<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Cuentas Personales</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="manifest" href="data:application/manifest+json,{
        %22name%22:%22Gestor de Cuentas%22,
        %22short_name%22:%22Cuentas%22,
        %22start_url%22:%22.%22,
        %22display%22:%22standalone%22,
        %22background_color%22:%22#000000%22,
        %22theme_color%22:%22#007AFF%22,
        %22description%22:%22Gestor de finanzas personales, elegante y profesional.%22,
        %22icons%22:[
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg%2bxml%2bxml%22},
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg%2bxml%2bxml%22}
        ]
    }">
    <meta name="theme-color" content="#000000"/>
    <link rel="apple-touch-icon" href="aiDANaI.webp">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        /* ================================================================= */
        /* === ESTILOS BASE: TEMA ÃšNICO "AMOLED FUTURISTA" === */
        /* ================================================================= */
        :root {
            /* === PALETA AMOLED FUTURISTA (segÃºn especificaciones) === */
            --c-primary: #007AFF;           /* Azul Vibrante */
            --c-primary-hover: #3395FF;     /* Azul mÃ¡s brillante para hover */
            --c-danger: #FF3B30;            /* Rojo Brillante (Secundario) */
            --c-success: #30D158;           /* Verde NeÃ³n (Terciario) */
            --c-warning: #FFD60A;           /* Amarillo Luminoso (Cuaternario) */
            --c-info: #C084FC;              /* Morado como color de acento adicional */
            
            --c-background: #000000;         /* Negro puro AMOLED (Fondo Principal) */
            --c-surface: #121212;            /* Negro casi puro para contenedores/tarjetas */
            --c-surface-variant: #1C1C1E;   /* Gris oscuro para superficies elevadas/inputs */
            --c-outline: #2C2C2E;           /* Borde sutil, un poco mÃ¡s claro */

            --c-on-surface: #FFFFFF;         /* Blanco puro para texto principal */
            --c-on-surface-secondary: #E0E0E0; /* Gris muy claro para texto secundario */
            --c-on-surface-tertiary: #B0B0B0;  /* Gris medio para info secundaria */
            --c-on-surface-disabled: #666666; /* Gris oscuro para deshabilitado */
            
            --c-white: #FFFFFF;
            --c-black: #000000;
            
            --c-chart-positive: var(--c-success);
            --c-chart-negative: var(--c-danger);

            /* Efectos de resplandor (glow) en lugar de sombras */
            --shadow-sm: 0 0 8px rgba(0, 122, 255, 0.2);
            --shadow-md: 0 0 20px rgba(0, 122, 255, 0.35);
            --glow-red: 0 0 20px rgba(255, 59, 48, 0.35);

            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            
            --fs-xs: 0.7rem; --fs-sm: 0.825rem; --fs-base: 0.95rem; --fs-lg: 1.05rem; --fs-xl: 1.2rem;
            --sp-1: 0.2rem; --sp-2: 0.4rem; --sp-3: 0.6rem; --sp-4: 0.8rem; --sp-5: 1rem; --sp-6: 1.25rem;
            --border-radius-md: 8px; --border-radius-lg: 14px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; scroll-behavior: smooth; }
        body { font-family: var(--font-family); background-color: var(--c-background); color: var(--c-on-surface); line-height: 1.4; min-height: 100vh; min-height: -webkit-fill-available; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow: hidden; font-weight: 500; }
        *:focus-visible { outline: 2px solid var(--c-primary); outline-offset: 2px; border-radius: var(--sp-2); }
        
        @keyframes pop-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes highlight-card { 0% { background-color: color-mix(in srgb, var(--c-primary) 15%, transparent); } 100% { background-color: transparent; } }
        .highlight-animation { animation: highlight-card 1.5s ease-out; }
        @keyframes highlight-field-success { 0% { background-color: color-mix(in srgb, var(--c-success) 20%, transparent); } 100% { background-color: transparent; } }
        .field-highlighted { animation: highlight-field-success 1s ease-out; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton { background-color: var(--c-surface-variant); background-image: linear-gradient(90deg, var(--c-surface-variant), color-mix(in srgb, var(--c-outline) 20%, var(--c-surface-variant)), var(--c-surface-variant)); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; border-radius: var(--sp-2); color: transparent !important; user-select: none; }
        .skeleton > * { visibility: hidden; }
        
        .intro-screen { position: fixed; inset: 0; z-index: 9999; display: flex; justify-content: center; align-items: center; background-color: #000000; transition: opacity 0.75s ease-in-out; }
        .starry-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(1px 1px at 10% 20%,#fff,transparent),radial-gradient(1px 1px at 80% 30%,#fff,transparent),radial-gradient(2px 2px at 50% 50%,#fff,transparent),radial-gradient(1px 1px at 30% 80%,#fff,transparent),radial-gradient(2px 2px at 90% 90%,#fff,transparent); background-size: 300px 300px; animation: twinkle 15s linear infinite; }
        @keyframes twinkle { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .intro-screen__logo { width: 250px; height: auto; border-radius: 24px; opacity: 0; position: absolute; animation: logoExplode 2.5s cubic-bezier(0.5, 0, 0.5, 1) forwards; }
        @keyframes logoExplode { 0% { transform: scale(0.2) rotate(-25deg); opacity: 0; } 30% { transform: scale(1.1) rotate(10deg); opacity: 1; } 50% { transform: scale(0.95) rotate(-8deg); opacity: 1; } 80% { transform: scale(1.5) rotate(5deg); opacity: 1; } 100% { transform: scale(12) rotate(20deg); opacity: 0; } }
        .intro-screen__quote-container { text-align: center; color: var(--c-white); padding: var(--sp-5); max-width: 800px; z-index: 1; opacity: 0; transition: opacity 1.5s ease-in-out; }
        .intro-screen__quote-container.visible { opacity: 1; }
        .intro-screen__quote-text { font-size: clamp(1.2rem, 4vw, 1.8rem); font-style: italic; font-weight: 400; line-height: 1.4; margin-bottom: 16px; text-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        .intro-screen__quote-author { display: block; font-size: clamp(0.8rem, 2.4vw, 1rem); color: var(--c-on-surface-secondary); font-weight: 500; }
        
        .app-layout { display: none; max-width: 500px; margin: 0 auto; height: 100vh; background-color: var(--c-background); flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; }
        .app-layout--visible { display: flex; opacity: 1; }

        .app-layout__main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 44px 0 48px 0; }
        .view { display: none; flex-direction: column; width: 100%; padding: 0 var(--sp-4); gap: var(--sp-4); }
        .view--active { display: flex; animation: fade-in 0.3s ease-in-out; }
        
        .top-bar { display: flex; align-items: center; justify-content: space-between; padding: var(--sp-2) var(--sp-4); background-color: rgba(0,0,0,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--c-outline); z-index: 200; height: 44px; position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; transition: background-color 0.3s ease-in-out; }
        .top-bar__title { font-size: var(--fs-lg); font-weight: 800; margin-right: auto; padding-left: var(--sp-2); }
        .top-bar__actions { display: flex; align-items: center; gap: var(--sp-1); }
        .top-bar__left-button { min-width: 85px; }

        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background-color: var(--c-surface); border-top: 1px solid var(--c-outline); display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 200; box-shadow: 0 -2px 15px rgba(0,0,0,0.2); height: 48px; }
        .bottom-nav__item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--sp-1) var(--sp-2); cursor: pointer; transition: color 0.2s; color: var(--c-on-surface-tertiary); border: none; background: none; }
        .bottom-nav__item--active { color: var(--c-primary); }
        .bottom-nav__item .material-icons { font-size: 22px; } 
        .bottom-nav__label { display: none; font-size: var(--fs-xs); margin-top: 2px; }

        .fab { position: fixed; bottom: calc(56px + env(safe-area-inset-bottom)); right: var(--sp-5); width: 56px; height: 56px; background-color: var(--c-primary); color: var(--c-white); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md); z-index: 50; transform: scale(0); opacity: 0; transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .fab--visible { transform: scale(1); opacity: 1; }
        .fab:hover { transform: scale(1.08) !important; box-shadow: 0 0 25px rgba(0, 122, 255, 0.5); } .fab .material-icons { font-size: 28px; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: flex; align-items: flex-end; justify-content: center; z-index: 1050; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .modal-overlay--active { opacity: 1; pointer-events: auto; }
        .modal { background: var(--c-surface); border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: var(--sp-5); width: 100%; max-width: 420px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.5); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); animation: pop-in 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid var(--c-outline); }
        .modal-overlay--active .modal { transform: translateY(0); }
        
        .card__title { font-size: var(--fs-lg); font-weight: 700; margin-bottom: var(--sp-3); display: flex; align-items: center; gap: var(--sp-2); color: var(--c-primary); padding: var(--sp-4) var(--sp-4) 0 var(--sp-4); }
        .card__content { padding: 0 var(--sp-4) var(--sp-4) var(--sp-4); }
        .card__title .material-icons { font-size: var(--fs-lg); }
        .card--no-bg { background: none; border: none; box-shadow: none; padding: 0; border-radius: 0; }
        .chart-container { position: relative; height: 220px; width: 100%; margin-bottom: var(--sp-4); }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--sp-3); }
        
        .kpi-item { background: var(--c-surface); border: 1px solid var(--c-outline); border-radius: var(--border-radius-lg); padding: var(--sp-3); text-align: center; transition: background-color 0.3s, border-color 0.3s; }
        .kpi-item:hover { background-color: var(--c-surface-variant); border-color: var(--c-primary); }
        .kpi-item__label { font-size: var(--fs-xs); font-weight: 600; color: var(--c-on-surface-secondary); margin-bottom: var(--sp-1); text-transform: uppercase; }
        .kpi-item__value { font-size: var(--fs-base); font-weight: 800; }
        .kpi-item__comparison { font-size: var(--fs-xs); font-weight: 500; margin-top: var(--sp-1); height: 14px; }
        #movimientos-list-container { position: relative; padding: 0 var(--sp-4); }
        #virtual-list-sizer { position: relative; width: 100%; }
        #virtual-list-content { position: absolute; top: 0; left: 0; width: 100%; }

        .transaction-card { display: flex; align-items: flex-start; padding: var(--sp-2) 0; cursor: pointer; border-bottom: 1px solid var(--c-outline); line-height: 1.25; min-height: 0; transition: background-color 0.2s; }
        .transaction-card:hover { background-color: var(--c-surface-variant); }
        .transaction-card:last-child { border-bottom: none; }
        .transaction-card__indicator { flex-shrink: 0; width: 3px; align-self: stretch; border-radius: 99px; margin-right: var(--sp-2); }
        .transaction-card__indicator--income { background-color: var(--c-success); }
        .transaction-card__indicator--expense { background-color: var(--c-danger); }
        .transaction-card__indicator--transfer { background-color: var(--c-info); }
        .transaction-card__indicator--recurrent { background-color: var(--c-warning); }
        .transaction-card__content { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; min-width: 0; }
        .transaction-card__details { flex-grow: 1; min-width: 0; padding-right: var(--sp-2); }
        .transaction-card__row-1, .transaction-card__concept { font-size: var(--fs-sm); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__row-2, .transaction-card__description { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__figures { flex-shrink: 0; text-align: right; }
        .transaction-card__amount { font-size: var(--fs-sm); font-weight: 700; display: block; }
        
        .transaction-card__balance { font-size: 0.7rem; color: var(--c-on-surface-secondary); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        
        .transaction-card__transfer-details { display: flex; flex-direction: column; gap: 0; margin: 2px 0 0 0; }
        .transaction-card__transfer-row { display: flex; justify-content: space-between; align-items: center; color: var(--c-on-surface-secondary); font-size: 0.75rem; }
        .transaction-card__transfer-row .material-icons { font-size: 11px; vertical-align: middle; margin-right: var(--sp-1); }
        .transaction-card__transfer-row > span:first-child { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #movimiento-modal .modal__actions { margin-top: var(--sp-4); display: flex; justify-content: space-between; align-items: center; gap: var(--sp-2); width: 100%; }
        #movimiento-modal .modal__actions .left-actions,
        #movimiento-modal .modal__actions .right-actions { display: flex; gap: var(--sp-2); align-items: center; }

        .accordion { margin-bottom: 0; background-color: var(--c-surface); overflow: hidden; }
        .accordion-wrapper > .accordion:first-child { border-top-left-radius: var(--border-radius-lg); border-top-right-radius: var(--border-radius-lg); }
        .accordion-wrapper > .accordion:last-child { border-bottom-left-radius: var(--border-radius-lg); border-bottom-right-radius: var(--border-radius-lg); }
        .accordion-wrapper > .accordion:not(:last-child) { border-bottom: 1px solid var(--c-outline); border-radius: 0; }
        .accordion-wrapper > .accordion:not(:last-child) > summary { border-bottom: none; }
        .accordion[open] > summary { border-bottom: 1px solid var(--c-outline); }
        .accordion > summary { font-weight: 700; cursor: pointer; padding: var(--sp-3) var(--sp-4); display: flex; align-items: center; justify-content: space-between; list-style: none; font-size: var(--fs-base); }
        .accordion > summary::-webkit-details-marker { display: none; }
        .accordion > summary .accordion__icon { transition: transform 0.2s; color: var(--c-on-surface-secondary); }
        .accordion[open] > summary .accordion__icon { transform: rotate(180deg); }
        .accordion__content { padding: 0 var(--sp-4) var(--sp-4) var(--sp-4); }
        .card > .accordion { border-radius: 0; }
        .account-group { background: var(--c-surface); border-radius: var(--border-radius-lg); margin-bottom: var(--sp-3); overflow: hidden; }
        .account-group__header { display: flex; justify-content: space-between; align-items: center; padding: var(--sp-2) var(--sp-4); border-bottom: 1px solid var(--c-outline); }
        .account-group__name { font-size: var(--fs-base); font-weight: 700; }
        .account-group__balance { font-size: var(--fs-sm); font-weight: 600; }
        .account-group .modal__list-item { padding: var(--sp-2) var(--sp-4); }
        .form-group { margin-bottom: var(--sp-3); position: relative; }
        .form-label { display: block; font-size: var(--fs-sm); font-weight: 600; margin-bottom: var(--sp-2); color: var(--c-on-surface-secondary); }
        .form-input, .form-select { width: 100%; padding: var(--sp-3); border: 1px solid var(--c-outline); border-radius: var(--border-radius-md); background: var(--c-surface-variant); color: var(--c-on-surface); font-size: var(--fs-base); appearance: none; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--c-primary); background-color: var(--c-surface); box-shadow: var(--shadow-md); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23FFFFFF' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 12px center; background-size: 14px; padding-right: 36px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr; gap: var(--sp-3); }
        
        .form-group-addon { display: flex; align-items: flex-end; gap: var(--sp-2); }
        .form-group-addon .form-group { flex-grow: 1; margin-bottom: 0; }
        .form-error { color: var(--c-danger); font-size: var(--fs-xs); margin-top: var(--sp-1); min-height: 14px; display: block; font-weight: 600; }
        .form-input--invalid { border-color: var(--c-danger) !important; box-shadow: var(--glow-red) !important; }
        .form-checkbox-group { display: flex; align-items: center; gap: var(--sp-2); margin-bottom: var(--sp-2); }
        .form-checkbox-group label { margin-bottom: 0; font-weight: normal; }
        .form-checkbox-group input[type="radio"], .form-checkbox-group input[type="checkbox"] { accent-color: var(--c-primary); }
        .form-switch-group { display: flex; align-items: center; justify-content: space-between; }
        .form-switch { position: relative; display: inline-block; width: 44px; height: 26px; }
        .form-switch input { opacity: 0; width: 0; height: 0; }
        .form-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--c-surface-variant); transition: .4s; border-radius: 34px; border: 1px solid var(--c-outline); }
        .form-switch .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        .form-switch input:checked + .slider { background-color: var(--c-success); border-color: var(--c-success); }
        .form-switch input:checked + .slider:before { transform: translateX(18px); }
        .btn { padding: var(--sp-3) var(--sp-4); border: 1px solid transparent; border-radius: var(--border-radius-md); font-size: var(--fs-sm); font-weight: 700; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: var(--sp-2); -webkit-user-select: none; user-select: none; }
        .btn:active { transform: scale(0.97); }
        .btn--primary { background-color: var(--c-primary); color: var(--c-white); border-color: var(--c-primary); } .btn--primary:hover { background-color: var(--c-primary-hover); border-color: var(--c-primary-hover); box-shadow: var(--shadow-md); }
        .btn--secondary { background-color: var(--c-surface-variant); color: var(--c-on-surface); border: 1px solid var(--c-outline); } .btn--secondary:hover { background-color: var(--c-outline); border-color: var(--c-on-surface-tertiary); }
        .btn--danger { background-color: var(--c-danger); color: var(--c-white); } .btn--danger:hover { box-shadow: var(--glow-red); }
        .btn--full { width: 100%; } .btn--loading { pointer-events: none; opacity: .8; }
        .icon-btn { background: none; border: none; color: var(--c-on-surface-secondary); cursor: pointer; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s, transform 0.2s; }
        .icon-btn .material-icons { font-size: 20px; }
        .icon-btn:hover { background-color: var(--c-surface-variant); color: var(--c-primary); }
        .icon-btn:active { transform: scale(0.9); }
        .modal__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--sp-3); flex-shrink: 0;}
        .modal__title { font-size: var(--fs-xl); font-weight: 800; }
        .modal__body { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; padding-right: var(--sp-2); margin-right: calc(-1 * var(--sp-2)); }
        .modal__list-item { display:flex; justify-content:space-between; align-items:center; padding: var(--sp-3) 0; border-bottom:1px solid var(--c-outline); gap: var(--sp-2); }
        .modal__list-item:last-child { border-bottom: none; }
        .modal__actions { margin-top: var(--sp-4); display: flex; justify-content: flex-end; gap: var(--sp-2); width: 100%;}
        #generic-modal-body h3, #generic-modal-body h4 { margin-top: 1.2em; margin-bottom: 0.6em; color: var(--c-primary); font-weight: 700; } 
        #generic-modal-body h4 { font-size: var(--fs-base); } 
        #generic-modal-body p, #generic-modal-body li, #generic-modal-body small { color: var(--c-on-surface-secondary); line-height: 1.5; } 
        #generic-modal-body ul, #generic-modal-body ol { list-style-position: inside; padding-left: var(--sp-2); } 
        #generic-modal-body ul li, #generic-modal-body ol li { margin-bottom: 6px; }
        #generic-modal-body ul ul { margin-top: 6px; }
        #generic-modal-body a { color: var(--c-primary); text-decoration: none; font-weight: 600; }
        #generic-modal-body a:hover { text-decoration: underline; }
        .login-view { position: fixed; inset: 0; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: var(--sp-4); opacity: 0; transition: opacity .5s; background-color: var(--c-background); }
        .login-view--visible { display: flex; opacity: 1; }
        .login-view__card { background-color: var(--c-surface); padding: var(--sp-5); border-radius: var(--border-radius-lg); box-shadow: 0 0 30px rgba(0,0,0,0.5); width: 100%; max-width: 340px; text-align: center; animation: pop-in 0.3s ease-out; border: 1px solid var(--c-outline); }
        .login-view__title { margin-bottom: var(--sp-4); font-size: var(--fs-xl); font-weight: 800; }
        .empty-state { text-align: center; padding: var(--sp-5) 0; color: var(--c-on-surface-secondary); animation: fade-in 0.3s; background: var(--c-surface); border-radius: var(--border-radius-lg); border: 1px solid var(--c-outline); }
        .empty-state .material-icons { font-size: 40px; margin-bottom: var(--sp-2); color: var(--c-primary); }
        .empty-state h3 { font-size: var(--fs-lg); font-weight: 700; color: var(--c-on-surface); margin-bottom: var(--sp-2); }
        .filter-pills { display: flex; flex-wrap: wrap; gap: var(--sp-2); margin-bottom: var(--sp-4); }
        .filter-pill { padding: var(--sp-1) var(--sp-3); border: 1px solid var(--c-outline); border-radius: 99px; font-size: var(--fs-xs); font-weight: 600; background-color: var(--c-surface-variant); color: var(--c-on-surface); cursor: pointer; transition: all 0.2s; }
        .filter-pill:hover { opacity: 0.8; border-color: var(--c-primary); }
        .filter-pill--active { background-color: var(--c-primary); color: var(--c-white); font-weight: 700; border-color: var(--c-primary); }
        
        .toast-container { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: var(--sp-2); pointer-events: none;}
        .toast { background-color: var(--c-surface); color: var(--c-white); padding: var(--sp-2) var(--sp-4); border-radius: var(--border-radius-md); box-shadow: 0 0 20px rgba(0,0,0,0.5); pointer-events: all; border: 1px solid var(--c-outline); }
        .toast--danger { background-color: var(--c-danger); border-color: var(--c-danger); }
        .toast--warning { background-color: var(--c-warning); border-color: var(--c-warning); color: var(--c-black); }
        .toast--info { background-color: var(--c-info); border-color: var(--c-info); }
        .text-positive { color: var(--c-success); } .text-negative { color: var(--c-danger); } .text-warning { color: var(--c-warning); } .text-info { color: var(--c-info); }
        .hidden { display: none !important; }
        .spinner { display: inline-block; width: 1em; height: 1em; border: .15em solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin .8s linear infinite; vertical-align: middle; }
        @keyframes spin { to { transform:rotate(360deg); } }
        #description-suggestions { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: var(--c-surface); border-radius: var(--border-radius-md); box-shadow: 0 10px 20px rgba(0,0,0,0.4); z-index: 1060; max-height: 150px; overflow-y: auto; border: 1px solid var(--c-outline); }
        .suggestion-item { padding: var(--sp-2) var(--sp-3); cursor: pointer; font-size: var(--fs-sm); }
        .suggestion-item:hover { background-color: var(--c-surface-variant); }
        .suggestion-item small { color: var(--c-on-surface-secondary); font-size: var(--fs-xs); }
        .budget-track-item { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: var(--sp-3); padding: var(--sp-2) 0; border-bottom: 1px solid var(--c-outline); }
        .budget-track-item:last-child { border-bottom: none; }
        .budget-track-item__main { display: flex; flex-direction: column; gap: var(--sp-1); min-width: 0; }
        .budget-track-item__concept-name { font-weight: 700; font-size: var(--fs-sm); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .budget-track-item__figures { display: flex; flex-direction: column; align-items: flex-end; text-align: right; font-size: var(--fs-xs); }
        .budget-track-item__amount { color: var(--c-on-surface-secondary); }
        .budget-track-item__amount strong { color: var(--c-on-surface); font-weight: 600;}
        .budget-track-item__difference { font-weight: 700; }
        .budget-item__progress { width: 100%; -webkit-appearance: none; appearance: none; height: 6px; border-radius: 99px; overflow: hidden; background-color: var(--c-surface-variant); }
        .budget-item__progress::-webkit-progress-bar { background-color: var(--c-surface-variant); }
        .budget-item__progress::-webkit-progress-value { background-color: var(--c-primary); transition: width 0.3s ease; }
        .budget-item__progress.budget-item__progress--danger::-webkit-progress-value { background-color: var(--c-danger); }
        .budget-item__progress.budget-item__progress--warning::-webkit-progress-value { background-color: var(--c-warning); }
        .investment-asset-card { background-color: var(--c-surface); border: 1px solid var(--c-outline); border-radius: var(--border-radius-lg); padding: var(--sp-3); margin-bottom: var(--sp-2); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; }
        .investment-asset-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--c-primary); }
        .investment-asset-card__header { display: grid; grid-template-columns: 1fr auto; align-items: flex-start; gap: var(--sp-2); }
        .investment-asset-card__name { font-size: var(--fs-base); font-weight: 700; }
        .investment-asset-card__value { font-size: var(--fs-lg); font-weight: 800; text-align: right; }
        .investment-asset-card__pnl { font-size: var(--fs-xs); font-weight: 600; text-align: right; }
        .investment-timeline-item { display: flex; align-items: center; gap: var(--sp-3); padding: var(--sp-2) 0; border-bottom: 1px solid var(--c-outline); }
        .investment-timeline-item:last-child { border-bottom: none; }
        .investment-timeline-item__icon { flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: var(--c-surface-variant); border-radius: 50%; }
        .investment-timeline-item__icon .material-icons { font-size: 18px; }
        .investment-timeline-item__details { flex-grow: 1; }
        .investment-timeline-item__description { font-weight: 600; font-size: var(--fs-sm); }
        .investment-timeline-item__date { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); }
        .investment-timeline-item__amount { font-weight: 700; font-size: var(--fs-sm); }
        #exit-screen { display: none; opacity: 0; position: fixed; inset: 0; background-color: var(--c-background); color: var(--c-on-surface); flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-size: 1.5rem; text-align: center; transition: opacity 0.5s ease; }
        .calculator-overlay { align-items: flex-end; background: rgba(0,0,0,0.3); }
        .calculator-ui { width: 100%; max-width: 500px; margin: 0 auto; background-color: var(--c-surface-variant); color: var(--c-on-surface); border-top-left-radius: var(--border-radius-lg); border-top-right-radius: var(--border-radius-lg); padding: var(--sp-4) var(--sp-4) env(safe-area-inset-bottom) var(--sp-4); box-shadow: 0 -5px 20px rgba(0,0,0,0.1); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-top: 1px solid var(--c-outline); }
        .modal-overlay--active .calculator-ui { transform: translateY(0); }
        .calculator-display { font-size: 2.5rem; font-weight: 300; text-align: right; padding: var(--sp-2) var(--sp-3); margin-bottom: var(--sp-3); min-height: 60px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--sp-3); }
        .calculator-btn { font-family: var(--font-family); font-size: 1.5rem; font-weight: 400; height: 64px; border-radius: 99px; border: none; background-color: var(--c-surface); color: var(--c-on-surface); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, transform 0.1s; }
        .calculator-btn:active { transform: scale(0.95); }
        .calculator-btn.btn-operator { background-color: var(--c-surface-variant); color: var(--c-on-surface); font-weight: 500; }
        .calculator-btn.btn-confirm { background-color: var(--c-primary); color: var(--c-white); font-weight: 500; }
        .calculator-btn.zero { grid-column: span 2; }
        .material-icons.backspace-icon { font-size: 1.5rem; }
        
        body[data-ledger-mode="A"] .top-bar { background-color: color-mix(in srgb, var(--c-primary) 10%, rgba(0,0,0,0.7)); }
        body[data-ledger-mode="A"] .top-bar, body[data-ledger-mode="A"] .top-bar .btn { color: var(--c-white); }
        body[data-ledger-mode="B"] .top-bar { background-color: color-mix(in srgb, var(--c-danger) 10%, rgba(0,0,0,0.7)); }
        body[data-ledger-mode="B"] .top-bar, body[data-ledger-mode="B"] .top-bar .btn { color: var(--c-white); }
        body[data-ledger-mode="B"] .bottom-nav__item--active { color: var(--c-danger); }
        #ledger-toggle-btn { font-weight: 700; padding: 6px 10px; font-size: 0.8rem; min-width: 40px; text-align: center; }

        #global-search-modal .modal { max-width: 600px; height: 70vh; border-radius: var(--border-radius-lg); }
        #global-search-modal .modal__body { padding: 0; margin-right: 0; }
        #global-search-input-wrapper { padding: 0 var(--sp-4) var(--sp-3) var(--sp-4); border-bottom: 1px solid var(--c-outline); display: flex; align-items: center; gap: var(--sp-3); }
        #global-search-input { width: 100%; font-size: var(--fs-lg); border: none; background: transparent; color: var(--c-on-surface); padding: var(--sp-2) 0; }
        #global-search-input:focus { outline: none; }
        #global-search-results { padding: var(--sp-2) 0; }
        .search-result-group__title { font-size: var(--fs-xs); font-weight: 700; text-transform: uppercase; color: var(--c-on-surface-secondary); padding: var(--sp-2) var(--sp-4); background-color: var(--c-surface-variant); }
        .search-result-item { display: flex; align-items: center; gap: var(--sp-3); padding: var(--sp-2) var(--sp-4); cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .search-result-item:hover { background-color: var(--c-surface-variant); }
        .search-result-item__icon { color: var(--c-on-surface-secondary); }
        .search-result-item__details p { font-size: var(--fs-sm); font-weight: 600; color: var(--c-on-surface); }
        .search-result-item__details small { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); }
        .inline-edit-form { width: 100%; display: flex; flex-direction: column; gap: var(--sp-2); padding: var(--sp-2) 0; }
        .inline-edit-form .form-input { padding: var(--sp-2); }
        .inline-edit-form .form-label { font-size: var(--fs-xs); margin-bottom: 4px; }
        
        .widget-config-item { display: flex; align-items: center; gap: var(--sp-3); background-color: var(--c-surface-variant); padding: var(--sp-2) var(--sp-3); border-radius: var(--border-radius-md); margin-bottom: var(--sp-2); }
        .widget-config-item.dragging { opacity: 0.5; background: var(--c-primary); }
        .widget-config-item .drag-handle { cursor: grab; color: var(--c-on-surface-secondary); }
        .widget-config-item .drag-handle:active { cursor: grabbing; }
        .widget-config-item__details { flex-grow: 1; }
        .widget-config-item__title { font-weight: 700; font-size: var(--fs-sm); }
        .widget-config-item__desc { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); }

        .onboarding-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 2000; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; }
        .onboarding-overlay--visible { opacity: 1; pointer-events: auto; }
        .onboarding-highlight { position: absolute; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); border-radius: var(--border-radius-md); z-index: 2001; pointer-events: none; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .onboarding-step-box { position: absolute; z-index: 2002; background-color: var(--c-surface); color: var(--c-on-surface); padding: var(--sp-4); border-radius: var(--border-radius-lg); width: 90%; max-width: 350px; box-shadow: var(--shadow-md); opacity: 0; transform: translateY(20px); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid var(--c-outline); }
        .onboarding-overlay--visible .onboarding-step-box { opacity: 1; transform: translateY(0); }
        .onboarding-step-box__title { font-size: var(--fs-lg); font-weight: 800; margin-bottom: var(--sp-2); color: var(--c-primary); }
        .onboarding-step-box__content { font-size: var(--fs-sm); line-height: 1.5; margin-bottom: var(--sp-4); }
        .onboarding-step-box__footer { display: flex; justify-content: space-between; align-items: center; }
        .onboarding-step-box__dots { display: flex; gap: var(--sp-2); }
        .onboarding-step-box__dot { width: 8px; height: 8px; background-color: var(--c-outline); border-radius: 50%; transition: background-color 0.3s; }
        .onboarding-step-box__dot--active { background-color: var(--c-primary); }
        
        #list-loader { text-align: center; padding: var(--sp-4); color: var(--c-on-surface-secondary); }
        
        /* === ESTILOS PARA EL NUEVO ASISTENTE DE IMPORTACIÃ“N JSON === */
        .json-wizard-step { display: flex; flex-direction: column; height: 100%; }
        #json-drop-zone {
            border: 2px dashed var(--c-outline);
            border-radius: var(--border-radius-lg);
            padding: var(--sp-6);
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #json-drop-zone.drag-over {
            border-color: var(--c-primary);
            background-color: color-mix(in srgb, var(--c-primary) 10%, transparent);
        }
        #json-preview-list { list-style: none; padding-left: 0; }
        #json-preview-list li {
            background-color: var(--c-surface-variant);
            padding: var(--sp-3);
            border-radius: var(--border-radius-md);
            margin-bottom: var(--sp-2);
            display: flex;
            align-items: center;
            gap: var(--sp-3);
        }
        #json-preview-list .material-icons { color: var(--c-success); }

        /* === INICIO CAMBIO: ESTILOS PARA LA CABECERA DE FECHA === */
        .movimiento-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background-color: #2c3e50; /* Un azul-gris oscuro y neutro */
            color: var(--c-on-surface);
            font-weight: 700;
            font-size: var(--fs-sm);
            border-radius: 99px; /* Forma de pÃ­ldora */
            margin-top: var(--sp-4);
            margin-bottom: var(--sp-2);
        }
        /* === FIN CAMBIO === */

        @media (min-width: 768px) {
            .app-layout { max-width: 95%; }
            .top-bar, .bottom-nav { max-width: 100%; }
            .modal-overlay { align-items: center; }
            .modal { border-radius: var(--border-radius-lg); transform: translateY(0) scale(0.95); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s; }
            .modal-overlay--active .modal { transform: translateY(0) scale(1); }
            .view { padding: 0 var(--sp-5); }
            .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--sp-4); }
            .form-grid { grid-template-columns: 1fr 1fr; }
        }

        @media (min-width: 1024px) {
            body { overflow-y: auto; }
            .app-layout { flex-direction: row; max-width: 100%; height: 100vh; }
            .bottom-nav { position: fixed; flex-direction: column; width: 240px; height: 100vh; left: 0; top: 0; transform: none; border-top: none; border-right: 1px solid var(--c-outline); padding: var(--sp-5) var(--sp-3); justify-content: flex-start; gap: var(--sp-2); box-shadow: none; background-color: var(--c-background); }
            .bottom-nav__item { flex: 0 0 auto; flex-direction: row; justify-content: flex-start; width: 100%; height: auto; padding: var(--sp-2) var(--sp-3); border-radius: var(--border-radius-md); }
            .bottom-nav__item:hover { background-color: var(--c-surface-variant); }
            body[data-ledger-mode="A"] .bottom-nav__item--active { background-color: var(--c-primary); color: var(--c-white); }
            body[data-ledger-mode="B"] .bottom-nav__item--active { background-color: var(--c-danger); color: var(--c-white); }
            body[data-ledger-mode="A"] .bottom-nav__item--active:hover { background-color: var(--c-primary-hover); }
            body[data-ledger-mode="B"] .bottom-nav__item--active:hover { background-color: color-mix(in srgb, var(--c-danger) 80%, white); }
            .bottom-nav__item .material-icons { margin-right: var(--sp-3); font-size: 20px; }
            .bottom-nav__label { display: inline-block; font-size: var(--fs-sm); font-weight: 600; margin-top: 0; }
            .app-layout__main { margin-left: 240px; width: calc(100% - 240px); height: 100vh; padding: 60px var(--sp-6) var(--sp-6) var(--sp-6); }
            .view { max-width: 1100px; margin: 0 auto; padding: 0; }
            .top-bar { max-width: none; width: calc(100% - 240px); left: auto; right: 0; transform: none; padding-left: var(--sp-6); padding-right: var(--sp-6); }
            .toast-container { bottom: var(--sp-4); left: auto; right: calc(240px / 2); transform: translateX(50%); }
        }
		.movements-modal-container {
    max-height: 60vh;
    overflow-y: auto;
}
    </style>
</head>
<body data-ledger-mode="A">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    
    <div id="introScreen" class="intro-screen">
        <div class="starry-background"></div>
        <img id="splashImage" class="intro-screen__logo" src="aiDANaI.webp" alt="Logo App" />
        <div id="quoteContainer" class="intro-screen__quote-container">
            <p id="quoteText" class="intro-screen__quote-text"></p>
            <span id="quoteAuthor" class="intro-screen__quote-author"></span>
        </div>
    </div>

    <div id="login-screen" class="login-view">
        <div class="login-view__card">
            <h2 id="login-title" class="login-view__title">ðŸ’° Cuentas aiDANaI</h2>
            <form id="login-form" noValidate>
                <div class="form-group"><input type="email" id="login-email" class="form-input" placeholder="Correo electrÃ³nico" required autoComplete="email" autoCapitalize="none" /><span class="form-error" id="login-email-error"></span></div>
                <div class="form-group"><input type="password" id="login-password" class="form-input" placeholder="ContraseÃ±a" required autoComplete="current-password" /><span class="form-error" id="login-password-error"></span></div>
                <div class="form-grid" style="margin-top: 16px;">
                    <button type="submit" data-action="login" class="btn btn--primary">Iniciar SesiÃ³n</button>
                    <button type="submit" data-action="register" class="btn btn--secondary">Registrarse</button>
                </div>
                <p id="login-error" class="form-error" style="min-height: 16px; margin-top: 8px;"></p>
            </form>
        </div>
    </div>
    
    <div id="app-root" class="app-layout">
        <nav class="bottom-nav">
            <button data-action="navigate" data-page="movimientos-page" class="bottom-nav__item">
                <span class="material-icons">swap_horiz</span>
                <span class="bottom-nav__label">Movimientos</span>
            </button>
            <button data-action="navigate" data-page="panel-control-page" class="bottom-nav__item">
                <span class="material-icons">dashboard</span>
                <span class="bottom-nav__label">Panel</span>
            </button>
            <button data-action="navigate" data-page="cuentas-page" class="bottom-nav__item">
                <span class="material-icons">account_balance_wallet</span>
                <span class="bottom-nav__label">Cuentas</span>
            </button>
            <button data-action="navigate" data-page="inversiones-page" class="bottom-nav__item">
                <span class="material-icons">trending_up</span>
                <span class="bottom-nav__label">Portafolio</span>
            </button>
            <button data-action="navigate" data-page="presupuestos-page" class="bottom-nav__item">
                <span class="material-icons">pie_chart</span>
                <span class="bottom-nav__label">Presupuestos</span>
            </button>
            <button data-action="navigate" data-page="configuracion-page" class="bottom-nav__item">
                <span class="material-icons">settings</span>
                <span class="bottom-nav__label">Ajustes</span>
            </button>
        </nav>

        <header id="app-top-bar" class="top-bar">
            <div id="top-bar-left-button" class="top-bar__left-button">
                 <button id="ledger-toggle-btn" class="btn btn--secondary" data-action="toggle-ledger" title="Cambiar entre contabilidad Personal (A) y Secundaria (B)">A</button>
            </div>
            <h1 id="top-bar-title" class="top-bar__title"></h1>
            <div id="top-bar-actions" class="top-bar__actions"></div>
        </header>

        <main class="app-layout__main">
            <!-- El contenido de la pÃ¡gina se genera dinÃ¡micamente -->
            <section id="panel-control-page" class="view">
                <!-- El contenido de esta pÃ¡gina ahora se genera dinÃ¡micamente por la funciÃ³n updateDashboard() -->
            </section>

            <section id="movimientos-page" class="view" style="padding: 0; gap: 0;">
                <div id="movimientos-list-container">
                    <div id="virtual-list-sizer">
                        <div id="virtual-list-content"></div>
                    </div>
                    <div id="list-loader" class="hidden"><span class="spinner"></span></div>
                </div> 
                <div id="empty-movimientos" class="empty-state hidden" style="margin: 0 var(--sp-4);">
                    <span class="material-icons">receipt_long</span>
                    <h3>Tu historial empieza aquÃ­</h3>
                    <p>Pulsa el botÃ³n `+` para aÃ±adir tu primer ingreso o gasto.</p>
                </div>
            </section>

            <section id="inversiones-page" class="view">
                <div id="investment-list-view">
                    <div id="investment-global-kpis"></div>
                    <div class="card card--no-bg" style="padding:0; margin-bottom: 0;">
                         <div class="form-grid">
                            <button class="btn btn--secondary" data-action="manage-investment-accounts"><span class="material-icons" style="font-size:16px;">checklist</span>Gestionar Activos</button>
                            <button class="btn btn--secondary" data-action="add-aportacion"><span class="material-icons" style="font-size:16px;">add_card</span>Aportar/Retirar</button>
                        </div>
                    </div>
                    <div id="investment-assets-list"></div>
                    <div id="empty-investments" class="empty-state hidden">
                        <span class="material-icons">rocket_launch</span>
                        <h3>Â¿Listo para despegar?</h3>
                        <p>Para empezar, pulsa en "Gestionar Activos" y selecciona las cuentas que quieres incluir en tu portafolio.</p>
                    </div>
                </div>
                <div id="investment-detail-view" class="hidden"></div>
            </section>

            <section id="cuentas-page" class="view">
                <div class="card" style="border: none; background: transparent;">
                    <div class="kpi-item" style="text-align: left; padding: var(--sp-4); background: none; border: none;">
                        <h4 class="kpi-item__label" style="text-align: left;">Saldo Total Seleccionado</h4>
                        <strong id="cuentas-total-balance" class="kpi-item__value" style="font-size: var(--fs-xl);">0,00 â‚¬</strong>
                    </div>
                </div>
                <div class="card card--no-bg">
                    <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary>
                                <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">filter_alt</span>Filtros</h3>
                                <span class="material-icons accordion__icon">expand_more</span>
                            </summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                <h3 class="card__title" style="font-size: var(--fs-base); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-2); padding: 0;">Filtro por tipo de cuenta</h3>
                                <div class="form-group">
                                    <div id="filter-account-types-pills" class="filter-pills"></div>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                <div id="resumen-cuentas-container" class="accordion-wrapper"></div>

                <div class="card card--no-bg accordion-wrapper">
                    <div id="liquid-assets-chart-container" class="hidden" style="margin-bottom: 0;">
                         <details class="accordion">
                            <summary>
                                <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">donut_small</span>DistribuciÃ³n de Activos LÃ­quidos</h3>
                                <span class="material-icons accordion__icon">expand_more</span>
                            </summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                <div class="chart-container" style="height: 200px; margin-bottom: 0;">
                                    <canvas id="liquid-assets-chart"></canvas>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </section>

            <section id="presupuestos-page" class="view">
                 <div class="card card--no-bg">
                     <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary>
                                <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">query_stats</span>GestiÃ³n de Presupuestos</h3>
                                <span class="material-icons accordion__icon">expand_more</span>
                            </summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                <div id="budget-controls" style="display: flex; gap: var(--sp-3); margin-bottom: var(--sp-4); flex-wrap: wrap;">
                                    <select id="budget-year-selector" class="form-select" style="flex-basis: 120px; flex-grow: 1;"></select>
                                    <button data-action="update-budgets" class="btn btn--secondary" title="Editar presupuestos del aÃ±o seleccionado">
                                        <span class="material-icons" style="font-size: 16px;">edit</span>
                                        <span>Editar AÃ±o</span>
                                    </button>
                                </div>
                                <div id="budget-tracking-list"></div>
                                <div id="budget-init-placeholder" class="empty-state hidden" style="background: transparent; padding: var(--sp-2) 0; border: none;">
                                    <span class="material-icons">auto_fix_high</span>
                                    <h3 id="budget-placeholder-title">Crear Presupuestos</h3>
                                    <p id="budget-placeholder-text">AÃºn no se han creado los presupuestos para el aÃ±o seleccionado.</p>
                                    <button data-action="create-budgets" class="btn btn--primary" style="margin-top: var(--sp-3);">Crear Ahora</button>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </section>

            <section id="configuracion-page" class="view">
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion" open>
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">account_circle</span>
                                Cuenta de Usuario
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <div class="modal__list-item" style="padding-left: 0; padding-right: 0;">
                                <span>SesiÃ³n iniciada como:</span>
                                <strong id="config-user-email">cargando...</strong>
                            </div>
                            <button data-action="logout" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);">
                                <span class="material-icons" style="font-size: 16px;">logout</span>
                                Cerrar SesiÃ³n
                            </button>
                            <button data-action="delete-account" class="btn btn--danger btn--full" style="margin-top: var(--sp-2); background-color: var(--c-black); border: 1px solid var(--c-danger);">
                                <span class="material-icons" style="font-size: 16px;">delete_forever</span>
                                Eliminar Mi Cuenta Permanentemente
                            </button>
                        </div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                     <details class="accordion" open>
                        <summary><h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">badge</span>ConfiguraciÃ³n General</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                         <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <h3 class="card__title" style="margin-top: 0; font-size: var(--fs-base); padding: 0;"><span class="material-icons">rocket_launch</span>Opciones de Arranque</h3>
                             <div class="form-checkbox-group">
                                <input type="checkbox" id="config-skip-intro" />
                                <label for="config-skip-intro">Omitir intro y cita al iniciar la app</label>
                            </div>
                            <button data-action="save-config" class="btn btn--primary btn--full" style="margin-top: var(--sp-4);">Guardar ConfiguraciÃ³n</button>
                        </div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary><h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">edit_note</span>GestiÃ³n de Datos</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                             <div class="form-grid">
                                <button data-action="manage-cuentas" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">account_balance</span>Cuentas</button>
                                <button data-action="manage-conceptos" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">category</span>Conceptos</button>
                                <button data-action="manage-recurrentes" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">event_repeat</span>Recurrentes</button>
                            </div>
                        </div>
                    </details>
                </div>
                 <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary><h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">backup</span>Copia de Seguridad</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-4);">La importaciÃ³n de JSON reemplazarÃ¡ todos los datos actuales. Se recomienda exportar primero para tener una copia de seguridad.</p>
                            <div class="form-grid">
								<button data-action="export-data" class="btn btn--secondary" title="Exportar una copia de seguridad completa en formato JSON."><span class="material-icons" style="font-size: 16px;">save</span>Exportar JSON</button>
								<button data-action="import-data" class="btn btn--secondary" title="Importar desde un archivo de seguridad JSON."><span class="material-icons" style="font-size: 16px;">file_upload</span>Importar JSON</button>
							</div>
								<input type="file" id="import-file-input" class="hidden" accept=".json,application/json" />
                            <button data-action="clear-data" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);">Borrar Todos los Datos</button>
                        </div>
                    </details>
                </div>
            </section>
        </main>
        
        <button data-action="add-movement" id="fab-add-movimiento" class="fab" title="AÃ±adir Movimiento" aria-label="AÃ±adir Movimiento"><span class="material-icons">add</span></button>

    </div>

    <div id="toast-container" aria-live="assertive"></div>
    
    <div id="movimiento-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="form-movimiento-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="form-movimiento-title" class="modal__title">AÃ±adir Movimiento</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="movimiento-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div class="modal__body">
                <form id="form-movimiento" novalidate>
                    <input type="hidden" id="movimiento-id" />
                    <input type="hidden" id="movimiento-mode" value="new" />
                    
                    <div class="filter-pills" style="justify-content: center; margin-bottom: var(--sp-4);">
                        <button type="button" id="mov-type-btn-movimiento" class="filter-pill filter-pill--active" data-action="set-movimiento-type" data-type="movimiento">Ingreso/Gasto</button>
                        <button type="button" id="mov-type-btn-traspaso" class="filter-pill" data-action="set-movimiento-type" data-type="traspaso">Traspaso</button>
                    </div>

                    <div class="form-group">
                        <label for="movimiento-cantidad" class="form-label">Cantidad (gasto en negativo)</label>
                        <input type="text" id="movimiento-cantidad" class="form-input input-amount-calculator" readonly required placeholder="Ej: -2,50" />
                        <span class="form-error" id="movimiento-cantidad-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="movimiento-descripcion" class="form-label">DescripciÃ³n</label>
                        <input type="text" id="movimiento-descripcion" class="form-input" required placeholder="Ej: Compra semanal" />
                        <span class="form-error"id="movimiento-descripcion-error"></span>
                        <div id="description-suggestions"></div>
                    </div>

                    <div id="movimiento-fields">
                        <div class="form-grid">
                            <div class="form-group-addon"><div class="form-group"><label for="movimiento-concepto" class="form-label">Concepto</label><select id="movimiento-concepto" class="form-select" required></select><span class="form-error" id="movimiento-concepto-error"></span></div><button type="button" data-action="manage-conceptos" class="icon-btn" title="Gestionar Conceptos"><span class="material-icons">more_vert</span></button></div>
                            <div class="form-group-addon"><div class="form-group"><label for="movimiento-cuenta" class="form-label">Cuenta</label><select id="movimiento-cuenta" class="form-select" required></select><span class="form-error" id="movimiento-cuenta-error"></span></div><button type="button" data-action="manage-cuentas" class="icon-btn" title="Gestionar Cuentas"><span class="material-icons">more_vert</span></button></div>
                        </div>
                    </div>

                    <div id="traspaso-fields" class="hidden">
                        <div class="form-group">
                            <label class="form-label" for="traspaso-show-all-accounts-toggle">Cuentas</label>
                            <div class="form-checkbox-group" style="margin-bottom: var(--sp-2);">
                                <input type="checkbox" id="traspaso-show-all-accounts-toggle" data-action="toggle-traspaso-accounts-filter" />
                                <label for="traspaso-show-all-accounts-toggle" style="font-size: var(--fs-xs);">Mostrar cuentas de ambas contabilidades (A y B)</label>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label for="movimiento-cuenta-origen" class="form-label">Cuenta Origen</label><select id="movimiento-cuenta-origen" class="form-select"></select><span class="form-error" id="movimiento-cuenta-origen-error"></span></div>
                            <div class="form-group"><label for="movimiento-cuenta-destino" class="form-label">Cuenta Destino</label><select id="movimiento-cuenta-destino" class="form-select"></select><span class="form-error" id="movimiento-cuenta-destino-error"></span></div>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid var(--c-outline); margin-top: var(--sp-4); padding-top: var(--sp-2);">
                        <div class="form-switch-group modal__list-item" style="padding: var(--sp-2) 0;">
                            <label for="movimiento-recurrente" style="font-weight: 700;">Â¿Programar como recurrente?</label>
                            <label class="form-switch"><input type="checkbox" id="movimiento-recurrente"><span class="slider"></span></label>
                        </div>
                        <div id="recurrent-options" class="hidden" style="animation: fade-in 0.3s; margin-top: var(--sp-2);">
                            <div class="form-group">
                                <label for="recurrent-frequency" class="form-label">Frecuencia</label>
                                <select id="recurrent-frequency" class="form-select">
                                    <option value="daily">Diaria</option>
                                    <option value="weekly">Semanal</option>
                                    <option value="monthly" selected>Mensual</option>
                                    <option value="yearly">Anual</option>
                                </select>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="recurrent-next-date" class="form-label">PrÃ³xima ejecuciÃ³n</label>
                                    <input type="date" id="recurrent-next-date" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="recurrent-end-date" class="form-label">Finaliza el (opcional)</label>
                                    <input type="date" id="recurrent-end-date" class="form-input">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: var(--sp-3);">
                        <label for="movimiento-fecha" class="form-label">Fecha</label>
                        <input type="date" id="movimiento-fecha" class="form-input" required />
                        <span class="form-error" id="movimiento-fecha-error"></span>
                    </div>

                    <div class="modal__actions">
                        <div class="left-actions">
                            <button type="button" id="delete-movimiento-btn" data-action="delete-movement-from-modal" class="icon-btn btn--danger hidden" title="Borrar"><span class="material-icons">delete</span></button>
                            <button type="button" id="duplicate-movimiento-btn" data-action="duplicate-movement" class="icon-btn btn--secondary hidden" title="Duplicar"><span class="material-icons">content_copy</span></button>
                        </div>
                        <div class="right-actions">
                            <button id="save-movimiento-btn" type="submit" class="btn btn--primary" title="Guardar Movimiento">Guardar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="generic-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="generic-modal-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="generic-modal-title" class="modal__title"></h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="generic-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="generic-modal-body" class="modal__body"></div>
        </div>
    </div>

    <div id="dashboard-config-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="dashboard-config-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="dashboard-config-title" class="modal__title">Personalizar Panel</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="dashboard-config-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div class="modal__body">
                <p class="form-label" style="margin-bottom: var(--sp-3);">Activa, desactiva y reordena los elementos que quieres ver en tu panel de control.</p>
                <div id="dashboard-widget-list">
                    <!-- La lista de widgets configurables se insertarÃ¡ aquÃ­ -->
                </div>
            </div>
            <div class="modal__actions">
                <button class="btn btn--primary btn--full" data-action="save-dashboard-config">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <div id="calculator-modal" class="modal-overlay calculator-overlay">
        <div class="calculator-ui">
            <div id="calculator-display" class="calculator-display">0</div>
            <div id="calculator-grid" class="calculator-grid">
                <button class="calculator-btn btn-operator" data-key="clear">C</button>
                <button class="calculator-btn btn-operator" data-key="sign">+/-</button>
                <button class="calculator-btn btn-operator" data-key="backspace"><span class="material-icons backspace-icon">backspace</span></button>
                <button class="calculator-btn btn-confirm" data-key="done">OK</button>
                
                <button class="calculator-btn" data-key="7">7</button>
                <button class="calculator-btn" data-key="8">8</button>
                <button class="calculator-btn" data-key="9">9</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-1" style="visibility: hidden;"></button>

                <button class="calculator-btn" data-key="4">4</button>
                <button class="calculator-btn" data-key="5">5</button>
                <button class="calculator-btn" data-key="6">6</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-2" style="visibility: hidden;"></button>
                
                <button class="calculator-btn" data-key="1">1</button>
                <button class="calculator-btn" data-key="2">2</button>
                <button class="calculator-btn" data-key="3">3</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-3" style="visibility: hidden;"></button>

                <button class="calculator-btn zero" data-key="0">0</button>
                <button class="calculator-btn" data-key="comma">,</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-4" style="visibility: hidden;"></button>
            </div>
        </div>
    </div>

    <div id="global-search-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="global-search-title">
        <div class="modal">
            <header class="modal__header">
                <div id="global-search-input-wrapper">
                    <span class="material-icons" style="color: var(--c-on-surface-secondary);">search</span>
                    <input type="search" id="global-search-input" placeholder="Buscar en toda la app..." autocomplete="off">
                </div>
                <button class="icon-btn" data-action="close-modal" data-modal-id="global-search-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="global-search-results" class="modal__body">
                <div class="empty-state" style="background:transparent; border: none;">
                    <span class="material-icons">manage_search</span>
                    <h3>EncuÃ©ntralo todo</h3>
                    <p>Busca movimientos, cuentas o conceptos. <br>Atajo: <strong>Cmd/Ctrl + K</strong></p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="onboarding-tour" class="onboarding-overlay">
        <div id="onboarding-highlight" class="onboarding-highlight"></div>
        <div id="onboarding-step-box" class="onboarding-step-box">
            <h3 id="onboarding-title" class="onboarding-step-box__title"></h3>
            <p id="onboarding-content" class="onboarding-step-box__content"></p>
            <div class="onboarding-step-box__footer">
                <button id="onboarding-skip-btn" class="btn btn--secondary" data-action="end-tour">Saltar</button>
                <div id="onboarding-dots" class="onboarding-step-box__dots"></div>
                <div>
                    <button id="onboarding-prev-btn" class="btn btn--secondary" data-action="prev-tour-step">Anterior</button>
                    <button id="onboarding-next-btn" class="btn btn--primary" data-action="next-tour-step">Siguiente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- === INICIO: NUEVO ASISTENTE DE IMPORTACIÃ“N JSON === -->
    <div id="json-import-wizard-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="json-wizard-title">
        <div class="modal" style="max-width: 500px; height: auto; max-height: 85vh;">
            <header class="modal__header">
                <h3 id="json-wizard-title" class="modal__title">Asistente de ImportaciÃ³n JSON</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="json-import-wizard-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="json-wizard-body" class="modal__body" style="display: flex; flex-direction: column;">

                <!-- PASO 1: SELECCIÃ“N DE ARCHIVO -->
                <div id="json-wizard-step-1" class="json-wizard-step">
                    <h4>Paso 1: Selecciona tu copia de seguridad</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);">Arrastra y suelta el archivo <code>.json</code> o haz clic para seleccionarlo. La importaciÃ³n reemplazarÃ¡ <strong>todos</strong> tus datos actuales.</p>
                    <div id="json-drop-zone">
                        <span class="material-icons" style="font-size: 48px; color: var(--c-outline);">upload_file</span>
                        <p id="json-drop-zone-text">Arrastra tu archivo aquÃ­ o haz clic</p>
                    </div>
                    <div id="json-file-error" class="form-error" style="text-align: center; margin-top: var(--sp-3);"></div>
                </div>

                <!-- PASO 2: VISTA PREVIA Y CONFIRMACIÃ“N -->
                <div id="json-wizard-step-2" class="json-wizard-step" style="display: none;">
                    <h4>Paso 2: Revisa y confirma</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);">Hemos analizado tu archivo. Si los datos son correctos, pulsa "Importar" para reemplazar tus datos actuales.</p>
                    <div id="json-preview-container">
                        <ul id="json-preview-list"></ul>
                        <div class="form-error" style="margin-top: var(--sp-2); text-align: center;"><strong>AtenciÃ³n:</strong> Esta acciÃ³n es irreversible.</div>
                    </div>
                    <div class="modal__actions" style="justify-content: space-between;">
                        <button class="btn btn--secondary" data-action="json-wizard-back-2">AtrÃ¡s</button>
                        <button class="btn btn--danger" data-action="json-wizard-import-final"><span class="material-icons">warning</span>Importar y Reemplazar</button>
                    </div>
                </div>

                <!-- PASO 3: PROGRESO Y RESULTADO -->
                <div id="json-wizard-step-3" class="json-wizard-step" style="display: none; justify-content: center; align-items: center; text-align: center; min-height: 200px;">
                    <div id="json-import-progress">
                        <span class="spinner" style="width: 48px; height: 48px; border-width: 4px;"></span>
                        <h4 style="margin-top: var(--sp-4);">Importando...</h4>
                        <p>Estamos guardando tus datos. Por favor, no cierres esta ventana.</p>
                    </div>
                     <div id="json-import-result" style="display: none;">
                        <span class="material-icons" style="font-size: 60px; color: var(--c-success);">task_alt</span>
                        <h4 id="json-result-title" style="margin-top: var(--sp-2);">Â¡ImportaciÃ³n Completada!</h4>
                        <p id="json-result-message"></p>
                        <div class="modal__actions" style="justify-content: center;">
                            <button class="btn btn--primary" data-action="close-modal" data-modal-id="json-import-wizard-modal">Finalizar</button>
                        </div>
                     </div>
                </div>

            </div>
        </div>
    </div>
    <!-- === FIN: NUEVO ASISTENTE DE IMPORTACIÃ“N JSON === -->


    <div id="exit-screen">
        <p>ðŸ§®âœ¨ Â¡Tus nÃºmeros estÃ¡n en orden, es hora de descansar! âœ¨ðŸ§®<br>ðŸ’° Tu asistente de finanzas personales se queda cuidando tus cuentas ðŸ’°</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script type="module">
        // =================================================================================
        // MIGRATION SCRIPT HELPER
        // =================================================================================
        /* 
            IMPORTANTE: GUÃA DE MIGRACIÃ“N DE DATOS PARA PAGINACIÃ“N

            Esta nueva versiÃ³n de la aplicaciÃ³n requiere una estructura de datos diferente en Firestore
            para poder funcionar correctamente. Necesitas ejecutar una migraciÃ³n UNA SOLA VEZ
            para tu cuenta.

            CÃ“MO MIGRAR:
            1.  **HAZ UNA COPIA DE SEGURIDAD:** Antes de nada, ve a Ajustes -> Copia de Seguridad -> Exportar JSON.
            2.  **INICIA SESIÃ“N:** AsegÃºrate de haber iniciado sesiÃ³n en la aplicaciÃ³n en tu navegador.
            3.  **ABRE LA CONSOLA:** Abre las herramientas de desarrollador de tu navegador (normalmente con F12 o Cmd+Opt+J)
                y ve a la pestaÃ±a "Consola".
            4.  **EJECUTA EL SCRIPT:** Pega la siguiente lÃ­nea de cÃ³digo en la consola y presiona Enter:
                
                migrateDataToSubcollections()

            5.  **ESPERA:** El script tardarÃ¡ un momento en procesar todos tus datos. La consola te
                avisarÃ¡ cuando haya terminado con "Â¡MIGRACIÃ“N COMPLETADA!".
            6.  **RECARGA LA APP:** Recarga la pÃ¡gina (F5 o Cmd+R). Tu aplicaciÃ³n ahora usarÃ¡ la nueva
                estructura de datos y la paginaciÃ³n.

            El script de migraciÃ³n estÃ¡ definido mÃ¡s abajo en este mismo fichero (`migrateDataToSubcollections`).
        */
       
       // =================================================================================
        // 1. STATE & GLOBAL VARIABLES (CORREGIDO)
        // =================================================================================
        
        // --- CONSTANTES DE LA APLICACIÃ“N ---
        // INICIO CAMBIO: Se elimina la constante de la pÃ¡gina de informes
        const PAGE_IDS = {
            MOVIMIENTOS: 'movimientos-page',
            PANEL: 'panel-control-page',
            CUENTAS: 'cuentas-page',
            INVERSIONES: 'inversiones-page',
            PRESUPUESTOS: 'presupuestos-page',
            CONFIGURACION: 'configuracion-page',
        };
        // FIN CAMBIO
        const quotesData = [ { "cita": "Los inversores conservadores duermen bien.", "autor": "Benjamin Graham" }, { "cita": "Nunca asciendas a alguien que no ha cometido errores, porque si lo haces, estÃ¡s ascendiendo a alguien que nunca ha hecho nada.", "autor": "Benjamin Graham" }, { "cita": "Si se han hecho los deberes antes de comprar una acciÃ³n, el momento de venderla es: normalmente, nunca.", "autor": "Benjamin Graham" }, { "cita": "Mientras que el entusiasmo Ã© necesario para conseguir grandes logros en cualquier lugar, en Wall Street suele conducir al desastre.", "autor": "John Templeton" }, { "cita": "Sin tener fe en el futuro, nadie invertirÃ­a. Para ser inversor, debes creer en un maÃ±ana mejor.", "autor": "John Templeton" }, { "cita": "Las cuatro palabras mÃ¡s caras de nuestro lenguaje son: 'Esta vez es diferente'.", "autor": "John Templeton" }, { "cita": "CÃ©ntrate en el valor porque la mayorÃ­a de los inversores se fijan en perspectivas y tendencias.", "autor": "Peter Lynch" }, { "cita": "El Ã©xito es un proceso de bÃºsqueda continua de respuestas a nuevas preguntas.", "autor": "Peter Lynch" }, { "cita": "Conoce en lo que inviertes, y por quÃ©.", "autor": "Peter Lynch" }, { "cita": "Cuando vendes en momentos de desesperaciÃ³n, siempre vendes barato.", "autor": "Peter Lynch" }, { "cita": "Una persona que posee una propiedad y tiene una participaciÃ³n en la empresa probablemente trabajarÃ¡ mÃ¡s duro, se sentirÃ¡ mÃ¡s feliz y harÃ¡ un mejor trabajo que otra que no tiene nada.", "autor": "Peter Lynch" }, { "cita": "El riesgo viene de no saber lo que se estÃ¡ haciendo.", "autor": "Warren Buffett" }, { "cita": "Cuesta 20 aÃ±os construir una reputaciÃ³n y 5 minutos destruirla. Si piensas sobre ello, harÃ¡s las cosas de manera diferente.", "autor": "Warren Buffett" }, { "cita": "En el mundo de los negocios, el espejo retrovisor estÃ¡ siempre mÃ¡s claro que el parabrisas.", "autor": "Warren Buffett" }, { "cita": "La inversiÃ³n mÃ¡s importante que puedes hacer es en uno mismo.", "autor": "Warren Buffett" }, { "cita": "SÃ© temeroso cuando otros sean avariciosos, sÃ© avaricioso cuando otros sean temerosos.", "autor": "Warren Buffett" }, { "cita": "SÃ© consciente de lo que no sabes. SiÃ©ntete a gusto entendiendo tus errores y debilidades.", "autor": "Charlie Munger" }, { "cita": "Para hacer dinero en los mercados, tienes que pensar diferente y ser humilde.", "autor": "Charlie Munger" }, { "cita": "El principal problema del inversor, e incluso su peor enemigo, es probablemente Ã©l mismo", "autor": "Benjamin Graham" }, { "cita": "Las personas que no pueden controlar sus emociones no son aptas para obtener beneficios mediante la inversiÃ³n", "autor": "Benjamin Graham" }, { "cita": "Trato de comprar acciones en los negocios que son tan maravillosos que un tonto podrÃ­a manejarlos. Tarde o temprano uno lo harÃ¡", "autor": "Warren Buffett" }, { "cita": "Un inversor deberÃ­a actuar como si tuviera una tarjeta con solo 20 decisiones (de compra) para tomar a lo largo de su vida", "autor": "Warren Buffett" }, { "cita": "Regla nÃºmero 1: nunca pierdas dinero. Regla nÃºmero 2: nunca olvides la regla nÃºmero 1", "autor": "Warren Buffett" }, { "cita": "Se gana dinero descontando lo obvio y apostando a lo inesperado", "autor": "George Soros" }, { "cita": "El problema no es lo que uno no sabe, sino lo que uno cree que sabe estando equivocado", "autor": "George Soros" }, { "cita": "Si invertir es entretenido, si te estÃ¡s divirtiendo, probablemente no estÃ©s ganando dinero. Las buenas inversiones son aburridas", "autor": "George Soros" }, { "cita": "Se puede perder dinero a corto plazo, pero necesitas del largo plazo para ganar dinero", "autor": "Peter Lynch" }, { "cita": "La mejor empresa para comprar puede ser alguna que ya tienes en cartera", "autor": "Peter Lynch" }, { "cita": "La clave para ganar dinero con las acciones es no tenerles miedo", "autor": "Peter Lynch" }, { "cita": "Los mercados alcistas nacen en el pesimismo, crecen en el escepticismo, maduran en el optimismo y mueren en la euforia", "autor": "John Templeton" }, { "cita": "El momento de mÃ¡ximo pesimismo es el mejor para comprar y el momento de mÃ¡ximo optimismo es el mejor para vender", "autor": "John Templeton" }, { "cita": "Un inversor que tiene todas las respuestas ni siquiera entiende las preguntas", "autor": "John Templeton" }, { "cita": "La inversiÃ³n es un negocio a largo plazo donde la paciencia marca la rentabilidad", "autor": "Francisco GarcÃ­a ParamÃ©s" }, { "cita": "Â¿CuÃ¡ndo vendemos un valor? Respondemos siempre: cuando haya una oportunidad mejor. Ese es nuestro objetivo permanente, mejorar la cartera cada dÃ­a", "autor": "Francisco GarcÃ­a ParamÃ©s" }, { "cita": "Lo que en la Bolsa saben todos, no me interesa", "autor": "AndrÃ© Kostolany" }, { "cita": "No sirve para nada proclamar la verdad en economÃ­a o recomendar cosas Ãºtiles. Es la mejor manera de hacerse enemigos", "autor": "AndrÃ© Kostolany" }, { "cita": "Un inversionista pierde la capacidad de raciocinio cuando gana los primeros diez mil dÃ³lares. A partir de entonces se convierte en un pelele fÃ¡cilmente manipulable", "autor": "AndrÃ© Kostolany" }, { "cita": "Comprar tÃ­tulos, acciones de empresas, tomarse unas pastillas para dormir durante 20/30 aÃ±os y cuando uno despierta, Â¡voilÃ ! es millonario", "autor": "AndrÃ© Kostolany" }, { "cita": "No sÃ© si los prÃ³ximos 1.000 puntos del Dow Jones serÃ¡n hacia arriba o hacia abajo, pero estoy seguro de que los prÃ³ximos 10.000 serÃ¡n hacia arriba", "autor": "Peter Lynch" }, { "cita": "El destino de un inversor lo marca su estÃ³mago , no su cerebro", "autor": "Peter Lynch" }, { "cita": "No siga mis pasos porque aun en el caso de que acierte al comprar usted no sabrÃ¡ cuando vendo", "autor": "Peter Lynch" }, { "cita": "Calcule las 'ganancias del dueÃ±o' para conseguir una reflexiÃ³n verdadera del valor", "autor": "Warren Buffett" }, { "cita": "Busque compaÃ±Ã­as con altos mÃ¡rgenes de beneficio", "autor": "Warren Buffett" }, { "cita": "Invierta siempre para el largo plazo", "autor": "Warren Buffett" }, { "cita": "El consejo de que 'usted nunca quiebra tomando un beneficio' es absurdo", "autor": "Warren Buffett" }, { "cita": "Â¿El negocio tiene una historia de funcionamiento constante?", "autor": "Warren Buffett" }, { "cita": "Recuerde que el mercado de valores es manÃ­aco-depresivo", "autor": "Benjamin Graham" }, { "cita": "Compre un negocio, no alquile la acciÃ³n", "autor": "Warren Buffett" }, { "cita": "Mientras mÃ¡s absurdo sea el comportamiento del mercado mejor serÃ¡ la oportunidad para el inversor metÃ³dico", "autor": "Benjamin Graham" }, { "cita": "Se puede perder dinero a corto plazo, pero usted sigue siendo un idiota", "autor": "Joel Greenblatt" }, { "cita": "Los mercados alcistas no tienen resistencia y los bajistas no tienen soporte", "autor": "Ed Downs" }, { "cita": "El pÃ¡nico causa que vendas en el bajÃ³n, y la codicia causa que compres cerca a la cima", "autor": "Stan Weinstein" }, { "cita": "Las dos grandes fuerzas que mueven los mercados son la codicia y el miedo", "autor": "AnÃ³nimo" }, { "cita": "Todo lo que sube baja y todo lo que baja sube", "autor": "AnÃ³nimo" }, { "cita": "Si no sientes miedo en el momento de comprar es que estÃ¡s comprando mal", "autor": "AnÃ³nimo" }, { "cita": "Que el Ãºltimo duro lo gane otro", "autor": "AnÃ³nimo" }, { "cita": "La clave para hacer dinero en acciones es no asustarse de ellas", "autor": "Peter Lynch" }, { "cita": "El precio es lo que pagas, el valor es lo que recibes", "autor": "Warren Buffett" }, { "cita": "No es necesario hacer cosas extraordinarias para conseguir resultados extraordinarios", "autor": "Warren Buffett" }, { "cita": "Alguien estÃ¡ sentado en la sombra hoy porque alguien plantÃ³ un Ã¡rbol mucho tiempo atrÃ¡s", "autor": "Warren Buffett" }, { "cita": "Ãšnicamente cuando la marea baja, descubres quiÃ©n ha estado nadando desnudo", "autor": "Warren Buffett" }, { "cita": "No tenemos que ser mÃ¡s inteligentes que el resto, tenemos que ser mÃ¡s disciplinados que el resto", "autor": "Warren Buffett" }, { "cita": "Si compras cosas que no necesitas, pronto tendrÃ¡s que vender cosas que necesitas", "autor": "Warren Buffett" }, { "cita": "Nunca inviertas en un negocio que no puedas entender", "autor": "Warren Buffett" }, { "cita": "El tiempo es amigo de las empresas maravillosas y enemigo de las mediocres", "autor": "Warren Buffett" }, { "cita": "Nuestro periodo de espera favorito es para siempre", "autor": "Warren Buffett" }, { "cita": "Wall Street es el Ãºnico lugar al que las personas van en un Rolls-Royce, para recibir asesorÃ­a de quienes toman el metro", "autor": "Warren Buffett" }, { "cita": "Llega un momento en el que debes empezar a hacer lo que realmente quieres. Busca un trabajo que te guste y saltarÃ¡s de la cama cada maÃ±ana con fuerza", "autor": "Warren Buffett" }, { "cita": "Es siempre mejor pasar el tiempo con gente mejor que tÃº. Escoge asociados cuyo comportamiento es mejor que el tuyo e irÃ¡s en esa direcciÃ³n", "autor": "Warren Buffett" }, { "cita": "Toma 20 aÃ±os en construir una reputaciÃ³n y 5 minutos en arruinarla. Si piensas sobre ello, harÃ¡s las cosas de forma diferente", "autor": "Warren Buffett" }, { "cita": "No importa el talento o los esfuerzos, hay cosas que llevan tiempo. No puedes producir un bebÃ© en un mes dejando embarazadas a 9 mujeres", "autor": "Warren Buffett" }, { "cita": "Las oportunidades aparecen pocas veces. Cuando llueva oro sal a la calle con un cesto grande y no con un dedal", "autor": "Warren Buffett" }, { "cita": "La gente siempre me pregunta dÃ³nde deberÃ­an trabajar y yo siempre les digo que vayan a trabajar con aquellos a los que mÃ¡s admiran", "autor": "Warren Buffett" }, { "cita": "Â¿CuÃ¡ndo hay que vender una acciÃ³n? Pues cuando tengamos una oportunidad mejor a la vista", "autor": "Francisco GarcÃ­a ParamÃ©s" }, { "cita": "Nunca acudo a las OPV, me gusta estar en las empresas que pueden ser opadas por competidores, no en las salidas a bolsa", "autor": "Francisco GarcÃ­a ParamÃ©s" }, { "cita": "Si en el mercado hay mÃ¡s tontos que papel, la bolsa va a subir, si hay mÃ¡s papel que tontos, la bolsa baja", "autor": "AndrÃ© Kostolany" }, { "cita": "No persiga nunca una acciÃ³n, tenga paciencia que la prÃ³xima oportunidad va a llegar con toda seguridad", "autor": "AndrÃ© Kostolany" }, { "cita": "Lo que todos saben en la bolsa, no nos interesa a los especuladores", "autor": "AndrÃ© Kostolany" }, { "cita": "Las inversiones exitosas consisten en saber gestionar el riesgo, no en evitarlo.", "autor": "Benjamin Graham" }, { "cita": "Una gran compaÃ±Ã­a no es una buena inversiÃ³n si pagas mucho por la acciÃ³n", "autor": "Benjamin Graham" }, { "cita": "A veces es mejor pensar una hora sobre el dinero que dedicar una semana a trabajar para obtenerlo.", "autor": "AndrÃ© Kostolany" }, { "cita": "En la Bolsa, con frecuencia, hay que cerrar los ojos para ver mejor.", "autor": "AndrÃ© Kostolany" }, { "cita": "Si la inversiÃ³n es entretenida, si te estÃ¡s divirtiendo, es probable que no estÃ©s ganando dinero. Una buena inversiÃ³n es aburrida.", "autor": "George Soros" }, { "cita": "Las burbujas del mercado de valores no crecen de la nada. Tienen una base sÃ³lida en la realidad, pero la realidad estÃ¡ distorsionada por un malentendido.", "autor": "George Soros" }, { "cita": "Nunca digas que no puedes permitirte algo. Esa es la aptitud de un hombre pobre. PregÃºntate cÃ³mo permitÃ­rtelo.", "autor": "Robert Kiyosaki" }, { "cita": "Una diferencia importante es que los ricos compran los lujos al final, mientras que los pobres y la clase media tienden a comprar los lujos primero.", "autor": "Robert Kiyosaki" }, { "cita": "MantÃ©n tus activos bajo mÃ­nimos, reduce los pasivos y, con mucha disciplina, ve construyendo una base de activos sÃ³lida.", "autor": "Robert Kiyosaki" }, { "cita": "No ahorres lo que queda despuÃ©s de gastar, sino gasta lo que queda despuÃ©s de ahorrar.", "autor": "Warren Buffett" }, { "cita": "El riesgo viene de no saber lo que estÃ¡s haciendo.", "autor": "Warren Buffett" }, { "cita": "Sea temeroso cuando otros son codiciosos, y sea codicioso cuando otros son temerosos.", "autor": "Warren Buffett" }, { "cita": "No compres cosas que no necesitas, con dinero que no tienes, para impresionar a gente que no te importa.", "autor": "Dave Ramsey" } ];
        const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };
        const AVAILABLE_WIDGETS = {
            'kpi-summary': { title: 'Resumen de KPIs', description: 'Ingresos, gastos y saldo neto del periodo.', icon: 'summarize' },
            'concept-totals': { title: 'Totales por Concepto', description: 'GrÃ¡fico y lista detallada de gastos/ingresos por concepto.', icon: 'bar_chart' }
        };
        const DEFAULT_DASHBOARD_WIDGETS = ['kpi-summary', 'concept-totals'];
        const getInitialDb = () => ({
            cuentas: [], 
            conceptos: [], 
            movimientos: [], 
            presupuestos: [],
            recurrentes: [],
            inversiones_historial: [],
            inversion_cashflows: [],
            config: { 
                skipIntro: false,
                dashboardWidgets: DEFAULT_DASHBOARD_WIDGETS
            } 
        });
        // --- ESTADO GLOBAL Y DE PAGINACIÃ“N ---
		let currentUser = null, unsubscribeListeners = [], db = getInitialDb(), deselectedAccountTypesFilter = new Set();
        let isOffBalanceMode = false;
        let descriptionIndex = {};
		let globalSearchDebounceTimer = null;
		let newMovementIdToHighlight = null;
        const originalButtonTexts = new Map();
        let conceptosChart = null, liquidAssetsChart = null, detailInvestmentChart = null, informesChart = null;
        let currentTourStep = 0;
        let lastScrollTop = null;
        
        // --- ESTADO PARA EL ASISTENTE DE IMPORTACIÃ“N DE JSON ---
        let jsonWizardState = {
            file: null,
            data: null,
            preview: {
                counts: {},
                meta: {}
            }
        };
        
        // --- Variables para la paginaciÃ³n de movimientos ---
		const MOVEMENTS_PAGE_SIZE = 200;
        let lastVisibleMovementDoc = null; 
        let isLoadingMoreMovements = false; 
        let allMovementsLoaded = false; 
        
        let runningBalancesCache = null; // CachÃ© para los saldos corrientes.
        
        const vList = {
			scrollerEl: null, sizerEl: null, contentEl: null, items: [], itemMap: [], 
			heights: {}, 
			renderBuffer: 10, lastRenderedRange: { start: -1, end: -1 }, isScrolling: null
		};
        
        const calculatorState = {
            displayValue: '0',
            waitingForNewValue: true,
            targetInput: null,
        };
                const buildDescriptionIndex = () => {
            descriptionIndex = {}; // Reset index
            if (!db.movimientos || db.movimientos.length === 0) return;

            // Para mejorar el rendimiento, solo indexamos los movimientos mÃ¡s recientes
            const movementsToIndex = db.movimientos.slice(0, 500); 

            movementsToIndex.forEach(mov => {
                const desc = mov.descripcion.trim().toLowerCase();
                if (desc.length > 3) { // Solo indexar descripciones significativas
                    if (!descriptionIndex[desc]) {
                        descriptionIndex[desc] = {
                            conceptoId: mov.conceptoId,
                            count: 0
                        };
                    }
                    descriptionIndex[desc].count++;
                }
            });
        };
               
        // =================================================================================
        // 1.5 TOUR DE BIENVENIDA (ONBOARDING)
        // =================================================================================
        const tourSteps = [
            {
                element: `button[data-page="${PAGE_IDS.MOVIMIENTOS}"]`,
                page: PAGE_IDS.MOVIMIENTOS,
                title: 'Â¡Bienvenido/a!',
                content: 'Este es un tour rÃ¡pido para mostrarte cÃ³mo funciona todo. Empecemos por la navegaciÃ³n principal. AquÃ­ puedes ver tus Movimientos.',
                position: 'top'
            },
            {
                element: '#fab-add-movimiento',
                page: PAGE_IDS.MOVIMIENTOS,
                title: 'AÃ±adir Movimientos',
                content: 'Usa este botÃ³n flotante para aÃ±adir nuevos gastos, ingresos o traspasos. Es el corazÃ³n de la aplicaciÃ³n. Â¡PruÃ©balo despuÃ©s del tour!',
                position: 'top-left'
            },
            {
                element: `button[data-page="${PAGE_IDS.PANEL}"]`,
                page: PAGE_IDS.PANEL,
                title: 'El Panel de Control',
                content: 'AquÃ­ tienes una vista general de tus finanzas. De un vistazo verÃ¡s tus ingresos, gastos y cÃ³mo se comparan con periodos anteriores.',
                position: 'top'
            },
            {
                element: '#kpi-container',
                page: PAGE_IDS.PANEL,
                title: 'Indicadores Clave (KPIs)',
                content: 'Estos son tus signos vitales financieros. Te muestran el resumen del periodo que hayas filtrado. Â¡Verde para ingresos, Rojo para gastos!',
                position: 'bottom'
            },
            {
                element: `button[data-page="${PAGE_IDS.CUENTAS}"]`,
                page: PAGE_IDS.CUENTAS,
                title: 'Tus Cuentas',
                content: 'Esta secciÃ³n agrupa tu dinero por "recipientes": tu banco, tu cartera, PayPal, etc. Es la foto de tu patrimonio.',
                position: 'top'
            },
            {
                element: '#ledger-toggle-btn',
                page: PAGE_IDS.CUENTAS,
                title: 'Contabilidad Dual (A/B)',
                content: 'Â¡FunciÃ³n estrella! Pulsa aquÃ­ para cambiar entre tu contabilidad principal (A) y una secundaria (B). Ideal para separar finanzas personales de un negocio, o gastos compartidos.',
                position: 'bottom'
            },
            {
                element: 'button[data-action="help"]',
                page: PAGE_IDS.CONFIGURACION,
                title: 'Ayuda y ConfiguraciÃ³n',
                content: 'En la secciÃ³n de Ajustes, encontrarÃ¡s este botÃ³n de ayuda. Contiene una guÃ­a detallada (Â¡mucho mÃ¡s que este tour!) y te permite volver a empezar este recorrido cuando quieras.',
                position: 'bottom-right'
            },
            {
                element: '#app-root',
                page: PAGE_IDS.CONFIGURACION,
                title: 'Â¡Todo Listo!',
                content: 'Has completado el tour. Ahora te toca a ti explorar y tomar el control de tus finanzas. Â¡Empieza aÃ±adiendo tus cuentas y tu primer movimiento!',
                position: 'center'
            }
        ];
        
        const startTour = async () => {
            hideModal('generic-modal'); 
            localStorage.removeItem('tourCompleted');
            currentTourStep = 0;
            const tourOverlay = select('onboarding-tour');
            if (tourOverlay) tourOverlay.classList.add('onboarding-overlay--visible');
            await showTourStep(currentTourStep);
        };
        
        const endTour = () => {
            const tourOverlay = select('onboarding-tour');
            if (tourOverlay) tourOverlay.classList.remove('onboarding-overlay--visible');
            localStorage.setItem('tourCompleted', 'true');
            const highlightBox = select('onboarding-highlight');
            if (highlightBox) highlightBox.style.display = 'none';
        };
        
        const nextTourStep = async () => {
            if (currentTourStep < tourSteps.length - 1) {
                currentTourStep++;
                await showTourStep(currentTourStep);
            } else {
                endTour();
            }
        };
        
        const prevTourStep = async () => {
            if (currentTourStep > 0) {
                currentTourStep--;
                await showTourStep(currentTourStep);
            }
        };
        
        const showTourStep = async (stepIndex) => {
            const step = tourSteps[stepIndex];
            if (!step) return;
        
            const activePageId = document.querySelector('.view--active')?.id;
            if (step.page && activePageId !== step.page) {
                navigateTo(step.page, false);
                await wait(350);
            }
        
            const targetElement = select(step.element) || selectOne(step.element);
            const highlightBox = select('onboarding-highlight');
            const stepBox = select('onboarding-step-box');
        
            if (!targetElement || !highlightBox || !stepBox) {
                console.warn('Onboarding element not found:', step.element);
                await nextTourStep();
                return;
            }
        
            select('onboarding-title').textContent = step.title;
            select('onboarding-content').textContent = step.content;
        
            const dotsContainer = select('onboarding-dots');
            dotsContainer.innerHTML = tourSteps.map((_, index) => 
                `<div class="onboarding-step-box__dot ${index === stepIndex ? 'onboarding-step-box__dot--active' : ''}"></div>`
            ).join('');
        
            select('onboarding-prev-btn').style.visibility = stepIndex === 0 ? 'hidden' : 'visible';
            select('onboarding-next-btn').textContent = stepIndex === tourSteps.length - 1 ? 'Finalizar' : 'Siguiente';
        
            const rect = targetElement.getBoundingClientRect();
            highlightBox.style.display = 'block';
            highlightBox.style.width = `${rect.width + 8}px`;
            highlightBox.style.height = `${rect.height + 8}px`;
            highlightBox.style.top = `${rect.top - 4}px`;
            highlightBox.style.left = `${rect.left - 4}px`;
            
            const boxRect = stepBox.getBoundingClientRect();
            const margin = 16;
            let top, left;
        
            switch (step.position) {
                case 'top': top = rect.top - boxRect.height - margin; left = rect.left + (rect.width / 2) - (boxRect.width / 2); break;
                case 'bottom': top = rect.bottom + margin; left = rect.left + (rect.width / 2) - (boxRect.width / 2); break;
                case 'left': top = rect.top + (rect.height / 2) - (boxRect.height / 2); left = rect.left - boxRect.width - margin; break;
                case 'right': top = rect.top + (rect.height / 2) - (boxRect.height / 2); left = rect.right + margin; break;
                case 'top-left': top = rect.top - boxRect.height - margin; left = rect.right - boxRect.width; break;
                case 'bottom-right': top = rect.bottom + margin; left = rect.left + rect.width - boxRect.width; break;
                case 'center': top = (window.innerHeight / 2) - (boxRect.height / 2); left = (window.innerWidth / 2) - (boxRect.width / 2); highlightBox.style.display = 'none'; break;
                default: top = rect.bottom + margin; left = rect.left + (rect.width / 2) - (boxRect.width / 2);
            }
            
            stepBox.style.top = `${Math.max(margin, Math.min(top, window.innerHeight - boxRect.height - margin))}px`;
            stepBox.style.left = `${Math.max(margin, Math.min(left, window.innerWidth - boxRect.width - margin))}px`;
        };
        
        
        // =================================================================================
        // 2. FIREBASE & DATA HANDLING (REFACTORIZADO PARA PAGINACIÃ“N Y CONSULTAS EFICIENTES)
        // =================================================================================
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        fbAuth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
        const fbDb = firebase.firestore();
        
        fbDb.enablePersistence({synchronizeTabs: true}).catch(err => {
            if (err.code == 'failed-precondition') showToast('Modo offline no disponible (mÃºltiples pestaÃ±as).', 'warning');
            else if (err.code == 'unimplemented') showToast('Navegador no soporta modo offline.', 'warning');
        });
        
        // --- NUEVOS ASISTENTES DE FIRESTORE ---
        async function saveDoc(collectionName, docId, data, btn = null) {
            if (!currentUser) { showToast("Error: No hay usuario.", "danger"); return; }
            if (btn) setButtonLoading(btn, true);
            try {
                const docRef = fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(docId);
                await docRef.set(data, { merge: true });
                if (btn) setButtonLoading(btn, false);
            } catch (error) {
                console.error(`Error guardando en ${collectionName}:`, error);
                showToast("Error al guardar.", "danger");
                if (btn) setButtonLoading(btn, false);
            }
        }

        /**
         * Actualiza el saldo de una cuenta de forma atÃ³mica.
         * @param {string} cuentaId - El ID de la cuenta a actualizar.
         * @param {number} amountInCents - La cantidad a sumar (positivo para ingresos, negativo para gastos).
         */
        async function updateAccountBalance(cuentaId, amountInCents) {
            if (!currentUser || !cuentaId || typeof amountInCents !== 'number') {
                console.error("Argumentos invÃ¡lidos para updateAccountBalance");
                return;
            }

            try {
                const accountRef = fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(cuentaId);
                // FieldValue.increment es una operaciÃ³n atÃ³mica del lado del servidor.
                // Es la forma mÃ¡s segura y eficiente de actualizar contadores.
                await accountRef.update({
                    saldo: firebase.firestore.FieldValue.increment(amountInCents)
                });
            } catch (error) {
                console.error(`Error al actualizar saldo de la cuenta ${cuentaId}:`, error);
                showToast("Error crÃ­tico: no se pudo actualizar el saldo.", "danger");
            }
        }
        
/**
 * Script de migraciÃ³n de un solo uso para calcular y guardar el saldo inicial
 * en cada documento de cuenta. EJECUTAR UNA SOLA VEZ DESDE LA CONSOLA.
 */
async function migrateBalancesToAccounts() {
    if (!currentUser) {
        console.error("Debes iniciar sesiÃ³n para ejecutar la migraciÃ³n.");
        return;
    }
    console.log("ðŸš€ Iniciando migraciÃ³n de saldos...");

    // Usamos fbDb, que es nuestra instancia de Firestore en el cliente.
    const userRef = fbDb.collection('users').doc(currentUser.uid);

    // 1. Obtener todas las cuentas y resetear sus saldos a 0.
    const cuentasSnapshot = await userRef.collection('cuentas').get();
    const cuentas = {};
    cuentasSnapshot.forEach(doc => {
        cuentas[doc.id] = { ref: doc.ref, saldo: 0 };
    });

            const movimientosSnapshot = await userRef.collection('movimientos').get();
            console.log(`Procesando ${movimientosSnapshot.size} movimientos...`);
            movimientosSnapshot.forEach(doc => {
                const mov = doc.data();
                if (mov.tipo === 'traspaso') {
                    if (cuentas[mov.cuentaOrigenId]) cuentas[mov.cuentaOrigenId].saldo -= mov.cantidad;
                    if (cuentas[mov.cuentaDestinoId]) cuentas[mov.cuentaDestinoId].saldo += mov.cantidad;
                } else {
                    if (cuentas[mov.cuentaId]) cuentas[mov.cuentaId].saldo += mov.cantidad;
                }
            });

            const batch = fbDb.batch(); 
            for (const cuentaId in cuentas) {
                const cuentaData = cuentas[cuentaId];
                batch.update(cuentaData.ref, { saldo: cuentaData.saldo });
            }

            await batch.commit();
            console.log(`ðŸŽ‰ Â¡MigraciÃ³n completada! Se actualizaron los saldos de ${Object.keys(cuentas).length} cuentas.`);
            alert("Â¡MigraciÃ³n de saldos completada! La aplicaciÃ³n ahora usarÃ¡ los saldos en tiempo real. Por favor, recarga la pÃ¡gina para ver los cambios.");
        }
        window.migrateBalancesToAccounts = migrateBalancesToAccounts;
        
        async function deleteDoc(collectionName, docId) {
            if (!currentUser) { showToast("Error: No hay usuario.", "danger"); return; }
            try {
                await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(docId).delete();
            } catch (error) {
                console.error(`Error borrando de ${collectionName}:`, error);
                showToast("Error al borrar.", "danger");
            }
        }
        
        // --- FUNCIÃ“N DE CARGA PRINCIPAL REFACTORIZADA ---
        async function loadCoreData(uid) {
            // Limpia listeners anteriores si existen
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            
            const userRef = fbDb.collection('users').doc(uid);

            const collectionsToLoad = ['cuentas', 'conceptos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];

            collectionsToLoad.forEach(collectionName => {
                const unsubscribe = userRef.collection(collectionName).onSnapshot(snapshot => {
                    db[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (['cuentas', 'conceptos'].includes(collectionName)) {
                        populateAllDropdowns();
                    }
                    
                    if (collectionName === 'cuentas' && select(PAGE_IDS.CUENTAS)?.classList.contains('view--active')) {
                        renderCuentas();
                    }
                }, error => {
                    console.error(`Error escuchando la colecciÃ³n ${collectionName}: `, error);
                    showToast(`Error al cargar datos de ${collectionName}.`, 'danger');
                });
                unsubscribeListeners.push(unsubscribe);
            });

            const unsubConfig = userRef.onSnapshot(doc => {
                db.config = doc.exists && doc.data().config ? doc.data().config : getInitialDb().config;
                localStorage.setItem('skipIntro', db.config?.skipIntro || 'false');
                loadConfig(); // Aplicar config a la UI
            }, error => {
                console.error("Error escuchando la configuraciÃ³n del usuario: ", error);
                showToast("Error al cargar la configuraciÃ³n.", "danger");
            });
            unsubscribeListeners.push(unsubConfig);

            await processRecurringMovements(); // Procesar recurrentes al cargar
            
            buildDescriptionIndex();
            startMainApp();
        };

        const checkAuthState = () => {
            fbAuth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadCoreData(user.uid);
                } else {
                    currentUser = null;
                    unsubscribeListeners.forEach(unsub => unsub());
                    unsubscribeListeners = [];
                    db = getInitialDb();
                    showLoginScreen();
                }
            });
        };

        // =================================================================================
        // 2.5. LÃ“GICA DE MOVIMIENTOS RECURRENTES
        // =================================================================================
        const calculateNextDueDate = (currentDueDate, frequency) => {
            const { addDays, addWeeks, addMonths, addYears } = dateFns;
            const d = new Date(currentDueDate);
            d.setHours(12, 0, 0, 0); 
        
            switch (frequency) {
                case 'daily': return addDays(d, 1);
                case 'weekly': return addWeeks(d, 1);
                case 'monthly': return addMonths(d, 1);
                case 'yearly': return addYears(d, 1);
                default: return d;
            }
        };

        const processRecurringMovements = async () => {
             if (!currentUser || !db.recurrentes || db.recurrentes.length === 0) {
                return false;
            }
        
            const now = new Date();
            let movementsCreated = 0;
            const batch = fbDb.batch();
            let hasChangesInBatch = false;

            for (const r of db.recurrentes) {
                let nextDate = new Date(r.nextDate);
                let currentRecurrenceNextDate = r.nextDate; // Keep track of the updated nextDate for this recurrence
        
                while (nextDate <= now) {
                    const endDate = r.endDate ? new Date(r.endDate) : null;
                    if (endDate && nextDate > endDate) {
                        const recRef = fbDb.collection('users').doc(currentUser.uid).collection('recurrentes').doc(r.id);
                        batch.delete(recRef);
                        hasChangesInBatch = true;
                        break; 
                    }
        
                    const newMovement = {
                        id: generateId(),
                        fecha: nextDate.toISOString(),
                        cantidad: r.cantidad,
                        descripcion: r.descripcion,
                        tipo: r.tipo,
                        cuentaId: r.cuentaId,
                        conceptoId: r.conceptoId,
                        cuentaOrigenId: r.cuentaOrigenId,
                        cuentaDestinoId: r.cuentaDestinoId,
                        sourceRecurrenceId: r.id
                    };
                    const movRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(newMovement.id);
                    batch.set(movRef, newMovement);
                    movementsCreated++;
                    hasChangesInBatch = true;
        
                    const newNextDate = calculateNextDueDate(nextDate, r.frequency);
                    currentRecurrenceNextDate = newNextDate.toISOString().slice(0, 10);
                    nextDate = newNextDate;
                }

                if (currentRecurrenceNextDate !== r.nextDate) {
                    const recRef = fbDb.collection('users').doc(currentUser.uid).collection('recurrentes').doc(r.id);
                    batch.update(recRef, { nextDate: currentRecurrenceNextDate });
                    hasChangesInBatch = true;
                }
            }
        
            if (hasChangesInBatch) {
                await batch.commit();
            }

            if (movementsCreated > 0) {
                showToast(`${movementsCreated} movimiento(s) recurrente(s) ha(n) sido aÃ±adido(s).`, 'info', 4000);
                return true;
            }

            return false;
        };


        // =================================================================================
        // 3. UI UTILITIES & HELPERS
        // =================================================================================
        const select = (id) => document.getElementById(id);
        const selectAll = (s) => document.querySelectorAll(s);
        const selectOne = (s) => document.querySelector(s);
		const measureListItemHeights = () => {
    const container = select('movimientos-list-container');
    if (!container) return;
		const chunkArray = (array, size) => {
            const chunks = [];
            for (let i = 0; i < array.length; i += size) {
                chunks.push(array.slice(i, i + size));
            }
            return chunks;
        };

                
    // Crear un movimiento de transacciÃ³n falso
    const tempTransaction = document.createElement('div');
    tempTransaction.style.position = 'absolute';
    tempTransaction.style.visibility = 'hidden';
    tempTransaction.style.zIndex = '-1';
    tempTransaction.innerHTML = renderVirtualListItem({
        type: 'transaction',
        movement: { id: 'temp', fecha: new Date().toISOString(), cantidad: -1000, descripcion: 'MediciÃ³n', tipo: 'movimiento', cuentaId: '1', conceptoId: '1' }
    });
    container.appendChild(tempTransaction);
    vList.heights.transaction = tempTransaction.offsetHeight;
    container.removeChild(tempTransaction);

    // Crear un movimiento de traspaso falso
    const tempTransfer = document.createElement('div');
    tempTransfer.style.position = 'absolute';
    tempTransfer.style.visibility = 'hidden';
    tempTransfer.style.zIndex = '-1';
    tempTransfer.innerHTML = renderVirtualListItem({
        type: 'transaction',
        movement: { id: 'temp', fecha: new Date().toISOString(), cantidad: 5000, descripcion: 'MediciÃ³n Traspaso', tipo: 'traspaso', cuentaOrigenId: '1', cuentaDestinoId: '2' }
    });
    container.appendChild(tempTransfer);
    vList.heights.transfer = tempTransfer.offsetHeight;
    container.removeChild(tempTransfer);

    console.log('Alturas de elementos medidas dinÃ¡micamente:', vList.heights);
};
        const hapticFeedback = (type = 'light') => {
            if ('vibrate' in navigator) {
                try {
                    let pattern;
                    switch (type) {
                        case 'light':   pattern = 10; break;
                        case 'medium':  pattern = 25; break;
                        case 'success': pattern = [15, 60, 15]; break;
                        case 'warning': pattern = [30, 40, 30]; break;
                        case 'error':   pattern = [50, 50, 50]; break;
                        default:        pattern = 10;
                    }
                    navigator.vibrate(pattern);
                } catch (e) {}
            }
        };

        const parseDateStringAsUTC = (dateString) => {
            if (!dateString) return null;
            return new Date(dateString + 'T12:00:00Z');
        };

        const generateId = () => fbDb.collection('users').doc().id;
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const formatCurrency = (numInCents) => {
            const number = (numInCents || 0) / 100;
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(number);
        };
        const toSentenceCase = (str) => {
			if (!str || typeof str !== 'string') return '';
			return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
		};
		const showToast = (message, type = 'default', duration = 3000) => {
            const c = select('toast-container'); if (!c) return;
            const t = document.createElement('div');
            t.className = `toast toast--${type}`;
            t.textContent = message;
            c.appendChild(t);
            
            if (type === 'danger' || type === 'error') hapticFeedback('error');
            else if (type === 'warning') hapticFeedback('warning');

            const animation = t.animate([ { transform: 'translateY(20px) scale(0.95)', opacity: 0 }, { transform: 'translateY(0) scale(1)', opacity: 1 } ], { duration: 300, easing: 'ease-out' });
        
            animation.onfinish = () => { setTimeout(() => { t.animate([ { opacity: 1 }, { opacity: 0 } ], { duration: 300, easing: 'ease-in' }).onfinish = () => t.remove(); }, duration - 600); };
        };
        const setButtonLoading = (btn, isLoading, text = 'Cargando...') => {
            if (!btn) return;
            if (isLoading) { if (!originalButtonTexts.has(btn)) originalButtonTexts.set(btn, btn.innerHTML); btn.setAttribute('disabled', 'true'); btn.classList.add('btn--loading'); btn.innerHTML = `<span class="spinner"></span> <span>${text}</span>`;
            } else { btn.removeAttribute('disabled'); btn.classList.remove('btn--loading'); if (originalButtonTexts.has(btn)) { btn.innerHTML = originalButtonTexts.get(btn); originalButtonTexts.delete(btn); } }
        };
        const displayError = (id, msg) => { const err = select(`${id}-error`); if (err) { err.textContent = msg; err.setAttribute('role', 'alert'); } const inp = select(id); if (inp) inp.classList.add('form-input--invalid'); };
        const clearError = (id) => { const err = select(`${id}-error`); if (err) { err.textContent = ''; err.removeAttribute('role'); } const inp = select(id); if (inp) inp.classList.remove('form-input--invalid'); };
        const clearAllErrors = (formId) => { const f = select(formId); if (!f) return; f.querySelectorAll('.form-error').forEach((e) => e.textContent = ''); f.querySelectorAll('.form-input--invalid').forEach(e => e.classList.remove('form-input--invalid')); };
        const animateCountUp = (el, end, duration = 700, formatAsCurrency = true, prefix = '', suffix = '') => {
            if (!el) return;
            const start = parseFloat(el.dataset.currentValue || '0');
            const endValue = end / 100;
            if (start === endValue || !el.offsetParent) { el.textContent = formatAsCurrency ? formatCurrency(end) : `${prefix}${end}${suffix}`; el.dataset.currentValue = String(endValue); return; }
            el.dataset.currentValue = String(endValue); let startTime = null;
            const step = (timestamp) => { if (!startTime) startTime = timestamp; const p = Math.min((timestamp - startTime) / duration, 1); const current = p * (end - start*100) + start*100; el.textContent = formatAsCurrency ? formatCurrency(current) : `${prefix}${current.toFixed(2)}${suffix}`; if (p < 1) requestAnimationFrame(step); else el.textContent = formatAsCurrency ? formatCurrency(end) : `${prefix}${end/100}${suffix}`; };
            requestAnimationFrame(step);
        };
        const escapeHTML = str => (str ?? '').replace(/[&<>"']/g, match => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[match]);
        
        const parseCurrencyString = (str) => {
            if (typeof str !== 'string' || !str.trim()) return NaN;
            
            let cleanStr = str.replace(/[â‚¬$Â£\s]/g, '');

            const hasComma = cleanStr.includes(',');
            const hasPeriod = cleanStr.includes('.');

            if (hasComma && hasPeriod) {
                if (cleanStr.lastIndexOf(',') > cleanStr.lastIndexOf('.')) {
                    cleanStr = cleanStr.replace(/\./g, '').replace(',', '.');
                } else {
                    cleanStr = cleanStr.replace(/,/g, '');
                }
            } else if (hasComma) {
                cleanStr = cleanStr.replace(',', '.');
            }
            
            return parseFloat(cleanStr);
        };

        // =================================================================================
        // 4. APP INITIALIZATION & AUTH
        // =================================================================================
        const initApp = async () => {
            setupTheme();
            attachEventListeners();
            Chart.register(ChartDataLabels);
            
            const intro = select('introScreen'), quoteContainer = select('quoteContainer');
            if (localStorage.getItem('skipIntro') === 'true') { if (intro) intro.remove(); } 
            else if (intro && quoteContainer && quotesData.length) {
                const r = quotesData[Math.floor(Math.random() * quotesData.length)];
                const quoteTextEl = select('quoteText');
                const quoteAuthorEl = select('quoteAuthor');
                if(quoteTextEl) quoteTextEl.textContent = `"${r.cita}"`;
                if(quoteAuthorEl) quoteAuthorEl.textContent = `â€” ${r.autor}`;
                await wait(2500); quoteContainer.classList.add('visible');
                await wait(4000); (intro).style.opacity = '0';
                await wait(750); intro.remove();
            } else if (intro) { intro.remove(); }
            
            checkAuthState();
        };

        const startMainApp = async () => {
            select('login-screen')?.classList.remove('login-view--visible');
            select('app-root')?.classList.add('app-layout--visible');
            populateAllDropdowns();
            loadConfig();
            
            measureListItemHeights();

            navigateTo(PAGE_IDS.MOVIMIENTOS, true);

            if (localStorage.getItem('tourCompleted') !== 'true') {
                await wait(1000);
                startTour();
            }
        };
        
        const showLoginScreen = () => { select('app-root')?.classList.remove('app-layout--visible'); select('login-screen')?.classList.add('login-view--visible'); };
        const handleLogin = (btn) => {
            const email = (select('login-email')).value.trim(), password = (select('login-password')).value, errEl = select('login-error'); clearAllErrors('login-form'); if(errEl) errEl.textContent = ''; let v = true;
            if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
            if (!password) { displayError('login-password', 'La contraseÃ±a es obligatoria.'); v = false; }
            if (!v) return; setButtonLoading(btn, true, 'Iniciando...');
            fbAuth.signInWithEmailAndPassword(email, password).then(() => showToast(`Â¡Bienvenido/a de nuevo!`)).catch((err) => { setButtonLoading(btn, false); if (['auth/wrong-password', 'auth/user-not-found', 'auth/invalid-credential'].includes(err.code)) (errEl).textContent = 'Error: Credenciales incorrectas.'; else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no vÃ¡lido.'); else (errEl).textContent = 'Error al iniciar sesiÃ³n.'; });
        };
        const handleRegister = (btn) => {
            const email = (select('login-email')).value.trim(), password = (select('login-password')).value, errEl = select('login-error'); clearAllErrors('login-form'); if(errEl) errEl.textContent = ''; let v = true;
            if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
            if (password.length < 6) { displayError('login-password', 'La contraseÃ±a debe tener al menos 6 caracteres.'); v = false; }
            if (!v) return; setButtonLoading(btn, true, 'Registrando...');
            fbAuth.createUserWithEmailAndPassword(email, password).then(() => showToast(`Â¡Registro completado!`)).catch((err) => { setButtonLoading(btn, false); if (err.code == 'auth/weak-password') displayError('login-password', 'La contraseÃ±a debe tener al menos 6 caracteres.'); else if (err.code == 'auth/email-already-in-use') displayError('login-email', 'El correo ya estÃ¡ registrado.'); else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no vÃ¡lido.'); else (errEl).textContent = 'Error en el registro.'; });
        };
        const handleExitApp = () => {
            const exitScreen = select('exit-screen');
            if (exitScreen) {
                exitScreen.style.display = 'flex';
                setTimeout(() => exitScreen.style.opacity = '1', 50);
            }
        };
        
        // =================================================================================
        // 5. NAVIGATION & UI CONTROL
        // =================================================================================
        const navigateTo = (pageId, isInitial = false) => {
            if (!isInitial) hapticFeedback('light');
            
            const titleEl = select('top-bar-title'), actionsEl = select('top-bar-actions'), leftEl = select('top-bar-left-button'), fab = select('fab-add-movimiento');
            const ledgerButtonHTML = `<button id="ledger-toggle-btn" class="btn btn--secondary" data-action="toggle-ledger" title="Cambiar Contabilidad">${isOffBalanceMode ? 'B' : 'A'}</button>`;
        
            if(leftEl && !(pageId === PAGE_IDS.INVERSIONES && !select('investment-detail-view')?.classList.contains('hidden'))) {
                leftEl.innerHTML = ledgerButtonHTML;
            } else if (leftEl) {
                leftEl.innerHTML = '';
            }

            const standardActions = `
                <button data-action="global-search" class="icon-btn" title="BÃºsqueda Global (Cmd/Ctrl+K)" aria-label="BÃºsqueda Global"><span class="material-icons">search</span></button>
                <button data-action="help" class="icon-btn" title="Ayuda" aria-label="Ayuda"><span class="material-icons">help_outline</span></button> 
                <button data-action="exit" class="icon-btn" title="Salir" aria-label="Salir de la aplicaciÃ³n"><span class="material-icons">exit_to_app</span></button>`;
            
            const dashboardActions = `<button data-action="configure-dashboard" class="icon-btn" title="Personalizar Panel" aria-label="Personalizar Panel"><span class="material-icons">tune</span></button>${standardActions}`;
        
            // INICIO CAMBIO: Se elimina la lÃ³gica de la pÃ¡gina de informes de la navegaciÃ³n principal
            const pageRenderers = {
                [PAGE_IDS.MOVIMIENTOS]: { title: 'Movimientos', render: loadInitialMovements, actions: standardActions },
                [PAGE_IDS.PANEL]: { title: 'Panel de Control', render: updateDashboard, actions: dashboardActions },
                [PAGE_IDS.CUENTAS]: { title: 'Cuentas', render: renderCuentas, actions: standardActions },
                [PAGE_IDS.INVERSIONES]: { title: 'Portafolio', render: renderInversionesPage, actions: standardActions },
                [PAGE_IDS.PRESUPUESTOS]: { title: 'Presupuestos', render: renderBudgetTracking, actions: standardActions },
                [PAGE_IDS.CONFIGURACION]: { title: 'ConfiguraciÃ³n', render: loadConfig, actions: standardActions }
            };
            // FIN CAMBIO
            
            if (pageRenderers[pageId]) {
                 if (pageId === PAGE_IDS.INVERSIONES && !select('investment-detail-view')?.classList.contains('hidden')) { /* Title is handled by renderInvestmentAccountDetail */ } 
                 else if (titleEl) { titleEl.textContent = pageRenderers[pageId].title; }
                if (actionsEl) actionsEl.innerHTML = pageRenderers[pageId].actions;
                pageRenderers[pageId].render();
            }
            
            const mainScroller = selectOne('.app-layout__main'); if (mainScroller) mainScroller.scrollTop = 0;
            selectAll('.view').forEach(p => p.classList.remove('view--active'));
            select(pageId)?.classList.add('view--active');
            selectAll('.bottom-nav__item').forEach(b => b.classList.toggle('bottom-nav__item--active', b.dataset.page === pageId));
            
            fab?.classList.toggle('fab--visible', ![PAGE_IDS.CONFIGURACION].includes(pageId));
        };
        
        const setupTheme = () => { 
            const gridColor = 'rgba(255, 255, 255, 0.1)';
            const textColor = '#FFFFFF';
            Chart.defaults.color = textColor; 
            Chart.defaults.borderColor = gridColor;
        };
        
        // =================================================================================
        // 6. CORE LOGIC & CALCULATIONS (REFACTORIZADO PARA CONSULTAS EFICIENTES)
        // =================================================================================
        const getVisibleAccounts = () => (db.cuentas || []).filter(c => !!c.offBalance === isOffBalanceMode);
        const getLiquidAccounts = () => getVisibleAccounts().filter((c) => !['PROPIEDAD', 'PRÃ‰STAMO'].includes((c.tipo || '').trim().toUpperCase()));
        
        async function fetchAllMovementsForBalances() {
            if (!currentUser) return [];
            const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        const getSaldos = async () => {
            const visibleAccounts = getVisibleAccounts();
            const saldos = {};
            visibleAccounts.forEach(cuenta => {
                saldos[cuenta.id] = cuenta.saldo || 0;
            });
            return saldos;
        };
        
        // [OPTIMIZACIÃ“N] Esta funciÃ³n ahora construye y ejecuta consultas eficientes a Firestore.
        const getFilteredMovements = async (forComparison = false) => {
            if (!currentUser) return { current: [], previous: [], label: '' };

            const visibleAccountIds = getVisibleAccounts().map(c => c.id);
            if (visibleAccountIds.length === 0) {
                return { current: [], previous: [], label: '' };
            }

            const p = select('filter-periodo')?.value || 'mes-actual';
            const cId = select('filter-cuenta')?.value;
            const coId = select('filter-concepto')?.value;
            let sDate, eDate, prevSDate, prevEDate, now = new Date();

            switch (p) {
                case 'mes-actual':
                    sDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    eDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    prevSDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    prevEDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                    break;
                case 'aÃ±o-actual':
                    sDate = new Date(now.getFullYear(), 0, 1);
                    eDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                    prevSDate = new Date(now.getFullYear() - 1, 0, 1);
                    prevEDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999);
                    break;
                case 'custom':
                    sDate = select('filter-fecha-inicio')?.value ? parseDateStringAsUTC(select('filter-fecha-inicio').value) : null;
                    eDate = select('filter-fecha-fin')?.value ? parseDateStringAsUTC(select('filter-fecha-fin').value) : null;
                    if (eDate) eDate.setHours(23, 59, 59, 999);
                    prevSDate = null; prevEDate = null;
                    break;
                default: sDate = null; eDate = null; prevSDate = null; prevEDate = null; break;
            }
            
            const fetchMovements = async (startDate, endDate) => {
                if (!startDate || !endDate) return [];
                
                let baseQuery = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
                    .where('fecha', '>=', startDate.toISOString())
                    .where('fecha', '<=', endDate.toISOString());
                
                if (coId) baseQuery = baseQuery.where('conceptoId', '==', coId);
                
                // [CORRECCIÃ“N CLAVE] Usamos la funciÃ³n de chunking.
                let movements = await fetchMovementsInChunks(baseQuery, 'cuentaId', cId ? [cId] : visibleAccountIds);

                // El post-filtrado para traspasos sigue siendo necesario si se elige una cuenta especÃ­fica.
                if(cId) {
                    movements = movements.filter(m => {
                        return m.cuentaId === cId || m.cuentaOrigenId === cId || m.cuentaDestinoId === cId;
                    });
                }
                return movements;
            };

            const currentMovs = await fetchMovements(sDate, eDate);
            if (!forComparison) return currentMovs;

            const prevMovs = await fetchMovements(prevSDate, prevEDate);
            const comparisonLabel = p === 'mes-actual' ? 'vs mes ant.' : (p === 'aÃ±o-actual' ? 'vs aÃ±o ant.' : '');
            return { current: currentMovs, previous: prevMovs, label: comparisonLabel };
        };
        
        const calculateIRR = (cashflows) => {
            if (cashflows.length < 2) return 0;
            const sortedCashflows = [...cashflows].sort((a, b) => a.date.getTime() - b.date.getTime());
            const firstDate = sortedCashflows[0].date;
            const npv = (rate) => { let total = 0; for (const flow of sortedCashflows) { const years = (flow.date.getTime() - firstDate.getTime()) / (365.25 * 24 * 60 * 60 * 1000); total += flow.amount / Math.pow(1 + rate, years); } return total; };
            const derivative = (rate) => { let total = 0; for (const flow of sortedCashflows) { const years = (flow.date.getTime() - firstDate.getTime()) / (365.25 * 24 * 60 * 60 * 1000); if (years > 0) { total -= years * flow.amount / Math.pow(1 + rate, years + 1); } } return total; };
            let guess = 0.1; const maxIterations = 100; const tolerance = 1e-7;
            for (let i = 0; i < maxIterations; i++) {
                const npvValue = npv(guess); const derivativeValue = derivative(guess); if (Math.abs(derivativeValue) < tolerance) break; const newGuess = guess - npvValue / derivativeValue; if (Math.abs(newGuess - guess) <= tolerance) { return newGuess; } guess = newGuess; }
            return 0;
        };
        
        const calculatePortfolioPerformance = async (cuentaId = null) => {
            const investmentAccounts = getVisibleAccounts().filter(c => c.esInversion && (cuentaId ? c.id === cuentaId : true));
            if (investmentAccounts.length === 0) { return { valorActual: 0, capitalInvertido: 0, pnlAbsoluto: 0, pnlPorcentual: 0, irr: 0 }; }
            const saldos = await getSaldos(); let totalValor = 0; let totalCapitalInvertido = 0; let allIrrCashflows = [];
            investmentAccounts.forEach(cuenta => {
                const capitalBase = saldos[cuenta.id] || 0; const cashflows = (db.inversion_cashflows || []).filter(cf => cf.cuentaId === cuenta.id); const netCashflow = cashflows.reduce((sum, cf) => sum + cf.cantidad, 0); const capitalInvertido = capitalBase + netCashflow;
                const valoraciones = (db.inversiones_historial || []).filter(v => v.cuentaId === cuenta.id).sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime()); 
                const valorActual = valoraciones.length > 0 ? valoraciones[0].valor : capitalInvertido;
                totalValor += valorActual; totalCapitalInvertido += capitalInvertido;
                const irrCashflows = []; if (capitalBase !== 0) { irrCashflows.push({ amount: -capitalBase, date: new Date(cuenta.fechaCreacion) }); } cashflows.forEach(cf => { irrCashflows.push({ amount: -cf.cantidad, date: new Date(cf.fecha) }); }); if (valorActual !== 0) { irrCashflows.push({ amount: valorActual, date: new Date() }); }
                allIrrCashflows.push(...irrCashflows);
            });
            const pnlAbsoluto = totalValor - totalCapitalInvertido; const pnlPorcentual = totalCapitalInvertido !== 0 ? (pnlAbsoluto / totalCapitalInvertido) * 100 : 0;
            if (cuentaId) {
                const cuentaUnica = investmentAccounts[0]; const capitalBase = saldos[cuentaUnica.id] || 0; const cashflows = (db.inversion_cashflows || []).filter(cf => cf.cuentaId === cuentaUnica.id); const netCashflow = cashflows.reduce((sum, cf) => sum + cf.cantidad, 0); const capitalInvertido = capitalBase + netCashflow; const valoraciones = (db.inversiones_historial || []).filter(v => v.cuentaId === cuentaUnica.id).sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime()); 
                const valorActual = valoraciones.length > 0 ? valoraciones[0].valor : capitalInvertido; 
                const pnlAbsolutoUnico = valorActual - capitalInvertido; const pnlPorcentualUnico = capitalInvertido !== 0 ? (pnlAbsolutoUnico / capitalInvertido) * 100 : 0;
                const singleIrrCashflows = []; if (capitalBase !== 0) singleIrrCashflows.push({ amount: -capitalBase, date: new Date(cuentaUnica.fechaCreacion) }); cashflows.forEach(cf => singleIrrCashflows.push({ amount: -cf.cantidad, date: new Date(cf.fecha) })); if (valorActual !== 0) singleIrrCashflows.push({ amount: valorActual, date: new Date() }); const irrUnico = calculateIRR(singleIrrCashflows);
                return { valorActual: valorActual, capitalInvertido: capitalInvertido, pnlAbsoluto: pnlAbsolutoUnico, pnlPorcentual: pnlPorcentualUnico, irr: irrUnico };
            }
            const irrGlobal = calculateIRR(allIrrCashflows); return { valorActual: totalValor, capitalInvertido: totalCapitalInvertido, pnlAbsoluto, pnlPorcentual, irr: irrGlobal };
        };

        const processMovementsForRunningBalance = async (movements) => {
            if (!runningBalancesCache) {
                const saldosVisibles = await getSaldos();
                runningBalancesCache = { ...saldosVisibles };
            }

            for (const mov of movements) {
                if (mov.tipo === 'traspaso') {
                    if (!runningBalancesCache.hasOwnProperty(mov.cuentaOrigenId)) {
                        runningBalancesCache[mov.cuentaOrigenId] = 0;
                    }
                    if (!runningBalancesCache.hasOwnProperty(mov.cuentaDestinoId)) {
                        runningBalancesCache[mov.cuentaDestinoId] = 0;
                    }

                    mov.runningBalanceOrigen = runningBalancesCache[mov.cuentaOrigenId];
                    mov.runningBalanceDestino = runningBalancesCache[mov.cuentaDestinoId];

                    runningBalancesCache[mov.cuentaOrigenId] += mov.cantidad;
                    runningBalancesCache[mov.cuentaDestinoId] -= mov.cantidad;

                } else { // Para 'movimiento'
                    if (!runningBalancesCache.hasOwnProperty(mov.cuentaId)) {
                        runningBalancesCache[mov.cuentaId] = 0;
                    }

                    mov.runningBalance = runningBalancesCache[mov.cuentaId];
                    runningBalancesCache[mov.cuentaId] -= mov.cantidad;
                }
            }
        };
        
        // =================================================================================
        // 7. RENDERING ENGINE & BUDGET FUNCTIONS
        // =================================================================================
        const populateAllDropdowns = () => {
            const visibleAccounts = getVisibleAccounts();
            const populate = (id, data, nameKey, valKey='id', all=false, none=false) => {
                const el = select(id); if (!el) return; const currentVal = el.value;
                let opts = all ? '<option value="">Todos</option>' : ''; if (none) opts += '<option value="">Ninguno</option>';
                [...data].sort((a,b) => (a[nameKey]||"").localeCompare(b[nameKey]||"")).forEach(i => opts += `<option value="${i[valKey]}">${i[nameKey]}</option>`);
                el.innerHTML = opts; el.value = Array.from(el.options).some(o=>o.value===currentVal) ? currentVal : (el.options[0]?.value || "");
            };
            populate('movimiento-cuenta', visibleAccounts, 'nombre', 'id', false, true);
            
            // [MEJORA] LÃ³gica para popular dropdowns de traspaso
            populateTraspasoDropdowns();
            
            populate('filter-cuenta', visibleAccounts, 'nombre', 'id', true); 
            populate('movimiento-concepto', db.conceptos, 'nombre', 'id', false, true); 
            populate('filter-concepto', db.conceptos, 'nombre', 'id', true);
            const budgetYearSelect = select('budget-year-selector'); if(budgetYearSelect) { const currentVal = budgetYearSelect.value; const currentYear = new Date().getFullYear(); let years = new Set([currentYear]); (db.presupuestos || []).forEach((p) => years.add(p.ano)); budgetYearSelect.innerHTML = [...years].sort((a,b) => b-a).map(y => `<option value="${y}">${y}</option>`).join(''); if(currentVal && [...years].some(y => y == parseInt(currentVal))) budgetYearSelect.value = currentVal; else budgetYearSelect.value = String(currentYear); }
            
            // INICIO CAMBIO: Asegurarse de que los selectores de informes (ahora en el panel) se populan
            populate('informe-cuenta', visibleAccounts, 'nombre', 'id', true);
            populate('informe-concepto', db.conceptos, 'nombre', 'id', true);
            // FIN CAMBIO
        };

        // [MEJORA] Nueva funciÃ³n para gestionar los dropdowns de traspasos de forma inteligente
        const populateTraspasoDropdowns = () => {
            const showAll = select('traspaso-show-all-accounts-toggle')?.checked;
            const accountsToList = showAll ? (db.cuentas || []) : getVisibleAccounts();
            
            const populate = (id, data, none = false) => {
                const el = select(id); if (!el) return;
                const currentVal = el.value;
                let opts = none ? '<option value="">Ninguno</option>' : '';
                data.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(i => opts += `<option value="${i.id}">${i.nombre}</option>`);
                el.innerHTML = opts;
                if (Array.from(el.options).some(o => o.value === currentVal)) {
                    el.value = currentVal;
                } else {
                    el.value = el.options[0]?.value || "";
                }
            };

            populate('movimiento-cuenta-origen', accountsToList, true);
            populate('movimiento-cuenta-destino', accountsToList, true);
        };
        
        const handleCreateBudgets = async (btn) => { hapticFeedback('medium'); const year = parseInt((select('budget-year-selector')).value); if (!year) { showToast('Selecciona un aÃ±o.', 'warning'); return; } if (btn) setButtonLoading(btn, true, 'Creando...'); const existingBudgets = new Set((db.presupuestos || []).filter((p) => p.ano === year).map((p) => p.conceptoId)); const newBudgets = []; db.conceptos.forEach((concepto) => { if (!existingBudgets.has(concepto.id)) { newBudgets.push({ id: generateId(), ano: year, conceptoId: concepto.id, cantidad: 0 }); } }); if (newBudgets.length > 0) { const batch = fbDb.batch(); newBudgets.forEach(budget => { const ref = fbDb.collection('users').doc(currentUser.uid).collection('presupuestos').doc(budget.id); batch.set(ref, budget); }); await batch.commit(); if (btn) setButtonLoading(btn, false); hapticFeedback('success'); showToast(`Presupuestos para ${year} creados.`); renderBudgetTracking(); } else { if (btn) setButtonLoading(btn, false); showToast(`Todos los presupuestos para ${year} ya existÃ­an.`, 'info'); renderBudgetTracking(); } };
        
        const handleUpdateBudgets = () => { hapticFeedback('light'); const year = parseInt((select('budget-year-selector')).value); if(!year) { showToast('Selecciona un aÃ±o.', 'warning'); return; } const budgetsToUpdate = (db.presupuestos || []).filter((p) => p.ano === year); let formHtml = `<form id="update-budgets-form" novalidate><p class="form-label" style="margin-bottom: var(--sp-3)">Introduce el lÃ­mite anual. Usa <b>valores positivos para metas de ingreso</b> y <b>valores negativos para lÃ­mites de gasto</b>.</p>`; const conceptsWithBudget = new Set(budgetsToUpdate.map((b) => b.conceptoId)); db.conceptos.filter((c) => conceptsWithBudget.has(c.id)).sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach((c) => { const budget = budgetsToUpdate.find((b) => b.conceptoId === c.id); const currentAmount = budget ? (budget.cantidad / 100).toFixed(2) : '0.00'; formHtml += `<div class="form-group"><label for="budget-input-${c.id}" class="form-label" style="font-weight: 600;">${c.nombre}</label><input type="text" id="budget-input-${c.id}" data-concept-id="${c.id}" class="form-input" inputmode="decimal" value="${currentAmount.replace('.', ',')}"></div>`; }); const missingConcepts = db.conceptos.filter((c) => !conceptsWithBudget.has(c.id)); if(missingConcepts.length > 0) { formHtml += `<hr style="margin: var(--sp-4) 0; border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-bottom: var(--sp-2);">AÃ±adir nuevos conceptos al presupuesto</h4>`; missingConcepts.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach((c) => { formHtml += `<div class="form-group"><label for="budget-input-${c.id}" class="form-label" style="font-weight: 600;">${c.nombre}</label><input type="text" id="budget-input-${c.id}" data-concept-id="${c.id}" class="form-input" inputmode="decimal" placeholder="0,00"></div>`; }); } formHtml += `<div class="modal__actions"><button type="submit" class="btn btn--primary btn--full">Guardar Cambios</button></div></form>`; showGenericModal(`Gestionar Presupuestos de ${year}`, formHtml); setTimeout(() => { const modalForm = select('update-budgets-form'); if (modalForm) { modalForm.addEventListener('submit', async (e) => { e.preventDefault(); const btn = modalForm.querySelector('button[type="submit"]'); setButtonLoading(btn, true, 'Guardando...'); const inputs = modalForm.querySelectorAll('input[data-concept-id]'); const batch = fbDb.batch(); inputs.forEach((input) => { const conceptoId = (input).dataset.conceptId; const amountValue = parseCurrencyString((input).value); if (isNaN(amountValue)) return; const newAmountInCents = Math.round(amountValue * 100); let budget = (db.presupuestos || []).find((b) => b.ano === year && b.conceptoId === conceptoId); if (budget) { const ref = fbDb.collection('users').doc(currentUser.uid).collection('presupuestos').doc(budget.id); batch.update(ref, { cantidad: newAmountInCents }); } else { const newId = generateId(); const ref = fbDb.collection('users').doc(currentUser.uid).collection('presupuestos').doc(newId); batch.set(ref, { id: newId, ano: year, conceptoId: conceptoId, cantidad: newAmountInCents }); } }); await batch.commit(); setButtonLoading(btn, false); hideModal('generic-modal'); hapticFeedback('success'); showToast('Presupuestos actualizados.'); renderBudgetTracking(); }); } }, 0); };
        
        const renderBudgetTracking = async () => {
            const listContainer = select('budget-tracking-list'), placeholder = select('budget-init-placeholder'), yearSelector = select('budget-year-selector');
            if (!listContainer || !placeholder || !yearSelector) return;
            const year = parseInt((yearSelector).value, 10);
            if (!year) { listContainer.classList.add('hidden'); placeholder.classList.add('hidden'); return; }
            const yearBudgets = (db.presupuestos || []).filter((b) => b.ano === year);
            if (yearBudgets.length === 0) { listContainer.innerHTML = ''; listContainer.classList.add('hidden'); placeholder.classList.remove('hidden'); (select('budget-placeholder-title')).textContent = `Crear Presupuestos ${year}`; (select('budget-placeholder-text')).textContent = `AÃºn no se han creado los presupuestos para el aÃ±o ${year}.`; return; }
            listContainer.classList.remove('hidden'); placeholder.classList.add('hidden');
            
            const visibleAccountIds = getVisibleAccounts().map(c => c.id);
            if (visibleAccountIds.length === 0) {
                listContainer.innerHTML = `<div class="card"><div class="card__content" style="padding: 0 var(--sp-4) var(--sp-2) var(--sp-4);"><p class='form-label' style='text-align: center; padding: var(--sp-4) 0;'>No hay cuentas en esta vista para calcular el presupuesto.</p></div></div>`;
                return;
            }

            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year, 11, 31, 23, 59, 59, 999);
            let baseQuery = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
				.where('fecha', '>=', startDate.toISOString())
				.where('fecha', '<=', endDate.toISOString())
				.where('tipo', '==', 'movimiento');
            
            // [CORRECCIÃ“N CLAVE] Usamos la funciÃ³n de chunking.
            const visibleMovements = await fetchMovementsInChunks(baseQuery, 'cuentaId', visibleAccountIds);
        
            let html = '';
            // El resto de la funciÃ³n permanece igual...
            yearBudgets.sort((a,b) => (db.conceptos.find((c) => c.id === a.conceptoId)?.nombre || '').localeCompare(db.conceptos.find((c) => c.id === b.conceptoId)?.nombre || '')).forEach((budget) => {
                const concepto = db.conceptos.find((c) => c.id === budget.conceptoId); if (!concepto || budget.cantidad === 0) return;
                const isIncomeBudget = budget.cantidad > 0;
                const actualAmount = visibleMovements.filter((m) => m.conceptoId === budget.conceptoId).reduce((sum, m) => sum + m.cantidad, 0);
                const budgetLimit = Math.abs(budget.cantidad), actualValue = isIncomeBudget ? actualAmount : Math.abs(actualAmount);
                const difference = isIncomeBudget ? (actualAmount - budgetLimit) : (budgetLimit - actualValue); const differenceClass = difference >= 0 ? 'text-positive' : 'text-negative';
                const progressValue = actualValue, progressMax = budgetLimit; let progressClass = ''; const percentage = progressMax > 0 ? (progressValue / progressMax) * 100 : 0;
                if (percentage > 100) progressClass = 'budget-item__progress--danger'; else if (percentage >= 85) progressClass = 'budget-item__progress--warning';
                
                html += `
<div class="budget-track-item">
    <div class="budget-track-item__main">
        <div class="budget-track-item__concept-name">${concepto.nombre}</div>
        <progress class="budget-item__progress ${progressClass}" value="${progressValue}" max="${progressMax}"></progress>
    </div>
    <div class="budget-track-item__figures">
        <div class="budget-track-item__amount">
            <strong>${formatCurrency(actualValue)}</strong> / ${formatCurrency(budgetLimit)}
        </div>
        <div class="budget-track-item__difference ${differenceClass}">
            ${difference >= 0 ? 'Sobrante' : 'Excedido'}: ${formatCurrency(Math.abs(difference))}
        </div>
    </div>
</div>`;
            });
            listContainer.innerHTML = `<div class="card"><div class="card__content" style="padding: 0 var(--sp-4) var(--sp-2) var(--sp-4);">${html || `<p class='form-label' style='text-align: center; padding: var(--sp-4) 0;'>No hay presupuestos para mostrar en esta vista.</p>`}</div></div>`;
        };
        
        // =================================================================================
        // 7.5. INVESTMENT & REPORT PAGE RENDERING
        // =================================================================================
        const renderInversionesPage = async () => {
            (select('investment-list-view'))?.classList.remove('hidden');
            (select('investment-detail-view'))?.classList.add('hidden');
            const topBarTitle = select('top-bar-title');
            if (topBarTitle) topBarTitle.textContent = 'Portafolio';
            const topBarLeftButton = select('top-bar-left-button');
            if (topBarLeftButton) {
                 topBarLeftButton.innerHTML = `<button id="ledger-toggle-btn" class="btn btn--secondary" data-action="toggle-ledger" title="Cambiar Contabilidad">${isOffBalanceMode ? 'B' : 'A'}</button>`;
            }
        
            const investmentAccounts = getVisibleAccounts().filter((c) => c.esInversion);
            const kpisContainer = select('investment-global-kpis');
            const assetsListContainer = select('investment-assets-list');
            const emptyState = select('empty-investments');
        
            if (!kpisContainer || !assetsListContainer || !emptyState) return;
            
            if (investmentAccounts.length === 0) {
                kpisContainer.innerHTML = '';
                assetsListContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
        
            emptyState.classList.add('hidden');
            
            const globalPerformance = await calculatePortfolioPerformance(null);
            const pnlClassGlobal = globalPerformance.pnlAbsoluto >= 0 ? 'text-positive' : 'text-negative';
            const irrClassGlobal = globalPerformance.irr >= 0 ? 'text-positive' : 'text-negative';
            
            const assetCardsPromises = investmentAccounts.map(async (cuenta) => {
                const performance = await calculatePortfolioPerformance(cuenta.id);
                const pnlClass = performance.pnlAbsoluto >= 0 ? 'text-positive' : 'text-negative';
                const irrClass = performance.irr >= 0 ? 'text-positive' : 'text-negative';
                return `
                    <div class="investment-asset-card" data-action="view-investment-detail" data-id="${cuenta.id}">
                        <div class="investment-asset-card__header">
                            <div>
                                <h3 class="investment-asset-card__name">${cuenta.nombre}</h3>
                                <small style="color: var(--c-on-surface-secondary);">${cuenta.tipo}</small>
                            </div>
                            <div>
                                <div class="investment-asset-card__value">${formatCurrency(performance.valorActual)}</div>
                                <div class="investment-asset-card__pnl ${pnlClass}">${performance.pnlAbsoluto >= 0 ? '+' : ''}${formatCurrency(performance.pnlAbsoluto)} (${performance.pnlPorcentual.toFixed(2)}%)</div>
                                <div class="investment-asset-card__pnl ${irrClass}" style="font-weight: 600;">TIR: ${(performance.irr * 100).toFixed(2)}%</div>
                            </div>
                        </div>
                    </div>`;
            });
            assetsListContainer.innerHTML = (await Promise.all(assetCardsPromises)).join('');

        
            kpisContainer.innerHTML = `
                <div class="kpi-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: var(--sp-3);">
                    <div class="kpi-item"><h4 class="kpi-item__label">Valor Total</h4><strong class="kpi-item__value">${formatCurrency(globalPerformance.valorActual)}</strong></div>
                    <div class="kpi-item"><h4 class="kpi-item__label">Capital Total</h4><strong class="kpi-item__value">${formatCurrency(globalPerformance.capitalInvertido)}</strong></div>
                </div>
                <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="kpi-item"><h4 class="kpi-item__label">P&L (â‚¬)</h4><strong class="kpi-item__value ${pnlClassGlobal}">${globalPerformance.pnlAbsoluto >= 0 ? '+' : ''}${formatCurrency(globalPerformance.pnlAbsoluto)}</strong></div>
                    <div class="kpi-item"><h4 class="kpi-item__label">P&L (%)</h4><strong class="kpi-item__value ${pnlClassGlobal}">${globalPerformance.pnlPorcentual.toFixed(2)}%</strong></div>
                    <div class="kpi-item"><h4 class="kpi-item__label">TIR Anualizada</h4><strong class="kpi-item__value ${irrClassGlobal}">${(globalPerformance.irr * 100).toFixed(2)}%</strong></div>
                </div>`;
        };
        
        const renderInvestmentAccountDetail = async (cuentaId) => {
            const cuenta = getVisibleAccounts().find((c) => c.id === cuentaId);
            if (!cuenta) { renderInversionesPage(); return; }
            
            (select('investment-list-view'))?.classList.add('hidden');
            const detailContainer = select('investment-detail-view');
            if(!detailContainer) return;
            detailContainer.classList.remove('hidden');
        
            const topBarTitle = select('top-bar-title');
            if (topBarTitle) topBarTitle.textContent = cuenta.nombre;
            const topBarLeftButton = select('top-bar-left-button');
            if (topBarLeftButton) {
                 topBarLeftButton.innerHTML = `<button class="icon-btn" data-action="back-to-investment-list" aria-label="Volver a la lista de portafolio"><span class="material-icons">arrow_back_ios</span></button>`;
            }
            
            if (detailInvestmentChart) detailInvestmentChart.destroy();
            
            const performance = await calculatePortfolioPerformance(cuentaId);
            const pnlClass = performance.pnlAbsoluto >= 0 ? 'text-positive' : 'text-negative';
            const irrClass = performance.irr >= 0 ? 'text-positive' : 'text-negative';
            
            const cashflows = (db.inversion_cashflows || []).filter((cf) => cf.cuentaId === cuentaId).sort((a, b) => new Date(a.fecha).getTime() - new Date(b.fecha).getTime());
            const valoraciones = (db.inversiones_historial || []).filter((v) => v.cuentaId === cuentaId).sort((a, b) => new Date(a.fecha).getTime() - new Date(b.fecha).getTime());
        
            detailContainer.innerHTML = `
                <div class="kpi-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="kpi-item"><h4 class="kpi-item__label">Valor Actual</h4><strong class="kpi-item__value">${formatCurrency(performance.valorActual)}</strong></div>
                    <div class="kpi-item"><h4 class="kpi-item__label">Capital Invertido</h4><strong class="kpi-item__value">${formatCurrency(performance.capitalInvertido)}</strong></div>
                    <div class="kpi-item"><h4 class="kpi-item__label">P&L Absoluto</h4><strong class="kpi-item__value ${pnlClass}">${performance.pnlAbsoluto >= 0 ? '+' : ''}${formatCurrency(performance.pnlAbsoluto)}</strong></div>
                    <div class="kpi-item"><h4 class="kpi-item__label">TIR Anualizada</h4><strong class="kpi-item__value ${irrClass}">${(performance.irr * 100).toFixed(2)}%</strong></div>
                </div>
                <div class="card">
                    <h3 class="card__title"><span class="material-icons">show_chart</span>EvoluciÃ³n</h3>
                    <div class="card__content">
                        <div class="chart-container" style="height: 200px; margin-bottom: 0;"><canvas id="detail-investment-chart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card__title"><span class="material-icons">history</span>Historial</h3>
                    <div class="card__content" id="investment-detail-timeline" style="padding-top: 0;"></div>
                </div>`;
        
            setTimeout(async () => {
                const ctx = (select('detail-investment-chart'))?.getContext('2d');
                if (ctx) {
                    const saldos = await getSaldos();
                    const capitalBase = saldos[cuentaId] || 0;
                    let runningCapital = capitalBase;
                    const capitalData = [{ x: new Date(cuenta.fechaCreacion || Date.now()).getTime(), y: capitalBase / 100 }];
                    cashflows.forEach((cf) => { runningCapital += cf.cantidad; capitalData.push({ x: new Date(cf.fecha).getTime(), y: runningCapital / 100 }); });
                    const valoracionData = valoraciones.map((v) => ({ x: new Date(v.fecha).getTime(), y: v.valor / 100 }));
                    detailInvestmentChart = new Chart(ctx, { type: 'line', data: { datasets: [ { label: 'Valor Activo', data: valoracionData, borderColor: 'var(--c-primary)', backgroundColor: 'rgba(0, 122, 255, 0.2)', tension: 0.1, fill: true }, { label: 'Capital Invertido', data: capitalData, borderColor: 'var(--c-info)', stepped: true, fill: false } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, datalabels: { display: false } }, scales: { x: { type: 'time', time: { unit: 'month' } }, y: { ticks: { callback: (value) => `â‚¬${value.toLocaleString('es-ES')}` } } } } });
                }
            }, 50);
            
            const timelineContainer = select('investment-detail-timeline');
            const timelineItems = [ ...valoraciones.map((v) => ({...v, type: 'valoracion'})), ...cashflows.map((c) => ({...c, type: c.cantidad > 0 ? 'aportacion' : 'reembolso'})) ].sort((a,b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime());
            if (timelineContainer) {
                if (timelineItems.length === 0) {
                    timelineContainer.innerHTML = `<p style="text-align:center; padding: var(--sp-3) 0; color: var(--c-on-surface-secondary);">No hay historial para este activo.</p>`;
                } else {
                    timelineContainer.innerHTML = timelineItems.map((item) => {
                        let icon, text, amount, amountClass = '';
                        const date = new Date(item.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                        switch (item.type) {
                            case 'valoracion': icon = 'check_circle_outline'; text = 'ValoraciÃ³n'; amount = formatCurrency((item).valor); amountClass = 'text-info'; break;
                            case 'aportacion': icon = 'add_circle_outline'; text = `AportaciÃ³n ${(item).notas ? `(${(item).notas})` : ''}`; amount = `+${formatCurrency((item).cantidad)}`; amountClass = 'text-positive'; break;
                            case 'reembolso': icon = 'remove_circle_outline'; text = `Reembolso ${(item).notas ? `(${(item).notas})` : ''}`; amount = `${formatCurrency((item).cantidad)}`; amountClass = 'text-negative'; break;
                        }
                        return `
                            <div class="investment-timeline-item" data-id="${item.id}" data-cuenta-id="${cuentaId}">
                                <div class="investment-timeline-item__icon ${amountClass}"><span class="material-icons">${icon}</span></div>
                                <div class="investment-timeline-item__details">
                                    <div class="investment-timeline-item__description">${text}</div>
                                    <div class="investment-timeline-item__date">${date}</div>
                                </div>
                                <div class="investment-timeline-item__amount ${amountClass}">${amount}</div>
                            </div>`;
                    }).join('');
                }
            }
        };

        // INICIO CAMBIO: La funciÃ³n de renderizar informes ahora es llamada por el botÃ³n "Generar Informe" dentro del Panel
        const renderInformesPage = async () => {
            const resultsContainer = select('informe-results-container');
            const emptyState = select('empty-informes');
            const kpiContainer = select('informe-kpi-container');
            const chartCtx = select('informes-chart')?.getContext('2d');
        
            if (!resultsContainer || !emptyState || !chartCtx || !kpiContainer) return;
            if (informesChart) { informesChart.destroy(); }
            
            // Los selectores de fecha ahora estÃ¡n dentro del panel, pero sus IDs son los mismos
            const fechaInicioVal = select('informe-fecha-inicio').value;
            const fechaFinVal = select('informe-fecha-fin').value;
            
            // Los filtros de cuenta y concepto se leen del acordeÃ³n principal del panel
            const cuentaId = select('filter-cuenta').value;
            const conceptoId = select('filter-concepto').value;
        
            if (!fechaInicioVal || !fechaFinVal) {
                resultsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
        
            const fechaInicio = parseDateStringAsUTC(fechaInicioVal);
            const fechaFin = parseDateStringAsUTC(fechaFinVal);
            
            const visibleAccountIds = getVisibleAccounts().map(c => c.id);
            if (visibleAccountIds.length === 0) {
                showToast('No hay cuentas seleccionadas en esta contabilidad.', 'info');
                resultsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                (emptyState.querySelector('p')).textContent = "No hay cuentas visibles para generar el informe.";
                return;
            }
        
            let baseQuery = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
                .where('fecha', '>=', fechaInicio.toISOString())
                .where('fecha', '<=', fechaFin.toISOString())
                .where('tipo', '==', 'movimiento');

            if (conceptoId) {
                baseQuery = baseQuery.where('conceptoId', '==', conceptoId);
            }
            
            const accountIdsToQuery = cuentaId ? [cuentaId] : visibleAccountIds;
            const movimientos = await fetchMovementsInChunks(baseQuery, 'cuentaId', accountIdsToQuery);
            
            if (movimientos.length === 0) {
                showToast('No se encontraron movimientos para los filtros seleccionados.', 'info');
                resultsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                (emptyState.querySelector('p')).textContent = "No hay datos para este informe. Prueba a cambiar los filtros.";
                return;
            }
            
        
            resultsContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            const datosAgrupados = movimientos.reduce((acc, mov) => {
                const fecha = new Date(mov.fecha);
                const clave = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                if (!acc[clave]) {
                    acc[clave] = { ingresos: 0, gastos: 0 };
                }

                if (mov.tipo === 'movimiento') {
                    if (mov.cantidad > 0) {
                        acc[clave].ingresos += mov.cantidad;
                    } else {
                        acc[clave].gastos += mov.cantidad;
                    }
                } else if (mov.tipo === 'traspaso') {
                    if (cuentaId) { 
                        if (mov.cuentaDestinoId === cuentaId) {
                            acc[clave].ingresos += mov.cantidad;
                        }
                        if (mov.cuentaOrigenId === cuentaId) {
                            acc[clave].gastos -= mov.cantidad;
                        }
                    }
                }
                return acc;
            }, {});
        
            const etiquetas = Object.keys(datosAgrupados).sort();
            const datosIngresos = etiquetas.map(clave => datosAgrupados[clave].ingresos / 100);
            const datosGastos = etiquetas.map(clave => Math.abs(datosAgrupados[clave].gastos / 100));
        
            const etiquetasFormateadas = etiquetas.map(clave => {
                const [year, month] = clave.split('-');
                return new Date(parseInt(year), parseInt(month) - 1).toLocaleDateString('es-ES', { month: 'short', year: '2-digit' });
            });
            
            const totalIngresos = datosIngresos.reduce((sum, val) => sum + (val * 100), 0);
            const totalGastos = datosGastos.reduce((sum, val) => sum + (val * 100), 0);
            const neto = totalIngresos - totalGastos;
            
            kpiContainer.innerHTML = `
                <div class="kpi-item"><h4 class="kpi-item__label">Total Ingresos</h4><strong class="kpi-item__value text-positive">${formatCurrency(totalIngresos)}</strong></div>
                <div class="kpi-item"><h4 class="kpi-item__label">Total Gastos</h4><strong class="kpi-item__value text-negative">${formatCurrency(-totalGastos)}</strong></div>
                <div class="kpi-item"><h4 class="kpi-item__label">Resultado Neto</h4><strong class="kpi-item__value ${neto >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(neto)}</strong></div>
            `;
        
            informesChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: etiquetasFormateadas,
                    datasets: [
                        { label: 'Ingresos', data: datosIngresos, borderColor: getComputedStyle(document.body).getPropertyValue('--c-success'), backgroundColor: 'rgba(48, 209, 88, 0.2)', fill: true, tension: 0.3, pointBackgroundColor: getComputedStyle(document.body).getPropertyValue('--c-success') },
                        { label: 'Gastos', data: datosGastos, borderColor: getComputedStyle(document.body).getPropertyValue('--c-danger'), backgroundColor: 'rgba(255, 59, 48, 0.2)', fill: true, tension: 0.3, pointBackgroundColor: getComputedStyle(document.body).getPropertyValue('--c-danger') }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: (value) => formatCurrency(value * 100).replace(/\s/g, '') } } },
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${formatCurrency(c.parsed.y * 100)}` } }, datalabels: { display: false } }
                }
            });
        };
        // FIN CAMBIO
        
        const renderVirtualListItem = (item) => {
            if (item.type === 'date-header') {
                const dateObj = new Date(item.date + 'T12:00:00Z');
                const day = dateObj.toLocaleDateString('es-ES', { weekday: 'short' }).toUpperCase().replace('.', '');
                const dateStr = dateObj.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });

                return `
                    <div class="movimiento-date-header">
                        <span>${day} ${dateStr}</span>
                        <span>${formatCurrency(item.total)}</span>
                    </div>
                `;
            }

            const m = item.movement;
            let highlightClass = '';
            if (m.id === newMovementIdToHighlight) {
                highlightClass = 'highlight-animation';
                newMovementIdToHighlight = null;
            }

            const formattedDate = new Date(m.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
            let indicatorClass = '';
            
            if (m.tipo === 'traspaso') indicatorClass = 'transaction-card__indicator--transfer';
            else if (m.cantidad >= 0) indicatorClass = 'transaction-card__indicator--income';
            else indicatorClass = 'transaction-card__indicator--expense';

            if (m.tipo === 'traspaso') {
                const origen = db.cuentas.find(c => c.id === m.cuentaOrigenId);
                const destino = db.cuentas.find(c => c.id === m.cuentaDestinoId);
                return `
                    <div class="transaction-card ${highlightClass}" data-action="edit-movement" data-id="${m.id}">
                        <div class="transaction-card__indicator ${indicatorClass}"></div>
                        <div class="transaction-card__content">
                            <div class="transaction-card__details">
                                <div class="transaction-card__concept">${escapeHTML(m.descripcion) || 'Traspaso'}</div>
                                <div class="transaction-card__transfer-details">
                                    <div class="transaction-card__transfer-row">
                                        <span><span class="material-icons">arrow_upward</span> ${origen?.nombre || '?'}</span>
                                        <span class="transaction-card__balance">${formatCurrency(m.runningBalanceOrigen)}</span>
                                    </div>
                                    <div class="transaction-card__transfer-row">
                                        <span><span class="material-icons">arrow_downward</span> ${destino?.nombre || '?'}</span>
                                        <span class="transaction-card__balance">${formatCurrency(m.runningBalanceDestino)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="transaction-card__figures">
                                <div class="transaction-card__amount text-info">${formatCurrency(m.cantidad)}</div>
                            </div>
                        </div>
                    </div>`;
            } else {
                const cuenta = db.cuentas.find(c => c.id === m.cuentaId);
                const concept = db.conceptos.find(c => c.id === m.conceptoId);
                const amountClass = m.cantidad >= 0 ? 'text-positive' : 'text-negative';
                return `
                    <div class="transaction-card ${highlightClass}" data-action="edit-movement" data-id="${m.id}">
                        <div class="transaction-card__indicator ${indicatorClass}"></div>
                        <div class="transaction-card__content">
                            <div class="transaction-card__details">
                                <div class="transaction-card__row-1">${toSentenceCase(concept?.nombre || 'S/C')}</div>
                                <div class="transaction-card__row-2">${escapeHTML(m.descripcion)}</div>
                            </div>
                            <div class="transaction-card__figures">
                                <div class="transaction-card__amount ${amountClass}">${formatCurrency(m.cantidad)}</div>
                                <div class="transaction-card__balance">${formatCurrency(m.runningBalance)}</div>
                                <div class="transaction-card__account-name" style="font-size: 0.7rem; color: var(--c-on-surface-secondary);">${escapeHTML(cuenta?.nombre || 'S/C')}</div>
                            </div>
                        </div>
                    </div>`;
            }
        };
        
        const renderVisibleItems = () => {
            if (!vList.scrollerEl || !vList.contentEl) return; 
            const scrollTop = vList.scrollerEl.scrollTop;
            const containerHeight = vList.scrollerEl.clientHeight;
            let startIndex = -1, endIndex = -1;
            
            for (let i = 0; i < vList.itemMap.length; i++) {
                const item = vList.itemMap[i];
                if (startIndex === -1 && item.offset + item.height > scrollTop) {
                    startIndex = Math.max(0, i - vList.renderBuffer);
                }
                if (endIndex === -1 && item.offset + item.height > scrollTop + containerHeight) {
                    endIndex = Math.min(vList.itemMap.length - 1, i + vList.renderBuffer);
                    break;
                }
            }
            if (startIndex === -1 && vList.items.length > 0) startIndex = 0;
            if (endIndex === -1) endIndex = vList.itemMap.length - 1;
            
            if (startIndex === vList.lastRenderedRange.start && endIndex === vList.lastRenderedRange.end) return;
            
            let visibleHtml = ''; 
            for (let i = startIndex; i <= endIndex; i++) {
                if (vList.items[i]) visibleHtml += renderVirtualListItem(vList.items[i]);
            }
            vList.contentEl.innerHTML = visibleHtml; 
            const offsetY = vList.itemMap[startIndex]?.offset || 0; 
            vList.contentEl.style.transform = `translateY(${offsetY}px)`; 
            vList.lastRenderedRange = { start: startIndex, end: endIndex };
        };
        
        const loadInitialMovements = async () => {
            const emptyEl = select('empty-movimientos'), listContainer = select('movimientos-list-container');
            if (!vList.scrollerEl) {
                vList.scrollerEl = selectOne('.app-layout__main');
                vList.sizerEl = select('virtual-list-sizer');
                vList.contentEl = select('virtual-list-content');
            }
            if (!listContainer || !emptyEl || !vList.sizerEl || !vList.contentEl) return;
            
            listContainer.classList.remove('hidden');
            emptyEl.classList.add('hidden');
            
            lastVisibleMovementDoc = null;
            allMovementsLoaded = false;
            isLoadingMoreMovements = false;
            runningBalancesCache = null;
			db.movimientos = []; // Clear local movements cache
            vList.items = [];
            vList.itemMap = [];
            vList.sizerEl.style.height = '0px';
            vList.contentEl.innerHTML = '';

            await loadMoreMovements(true); // Perform the initial load
        };

        const filterMovementsByLedger = (movements) => {
            const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
            if (visibleAccountIds.size === 0) return [];
            
            return movements.filter(m => {
                if (m.tipo === 'traspaso') {
                    return visibleAccountIds.has(m.cuentaOrigenId) || visibleAccountIds.has(m.cuentaDestinoId);
                } else {
                    return visibleAccountIds.has(m.cuentaId);
                }
            });
        };

        const chunkArray = (array, size) => {
            const chunks = [];
            for (let i = 0; i < array.length; i += size) {
                chunks.push(array.slice(i, i + size));
            }
            return chunks;
        };
		async function fetchMovementsPage(startAfterDoc = null) {
            if (!currentUser) return [];
            try {
                let query = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
                    .orderBy('fecha', 'desc');

                if (startAfterDoc) {
                    query = query.startAfter(startAfterDoc);
                }

                query = query.limit(MOVEMENTS_PAGE_SIZE);
                const snapshot = await query.get();

                if (snapshot.empty) {
                    allMovementsLoaded = true;
                    return [];
                }

                lastVisibleMovementDoc = snapshot.docs[snapshot.docs.length - 1];

                if (snapshot.docs.length < MOVEMENTS_PAGE_SIZE) {
                    allMovementsLoaded = true;
                }
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            } catch (error) {
                console.error("Error al obtener los movimientos:", error);
                showToast("Error al cargar los movimientos.", "danger");
                return [];
            }
        }
		const loadMoreMovements = async (isInitial = false) => {
            if (isLoadingMoreMovements || allMovementsLoaded) {
                return;
            }
        
            isLoadingMoreMovements = true;
            const loader = select('list-loader');
            if (loader) loader.classList.remove('hidden');
        
            try {
                let keepFetching = true;
        
                while (keepFetching && !allMovementsLoaded) {
                    const newMovs = await fetchMovementsPage(lastVisibleMovementDoc);
        
                    if (newMovs.length === 0) {
                        allMovementsLoaded = true;
                        keepFetching = false;
                        continue;
                    }
        
                    const filteredMovs = filterMovementsByLedger(newMovs);
        
                    if (filteredMovs.length > 0) {
                        await processMovementsForRunningBalance(filteredMovs);
                        db.movimientos = [...db.movimientos, ...filteredMovs];
                        updateVirtualList(filteredMovs, false);
                        keepFetching = false;
                    }
                }
        
            } catch (error) {
                console.error("Error al cargar mÃ¡s movimientos:", error);
                showToast("No se pudieron cargar mÃ¡s movimientos.", "danger");
            } finally {
                isLoadingMoreMovements = false;
                if (loader) loader.classList.add('hidden');
        
                if (isInitial && db.movimientos.length === 0) {
                     select('movimientos-list-container')?.classList.add('hidden');
                     select('empty-movimientos')?.classList.remove('hidden');
                }
            }
        };
        
        const updateVirtualList = (newItemsChunk, replace = false) => {
            if (replace) {
                db.movimientos = [];
            }
        
            const grouped = {};
            (db.movimientos || []).forEach(mov => {
                const dateKey = mov.fecha.slice(0, 10);
                if (!grouped[dateKey]) {
                    grouped[dateKey] = { movements: [], total: 0 };
                }
                grouped[dateKey].movements.push(mov);
                
                if (mov.tipo === 'traspaso') {
                    const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
                    const origenVisible = visibleAccountIds.has(mov.cuentaOrigenId);
                    const destinoVisible = visibleAccountIds.has(mov.cuentaDestinoId);
                    if (origenVisible && !destinoVisible) {
                        grouped[dateKey].total -= mov.cantidad;
                    } else if (!origenVisible && destinoVisible) {
                        grouped[dateKey].total += mov.cantidad;
                    }
                } else {
                    grouped[dateKey].total += mov.cantidad;
                }
            });

            vList.items = [];
            vList.itemMap = [];
            let currentHeight = 0;
            const sortedDates = Object.keys(grouped).sort((a, b) => b.localeCompare(a));

            for (const dateKey of sortedDates) {
                const group = grouped[dateKey];
        
                vList.items.push({ type: 'date-header', date: dateKey, total: group.total });
                vList.itemMap.push({ height: vList.heights.header, offset: currentHeight });
                currentHeight += vList.heights.header;
        
                for (const mov of group.movements) {
                    const itemHeight = mov.tipo === 'traspaso' ? vList.heights.transfer : vList.heights.transaction;
                    vList.items.push({ type: 'transaction', movement: mov });
                    vList.itemMap.push({ height: itemHeight, offset: currentHeight });
                    currentHeight += itemHeight;
                }
            }
            
            if (vList.sizerEl) {
                vList.sizerEl.style.height = `${currentHeight}px`;
            }
            
            vList.lastRenderedRange = { start: -1, end: -1 };
            renderVisibleItems();
            
            buildDescriptionIndex(); 
        };

        const renderCuentas = async () => {
            const resCont = select('resumen-cuentas-container'), pillsCont = select('filter-account-types-pills'), totalBalanceEl = select('cuentas-total-balance');
            if (!resCont || !pillsCont || !totalBalanceEl) return;
            if (liquidAssetsChart) liquidAssetsChart.destroy();
            
            const saldos = await getSaldos();
            const allAccounts = getVisibleAccounts();
            const allAccountTypes = [...new Set(allAccounts.map((c) => toSentenceCase(c.tipo || 'S/T')))].sort();
            
            pillsCont.innerHTML = allAccountTypes.map(t => `<button class="filter-pill ${!deselectedAccountTypesFilter.has(t) ? 'filter-pill--active' : ''}" data-action="toggle-account-type-filter" data-type="${t}">${t}</button>`).join('') || `<p style="font-size:var(--fs-xs); color:var(--c-on-surface-secondary)">No hay cuentas en esta vista.</p>`;
            
            const filteredAccountTypes = new Set(allAccountTypes.filter(t => !deselectedAccountTypesFilter.has(t)));
            
            let totalSelectedBalance = 0;
            allAccounts.forEach((c) => {
                const tipo = toSentenceCase(c.tipo || 'S/T');
                if (filteredAccountTypes.has(tipo)) {
                    totalSelectedBalance += (saldos[c.id] || 0);
                }
            });
            animateCountUp(totalBalanceEl, totalSelectedBalance, 500);
        
            const accountsByType = allAccounts.reduce((acc, c) => {
                const tipo = toSentenceCase(c.tipo || 'S/T');
                if (!acc[tipo]) acc[tipo] = [];
                acc[tipo].push(c);
                return acc;
            }, {});
            
            resCont.innerHTML = Object.keys(accountsByType).sort().map(tipo => {
                if (!filteredAccountTypes.has(tipo)) return '';
                
                const accountsInType = accountsByType[tipo];
                const typeBalance = accountsInType.reduce((sum, account) => sum + (saldos[account.id] || 0), 0);

                const accountsHtml = accountsInType.sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => {
                    const balance = saldos[c.id] || 0;
                    const accountPercentage = typeBalance !== 0 ? (Math.abs(balance) / Math.abs(typeBalance)) * 100 : 0;
                    const accountPercentageText = balance !== 0 ? ` (${accountPercentage.toFixed(1)}%)` : '';
                    let amountHTML = `<strong>${formatCurrency(balance)}</strong>${accountPercentageText}`;
                    if (tipo === 'PRÃ‰STAMO') {
                        amountHTML = `<strong class="text-warning">${formatCurrency(Math.abs(balance))}</strong>${accountPercentageText}`;
                    }
                    const investmentIcon = c.esInversion ? `<span class="material-icons text-info" style="font-size: 14px; margin-left: var(--sp-2);" title="Cuenta de Portafolio">trending_up</span>` : '';
                    return `
                        <div class="modal__list-item" data-action="view-account-details" data-id="${c.id}" style="cursor: pointer; padding-left: 0; padding-right: 0;">
                            <div><span style="display: block; font-weight: 500;">${c.nombre}</span></div>
                            <div style="display: flex; align-items: center; gap: var(--sp-2);">${amountHTML}${investmentIcon}<span class="material-icons" style="font-size: 18px; color: var(--c-on-surface-secondary);">chevron_right</span></div>
                        </div>`;
                }).join('');
                
                if (!accountsHtml) return '';
                
                const typePercentage = totalSelectedBalance !== 0 ? (typeBalance / totalSelectedBalance) * 100 : 0;
                const percentageText = typeBalance !== 0 ? ` (${typePercentage.toFixed(1)}%)` : '';
                const icon = tipo==='EFECTIVO'?'payments':(tipo.includes('TARJETA')?'credit_card':(tipo==='AHORRO'?'savings':(tipo==='INVERSIÃ“N'?'trending_up':(tipo==='PROPIEDAD'?'domain':(tipo==='PRÃ‰STAMO'?'credit_score':'account_balance')))));
                
                return `
                    <details class="accordion">
                        <summary>
                            <span class="account-group__name"><span class="material-icons" style="vertical-align:bottom;font-size:16px;margin-right:8px">${icon}</span>${tipo}</span>
                            <div style="display:flex; align-items:center; gap:var(--sp-2);">
                                <span class="account-group__balance">${formatCurrency(typeBalance)}${percentageText}</span>
                                <span class="material-icons accordion__icon">expand_more</span>
                            </div>
                        </summary>
                        <div class="accordion__content">${accountsHtml}</div>
                    </details>`;
            }).join('');
        
            const chartContainer = select(`liquid-assets-chart-container`);
            const chartCtx = (select(`liquid-assets-chart`))?.getContext('2d');
            if (chartCtx && chartContainer) {
                const saldosPorTipoChart = {};
                getLiquidAccounts().filter((c) => filteredAccountTypes.has(toSentenceCase(c.tipo || 'S/T'))).forEach((c) => {
                    const tipo = toSentenceCase(c.tipo || 'S/T');
                    saldosPorTipoChart[tipo] = (saldosPorTipoChart[tipo] || 0) + (saldos[c.id] || 0);
                });
                const chartData = Object.entries(saldosPorTipoChart).filter(([,saldo]) => saldo > 0);
                if (chartData.length > 0) {
                    chartContainer.classList.remove('hidden');
                    liquidAssetsChart = new Chart(chartCtx, {
                        type: 'pie',
                        data: {
                            labels: chartData.map(([tipo]) => tipo),
                            datasets: [{ data: chartData.map(([, saldo]) => saldo / 100), backgroundColor: ['#007AFF', '#30D158', '#FFD60A', '#FF3B30', '#C084FC', '#4ECDC4'], borderColor: getComputedStyle(document.body).getPropertyValue('--c-background'), borderWidth: 4 }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 12, padding: 15 } }, datalabels: { formatter: (v,c)=>{ let s=c.chart.data.datasets[0].data.reduce((a,b)=>a+b,0); return s > 0 ? (v*100/s).toFixed(0)+"%" : "0%"; }, color: '#fff', font: { weight: 'bold', size: 10 } } }
                        }
                    });
                } else {
                    chartContainer.classList.add('hidden');
                }
            }
        };
        
        const loadConfig = () => { 
            (select('config-skip-intro')).checked = !!db.config?.skipIntro; 
            const userEmailEl = select('config-user-email'); 
            if (userEmailEl && currentUser) userEmailEl.textContent = currentUser.email; 
        };
        
        // =================================================================================
        // 7.6. DASHBOARD RENDERING
        // =================================================================================
        // INICIO CAMBIO: La funciÃ³n updateDashboard ahora construye la estructura completa del panel unificado
        const updateDashboard = () => {
            const container = select(PAGE_IDS.PANEL);
            if (!container) return;
        
            if (conceptosChart) { conceptosChart.destroy(); conceptosChart = null; }
        
            const widgetOrder = db.config.dashboardWidgets || DEFAULT_DASHBOARD_WIDGETS;
        
            container.innerHTML = `
                <div class="card card--no-bg" id="dashboard-filters-widget">
                    <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary><h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">filter_list</span>Filtros</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                <div class="form-group"><label for="filter-periodo" class="form-label">Periodo</label><select id="filter-periodo" class="form-select"><option value="mes-actual">Mes Actual</option><option value="aÃ±o-actual">AÃ±o Actual</option><option value="siempre">Siempre</option></select></div>
                                <div class="form-grid"><div class="form-group"><label for="filter-cuenta" class="form-label">Cuenta</label><select id="filter-cuenta" class="form-select"></select></div><div class="form-group"><label for="filter-concepto" class="form-label">Concepto</label><select id="filter-concepto" class="form-select"></select></div></div>
                                <button data-action="apply-filters" class="btn btn--primary btn--full">Aplicar Filtros</button>
                            </div>
                        </details>
                    </div>
                </div>

                <div id="panel-view-switcher" class="filter-pills" style="justify-content: center;">
                    <button class="filter-pill filter-pill--active" data-action="set-panel-view" data-view="general">Vista General</button>
                    <button class="filter-pill" data-action="set-panel-view" data-view="report">Informe Personalizado</button>
                </div>

                <div id="dashboard-view-general">
                    ${widgetOrder.map(widgetId => {
                        switch(widgetId) {
                            case 'kpi-summary': return renderDashboardKpiSummary();
                            case 'concept-totals': return renderDashboardConceptTotals();
                            default: return '';
                        }
                    }).join('')}
                </div>

                <div id="dashboard-view-report" class="hidden">
                    <div class="card card--no-bg">
                        <div class="accordion-wrapper">
                            <details class="accordion" open>
                                <summary>
                                    <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">date_range</span>Seleccionar Fechas</h3>
                                    <span class="material-icons accordion__icon">expand_more</span>
                                </summary>
                                <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="informe-fecha-inicio" class="form-label">Desde</label>
                                            <input type="date" id="informe-fecha-inicio" class="form-input" />
                                        </div>
                                        <div class="form-group">
                                            <label for="informe-fecha-fin" class="form-label">Hasta</label>
                                            <input type="date" id="informe-fecha-fin" class="form-input" />
                                        </div>
                                    </div>
                                    <button data-action="apply-informe-filters" class="btn btn--primary btn--full">Generar Informe</button>
                                </div>
                            </details>
                        </div>
                    </div>

                    <div id="informe-results-container" class="hidden">
                        <section id="informe-kpi-container" class="kpi-grid" aria-label="Resumen del informe"></section>
                        <div class="card">
                            <h3 class="card__title"><span class="material-icons">timeline</span>EvoluciÃ³n Mensual</h3>
                            <div class="card__content">
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="informes-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="empty-informes" class="empty-state" style="margin: 0 var(--sp-4); border: none;">
                        <span class="material-icons">analytics</span>
                        <h3>Genera tu Informe</h3>
                        <p>Selecciona las fechas y pulsa "Generar Informe" para ver la evoluciÃ³n de tus finanzas.</p>
                    </div>
                </div>
            `;
            populateAllDropdowns();
            select('filter-periodo')?.dispatchEvent(new Event('change'));
            updateDashboardData();
        };
        // FIN CAMBIO
        
        const renderDashboardKpiSummary = () => {
            return `
                <section id="kpi-container" class="kpi-grid" aria-label="Indicadores clave de rendimiento">
                    <div class="kpi-item"><h4 class="kpi-item__label">Ingresos</h4><strong id="kpi-ingresos-value" class="kpi-item__value text-positive skeleton" data-current-value="0">+0,00 â‚¬</strong><div id="kpi-ingresos-comparison" class="kpi-item__comparison"></div></div>
                    <div class="kpi-item"><h4 class="kpi-item__label">Gastos</h4><strong id="kpi-gastos-value" class="kpi-item__value text-negative skeleton" data-current-value="0">0,00 â‚¬</strong><div id="kpi-gastos-comparison" class="kpi-item__comparison"></div></div>
                    <div class="kpi-item"><h4 class="kpi-item__label">Saldo Neto</h4><strong id="kpi-saldo-value" class="kpi-item__value skeleton" data-current-value="0">0,00 â‚¬</strong><div id="kpi-saldo-comparison" class="kpi-item__comparison"></div></div>
                </section>`;
        };
        
        const renderDashboardConceptTotals = () => {
            return `
                <div class="card card--no-bg" id="concept-totals-widget">
                    <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary><h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">category</span>Totales por Concepto</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);"><div class="chart-container" style="height: 240px; margin-bottom: var(--sp-2);"><canvas id="conceptos-chart"></canvas></div><div id="concepto-totals-list">${Array(3).fill('<div class="skeleton" style="height: 48px; margin-bottom: 2px;"></div>').join('')}</div></div>
                        </details>
                    </div>
                </div>`;
        };
        
        const updateDashboardData = async () => {
            const { current, previous, label } = await getFilteredMovements(true);
            const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
            const kpiContainer = select('kpi-container');
            const conceptListContainer = select('concepto-totals-list');
            const chartCtx = select('conceptos-chart')?.getContext('2d');
            const cId = select('filter-cuenta')?.value;
        
            const calculateTotals = (movs) => {
                let ingresos = 0, gastos = 0;
                movs.forEach(m => {
                    if (m.tipo === 'movimiento') { 
                        if (m.cantidad > 0) ingresos += m.cantidad; 
                        else gastos += m.cantidad; 
                    } 
                    else if (m.tipo === 'traspaso') {
                        if (cId) {
                            if (m.cuentaOrigenId === cId) { gastos -= m.cantidad; }
                            if (m.cuentaDestinoId === cId) { ingresos += m.cantidad; }
                        } else {
                            const origenVisible = visibleAccountIds.has(m.cuentaOrigenId);
                            const destinoVisible = visibleAccountIds.has(m.cuentaDestinoId);
                            if (origenVisible && !destinoVisible) { gastos -= m.cantidad; }
                            else if (!origenVisible && destinoVisible) { ingresos += m.cantidad; }
                        }
                    }
                });
                return { ingresos, gastos };
            };
        
            const currentTotals = calculateTotals(current);
            const previousTotals = calculateTotals(previous);
            
            if (kpiContainer) {
                selectAll('#kpi-container .skeleton').forEach(el => el.classList.remove('skeleton'));
                
                const getComparisonHTML = (currentVal, prevVal, comparisonLabel, lowerIsBetter = false) => {
                    if (!comparisonLabel || prevVal === 0) return '';
                    const isImprovement = lowerIsBetter ? (currentVal < prevVal) : (currentVal > prevVal);
                    const diff = (currentVal - prevVal) / Math.abs(prevVal) * 100;
                    const diffClass = isImprovement ? 'text-positive' : 'text-negative';
                    const icon = isImprovement ? 'arrow_upward' : 'arrow_downward';
                    return `<span class="${diffClass}"><span class="material-icons" style="font-size: 12px; vertical-align: middle;">${icon}</span> ${Math.abs(diff).toFixed(0)}%</span> <span style="color:var(--c-on-surface-secondary)">${comparisonLabel}</span>`;
                };

                const saldoActual = currentTotals.ingresos + currentTotals.gastos;
                const saldoAnterior = previousTotals.ingresos + previousTotals.gastos;
        
                animateCountUp(select('kpi-ingresos-value'), currentTotals.ingresos);
                select('kpi-ingresos-comparison').innerHTML = getComparisonHTML(currentTotals.ingresos, previousTotals.ingresos, label);
                animateCountUp(select('kpi-gastos-value'), currentTotals.gastos);
                select('kpi-gastos-comparison').innerHTML = getComparisonHTML(Math.abs(currentTotals.gastos), Math.abs(previousTotals.gastos), label, true);
                
                const kpiSaldoValueEl = select('kpi-saldo-value');
                if (kpiSaldoValueEl) {
                    kpiSaldoValueEl.classList.remove('text-positive', 'text-negative');
                    kpiSaldoValueEl.classList.add(saldoActual >= 0 ? 'text-positive' : 'text-negative');
                    animateCountUp(kpiSaldoValueEl, saldoActual);
                }
                select('kpi-saldo-comparison').innerHTML = getComparisonHTML(saldoActual, saldoAnterior, label);
            }
        
            if (conceptosChart) conceptosChart.destroy();
            if (conceptListContainer && chartCtx) {
                const cTots = current.reduce((a, m) => { if (m.tipo === 'movimiento' && m.conceptoId) { if (!a[m.conceptoId]) a[m.conceptoId] = { total: 0, movements: [], icon: db.conceptos.find((c) => c.id === m.conceptoId)?.icon || 'label' }; a[m.conceptoId].total += m.cantidad; a[m.conceptoId].movements.push(m); } return a; }, {});
                const sortedTotals = Object.entries(cTots).sort(([, a], [, b]) => a.total - b.total);
                const colorSuccess = getComputedStyle(document.body).getPropertyValue('--c-chart-positive').trim(), colorDanger = getComputedStyle(document.body).getPropertyValue('--c-danger').trim();
                conceptosChart = new Chart(chartCtx, { type: 'bar', data: { labels: sortedTotals.map(([id]) => toSentenceCase(db.conceptos.find((c) => c.id === id)?.nombre || '?')), datasets: [{ data: sortedTotals.map(([, data]) => data.total / 100), backgroundColor: sortedTotals.map(([, data]) => data.total >= 0 ? colorSuccess : colorDanger), borderRadius: 6, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { y: { ticks: { callback: (value) => `${value.toLocaleString('es-ES')}` } } } } });
                conceptListContainer.innerHTML = sortedTotals.length === 0 ? `<div class="empty-state" style="padding:16px 0; background:transparent; border:none;"><p>Sin datos para los filtros.</p></div>` : sortedTotals.map(([id, data]) => { const con = db.conceptos.find((c) => c.id === id); const t = data.total; return `<details class="accordion" style="background-color: var(--c-surface-variant);"><summary><span style="display: flex; align-items: center; gap: 8px;"><span class="material-icons" style="font-size: 18px;">${data.icon}</span>${toSentenceCase(con?.nombre || '?')}</span><span><strong class="${t >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(t)}</strong><span class="material-icons accordion__icon">expand_more</span></span></summary><div class="accordion__content">${data.movements.sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime()).map((mov) => `<div class="transaction-card" data-action="edit-movement" data-id="${mov.id}" style="border:0;"><div class="transaction-card__content" style="padding: var(--sp-1) 0; "><div style="flex-grow:1;min-width:0;"><div class="transaction-card__row-2" style="font-size:0.75rem;">${new Date(mov.fecha).toLocaleDateString('es-ES')} - ${escapeHTML(mov.descripcion)}</div></div><div class="transaction-card__amount ${mov.cantidad >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(mov.cantidad)}</div></div></div>`).join('')}</div></details>`; }).join('');
            }
        };
        
        // =================================================================================
        // 8. MODAL & FORM HANDLING
        // =================================================================================
        const showModal=(id)=>{
            const m = select(id);
            if (m) {
                const mainScroller = selectOne('.app-layout__main');
                if (mainScroller) { 
					lastScrollTop = mainScroller.scrollTop;
				}
				m.classList.add('modal-overlay--active');
                if(!id.includes('calculator')){
                    const f = m.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (f) (f).focus();
                }
            }
        };

        const hideModal=(id)=>{
            const m = select(id);
            if(m) m.classList.remove('modal-overlay--active');

            const mainScroller = selectOne('.app-layout__main');
            if (mainScroller && lastScrollTop !== null) {
                requestAnimationFrame(() => {
				    mainScroller.scrollTop = lastScrollTop;
                    lastScrollTop = null;
                });
            }
        };

        const showGenericModal=(title,html)=>{(select('generic-modal-title')).textContent=title;(select('generic-modal-body')).innerHTML=html;showModal('generic-modal');};
        const showConfirmationModal=(msg, onConfirm, title="Confirmar AcciÃ³n")=>{ hapticFeedback('medium'); const id='confirmation-modal';document.getElementById(id)?.remove(); const overlay=document.createElement('div');overlay.id=id;overlay.className='modal-overlay modal-overlay--active'; overlay.innerHTML=`<div class="modal" role="alertdialog" style="border-radius:var(--border-radius-lg)"><div class="modal__header"><h3 class="modal__title">${title}</h3></div><div class="modal__body"><p>${msg}</p><div style="display:flex;gap:var(--sp-3);margin-top:var(--sp-4);"><button class="btn btn--secondary btn--full" data-action="close-modal" data-modal-id="confirmation-modal">Cancelar</button><button class="btn btn--danger btn--full" data-action="confirm-action">SÃ­, continuar</button></div></div></div>`; document.body.appendChild(overlay); (overlay.querySelector('[data-action="confirm-action"]')).onclick=()=>{hapticFeedback('medium');onConfirm();overlay.remove();}; (overlay.querySelector('[data-action="close-modal"]')).onclick=()=>overlay.remove(); };
        
        const showAccountMovementsModal = async (cId) => {
            const cuenta = getVisibleAccounts().find((c) => c.id === cId);
            if (!cuenta) return;

            showGenericModal(`Movimientos de ${cuenta.nombre}`, `<div style="text-align:center; padding: var(--sp-5);"><span class="spinner"></span><p style="margin-top: var(--sp-3);">Cargando historial...</p></div>`);

            try {
                // --- Esta parte de la obtenciÃ³n de datos es correcta y no cambia ---
                const movsRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos');
                
                const regularMovsQuery = movsRef.where('cuentaId', '==', cId).get();
                const originTransfersQuery = movsRef.where('cuentaOrigenId', '==', cId).get();
                const destinationTransfersQuery = movsRef.where('cuentaDestinoId', '==', cId).get();

                const [regularSnapshot, originSnapshot, destinationSnapshot] = await Promise.all([
                    regularMovsQuery, originTransfersQuery, destinationTransfersQuery
                ]);

                const allMovements = new Map();
                const processSnapshot = (snapshot) => {
                    snapshot.forEach(doc => {
                        allMovements.set(doc.id, { id: doc.id, ...doc.data() });
                    });
                };
                processSnapshot(regularSnapshot);
                processSnapshot(originSnapshot);
                processSnapshot(destinationSnapshot);

                const sortedMovements = Array.from(allMovements.values())
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                // ===================== INICIO DEL CÃ“DIGO AÃ‘ADIDO (LA SOLUCIÃ“N) =====================
                
                // 1. Empezamos con el saldo actual de la cuenta.
                let runningBalanceInCents = cuenta.saldo || 0;

                // 2. Iteramos sobre los movimientos (del mÃ¡s nuevo al mÃ¡s viejo) para calcular el saldo histÃ³rico.
                for (const mov of sortedMovements) {
                    // 3. Asignamos el saldo actual al movimiento que estamos procesando. Este es el saldo ANTES del movimiento.
                    // Para traspasos, necesitamos saber el saldo de ambas cuentas implicadas.
                    if (mov.tipo === 'traspaso') {
                        // El saldo de la cuenta principal (cId) es el que calculamos.
                        mov.runningBalance = runningBalanceInCents;
                        // Para la otra cuenta, simplemente usamos su saldo actual como referencia estÃ¡tica,
                        // ya que calcular su historial completo serÃ­a demasiado complejo aquÃ­.
                        const otraCuentaId = mov.cuentaOrigenId === cId ? mov.cuentaDestinoId : mov.cuentaOrigenId;
                        const otraCuenta = db.cuentas.find(c => c.id === otraCuentaId);
                        
                        if (mov.cuentaOrigenId === cId) {
                            mov.runningBalanceOrigen = runningBalanceInCents;
                            mov.runningBalanceDestino = otraCuenta?.saldo || 0;
                        } else {
                            mov.runningBalanceOrigen = otraCuenta?.saldo || 0;
                            mov.runningBalanceDestino = runningBalanceInCents;
                        }
                    } else {
                        mov.runningBalance = runningBalanceInCents;
                    }
                    
                    // 4. Actualizamos el 'runningBalanceInCents' para el *siguiente* movimiento (el mÃ¡s antiguo)
                    // revirtiendo la operaciÃ³n actual.
                    if (mov.tipo === 'traspaso') {
                        if (mov.cuentaOrigenId === cId) { // SaliÃ³ dinero de nuestra cuenta
                            runningBalanceInCents += mov.cantidad;
                        }
                        if (mov.cuentaDestinoId === cId) { // EntrÃ³ dinero a nuestra cuenta
                            runningBalanceInCents -= mov.cantidad;
                        }
                    } else { // Es un movimiento normal
                        runningBalanceInCents -= mov.cantidad;
                    }
                }
                // ===================== FIN DEL CÃ“DIGO AÃ‘ADIDO =====================

                const html = sortedMovements.length === 0 
                    ? `<div class="empty-state" style="background:transparent; border:none;">...</div>` 
                    : `<div class="movements-modal-container">
                           ${sortedMovements.map((m) => renderVirtualListItem({type: 'transaction', movement: m})).join('')}
                       </div>`;

                const modalBody = select('generic-modal-body');
                if (modalBody) {
                    modalBody.innerHTML = html;
                }

            } catch (error) {
                // ... el resto de la funciÃ³n no cambia ...
                console.error("Error al obtener los movimientos de la cuenta:", error);
                showToast("No se pudo cargar el historial de la cuenta.", "danger");
                const modalBody = select('generic-modal-body');
                if (modalBody) {
                    modalBody.innerHTML = `<p class="text-danger" style="text-align:center;">Ha ocurrido un error al cargar los datos.</p>`;
                }
            }
        };
        
        const setMovimientoFormType = (type) => {
            hapticFeedback('light');
            const isTraspaso = type === 'traspaso';

            select('movimiento-fields').classList.toggle('hidden', isTraspaso);
            select('traspaso-fields').classList.toggle('hidden', !isTraspaso);

            select('form-movimiento-title').textContent = isTraspaso ? 'AÃ±adir Traspaso' : 'AÃ±adir Movimiento';
            
            select('mov-type-btn-movimiento').classList.toggle('filter-pill--active', !isTraspaso);
            select('mov-type-btn-traspaso').classList.toggle('filter-pill--active', isTraspaso);
        };

        const startMovementForm = (id = null, isRecurrent = false) => {
            hapticFeedback('medium');
            const form = select('form-movimiento');
            form.reset();
            clearAllErrors(form.id);
            populateAllDropdowns();

            setMovimientoFormType('movimiento'); 
            
            let data = null;
            let mode = 'new';
            const collectionName = isRecurrent ? 'recurrentes' : 'movimientos';
            const dataSource = isRecurrent ? db.recurrentes : db.movimientos;
        
            if (id) {
                data = dataSource.find(item => item.id === id);
                mode = isRecurrent ? 'edit-recurrent' : 'edit-single';
            }

			select('movimiento-mode').value = mode;
            select('movimiento-id').value = id || '';
        
            if (data?.tipo === 'traspaso') {
                setMovimientoFormType('traspaso');
            }
        
            select('form-movimiento-title').textContent = id ? (data?.tipo === 'traspaso' ? 'Editar Traspaso' : 'Editar Movimiento') : 'AÃ±adir Movimiento';
            select('movimiento-cantidad').value = data ? `${(data.cantidad / 100).toLocaleString('es-ES', { minimumFractionDigits: 2 })}` : '';
            
            const fecha = data?.fecha ? new Date(data.fecha) : new Date();
            select('movimiento-fecha').value = new Date(fecha.getTime() - (fecha.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
            select('movimiento-descripcion').value = data?.descripcion || '';
        
            if (data?.tipo === 'traspaso') {
                select('movimiento-cuenta-origen').value = data?.cuentaOrigenId || '';
                select('movimiento-cuenta-destino').value = data?.cuentaDestinoId || '';
            } else {
                select('movimiento-cuenta').value = data?.cuentaId || '';
                select('movimiento-concepto').value = data?.conceptoId || '';
            }
        
            const recurrenteCheckbox = select('movimiento-recurrente');
            const recurrentOptions = select('recurrent-options');
            if (mode === 'edit-recurrent') {
                recurrenteCheckbox.checked = true;
                select('recurrent-frequency').value = data.frequency;
                select('recurrent-next-date').value = data.nextDate;
                select('recurrent-end-date').value = data.endDate || '';
                recurrentOptions.classList.remove('hidden');
            } else {
                recurrenteCheckbox.checked = false;
                recurrentOptions.classList.add('hidden');
            }
            
            select('delete-movimiento-btn').classList.toggle('hidden', !id);
            select('delete-movimiento-btn').dataset.isRecurrent = isRecurrent;
            select('duplicate-movimiento-btn').classList.toggle('hidden', !(mode === 'edit-single'));
            
            showModal('movimiento-modal');
        };
        
        const showCalculator = (targetInput) => {
            calculatorState.targetInput = targetInput;
            const currentValue = targetInput.value.trim().replace(/\s?â‚¬/g, '');
            if (currentValue && !isNaN(parseFloat(currentValue.replace(',', '.')))) {
                calculatorState.displayValue = currentValue.replace('.', '');
            } else {
                calculatorState.displayValue = '0';
            }
            calculatorState.waitingForNewValue = true;
            updateCalculatorDisplay();
            showModal('calculator-modal');
        };
        
        const hideCalculator = () => {
            hideModal('calculator-modal');
            calculatorState.targetInput = null;
        };
        
                
        const handleCalculatorInput = (key) => {
            hapticFeedback('light');
            let { displayValue, waitingForNewValue } = calculatorState;

            displayValue = displayValue.replace(',', '.');

            switch(key) {
                case 'done': 
                    hapticFeedback('medium'); 
                    if (calculatorState.targetInput) {
                        const finalValue = parseFloat(displayValue) || 0;
                        calculatorState.targetInput.value = finalValue.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    hideCalculator(); 
                    return;
                case 'comma': 
                    if (!displayValue.includes('.')) { 
                        displayValue += '.'; 
                    } 
                    waitingForNewValue = false;
                    break;
                case 'clear': 
                    displayValue = '0'; 
                    waitingForNewValue = true; 
                    break;
                case 'backspace': 
                    displayValue = displayValue.slice(0, -1) || '0'; 
                    break;
                case 'sign': 
                    if (displayValue !== '0') { 
                        displayValue = displayValue.startsWith('-') ? displayValue.slice(1) : `-${displayValue}`; 
                    } 
                    break;
                default:
                    if (waitingForNewValue || displayValue === '0') { 
                        displayValue = key; 
                        waitingForNewValue = false; 
                    } else { 
                        displayValue += key; 
                    } 
                    break;
            }
            
            calculatorState.displayValue = displayValue.replace('.', ',');
            calculatorState.waitingForNewValue = waitingForNewValue;
            updateCalculatorDisplay();
        };

        const updateCalculatorDisplay = () => {
            const display = select('calculator-display');
            if (display) { 
                display.textContent = calculatorState.displayValue; 
            }
            if (calculatorState.targetInput) {
                const numValue = parseFloat(calculatorState.displayValue.replace(',', '.')) || 0;
                calculatorState.targetInput.value = numValue.toLocaleString('es-ES', { 
                    useGrouping: false,
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            }
        };

        const showGlobalSearchModal = () => {
            hapticFeedback('medium');
            showModal('global-search-modal');
            setTimeout(() => {
                const input = select('global-search-input');
                input.focus();
                input.value = '';
                input.dispatchEvent(new Event('input'));
            }, 100);
        };
        
        const performGlobalSearch = (query) => {
            const resultsContainer = select('global-search-results');
            if (!query || query.trim().length < 2) {
                resultsContainer.innerHTML = `<div class="empty-state" style="background:transparent; border: none;"><span class="material-icons">manage_search</span><h3>EncuÃ©ntralo todo</h3><p>Busca movimientos, cuentas o conceptos. <br>Atajo: <strong>Cmd/Ctrl + K</strong></p></div>`;
                return;
            }
        
            query = query.toLowerCase();
            let resultsHtml = '';
            const MAX_RESULTS_PER_GROUP = 5;
        
            const movs = (db.movimientos || [])
                .filter(m => {
                    const concept = db.conceptos.find(c => c.id === m.conceptoId)?.nombre.toLowerCase() || '';
                    const desc = m.descripcion.toLowerCase();
                    return desc.includes(query) || concept.includes(query);
                })
                .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))
                .slice(0, MAX_RESULTS_PER_GROUP);
        
            if (movs.length > 0) {
                resultsHtml += `<div class="search-result-group__title">Movimientos (recientes)</div>`;
                movs.forEach(m => {
                    const concept = db.conceptos.find(c => c.id === m.conceptoId)?.nombre || '';
                    const amountClass = m.cantidad >= 0 ? 'text-positive' : 'text-negative';
                    resultsHtml += `
                        <button class="search-result-item" data-action="search-result-movimiento" data-id="${m.id}">
                            <span class="material-icons search-result-item__icon">receipt_long</span>
                            <div class="search-result-item__details" style="flex-grow: 1;">
                                <p>${escapeHTML(m.descripcion)}</p>
                                <small>${new Date(m.fecha).toLocaleDateString('es-ES')} â€¢ ${escapeHTML(concept)}</small>
                            </div>
                            <strong class="${amountClass}">${formatCurrency(m.cantidad)}</strong>
                        </button>`;
                });
            }
        
            const cuentas = (db.cuentas || []).filter(c => c.nombre.toLowerCase().includes(query) || c.tipo.toLowerCase().includes(query)).slice(0, MAX_RESULTS_PER_GROUP);
            if (cuentas.length > 0) {
                resultsHtml += `<div class="search-result-group__title">Cuentas</div>`;
                cuentas.forEach(c => { resultsHtml += `<button class="search-result-item" data-action="search-result-cuenta" data-id="${c.id}"><span class="material-icons search-result-item__icon">account_balance_wallet</span><div class="search-result-item__details"><p>${escapeHTML(c.nombre)}</p><small>${escapeHTML(c.tipo)}</small></div></button>`; });
            }
        
            const conceptos = (db.conceptos || []).filter(c => c.nombre.toLowerCase().includes(query)).slice(0, MAX_RESULTS_PER_GROUP);
            if (conceptos.length > 0) {
                resultsHtml += `<div class="search-result-group__title">Conceptos</div>`;
                conceptos.forEach(c => { resultsHtml += `<button class="search-result-item" data-action="search-result-concepto" data-id="${c.id}"><span class="material-icons search-result-item__icon">label</span><div class="search-result-item__details"><p>${escapeHTML(c.nombre)}</p></div></button>`; });
            }
        
            if (!resultsHtml) {
                resultsHtml = `<div class="empty-state" style="background:transparent; border: none;"><span class="material-icons">search_off</span><h3>Sin resultados</h3><p>No se encontrÃ³ nada para "${escapeHTML(query)}".</p></div>`;
            }
            resultsContainer.innerHTML = resultsHtml;
        };
        
        // =================================================================================
        // 9. FORM HANDLERS & MODAL CONTENT
        // =================================================================================
		    const showHelpModal = () => {
    const helpHTML = `
        <div style="text-align: center; margin-bottom: var(--sp-4);">
            <span class="material-icons" style="font-size: 48px; color: var(--c-primary);">school</span>
            <h3>Â¡Bienvenido/a a tu Centro de Mando Financiero!</h3>
        </div>
        <p>Esta guÃ­a estÃ¡ diseÃ±ada para que saques el mÃ¡ximo partido a la aplicaciÃ³n y tomes el control total de tus finanzas. Â¡Vamos allÃ¡!</p>
        <button class="btn btn--primary btn--full" data-action="start-onboarding-tour" style="margin: var(--sp-4) 0;"><span class="material-icons">tour</span>Iniciar Tour Guiado RÃ¡pido</button>
        
        <h4 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-2);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">key</span>La FilosofÃ­a: Entiende los 3 Pilares</h4>
        <p>Para dominar la app, solo necesitas entender tres conceptos clave que lo organizan todo:</p>
        <ul>
            <li><strong>Cuentas <span class="material-icons" style="font-size: 1em;">account_balance_wallet</span>:</strong> Son los "recipientes" de tu dinero. Representan <strong>DÃ“NDE</strong> estÃ¡ tu patrimonio. Ejemplos: "Banco Santander", "Cartera", "PayPal", "Cuenta de Ahorro".</li>
            <li><strong>Conceptos <span class="material-icons" style="font-size: 1em;">label</span>:</strong> Son las "etiquetas" que explican tus movimientos. Responden al <strong>PORQUÃ‰</strong> se mueve el dinero. Ejemplos: "NÃ³mina", "Supermercado", "Alquiler", "Ocio".</li>
            <li><strong>Movimientos <span class="material-icons" style="font-size: 1em;">swap_horiz</span>:</strong> Son las <strong>ACCIONES</strong>. Unen una Cuenta, un Concepto y una cantidad. Ejemplo: un gasto de 50â‚¬ desde la cuenta "Banco Santander" por el concepto "Supermercado".</li>
        </ul>

        <h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">explore</span>Un Paseo Guiado por cada SecciÃ³n</h3>
        
        <details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">swap_horiz</span><strong>Movimientos</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Es el corazÃ³n de la app, tu historial financiero. AquÃ­ verÃ¡s todas tus transacciones ordenadas por fecha. Usa el botÃ³n azul <strong>(+)</strong> para aÃ±adir nuevos ingresos, gastos o traspasos entre tus cuentas.</p></div></details>
                        
        <details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">dashboard</span><strong>Panel</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Tu centro de control visual. Te ofrece una vista de pÃ¡jaro de tu salud financiera con grÃ¡ficos y resÃºmenes (KPIs). Puedes filtrar por periodo, cuenta o concepto para analizar a fondo.</p><strong>ðŸ’¡ Consejo Pro:</strong> Â¡Este panel es 100% personalizable! Pulsa el icono de ajustes <span class="material-icons" style="font-size:1em; vertical-align:text-bottom;">tune</span> en la barra superior para activar, desactivar y reordenar los mÃ³dulos a tu gusto.</div></details>
        
        <details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">account_balance_wallet</span><strong>Cuentas</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>AquÃ­ gestionas tus "recipientes" de dinero. Puedes ver el saldo total y un desglose por tipo de cuenta. Es la foto de tu patrimonio. Desde aquÃ­ puedes filtrar para ver cÃ³mo se distribuye tu dinero.</p></div></details>

        <details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">analytics</span><strong>Informes</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Tu herramienta de anÃ¡lisis. Selecciona un rango de fechas, una cuenta o un concepto y genera un informe detallado con totales y un grÃ¡fico de evoluciÃ³n. Perfecto para entender tendencias a largo plazo.</p></div></details>

        <details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">trending_up</span><strong>Portafolio</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Tu espacio para seguir tus inversiones. Primero, ve a "Gestionar Activos" y marca quÃ© cuentas son de inversiÃ³n. La app calcularÃ¡ automÃ¡ticamente la rentabilidad (P&L) y la Tasa Interna de Retorno (TIR) para que sepas exactamente cÃ³mo rinden tus activos.</p></div></details>

        <details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">pie_chart</span><strong>Presupuestos</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Define tus metas y lÃ­mites. Selecciona un aÃ±o y asigna un presupuesto anual a cada concepto (los gastos en negativo, los ingresos en positivo). La app te mostrarÃ¡ tu progreso en tiempo real con barras de colores para que no te desvÃ­es de tus objetivos.</p></div></details>

        <h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">stars</span>Funciones Estrella que Debes Conocer</h3>

        <details class="accordion" style="margin-bottom: var(--sp-2);"><summary>ðŸš€ <strong>La Contabilidad Dual (A/B)</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Esta es la funciÃ³n mÃ¡s potente de la app. Te permite llevar dos contabilidades paralelas e independientes.</p><ul><li><strong>Â¿Para quÃ© sirve?</strong> Para separar tus finanzas personales (A) de las de un proyecto, un negocio, gastos compartidos con tu pareja, o cualquier otra cosa que necesites gestionar aparte (B).</li><li><strong>Â¿CÃ³mo se usa?</strong><ol><li>Ve a <strong>Ajustes > GestiÃ³n de Datos > Cuentas</strong>.</li><li>En cada cuenta, activa el interruptor "B" para asignarla a la Contabilidad B.</li><li>Usa el botÃ³n <strong>[A]/[B]</strong> en la esquina superior izquierda para cambiar de vista. Â¡Toda la app (movimientos, panel, informes) se adaptarÃ¡ al instante!</li></ol></div></details>

        <details class="accordion" style="margin-bottom: var(--sp-2);"><summary>ðŸ” <strong>BÃºsqueda Global (Atajo: Ctrl/Cmd + K)</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Pulsa el icono de la lupa o usa el atajo de teclado para abrir la bÃºsqueda universal. Escribe lo que sea (una descripciÃ³n, el nombre de una cuenta, un concepto) y encuentra al instante lo que necesitas sin tener que navegar por menÃºs.</p></div></details>

        <details class="accordion" style="margin-bottom: var(--sp-2);"><summary>ðŸ”„ <strong>ImportaciÃ³n y ExportaciÃ³n de Datos</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Tus datos son tuyos. En <strong>Ajustes > Copia de Seguridad</strong> puedes:<ul><li><strong>Exportar a CSV:</strong> Para abrir tus movimientos en Excel o Google Sheets. Â¡Mejorado con mÃ¡s detalles!</li><li><strong>Exportar/Importar JSON:</strong> Para crear y restaurar copias de seguridad completas de toda tu informaciÃ³n (cuentas, conceptos, etc.).</li><li><strong>Asistente de CSV:</strong> Importa extractos de tu banco de forma sencilla con nuestro asistente guiado, Â¡ahora con detecciÃ³n de duplicados!</li></ul></p></div></details>

        <p style="text-align: center; margin-top: var(--sp-5); font-style: italic; color: var(--c-on-surface-secondary);">Ahora ya conoces todos los secretos. El poder de tus finanzas estÃ¡, literalmente, en tus manos. Â¡Explora, registra y alcanza tus metas!</p>
    `;
    showGenericModal("GuÃ­a Completa de Usuario", helpHTML);
};
        
        const showConceptosModal = () => { 
            const html = `
                <form id="add-concepto-form" novalidate style="margin-bottom: var(--sp-4);">
                    <div class="form-grid"><div class="form-group" style="grid-column: 1 / -1;"><label for="new-concepto-nombre" class="form-label">Nombre del Concepto</label><input type="text" id="new-concepto-nombre" class="form-input" placeholder="Ej: NÃ³mina" required></div></div>
                    <button type="submit" class="btn btn--primary btn--full">AÃ±adir Concepto</button>
                </form>
                <hr style="border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-top: var(--sp-4); margin-bottom: var(--sp-2); font-size: var(--fs-base); color: var(--c-on-surface-secondary);">Conceptos Existentes</h4><div id="conceptos-modal-list"></div>`; 
            showGenericModal('Gestionar Conceptos', html); 
            renderConceptosModalList(); 
        };
        
        const renderConceptosModalList = () => { 
            const list = select('conceptos-modal-list'); 
            if (!list) return; 
            list.innerHTML = (db.conceptos || []).length === 0 
                ? `<p style="font-size:var(--fs-sm); color:var(--c-on-surface-secondary); text-align:center; padding: var(--sp-4) 0;">No hay conceptos.</p>` 
                : [...db.conceptos].sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => `<div id="concepto-item-${c.id}" class="modal__list-item"><div style="display: flex; align-items: center; gap: 12px; flex-grow: 1; min-width: 0;"><span class="material-icons" style="color: var(--c-primary);">${c.icon || 'label'}</span><span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(c.nombre)}</span></div><div style="display: flex; align-items: center; gap: var(--sp-1); flex-shrink: 0;"><button class="icon-btn" data-action="edit-concepto" data-id="${c.id}" title="Editar Concepto"><span class="material-icons">edit_note</span></button><button class="icon-btn" data-action="delete-concepto" data-id="${c.id}" title="Eliminar Concepto"><span class="material-icons">delete_outline</span></button></div></div>`).join(''); 
        };
        
        const showConceptoEditForm = (id) => {
            const itemContainer = select(`concepto-item-${id}`);
            const concepto = db.conceptos.find(c => c.id === id);
            if (!itemContainer || !concepto) return;
            itemContainer.innerHTML = `
                <form class="inline-edit-form" data-id="${id}" novalidate>
                    <div class="form-group" style="margin-bottom: 0;"><label class="form-label" for="edit-concepto-nombre-${id}">Nombre</label><input type="text" id="edit-concepto-nombre-${id}" class="form-input" value="${escapeHTML(concepto.nombre)}" required></div>
                    <div style="display:flex; justify-content: flex-end; gap: var(--sp-2); align-items: center; margin-top: var(--sp-2);"><button type="button" class="btn btn--secondary" data-action="cancel-edit-concepto">Cancelar</button><button type="button" class="btn btn--primary" data-action="save-edited-concepto" data-id="${id}">Guardar</button></div>
                </form>`;
            select(`edit-concepto-nombre-${id}`).focus();
        };
        const handleSaveEditedConcept = async (id, btn) => {
            const nombreInput = select(`edit-concepto-nombre-${id}`);
            const nombre = nombreInput.value.trim();
            if (!nombre) { showToast('El nombre es obligatorio.', 'warning'); nombreInput.classList.add('form-input--invalid'); return; }
            
            await saveDoc('conceptos', id, { nombre }, btn);
			hapticFeedback('success');
			showToast('Concepto actualizado.');
			renderConceptosModalList();
        };

        const showCuentasModal = () => { 
            const existingAccountTypes = [...new Set((db.cuentas || []).map(c => c.tipo))].sort();
            const datalistOptions = existingAccountTypes.map(type => `<option value="${type}"></option>`).join('');
            const html = `
            <form id="add-cuenta-form" novalidate>
                <div class="form-group"><label for="new-cuenta-nombre" class="form-label">Nombre de la Cuenta</label><input type="text" id="new-cuenta-nombre" class="form-input" placeholder="Ej: Cartera personal" required></div>
                <div class="form-group"><label for="new-cuenta-tipo" class="form-label">Tipo de Cuenta</label><input type="text" id="new-cuenta-tipo" class="form-input" list="tipos-cuenta-list" placeholder="Ej: Banco, Cripto, Fintech..." required><datalist id="tipos-cuenta-list">${datalistOptions}</datalist></div>
                <button type="submit" class="btn btn--primary btn--full" style="margin-top: var(--sp-3)">AÃ±adir Cuenta</button>
            </form>
            <hr style="margin: var(--sp-4) 0; border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-top: var(--sp-4); margin-bottom: var(--sp-2); font-size: var(--fs-base); color: var(--c-on-surface-secondary);">Cuentas Existentes</h4><div id="cuentas-modal-list"></div>`; 
            showGenericModal('Gestionar Cuentas', html); 
            renderCuentasModalList(); 
        };
    
        const renderCuentasModalList = () => {
            const list = select('cuentas-modal-list');
            if (!list) return;
            list.innerHTML = (db.cuentas || []).length === 0
                ? `<p style="font-size:var(--fs-sm); color:var(--c-on-surface-secondary); text-align:center; padding: var(--sp-4) 0;">No hay cuentas.</p>`
                : [...db.cuentas].sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => `
                    <div class="modal__list-item" id="cuenta-item-${c.id}">
                    <div style="display: flex; flex-direction: column; flex-grow: 1; min-width: 0;"><span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(c.nombre)}</span><small style="color: var(--c-on-surface-secondary); font-size: var(--fs-xs);">${toSentenceCase(escapeHTML(c.tipo))}</small></div>
                    <div style="display: flex; align-items: center; gap: var(--sp-1); flex-shrink: 0;"><div class="form-switch-group" style="gap: var(--sp-2);"><label for="offbalance-toggle-${c.id}" style="font-size: var(--fs-xs); color: var(--c-on-surface-secondary);" title="Marcar como 'Contabilidad B'">B</label><label class="form-switch"><input type="checkbox" id="offbalance-toggle-${c.id}" data-action="toggle-off-balance" data-id="${c.id}" ${c.offBalance ? 'checked' : ''}><span class="slider"></span></label></div><button class="icon-btn" data-action="edit-cuenta" data-id="${c.id}" title="Editar Cuenta"><span class="material-icons">edit_note</span></button><button class="icon-btn" data-action="delete-cuenta" data-id="${c.id}" title="Eliminar Cuenta"><span class="material-icons">delete_outline</span></button></div>
                    </div>`).join('');
        };
    
        const showAccountEditForm = (id) => {
            const itemContainer = select(`cuenta-item-${id}`);
            const cuenta = db.cuentas.find(c => c.id === id);
            if (!itemContainer || !cuenta) return;
            itemContainer.innerHTML = `
                <form class="inline-edit-form" data-id="${id}" novalidate>
                    <div class="form-grid">
                                                <div class="form-group" style="margin-bottom: 0;"><label class="form-label" for="edit-cuenta-nombre-${id}">Nombre</label><input type="text" id="edit-cuenta-nombre-${id}" class="form-input" value="${escapeHTML(cuenta.nombre)}" required></div>
                        <div class="form-group" style="margin-bottom: 0;"><label class="form-label" for="edit-cuenta-tipo-${id}">Tipo</label><input type="text" id="edit-cuenta-tipo-${id}" class="form-input" list="tipos-cuenta-list" value="${escapeHTML(cuenta.tipo)}" required></div>
                    </div>
                    <div style="display:flex; justify-content: flex-end; gap: var(--sp-2); align-items: center; margin-top: var(--sp-2);"><button type="button" class="btn btn--secondary" data-action="cancel-edit-cuenta">Cancelar</button><button type="button" class="btn btn--primary" data-action="save-edited-cuenta" data-id="${id}">Guardar</button></div>
                </form>`;
            select(`edit-cuenta-nombre-${id}`).focus();
        };
    
        const handleSaveEditedAccount = async (id, btn) => {
            const nombreInput = select(`edit-cuenta-nombre-${id}`);
            const tipoInput = select(`edit-cuenta-tipo-${id}`);
            const nombre = nombreInput.value.trim();
            const tipo = toSentenceCase(tipoInput.value.trim());
        
            if (!nombre || !tipo) { showToast('El nombre y el tipo no pueden estar vacÃ­os.', 'warning'); if (!nombre) nombreInput.classList.add('form-input--invalid'); if (!tipo) tipoInput.classList.add('form-input--invalid'); return; }
            
            await saveDoc('cuentas', id, { nombre, tipo }, btn);
            hapticFeedback('success');
            showToast('Cuenta actualizada.');
            renderCuentasModalList();
        };

        const showRecurrentesModal = () => {
            let html = `<p class="form-label" style="margin-bottom: var(--sp-3);">AquÃ­ puedes ver y gestionar tus operaciones programadas. Se crearÃ¡n automÃ¡ticamente en su fecha de ejecuciÃ³n.</p><div id="recurrentes-modal-list"></div>`;
            showGenericModal('Gestionar Movimientos Recurrentes', html);
            renderRecurrentesModalList();
        };

        const renderRecurrentesModalList = () => {
            const list = select('recurrentes-modal-list');
            if (!list) return;
            const recurrentes = [...(db.recurrentes || [])].sort((a,b) => new Date(a.nextDate) - new Date(b.nextDate));
            list.innerHTML = recurrentes.length === 0 
                ? `<div class="empty-state" style="background:transparent; padding:var(--sp-4) 0; border: none;"><span class="material-icons">event_repeat</span><h3>Sin operaciones programadas</h3><p>Puedes crear una al aÃ±adir un nuevo movimiento.</p></div>`
                : recurrentes.map(r => {
                    const nextDate = new Date(r.nextDate).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                    const frequencyMap = { daily: 'Diaria', weekly: 'Semanal', monthly: 'Mensual', yearly: 'Anual' };
                    const amountClass = r.cantidad >= 0 ? 'text-positive' : 'text-negative';
                    const icon = r.cantidad >= 0 ? 'south_west' : 'north_east';
                    return `
                    <div class="modal__list-item" id="recurrente-item-${r.id}">
                        <div style="display: flex; align-items: center; gap: 12px; flex-grow: 1; min-width: 0;">
                            <span class="material-icons ${amountClass}" style="font-size: 20px;">${icon}</span>
                        <div style="display: flex; flex-direction: column; min-width: 0;">
                                <span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(r.descripcion)}</span>
                                <small style="color: var(--c-on-surface-secondary); font-size: var(--fs-xs);">PrÃ³ximo: ${nextDate} (${frequencyMap[r.frequency]})</small>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--sp-1); flex-shrink: 0;">
                            <strong class="${amountClass}" style="margin-right: var(--sp-2);">${formatCurrency(r.cantidad)}</strong>
                            <button class="icon-btn" data-action="edit-recurrente" data-id="${r.id}" title="Editar Recurrente"><span class="material-icons">edit</span></button>
                        </div>
                    </div>`
                }).join('');
        };

        // =================================================================================
        // 9.5. DASHBOARD CONFIGURATION MODAL LOGIC
        // =================================================================================
        const showDashboardConfigModal = () => {
            const listContainer = select('dashboard-widget-list');
            if (!listContainer) return;
            
            const currentWidgets = db.config.dashboardWidgets || DEFAULT_DASHBOARD_WIDGETS;
            const currentWidgetSet = new Set(currentWidgets);
            
            const widgetItems = currentWidgets.map(widgetId => {
                const widget = AVAILABLE_WIDGETS[widgetId];
                return { id: widgetId, html: createWidgetConfigItem(widgetId, widget, true) };
            });

            Object.keys(AVAILABLE_WIDGETS).forEach(widgetId => {
                if (!currentWidgetSet.has(widgetId)) {
                    const widget = AVAILABLE_WIDGETS[widgetId];
                    widgetItems.push({ id: widgetId, html: createWidgetConfigItem(widgetId, widget, false) });
                }
            });

            listContainer.innerHTML = widgetItems.map(item => item.html).join('');
            
            setupDragAndDrop();
            showModal('dashboard-config-modal');
        };

        const createWidgetConfigItem = (id, widget, isActive) => {
            return `
                <div class="widget-config-item" draggable="true" data-widget-id="${id}">
                    <span class="material-icons drag-handle">drag_indicator</span>
                    <div class="widget-config-item__details">
                        <div class="widget-config-item__title">${widget.title}</div>
                        <div class="widget-config-item__desc">${widget.description}</div>
                    </div>
                    <label class="form-switch">
                        <input type="checkbox" ${isActive ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>`;
        };

        const setupDragAndDrop = () => {
            const container = select('dashboard-widget-list');
            let draggingElement = null;

            container.addEventListener('dragstart', e => {
                draggingElement = e.target.closest('.widget-config-item');
                if (draggingElement) { setTimeout(() => draggingElement.classList.add('dragging'), 0); }
            });

            container.addEventListener('dragend', e => {
                if (draggingElement) { draggingElement.classList.remove('dragging'); draggingElement = null; }
            });

            container.addEventListener('dragover', e => {
                e.preventDefault();
                const target = e.target.closest('.widget-config-item');
                if (target && target !== draggingElement) {
                    const rect = target.getBoundingClientRect();
                    const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                    if (next) { container.insertBefore(draggingElement, target.nextSibling); } 
                    else { container.insertBefore(draggingElement, target); }
                }
            });
        };

        const handleSaveDashboardConfig = (btn) => {
            setButtonLoading(btn, true);
            const widgetItems = selectAll('#dashboard-widget-list .widget-config-item');
            
            const newWidgetOrder = Array.from(widgetItems)
                .filter(item => item.querySelector('input[type="checkbox"]').checked)
                .map(item => item.dataset.widgetId);

            db.config.dashboardWidgets = newWidgetOrder;
            
            const userRef = fbDb.collection('users').doc(currentUser.uid);
            userRef.set({ config: db.config }, { merge: true }).then(() => {
                setButtonLoading(btn, false);
                hideModal('dashboard-config-modal');
                hapticFeedback('success');
                showToast('Panel actualizado.');
                updateDashboard();
            }).catch(err => {
                setButtonLoading(btn, false);
                showToast('Error al guardar la configuraciÃ³n.', 'danger');
            });
        };
        const showManageInvestmentAccountsModal = () => {
            const visibleAccounts = getVisibleAccounts().sort((a, b) => a.nombre.localeCompare(b.nombre));
            let formHtml = `
            <form id="manage-investment-accounts-form" novalidate>
                <p class="form-label" style="margin-bottom: var(--sp-3);">
                    Selecciona las cuentas que quieres que formen parte de tu portafolio de inversiÃ³n. Estas aparecerÃ¡n en la secciÃ³n "Portafolio" para un seguimiento detallado de su rentabilidad.
                </p>
                <div style="max-height: 40vh; overflow-y: auto; padding: var(--sp-2); background: var(--c-surface-variant); border-radius: var(--border-radius-md);">`;

            if (visibleAccounts.length > 0) {
                formHtml += visibleAccounts.map(c => `
                    <div class="form-checkbox-group modal__list-item" style="padding: var(--sp-2);">
                        <input type="checkbox" id="investment-toggle-${c.id}" value="${c.id}" ${c.esInversion ? 'checked' : ''}>
                        <label for="investment-toggle-${c.id}" style="flex-grow: 1;">${escapeHTML(c.nombre)} <small>(${toSentenceCase(c.tipo)})</small></label>
                    </div>
                `).join('');
            } else {
                formHtml += `<p class="empty-state" style="background: transparent; border: none;">No hay cuentas en la contabilidad actual para configurar.</p>`;
            }

            formHtml += `
                </div>
                <div class="modal__actions">
                    <button type="submit" class="btn btn--primary btn--full">Guardar SelecciÃ³n</button>
                </div>
            </form>`;

            showGenericModal('Gestionar Activos de InversiÃ³n', formHtml);
        };

        // =================================================================================
        // 10. EVENT LISTENERS & HANDLERS
        // =================================================================================
        const attachEventListeners = () => {

            const handleDeleteAllData = async (btn) => {
                if (!currentUser) return;
                setButtonLoading(btn, true, 'Borrando...');
                showToast('Iniciando borrado... Esto puede tardar unos segundos.', 'info', 5000);
                const collectionsToDelete = ['movimientos', 'cuentas', 'conceptos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];
                try {
                    for (const collectionName of collectionsToDelete) {
                        const collectionRef = fbDb.collection('users').doc(currentUser.uid).collection(collectionName);
                        let snapshot;
                        do {
                            snapshot = await collectionRef.limit(400).get();
                            if (snapshot.empty) break;
                            const batch = fbDb.batch();
                            snapshot.docs.forEach(doc => batch.delete(doc.ref));
                            await batch.commit();
                        } while (!snapshot.empty);
                    }
                    await fbDb.collection('users').doc(currentUser.uid).set({ config: getInitialDb().config });
                    hapticFeedback('success');
                    showToast('Â¡Todos tus datos han sido eliminados! La aplicaciÃ³n se reiniciarÃ¡.', 'info', 4000);
                    setTimeout(() => location.reload(), 4000);
                } catch (error) {
                    console.error("Error al borrar todos los datos:", error);
                    showToast("OcurriÃ³ un error grave durante el borrado.", "danger");
                    setButtonLoading(btn, false);
                }
            };

            const handleDeleteAccount = async (btn) => {
                if (!currentUser) return;
                showConfirmationModal('Vas a eliminar tu cuenta PERMANENTEMENTE. Todos tus datos serÃ¡n borrados y no podrÃ¡s recuperarlos. Esta acciÃ³n es irreversible.', async () => {
                    setButtonLoading(btn, true, 'Eliminando...');
                    showToast('Eliminando todos tus datos...', 'info', 4000);
                    try {
                        const collectionsToDelete = ['movimientos', 'cuentas', 'conceptos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];
                        for (const collectionName of collectionsToDelete) {
                            const collectionRef = fbDb.collection('users').doc(currentUser.uid).collection(collectionName);
                            let snapshot;
                            do {
                                snapshot = await collectionRef.limit(400).get();
                                if (snapshot.empty) break;
                                const batch = fbDb.batch();
                                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                                await batch.commit();
                            } while (!snapshot.empty);
                        }
                        await fbDb.collection('users').doc(currentUser.uid).delete();
                        showToast('Datos eliminados. Eliminando usuario...', 'info', 3000);
                        await fbAuth.currentUser.delete();
                    } catch (error) {
                        console.error("Error al eliminar la cuenta:", error);
                        if (error.code === 'auth/requires-recent-login') {
                            showToast('Por seguridad, debes haber iniciado sesiÃ³n recientemente. Por favor, cierra sesiÃ³n y vuelve a entrar antes de eliminar tu cuenta.', 'danger', 8000);
                        } else {
                            showToast('OcurriÃ³ un error al eliminar tu cuenta.', 'danger');
                        }
                        setButtonLoading(btn, false);
                    }
                }, 'Â¿Eliminar Cuenta Permanentemente?');
            };

            document.body.addEventListener('click', async (e) => {
                const target = e.target;
                const actionTarget = target.closest('[data-action]');
                
                const suggestionsBox = select('description-suggestions');
                if (suggestionsBox && suggestionsBox.style.display === 'block' && !target.closest('#movimiento-descripcion') && !target.closest('#description-suggestions')) {
                    suggestionsBox.style.display = 'none';
                }

                const modalOverlay = target.closest('.modal-overlay');
                if (modalOverlay && target === modalOverlay && !modalOverlay.id.includes('calculator') && !modalOverlay.id.includes('onboarding')) return hideModal(modalOverlay.id);
                if (!actionTarget) return; 

                const { action, id, page, type, modalId, view } = actionTarget.dataset;
                const btn = actionTarget.closest('button');
                
                const actions = {
                    'navigate': () => navigateTo(page),
                    'help': showHelpModal,
                    'exit': handleExitApp,
                    'toggle-ledger': async () => {
                        hapticFeedback('medium');
                        isOffBalanceMode = !isOffBalanceMode;
                        document.body.dataset.ledgerMode = isOffBalanceMode ? 'B' : 'A';
                        const activePage = selectOne('.view--active')?.id || PAGE_IDS.MOVIMIENTOS;
                        navigateTo(activePage, false);
                        showToast(`Mostrando Contabilidad ${isOffBalanceMode ? 'B' : 'A'}.`, 'info');
                    },
                    'toggle-off-balance': async () => {
                        const checkbox = target.closest('input[type="checkbox"]'); if (!checkbox) return;
                        hapticFeedback('light');
                        await saveDoc('cuentas', checkbox.dataset.id, { offBalance: checkbox.checked });
                    },
                    'apply-filters': () => { hapticFeedback('light'); updateDashboardData(); },
                    // INICIO CAMBIO: La acciÃ³n de aplicar filtros de informe ahora llama a la funciÃ³n de renderizado de informes
                    'apply-informe-filters': () => { hapticFeedback('light'); renderInformesPage(); },
                    // FIN CAMBIO
                    'add-movement': () => startMovementForm(),
                    'edit-movement': () => {
                        if (select('generic-modal')?.classList.contains('modal-overlay--active')) {
                            hideModal('generic-modal');
                        }
                        startMovementForm(id, false);
                    },			
                    'edit-recurrente': () => { hideModal('generic-modal'); startMovementForm(id, true); },
                    'delete-movement-from-modal': () => {
                        const isRecurrent = (actionTarget.dataset.isRecurrent === 'true');
                        const idToDelete = select('movimiento-id').value;
                        const collection = isRecurrent ? 'recurrentes' : 'movimientos';
                        const message = isRecurrent ? 'Â¿Seguro que quieres eliminar esta operaciÃ³n recurrente?' : 'Â¿Seguro que quieres eliminar este movimiento?';
                        
                        showConfirmationModal(message, async () => {
                            if (!isRecurrent) {
                                const movRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(idToDelete);
                                const doc = await movRef.get();

                                if (doc.exists) {
                                    const movToDelete = doc.data();
                                    if (movToDelete.tipo === 'traspaso') {
                                        await updateAccountBalance(movToDelete.cuentaOrigenId, movToDelete.cantidad); // Devuelve al origen
                                        await updateAccountBalance(movToDelete.cuentaDestinoId, -movToDelete.cantidad); // Saca del destino
                                    } else {
                                        await updateAccountBalance(movToDelete.cuentaId, -movToDelete.cantidad);
                                    }
                                }
                            }
                            await deleteDoc(collection, idToDelete);
                            hideModal('movimiento-modal');
                            hapticFeedback('success');
                            showToast('OperaciÃ³n eliminada.');
                            if (collection === 'movimientos') {
                                loadInitialMovements();
                            }
                        });
                    },
                    'delete-concepto': async () => { 
                        const movsCheck = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').where('conceptoId', '==', id).limit(1).get();
                        if(!movsCheck.empty) { showToast("Concepto en uso, no se puede borrar.","warning"); return; }
                        showConfirmationModal('Â¿Seguro que quieres eliminar este concepto?', async () => { 
                            await deleteDoc('conceptos', id);
                            hapticFeedback('success'); 
                            showToast("Concepto eliminado.");
                        }); 
                    },
                    'delete-cuenta': async () => { 
                        const movsCheck = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').where('cuentaId', '==', id).limit(1).get();
                        if(!movsCheck.empty) { showToast("Cuenta con movimientos, no se puede borrar.","warning",3500); return; }
                        showConfirmationModal('Â¿Seguro que quieres eliminar esta cuenta?', async () => {
                            await deleteDoc('cuentas', id);
                            hapticFeedback('success');
                            showToast("Cuenta eliminada.");
                        });
                    },
                    'close-modal': () => hideModal(modalId || target.closest('.modal-overlay').id),
                    'manage-conceptos': showConceptosModal,
                    'manage-cuentas': showCuentasModal,
                    'manage-recurrentes': showRecurrentesModal,
                    'view-account-details': () => showAccountMovementsModal(id),
                    'save-config': () => handleSaveConfig(btn),
                    'export-data': () => handleExportData(btn),
                    'import-data': () => showImportJSONWizard(),
                    'clear-data': () => {
                        showConfirmationModal('Â¿Seguro que quieres borrar TODOS tus datos financieros? Esta acciÃ³n es irreversible.', () => {
                            showConfirmationModal('Esta es tu Ãºltima oportunidad. Â¿EstÃ¡s absolutamente seguro?', () => {
                                handleDeleteAllData(actionTarget.closest('button'));
                            }, 'ConfirmaciÃ³n Final');
                        });
                    },
                    'toggle-account-type-filter': () => { hapticFeedback('light'); if(deselectedAccountTypesFilter.has(type)) { deselectedAccountTypesFilter.delete(type); } else { deselectedAccountTypesFilter.add(type); } renderCuentas(); },
                    'create-budgets': () => handleCreateBudgets(btn),
                    'update-budgets': handleUpdateBudgets,
                    'logout': () => showConfirmationModal('Â¿Seguro que quieres cerrar la sesiÃ³n?', () => { fbAuth.signOut().then(() => { showToast('SesiÃ³n cerrada correctamente.'); }).catch(() => { showToast('Error al cerrar sesiÃ³n.', 'danger'); }); }, 'Cerrar SesiÃ³n'),
                    'delete-account': () => handleDeleteAccount(actionTarget.closest('button')),
                    'back-to-investment-list': renderInversionesPage,
                    'view-investment-detail': () => renderInvestmentAccountDetail(id),
                    'manage-investment-accounts': showManageInvestmentAccountsModal,
                    'add-aportacion': () => showAportacionModal(),
                    'global-search': showGlobalSearchModal,
                    'search-result-movimiento': () => { hideModal('global-search-modal'); startMovementForm(id, false); },
                    'search-result-cuenta': () => { hideModal('global-search-modal'); showCuentasModal(); setTimeout(() => select(`cuenta-item-${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200); },
                    'search-result-concepto': () => { hideModal('global-search-modal'); showConceptosModal(); setTimeout(() => select(`concepto-item-${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200); },
                    'edit-concepto': () => showConceptoEditForm(id),
                    'cancel-edit-concepto': renderConceptosModalList,
                    'save-edited-concepto': () => handleSaveEditedConcept(id, btn),
                    'edit-cuenta': () => showAccountEditForm(id),
                    'cancel-edit-cuenta': renderCuentasModalList,
                    'save-edited-cuenta': () => handleSaveEditedAccount(id, btn),
                    'duplicate-movement': () => handleDuplicateMovement(), // âœ… BotÃ³n de duplicar ahora funciona
                    'start-onboarding-tour': startTour,
                    'end-tour': endTour,
                    'next-tour-step': nextTourStep,
                    'prev-tour-step': prevTourStep,
                    'configure-dashboard': showDashboardConfigModal,
                    'save-dashboard-config': () => handleSaveDashboardConfig(btn),
                    'set-movimiento-type': () => setMovimientoFormType(type),
                    // INICIO CAMBIO: Nueva acciÃ³n para el selector de vista del panel
                    'set-panel-view': () => {
                        const isGeneralView = view === 'general';
                        selectAll('#panel-view-switcher .filter-pill').forEach(pill => pill.classList.remove('filter-pill--active'));
                        actionTarget.classList.add('filter-pill--active');
                        select('dashboard-view-general').classList.toggle('hidden', !isGeneralView);
                        select('dashboard-view-report').classList.toggle('hidden', isGeneralView);
                    },
                    // FIN CAMBIO
                    'json-wizard-back-2': () => goToJSONStep(1),
                    'json-wizard-import-final': () => handleFinalJsonImport(btn),
                    'toggle-traspaso-accounts-filter': () => populateTraspasoDropdowns()
                };
                if (actions[action]) actions[action](e);
            });

            document.body.addEventListener('submit', (e) => {
                e.preventDefault();
                const target = e.target;
                const submitter = e.submitter;
                const handlers = {
                    'login-form': () => { if (submitter?.dataset.action === 'login') handleLogin(submitter); if (submitter?.dataset.action === 'register') handleRegister(submitter); },
                    'form-movimiento':() => handleSaveMovement(target, submitter),
                    'add-concepto-form':() => handleAddConcept(submitter),
                    'add-cuenta-form':() => handleAddAccount(submitter),
                    'manage-investment-accounts-form':() => handleSaveInvestmentAccounts(target, submitter)
                };
                if(handlers[target.id]) handlers[target.id]();
            });

            document.body.addEventListener('input', (e) => {
                const id=(e.target).id;
                if(id && select(`${id}-error`)) clearError(id);
            });

            document.body.addEventListener('focusin', (e) => { if (e.target.matches('.input-amount-calculator')) { e.preventDefault(); showCalculator(e.target); } });
            
            document.addEventListener('change', e => {
                const target = e.target;
                if (target.id === 'filter-periodo') { select('custom-date-filters')?.classList.toggle('hidden', target.value !== 'custom'); }
                if (target.id === 'movimiento-recurrente') { select('recurrent-options').classList.toggle('hidden', !target.checked); if(target.checked && !select('recurrent-next-date').value) { select('recurrent-next-date').value = select('movimiento-fecha').value; } }
            });

            select('import-file-input')?.addEventListener('change', (e) => { if(e.target.files[0]) handleJSONFileSelect(e.target.files[0]); });
            select('calculator-grid')?.addEventListener('click', (e) => { const btn = e.target.closest('button'); if(btn && btn.dataset.key) handleCalculatorInput(btn.dataset.key); });
            
            const searchInput = select('global-search-input');
            searchInput?.addEventListener('input', () => { clearTimeout(globalSearchDebounceTimer); globalSearchDebounceTimer = setTimeout(() => { performGlobalSearch(searchInput.value); }, 250); });

            document.body.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); e.stopPropagation(); showGlobalSearchModal(); }
                const tourOverlay = select('onboarding-tour');
                if(tourOverlay.classList.contains('onboarding-overlay--visible')) {
                    if(e.key === 'ArrowRight') nextTourStep();
                    else if (e.key === 'ArrowLeft') prevTourStep();
                    else if (e.key === 'Escape') endTour();
                }
            });

            const mainScroller = selectOne('.app-layout__main');
            mainScroller?.addEventListener('scroll', () => {
                if (!select(PAGE_IDS.MOVIMIENTOS)?.classList.contains('view--active')) return;
                const { scrollTop, scrollHeight, clientHeight } = mainScroller;
                if (scrollHeight - scrollTop - clientHeight < 400) {
                    loadMoreMovements();
                }
            });
            
            const dropZone = select('json-drop-zone');
            dropZone?.addEventListener('click', () => select('import-file-input').click());
            dropZone?.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
            dropZone?.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
            dropZone?.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); const file = e.dataTransfer.files[0]; if (file) handleJSONFileSelect(file); });
        };

        const showImportJSONWizard = () => {
            jsonWizardState = { file: null, data: null, preview: { counts: {}, meta: {} } };
            goToJSONStep(1);
            select('json-file-error').textContent = '';
            select('json-drop-zone-text').textContent = 'Arrastra tu archivo aquÃ­ o haz clic';
            showModal('json-import-wizard-modal');
        };

        const goToJSONStep = (stepNumber) => {
            selectAll('.json-wizard-step').forEach(step => step.style.display = 'none');
            const targetStep = select(`json-wizard-step-${stepNumber}`);
            if (targetStep) targetStep.style.display = 'flex';
        };

        const handleJSONFileSelect = (file) => {
            const errorEl = select('json-file-error');
            errorEl.textContent = '';

            if (!file.type.includes('json')) {
                errorEl.textContent = 'Error: El archivo debe ser de tipo .json.';
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    let data = JSON.parse(event.target.result);
                    let dataToAnalyze = data;

                    if (data.meta && data.data) {
                        jsonWizardState.preview.meta = data.meta;
                        dataToAnalyze = data.data;
                    } else {
                        jsonWizardState.preview.meta = { appName: 'Cuentas (Formato Antiguo)', exportDate: 'N/A' };
                    }

                    if (!dataToAnalyze.cuentas || !dataToAnalyze.conceptos || !dataToAnalyze.movimientos) {
                        throw new Error("El archivo no tiene la estructura de una copia de seguridad vÃ¡lida.");
                    }

                    jsonWizardState.data = dataToAnalyze;
                    
                    const counts = {};
                    for (const key in dataToAnalyze) {
                        if (Array.isArray(dataToAnalyze[key])) {
                            counts[key] = dataToAnalyze[key].length;
                        }
                    }
                    jsonWizardState.preview.counts = counts;
                    
                    renderJSONPreview();
                    goToJSONStep(2);

                } catch (error) {
                    console.error("Error al procesar el archivo JSON:", error);
                    errorEl.textContent = `Error: ${error.message}`;
                }
            };
            reader.readAsText(file);
        };

        const renderJSONPreview = () => {
            const previewList = select('json-preview-list');
            const { counts } = jsonWizardState.preview;
            
            const friendlyNames = {
                cuentas: 'Cuentas', conceptos: 'Conceptos', movimientos: 'Movimientos',
                presupuestos: 'Presupuestos', recurrentes: 'Recurrentes',
                inversiones_historial: 'Historial de InversiÃ³n', inversion_cashflows: 'Flujos de Capital'
            };
            
            let html = '';
            for(const key in counts) {
                if(counts[key] > 0) {
                    html += `<li><span class="material-icons">check_circle</span> <strong>${counts[key]}</strong> ${friendlyNames[key] || key}</li>`;
                }
            }
            
            previewList.innerHTML = html || `<li><span class="material-icons">info</span>El archivo parece estar vacÃ­o.</li>`;
        };

        const handleFinalJsonImport = async (btn) => {
            goToJSONStep(3);
            setButtonLoading(btn, true, 'Importando...');
            select('json-import-progress').style.display = 'block';
            select('json-import-result').style.display = 'none';

            try {
                const dataToImport = jsonWizardState.data;
                const collectionsToClear = ['cuentas', 'conceptos', 'movimientos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];

                for (const collectionName of collectionsToClear) {
                    const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).get();
                    if (snapshot.empty) continue;
                    let batch = fbDb.batch();
                    let count = 0;
                    for (const doc of snapshot.docs) {
                        batch.delete(doc.ref);
                        count++;
                        if (count >= 450) { await batch.commit(); batch = fbDb.batch(); count = 0; }
                    }
                    if(count > 0) await batch.commit();
                }
                
                for (const collectionName of Object.keys(dataToImport)) {
                    const items = dataToImport[collectionName];
                    if (Array.isArray(items) && items.length > 0) {
                        let batch = fbDb.batch();
                        let count = 0;
                        for (const item of items) {
                            if (item.id) {
                                const docRef = fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(item.id);
                                batch.set(docRef, item);
                                count++;
                                if (count >= 450) { await batch.commit(); batch = fbDb.batch(); count = 0; }
                            }
                        }
                        if(count > 0) await batch.commit();
                    } else if (collectionName === 'config') {
                        await fbDb.collection('users').doc(currentUser.uid).set({ config: items }, { merge: true });
                    }
                }
                
                select('json-import-progress').style.display = 'none';
                select('json-import-result').style.display = 'block';
                select('json-result-message').textContent = `Se han importado los datos correctamente. La aplicaciÃ³n se recargarÃ¡.`;
                hapticFeedback('success');
                
                setTimeout(() => location.reload(), 4000);

            } catch (error) {
                console.error("Error durante la importaciÃ³n final:", error);
                showToast("Error crÃ­tico durante la importaciÃ³n.", "danger", 5000);
                select('json-result-title').textContent = 'Â¡Error en la ImportaciÃ³n!';
                select('json-result-message').textContent = `OcurriÃ³ un error. Por favor, revisa la consola e intÃ©ntalo de nuevo.`;
                select('json-import-progress').style.display = 'none';
                select('json-import-result').style.display = 'block';
                select('json-import-result .material-icons').style.color = 'var(--c-danger)';
                setButtonLoading(btn, false);
            }
        };

        // âœ… [IMPLEMENTACIÃ“N] FunciÃ³n para duplicar un movimiento
        const handleDuplicateMovement = () => {
            hapticFeedback('medium');
            
            // 1. Cambiar el modo del formulario a 'new'
            select('movimiento-mode').value = 'new';
            select('movimiento-id').value = '';

            // 2. Actualizar UI para reflejar que es un nuevo movimiento
            select('form-movimiento-title').textContent = 'Duplicar Movimiento';
            select('delete-movimiento-btn').classList.add('hidden');
            select('duplicate-movimiento-btn').classList.add('hidden');
            
            // 3. (Opcional) Cambiar la fecha a la actual
            const today = new Date();
            select('movimiento-fecha').value = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);

            showToast('Datos duplicados. Ajusta y guarda.', 'info');
        };

        const handleSaveMovement = async (form, btn) => {
            clearAllErrors(form.id);
            let isValid = true;
            const type = select('mov-type-btn-traspaso').classList.contains('filter-pill--active') ? 'traspaso' : 'movimiento';
            const cantidadValue = parseCurrencyString(select('movimiento-cantidad').value);

            if (isNaN(cantidadValue)) { displayError('movimiento-cantidad', 'La cantidad no es vÃ¡lida.'); isValid = false; }
            if (!select('movimiento-fecha').value) { displayError('movimiento-fecha', 'La fecha es obligatoria.'); isValid = false; }
            if (!select('movimiento-descripcion').value.trim()) { displayError('movimiento-descripcion', 'La descripciÃ³n es obligatoria.'); isValid = false; }
            if (type === 'movimiento') {
                if (!select('movimiento-concepto').value) { displayError('movimiento-concepto', 'Elige un concepto.'); isValid = false; }
                if (!select('movimiento-cuenta').value) { displayError('movimiento-cuenta', 'Elige una cuenta.'); isValid = false; }
            } else {
                const origen = select('movimiento-cuenta-origen').value;
                const destino = select('movimiento-cuenta-destino').value;
                if (!origen) { displayError('movimiento-cuenta-origen', 'Elige cuenta origen.'); isValid = false; }
                if (!destino) { displayError('movimiento-cuenta-destino', 'Elige cuenta destino.'); isValid = false; }
                if (origen && destino && origen === destino) { displayError('movimiento-cuenta-destino', 'Las cuentas no pueden ser iguales.'); isValid = false; }
            }
            if (!isValid) { hapticFeedback('error'); showToast('Por favor, revisa los campos marcados en rojo.', 'warning'); return; }
            
            setButtonLoading(btn, true);

            const mode = select('movimiento-mode').value;
            const movementId = select('movimiento-id').value || generateId();
            let oldMovementData = null;

            if (mode.includes('edit')) {
                const oldDocRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(movementId);
                const doc = await oldDocRef.get();
                if (doc.exists) {
                    oldMovementData = doc.data();
                }
            }
            
            const newMovementData = {
                id: movementId,
                cantidad: Math.round(cantidadValue * 100),
                descripcion: select('movimiento-descripcion').value.trim(),
                tipo: type,
                fecha: parseDateStringAsUTC(select('movimiento-fecha').value).toISOString(),
                cuentaId: select('movimiento-cuenta').value,
                conceptoId: select('movimiento-concepto').value,
                cuentaOrigenId: select('movimiento-cuenta-origen').value,
                cuentaDestinoId: select('movimiento-cuenta-destino').value,
            };
            if (newMovementData.tipo === 'traspaso') { newMovementData.cantidad = Math.abs(newMovementData.cantidad); }

            const isRecurrent = select('movimiento-recurrente').checked;

            if (isRecurrent) {
                const recurrentData = { ...newMovementData, frequency: select('recurrent-frequency').value, nextDate: select('recurrent-next-date').value, endDate: select('recurrent-end-date').value || null };
                await saveDoc('recurrentes', movementId, recurrentData);
            } else {
                let balanceUpdates = [];

               if (oldMovementData) { // Estamos EDITANDO un movimiento existente
                    // 1. Revertimos el impacto del movimiento antiguo
                    if (oldMovementData.tipo === 'traspaso') {
                        balanceUpdates.push({ cuentaId: oldMovementData.cuentaOrigenId, amount: oldMovementData.cantidad }); // Devuelve el dinero al origen
                        balanceUpdates.push({ cuentaId: oldMovementData.cuentaDestinoId, amount: -oldMovementData.cantidad }); // Quita el dinero del destino
                    } else {
                        balanceUpdates.push({ cuentaId: oldMovementData.cuentaId, amount: -oldMovementData.cantidad });
                    }
                }
                
                // 2. Aplicamos el impacto del movimiento nuevo (o actualizado)
                if (newMovementData.tipo === 'traspaso') {
                    balanceUpdates.push({ cuentaId: newMovementData.cuentaOrigenId, amount: -newMovementData.cantidad }); // Sale del origen
                    balanceUpdates.push({ cuentaId: newMovementData.cuentaDestinoId, amount: newMovementData.cantidad }); // Entra al destino
                } else {
                    balanceUpdates.push({ cuentaId: newMovementData.cuentaId, amount: newMovementData.cantidad });
                }

                const finalUpdates = balanceUpdates.reduce((acc, up) => {
                    if (up.cuentaId) {
                        acc[up.cuentaId] = (acc[up.cuentaId] || 0) + up.amount;
                    }
                    return acc;
                }, {});

                const updatePromises = Object.entries(finalUpdates).map(([cuentaId, amount]) => updateAccountBalance(cuentaId, amount));

                await Promise.all([
                    saveDoc('movimientos', movementId, newMovementData),
                    ...updatePromises
                ]);
            }
            
            if (mode.includes('new') && !isRecurrent) {
                newMovementIdToHighlight = movementId;
            }
            
            setButtonLoading(btn, false);
            hideModal('movimiento-modal');
            hapticFeedback('success');
            showToast(mode === 'new' ? 'Movimiento guardado.' : 'Movimiento actualizado.');
            // [MEJORA] Se recarga siempre la lista para mantener la consistencia de los saldos corrientes
            if (!isRecurrent) {
                loadInitialMovements();
            }
        };

        const handleAddConcept = async (btn) => { 
            const nombre = toSentenceCase((select('new-concepto-nombre')).value.trim());
            if (!nombre) { showToast('El nombre es obligatorio.', 'warning'); return; } 
            const newId = generateId();
            await saveDoc('conceptos', newId, { id: newId, nombre, icon: 'label' }, btn);
            hapticFeedback('success'); 
            showToast('Concepto aÃ±adido.');
            (select('add-concepto-form')).reset(); 
        };
        const handleAddAccount = async (btn) => { 
            const nombre = (select('new-cuenta-nombre')).value.trim(); 
            const tipo = toSentenceCase((select('new-cuenta-tipo')).value.trim()); 
            if (!nombre || !tipo) { showToast('El nombre y el tipo son obligatorios.', 'warning'); return; } 
            const newId = generateId();
            await saveDoc('cuentas', newId, { id: newId, nombre, tipo, saldo: 0, esInversion: false, offBalance: isOffBalanceMode, fechaCreacion: new Date().toISOString() }, btn);
            hapticFeedback('success'); 
            showToast('Cuenta aÃ±adida.');
            (select('add-cuenta-form')).reset(); 
        };
        const handleSaveConfig = async (btn) => { 
            setButtonLoading(btn, true);
            const newConfig = { skipIntro: select('config-skip-intro').checked, dashboardWidgets: db.config.dashboardWidgets || DEFAULT_DASHBOARD_WIDGETS };
            await fbDb.collection('users').doc(currentUser.uid).set({ config: newConfig }, { merge: true });
            localStorage.setItem('skipIntro', String(newConfig.skipIntro));
            setButtonLoading(btn, false);
            hapticFeedback('success'); showToast('ConfiguraciÃ³n guardada.'); 
        };

        const handleExportData = async (btn) => {
            if (!currentUser) { showToast("No hay usuario autenticado.", "danger"); return; }
            setButtonLoading(btn, true, 'Exportando...');
            try {
                const dataPayload = {};
                const collections = ['cuentas', 'conceptos', 'movimientos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];
                
                for (const collectionName of collections) {
                    const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).get();
                    dataPayload[collectionName] = snapshot.docs.map(doc => doc.data());
                }
                dataPayload.config = db.config;

                const exportObject = {
                    meta: {
                        appName: "Cuentas aiDANaI",
                        version: "2.0.0",
                        exportDate: new Date().toISOString()
                    },
                    data: dataPayload
                };

                const jsonString = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cuentas_aidanai_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("ExportaciÃ³n JSON completada.", "info");
            } catch (error) {
                console.error("Error al exportar datos:", error);
                showToast("Error durante la exportaciÃ³n.", "danger");
            } finally {
                setButtonLoading(btn, false);
            }
        };

        const handleSaveInvestmentAccounts = async (form, btn) => {
            setButtonLoading(btn, true);
            const selectedIds = new Set(Array.from(form.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value));
            const batch = fbDb.batch();
            db.cuentas.forEach(c => {
                const ref = fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(c.id);
                batch.update(ref, { esInversion: selectedIds.has(c.id) });
            });
            await batch.commit();
            setButtonLoading(btn, false);
            hideModal('generic-modal');
            hapticFeedback('success');
            showToast('Portafolio actualizado.');
        };

        const showAportacionModal = (cuentaId = null) => {
            const investmentAccounts = getVisibleAccounts().filter(c => c.esInversion);
            if (investmentAccounts.length === 0) {
                showToast('Primero debes marcar al menos una cuenta como activo de inversiÃ³n.', 'warning');
                return;
            }
            
            const fechaISO = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
            
            const accountsOptions = investmentAccounts
                .map(c => `<option value="${c.id}" ${cuentaId === c.id ? 'selected' : ''}>${escapeHTML(c.nombre)}</option>`)
                .join('');

            let formHtml = `
            <form id="form-aportacion" novalidate>
                <p class="form-label" style="margin-bottom: var(--sp-3);">
                    Registra una entrada (aportaciÃ³n, positivo) o salida (retiro, negativo) de capital en uno de tus activos. Esto es crucial para calcular correctamente la rentabilidad (TIR).
                </p>
                <div class="form-group">
                    <label for="aportacion-cuenta" class="form-label">Activo de InversiÃ³n</label>
                    <select id="aportacion-cuenta" class="form-select">${accountsOptions}</select>
                </div>
                <div class="form-group">
                    <label for="aportacion-cantidad" class="form-label">Cantidad (retiro en negativo)</label>
                    <input type="text" id="aportacion-cantidad" class="form-input input-amount-calculator" readonly required placeholder="Ej: -250,50 para un retiro">
                </div>
                <div class="form-group">
                    <label for="aportacion-fecha" class="form-label">Fecha</label>
                    <input type="date" id="aportacion-fecha" class="form-input" value="${fechaISO}" required>
                </div>
                <div class="form-group">
                    <label for="aportacion-notas" class="form-label">Notas (Opcional)</label>
                    <input type="text" id="aportacion-notas" class="form-input" placeholder="Ej: AportaciÃ³n periÃ³dica">
                </div>
                <div class="modal__actions">
                    <button type="submit" class="btn btn--primary">Guardar</button>
                </div>
            </form>`;

            showGenericModal('Registrar AportaciÃ³n/Retiro', formHtml);
        };


        async function migrateDataToSubcollections() {
            if (!currentUser) { console.error("No hay usuario logueado."); return; }
            console.log("ðŸš€ Iniciando migraciÃ³n para el usuario:", currentUser.uid);
            try {
                const userDocRef = fbDb.collection('users').doc(currentUser.uid);
                const doc = await userDocRef.get();
                if (!doc.exists || !doc.data().db) { console.warn("No se encontrÃ³ el campo 'db' para migrar."); return; }
                const oldDb = doc.data().db;
                console.log("Datos antiguos encontrados. Procediendo...");
                let batch = fbDb.batch();
                let operations = 0;
                const commitBatch = async () => { await batch.commit(); console.log(`Lote de ${operations} op. completado.`); batch = fbDb.batch(); operations = 0; };
                const collectionsToMigrate = ['cuentas', 'conceptos', 'movimientos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];
                for (const collectionName of collectionsToMigrate) {
                    if (oldDb[collectionName] && Array.isArray(oldDb[collectionName])) {
                        console.log(`- Migrando ${oldDb[collectionName].length} docs a '${collectionName}'...`);
                        for (const item of oldDb[collectionName]) {
                            const docRef = userDocRef.collection(collectionName).doc(item.id);
                            batch.set(docRef, item);
                            operations++;
                            if (operations >= 400) await commitBatch();
                        }
                    }
                }
                if (operations > 0) await commitBatch();
                console.log("âœ… Subcolecciones creadas. Actualizando documento principal...");
                await userDocRef.set({ config: oldDb.config || getInitialDb().config }, { merge: false });
                console.log("ðŸŽ‰ Â¡MIGRACIÃ“N COMPLETADA! Por favor, recarga la aplicaciÃ³n.");
                alert("Â¡MigraciÃ³n completada! Recarga la pÃ¡gina.");
            } catch (error) {
                console.error("âŒ ERROR DURANTE LA MIGRACIÃ“N:", error);
                alert("OcurriÃ³ un error durante la migraciÃ³n. Revisa la consola.");
            }
        }
        window.migrateDataToSubcollections = migrateDataToSubcollections;

        document.addEventListener('DOMContentLoaded', initApp);
		
		// =================================================================================
        // FUNCIONES DE AYUDA PARA CONSULTAS AVANZADAS (CÃ“DIGO ESENCIAL)
        // =================================================================================

        /**
         * Ejecuta mÃºltiples consultas 'in' para superar el lÃ­mite de 10 elementos de Firestore.
         * @param {firebase.firestore.Query} baseQuery - La consulta base sin el filtro 'in'.
         * @param {string} field - El campo por el que filtrar (ej. 'cuentaId').
         * @param {Array<string>} ids - El array de IDs (puede tener mÃ¡s de 10).
         * @returns {Promise<Array<Object>>} Una promesa que resuelve a un array con todos los documentos encontrados.
         */
        const fetchMovementsInChunks = async (baseQuery, field, ids) => {
            if (ids.length === 0) {
                return [];
            }
            // Dividimos el array de IDs en trozos de 10
            const idChunks = chunkArray(ids, 10);
            
            // Creamos una promesa de consulta para cada trozo
            const queryPromises = idChunks.map(chunk => {
                return baseQuery.where(field, 'in', chunk).get();
            });

            // Esperamos a que todas las consultas se completen
            const querySnapshots = await Promise.all(queryPromises);

            // Unimos los resultados de todas las consultas en un solo array
            let movements = [];
            querySnapshots.forEach(snapshot => {
                snapshot.forEach(doc => {
                    movements.push({ id: doc.id, ...doc.data() });
                });
            });

            return movements;
        };
    </script>
</body>
</html>