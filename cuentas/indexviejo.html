<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Cuentas Personales</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="manifest" href="data:application/manifest+json,{
        %22name%22:%22Gestor de Cuentas%22,
        %22short_name%22:%22Cuentas%22,
        %22start_url%22:%22.%22,
        %22display%22:%22standalone%22,
        %22background_color%22:%22#000000%22,
        %22theme_color%22:%22#007AFF%22,
        %22description%22:%22Gestor de finanzas personales, elegante y profesional.%22,
        %22icons%22:[
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg%2bxml%2bxml%22},
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3Csvg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg%2bxml%2bxml%22}
        ]
    }">
    <meta name="theme-color" content="#000000"/>
    <link rel="apple-touch-icon" href="aiDANaI.webp">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0"></script>
    <style>
        /* ================================================================= */
        /* === ESTILOS BASE: TEMA ÚNICO "AMOLED FUTURISTA" === */
        /* ================================================================= */
               :root {
            /* === PALETA AMOLED FUTURISTA 2.0 (MEJORADA) === */
            --c-primary: #007AFF;
            --c-primary-hover: #3395FF;
            --c-danger: #FF3B30;
            --c-success: #30D158;
            --c-warning: #FFD60A;
            --c-info: #C084FC;
            
            /* FONDO: Un negro profundo con un gradiente sutil para dar profundidad */
            --c-background: #050508;
            
            /* SUPERFICIES: Ligeramente translúcidas para un efecto de "vidrio ahumado" */
            --c-surface: rgba(22, 24, 30, 0.75);
            --c-surface-variant: rgba(30, 32, 40, 0.75);

            /* BORDES: Un brillo azulado sutil en lugar de un gris plano */
            --c-outline: rgba(0, 122, 255, 0.2);

            --c-on-surface: #FFFFFF;
            --c-on-surface-secondary: #E0E0E0;
            --c-on-surface-tertiary: #B0B0B0;
            --c-on-surface-disabled: #666666;
            
            --c-white: #FFFFFF;
            --c-black: #000000;
            
            --c-chart-positive: var(--c-success);
            --c-chart-negative: var(--c-danger);

            /* SOMBRAS: Un resplandor de neón más suave y pronunciado */
            --shadow-sm: 0 0 12px rgba(0, 122, 255, 0.25);
            --shadow-md: 0 0 24px rgba(0, 122, 255, 0.35), 0 0 40px rgba(0, 122, 255, 0.15);
            --glow-red: 0 0 24px rgba(255, 59, 48, 0.4);

            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            
            --fs-xs: 0.7rem; --fs-sm: 0.825rem; --fs-base: 0.95rem; --fs-lg: 1.05rem; --fs-xl: 1.2rem;
            --sp-1: 0.2rem; --sp-2: 0.4rem; --sp-3: 0.6rem; --sp-4: 0.8rem; --sp-5: 1rem; --sp-6: 1.25rem;
            --border-radius-md: 8px; --border-radius-lg: 14px;
        }

        /* PEQUEÑO AÑADIDO PARA EL EFECTO DE PROFUNDIDAD DEL TEMA OSCURO */
        body {
            background-image: radial-gradient(ellipse at center, #101218 0%, #050508 70%);
        }

        .card, .modal, .kpi-item, .login-view__card, .empty-state {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--c-outline);
            background-color: var(--c-surface); /* Esto activa la translucidez */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; scroll-behavior: smooth; }
        body { font-family: var(--font-family); background-color: var(--c-background); color: var(--c-on-surface); line-height: 1.4; min-height: 100vh; min-height: -webkit-fill-available; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow: hidden; font-weight: 500; }
        *:focus-visible { outline: 2px solid var(--c-primary); outline-offset: 2px; border-radius: var(--sp-2); }
        
        @keyframes pop-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes highlight-card { 0% { background-color: color-mix(in srgb, var(--c-primary) 15%, transparent); } 100% { background-color: transparent; } }
        .highlight-animation { animation: highlight-card 1.5s ease-out; }
        @keyframes highlight-field-success { 0% { background-color: color-mix(in srgb, var(--c-success) 20%, transparent); } 100% { background-color: transparent; } }
        .field-highlighted { animation: highlight-field-success 1s ease-out; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton { background-color: var(--c-surface-variant); background-image: linear-gradient(90deg, var(--c-surface-variant), color-mix(in srgb, var(--c-outline) 20%, var(--c-surface-variant)), var(--c-surface-variant)); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; border-radius: var(--sp-2); color: transparent !important; user-select: none; }
        .skeleton > * { visibility: hidden; }
        
        .intro-screen { position: fixed; inset: 0; z-index: 9999; display: flex; justify-content: center; align-items: center; background-color: #000000; transition: opacity 0.75s ease-in-out; }
        .starry-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(1px 1px at 10% 20%,#fff,transparent),radial-gradient(1px 1px at 80% 30%,#fff,transparent),radial-gradient(2px 2px at 50% 50%,#fff,transparent),radial-gradient(1px 1px at 30% 80%,#fff,transparent),radial-gradient(2px 2px at 90% 90%,#fff,transparent); background-size: 300px 300px; animation: twinkle 15s linear infinite; }
        @keyframes twinkle { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .intro-screen__logo { width: 250px; height: auto; border-radius: 24px; opacity: 0; position: absolute; animation: logoExplode 2.5s cubic-bezier(0.5, 0, 0.5, 1) forwards; }
        @keyframes logoExplode { 0% { transform: scale(0.2) rotate(-25deg); opacity: 0; } 30% { transform: scale(1.1) rotate(10deg); opacity: 1; } 50% { transform: scale(0.95) rotate(-8deg); opacity: 1; } 80% { transform: scale(1.5) rotate(5deg); opacity: 1; } 100% { transform: scale(12) rotate(20deg); opacity: 0; } }
        .intro-screen__quote-container { text-align: center; color: var(--c-white); padding: var(--sp-5); max-width: 800px; z-index: 1; opacity: 0; transition: opacity 1.5s ease-in-out; }
        .intro-screen__quote-container.visible { opacity: 1; }
        .intro-screen__quote-text { font-size: clamp(1.2rem, 4vw, 1.8rem); font-style: italic; font-weight: 400; line-height: 1.4; margin-bottom: 16px; text-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        .intro-screen__quote-author { display: block; font-size: clamp(0.8rem, 2.4vw, 1rem); color: var(--c-on-surface-secondary); font-weight: 500; }
        
        .app-layout { display: none; max-width: 500px; margin: 0 auto; height: 100vh; background-color: var(--c-background); flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; }
        .app-layout--visible { display: flex; opacity: 1; }

        .app-layout__main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 44px 0 48px 0; }
        .view { display: none; flex-direction: column; width: 100%; padding: 0 var(--sp-4); gap: var(--sp-4); }
        .view--active { display: flex; animation: fade-in 0.3s ease-in-out; }
        
        .top-bar { display: flex; align-items: center; justify-content: space-between; padding: var(--sp-2) var(--sp-4); background-color: rgba(0,0,0,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--c-outline); z-index: 200; height: 44px; position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; transition: background-color 0.3s ease-in-out; }
        .top-bar__title {
			font-size: var(--fs-lg);
			font-weight: 800;
			/* Se elimina margin-right: auto; */
			padding-left: var(--sp-2);
			flex: 1; /* Permite que el título ocupe el espacio disponible */
			text-align: center; /* Centra el texto dentro de ese espacio */
		}

        .top-bar__actions { display: flex; align-items: center; gap: var(--sp-1); }
         .top-bar__left-button {
            min-width: 85px;
            display: flex;
            align-items: center;
        }
		 .top-bar__left-group {
			display: flex;
			align-items: center;
			gap: var(--sp-3); /* Espacio entre el icono y el botón */
		}
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background-color: var(--c-surface); border-top: 1px solid var(--c-outline); display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 200; box-shadow: 0 -2px 15px rgba(0,0,0,0.2); height: 48px; }
        .bottom-nav__item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--sp-1) var(--sp-2); cursor: pointer; transition: color 0.2s; color: var(--c-on-surface-tertiary); border: none; background: none; }
        .bottom-nav__item--active { color: var(--c-primary); }
        .bottom-nav__item .material-icons { font-size: 22px; } 
        .bottom-nav__label { display: none; font-size: var(--fs-xs); margin-top: 2px; }

        .fab { position: fixed; bottom: calc(56px + env(safe-area-inset-bottom)); right: var(--sp-5); width: 56px; height: 56px; background-color: var(--c-primary); color: var(--c-white); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md); z-index: 50; transform: scale(0); opacity: 0; transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .fab--visible { transform: scale(1); opacity: 1; }
        .fab:hover { transform: scale(1.08) !important; box-shadow: 0 0 25px rgba(0, 122, 255, 0.5); } .fab .material-icons { font-size: 28px; }
        
                .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1050;
            opacity: 0;
            transition: opacity 0.3s ease-out; /* Animación de opacidad */
            pointer-events: none;
        }

        /* ESTA ES LA MAGIA NUEVA: Controla el fondo de la app */
        .app-layout.app-layout--transformed-by-modal {
            transform: scale(0.95) translateY(-10px); /* Encoge y sube un poco el fondo */
            border-radius: var(--border-radius-lg); /* Redondea las esquinas del fondo */
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .modal-overlay--active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Hacemos que el cambio de vuelta a la normalidad también sea suave */
        .app-layout {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-radius 0.4s;
        }
                .modal {
            background: var(--c-surface);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            padding: var(--sp-5);
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            border: 1px solid var(--c-outline);
            
            /* Animación de entrada de la ventana */
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-overlay--active .modal {
            transform: translateY(0); /* La ventana sube a su sitio */
        }
        
        .card__title { font-size: var(--fs-lg); font-weight: 700; margin-bottom: var(--sp-3); display: flex; align-items: center; gap: var(--sp-2); color: var(--c-primary); padding: var(--sp-4) var(--sp-4) 0 var(--sp-4); }
        .card__content { padding: 0 var(--sp-4) var(--sp-4) var(--sp-4); }
        .card__title .material-icons { font-size: var(--fs-lg); }
        .card--no-bg { background: none; border: none; box-shadow: none; padding: 0; border-radius: 0; }
        .chart-container { position: relative; height: 220px; width: 100%; margin-bottom: var(--sp-4); }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--sp-3); }
        
        .kpi-item { background: var(--c-surface); border: 1px solid var(--c-outline); border-radius: var(--border-radius-lg); padding: var(--sp-3); text-align: center; transition: background-color 0.3s, border-color 0.3s; }
        .kpi-item:hover { background-color: var(--c-surface-variant); border-color: var(--c-primary); }
        .kpi-item__label { font-size: var(--fs-xs); font-weight: 600; color: var(--c-on-surface-secondary); margin-bottom: var(--sp-1); text-transform: uppercase; }
        .kpi-item__value { font-size: var(--fs-base); font-weight: 800; }
        .kpi-item__comparison { font-size: var(--fs-xs); font-weight: 500; margin-top: var(--sp-1); height: 14px; }
        #movimientos-list-container { position: relative; padding: 0 var(--sp-4); }
        #virtual-list-sizer { position: relative; width: 100%; }
        #virtual-list-content { position: absolute; top: 0; left: 0; width: 100%; }

        .transaction-card { display: flex; align-items: flex-start; padding: var(--sp-2) 0; cursor: pointer; border-bottom: 1px solid var(--c-outline); line-height: 1.25; min-height: 0; transition: background-color 0.2s; }
        .transaction-card:hover { background-color: var(--c-surface-variant); }
        .transaction-card:last-child { border-bottom: none; }
        .transaction-card__indicator { flex-shrink: 0; width: 3px; align-self: stretch; border-radius: 99px; margin-right: var(--sp-2); }
        .transaction-card__indicator--income { background-color: var(--c-success); }
        .transaction-card__indicator--expense { background-color: var(--c-danger); }
        .transaction-card__indicator--transfer { background-color: var(--c-info); }
        .transaction-card__indicator--recurrent { background-color: var(--c-warning); }
        .transaction-card__content { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; min-width: 0; }
        .transaction-card__details { flex-grow: 1; min-width: 0; padding-right: var(--sp-2); }
        .transaction-card__row-1, .transaction-card__concept { font-size: var(--fs-sm); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__row-2, .transaction-card__description { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__figures { flex-shrink: 0; text-align: right; }
        .transaction-card__amount { font-size: var(--fs-sm); font-weight: 700; display: block; }
        
        .transaction-card__balance { font-size: 0.7rem; color: var(--c-on-surface-secondary); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        
        .transaction-card__transfer-details { display: flex; flex-direction: column; gap: 0; margin: 2px 0 0 0; }
        .transaction-card__transfer-row { display: flex; justify-content: space-between; align-items: center; color: var(--c-on-surface-secondary); font-size: 0.75rem; }
        .transaction-card__transfer-row .material-icons { font-size: 11px; vertical-align: middle; margin-right: var(--sp-1); }
        .transaction-card__transfer-row > span:first-child { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #movimiento-modal .modal__actions { margin-top: var(--sp-4); display: flex; justify-content: space-between; align-items: center; gap: var(--sp-2); width: 100%; }
        #movimiento-modal .modal__actions .left-actions,
        #movimiento-modal .modal__actions .right-actions { display: flex; gap: var(--sp-2); align-items: center; }

        .accordion { margin-bottom: 0; background-color: var(--c-surface); overflow: hidden; }
        .accordion-wrapper > .accordion:first-child { border-top-left-radius: var(--border-radius-lg); border-top-right-radius: var(--border-radius-lg); }
        .accordion-wrapper > .accordion:last-child { border-bottom-left-radius: var(--border-radius-lg); border-bottom-right-radius: var(--border-radius-lg); }
        .accordion-wrapper > .accordion:not(:last-child) { border-bottom: 1px solid var(--c-outline); border-radius: 0; }
        .accordion-wrapper > .accordion:not(:last-child) > summary { border-bottom: none; }
        .accordion[open] > summary { border-bottom: 1px solid var(--c-outline); }
        .accordion > summary { font-weight: 700; cursor: pointer; padding: var(--sp-3) var(--sp-4); display: flex; align-items: center; justify-content: space-between; list-style: none; font-size: var(--fs-base); }
        .accordion > summary::-webkit-details-marker { display: none; }
        .accordion > summary .accordion__icon { transition: transform 0.2s; color: var(--c-on-surface-secondary); }
        .accordion[open] > summary .accordion__icon { transform: rotate(180deg); }
        .accordion__content { padding: 0 var(--sp-4) var(--sp-4) var(--sp-4); }
        .card > .accordion { border-radius: 0; }
        .account-group { background: var(--c-surface); border-radius: var(--border-radius-lg); margin-bottom: var(--sp-3); overflow: hidden; }
        .account-group__header { display: flex; justify-content: space-between; align-items: center; padding: var(--sp-2) var(--sp-4); border-bottom: 1px solid var(--c-outline); }
        .account-group__name { font-size: var(--fs-base); font-weight: 700; }
        .account-group__balance { font-size: var(--fs-sm); font-weight: 600; }
        .account-group .modal__list-item { padding: var(--sp-2) var(--sp-4); }
        .form-group { margin-bottom: var(--sp-3); position: relative; }
        .form-label { display: block; font-size: var(--fs-sm); font-weight: 600; margin-bottom: var(--sp-2); color: var(--c-on-surface-secondary); }
        .form-input, .form-select { width: 100%; padding: var(--sp-3); border: 1px solid var(--c-outline); border-radius: var(--border-radius-md); background: var(--c-surface-variant); color: var(--c-on-surface); font-size: var(--fs-base); appearance: none; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--c-primary); background-color: var(--c-surface); box-shadow: var(--shadow-md); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23FFFFFF' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 12px center; background-size: 14px; padding-right: 36px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr; gap: var(--sp-3); }
        
        .form-group-addon {
    display: flex;
    align-items: center; /* ¡Cambiado de 'flex-end' a 'center'! */
    gap: var(--sp-2);
}
        .form-group-addon .form-group { flex-grow: 1; margin-bottom: 0; }
        .form-error { color: var(--c-danger); font-size: var(--fs-xs); margin-top: var(--sp-1); min-height: 14px; display: block; font-weight: 600; }
        .form-input--invalid { border-color: var(--c-danger) !important; box-shadow: var(--glow-red) !important; }
        .form-checkbox-group { display: flex; align-items: center; gap: var(--sp-2); margin-bottom: var(--sp-2); }
        .form-checkbox-group label { margin-bottom: 0; font-weight: normal; }
        .form-checkbox-group input[type="radio"], .form-checkbox-group input[type="checkbox"] { accent-color: var(--c-primary); }
        .form-switch-group { display: flex; align-items: center; justify-content: space-between; }
        .form-switch { position: relative; display: inline-block; width: 44px; height: 26px; }
        .form-switch input { opacity: 0; width: 0; height: 0; }
        .form-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--c-surface-variant); transition: .4s; border-radius: 34px; border: 1px solid var(--c-outline); }
        .form-switch .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        .form-switch input:checked + .slider { background-color: var(--c-success); border-color: var(--c-success); }
        .form-switch input:checked + .slider:before { transform: translateX(18px); }
        .btn { padding: var(--sp-3) var(--sp-4); border: 1px solid transparent; border-radius: var(--border-radius-md); font-size: var(--fs-sm); font-weight: 700; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: var(--sp-2); -webkit-user-select: none; user-select: none; }
        .btn:active { transform: scale(0.97); }
        .btn--primary { background-color: var(--c-primary); color: var(--c-white); border-color: var(--c-primary); } .btn--primary:hover { background-color: var(--c-primary-hover); border-color: var(--c-primary-hover); box-shadow: var(--shadow-md); }
        .btn--secondary { background-color: var(--c-surface-variant); color: var(--c-on-surface); border: 1px solid var(--c-outline); } .btn--secondary:hover { background-color: var(--c-outline); border-color: var(--c-on-surface-tertiary); }
        .btn--danger { background-color: var(--c-danger); color: var(--c-white); } .btn--danger:hover { box-shadow: var(--glow-red); }
        .btn--full { width: 100%; } .btn--loading { pointer-events: none; opacity: .8; }
        .icon-btn { background: none; border: none; color: var(--c-on-surface-secondary); cursor: pointer; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s, transform 0.2s; }
        .icon-btn .material-icons { font-size: 20px; }
        .icon-btn:hover { background-color: var(--c-surface-variant); color: var(--c-primary); }
        .icon-btn:active { transform: scale(0.9); }
        .modal__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--sp-3); flex-shrink: 0;}
        .modal__title { font-size: var(--fs-xl); font-weight: 800; }
        .modal__body { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; padding-right: var(--sp-2); margin-right: calc(-1 * var(--sp-2)); }
        .modal__list-item { display:flex; justify-content:space-between; align-items:center; padding: var(--sp-3) 0; border-bottom:1px solid var(--c-outline); gap: var(--sp-2); }
        .modal__list-item:last-child { border-bottom: none; }
        .modal__actions { margin-top: var(--sp-4); display: flex; justify-content: flex-end; gap: var(--sp-2); width: 100%;}
        #generic-modal-body h3, #generic-modal-body h4 { margin-top: 1.2em; margin-bottom: 0.6em; color: var(--c-primary); font-weight: 700; } 
        #generic-modal-body h4 { font-size: var(--fs-base); } 
        #generic-modal-body p, #generic-modal-body li, #generic-modal-body small { color: var(--c-on-surface-secondary); line-height: 1.5; } 
        #generic-modal-body ul, #generic-modal-body ol { list-style-position: inside; padding-left: var(--sp-2); } 
        #generic-modal-body ul li, #generic-modal-body ol li { margin-bottom: 6px; }
        #generic-modal-body ul ul { margin-top: 6px; }
        #generic-modal-body a { color: var(--c-primary); text-decoration: none; font-weight: 600; }
        #generic-modal-body a:hover { text-decoration: underline; }
        .login-view { position: fixed; inset: 0; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: var(--sp-4); opacity: 0; transition: opacity .5s; background-color: var(--c-background); }
        .login-view--visible { display: flex; opacity: 1; }
        .login-view__card { background-color: var(--c-surface); padding: var(--sp-5); border-radius: var(--border-radius-lg); box-shadow: 0 0 30px rgba(0,0,0,0.5); width: 100%; max-width: 340px; text-align: center; animation: pop-in 0.3s ease-out; border: 1px solid var(--c-outline); }
        .login-view__title { margin-bottom: var(--sp-4); font-size: var(--fs-xl); font-weight: 800; }
        .empty-state { text-align: center; padding: var(--sp-5) 0; color: var(--c-on-surface-secondary); animation: fade-in 0.3s; background: var(--c-surface); border-radius: var(--border-radius-lg); border: 1px solid var(--c-outline); }
        .empty-state .material-icons { font-size: 40px; margin-bottom: var(--sp-2); color: var(--c-primary); }
        .empty-state h3 { font-size: var(--fs-lg); font-weight: 700; color: var(--c-on-surface); margin-bottom: var(--sp-2); }
        .filter-pills { display: flex; flex-wrap: wrap; gap: var(--sp-2); margin-bottom: var(--sp-4); }
        .filter-pill { padding: var(--sp-1) var(--sp-3); border: 1px solid var(--c-outline); border-radius: 99px; font-size: var(--fs-xs); font-weight: 600; background-color: var(--c-surface-variant); color: var(--c-on-surface); cursor: pointer; transition: all 0.2s; }
        .filter-pill:hover { opacity: 0.8; border-color: var(--c-primary); }
        .filter-pill--active { background-color: var(--c-primary); color: var(--c-white); font-weight: 700; border-color: var(--c-primary); }
        
        .toast-container { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: var(--sp-2); pointer-events: none;}
        .toast { background-color: var(--c-surface); color: var(--c-white); padding: var(--sp-2) var(--sp-4); border-radius: var(--border-radius-md); box-shadow: 0 0 20px rgba(0,0,0,0.5); pointer-events: all; border: 1px solid var(--c-outline); }
        .toast--danger { background-color: var(--c-danger); border-color: var(--c-danger); }
        .toast--warning { background-color: var(--c-warning); border-color: var(--c-warning); color: var(--c-black); }
        .toast--info { background-color: var(--c-info); border-color: var(--c-info); }
        .text-positive { color: var(--c-success); } .text-negative { color: var(--c-danger); } .text-warning { color: var(--c-warning); } .text-info { color: var(--c-info); }
        .hidden { display: none !important; }
        .spinner { display: inline-block; width: 1em; height: 1em; border: .15em solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin .8s linear infinite; vertical-align: middle; }
        @keyframes spin { to { transform:rotate(360deg); } }
        #description-suggestions { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: var(--c-surface); border-radius: var(--border-radius-md); box-shadow: 0 10px 20px rgba(0,0,0,0.4); z-index: 1060; max-height: 150px; overflow-y: auto; border: 1px solid var(--c-outline); }
        .suggestion-item { padding: var(--sp-2) var(--sp-3); cursor: pointer; font-size: var(--fs-sm); }
        .suggestion-item:hover { background-color: var(--c-surface-variant); }
        .suggestion-item small { color: var(--c-on-surface-secondary); font-size: var(--fs-xs); }
        .budget-track-item { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: var(--sp-3); padding: var(--sp-2) 0; border-bottom: 1px solid var(--c-outline); }
        .budget-track-item:last-child { border-bottom: none; }
        .budget-track-item__main { display: flex; flex-direction: column; gap: var(--sp-1); min-width: 0; }
        .budget-track-item__concept-name { font-weight: 700; font-size: var(--fs-sm); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .budget-track-item__figures { display: flex; flex-direction: column; align-items: flex-end; text-align: right; font-size: var(--fs-xs); }
        .budget-track-item__amount { color: var(--c-on-surface-secondary); }
        .budget-track-item__amount strong { color: var(--c-on-surface); font-weight: 600;}
        .budget-track-item__difference { font-weight: 700; }
        .budget-item__progress { width: 100%; -webkit-appearance: none; appearance: none; height: 6px; border-radius: 99px; overflow: hidden; background-color: var(--c-surface-variant); }
        .budget-item__progress::-webkit-progress-bar { background-color: var(--c-surface-variant); }
        .budget-item__progress::-webkit-progress-value { background-color: var(--c-primary); transition: width 0.3s ease; }
        .budget-item__progress.budget-item__progress--danger::-webkit-progress-value { background-color: var(--c-danger); }
        .budget-item__progress.budget-item__progress--warning::-webkit-progress-value { background-color: var(--c-warning); }
        .investment-asset-card { background-color: var(--c-surface); border: 1px solid var(--c-outline); border-radius: var(--border-radius-lg); padding: var(--sp-3); margin-bottom: var(--sp-2); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; }
        .investment-asset-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--c-primary); }
        .investment-asset-card__header { display: grid; grid-template-columns: 1fr auto; align-items: flex-start; gap: var(--sp-2); }
        .investment-asset-card__name { font-size: var(--fs-base); font-weight: 700; }
        .investment-asset-card__value { font-size: var(--fs-lg); font-weight: 800; text-align: right; }
        .investment-asset-card__pnl { font-size: var(--fs-xs); font-weight: 600; text-align: right; }
        .investment-timeline-item { display: flex; align-items: center; gap: var(--sp-3); padding: var(--sp-2) 0; border-bottom: 1px solid var(--c-outline); }
        .investment-timeline-item:last-child { border-bottom: none; }
        .investment-timeline-item__icon { flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: var(--c-surface-variant); border-radius: 50%; }
        .investment-timeline-item__icon .material-icons { font-size: 18px; }
        .investment-timeline-item__details { flex-grow: 1; }
        .investment-timeline-item__description { font-weight: 600; font-size: var(--fs-sm); }
        .investment-timeline-item__date { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); }
        .investment-timeline-item__amount { font-weight: 700; font-size: var(--fs-sm); }
        #exit-screen { display: none; opacity: 0; position: fixed; inset: 0; background-color: var(--c-background); color: var(--c-on-surface); flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-size: 1.5rem; text-align: center; transition: opacity 0.5s ease; }
/* ================================================================= */
/* === INICIO: NUEVOS ESTILOS PARA LA CALCULADORA INTEGRADA === */
/* ================================================================= */
.calculator-ui {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1100; /* Por encima del modal del formulario */
    
    width: 100%;
    max-width: 440px; 
    margin: 0 auto;
    
    background-color: var(--c-surface-variant);
    color: var(--c-on-surface);
    border-top-left-radius: var(--border-radius-lg);
    border-top-right-radius: var(--border-radius-lg);
    padding: var(--sp-3) var(--sp-3) env(safe-area-inset-bottom) var(--sp-3);
    box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
    border-top: 1px solid var(--c-outline);
    
    transform: translateY(100%); /* Comienza oculta abajo */
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* Añadimos esto para que no se pueda interactuar cuando está oculta */
    pointer-events: none; 
}

/* Esta clase hará que la calculadora se deslice y aparezca */
.calculator-ui--visible {
    transform: translateY(0);
    pointer-events: auto; /* Permitimos la interacción cuando es visible */
}

/* El resto de los estilos de la calculadora permanecen igual */
.calculator-display {
    font-size: 2.5rem; 
    font-weight: 300;
    text-align: right;
    padding: var(--sp-2) var(--sp-3);
    margin-bottom: var(--sp-3); 
    min-height: 55px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.calculator-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
}

.calculator-btn {
    font-family: var(--font-family);
    font-size: 1.5rem;
    font-weight: 400;
    aspect-ratio: 1 / 1; 
    border-radius: 50%;
    border: none;
    background-color: var(--c-surface);
    color: var(--c-on-surface);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, transform 0.1s;
}

.calculator-btn:active {
    transform: scale(0.95);
}

.calculator-btn.btn-operator {
    background-color: var(--c-surface-variant);
    color: var(--c-on-surface);
    font-weight: 500;
}

.calculator-btn.btn-confirm {
    background-color: var(--c-primary);
    color: var(--c-white);
    font-weight: 500;
}

.calculator-btn.zero {
    grid-column: span 2;
    aspect-ratio: auto; 
    border-radius: 99px;
}

.material-icons.backspace-icon {
    font-size: 1.5rem;
}
        /*
 * === ESTILOS PARA EL BOTÓN DE CAMBIO DE CONTABILIDAD (A/B) ===
 * Hacemos que el botón adopte el color del tema principal según el modo de contabilidad.
 */
        body[data-ledger-mode="A"] #ledger-toggle-btn {
            background-color: var(--c-primary);
            border-color: var(--c-primary);
            color: var(--c-white);
            box-shadow: var(--shadow-sm); /* Un toque de sombra para que destaque */
        }

        body[data-ledger-mode="A"] #ledger-toggle-btn:hover {
            background-color: var(--c-primary-hover);
            border-color: var(--c-primary-hover);
            box-shadow: var(--shadow-md);
        }

        body[data-ledger-mode="B"] #ledger-toggle-btn {
            background-color: var(--c-danger);
            border-color: var(--c-danger);
            color: var(--c-white);
            box-shadow: var(--shadow-sm); /* Un toque de sombra para que destaque */
        }

        body[data-ledger-mode="B"] #ledger-toggle-btn:hover {
            /* Puedes ajustar este color para un hover del rojo si lo deseas, por ejemplo, un rojo un poco más oscuro */
            background-color: color-mix(in srgb, var(--c-danger) 85%, black); 
            border-color: color-mix(in srgb, var(--c-danger) 85%, black);
            box-shadow: var(--glow-red); /* Utiliza el glow-red para mantener la consistencia */
        }
        body[data-ledger-mode="A"] .top-bar { background-color: #002D5B; } /* Azul oscuro */
        body[data-ledger-mode="A"] .top-bar, body[data-ledger-mode="A"] .top-bar .btn { color: var(--c-white); }
        body[data-ledger-mode="B"] .top-bar { background-color: #5B0000; } /* Rojo oscuro */
        body[data-ledger-mode="B"] .top-bar, body[data-ledger-mode="B"] .top-bar .btn { color: var(--c-white); }
        body[data-ledger-mode="B"] .bottom-nav__item--active { color: var(--c-danger); }
        #ledger-toggle-btn { font-weight: 700; padding: 6px 10px; font-size: 0.8rem; min-width: 40px; text-align: center; }

        #global-search-modal .modal { max-width: 600px; height: 70vh; border-radius: var(--border-radius-lg); }
        #global-search-modal .modal__body { padding: 0; margin-right: 0; }
        #global-search-input-wrapper { padding: 0 var(--sp-4) var(--sp-3) var(--sp-4); border-bottom: 1px solid var(--c-outline); display: flex; align-items: center; gap: var(--sp-3); }
        #global-search-input { width: 100%; font-size: var(--fs-lg); border: none; background: transparent; color: var(--c-on-surface); padding: var(--sp-2) 0; }
        #global-search-input:focus { outline: none; }
        #global-search-results { padding: var(--sp-2) 0; }
        .search-result-group__title { font-size: var(--fs-xs); font-weight: 700; text-transform: uppercase; color: var(--c-on-surface-secondary); padding: var(--sp-2) var(--sp-4); background-color: var(--c-surface-variant); }
        .search-result-item { display: flex; align-items: center; gap: var(--sp-3); padding: var(--sp-2) var(--sp-4); cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .search-result-item:hover { background-color: var(--c-surface-variant); }
        .search-result-item__icon { color: var(--c-on-surface-secondary); }
        .search-result-item__details p { font-size: var(--fs-sm); font-weight: 600; color: var(--c-on-surface); }
        .search-result-item__details small { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); }
        .inline-edit-form { width: 100%; display: flex; flex-direction: column; gap: var(--sp-2); padding: var(--sp-2) 0; }
        .inline-edit-form .form-input { padding: var(--sp-2); }
        .inline-edit-form .form-label { font-size: var(--fs-xs); margin-bottom: 4px; }
        
        .widget-config-item { display: flex; align-items: center; gap: var(--sp-3); background-color: var(--c-surface-variant); padding: var(--sp-2) var(--sp-3); border-radius: var(--border-radius-md); margin-bottom: var(--sp-2); }
        .widget-config-item.dragging { opacity: 0.5; background: var(--c-primary); }
        .widget-config-item .drag-handle { cursor: grab; color: var(--c-on-surface-secondary); }
        .widget-config-item .drag-handle:active { cursor: grabbing; }
        .widget-config-item__details { flex-grow: 1; }
        .widget-config-item__title { font-weight: 700; font-size: var(--fs-sm); }
        .widget-config-item__desc { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); }

                
        #list-loader { text-align: center; padding: var(--sp-4); color: var(--c-on-surface-secondary); }
        
        /* === ESTILOS PARA EL NUEVO ASISTENTE DE IMPORTACIÓN JSON === */
        .json-wizard-step { display: flex; flex-direction: column; height: 100%; }
        #json-drop-zone {
            border: 2px dashed var(--c-outline);
            border-radius: var(--border-radius-lg);
            padding: var(--sp-6);
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #json-drop-zone.drag-over {
            border-color: var(--c-primary);
            background-color: color-mix(in srgb, var(--c-primary) 10%, transparent);
        }
        #json-preview-list { list-style: none; padding-left: 0; }
        #json-preview-list li {
            background-color: var(--c-surface-variant);
            padding: var(--sp-3);
            border-radius: var(--border-radius-md);
            margin-bottom: var(--sp-2);
            display: flex;
            align-items: center;
            gap: var(--sp-3);
        }
        #json-preview-list .material-icons { color: var(--c-success); }

        .movimiento-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background-color: #2c3e50; /* Un azul-gris oscuro y neutro */
            color: var(--c-on-surface);
            font-weight: 700;
            font-size: var(--fs-sm);
            border-radius: 99px; /* Forma de píldora */
            margin-top: var(--sp-4);
            margin-bottom: var(--sp-2);
        }
		/* ================================================================= */
/* === INICIO: MEJORAS PARA EL FORMULARIO DE MOVIMIENTOS === */
/* ================================================================= */

/* 1. Reducir el espaciado vertical dentro del modal de movimientos */
#movimiento-modal .form-group {
    margin-bottom: var(--sp-2);
}

/* 2. Estilo para el "agarrador" visual del modal */
.modal__grabber {
    width: 40px;
    height: 5px;
    background-color: var(--c-outline);
    border-radius: 99px;
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
}

/* 3. Estilo para el nuevo botón de fecha */
#movimiento-fecha-display {
    justify-content: space-between;
    font-weight: 500;
    padding-top: var(--sp-3);
    padding-bottom: var(--sp-3);
}

#movimiento-fecha-display .material-icons {
    color: var(--c-on-surface-tertiary);
    font-size: 18px;
}

/* 4. Clase para ocultar visualmente el input de fecha real */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}
/* ================================================================= */
/* === FIN: MEJORAS PARA EL FORMULARIO DE MOVIMIENTOS === */
/* ================================================================= */
        @media (min-width: 768px) {
            .app-layout { max-width: 95%; }
            .top-bar, .bottom-nav { max-width: 100%; }
            .modal-overlay { align-items: center; }
			.calculator-overlay {
				align-items: flex-end !important; }
            .modal { border-radius: var(--border-radius-lg); transform: translateY(0) scale(0.95); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s; }
            .modal-overlay--active .modal { transform: translateY(0) scale(1); }
            .view { padding: 0 var(--sp-5); }
            .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--sp-4); }
            .form-grid { grid-template-columns: 1fr 1fr; }
        }

        @media (min-width: 1024px) {
            body { overflow-y: auto; }
            .app-layout { flex-direction: row; max-width: 100%; height: 100vh; }
            .bottom-nav { position: fixed; flex-direction: column; width: 240px; height: 100vh; left: 0; top: 0; transform: none; border-top: none; border-right: 1px solid var(--c-outline); padding: var(--sp-5) var(--sp-3); justify-content: flex-start; gap: var(--sp-2); box-shadow: none; background-color: var(--c-background); }
            .bottom-nav__item { flex: 0 0 auto; flex-direction: row; justify-content: flex-start; width: 100%; height: auto; padding: var(--sp-2) var(--sp-3); border-radius: var(--border-radius-md); }
            .bottom-nav__item:hover { background-color: var(--c-surface-variant); }
            body[data-ledger-mode="A"] .bottom-nav__item--active { background-color: var(--c-primary); color: var(--c-white); }
            body[data-ledger-mode="B"] .bottom-nav__item--active { background-color: var(--c-danger); color: var(--c-white); }
            body[data-ledger-mode="A"] .bottom-nav__item--active:hover { background-color: var(--c-primary-hover); }
            body[data-ledger-mode="B"] .bottom-nav__item--active:hover { background-color: color-mix(in srgb, var(--c-danger) 80%, white); }
            .bottom-nav__item .material-icons { margin-right: var(--sp-3); font-size: 20px; }
            .bottom-nav__label { display: inline-block; font-size: var(--fs-sm); font-weight: 600; margin-top: 0; }
            .app-layout__main { margin-left: 240px; width: calc(100% - 240px); height: 100vh; padding: 60px var(--sp-6) var(--sp-6) var(--sp-6); }
            .view { max-width: 1100px; margin: 0 auto; padding: 0; }
            .top-bar { max-width: none; width: calc(100% - 240px); left: auto; right: 0; transform: none; padding-left: var(--sp-6); padding-right: var(--sp-6); }
            .toast-container { bottom: var(--sp-4); left: auto; right: calc(240px / 2); transform: translateX(50%); }
        }
		.movements-modal-container {
    max-height: 60vh;
    overflow-y: auto;
}

/* ================================================================= */
/* === INICIO: NUEVO TEMA "iOS PRO DARK" === */
/* ================================================================= */
body[data-theme="crystal"] {
    /* COLORES: Inspirados en la paleta profesional Dark Mode de Apple */
    --c-primary: #0A84FF;      /* Azul Vibrante de iOS */
    --c-primary-hover: #3398FF;
    --c-danger: #FF453A;       /* Rojo Vibrante de iOS */
    --c-success: #30D158;      /* Verde Vibrante de iOS */
    --c-warning: #FFD60A;      /* Amarillo Vibrante de iOS */
    --c-info: #5E5CE6;         /* Índigo de iOS */
    
    /* FONDO: Un gris casi negro, profundo pero no puro para evitar fatiga visual */
    --c-background: #161618;
    
    /* SUPERFICIES: Grises oscuros para crear capas y profundidad */
    --c-surface: #212123;
    --c-surface-variant: #303032;
    --c-outline: rgba(84, 84, 88, 0.65); /* Color de los separadores de iOS */

    /* TEXTOS: Blancos rotos y grises para una jerarquía clara y legible */
    --c-on-surface: #F2F2F7;
    --c-on-surface-secondary: #AEAEB2;
    --c-on-surface-tertiary: #8A8A8E;
    --c-on-surface-disabled: #545456;
    
    /* SOMBRAS: Extremadamente sutiles, casi imperceptibles, para sugerir elevación */
    --shadow-sm: 0px 2px 4px rgba(0, 0, 0, 0.2);
    --shadow-md: 0px 8px 16px rgba(0, 0, 0, 0.25);
    --glow-red: 0 0 20px rgba(255, 69, 58, 0.4);
}

/* --- Ajustes Específicos para iOS Pro Dark --- */

body[data-theme="crystal"] {
    background-image: none; /* Fondo sin efectos, solo el color base para un look limpio */
}

body[data-theme="crystal"] .top-bar,
body[data-theme="crystal"] .bottom-nav,
body[data-theme="crystal"] .modal {
    background-color: var(--c-surface-variant);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border-color: var(--c-outline);
}

body[data-theme="crystal"] .card,
body[data-theme="crystal"] .kpi-item,
body[data-theme="crystal"] .accordion,
body[data-theme="crystal"] .login-view__card,
body[data-theme="crystal"] .empty-state {
    background-color: var(--c-surface);
    border: 1px solid var(--c-outline);
    box-shadow: none; /* Las sombras se usan con más moderación en este estilo */
    transition: transform 0.2s, background-color 0.2s;
}

body[data-theme="crystal"] .kpi-item:hover,
body[data-theme="crystal"] .investment-asset-card:hover {
    transform: translateY(-2px);
    background-color: var(--c-surface-variant);
}

body[data-theme="crystal"] .form-input,
body[data-theme="crystal"] .form-select {
    background-color: var(--c-background);
    border: 1px solid var(--c-outline);
}

body[data-theme="crystal"] .form-input:focus,
body[data-theme="crystal"] .form-select:focus {
    background-color: var(--c-background);
    border-color: var(--c-primary);
    box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3); /* Anillo de foco estilo iOS */
}

body[data-theme="crystal"] .form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23F2F2F7' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
}

body[data-theme="crystal"] .starry-background {
    opacity: 0.5; /* Mantenemos el fondo estrellado pero más sutil */
}

body[data-theme="crystal"] .calculator-ui { background-color: #2c2c2e; border-color: #444; }
body[data-theme="crystal"] .calculator-display { color: var(--c-on-surface); }
body[data-theme="crystal"] .calculator-btn { background-color: #505054; color: var(--c-on-surface); }
body[data-theme="crystal"] .calculator-btn:hover { background-color: #6a6a6e; }
body[data-theme="crystal"] .calculator-btn.btn-operator { background-color: #3b3b3d; color: var(--c-primary); font-weight: 700; }
body[data-theme="crystal"] .calculator-btn.btn-operator:hover { background-color: #505054; }
body[data-theme="crystal"] .calculator-btn.btn-confirm { background-color: var(--c-primary); color: var(--c-white); }
body[data-theme="crystal"] .calculator-btn.btn-confirm:hover { background-color: var(--c-primary-hover); }

body[data-theme="crystal"] .fab { box-shadow: var(--shadow-md); }
body[data-theme="crystal"] .fab:hover { box-shadow: 0 8px 25px rgba(10, 132, 255, 0.3); }
/* ================================================================= */
/* === FIN: NUEVO TEMA "iOS PRO DARK" === */
/* ================================================================= */
<!-- INICIO BLOQUE CSV -->
/* === ESTILOS PARA EL CONVERSOR CSV A JSON === */
.csv-converter-modal .upload-area {
    border: 2px dashed var(--c-outline);
    border-radius: var(--border-radius-lg);
    padding: 2.5rem;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.3s, background-color 0.3s;
    margin-bottom: 1.5rem;
}
.csv-converter-modal .upload-area.drag-over {
    border-color: var(--c-primary);
    background-color: color-mix(in srgb, var(--c-primary) 10%, transparent);
}
.csv-converter-modal .upload-area p {
    margin: 0;
    color: var(--c-on-surface-tertiary);
}
.csv-converter-modal .upload-area strong {
    color: var(--c-primary);
}
.csv-converter-modal #file-name {
    font-weight: 600;
    color: var(--c-success);
    margin-top: 1rem;
    display: block;
    min-height: 24px;
}
.csv-converter-modal .results-log {
    margin-top: 2rem;
    background-color: var(--c-surface-variant);
    border: 1px solid var(--c-outline);
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
    display: none;
}
.csv-converter-modal .results-log h2 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: var(--c-on-surface-secondary);
}
.csv-converter-modal .results-log ul {
    list-style: none;
    padding: 0;
}
.csv-converter-modal .results-log li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--c-outline);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.csv-converter-modal .results-log li:last-child {
    border-bottom: none;
}
.csv-converter-modal .results-log li .label {
    color: var(--c-on-surface-tertiary);
}
.csv-converter-modal .results-log li .value {
    font-weight: 700;
    color: var(--c-on-surface);
    padding: 0.1rem 0.5rem;
    border-radius: 6px;
}
.csv-converter-modal .results-log .value.success { background-color: color-mix(in srgb, var(--c-success) 20%, transparent); }
.csv-converter-modal .results-log .value.warning { background-color: color-mix(in srgb, var(--c-warning) 20%, transparent); }
.csv-converter-modal .results-log .value.danger { background-color: color-mix(in srgb, var(--c-danger) 20%, transparent); }
.csv-converter-modal #download-container {
    margin-top: 1.5rem;
    display: none;
}
<!-- FIN BLOQUE CSV -->
/* === ESTILOS PARA EL INDICADOR DE SINCRONIZACIÓN === */
#sync-status-icon {
    /* No debe tener márgenes aquí */
    font-size: 20px;
    transition: color 0.3s ease-in-out, transform 0.3s ease;
}

.sync-status--synced {
    color: var(--c-success);
    transform: scale(1.1);
}

.sync-status--syncing .sync-icon-spinner {
    animation: spin 1.2s linear infinite;
}

.sync-status--error {
    color: var(--c-danger);
}

 /* ================================================================= */
/* === ESTILOS PARA LA PANTALLA DE LOGIN PROFESIONAL === */
/* ================================================================= */
.login-view {
    /* Ya tienes la mayoría de estilos, solo nos aseguramos de que el fondo estrellado se muestre */
    background-color: transparent; 
}
.login-view .starry-background {
    opacity: 0.7; /* Hacemos las estrellas un poco más sutiles */
}

.login-view__card {
    padding: var(--sp-6) var(--sp-5); /* Más espacio interior */
    max-width: 380px; /* Un poco más ancha */
    z-index: 10; /* Para que esté por encima del fondo estrellado */
    text-align: center;
}

.login-view__logo {
    max-width: 90px;
    height: auto;
    border-radius: 18px;
    margin-bottom: var(--sp-4);
    box-shadow: 0 0 25px rgba(255, 255, 255, 0.1);
}

.login-view__title {
    margin-bottom: var(--sp-1);
    font-size: var(--fs-xl);
    font-weight: 800;
}

.login-view__tagline {
    font-size: var(--fs-base);
    color: var(--c-on-surface-secondary);
    margin-bottom: var(--sp-5);
}

/* Estilos para los inputs con iconos */
.form-group--with-icon {
    position: relative;
}

.form-group--with-icon .material-icons {
    position: absolute;
    left: var(--sp-3);
    top: 50%;
    transform: translateY(-50%);
    color: var(--c-on-surface-tertiary);
    pointer-events: none; /* Para que se pueda hacer clic en el input */
    transition: color 0.2s;
}

.form-group--with-icon .form-input {
    padding-left: calc(var(--sp-3) * 2 + 24px); /* Espacio para el icono */
}

/* Efecto de foco en el icono */
.form-group--with-icon .form-input:focus + .material-icons,
.form-group--with-icon .form-input:focus ~ .material-icons {
    color: var(--c-primary);
}

.login-view__actions {
    display: flex;
    justify-content: flex-end;
    margin-bottom: var(--sp-4);
}

.login-view__link {
    font-size: var(--fs-sm);
    color: var(--c-primary);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s;
}
.login-view__link:hover {
    color: var(--c-primary-hover);
    text-decoration: underline;
}

.login-view__footer {
    margin-top: var(--sp-4);
    width: 100%;
}

.login-view__secondary-action {
    margin-top: var(--sp-4);
    font-size: var(--fs-sm);
    color: var(--c-on-surface-secondary);
}

/* Ocultamos el grid de botones original porque ya no lo usamos en este formulario */
#login-form .form-grid {
    display: none;
}

 /* ================================================================= */
/* === ESTILOS PARA EL ENCABEZADO CONDENSADO DE PATRIMONIO === */
/* ================================================================= */

/* Por defecto (móvil), los elementos se apilan uno sobre otro */
.patrimonio-header-grid {
    display: flex;
    flex-direction: column; /* Apilado vertical en móvil */
    gap: var(--sp-4);
    background-color: var(--c-surface);
    border: 1px solid var(--c-outline);
    border-radius: var(--border-radius-lg);
    padding: var(--sp-4);
    margin-bottom: var(--sp-4);
}

.patrimonio-header-grid__filters .kpi-item__label {
    margin-bottom: var(--sp-3);
    font-weight: 600;
}

/* Cuando la pantalla es suficientemente ancha (desktop) */
@media (min-width: 768px) {
    .patrimonio-header-grid {
        flex-direction: row; /* Se ponen en fila */
        align-items: flex-start; /* Alinea los items al principio */
    }

    .patrimonio-header-grid__kpi {
        flex: 1; /* Ocupa 1 parte del espacio */
        min-width: 220px; /* Ancho mínimo para que no se aplaste */
    }

    .patrimonio-header-grid__filters {
        flex: 3; /* Ocupa 3 partes del espacio, dándole más sitio a los filtros */
        padding-left: var(--sp-4);
        border-left: 1px solid var(--c-outline);
    }
}
 
/* ================================================================= */
/* === INICIO: MEJORAS PARA EL FORMULARIO DE MOVIMIENTOS === */
/* ================================================================= */

/* 1. Reducir el espaciado vertical dentro del modal de movimientos */
#movimiento-modal .form-group {
    margin-bottom: var(--sp-2);
}

/* 2. Estilo para el "agarrador" visual del modal */
.modal__grabber {
    width: 40px;
    height: 5px;
    background-color: var(--c-outline);
    border-radius: 99px;
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
}

/* 3. Estilo para el nuevo botón de fecha */
#movimiento-fecha-display {
    justify-content: space-between;
    font-weight: 500;
    padding-top: var(--sp-3);
    padding-bottom: var(--sp-3);
}

#movimiento-fecha-display .material-icons {
    color: var(--c-on-surface-tertiary);
    font-size: 18px;
}

/* 4. Clase para ocultar visualmente el input de fecha real */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}
/* ================================================================= */
/* === FIN: MEJORAS PARA EL FORMULARIO DE MOVIMIENTOS === */
/* ================================================================= */
/* ===== INICIO: NUEVOS ESTILOS PARA EL LOGIN CON PIN ===== */
.pin-inputs {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin: 2rem 0;
}

.pin-input {
    width: 50px;
    height: 60px;
    font-size: 2rem;
    text-align: center;
    border: 2px solid var(--c-outline);
    border-radius: var(--border-radius-md);
    background-color: var(--c-surface-variant);
    color: var(--c-on-surface);
    caret-color: var(--c-primary);
    transition: border-color 0.2s, box-shadow 0.2s;
}

.pin-input:focus {
    outline: none;
    border-color: var(--c-primary);
    box-shadow: var(--shadow-md);
}

/* Oculta los spinners en los inputs de tipo número */
.pin-input::-webkit-outer-spin-button,
.pin-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.pin-input[type=number] {
  -moz-appearance: textfield;
}
/* ===== FIN: NUEVOS ESTILOS PARA EL LOGIN CON PIN ===== */
    </style>
</head>
<body data-ledger-mode="A">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    
    <div id="introScreen" class="intro-screen">
        <div class="starry-background"></div>
        <img id="splashImage" class="intro-screen__logo" src="aiDANaI.webp" alt="Logo App" />
        <div id="quoteContainer" class="intro-screen__quote-container">
            <p id="quoteText" class="intro-screen__quote-text"></p>
            <span id="quoteAuthor" class="intro-screen__quote-author"></span>
        </div>
    </div>
	 <!-- ================================================================================= -->
<!-- INICIO: PANTALLA DE LOGIN PROFESIONALIZADA -->
<!-- ================================================================================= -->
<div id="login-screen" class="login-view">
    <div class="starry-background"></div> <!-- Reutilizamos el fondo estrellado -->
    <div class="login-view__card">
        <!-- 1. Logo para reforzar la marca -->
        <img src="aiDANaI.webp" alt="Logo Cuentas aiDANaI" class="login-view__logo">
        
        <!-- 2. Título y eslogan más acogedores -->
        <h2 id="login-title" class="login-view__title" data-i18n="login_welcome">Bienvenido de nuevo</h2>
        <p class="login-view__tagline" data-i18n="login_tagline">Inicia sesión para controlar tus finanzas.</p>

        <form id="login-form" noValidate>
            <!-- 3. Inputs con iconos para una UI moderna -->
            <div class="form-group form-group--with-icon">
                <span class="material-icons">alternate_email</span>
                <input type="email" id="login-email" class="form-input" data-i18n-placeholder="login_email_placeholder" placeholder="Correo electrónico" required autoComplete="email" autoCapitalize="none" />
                <span class="form-error" id="login-email-error"></span>
            </div>
            <div class="form-group form-group--with-icon">
                <span class="material-icons">lock</span>
                <input type="password" id="login-password" class="form-input" data-i18n-placeholder="login_password_placeholder" placeholder="Contraseña" required autoComplete="current-password" />
                <span class="form-error" id="login-password-error"></span>
            </div>

            <!-- 4. Enlace para recuperar contraseña -->
            <div class="login-view__actions">
                <a href="#" class="login-view__link" data-action="forgot-password" data-i18n="login_forgot_password">¿Olvidaste tu contraseña?</a>
            </div>

            <p id="login-error" class="form-error" style="min-height: 16px; margin-top: 8px;"></p>
            
            <!-- 5. Botón principal claro y acciones secundarias -->
            <div class="login-view__footer">
                <button type="submit" data-action="login" class="btn btn--primary btn--full" data-i18n="login_button">Iniciar Sesión</button>
                <p class="login-view__secondary-action">
                    <span data-i18n="login_no_account">¿No tienes una cuenta?</span> <a href="#" class="login-view__link" data-action="show-register" data-i18n="login_register_link">Regístrate aquí</a>
                </p>
            </div>
        </form>
    </div>
</div>
<!-- ================================================================================= -->
<!-- FIN: PANTALLA DE LOGIN PROFESIONALIZADA -->
<!-- ================================================================================= -->
<!-- ================================================================================= -->
<!-- INICIO: PANTALLA DE LOGIN CON PIN (CÓDIGO AÑADIDO) -->
<!-- ================================================================================= -->
<div id="pin-login-screen" class="login-view">
    <div class="starry-background"></div>
    <div class="login-view__card">
        <img src="aiDANaI.webp" alt="Logo" class="login-view__logo">
        <h2 class="login-view__title">Acceso Rápido</h2>
        <p class="login-view__tagline">Introduce tu PIN de 4 dígitos.</p>

        <form id="pin-form">
            <div class="pin-inputs" id="pin-inputs-container">
                <input type="number" class="pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="1" required>
                <input type="number" class="pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="1" required>
                <input type="number" class="pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="1" required>
                <input type="number" class="pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="1" required>
            </div>
            <p id="pin-error" class="form-error" style="min-height: 16px; margin-top: 8px;"></p>
        </form>
        
    <div class="login-view__footer">
    <p class="login-view__secondary-action">
        <!-- AÑADIMOS ESTE ENLACE -->
        <a href="#" class="login-view__link" data-action="use-password-instead">
            Usar contraseña en su lugar
        </a>
    </p>
    <p class="login-view__secondary-action" style="margin-top: var(--sp-2);">
        <a href="#" class="login-view__link" data-action="logout">O iniciar sesión con otra cuenta</a>
    </p>
</div>
    </div>
</div>
<!-- ================================================================================= -->
<!-- FIN: PANTALLA DE LOGIN CON PIN -->
<!-- ================================================================================= -->
    
    <div id="app-root" class="app-layout">
        <!-- ================================================================================= -->
        <!-- INICIO CAMBIO: Reestructuración de la Navegación Principal a 4 Pestañas -->
        <!-- ================================================================================= -->
        <nav class="bottom-nav">
            <button data-action="navigate" data-page="inicio-page" class="bottom-nav__item">
                <span class="material-icons">home</span>
                <span class="bottom-nav__label" data-i18n="nav_home">Inicio</span>
            </button>
            <button data-action="navigate" data-page="patrimonio-page" class="bottom-nav__item">
                <span class="material-icons">account_balance</span>
                <span class="bottom-nav__label" data-i18n="nav_wealth">Patrimonio</span>
            </button>
            <button data-action="navigate" data-page="analisis-page" class="bottom-nav__item">
                <span class="material-icons">analytics</span>
                <span class="bottom-nav__label" data-i18n="nav_analysis">Análisis</span>
            </button>
            <button data-action="navigate" data-page="configuracion-page" class="bottom-nav__item">
                <span class="material-icons">settings</span>
                <span class="bottom-nav__label" data-i18n="nav_settings">Ajustes</span>
            </button>
        </nav>

        <header id="app-top-bar" class="top-bar">
            <!-- INICIO: Grupo Izquierdo -->
            <div class="top-bar__left-group">
                <span id="sync-status-icon" class="material-icons"></span>
                <div id="top-bar-left-button" class="top-bar__left-button">
                    <!-- El botón A/B se inserta aquí dinámicamente -->
                </div>
            </div>
            <!-- FIN: Grupo Izquierdo -->

            <!-- Título Central -->
            <h1 id="top-bar-title" class="top-bar__title"></h1>

            <!-- Acciones Derechas -->
            <div id="top-bar-actions" class="top-bar__actions"></div>
        </header>

        <main class="app-layout__main">
            <!-- ================================================================================= -->
            <!-- INICIO CAMBIO: Nuevas secciones para la arquitectura de 4 pestañas -->
            <!-- ================================================================================= -->

            <!-- 1. PESTAÑA INICIO: Fusión de Panel y Movimientos Recientes -->
            <section id="inicio-page" class="view">
                <!-- El contenido de esta página se genera dinámicamente por la nueva función renderInicioPage() -->
            </section>

            <!-- 2. PESTAÑA PATRIMONIO: Fusión de Cuentas y Portafolio -->
            <section id="patrimonio-page" class="view">
                 <!-- El contenido de esta página se genera dinámicamente por la nueva función renderPatrimonioPage() -->
            </section>

            <!-- 3. PESTAÑA ANÁLISIS: Fusión de Presupuestos e Informes -->
<section id="analisis-page" class="view">
    <!-- Bloque 1: Presupuestos-->
    <div class="card card--no-bg accordion-wrapper">
        <details class="accordion">
            <summary>
                <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                    <span class="material-icons">request_quote</span>
                    <span>Presupuestos</span>
                </h3>
                <span class="material-icons accordion__icon">expand_more</span>
            </summary>
            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--sp-4);">
                    <div class="form-group" style="flex-grow: 1; margin: 0;">
                        <label for="budget-year-selector" class="form-label" style="margin: 0;">Año del Presupuesto</label>
                        <select id="budget-year-selector" class="form-select"></select>
                    </div>
                    <button data-action="update-budgets" class="btn btn--secondary" style="margin-left: var(--sp-3);">
                        <span class="material-icons" style="font-size: 16px;">edit_calendar</span>
                        <span>Gestionar</span>
                    </button>
                </div>

                <!-- Contenedor del Dashboard de Presupuestos -->
                <div id="annual-budget-dashboard">
                    <div id="budget-kpi-container" class="kpi-grid"></div>
                    <div class="card" style="margin-top: var(--sp-4);">
                        <!-- ================== TÍTULO CORREGIDO AQUÍ ================== -->
                        <h3 class="card__title"><span class="material-icons">trending_up</span>Tendencia Ingresos y Gastos</h3>
                        <div class="card__content">
                            <div class="chart-container" style="height: 220px;"><canvas id="budget-trend-chart"></canvas></div>
                        </div>
                    </div>
                    <div id="budget-details-list" style="margin-top: var(--sp-4);"></div>
                </div>
                
                <!-- INICIO CAMBIO: Empty State de Presupuestos mejorado -->
                <div id="budget-init-placeholder" class="empty-state hidden">
                    <span class="material-icons">edit_calendar</span>
                    <h3 id="budget-placeholder-title" data-i18n="budget_empty_title">Define tu Plan Financiero</h3>
                    <p id="budget-placeholder-text" data-i18n="budget_empty_text">Establece límites de gasto y metas de ingreso para tomar el control de tu año. ¡Empieza ahora!</p>
                    <button data-action="update-budgets" class="btn btn--primary" style="margin-top: var(--sp-4);">
                        <span class="material-icons" style="font-size: 16px;">add_circle_outline</span>
                        <span data-i18n="budget_empty_cta">Crear Presupuestos</span>
                    </button>
                </div>
                <!-- FIN CAMBIO -->
            </div>
        </details>
    </div>

    <!-- Bloque 2: Portafolio-->
    <div class="card card--no-bg accordion-wrapper">
        <details class="accordion">
            <summary>
                <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                    <span class="material-icons">edit_note</span>
                    <span>Portafolio</span>
                </h3>
                <span class="material-icons accordion__icon">expand_more</span>
            </summary>
            <div class="accordion__content" id="analisis-inversiones-container" style="padding: var(--sp-3) var(--sp-4);">
                <!-- El contenido del portafolio se renderizará aquí con JS -->
            </div>
        </details>
    </div>

    <!-- Bloque 3: Informes-->
    <div class="card card--no-bg accordion-wrapper">
        <details class="accordion">
            <summary>
                <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                    <span class="material-icons">assessment</span>
                    <span>Informes</span>
                </h3>
                <span class="material-icons accordion__icon">expand_more</span>
            </summary>
            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label for="informe-fecha-inicio" class="form-label">Desde</label>
                        <input type="date" id="informe-fecha-inicio" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="informe-fecha-fin" class="form-label">Hasta</label>
                        <input type="date" id="informe-fecha-fin" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="filter-cuenta-informe" class="form-label">Cuenta</label>
                        <select id="filter-cuenta-informe" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="filter-concepto-informe" class="form-label">Concepto</label>
                        <select id="filter-concepto-informe" class="form-select"></select>
                    </div>
                </div>
                <button data-action="apply-informe-filters" class="btn btn--primary btn--full" style="margin-top: var(--sp-2);">Generar Informe</button>

                <div id="informe-results-container" class="hidden" style="margin-top: var(--sp-4);">
                    <div id="informe-kpi-container" class="kpi-grid"></div>
                    <div class="chart-container" style="margin-top: var(--sp-4);"><canvas id="informes-chart"></canvas></div>
                </div>
                <div id="empty-informes" class="empty-state" style="border: none; background: transparent; padding-top: var(--sp-4);">
                    <span class="material-icons">query_stats</span>
                    <h3>Define tus parámetros</h3>
                    <p>Selecciona un rango de fechas para generar tu informe personalizado.</p>
                </div>
            </div>
        </details>
    </div>
</section>

            <!-- 4. PESTAÑA AJUSTES (Sin cambios en su contenido interno) -->
            <section id="configuracion-page" class="view">
    <div class="card card--no-bg accordion-wrapper">
        <details class="accordion">
            <summary>
                <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                    <span class="material-icons">person_outline</span>
                    <span data-i18n="settings_account_and_prefs">Cuenta y Preferencias</span>
                </h3>
                <span class="material-icons accordion__icon">expand_more</span>
            </summary>
            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                
                <!-- Contenido de Cuenta de Usuario -->
                <h3 class="card__title" style="margin-top: 0; font-size: var(--fs-base); padding: 0;">
                    <span class="material-icons">account_circle</span>
                    <span data-i18n="settings_user_account">Cuenta de Usuario</span>
                </h3>
                <div class="modal__list-item" style="padding-left: 0; padding-right: 0; margin-top: var(--sp-2);">
                    <span data-i18n="settings_logged_in_as">Sesión iniciada como:</span>
                    <strong id="config-user-email">cargando...</strong>
                </div>
                <button data-action="logout" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);">
                    <span class="material-icons" style="font-size: 16px;">logout</span>
                    <span data-i18n="settings_logout">Cerrar Sesión</span>
                </button>
				<!-- AÑADE ESTE NUEVO BOTÓN JUSTO DEBAJO -->
<button data-action="set-pin" class="btn btn--secondary btn--full" style="margin-top: var(--sp-2);">
    <span class="material-icons" style="font-size: 16px;">password</span>
    <span>Configurar PIN de Acceso Rápido</span>
</button>
                <button data-action="delete-account" class="btn btn--danger btn--full" style="margin-top: var(--sp-2); background-color: var(--c-black); border: 1px solid var(--c-danger);">
                    <span class="material-icons" style="font-size: 16px;">delete_forever</span>
                    <span data-i18n="settings_delete_account">Eliminar Mi Cuenta Permanentemente</span>
                </button>

                <!-- Separador Visual -->
                <hr style="margin: var(--sp-5) 0; border-color: var(--c-outline); opacity: 0.5;">

                <!-- Contenido de Idioma (Movido aquí) -->
                <h3 class="card__title" style="margin-top: 0; font-size: var(--fs-base); padding: 0;">
                    <span class="material-icons">translate</span><span data-i18n="settings_language">Idioma</span>
                </h3>
                <div id="language-selector" class="form-group" style="margin-top: var(--sp-3);">
                    <!-- El selector de idioma se generará aquí con JS -->
                </div>

                <!-- Separador Visual -->
                <hr style="margin: var(--sp-5) 0; border-color: var(--c-outline); opacity: 0.5;">

                <!-- Contenido de Configuración General (Movido aquí) -->
                <h3 class="card__title" style="margin-top: 0; font-size: var(--fs-base); padding: 0;">
                    <span class="material-icons">rocket_launch</span><span data-i18n="settings_startup_options">Opciones de Arranque</span>
                </h3>
                 <div class="form-checkbox-group" style="margin-top: var(--sp-2);">
                    <input type="checkbox" id="config-skip-intro" />
                    <label for="config-skip-intro" data-i18n="settings_skip_intro">Omitir intro y cita al iniciar la app</label>
                </div>
                
                <!-- Botón de guardado general para las preferencias -->
                <button data-action="save-config" class="btn btn--primary btn--full" style="margin-top: var(--sp-5);" data-i18n="settings_save_config">Guardar Preferencias</button>

            </div>
        </details>
    </div>
    
    <!-- Los demás bloques permanecen sin cambios -->
    <div class="card card--no-bg accordion-wrapper">
        <details class="accordion">
            <summary>
                <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                    <span class="material-icons">edit_note</span><span data-i18n="settings_data_management">Gestión de Datos</span>
                </h3>
                <span class="material-icons accordion__icon">expand_more</span>
            </summary>
            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                 <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <button data-action="manage-cuentas" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">account_balance</span><span data-i18n="common_accounts">Cuentas</span></button>
                    <button data-action="manage-conceptos" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">category</span><span data-i18n="common_concepts">Conceptos</span></button>
                    <button data-action="manage-recurrentes" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">event_repeat</span><span data-i18n="common_recurrent">Recurrentes</span></button>
                    <button data-action="update-budgets" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">edit_calendar</span><span>Presupuestos</span></button>
                </div>
                <button data-action="recalculate-balances" class="btn btn--primary btn--full" style="margin-top: var(--sp-4);">
                    <span class="material-icons" style="font-size: 16px;">calculate</span>
                    <span data-i18n="settings_recalculate_balances">Recalcular Saldos de Cuentas</span>
                </button>
            </div>
        </details>
    </div>
     <div class="card card--no-bg accordion-wrapper">
        <details class="accordion">
            <summary>
                <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                    <span class="material-icons">backup</span><span data-i18n="settings_backup">Copia de Seguridad</span>
                </h3>
                <span class="material-icons accordion__icon">expand_more</span>
            </summary>
            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-4);" data-i18n="settings_backup_warning">La importación de JSON o CSV reemplazará todos los datos actuales. Se recomienda exportar primero para tener una copia de seguridad.</p>
                <div class="form-grid">
                    <button data-action="export-data" class="btn btn--secondary" data-i18n-title="tooltip_export_json" title="Exportar una copia de seguridad completa en formato JSON."><span class="material-icons" style="font-size: 16px;">save</span><span data-i18n="settings_export_json">Exportar JSON</span></button>
                    <button data-action="export-csv" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">grid_on</span>Exportar CSV</button>
                    <button data-action="import-data" class="btn btn--secondary" data-i18n-title="tooltip_import_json" title="Importar desde un archivo de seguridad JSON."><span class="material-icons" style="font-size: 16px;">file_upload</span><span data-i18n="settings_import_json">Importar JSON</span></button>
                    <button data-action="import-csv" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">upload_file</span><span data-i18n="settings_import_csv">Importar CSV</span></button>
                </div>
                <input type="file" id="import-file-input" class="hidden" accept=".json,application/json" />
                <button data-action="clear-data" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);" data-i18n="settings_delete_all_data">Borrar Todos los Datos</button>
            </div>
        </details>
    </div>
</section>
            
            <!-- VISTA ESPECIAL: HISTORIAL COMPLETO DE MOVIMIENTOS -->
            <section id="movimientos-page-full" class="view" style="padding: 0; gap: 0;">
                <div id="movimientos-list-container">
                    <div id="virtual-list-sizer">
                        <div id="virtual-list-content"></div>
                    </div>
                    <div id="list-loader" class="hidden"><span class="spinner"></span></div>
                </div>
                <!-- INICIO CAMBIO: Empty State de Historial mejorado -->
                <div id="empty-movimientos" class="empty-state hidden" style="margin: 0 var(--sp-4);">
                    <span class="material-icons">receipt_long</span>
                    <h3 data-i18n="empty_history_title">Tu historial empieza aquí</h3>
                    <p data-i18n="empty_history_text">Pulsa el botón `+` para añadir tu primer ingreso o gasto.</p>
                </div>
                <!-- FIN CAMBIO -->
            </section>
            
            <!-- FIN CAMBIO: Fin de las nuevas secciones -->
        </main>
        
        <button data-action="add-movement" id="fab-add-movimiento" class="fab" data-i18n-title="tooltip_add_movement" title="Añadir Movimiento" aria-label="Añadir Movimiento"><span class="material-icons">add</span></button>

    </div>

    <div id="toast-container" aria-live="assertive"></div>
    
    <div id="movimiento-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="form-movimiento-title">
                <div class="modal">
            <!-- ======================= INICIO CAMBIO: Modal Grabber ======================= -->
            <div class="modal__grabber"></div>
            <!-- ======================= FIN CAMBIO ======================= -->
            <header class="modal__header" style="padding-top: var(--sp-2);">
                <h3 id="form-movimiento-title" class="modal__title">Añadir Movimiento</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="movimiento-modal" data-i18n-title="tooltip_close" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div class="modal__body">
                <form id="form-movimiento" novalidate>
                    <input type="hidden" id="movimiento-id" />
                    <input type="hidden" id="movimiento-mode" value="new" />
                    
                    <div class="filter-pills" style="justify-content: center; margin-bottom: var(--sp-3);">
                        <button type="button" id="mov-type-btn-movimiento" class="filter-pill filter-pill--active" data-action="set-movimiento-type" data-type="movimiento" data-i18n="form_type_movement">Ingreso/Gasto</button>
                        <button type="button" id="mov-type-btn-traspaso" class="filter-pill" data-action="set-movimiento-type" data-type="traspaso" data-i18n="form_type_transfer">Traspaso</button>
                    </div>

                    <!-- ======================= INICIO CAMBIO: Formulario Compacto ======================= -->
                    <div class="form-grid" style="grid-template-columns: 40% 1fr; align-items: flex-start;">
    <div class="form-group">
        <label for="movimiento-cantidad" class="form-label" data-i18n="form_amount">Cantidad</label>
        <input type="text" id="movimiento-cantidad" class="form-input input-amount-calculator" inputmode="none" required data-i18n-placeholder="form_amount_placeholder" placeholder="Ej: -2,50" />
        <span class="form-error" id="movimiento-cantidad-error"></span>
    </div>
	
    <div class="form-group">
        <label for="movimiento-descripcion" class="form-label" data-i18n="form_description">Descripción</label>
        <input type="text" id="movimiento-descripcion" class="form-input" required data-i18n-placeholder="form_description_placeholder" placeholder="Ej: Compra semanal" />
        <span class="form-error" id="movimiento-descripcion-error"></span>
        <div id="description-suggestions"></div>
    </div>
</div>

                    <div id="movimiento-fields">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group-addon">
                                <div class="form-group">
                                    <label for="movimiento-concepto" class="form-label" data-i18n="common_concept">Concepto</label>
                                    <select id="movimiento-concepto" class="form-select" required></select>
                                    <span class="form-error" id="movimiento-concepto-error"></span>
                                </div>
                                <button type="button" data-action="manage-conceptos" class="icon-btn" data-i18n-title="tooltip_manage_concepts" title="Gestionar Conceptos"><span class="material-icons">more_vert</span></button>
                            </div>
                            <div class="form-group-addon">
                                <div class="form-group">
                                    <label for="movimiento-cuenta" class="form-label" data-i18n="common_account">Cuenta</label>
                                    <select id="movimiento-cuenta" class="form-select" required></select>
                                    <span class="form-error" id="movimiento-cuenta-error"></span>
                                </div>
                                <button type="button" data-action="manage-cuentas" class="icon-btn" data-i18n-title="tooltip_manage_accounts" title="Gestionar Cuentas"><span class="material-icons">more_vert</span></button>
                            </div>
                        </div>
                    </div>

                    <div id="traspaso-fields" class="hidden">
                        <div class="form-group">
                            <label class="form-label" for="traspaso-show-all-accounts-toggle" data-i18n="common_accounts">Cuentas</label>
                            <div class="form-checkbox-group" style="margin-bottom: var(--sp-2);">
                                <input type="checkbox" id="traspaso-show-all-accounts-toggle" data-action="toggle-traspaso-accounts-filter" />
                                <label for="traspaso-show-all-accounts-toggle" style="font-size: var(--fs-xs);" data-i18n="form_show_all_accounts">Mostrar cuentas de ambas contabilidades (A y B)</label>
                            </div>
                        </div>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="movimiento-cuenta-origen" class="form-label" data-i18n="form_source_account">Cuenta Origen</label>
                                <select id="movimiento-cuenta-origen" class="form-select"></select>
                                <span class="form-error" id="movimiento-cuenta-origen-error"></span>
                            </div>
                            <div class="form-group">
                                <label for="movimiento-cuenta-destino" class="form-label" data-i18n="form_destination_account">Cuenta Destino</label>
                                <select id="movimiento-cuenta-destino" class="form-select"></select>
                                <span class="form-error" id="movimiento-cuenta-destino-error"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid var(--c-outline); margin-top: var(--sp-3); padding-top: var(--sp-2);">
                        <div class="form-switch-group modal__list-item" style="padding: var(--sp-2) 0;">
                            <label for="movimiento-recurrente" style="font-weight: 700;" data-i18n="form_schedule_recurrent">¿Programar como recurrente?</label>
                            <label class="form-switch"><input type="checkbox" id="movimiento-recurrente"><span class="slider"></span></label>
                        </div>
                        <div id="recurrent-options" class="hidden" style="animation: fade-in 0.3s; margin-top: var(--sp-2);">
                            <div class="form-group">
                                <label for="recurrent-frequency" class="form-label" data-i18n="form_frequency">Frecuencia</label>
                                <select id="recurrent-frequency" class="form-select">
                                    <option value="daily" data-i18n="freq_daily">Diaria</option>
                                    <option value="weekly" data-i18n="freq_weekly">Semanal</option>
                                    <option value="monthly" selected data-i18n="freq_monthly">Mensual</option>
                                    <option value="yearly" data-i18n="freq_yearly">Anual</option>
                                </select>
                            </div>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label for="recurrent-next-date" class="form-label" data-i18n="form_next_execution">Próxima ejecución</label>
                                    <input type="date" id="recurrent-next-date" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="recurrent-end-date" class="form-label" data-i18n="form_ends_on">Finaliza el (opcional)</label>
                                    <input type="date" id="recurrent-end-date" class="form-input">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: var(--sp-2);">
                        <label for="movimiento-fecha-display" class="form-label" data-i18n="form_date">Fecha</label>
                        <div class="form-group-addon">
                            <input type="date" id="movimiento-fecha" class="visually-hidden" required />
                            <button type="button" id="movimiento-fecha-display" class="btn btn--secondary" style="flex-grow: 1;">
                                <span id="movimiento-fecha-text"></span>
                                <span class="material-icons">edit_calendar</span>
                            </button>
                        </div>
                        <span class="form-error" id="movimiento-fecha-error"></span>
                    </div>
                    <!-- ======================= FIN CAMBIO ======================= -->

                    <div class="modal__actions">
                        <div class="left-actions">
                            <button type="button" id="delete-movimiento-btn" data-action="delete-movement-from-modal" class="icon-btn btn--danger hidden" data-i18n-title="tooltip_delete" title="Borrar"><span class="material-icons">delete</span></button>
                            <button type="button" id="duplicate-movimiento-btn" data-action="duplicate-movement" class="icon-btn btn--secondary hidden" data-i18n-title="tooltip_duplicate" title="Duplicar"><span class="material-icons">content_copy</span></button>
                        </div>
                        <div class="right-actions">
                            <button id="save-movimiento-btn" type="submit" class="btn btn--primary" data-i18n-title="tooltip_save_movement" title="Guardar Movimiento" data-i18n="common_save">Guardar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    
    
             
       
    <div id="calculator-ui" class="calculator-ui">
        <div id="calculator-display" class="calculator-display">0</div>
        <div id="calculator-grid" class="calculator-grid">
            <button class="calculator-btn btn-operator" data-key="clear">C</button>
            <button class="calculator-btn btn-operator" data-key="sign">+/-</button>
            <button class="calculator-btn btn-operator" data-key="backspace"><span class="material-icons backspace-icon">backspace</span></button>
            <button class="calculator-btn btn-confirm" id="calculator-btn-done" data-key="done">OK</button> <!-- Añadido ID aquí -->
            
            <button class="calculator-btn" data-key="7">7</button>
            <button class="calculator-btn" data-key="8">8</button>
            <button class="calculator-btn" data-key="9">9</button>
            <button class="calculator-btn btn-operator" data-key="divide">/</button> <!-- Operador -->

            <button class="calculator-btn" data-key="4">4</button>
            <button class="calculator-btn" data-key="5">5</button>
            <button class="calculator-btn" data-key="6">6</button>
            <button class="calculator-btn btn-operator" data-key="multiply">x</button> <!-- Operador -->
            
            <button class="calculator-btn" data-key="1">1</button>
            <button class="calculator-btn" data-key="2">2</button>
            <button class="calculator-btn" data-key="3">3</button>
            <button class="calculator-btn btn-operator" data-key="subtract">-</button> <!-- Operador -->

            <button class="calculator-btn zero" data-key="0">0</button>
            <button class="calculator-btn" data-key="comma">,</button>
            <button class="calculator-btn btn-operator" data-key="add">+</button> <!-- Operador -->
        </div>
    </div>
	<div id="generic-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="generic-modal-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="generic-modal-title" class="modal__title"></h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="generic-modal" data-i18n-title="tooltip_close" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="generic-modal-body" class="modal__body"></div>
        </div>
    </div>
    
</div>

<div id="global-search-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="global-search-title">
        <div class="modal">
            <header class="modal__header">
                <div id="global-search-input-wrapper">
                    <span class="material-icons" style="color: var(--c-on-surface-secondary);">search</span>
                    <input type="search" id="global-search-input" data-i18n-placeholder="search_placeholder" placeholder="Buscar en toda la app..." autocomplete="off">
                </div>
                <button class="icon-btn" data-action="close-modal" data-modal-id="global-search-modal" data-i18n-title="tooltip_close" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="global-search-results" class="modal__body">
                <div class="empty-state" style="background:transparent; border: none;">
                    <span class="material-icons">manage_search</span>
                    <h3 data-i18n="search_empty_title">Encuéntralo todo</h3>
                    <p data-i18n="search_empty_text">Busca movimientos, cuentas o conceptos. <br>Atajo: <strong>Cmd/Ctrl + K</strong></p>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- === INICIO: NUEVO ASISTENTE DE IMPORTACIÓN JSON === -->
    <div id="json-import-wizard-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="json-wizard-title">
        <div class="modal" style="max-width: 500px; height: auto; max-height: 85vh;">
            <header class="modal__header">
                <h3 id="json-wizard-title" class="modal__title" data-i18n="json_wizard_title">Asistente de Importación JSON</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="json-import-wizard-modal" data-i18n-title="tooltip_close" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="json-wizard-body" class="modal__body" style="display: flex; flex-direction: column;">

                <!-- PASO 1: SELECCIÓN DE ARCHIVO -->
                <div id="json-wizard-step-1" class="json-wizard-step">
                    <h4 data-i18n="json_wizard_step1_title">Paso 1: Selecciona tu copia de seguridad</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);" data-i18n="json_wizard_step1_desc">Arrastra y suelta el archivo <code>.json</code> o haz clic para seleccionarlo. La importación reemplazará <strong>todos</strong> tus datos actuales.</p>
                    <div id="json-drop-zone">
                        <span class="material-icons" style="font-size: 48px; color: var(--c-outline);">upload_file</span>
                        <p id="json-drop-zone-text" data-i18n="json_wizard_dropzone">Arrastra tu archivo aquí o haz clic</p>
                    </div>
                    <div id="json-file-error" class="form-error" style="text-align: center; margin-top: var(--sp-3);"></div>
                </div>

                <!-- PASO 2: VISTA PREVIA Y CONFIRMACIÓN -->
                <div id="json-wizard-step-2" class="json-wizard-step" style="display: none;">
                    <h4 data-i18n="json_wizard_step2_title">Paso 2: Revisa y confirma</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);" data-i18n="json_wizard_step2_desc">Hemos analizado tu archivo. Si los datos son correctos, pulsa "Importar" para reemplazar tus datos actuales.</p>
                    <div id="json-preview-container">
                        <ul id="json-preview-list"></ul>
                        <div class="form-error" style="margin-top: var(--sp-2); text-align: center;"><strong data-i18n="common_irreversible">Atención:</strong> <span data-i18n="common_irreversible_desc">Esta acción es irreversible.</span></div>
                    </div>
                    <div class="modal__actions" style="justify-content: space-between;">
                        <button class="btn btn--secondary" data-action="json-wizard-back-2" data-i18n="common_back">Atrás</button>
                        <button class="btn btn--danger" data-action="json-wizard-import-final"><span class="material-icons">warning</span><span data-i18n="common_import_replace">Importar y Reemplazar</span></button>
                    </div>
                </div>

                <!-- PASO 3: PROGRESO Y RESULTADO -->
                <div id="json-wizard-step-3" class="json-wizard-step" style="display: none; justify-content: center; align-items: center; text-align: center; min-height: 200px;">
                    <div id="json-import-progress">
                        <span class="spinner" style="width: 48px; height: 48px; border-width: 4px;"></span>
                        <h4 style="margin-top: var(--sp-4);" data-i18n="common_importing">Importando...</h4>
                        <p data-i18n="common_importing_desc">Estamos guardando tus datos. Por favor, no cierres esta ventana.</p>
                    </div>
                     <div id="json-import-result" style="display: none;">
                        <span class="material-icons" style="font-size: 60px; color: var(--c-success);">task_alt</span>
                        <h4 id="json-result-title" style="margin-top: var(--sp-2);" data-i18n="import_complete_title">¡Importación Completada!</h4>
                        <p id="json-result-message"></p>
                        <div class="modal__actions" style="justify-content: center;">
                            <button class="btn btn--primary" data-action="close-modal" data-modal-id="json-import-wizard-modal" data-i18n="common_finish">Finalizar</button>
                        </div>
                     </div>
                </div>

            </div>
        </div>
    </div>
    <!-- === FIN: NUEVO ASISTENTE DE IMPORTACIÓN JSON === -->


    <div id="exit-screen">
        <p>Finanzas al día ✅ Movimientos revisados 👀  <br>💰 aiDANaI simplifica tus cuentas 💰</p>
    </div>
<!-- ================================================================================= -->
<!-- INICIO: MODAL DE AYUDA (EL CÓDIGO QUE FALTABA) -->
<!-- ================================================================================= -->
<div id="help-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="help-modal-title">
    <div class="modal" style="max-width: 650px; max-height: 80vh;">
        <header class="modal__header">
            <!-- El ID "help-modal-title" es el que busca el JavaScript para poner el título -->
            <h3 id="help-modal-title" class="modal__title"></h3>
            <!-- El data-modal-id="help-modal" asegura que este botón cierre el modal correcto -->
            <button class="icon-btn" data-action="close-modal" data-modal-id="help-modal" data-i18n-title="tooltip_close" title="Cerrar" aria-label="Cerrar">
                <span class="material-icons">close</span>
            </button>
        </header>
        <!-- El ID "help-modal-body" es donde el JavaScript inyectará todo el contenido de la guía -->
        <div id="help-modal-body" class="modal__body">
            <!-- El contenido se cargará aquí dinámicamente -->
        </div>
    </div>
</div>
<!-- ================================================================================= -->
<!-- FIN: MODAL DE AYUDA -->
<!-- ================================================================================= -->


    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script type="module">

	import { addDays, addWeeks, addMonths, addYears } from 'https://cdn.jsdelivr.net/npm/date-fns@2.29.3/+esm'
        // =================================================================================
        // MIGRATION SCRIPT HELPER
        // =================================================================================
        /* 
            IMPORTANTE: GUÍA DE MIGRACIÓN DE DATOS PARA PAGINACIÓN

            Esta nueva versión de la aplicación requiere una estructura de datos diferente en Firestore
            para poder funcionar correctamente. Necesitas ejecutar una migración UNA SOLA VEZ
            para tu cuenta.

            CÓMO MIGRAR:
            1.  **HAZ UNA COPIA DE SEGURIDAD:** Antes de nada, ve a Ajustes -> Copia de Seguridad -> Exportar JSON.
            2.  **INICIA SESIÓN:** Asegúrate de haber iniciado sesión en la aplicación en tu navegador.
            3.  **ABRE LA CONSOLA:** Abre las herramientas de desarrollador de tu navegador (normalmente con F12 o Cmd+Opt+J)
                y ve a la pestaña "Consola".
            4.  **EJECUTA EL SCRIPT:** Pega la siguiente línea de código en la consola y presiona Enter:
                
                migrateDataToSubcollections()

            5.  **ESPERA:** El script tardará un momento en procesar todos tus datos. La consola te
                avisará cuando haya terminado con "¡MIGRACIÓN COMPLETADA!".
            6.  **RECARGA LA APP:** Recarga la página (F5 o Cmd+R). Tu aplicación ahora usará la nueva
                estructura de datos y la paginación.

            El script de migración está definido más abajo en este mismo fichero (`migrateDataToSubcollections`).
        */
       
        // =================================================================================
        // 0. INTERNATIONALIZATION (I18N)
        // =================================================================================

        const translations = {
            // ENGLISH
            en: {
                // Nav & Titles
                nav_home: "Home",
                nav_wealth: "Wealth",
                nav_analysis: "Analysis",
                nav_settings: "Settings",
                title_home: "Home",
                title_wealth: "Wealth",
                title_analysis: "Analysis",
                title_settings: "Settings",
                title_history: "Transaction History",

                // Login
                login_welcome: "Welcome Back",
                login_tagline: "Log in to take control of your finances.",
                login_email_placeholder: "Email address",
                login_password_placeholder: "Password",
                login_forgot_password: "Forgot your password?",
                login_button: "Log In",
                login_no_account: "Don't have an account?",
                login_register_link: "Sign up here",
                
                // Settings
				settings_account_and_prefs: "Account & Preferences",
                settings_user_account: "User Account",
                settings_logged_in_as: "Logged in as:",
                settings_logout: "Log Out",
                settings_delete_account: "Delete My Account Permanently",
                settings_appearance: "Appearance",
                settings_language: "Language",
                settings_theme_selector: "Theme Selector",
                settings_general: "General Settings",
                settings_startup_options: "Startup Options",
                settings_skip_intro: "Skip intro and quote on app start",
                settings_save_config: "Save Settings",
                settings_data_management: "Data Management",
                settings_recalculate_balances: "Recalculate Account Balances",
                settings_backup: "Backup & Restore",
                settings_backup_warning: "Importing a JSON or CSV file will replace all your current data. It is recommended to export first to have a backup.",
                settings_export_json: "Export JSON",
                settings_import_json: "Import JSON",
                settings_import_csv: "Import CSV",
                settings_delete_all_data: "Delete All Data",

                // Tooltips
                tooltip_toggle_ledger: "Switch between Personal (A) and Secondary (B) ledger",
                tooltip_add_movement: "Add Transaction",
                tooltip_close: "Close",
                tooltip_manage_concepts: "Manage Categories",
                tooltip_manage_accounts: "Manage Accounts",
                tooltip_save_movement: "Save Transaction",
                tooltip_delete: "Delete",
                tooltip_duplicate: "Duplicate",
                tooltip_export_json: "Export a full backup in JSON format.",
                tooltip_import_json: "Import from a JSON backup file.",
                
                // Forms & Modals
                form_type_movement: "Income/Expense",
                form_type_transfer: "Transfer",
                form_amount: "Amount (expense as negative)",
                form_amount_placeholder: "e.g.: -2.50",
                form_description: "Description",
                form_description_placeholder: "e.g.: Weekly groceries",
                form_source_account: "Source Account",
                form_destination_account: "Destination Account",
                form_show_all_accounts: "Show accounts from both ledgers (A & B)",
                form_schedule_recurrent: "Schedule as recurrent?",
                form_frequency: "Frequency",
                form_next_execution: "Next execution",
                form_ends_on: "Ends on (optional)",
                form_date: "Date",
                
                // Frequencies
                freq_daily: "Daily",
                freq_weekly: "Weekly",
                freq_monthly: "Monthly",
                freq_yearly: "Annual",

                // Empty States
                empty_history_title: "Your history starts here",
                empty_history_text: "Press the `+` button to add your first income or expense.",
                budget_empty_title: "Define Your Financial Plan",
                budget_empty_text: "Set spending limits and income goals to take control of your year. Get started now!",
                budget_empty_cta: "Create Budgets",

                // Search
                search_placeholder: "Search across the app...",
                search_empty_title: "Find everything",
                search_empty_text: "Search for transactions, accounts, or categories. <br>Shortcut: <strong>Cmd/Ctrl + K</strong>",
                
                // Tour
                tour_skip: "Skip",
                tour_previous: "Previous",
                tour_next: "Next",

                // Common Words
                common_accounts: "Accounts",
                common_concepts: "Categories",
                common_recurrent: "Recurrent",
                common_account: "Account",
                common_concept: "Category",
                common_save: "Save",
                common_back: "Back",
                common_finish: "Finish",
                common_import_replace: "Import and Replace",
                common_importing: "Importing...",
                common_importing_desc: "We are saving your data. Please do not close this window.",
                common_irreversible: "Warning:",
                common_irreversible_desc: "This action is irreversible.",
                
                // JSON Wizard
                json_wizard_title: "JSON Import Wizard",
                json_wizard_step1_title: "Step 1: Select your backup",
                json_wizard_step1_desc: "Drag and drop the <code>.json</code> file or click to select it. Importing will replace <strong>all</strong> of your current data.",
                json_wizard_dropzone: "Drag your file here or click",
                json_wizard_step2_title: "Step 2: Review and confirm",
                json_wizard_step2_desc: "We have analyzed your file. If the data is correct, press 'Import' to replace your current data.",
                import_complete_title: "Import Complete!",

                // Customize Panel
                customize_panel_title: "Customize Dashboard",
                customize_panel_desc: "Enable, disable, and reorder the elements you want to see on your dashboard.",
                customize_panel_save: "Save Changes",
                
                // INICIO CAMBIO: Ayuda en Inglés
                help_title: "The Ultimate User Guide",
                help_content: `
                    <div style="text-align: center; margin-bottom: var(--sp-4);">
                        <span class="material-icons" style="font-size: 48px; color: var(--c-primary);">school</span>
                        <h3>¡Bienvenido a tu Centro de Mando Financiero!</h3>
                    </div>
                    <p>¡Hola! Prepárate para tomar el control de tu dinero como nunca antes. Esta guía está diseñada para convertirte en un experto de tus propias finanzas, explicando cada rincón de la aplicación de una forma clara y entretenida. ¡Vamos allá!</p>
                    
                    <div style="text-align: center; margin: var(--sp-4) 0;">
                        <button class="btn btn--secondary" data-action="start-onboarding-tour">
                            <span class="material-icons" style="font-size: 16px;">play_circle_outline</span>
                            <span>Iniciar Tour Interactivo</span>
                        </button>
                    </div>

                    <h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">explore</span>Un Paseo por la Nueva Interfaz</h3>
                    <p>Hemos organizado la aplicación en cuatro pestañas principales para que todo sea más intuitivo. Piensa en ellas como los departamentos de tu empresa financiera personal:</p>
                    
                    <details class="accordion" style="margin-bottom: var(--sp-2);" open>
                        <summary><span class="material-icons" style="margin-right:8px">home</span><strong>1. Inicio: Tu Centro de Operaciones Diario</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);">
                            <p>Aquí es donde pasarás la mayor parte del tiempo. Es el pulso de tu actividad financiera diaria. Tienes dos vistas geniales:</p>
                            <ul>
                                <li><strong>Vista "Recientes":</strong> Como el feed de tus redes sociales, pero con tu dinero. Verás al instante tus últimos gastos, ingresos y traspasos. Es perfecta para saber qué ha pasado hoy o ayer.</li>
                                <li><strong>Vista "Resumen":</strong> ¿Quieres saber cómo va el mes? Cambia a esta vista y obtendrás un análisis de alto nivel con:
                                    <ul>
                                        <li><strong>KPIs (Indicadores Clave):</strong> Tus ingresos, gastos y, lo más importante, el <strong>saldo neto</strong>. ¡Incluso te dice si vas mejor o peor que el mes pasado!</li>
                                        <li><strong>Gráficos por Concepto:</strong> Un desglose visual y súper fácil de entender sobre a dónde se va tu dinero (comida, ocio, facturas...) y de dónde viene.</li>
                                    </ul>
                                </li>
                            </ul>
                            <p><strong>Ejemplo práctico:</strong> Acabas de empezar el mes. Usas la vista "Recientes" para registrar tu compra del súper. A mitad de mes, cambias a "Resumen" para ver si estás gastando más de la cuenta en "Restaurantes" y ajustar tus planes para las próximas semanas.</p>
                        </div>
                    </details>
                                    
                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary><span class="material-icons" style="margin-right:8px">account_balance</span><strong>2. Patrimonio: Tu Fotografía Financiera</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);">
                            <p>Esta sección es tu "foto de la riqueza". Te muestra todo lo que tienes y dónde lo tienes, dándote una visión clara de tu salud financiera global.</p>
                            <ul>
                                <li><strong>Patrimonio Neto:</strong> El número más importante, arriba del todo. Te dice el valor total de tus posesiones.</li>
                                <li><strong>Listado de Cuentas:</strong> Aquí verás todas tus cuentas (bancos, efectivo, tarjetas...) agrupadas por tipo. Puedes usar los filtros para, por ejemplo, ver solo el dinero que tienes en bancos.</li>
                                <li><strong>Cartera de Inversión:</strong> Un apartado de lujo para tus activos de inversión. No solo te dice cuánto valen, sino cómo están rindiendo.</li>
                            </ul>
                            <p><strong>Ejemplo práctico:</strong> Quieres saber cuánto dinero "líquido" tienes disponible. Vas a Patrimonio, filtras para ver solo "Banco" y "Efectivo", y el número de "Patrimonio Neto" te dará la respuesta al instante.</p>
                        </div>
                    </details>
                    
                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary><span class="material-icons" style="margin-right:8px">analytics</span><strong>3. Análisis: El Laboratorio del Estratega</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);">
                            <p>Aquí es donde te pones el sombrero de estratega. Miras al pasado para tomar mejores decisiones en el futuro.</p>
                            <ul>
                                <li><strong>Presupuestos:</strong> ¡Tu plan de batalla! Define cuánto quieres gastar (o ingresar) en cada categoría durante el año. La app te mostrará con barras de progreso si te estás ciñendo al plan o si necesitas apretarte el cinturón.</li>
                                <li><strong>Informes Personalizados:</strong> Eres el detective de tus finanzas. ¿Quieres saber cuánto gastaste en gasolina el trimestre pasado usando solo una tarjeta de crédito específica? Aquí puedes generar ese informe con gráficos y todo.</li>
                            </ul>
                            <p><strong>Ejemplo práctico:</strong> Creas un presupuesto de 200€ al mes para "Ocio". A final de mes, en la sección de Presupuestos, ves que has gastado 250€. La barra de progreso estará en rojo, avisándote de que te has pasado un 25%.</p>
                        </div>
                    </details>

                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary><span class="material-icons" style="margin-right:8px">settings</span><strong>4. Ajustes: La Sala de Máquinas</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);"><p>El centro de control. Aquí personalizas la app (¡prueba los temas de colores!), gestionas tus datos base (crear/editar Cuentas y Conceptos) y, muy importante, haces tus copias de seguridad.</p></div>
                    </details>

                    <h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">stars</span>Funciones Estrella que Debes Conocer</h3>

                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary>🚀 <strong>Contabilidad Dual (A/B): Tu Superpoder Secreto</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);"><p>El botón <strong>[A]/[B]</strong> de la esquina superior izquierda es mágico. Te permite llevar dos contabilidades totalmente separadas. Es como tener dos aplicaciones en una.</p>
                        <p><strong>Ejemplo de uso:</strong></p>
                        <ul>
                            <li><strong>Contabilidad A (Personal):</strong> Gestionas tu nómina, tus gastos diarios, tus ahorros... tu vida.</li>
                            <li><strong>Contabilidad B (Proyecto):</strong> Gestionas los ingresos y gastos de un pequeño negocio, de las cuentas de la comunidad de vecinos, o de la organización de un viaje en grupo. ¡Todo separado y ordenado!</li>
                        </ul>
                        </div>
                    </details>

                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary>🔍 <strong>Búsqueda Global (Atajo: Ctrl/Cmd + K)</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);"><p>¿No recuerdas dónde apuntaste la cena del sábado? Pulsa el icono de la lupa (o el atajo de teclado) y escribe "cena". La búsqueda te mostrará al instante ese movimiento, la cuenta relacionada y el concepto. ¡Es la forma más rápida de encontrar cualquier cosa!</p></div>
                    </details>

                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary>📈 <strong>Seguimiento PRO de Inversiones</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);">
                            <p>Esto lleva tus finanzas al siguiente nivel. En <strong>Ajustes > Gestión de Datos > Cuentas</strong>, puedes marcar una cuenta como "de inversión". Al hacerlo, la app empezará a calcular métricas profesionales para ella en la pestaña de Patrimonio:</p>
                            <ul>
                                <li><strong>P&L (Ganancias y Pérdidas):</strong> Te dice exactamente cuánto dinero has ganado o perdido, tanto en euros como en porcentaje.</li>
                                <li><strong>TIR (Tasa Interna de Retorno):</strong> El indicador definitivo. Te dice la rentabilidad <strong>anualizada</strong> real de tu inversión, teniendo en cuenta no solo el valor final, sino cuándo y cuánto dinero has ido metiendo o sacando.</li>
                            </ul>
                        </div>
                    </details>
                    
                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary>🔄 <strong>Importación Inteligente desde CSV</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);">
                            <p>¿Vienes de otra app o tienes tus datos en una hoja de cálculo? ¡No hay problema! Ve a <strong>Ajustes > Copia de Seguridad > Importar CSV</strong>. Solo necesitas un archivo con 5 columnas:</p>
                            <code>FECHA;CUENTA;CONCEPTO;IMPORTE;DESCRIPCIÓN</code>
                            <p>La app es muy lista y hará magia por ti:</p>
                            <ul>
                                <li>Si una cuenta o concepto no existe, ¡lo crea automáticamente!</li>
                                <li><strong>Truco PRO:</strong> Si en la columna CONCEPTO pones <code>TRASPASO</code>, la app buscará un movimiento de la misma fecha e importe contrario en otra cuenta y los emparejará como una transferencia.</li>
                                <li><strong>Truco PRO 2:</strong> Usa el CONCEPTO <code>INICIAL</code> para establecer el saldo de partida de una cuenta. Por ejemplo: "01/01/2025;Mi Banco;INICIAL;1500;Saldo inicial del año".</li>
                            </ul>
                        </div>
                    </details>

                    <p style="text-align: center; margin-top: var(--sp-5); font-style: italic; color: var(--c-on-surface-secondary);">¡Explora, registra y toma el control definitivo de tu futuro financiero!</p>
                `,
                // FIN CAMBIO
            },
            
            // FRENCH
            fr: {
                // Nav & Titles
                nav_home: "Accueil",
                nav_wealth: "Patrimoine",
                nav_analysis: "Analyse",
                nav_settings: "Réglages",
                title_home: "Accueil",
                title_wealth: "Patrimoine",
                title_analysis: "Analyse",
                title_settings: "Réglages",
                title_history: "Historique des Transactions",

                // Login
                login_welcome: "Bon Retour",
                login_tagline: "Connectez-vous pour prendre le contrôle de vos finances.",
                login_email_placeholder: "Adresse e-mail",
                login_password_placeholder: "Mot de passe",
                login_forgot_password: "Mot de passe oublié ?",
                login_button: "Se Connecter",
                login_no_account: "Pas de compte ?",
                login_register_link: "Inscrivez-vous ici",
                
                // Settings
				settings_account_and_prefs: "Compte et Préférences",
                settings_user_account: "Compte Utilisateur",
                settings_logged_in_as: "Connecté en tant que :",
                settings_logout: "Se Déconnecter",
                settings_delete_account: "Supprimer Mon Compte Définitivement",
                settings_appearance: "Apparence",
                settings_language: "Langue",
                settings_theme_selector: "Sélecteur de Thème",
                settings_general: "Réglages Généraux",
                settings_startup_options: "Options de Démarrage",
                settings_skip_intro: "Passer l'intro et la citation au démarrage",
                settings_save_config: "Enregistrer les Réglages",
                settings_data_management: "Gestion des Données",
                settings_recalculate_balances: "Recalculer les Soldes des Comptes",
                settings_backup: "Sauvegarde",
                settings_backup_warning: "L'importation d'un fichier JSON ou CSV remplacera toutes vos données actuelles. Il est recommandé d'exporter d'abord pour avoir une sauvegarde.",
                settings_export_json: "Exporter JSON",
                settings_import_json: "Importer JSON",
                settings_import_csv: "Importer CSV",
                settings_delete_all_data: "Supprimer Toutes les Données",

                // Tooltips
                tooltip_toggle_ledger: "Basculer entre la comptabilité Personnelle (A) et Secondaire (B)",
                tooltip_add_movement: "Ajouter une Transaction",
                tooltip_close: "Fermer",
                tooltip_manage_concepts: "Gérer les Catégories",
                tooltip_manage_accounts: "Gérer les Comptes",
                tooltip_save_movement: "Enregistrer la Transaction",
                tooltip_delete: "Supprimer",
                tooltip_duplicate: "Dupliquer",
                tooltip_export_json: "Exporter une sauvegarde complète au format JSON.",
                tooltip_import_json: "Importer depuis un fichier de sauvegarde JSON.",
                
                // Forms & Modals
                form_type_movement: "Revenu/Dépense",
                form_type_transfer: "Virement",
                form_amount: "Montant (dépense en négatif)",
                form_amount_placeholder: "ex: -2,50",
                form_description: "Description",
                form_description_placeholder: "ex: Courses de la semaine",
                form_source_account: "Compte Source",
                form_destination_account: "Compte Destinataire",
                form_show_all_accounts: "Afficher les comptes des deux comptabilités (A et B)",
                form_schedule_recurrent: "Planifier comme récurrent ?",
                form_frequency: "Fréquence",
                form_next_execution: "Prochaine exécution",
                form_ends_on: "Se termine le (optionnel)",
                form_date: "Date",
                
                // Frequencies
                freq_daily: "Quotidienne",
                freq_weekly: "Hebdomadaire",
                freq_monthly: "Mensuelle",
                freq_yearly: "Annuelle",

                // Empty States
                empty_history_title: "Votre historique commence ici",
                empty_history_text: "Appuyez sur le bouton `+` pour ajouter votre premier revenu ou dépense.",
                budget_empty_title: "Définissez Votre Plan Financier",
                budget_empty_text: "Fixez des limites de dépenses et des objectifs de revenus pour prendre le contrôle de votre année. Commencez maintenant !",
                budget_empty_cta: "Créer des Budgets",

                // Search
                search_placeholder: "Rechercher dans toute l'application...",
                search_empty_title: "Trouvez tout",
                search_empty_text: "Recherchez des transactions, comptes ou catégories. <br>Raccourci : <strong>Cmd/Ctrl + K</strong>",

                // Tour
                tour_skip: "Passer",
                tour_previous: "Précédent",
                tour_next: "Suivant",

                // Common Words
                common_accounts: "Comptes",
                common_concepts: "Catégories",
                common_recurrent: "Récurrents",
                common_account: "Compte",
                common_concept: "Catégorie",
                common_save: "Enregistrer",
                common_back: "Retour",
                common_finish: "Terminer",
                common_import_replace: "Importer et Remplacer",
                common_importing: "Importation...",
                common_importing_desc: "Nous sauvegardons vos données. Veuillez ne pas fermer cette fenêtre.",
                common_irreversible: "Attention :",
                common_irreversible_desc: "Cette action est irréversible.",

                // JSON Wizard
                json_wizard_title: "Assistant d'Importation JSON",
                json_wizard_step1_title: "Étape 1 : Sélectionnez votre sauvegarde",
                json_wizard_step1_desc: "Glissez-déposez le fichier <code>.json</code> ou cliquez pour le sélectionner. L'importation remplacera <strong>toutes</strong> vos données actuelles.",
                json_wizard_dropzone: "Glissez votre fichier ici ou cliquez",
                json_wizard_step2_title: "Étape 2 : Vérifiez et confirmez",
                json_wizard_step2_desc: "Nous avons analysé votre fichier. Si les données sont correctes, appuyez sur 'Importer' pour remplacer vos données actuelles.",
                import_complete_title: "Importation Terminée !",
                
                // Customize Panel
                customize_panel_title: "Personnaliser le Tableau de Bord",
                customize_panel_desc: "Activez, désactivez et réorganisez les éléments que vous souhaitez voir sur votre tableau de bord.",
                customize_panel_save: "Enregistrer les Modifications",

                // INICIO CAMBIO: Ayuda en Francés
                help_title: "Le Guide Utilisateur Ultime",
                help_content: `
                    <div style="text-align: center; margin-bottom: var(--sp-4);">
                        <span class="material-icons" style="font-size: 48px; color: var(--c-primary);">school</span>
                        <h3>Bienvenido a su Centro de Mando Financiero !</h3>
                    </div>
                    <p>Bonjour ! Préparez-vous à prendre le contrôle de votre argent comme jamais auparavant. Ce guide est conçu pour faire de vous un expert de vos propres finances en expliquant chaque recoin de l'application de manière claire et engageante. C'est parti !</p>
                    
                    <h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">explore</span>Un Tour de la Nouvelle Interface</h3>
                    <p>Nous avons organisé l'application en quatre onglets principaux pour rendre tout plus intuitif. Considérez-les comme les départements de votre entreprise financière personnelle :</p>
                    
                    <details class="accordion" style="margin-bottom: var(--sp-2);" open>
                        <summary><span class="material-icons" style="margin-right:8px">home</span><strong>1. Accueil : Votre Centre d'Opérations Quotidien</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);">
                            <p>C'est ici que vous passerez le plus de temps. C'est le pouls de votre activité financière quotidienne. Vous disposez de deux vues géniales :</p>
                            <ul>
                                <li><strong>Vue "Récents" :</strong> Comme votre fil d'actualité sur les réseaux sociaux, mais pour votre argent. Voyez instantanément vos dernières dépenses, revenus et virements. Parfait pour savoir ce qui s'est passé aujourd'hui ou hier.</li>
                                <li><strong>Vue "Résumé" :</strong> Vous voulez savoir comment se passe le mois ? Passez à cette vue pour une analyse de haut niveau avec :
                                    <ul>
                                        <li><strong>KPIs (Indicateurs Clés de Performance) :</strong> Vos revenus, vos dépenses et, le plus important, le <strong>solde net</strong>. Il vous indique même si vous faites mieux ou moins bien que le mois dernier !</li>
                                        <li><strong>Graphiques par Catégorie :</strong> Une répartition visuelle et super facile à comprendre de l'destination de votre argent (nourriture, loisirs, factures...) et de sa provenance.</li>
                                    </ul>
                                </li>
                            </ul>
                            <p><strong>Exemple pratique :</strong> Vous venez de commencer le mois. Vous utilisez la vue "Récents" pour enregistrer vos courses. À la mi-mois, vous passez à "Résumé" pour voir si vous dépensez trop en "Restaurants" et ajuster vos plans pour les semaines à venir.</p>
                        </div>
                    </details>
                                    
                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary><span class="material-icons" style="margin-right:8px">account_balance</span><strong>2. Patrimoine : Votre Cliché Financier</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);">
                            <p>Cette section est votre "cliché de richesse". Elle vous montre tout ce que vous possédez et où vous le possédez, vous donnant une vision claire de votre santé financière globale.</p>
                            <ul>
                                <li><strong>Valeur Nette :</strong> Le chiffre le plus important, tout en haut. Il vous indique la valeur totale de vos actifs.</li>
                                <li><strong>Liste des Comptes :</strong> Ici, vous verrez tous vos comptes (banques, espèces, cartes...) regroupés par type. Vous pouvez utiliser les filtres pour, par exemple, ne voir que l'argent que vous avez en banque.</li>
                                <li><strong>Portefeuille d'Investissement :</strong> Une section premium pour vos actifs d'investissement. Elle vous indique non seulement leur valeur, mais aussi leur performance.</li>
                            </ul>
                            <p><strong>Exemple pratique :</strong> Vous voulez savoir combien d'argent "liquide" vous avez de disponible. Vous allez dans Patrimoine, filtrez pour ne voir que "Banque" et "Espèces", et le chiffre de la "Valeur Nette" vous donne la réponse instantanément.</p>
                        </div>
                    </details>
                    
                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary><span class="material-icons" style="margin-right:8px">analytics</span><strong>3. Analyse : Le Laboratoire du Stratège</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);">
                            <p>C'est ici que vous mettez votre casquette de stratège. Vous regardez le passé pour prendre de meilleures décisions pour l'avenir.</p>
                            <ul>
                                <li><strong>Budgets :</strong> Votre plan de bataille ! Définissez combien vous voulez dépenser (ou gagner) dans chaque catégorie pour l'année. L'application vous montrera avec des barres de progression si vous respectez le plan ou si vous devez vous serrer la ceinture.</li>
                                <li><strong>Rapports Personnalisés :</strong> Vous êtes le détective de vos finances. Vous voulez savoir combien vous avez dépensé en essence le trimestre dernier en utilisant uniquement une carte de crédit spécifique ? Ici, vous pouvez générer ce rapport avec des graphiques et tout.</li>
                            </ul>
                            <p><strong>Exemple pratique :</strong> Vous créez un budget de 200€/mois pour les "Loisirs". À la fin du mois, dans la section Budgets, vous voyez que vous avez dépensé 250€. La barre de progression sera rouge, vous avertissant que vous avez dépassé de 25%.</p>
                        </div>
                    </details>

                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary><span class="material-icons" style="margin-right:8px">settings</span><strong>4. Réglages : La Salle des Machines</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);"><p>Le centre de control. Ici, vous personnalisez l'application (essayez les thèmes de couleurs !), gérez vos données de base (créer/modifier des Comptes et Catégories), et, très important, faites vos sauvegardes.</p></div>
                    </details>

                    <h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">stars</span>Fonctionnalités Clés à Connaître</h3>

                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary>🚀 <strong>Comptabilité Double (A/B) : Votre Super-pouvoir Secret</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);"><p>Le bouton <strong>[A]/[B]</strong> dans le coin supérieur gauche est magique. Il vous permet de tenir deux comptabilités complètement séparées. C'est comme avoir deux applications en une.</p>
                        <p><strong>Exemple d'utilisation :</strong></p>
                        <ul>
                            <li><strong>Comptabilité A (Personnelle) :</strong> Gérez votre salaire, vos dépenses quotidiennes, votre épargne... votre vie.</li>
                            <li><strong>Comptabilité B (Projet) :</strong> Gérez les revenus et les dépenses d'une petite entreprise, d'une association de propriétaires, ou l'organisation d'un voyage de groupe. Tout est séparé et organisé !</li>
                        </ul>
                        </div>
                    </details>

                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary>🔍 <strong>Recherche Globale (Raccourci : Ctrl/Cmd + K)</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);"><p>Vous ne vous souvenez plus où vous avez noté le dîner de samedi ? Appuyez sur l'icône de la loupe (ou le raccourci clavier) et tapez "dîner". La recherche vous montrera instantanément cette transaction, le compte associé et la catégorie. C'est le moyen le plus rapide de trouver n'importe quoi !</p></div>
                    </details>

                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary>📈 <strong>Suivi PRO des Investissements</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);">
                            <p>Cela amène vos finances au niveau supérieur. Dans <strong>Réglages > Gestion des Données > Comptes</strong>, vous pouvez marquer un compte comme "investissement". Ce faisant, l'application commencera à calculer des métriques professionnelles pour celui-ci dans l'onglet Patrimoine :</p>
                            <ul>
                                <li><strong>P&L (Profits et Pertes) :</strong> Vous indique exactly combien d'argent vous avez gagné ou perdu, en euros et en pourcentage.</li>
                                <li><strong>TRI (Taux de Rentabilité Interne) :</strong> L'indicateur ultime. Il vous indique le rendement <strong>annualisé</strong> réel de votre investissement, en tenant compte non seulement de la valeur finale, mais aussi du moment et du montant des entrées et sorties de capitaux.</li>
                            </ul>
                        </div>
                    </details>
                    
                    <details class="accordion" style="margin-bottom: var(--sp-2);">
                        <summary>🔄 <strong>Importation Intelligente depuis CSV</strong></summary>
                        <div class="accordion__content" style="padding-top: var(--sp-2);">
                            <p>Vous venez d'une autre application ou vous avez vos données dans une feuille de calcul ? Pas de problème ! Allez dans <strong>Réglages > Sauvegarde > Importer CSV</strong>. Vous avez juste besoin d'un fichier avec 5 colonnes :</p>
                            <code>DATE;COMPTE;CATÉGORIE;MONTANT;DESCRIPTION</code>
                            <p>L'application est très intelligente et fera de la magie pour vous :</p>
                            <ul>
                                <li>Si un compte ou une catégorie n'existe pas, elle le crée automatiquement !</li>
                                <li><strong>Astuce PRO :</strong> Si vous mettez <code>VIREMENT</code> dans la colonne CATÉGORIE, l'application recherchera une transaction avec la même date et un montant opposé dans un autre compte et les associera comme un virement.</li>
                                <li><strong>Astuce PRO 2 :</strong> Utilisez la CATÉGORIE <code>INITIAL</code> pour définir le solde de départ d'un compte. Par exemple : "01/01/2025;Ma Banque;INITIAL;1500;Solde initial de l'année".</li>
                            </ul>
                        </div>
                    </details>

                    <p style="text-align: center; margin-top: var(--sp-5); font-style: italic; color: var(--c-on-surface-secondary);">Explorez, enregistrez et prenez le contrôle ultime de votre avenir financier !</p>
                `,
                // FIN CAMBIO
            },

            // SPANISH (DEFAULT)
            es: {
                 // Nav & Titles
                nav_home: "Inicio",
                nav_wealth: "Patrimonio",
                nav_analysis: "Análisis",
                nav_settings: "Ajustes",
                title_home: "Inicio",
                title_wealth: "Patrimonio",
                title_analysis: "Análisis",
                title_settings: "Ajustes",
                title_history: "Historial de Movimientos",

                // Login
                login_welcome: "Bienvenido de nuevo",
                login_tagline: "Inicia sesión para controlar tus finanzas.",
                login_email_placeholder: "Correo electrónico",
                login_password_placeholder: "Contraseña",
                login_forgot_password: "¿Olvidaste tu contraseña?",
                login_button: "Iniciar Sesión",
                login_no_account: "¿No tienes una cuenta?",
                login_register_link: "Regístrate aquí",
                
                // Settings
				settings_account_and_prefs: "Cuenta y Preferencias",
                settings_user_account: "Cuenta de Usuario",
                settings_logged_in_as: "Sesión iniciada como:",
                settings_logout: "Cerrar Sesión",
                settings_delete_account: "Eliminar Mi Cuenta Permanentemente",
                settings_appearance: "Apariencia",
                settings_language: "Idioma",
                settings_theme_selector: "Selector de Tema",
                settings_general: "Configuración General",
                settings_startup_options: "Opciones de Arranque",
                settings_skip_intro: "Omitir intro y cita al iniciar la app",
                settings_save_config: "Guardar Configuración",
                settings_data_management: "Gestión de Datos",
                settings_recalculate_balances: "Recalcular Saldos de Cuentas",
                settings_backup: "Copia de Seguridad",
                settings_backup_warning: "La importación de JSON o CSV reemplazará todos los datos actuales. Se recomienda exportar primero para tener una copia de seguridad.",
                settings_export_json: "Exportar JSON",
                settings_import_json: "Importar JSON",
                settings_import_csv: "Importar CSV",
                settings_delete_all_data: "Borrar Todos los Datos",

                // Tooltips
                tooltip_toggle_ledger: "Cambiar entre contabilidad Personal (A) y Secundaria (B)",
                tooltip_add_movement: "Añadir Movimiento",
                tooltip_close: "Cerrar",
                tooltip_manage_concepts: "Gestionar Conceptos",
                tooltip_manage_accounts: "Gestionar Cuentas",
                tooltip_save_movement: "Guardar Movimiento",
                tooltip_delete: "Borrar",
                tooltip_duplicate: "Duplicar",
                tooltip_export_json: "Exportar una copia de seguridad completa en formato JSON.",
                tooltip_import_json: "Importar desde un archivo de seguridad JSON.",
                
                // Forms & Modals
                form_type_movement: "Ingreso/Gasto",
                form_type_transfer: "Traspaso",
                form_amount: "Cantidad",
                form_amount_placeholder: "Ej: -2,50",
                form_description: "Descripción",
                form_description_placeholder: "Ej: Compra semanal",
                form_source_account: "Cuenta Origen",
                form_destination_account: "Cuenta Destino",
                form_show_all_accounts: "Mostrar cuentas de ambas contabilidades (A y B)",
                form_schedule_recurrent: "¿Programar como recurrente?",
                form_frequency: "Frecuencia",
                form_next_execution: "Próxima ejecución",
                form_ends_on: "Finaliza el (opcional)",
                form_date: "Fecha",
                
                // Frequencies
                freq_daily: "Diaria",
                freq_weekly: "Semanal",
                freq_monthly: "Mensual",
                freq_yearly: "Anual",

                // Empty States
                empty_history_title: "Tu historial empieza aquí",
                empty_history_text: "Pulsa el botón `+` para añadir tu primer ingreso o gasto.",
                budget_empty_title: "Define tu Plan Financiero",
                budget_empty_text: "Establece límites de gasto y metas de ingreso para tomar el control de tu año. ¡Empieza ahora!",
                budget_empty_cta: "Crear Presupuestos",

                // Search
                search_placeholder: "Buscar en toda la app...",
                search_empty_title: "Encuéntralo todo",
                search_empty_text: "Busca movimientos, cuentas o conceptos. <br>Atajo: <strong>Cmd/Ctrl + K</strong>",

                // Tour
                tour_skip: "Saltar",
                tour_previous: "Anterior",
                tour_next: "Siguiente",
                
                // Common Words
                common_accounts: "Cuentas",
                common_concepts: "Conceptos",
                common_recurrent: "Recurrentes",
                common_account: "Cuenta",
                common_concept: "Concepto",
                common_save: "Guardar",
                common_back: "Atrás",
                common_finish: "Finalizar",
                common_import_replace: "Importar y Reemplazar",
                common_importing: "Importando...",
                common_importing_desc: "Estamos guardando tus datos. Por favor, no cierres esta ventana.",
                common_irreversible: "Atención:",
                common_irreversible_desc: "Esta acción es irreversible.",

                // JSON Wizard
                json_wizard_title: "Asistente de Importación JSON",
                json_wizard_step1_title: "Paso 1: Selecciona tu copia de seguridad",
                json_wizard_step1_desc: "Arrastra y suelta el archivo <code>.json</code> o haz clic para seleccionarlo. La importación reemplazará <strong>todos</strong> tus datos actuales.",
                json_wizard_dropzone: "Arrastra tu archivo aquí o haz clic",
                json_wizard_step2_title: "Paso 2: Revisa y confirma",
                json_wizard_step2_desc: "Hemos analizado tu archivo. Si los datos son correctos, pulsa 'Importar' para reemplazar tus datos actuales.",
                import_complete_title: "¡Importación Completada!",

                // Customize Panel
                customize_panel_title: "Personalizar Panel",
                customize_panel_desc: "Activa, desactiva y reordena los elementos que quieres ver en tu panel de control.",
                customize_panel_save: "Guardar Cambios",
				// Puedes crear una nueva sección para esto
				help_topics: "Temas de Ayuda",
				help_topic_tir_title: "TIR (Tasa Interna de Retorno)",
help_topic_tir_content: "<p>La TIR es la métrica de rentabilidad más precisa.</p><p>Te dice el <strong>beneficio anualizado real</strong> de tu inversión, como si fuera el tipo de interés que te daría un banco. Es inteligente porque tiene en cuenta no solo cuánto ha crecido tu dinero, sino también <strong>cuándo y cuánto capital</strong> has ido aportando o retirando a lo largo del tiempo.</p>",
help_topic_pace_title: "Ritmo del Presupuesto (Pace)",
help_topic_pace_content: "<p>El 'Pace' o ritmo te ayuda a saber si vas por el buen camino para cumplir tu presupuesto anual.</p><p>Compara el porcentaje de tu presupuesto que has consumido hasta hoy con el porcentaje del año que ya ha transcurrido. Por ejemplo, si a mitad de año (50% del tiempo) has gastado el 75% de tu presupuesto anual para 'Ocio', tu ritmo indicará que vas 'Excedido'.</p>",
                // INICIO CAMBIO: Ayuda en Español
                help_title: "Guía de Usuario Definitiva",
                help_content: `
                    <div style="text-align: center; margin-bottom: var(--sp-4);">
    <span class="material-icons" style="font-size: 48px; color: var(--c-primary);">school</span>
    <h3>¡Bienvenido a tu Centro de Mando Financiero!</h3>
</div>
<p>¡Hola! Prepárate para tomar el control de tu dinero como nunca antes. Esta guía está diseñada para convertirte en un experto de tus propias finanzas, explicando cada rincón de la aplicación de una forma clara y entretenida. ¡Vamos allá!</p>

<h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">explore</span>Un Paseo por la Nueva Interfaz</h3>
<p>Hemos organizado la aplicación en cuatro pestañas principales para que todo sea más intuitivo. Piensa en ellas como los departamentos de tu empresa financiera personal:</p>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary><span class="material-icons" style="margin-right:8px">home</span><strong>1. Inicio: Tu Centro de Operaciones Diario</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>Aquí es donde pasarás la mayor parte del tiempo. Es el pulso de tu actividad financiera diaria. Tienes dos vistas geniales:</p>
        <ul>
            <li><strong>Vista "Recientes":</strong> Como el feed de tus redes sociales, pero con tu dinero. Verás al instante tus últimos gastos, ingresos y traspasos. Es perfecta para saber qué ha pasado hoy o ayer.</li>
            <li><strong>Vista "Resumen":</strong> ¿Quieres saber cómo va el mes? Cambia a esta vista y obtendrás un análisis de alto nivel con:
                <ul>
                    <li><strong>KPIs (Indicadores Clave):</strong> Tus ingresos, gastos y, lo más importante, el <strong>saldo neto</strong>. ¡Incluso te dice si vas mejor o peor que el mes pasado!</li>
                    <li><strong>Gráficos por Concepto:</strong> Un desglose visual y súper fácil de entender sobre a dónde se va tu dinero (comida, ocio, facturas...) y de dónde viene.</li>
                </ul>
            </li>
        </ul>
        <p><strong>Ejemplo práctico:</strong> Acabas de empezar el mes. Usas la vista "Recientes" para registrar tu compra del súper. A mitad de mes, cambias a "Resumen" para ver si estás gastando más de la cuenta en "Restaurantes" y ajustar tus planes para las próximas semanas.</p>
    </div>
</details>
                
<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary><span class="material-icons" style="margin-right:8px">account_balance</span><strong>2. Patrimonio: Tu Fotografía Financiera</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>Esta sección es tu "foto de la riqueza". Te muestra todo lo que tienes y dónde lo tienes, dándote una visión clara de tu salud financiera global.</p>
        <ul>
            <li><strong>Patrimonio Neto:</strong> El número más importante, arriba del todo. Te dice el valor total de tus posesiones.</li>
            <li><strong>Listado de Cuentas:</strong> Aquí verás todas tus cuentas (bancos, efectivo, tarjetas...) agrupadas por tipo. Puedes usar los filtros para, por ejemplo, ver solo el dinero que tienes en bancos.</li>
            <li><strong>Cartera de Inversión:</strong> Un apartado de lujo para tus activos de inversión. No solo te dice cuánto valen, sino cómo están rindiendo.</li>
        </ul>
        <p><strong>Ejemplo práctico:</strong> Quieres saber cuánto dinero "líquido" tienes disponible. Vas a Patrimonio, filtras para ver solo "Banco" y "Efectivo", y el número de "Patrimonio Neto" te dará la respuesta al instante.</p>
    </div>
</details>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary><span class="material-icons" style="margin-right:8px">analytics</span><strong>3. Análisis: El Laboratorio del Estratega</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>Aquí es donde te pones el sombrero de estratega. Miras al pasado para tomar mejores decisiones en el futuro.</p>
        <ul>
            <li><strong>Presupuestos:</strong> ¡Tu plan de batalla! Define cuánto quieres gastar (o ingresar) en cada categoría durante el año. La app te mostrará con barras de progreso si te estás ciñendo al plan o si necesitas apretarte el cinturón.</li>
            <li><strong>Informes Personalizados:</strong> Eres el detective de tus finanzas. ¿Quieres saber cuánto gastaste en gasolina el trimestre pasado usando solo una tarjeta de crédito específica? Aquí puedes generar ese informe con gráficos y todo.</li>
        </ul>
        <p><strong>Ejemplo práctico:</strong> Creas un presupuesto de 200€ al mes para "Ocio". A final de mes, en la sección de Presupuestos, ves que has gastado 250€. La barra de progreso estará en rojo, avisándote de que te has pasado un 25%.</p>
    </div>
</details>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary><span class="material-icons" style="margin-right:8px">settings</span><strong>4. Ajustes: La Sala de Máquinas</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);"><p>El centro de control. Aquí personalizas la app (¡prueba los temas de colores!), gestionas tus datos base (crear/editar Cuentas y Conceptos) y, muy importante, haces tus copias de seguridad.</p></div>
</details>

<h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">stars</span>Funciones Estrella que Debes Conocer</h3>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary>🚀 <strong>Contabilidad Dual (A/B): Tu Superpoder Secreto</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);"><p>El botón <strong>[A]/[B]</strong> de la esquina superior izquierda es mágico. Te permite llevar dos contabilidades totalmente separadas. Es como tener dos aplicaciones en una.</p>
    <p><strong>Ejemplo de uso:</strong></p>
    <ul>
        <li><strong>Contabilidad A (Personal):</strong> Gestionas tu nómina, tus gastos diarios, tus ahorros... tu vida.</li>
        <li><strong>Contabilidad B (Proyecto):</strong> Gestionas los ingresos y gastos de un pequeño negocio, de las cuentas de la comunidad de vecinos, o de la organización de un viaje en grupo. ¡Todo separado y ordenado!</li>
    </ul>
    </div>
</details>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary>🔍 <strong>Búsqueda Global (Atajo: Ctrl/Cmd + K)</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);"><p>¿No recuerdas dónde apuntaste la cena del sábado? Pulsa el icono de la lupa (o el atajo de teclado) y escribe "cena". La búsqueda te mostrará al instante ese movimiento, la cuenta relacionada y el concepto. ¡Es la forma más rápida de encontrar cualquier cosa!</p></div>
</details>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary>📈 <strong>Seguimiento PRO de Inversiones</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>Esto lleva tus finanzas al siguiente nivel. En <strong>Ajustes > Gestión de Datos > Cuentas</strong>, puedes marcar una cuenta como "de inversión". Al hacerlo, la app empezará a calcular métricas profesionales para ella en la pestaña de Patrimonio:</p>
        <ul>
            <li><strong>P&L (Ganancias y Pérdidas):</strong> Te dice exactamente cuánto dinero has ganado o perdido, tanto en euros como en porcentaje.</li>
            <li><strong>TIR (Tasa Interna de Retorno):</strong> El indicador definitivo. Te dice la rentabilidad <strong>anualizada</strong> real de tu inversión, teniendo en cuenta no solo el valor final, sino cuándo y cuánto dinero has ido metiendo o sacando.</li>
        </ul>
    </div>
</details>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary>🔄 <strong>Importación Inteligente desde CSV</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>¿Vienes de otra app o tienes tus datos en una hoja de cálculo? ¡No hay problema! Ve a <strong>Ajustes > Copia de Seguridad > Importar CSV</strong>. Solo necesitas un archivo con 5 columnas:</p>
        <code>FECHA;CUENTA;CONCEPTO;IMPORTE;DESCRIPCIÓN</code>
        <p>La app es muy lista y hará magia por ti:</p>
        <ul>
            <li>Si una cuenta o concepto no existe, ¡lo crea automáticamente!</li>
            <li><strong>Truco PRO:</strong> Si en la columna CONCEPTO pones <code>TRASPASO</code>, la app buscará un movimiento de la misma fecha e importe contrario en otra cuenta y los emparejará como una transferencia.</li>
            <li><strong>Truco PRO 2:</strong> Usa el CONCEPTO <code>INICIAL</code> para establecer el saldo de partida de una cuenta. Por ejemplo: "01/01/2025;Mi Banco;INICIAL;1500;Saldo inicial del año".</li>
        </ul>
    </div>
</details>

<p style="text-align: center; margin-top: var(--sp-5); font-style: italic; color: var(--c-on-surface-secondary);">¡Explora, registra y toma el control definitivo de tu futuro financiero!</p>
                `,
                // FIN CAMBIO
            }
        };
        let currentLanguage = localStorage.getItem('appLanguage') || 'es';
        const locales = { es: 'es-ES', en: 'en-US', fr: 'fr-FR' };

        /**
         * Función principal de traducción.
         * @param {string} key - La clave del string a traducir.
         * @param {object} replacements - Un objeto con valores para reemplazar placeholders.
         * @returns {string} El string traducido.
         */
        const t = (key, replacements = {}) => {
            const lang = translations[currentLanguage] || translations.es;
            let text = lang[key] || translations.es[key] || `[${key}]`;

            for (const placeholder in replacements) {
                text = text.replace(`{${placeholder}}`, replacements[placeholder]);
            }
            return text;
        };
        
        // =================================================================================
        // 1. STATE & GLOBAL VARIABLES (CORREGIDO)
        // =================================================================================
        
        // --- CONSTANTES DE LA APLICACIÓN ---
        // INICIO CAMBIO: Reestructuración de constantes de página para el nuevo modelo de 4 pestañas
        const PAGE_IDS = {
            INICIO: 'inicio-page',
            PATRIMONIO: 'patrimonio-page',
            ANALISIS: 'analisis-page',
            CONFIGURACION: 'configuracion-page',
            MOVIMIENTOS_FULL: 'movimientos-page-full', // Vista especial para el historial completo
        };
        // FIN CAMBIO
		// ... Al inicio del script, junto a las otras constantes
		const THEMES = {
    'default': { name: 'Amoled Futurista', icon: 'dark_mode' },
    'crystal': { name: 'Ciber Cristal', icon: 'flare' }
};
        const quotesData = [ { "cita": "Los inversores conservadores duermen bien.", "autor": "Benjamin Graham" }, { "cita": "Nunca asciendas a alguien que no ha cometido errores, porque si lo haces, estás ascendiendo a alguien que nunca ha hecho nada.", "autor": "Benjamin Graham" }, { "cita": "Si se han hecho los deberes antes de comprar una acción, el momento de venderla es: normalmente, nunca.", "autor": "Benjamin Graham" }, { "cita": "Mientras que el entusiasmo é necesario para conseguir grandes logros en cualquier lugar, en Wall Street suele conducir al desastre.", "autor": "John Templeton" }, { "cita": "Sin tener fe en el futuro, nadie invertiría. Para ser inversor, debes creer en un mañana mejor.", "autor": "John Templeton" }, { "cita": "Las cuatro palabras más caras de nuestro lenguaje son: 'Esta vez es diferente'.", "autor": "John Templeton" }, { "cita": "Céntrate en el valor porque la mayoría de los inversores se fijan en perspectivas y tendencias.", "autor": "Peter Lynch" }, { "cita": "El éxito es un proceso de búsqueda continua de respuestas a nuevas preguntas.", "autor": "Peter Lynch" }, { "cita": "Conoce en lo que inviertes, y por qué.", "autor": "Peter Lynch" }, { "cita": "Cuando vendes en momentos de desesperación, siempre vendes barato.", "autor": "Peter Lynch" }, { "cita": "Una persona que posee una propiedad y tiene una participación en la empresa probablemente trabajará más duro, se sentirá más feliz y hará un mejor trabajo que otra que no tiene nada.", "autor": "Peter Lynch" }, { "cita": "El riesgo viene de no saber lo que se está haciendo.", "autor": "Warren Buffett" }, { "cita": "Cuesta 20 años construir una reputación y 5 minutos destruirla. Si piensas sobre ello, harás las cosas de manera diferente.", "autor": "Warren Buffett" }, { "cita": "En el mundo de los negocios, el espejo retrovisor está siempre más claro que el parabrisas.", "autor": "Warren Buffett" }, { "cita": "La inversión más importante que puedes hacer es en uno mismo.", "autor": "Warren Buffett" }, { "cita": "Sé temeroso cuando otros sean avariciosos, sé avaricioso cuando otros sean temerosos.", "autor": "Warren Buffett" }, { "cita": "Sé consciente de lo que no sabes. Siéntete a gusto entendiendo tus errores y debilidades.", "autor": "Charlie Munger" }, { "cita": "Para hacer dinero en los mercados, tienes que pensar diferente y ser humilde.", "autor": "Charlie Munger" }, { "cita": "El principal problema del inversor, e incluso su peor enemigo, es probablemente él mismo", "autor": "Benjamin Graham" }, { "cita": "Las personas que no pueden controlar sus emociones no son aptas para obtener beneficios mediante la inversión", "autor": "Benjamin Graham" }, { "cita": "Trato de comprar acciones en los negocios que son tan maravillosos que un tonto podría manejarlos. Tarde o temprano uno lo hará", "autor": "Warren Buffett" }, { "cita": "Un inversor debería actuar como si tuviera una tarjeta con solo 20 decisiones (de compra) para tomar a lo largo de su vida", "autor": "Warren Buffett" }, { "cita": "Regla número 1: nunca pierdas dinero. Regla número 2: nunca olvides la regla número 1", "autor": "Warren Buffett" }, { "cita": "Se gana dinero descontando lo obvio y apostando a lo inesperado", "autor": "George Soros" }, { "cita": "El problema no es lo que uno no sabe, sino lo que uno cree que sabe estando equivocado", "autor": "George Soros" }, { "cita": "Si invertir es entretenido, si te estás divirtiendo, probablemente no estés ganando dinero. Las buenas inversiones son aburridas", "autor": "George Soros" }, { "cita": "Se puede perder dinero a corto plazo, pero necesitas del largo plazo para ganar dinero", "autor": "Peter Lynch" }, { "cita": "La mejor empresa para comprar puede ser alguna que ya tienes en cartera", "autor": "Peter Lynch" }, { "cita": "La clave para ganar dinero con las acciones es no tenerles miedo", "autor": "Peter Lynch" }, { "cita": "Los mercados alcistas nacen en el pesimismo, crecen en el escepticismo, maduran en el optimismo y mueren en la euforia", "autor": "John Templeton" }, { "cita": "El momento de máximo pesimismo es el mejor para comprar y el momento de máximo optimismo es el mejor para vender", "autor": "John Templeton" }, { "cita": "Un inversor que tiene todas las respuestas ni siquiera entiende las preguntas", "autor": "John Templeton" }, { "cita": "La inversión es un negocio a largo plazo donde la paciencia marca la rentabilidad", "autor": "Francisco García Paramés" }, { "cita": "¿Cuándo vendemos un valor? Respondemos siempre: cuando haya una oportunidad mejor. Ese es nuestro objetivo permanente, mejorar la cartera cada día", "autor": "Francisco García Paramés" }, { "cita": "Lo que en la Bolsa saben todos, no me interesa", "autor": "André Kostolany" }, { "cita": "No sirve para nada proclamar la verdad en economía o recomendar cosas útiles. Es la mejor manera de hacerse enemigos", "autor": "André Kostolany" }, { "cita": "Un inversor pierde la capacidad de raciocinio cuando gana los primeros diez mil dólares. A partir de entonces se convierte en un pelele fácilmente manipulable", "autor": "André Kostolany" }, { "cita": "Comprar títulos, acciones de empresas, tomarse unas pastillas para dormir durante 20/30 años y cuando uno despierta, ¡voilà! es millonario", "autor": "André Kostolany" }, { "cita": "No sé si los próximos 1.000 puntos del Dow Jones serán hacia arriba o hacia abajo, pero estoy seguro de que los próximos 10.000 serán hacia arriba", "autor": "Peter Lynch" }, { "cita": "El destino de un inversor lo marca su estómago , no su cerebro", "autor": "Peter Lynch" }, { "cita": "No siga mis pasos porque aun en el caso de que acierte al comprar usted no sabrá cuando vendo", "autor": "Peter Lynch" }, { "cita": "Calcule las 'ganancias del dueño' para conseguir una reflexión verdadera del valor", "autor": "Warren Buffett" }, { "cita": "Busque compañías con altos márgenes de beneficio", "autor": "Warren Buffett" }, { "cita": "Invierta siempre para el largo plazo", "autor": "Warren Buffett" }, { "cita": "El consejo de que 'usted nunca quiebra tomando un beneficio' es absurdo", "autor": "Warren Buffett" }, { "cita": "¿El negocio tiene una historia de funcionamiento constante?", "autor": "Warren Buffett" }, { "cita": "Recuerde que el mercado de valores es maníaco-depresivo", "autor": "Benjamin Graham" }, { "cita": "Compre un negocio, no alquile la acción", "autor": "Warren Buffett" }, { "cita": "Mientras más absurdo sea el comportamiento del mercado mejor será la oportunidad para el inversor metódico", "autor": "Benjamin Graham" }, { "cita": "Se puede perder dinero a corto plazo, pero usted sigue siendo un idiota", "autor": "Joel Greenblatt" }, { "cita": "Los mercados alcistas no tienen resistencia y los bajistas no tienen soporte", "autor": "Ed Downs" }, { "cita": "El pánico causa que vendas en el bajón, y la codicia causa que compres cerca a la cima", "autor": "Stan Weinstein" }, { "cita": "Las dos grandes fuerzas que mueven los mercados son la codicia y el miedo", "autor": "Anónimo" }, { "cita": "Todo lo que sube baja y todo lo que baja sube", "autor": "Anónimo" }, { "cita": "Si no sientes miedo en el momento de comprar es que estás comprando mal", "autor": "Anónimo" }, { "cita": "Que el último duro lo gane otro", "autor": "Anónimo" }, { "cita": "La clave para hacer dinero en acciones es no asustarse de ellas", "autor": "Peter Lynch" }, { "cita": "El precio es lo que pagas, el valor es lo que recibes", "autor": "Warren Buffett" }, { "cita": "No es necesario hacer cosas extraordinarias para conseguir resultados extraordinarios", "autor": "Warren Buffett" }, { "cita": "Alguien está sentado en la sombra hoy porque alguien plantó un árbol mucho tiempo atrás", "autor": "Warren Buffett" }, { "cita": "Únicamente cuando la marea baja, descubres quién ha estado nadando desnudo", "autor": "Warren Buffett" }, { "cita": "No tenemos que ser más inteligentes que el resto, tenemos que ser más disciplinados que el resto", "autor": "Warren Buffett" }, { "cita": "Si compras cosas que no necesitas, pronto tendrás que vender cosas que necesitas", "autor": "Warren Buffett" }, { "cita": "Nunca inviertas en un negocio que no puedas entender", "autor": "Warren Buffett" }, { "cita": "El tiempo es amigo de las empresas maravillosas y enemigo de las mediocres", "autor": "Warren Buffett" }, { "cita": "Nuestro periodo de espera favorito es para siempre", "autor": "Warren Buffett" }, { "cita": "Wall Street es el único lugar al que las personas van en un Rolls-Royce, para recibir asesoría de quienes toman el metro", "autor": "Warren Buffett" }, { "cita": "Llega un momento en el que debes empezar a hacer lo que realmente quieres. Busca un trabajo que te guste y saltarás de la cama cada mañana con fuerza", "autor": "Warren Buffett" }, { "cita": "Es siempre mejor pasar el tiempo con gente mejor que tú. Escoge asociados cuyo comportamiento es mejor que el tuyo e irás en esa dirección", "autor": "Warren Buffett" }, { "cita": "Toma 20 años en construir una reputación y 5 minutos en arruinarla. Si piensas sobre ello, harás las cosas de forma diferente", "autor": "Warren Buffett" }, { "cita": "No importa el talento o los esfuerzos, hay cosas que llevan tiempo. No puedes producir un bebé en un mes dejando embarazadas a 9 mujeres", "autor": "Warren Buffett" }, { "cita": "Las oportunidades aparecen pocas veces. Cuando llueva oro sal a la calle con un cesto grande y no con un dedal", "autor": "Warren Buffett" }, { "cita": "La gente siempre me pregunta dónde deberían trabajar y yo siempre les digo que vayan a trabajar con aquellos a los que más admiran", "autor": "Warren Buffett" }, { "cita": "¿Cuándo hay que vender una acción? Pues cuando tengamos una oportunidad mejor a la vista", "autor": "Francisco García Paramés" }, { "cita": "Nunca acudo a las OPV, me gusta estar en las empresas que pueden ser opadas por competidores, no en las salidas a bolsa", "autor": "Francisco García Paramés" }, { "cita": "Si en el mercado hay más tontos que papel, la bolsa va a subir, si hay más papel que tontos, la bolsa baja", "autor": "André Kostolany" }, { "cita": "No persiga nunca una acción, tenga paciencia que la próxima oportunidad va a llegar con toda seguridad", "autor": "André Kostolany" }, { "cita": "Lo que todos saben en la bolsa, no nos interesa a los especuladores", "autor": "André Kostolany" }, { "cita": "Las inversiones exitosas consisten en saber gestionar el riesgo, no en evitarlo.", "autor": "Benjamin Graham" }, { "cita": "Una gran compañía no es una buena inversión si pagas mucho por la acción", "autor": "Benjamin Graham" }, { "cita": "A veces es mejor pensar una hora sobre el dinero que dedicar una semana a trabajar para obtenerlo.", "autor": "André Kostolany" }, { "cita": "En la Bolsa, con frecuencia, hay que cerrar los ojos para ver mejor.", "autor": "André Kostolany" }, { "cita": "Si la inversión es entretenida, si te estás divirtiendo, es probable que no estés ganando dinero. Una buena inversión es aburrida.", "autor": "George Soros" }, { "cita": "Las burbujas del mercado de valores no crecen de la nada. Tienen una base sólida en la realidad, pero la realidad está distorsionada por un malentendido.", "autor": "George Soros" }, { "cita": "Nunca digas que no puedes permitirte algo. Esa es la aptitud de un hombre pobre. Pregúntate cómo permitírtelo.", "autor": "Robert Kiyosaki" }, { "cita": "Una diferencia importante es que los ricos compran los lujos al final, mientras que los pobres y la clase media tienden a comprar los lujos primero.", "autor": "Robert Kiyosaki" }, { "cita": "Mantén tus activos bajo mínimos, reduce los pasivos y, con mucha disciplina, ve construyendo una base de activos sólida.", "autor": "Robert Kiyosaki" }, { "cita": "No ahorres lo que queda después de gastar, sino gasta lo que queda después de ahorrar.", "autor": "Warren Buffett" }, { "cita": "El riesgo viene de no saber lo que estás haciendo.", "autor": "Warren Buffett" }, { "cita": "Sea temeroso cuando otros son codiciosos, y sea codicioso cuando otros son temerosos.", "autor": "Warren Buffett" }, { "cita": "No compres cosas que no necesitas, con dinero que no tienes, para impresionar a gente que no te importa.", "autor": "Dave Ramsey" } ];
        const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };
        const AVAILABLE_WIDGETS = {
            'kpi-summary': { title: 'Resumen de KPIs', description: 'Ingresos, gastos y saldo neto del periodo.', icon: 'summarize' },
            'concept-totals': { title: 'Totales por Concepto', description: 'Gráfico y lista detallada de gastos/ingresos por concepto.', icon: 'bar_chart' }
        };
        const DEFAULT_DASHBOARD_WIDGETS = ['kpi-summary', 'concept-totals'];
        const getInitialDb = () => ({
            cuentas: [], 
            conceptos: [], 
            movimientos: [], 
            presupuestos: [],
            recurrentes: [],
            inversiones_historial: [],
            inversion_cashflows: [],
            config: { 
                skipIntro: false,
                dashboardWidgets: DEFAULT_DASHBOARD_WIDGETS
            } 
        });
        // --- ESTADO GLOBAL Y DE PAGINACIÓN ---
		let currentUser = null, unsubscribeListeners = [], db = getInitialDb(), deselectedAccountTypesFilter = new Set();
		let deselectedInvestmentTypesFilter = new Set();
		let selectedInvestmentTypeFilter = null;
		let intelligentIndex = new Map();
		// Cerca de tus otras variables globales, como currentUser, db, etc.
		let syncState = 'synced'; // Posibles estados: 'synced', 'syncing', 'error'	
        let isOffBalanceMode = false;
        let descriptionIndex = {};
		let globalSearchDebounceTimer = null;
		let newMovementIdToHighlight = null;
		let unsubscribeRecientesListener = null
        const originalButtonTexts = new Map();
        let conceptosChart = null, liquidAssetsChart = null, detailInvestmentChart = null, informesChart = null, assetAllocationChart = null;
        let currentTourStep = 0;
        let lastScrollTop = null;
        
        // --- ESTADO PARA EL ASISTENTE DE IMPORTACIÓN DE JSON ---
        let jsonWizardState = {
            file: null,
            data: null,
            preview: {
                counts: {},
                meta: {}
            }
        };
        let isInitialLoadComplete = false; // <-- AÑADE ESTA LÍNEA
        // ================== INICIO CAMBIO: Sistema de Lazy Loading ==================
        // Este objeto nos ayudará a saber qué colecciones de datos ya hemos cargado
        // para no volver a pedirlas a Firestore innecesariamente.
        let dataLoaded = {
            presupuestos: false,
            recurrentes: false,
            inversiones: false
        };
        // ================== FIN CAMBIO ==============================================
        
        // --- Variables para la paginación de movimientos ---
		const MOVEMENTS_PAGE_SIZE = 200;
        let lastVisibleMovementDoc = null; 
        let isLoadingMoreMovements = false; 
        let allMovementsLoaded = false; 
        
        let runningBalancesCache = null; // Caché para los saldos corrientes.
		let recentMovementsCache = [];
        
        const vList = {
			scrollerEl: null, sizerEl: null, contentEl: null, items: [], itemMap: [], 
			heights: {}, 
			renderBuffer: 10, lastRenderedRange: { start: -1, end: -1 }, isScrolling: null
		};
        
        let calculatorState = {
            displayValue: '0', // Always use period for decimal internally
            operand1: null, // First number in an operation
            operator: null, // Current operator (+, -, *, /)
            waitingForNewValue: true, // True if the next digit should start a new number
            targetInput: null,
            isVisible: false, 
            isResultDisplayed: false, // NEW: Tracks if a calculation result is currently displayed
        };
        // <<< CAMBIO: Variable para el debounce de las sugerencias de descripción
        let descriptionSuggestionDebounceTimer = null; 
        // <<< CAMBIO: Límite de sugerencias de descripción
        const DESCRIPTION_SUGGESTION_LIMIT = 5;
        
        // =================================================================================
// 2.1. HELPERS DE SEGURIDAD PARA EL PIN
// =================================================================================

/**
 * Convierte un PIN en un hash SHA-256 seguro para su almacenamiento.
 * @param {string} pin - El PIN de 4 dígitos.
 * @returns {Promise<string>} El hash en formato hexadecimal.
 */

/**
 * Verifica si un PIN introducido coincide con un hash almacenado.
 * @param {string} pin - El PIN introducido por el usuario.
 * @param {string} storedHash - El hash guardado en localStorage.
 * @returns {Promise<boolean>} True si coinciden, false si no.
 */

		// Añade esta nueva función en tu sección de UI UTILITIES & HELPERS

const updateSyncStatusIcon = () => {
    const iconEl = select('sync-status-icon');
    if (!iconEl) return;

    let iconName = '';
    let iconTitle = '';
    let iconClass = '';

    switch (syncState) {
        case 'syncing':
            iconName = `<span class="sync-icon-spinner">sync</span>`; // Usamos un span interno para la animación
            iconTitle = 'Sincronizando datos con la nube...';
            iconClass = 'sync-status--syncing';
            break;
        case 'error':
            iconName = 'cloud_off';
            iconTitle = 'Error de conexión. Tus cambios se guardan localmente y se sincronizarán al recuperar la conexión.';
            iconClass = 'sync-status--error';
            break;
        case 'synced':
        default:
            iconName = 'cloud_done';
            iconTitle = 'Todos los datos están guardados y sincronizados en la nube.';
            iconClass = 'sync-status--synced';
            break;
    }
    
    iconEl.innerHTML = iconName;
    iconEl.title = iconTitle;
    iconEl.className = `material-icons ${iconClass}`;
};
                const buildDescriptionIndex = () => {
            descriptionIndex = {}; // Reset index
            if (!db.movimientos || db.movimientos.length === 0) return;

            // Para mejorar el rendimiento, solo indexamos los movimientos más recientes
            const movementsToIndex = db.movimientos.slice(0, 500); 

            movementsToIndex.forEach(mov => {
                const desc = mov.descripcion.trim().toLowerCase();
                if (desc.length > 3) { // Solo indexar descripciones significativas
                    if (!descriptionIndex[desc]) {
                        descriptionIndex[desc] = {
                            conceptoId: mov.conceptoId,
                            count: 0
                        };
                    }
                    descriptionIndex[desc].count++;
                }
            });
        };
               
    
        // =================================================================================
        // 2. FIREBASE & DATA HANDLING (REFACTORIZADO PARA PAGINACIÓN Y CONSULTAS EFICIENTES)
        // =================================================================================
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        fbAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        const fbDb = firebase.firestore();
        
        fbDb.enablePersistence({synchronizeTabs: true}).catch(err => {
            if (err.code == 'failed-precondition') showToast('Modo offline no disponible (múltiples pestañas).', 'warning');
            else if (err.code == 'unimplemented') showToast('Navegador no soporta modo offline.', 'warning');
        });
        
        // --- NUEVOS ASISTENTES DE FIRESTORE ---
        // REEMPLAZA tu función saveDoc con esta:
async function saveDoc(collectionName, docId, data, btn = null) {
    if (!currentUser) { showToast("Error: No hay usuario.", "danger"); return; }
    if (btn) setButtonLoading(btn, true);

    syncState = 'syncing';
    updateSyncStatusIcon();

    try {
        const docRef = fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(docId);
        await docRef.set(data, { merge: true });
        
        // Espera a que los datos se confirmen en el servidor (opcional pero recomendado para precisión)
        await fbDb.waitForPendingWrites();

        syncState = 'synced';
        
    } catch (error) {
        console.error(`Error guardando en ${collectionName}:`, error);
        showToast("Error al guardar.", "danger");
        syncState = 'error';
    } finally {
        if (btn) setButtonLoading(btn, false);
        updateSyncStatusIcon();
    }
}


        /**
         * Actualiza el saldo de una cuenta de forma atómica.
         * @param {string} cuentaId - El ID de la cuenta a actualizar.
         * @param {number} amountInCents - La cantidad a sumar (positivo para ingresos, negativo para gastos).
         */
        async function updateAccountBalance(cuentaId, amountInCents) {
            if (!currentUser || !cuentaId || typeof amountInCents !== 'number') {
                console.error("Argumentos inválidos para updateAccountBalance");
                return;
            }

            try {
                const accountRef = fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(cuentaId);
                // FieldValue.increment es una operación atómica del lado del servidor.
                // Es la forma más segura y eficiente de actualizar contadores.
                await accountRef.update({
                    saldo: firebase.firestore.FieldValue.increment(amountInCents)
                });
            } catch (error) {
                console.error(`Error al actualizar saldo de la cuenta ${cuentaId}:`, error);
                showToast("Error crítico: no se pudo actualizar el saldo.", "danger");
            }
        }
        
/**
 * Script de migración de un solo uso para calcular y guardar el saldo inicial
 * en cada documento de cuenta. EJECUTAR UNA SOLA VEZ DESDE LA CONSOLA.
 */
async function migrateBalancesToAccounts() {
    if (!currentUser) {
        console.error("Debes iniciar sesión para ejecutar la migración.");
        return;
    }
    console.log("🚀 Iniciando migración de saldos...");

    // Usamos fbDb, que es nuestra instancia de Firestore en el cliente.
    const userRef = fbDb.collection('users').doc(currentUser.uid);

    // 1. Obtener todas las cuentas y resetear sus saldos a 0.
    const cuentasSnapshot = await userRef.collection('cuentas').get();
    const cuentas = {};
    cuentasSnapshot.forEach(doc => {
        cuentas[doc.id] = { ref: doc.ref, saldo: 0 };
    });

            const movimientosSnapshot = await userRef.collection('movimientos').get();
            console.log(`Procesando ${movimientosSnapshot.size} movimientos...`);
            movimientosSnapshot.forEach(doc => {
                const mov = doc.data();
                if (mov.tipo === 'traspaso') {
                    if (cuentas[mov.cuentaOrigenId]) cuentas[mov.cuentaOrigenId].saldo -= mov.cantidad;
                    if (cuentas[mov.cuentaDestinoId]) cuentas[mov.cuentaDestinoId].saldo += mov.cantidad;
                } else {
                    if (cuentas[mov.cuentaId]) cuentas[mov.cuentaId].saldo += mov.cantidad;
                }
            });

            const batch = fbDb.batch(); 
            for (const cuentaId in cuentas) {
                const cuentaData = cuentas[cuentaId];
                batch.update(cuentaData.ref, { saldo: cuentaData.saldo });
            }

            await batch.commit();
            console.log(`🎉 ¡Migración completada! Se actualizaron los saldos de ${Object.keys(cuentas).length} cuentas.`);
            alert("¡Migración de saldos completada! La aplicación ahora usará los saldos en tiempo real. Por favor, recarga la página para ver los cambios.");
        }
        window.migrateBalancesToAccounts = migrateBalancesToAccounts;
        
        async function deleteDoc(collectionName, docId) {
    if (!currentUser) { showToast("Error: No hay usuario.", "danger"); return; }
    
    syncState = 'syncing';
    updateSyncStatusIcon();

    try {
        await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(docId).delete();
        await fbDb.waitForPendingWrites();
        syncState = 'synced';
    } catch (error) {
        console.error(`Error borrando de ${collectionName}:`, error);
        showToast("Error al borrar.", "danger");
        syncState = 'error';
    } finally {
        updateSyncStatusIcon();
    }
}
        
        // ================== INICIO CAMBIO: Implementación de Lazy Loading ==================
        // --- FUNCIÓN DE CARGA PRINCIPAL REFACTORIZADA ---
        async function loadCoreData(uid) {
            // Limpia listeners anteriores si existen
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            
            // Resetea los flags de datos cargados
            dataLoaded = { presupuestos: false, recurrentes: false, inversiones: false };

            const userRef = fbDb.collection('users').doc(uid);

            // 1. Cargar solo los datos ESENCIALES al inicio
            const collectionsToLoadInitially = ['cuentas', 'conceptos'];

            collectionsToLoadInitially.forEach(collectionName => {
                const unsubscribe = userRef.collection(collectionName).onSnapshot(snapshot => {
                    db[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Solo estas dos colecciones son necesarias para los dropdowns iniciales
                    populateAllDropdowns();
                    
                    if (select(PAGE_IDS.INICIO)?.classList.contains('view--active')) {
                        _renderRecientesFromCache();
                    }

                    if (select(PAGE_IDS.PATRIMONIO)?.classList.contains('view--active')) {
                        renderPatrimonioPage();
                    }
                }, error => {
                    console.error(`Error escuchando ${collectionName}: `, error);
                    showToast(`Error al cargar ${collectionName}.`, "danger");
                });
                unsubscribeListeners.push(unsubscribe);
            });

            // 2. La configuración también es esencial
            const unsubConfig = userRef.onSnapshot(doc => {
                db.config = doc.exists && doc.data().config ? doc.data().config : getInitialDb().config;
                localStorage.setItem('skipIntro', (db.config && db.config.skipIntro) || 'false');
                loadConfig();
            }, error => {
                console.error("Error escuchando la configuración del usuario: ", error);
                showToast("Error al cargar la configuración.", "danger");
            });
            unsubscribeListeners.push(unsubConfig);
			                        
            // Ya no se cargan todos los movimientos, solo se construye el índice si hay datos iniciales
            buildDescriptionIndex();
            startMainApp();
        };

        // 3. Nuevas funciones para cargar datos bajo demanda (Lazy Loading)
        async function loadRecurrentes() {
            if (dataLoaded.recurrentes || !currentUser) return;
            console.log("Lazy loading: Cargando recurrentes...");
            const unsub = fbDb.collection('users').doc(currentUser.uid).collection('recurrentes').onSnapshot(snapshot => {
                db.recurrentes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Si estamos en la página de inicio, re-renderizamos el widget de recurrentes pendientes
                const activePage = document.querySelector('.view--active');
                if (activePage && activePage.id === PAGE_IDS.INICIO) {
                    renderPendingRecurrents();
                }
            }, err => console.error("Error al cargar recurrentes:", err));
            unsubscribeListeners.push(unsub);
            dataLoaded.recurrentes = true;
        }

        async function loadPresupuestos() {
            if (dataLoaded.presupuestos || !currentUser) return;
            console.log("Lazy loading: Cargando presupuestos...");
            const unsub = fbDb.collection('users').doc(currentUser.uid).collection('presupuestos').onSnapshot(snapshot => {
                db.presupuestos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Si estamos en la página de análisis, re-renderizamos los presupuestos
                const activePage = document.querySelector('.view--active');
                if (activePage && activePage.id === PAGE_IDS.ANALISIS) {
                    renderBudgetTracking();
                }
            }, err => console.error("Error al cargar presupuestos:", err));
            unsubscribeListeners.push(unsub);
            dataLoaded.presupuestos = true;
        }

        async function loadInversiones() {
            if (dataLoaded.inversiones || !currentUser) return;
            console.log("Lazy loading: Cargando datos de inversión...");

            const coleccionesInversion = ['inversiones_historial', 'inversion_cashflows'];
            
            coleccionesInversion.forEach(collectionName => {
                const unsub = fbDb.collection('users').doc(currentUser.uid).collection(collectionName).onSnapshot(snapshot => {
                    // 1. Actualiza el estado global con los nuevos datos.
                    db[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // 2. Marca los datos como cargados.
                    dataLoaded.inversiones = true;

                    // 3. Comprueba cuál es la página activa en este momento.
                    const activePageEl = document.querySelector('.view--active');
                    const activePage = activePageEl ? activePageEl.id : null;
                    
                    // 4. Si el usuario está viendo la página de Análisis, ordena un re-renderizado COMPLETO de esa página.
                    if (activePage === PAGE_IDS.ANALISIS) {
                        console.log("Datos de inversión recibidos. Re-renderizando la página de Análisis.");
                        renderAnalisisPage();
                    }
                    
                    // 5. Haz lo mismo para la página de Patrimonio si estuviera activa.
                    if (activePage === PAGE_IDS.PATRIMONIO) {
                        renderPatrimonioPage();
                    }
                    
                }, err => console.error(`Error al cargar ${collectionName}:`, err));
                
                unsubscribeListeners.push(unsub);
            });
        }
        // ================== FIN CAMBIO ===================================================

    const checkAuthState = () => {
            fbAuth.onAuthStateChanged((user) => {
                if (user) {
                    const storedPinHash = localStorage.getItem('pinUserHash');
                    const storedPinEmail = localStorage.getItem('pinUserEmail');

                    // Si existe un PIN guardado para este usuario, mostramos la pantalla de PIN.
                    if (storedPinHash && storedPinEmail === user.email) {
                        showPinScreen(user);
                    } else {
                        // Si no, procedemos al arranque normal de la app.
                        currentUser = user;
                        loadCoreData(user.uid);
                    }
                } else {
                    currentUser = null;
                    unsubscribeListeners.forEach(unsub => unsub());
                    unsubscribeListeners = [];
                    db = getInitialDb();
                    showLoginScreen();
                }
            });
        };

        // =================================================================================
        // 2.5. LÓGICA DE MOVIMIENTOS RECURRENTES
        // =================================================================================
        const calculateNextDueDate = (currentDueDate, frequency) => {
            const d = new Date(currentDueDate);
            d.setHours(12, 0, 0, 0); 
        
            // Ya no necesitamos la línea "const { ... } = window.dateFns;"
            // Las funciones 'addDays', etc., están directamente disponibles gracias al 'import'.
            switch (frequency) {
                case 'daily': return addDays(d, 1);
                case 'weekly': return addWeeks(d, 1);
                case 'monthly': return addMonths(d, 1);
                case 'yearly': return addYears(d, 1);
                default: return d;
            }
        };
        
        // =================================================================================
		// 3. UI UTILITIES & HELPERS
		// =================================================================================
		const select = (id) => document.getElementById(id);
		const selectAll = (s) => document.querySelectorAll(s);
		const selectOne = (s) => document.querySelector(s);
        
        const applyStaticTranslations = () => {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                el.textContent = t(key);
            });
             document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.dataset.i18nPlaceholder;
                el.placeholder = t(key);
            });
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.dataset.i18nTitle;
                el.title = t(key);
            });
        };

		// === INICIO DE LA CORRECCIÓN ===
		// Pega la función aquí, en el ámbito global, para que todos puedan usarla.
		const chunkArray = (array, size) => {
			const chunks = [];
			for (let i = 0; i < array.length; i += size) {
				chunks.push(array.slice(i, i + size));
			}
			return chunks;
		};
		// La función original ahora está limpia
		const measureListItemHeights = () => {
			const container = select('movimientos-list-container');
			if (!container) return;

            // Usamos un HTML simple y autocontenido en lugar de depender de datos
            const tempTransaction = document.createElement('div');
            tempTransaction.className = 'transaction-card';
            tempTransaction.style.position = 'absolute';
            tempTransaction.style.visibility = 'hidden';
            tempTransaction.innerHTML = `
                <div class="transaction-card__indicator transaction-card__indicator--expense"></div>
                <div class="transaction-card__content">
                    <div class="transaction-card__details">
                        <div class="transaction-card__row-1">Medición de Altura</div>
                        <div class="transaction-card__row-2">Esto es solo para medir</div>
                    </div>
                    <div class="transaction-card__figures">
                        <div class="transaction-card__amount">1,00 €</div>
                        <div class="transaction-card__balance">1,00 €</div>
                    </div>
                </div>`;
            container.appendChild(tempTransaction);
            vList.heights.transaction = tempTransaction.offsetHeight;
            container.removeChild(tempTransaction);

            const tempTransfer = document.createElement('div');
            tempTransfer.className = 'transaction-card';
            tempTransfer.style.position = 'absolute';
            tempTransfer.style.visibility = 'hidden';
            tempTransfer.innerHTML = `
                <div class="transaction-card__indicator transaction-card__indicator--transfer"></div>
                <div class="transaction-card__content">
                     <div class="transaction-card__details">
                        <div class="transaction-card__concept">Medición Traspaso</div>
                        <div class="transaction-card__description">Fecha</div>
                        <div class="transaction-card__transfer-details">
                            <div class="transaction-card__transfer-row"><span>Origen</span></div>
                            <div class="transaction-card__transfer-row"><span>Destino</span></div>
                        </div>
                    </div>
                </div>`;
            container.appendChild(tempTransfer);
            vList.heights.transfer = tempTransfer.offsetHeight;
            container.removeChild(tempTransfer);

            const tempHeader = document.createElement('div');
            tempHeader.className = 'movimiento-date-header';
            tempHeader.style.position = 'absolute';
            tempHeader.style.visibility = 'hidden';
            tempHeader.innerHTML = `<span>FECHA</span><span>TOTAL</span>`;
            container.appendChild(tempHeader);
            vList.heights.header = tempHeader.offsetHeight;
            container.removeChild(tempHeader);

            console.log('Alturas de elementos medidas (CORREGIDO):', vList.heights);
        };
        const hapticFeedback = (type = 'light') => {
            if ('vibrate' in navigator) {
                try {
                    let pattern;
                    switch (type) {
                        case 'light':   pattern = 10; break;
                        case 'medium':  pattern = 25; break;
                        case 'success': pattern = [15, 60, 15]; break;
                        case 'warning': pattern = [30, 40, 30]; break;
                        case 'error':   pattern = [50, 50, 50]; break;
                        default:        pattern = 10;
                    }
                    navigator.vibrate(pattern);
                } catch (e) {}
            }
        };

        const parseDateStringAsUTC = (dateString) => {
            if (!dateString) return null;
            return new Date(dateString + 'T12:00:00Z');
        };

        const generateId = () => fbDb.collection('users').doc().id;
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const formatCurrency = (numInCents) => {
            const number = (numInCents || 0) / 100;
            return new Intl.NumberFormat(locales[currentLanguage], { style: 'currency', currency: 'EUR' }).format(number);
        };
        const toSentenceCase = (str) => {
			if (!str || typeof str !== 'string') return '';
			return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
		};
		const showToast = (message, type = 'default', duration = 3000) => {
            const c = select('toast-container'); if (!c) return;
            const t = document.createElement('div');
            t.className = `toast toast--${type}`;
            c.appendChild(t); // Append first to make it visible and get computed style

            // Animate in
            const fadeIn = t.animate([ { transform: 'translateY(20px) scale(0.95)', opacity: 0 }, { transform: 'translateY(0) scale(1)', opacity: 1 } ], { duration: 300, easing: 'ease-out' });
        
            fadeIn.onfinish = () => {
                t.textContent = message; // Set text after visible to avoid FOUC
                t.classList.add(`toast--${type}`); // Apply type classes after appending
                if (type === 'danger' || type === 'error') hapticFeedback('error');
                else if (type === 'warning') hapticFeedback('warning');

                // Animate out after duration
                setTimeout(() => {
                    t.animate([ { opacity: 1 }, { opacity: 0 } ], { duration: 300, easing: 'ease-in' }).onfinish = () => t.remove();
                }, duration - 600); // 600ms = 300ms fadeIn + 300ms fadeOut
            };
        };
        const setButtonLoading = (btn, isLoading, text = 'Cargando...') => {
            if (!btn) return;
            if (isLoading) { if (!originalButtonTexts.has(btn)) originalButtonTexts.set(btn, btn.innerHTML); btn.setAttribute('disabled', 'true'); btn.classList.add('btn--loading'); btn.innerHTML = `<span class="spinner"></span> <span>${text}</span>`;
            } else { btn.removeAttribute('disabled'); btn.classList.remove('btn--loading'); if (originalButtonTexts.has(btn)) { btn.innerHTML = originalButtonTexts.get(btn); originalButtonTexts.delete(btn); } }
        };
        const displayError = (id, msg) => { const err = select(`${id}-error`); if (err) { err.textContent = msg; err.setAttribute('role', 'alert'); } const inp = select(id); if (inp) inp.classList.add('form-input--invalid'); };
        const clearError = (id) => { const err = select(`${id}-error`); if (err) { err.textContent = ''; err.removeAttribute('role'); } const inp = select(id); if (inp) inp.classList.remove('form-input--invalid'); };
        const clearAllErrors = (formId) => { const f = select(formId); if (!f) return; f.querySelectorAll('.form-error').forEach((e) => e.textContent = ''); f.querySelectorAll('.form-input--invalid').forEach(e => e.classList.remove('form-input--invalid')); };
        const animateCountUp = (el, end, duration = 700, formatAsCurrency = true, prefix = '', suffix = '') => {
            if (!el) return;
            const start = parseFloat(el.dataset.currentValue || '0');
            const endValue = end / 100;
            if (start === endValue || !el.offsetParent) { el.textContent = formatAsCurrency ? formatCurrency(end) : `${prefix}${end}${suffix}`; el.dataset.currentValue = String(endValue); return; }
            el.dataset.currentValue = String(endValue); let startTime = null;
            const step = (timestamp) => { if (!startTime) startTime = timestamp; const p = Math.min((timestamp - startTime) / duration, 1); const current = p * (end - start*100) + start*100; el.textContent = formatAsCurrency ? formatCurrency(current) : `${prefix}${current.toFixed(2)}${suffix}`; if (p < 1) requestAnimationFrame(step); else el.textContent = formatAsCurrency ? formatCurrency(end) : `${prefix}${end/100}${suffix}`; };
            requestAnimationFrame(step);
        };
        const escapeHTML = str => (str || '').replace(/[&<>"']/g, match => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[match]);
        
        const parseCurrencyString = (str) => {
            if (typeof str !== 'string' || !str.trim()) return NaN;
            
            let cleanStr = str.replace(/[€$£\s]/g, '');

            const hasComma = cleanStr.includes(',');
            const hasPeriod = cleanStr.includes('.');

            if (hasComma && hasPeriod) {
                if (cleanStr.lastIndexOf(',') > cleanStr.lastIndexOf('.')) {
                    cleanStr = cleanStr.replace(/\./g, '').replace(',', '.');
                } else {
                    cleanStr = cleanStr.replace(/,/g, '');
                }
            } else if (hasComma) {
                cleanStr = cleanStr.replace(',', '.');
            }
            
            return parseFloat(cleanStr);
        };
		const showPinScreen = (user) => {
            currentUser = user; // Guardamos el usuario autenticado
            const pinScreen = select('pin-login-screen');
            const loginScreen = select('login-screen');
            const appRoot = select('app-root');

            if (appRoot) appRoot.classList.remove('app-layout--visible');
            if (loginScreen) loginScreen.classList.remove('login-view--visible');
            if (pinScreen) pinScreen.classList.add('login-view--visible');
            
            const pinInputs = selectAll('#pin-inputs-container .pin-input');
            pinInputs.forEach(input => input.value = '');
            (select('pin-error')).textContent = '';
            if (pinInputs.length > 0) pinInputs[0].focus();
        };

        /** Verifica el PIN introducido contra el hash almacenado */
        const handlePinSubmit = async () => {
            const pinInputs = selectAll('#pin-inputs-container .pin-input');
            const pin = Array.from(pinInputs).map(input => input.value).join('');
            const errorEl = select('pin-error');
            
            if (pin.length !== 4) {
                errorEl.textContent = 'El PIN debe tener 4 dígitos.';
                return;
            }

            const storedHash = localStorage.getItem('pinUserHash');
            const isValid = await verifyPin(pin, storedHash);

            if (isValid) {
                hapticFeedback('success');
                loadCoreData(currentUser.uid); // Carga los datos y arranca la app
            } else {
                hapticFeedback('error');
                errorEl.textContent = 'PIN incorrecto. Inténtalo de nuevo.';
                pinInputs.forEach(input => input.value = '');
                pinInputs[0].focus();
            }
        };
        
        /** Maneja la interacción con los inputs del PIN para auto-foco y auto-submit */
        const handlePinInputInteraction = () => {
            const inputs = Array.from(selectAll('#pin-inputs-container .pin-input'));
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key >= 0 && e.key <= 9) {
                        inputs[index].value = ''; // Limpia el campo antes de llenarlo
                        setTimeout(() => {
                           if (index < inputs.length - 1) {
                                inputs[index + 1].focus();
                           } else {
                               handlePinSubmit();
                           }
                        }, 10);
                    } else if (e.key === 'Backspace') {
                        if (index > 0) {
                            setTimeout(() => inputs[index - 1].focus(), 10);
                        }
                    }
                });
            });
        };
	/**
 * Convierte un PIN en un hash SHA-256 seguro para su almacenamiento.
 * @param {string} pin - El PIN de 4 dígitos.
 * @returns {Promise<string>} El hash en formato hexadecimal.
 */
async function hashPin(pin) {
    const encoder = new TextEncoder();
    const data = encoder.encode(pin);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

/**
 * Verifica si un PIN introducido coincide con un hash almacenado.
 * @param {string} pin - El PIN introducido por el usuario.
 * @param {string} storedHash - El hash guardado en localStorage.
 * @returns {Promise<boolean>} True si coinciden, false si no.
 */
async function verifyPin(pin, storedHash) {
    const pinHash = await hashPin(pin);
    return pinHash === storedHash;
}
        // =================================================================================
        // 4. APP INITIALIZATION & AUTH
        // =================================================================================
        const initApp = async () => {
            document.documentElement.lang = currentLanguage;
            applyStaticTranslations();
            setupTheme();
			const savedTheme = localStorage.getItem('appTheme') || 'default';
			document.body.dataset.theme = savedTheme;
            attachEventListeners();
            
            const intro = select('introScreen'), quoteContainer = select('quoteContainer');
            if (localStorage.getItem('skipIntro') === 'true') { if (intro) intro.remove(); } 
            else if (intro && quoteContainer && quotesData.length) {
                const r = quotesData[Math.floor(Math.random() * quotesData.length)];
                const quoteTextEl = select('quoteText');
                const quoteAuthorEl = select('quoteAuthor');
                if(quoteTextEl) quoteTextEl.textContent = `"${r.cita}"`;
                if(quoteAuthorEl) quoteAuthorEl.textContent = `— ${r.autor}`;
                await wait(2500); quoteContainer.classList.add('visible');
                await wait(4000); (intro).style.opacity = '0';
                await wait(750); intro.remove();
            } else if (intro) { intro.remove(); }
            
            checkAuthState();
        };
		window.addEventListener('online', () => {
    console.log("Conexión recuperada. Sincronizando...");
    syncState = 'syncing';
    updateSyncStatusIcon();
    // Firestore se encargará de sincronizar automáticamente.
    // Damos un tiempo para que se complete antes de mostrar el check.
    setTimeout(() => {
        syncState = 'synced';
        updateSyncStatusIcon();
    }, 2500);
});

window.addEventListener('offline', () => {
    console.log("Se ha perdido la conexión.");
    syncState = 'error';
    updateSyncStatusIcon();
});
    const startMainApp = async () => {
            const loginScreen = select('login-screen');
            const pinLoginScreen = select('pin-login-screen'); // Esta línea ahora funcionará sin error
            const appRoot = select('app-root');

            if (loginScreen) loginScreen.classList.remove('login-view--visible');
            if (pinLoginScreen) pinLoginScreen.classList.remove('login-view--visible');
            if (appRoot) appRoot.classList.add('app-layout--visible');
            
            populateAllDropdowns();
            loadConfig();
            
            measureListItemHeights();
            
            updateSyncStatusIcon();
            buildIntelligentIndex();
            navigateTo(PAGE_IDS.INICIO, true);
            updateThemeIcon(localStorage.getItem('appTheme') || 'default');
            isInitialLoadComplete = true;
        };

        
    const showLoginScreen = () => {
        const loginScreen = select('login-screen');
        const pinLoginScreen = select('pin-login-screen');
        const appRoot = select('app-root');
        if (appRoot) appRoot.classList.remove('app-layout--visible');
        if (pinLoginScreen) pinLoginScreen.classList.remove('login-view--visible');
        if (loginScreen) loginScreen.classList.add('login-view--visible');
    };
	
    const showPasswordFallback = () => {
    hapticFeedback('light');
    const pinScreen = select('pin-login-screen');
    if (!pinScreen) return;

    // Ocultamos los elementos del PIN que ya no necesitamos
    pinScreen.querySelector('.pin-inputs').classList.add('hidden');
    pinScreen.querySelector('[data-action="use-password-instead"]').parentElement.classList.add('hidden');
    
    // Cambiamos el texto de ayuda
    pinScreen.querySelector('.login-view__tagline').textContent = 'Introduce tu contraseña para continuar.';
    
    // Creamos y añadimos el formulario de contraseña
    const form = pinScreen.querySelector('form');
    const passwordContainer = document.createElement('div');
    passwordContainer.innerHTML = `
        <div class="form-group form-group--with-icon" style="margin-top: 1.5rem;">
            <span class="material-icons">lock</span>
            <input type="password" id="pin-fallback-password" class="form-input" placeholder="Contraseña" required>
        </div>
        <button type="submit" class="btn btn--primary btn--full" style="margin-top: 1rem;">Verificar</button>
    `;
    form.appendChild(passwordContainer);
    select('pin-fallback-password').focus();

    // Le decimos al formulario qué hacer al enviarlo
    form.onsubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        setButtonLoading(btn, true);

        const password = select('pin-fallback-password').value;
        const errorEl = select('pin-error');
        errorEl.textContent = '';

        try {
            // Verificamos la contraseña contra Firebase
            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
            await currentUser.reauthenticateWithCredential(credential);
            
            // Si es correcta, ¡adelante!
            startMainApp(); 

        } catch (error) {
            // Si es incorrecta, mostramos un error
            errorEl.textContent = 'Contraseña incorrecta.';
            hapticFeedback('error');
        } finally {
            setButtonLoading(btn, false);
        }
    };
};
         
        const handleLogin = (btn) => {
            const email = (select('login-email')).value.trim(), password = (select('login-password')).value, errEl = select('login-error'); clearAllErrors('login-form'); if(errEl) errEl.textContent = ''; let v = true;
            if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
            if (!password) { displayError('login-password', 'La contraseña es obligatoria.'); v = false; }
            if (!v) return; setButtonLoading(btn, true, 'Iniciando...');
            fbAuth.signInWithEmailAndPassword(email, password).then(() => showToast(`¡Bienvenido/a de nuevo!`)).catch((err) => { setButtonLoading(btn, false); if (['auth/wrong-password', 'auth/user-not-found', 'auth/invalid-credential'].includes(err.code)) (errEl).textContent = 'Error: Credenciales incorrectas.'; else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no válido.'); else (errEl).textContent = 'Error al iniciar sesión.'; });
        };
        const handleRegister = (btn) => {
            const email = (select('login-email')).value.trim(), password = (select('login-password')).value, errEl = select('login-error'); clearAllErrors('login-form'); if(errEl) errEl.textContent = ''; let v = true;
            if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
            if (password.length < 6) { displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); v = false; }
            if (!v) return; setButtonLoading(btn, true, 'Registrando...');
            fbAuth.createUserWithEmailAndPassword(email, password).then(() => showToast(`¡Registro completado!`)).catch((err) => { setButtonLoading(btn, false); if (err.code == 'auth/weak-password') displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); else if (err.code == 'auth/email-already-in-use') displayError('login-email', 'El correo ya está registrado.'); else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no válido.'); else (errEl).textContent = 'Error en el registro.'; });
        };
        const handleExitApp = () => {
            const exitScreen = select('exit-screen');
            const appRoot = select('app-root');

            if (exitScreen) {
                // Hacemos visible la pantalla de salida
                exitScreen.style.display = 'flex';
                setTimeout(() => exitScreen.style.opacity = '1', 50);

                // Y ahora, aplicamos la transformación al fondo de la app
                // solo si la carga inicial ha terminado.
                if (isInitialLoadComplete && appRoot) {
                    appRoot.classList.add('app-layout--transformed-by-modal');
                }
            }
        };
        
        // =================================================================================
        // 5. NAVIGATION & UI CONTROL (REESTRUCTURADO)
        // =================================================================================
        const navigateTo = async (pageId, isInitial = false) => {
            if (!isInitial) hapticFeedback('light');
            
            const oldActiveView = document.querySelector('.view--active');
            const oldViewId = oldActiveView ? oldActiveView.id : null;

            if (oldViewId === PAGE_IDS.PATRIMONIO && liquidAssetsChart) {
                liquidAssetsChart.destroy();
                liquidAssetsChart = null;
            }
			if (oldViewId === PAGE_IDS.ANALISIS && assetAllocationChart) {
				assetAllocationChart.destroy();
				assetAllocationChart = null;
			}
            if (oldViewId === PAGE_IDS.INICIO && conceptosChart) {
                conceptosChart.destroy();
                conceptosChart = null;
            }
            if (oldViewId === PAGE_IDS.ANALISIS && informesChart) {
                informesChart.destroy();
                informesChart = null;
            }
            if (oldViewId === PAGE_IDS.INICIO && unsubscribeRecientesListener) {
				console.log("Saliendo de Inicio, desconectando el listener de recientes.");
				unsubscribeRecientesListener();
				unsubscribeRecientesListener = null;
            }
			if (pageId === PAGE_IDS.ANALISIS) {
                selectedInvestmentTypeFilter = null; // Reinicia el filtro al entrar en la página
                deselectedInvestmentTypesFilter.clear(); // <-- Añadir esta línea para limpiar filtros de tipo
            }
            const titleEl = select('top-bar-title'), actionsEl = select('top-bar-actions'), leftEl = select('top-bar-left-button'), fab = select('fab-add-movimiento');
            
            const standardActions = `
                <button data-action="global-search" class="icon-btn" data-i18n-title="search_placeholder" title="Búsqueda Global (Cmd/Ctrl+K)" aria-label="Búsqueda Global"><span class="material-icons">search</span></button>
                <button id="theme-toggle-btn" data-action="toggle-theme" class="icon-btn" title="Cambiar Tema" aria-label="Cambiar Tema"><span class="material-icons">light_mode</span></button>
				<button data-action="help" class="icon-btn" data-i18n-title="nav_help" title="Ayuda" aria-label="Ayuda"><span class="material-icons">help_outline</span></button> 
                <button data-action="exit" class="icon-btn" data-i18n-title="nav_exit" title="Salir" aria-label="Salir de la aplicación"><span class="material-icons">exit_to_app</span></button>`;
            
            const inicioActions = standardActions;
            
            if (pageId === PAGE_IDS.MOVIMIENTOS_FULL) {
                leftEl.innerHTML = `<button class="icon-btn" data-action="navigate" data-page="${PAGE_IDS.INICIO}" aria-label="Volver a Inicio"><span class="material-icons">arrow_back_ios</span></button>`;
            } else {
                leftEl.innerHTML = `<button id="ledger-toggle-btn" class="btn btn--secondary" data-action="toggle-ledger" data-i18n-title="tooltip_toggle_ledger" title="Cambiar Contabilidad">${isOffBalanceMode ? 'B' : 'A'}</button>`;
            }

            if (pageId === PAGE_IDS.INICIO && !dataLoaded.recurrentes) await loadRecurrentes();
            if (pageId === PAGE_IDS.ANALISIS && !dataLoaded.presupuestos) await loadPresupuestos();
            if ((pageId === PAGE_IDS.PATRIMONIO || pageId === PAGE_IDS.ANALISIS) && !dataLoaded.inversiones) await loadInversiones();

            const pageRenderers = {
                [PAGE_IDS.INICIO]: { titleKey: 'title_home', render: renderInicioPage, actions: inicioActions },
                [PAGE_IDS.PATRIMONIO]: { titleKey: 'title_wealth', render: renderPatrimonioPage, actions: standardActions },
                [PAGE_IDS.ANALISIS]: { titleKey: 'title_analysis', render: renderAnalisisPage, actions: standardActions },
                [PAGE_IDS.CONFIGURACION]: { titleKey: 'title_settings', render: loadConfig, actions: standardActions },
                [PAGE_IDS.MOVIMIENTOS_FULL]: { titleKey: 'title_history', render: loadInitialMovements, actions: standardActions },
            };
            
            if (pageRenderers[pageId]) {
                 if (titleEl) { titleEl.textContent = t(pageRenderers[pageId].titleKey); }
				if (actionsEl) {
                    actionsEl.innerHTML = pageRenderers[pageId].actions;
                    applyStaticTranslations();
                }
                pageRenderers[pageId].render();
            }
            
            const mainScroller = selectOne('.app-layout__main'); if (mainScroller) mainScroller.scrollTop = 0;
            selectAll('.view').forEach(p => p.classList.remove('view--active'));
            const newActivePage = select(pageId); if (newActivePage) newActivePage.classList.add('view--active');
            selectAll('.bottom-nav__item').forEach(b => b.classList.toggle('bottom-nav__item--active', b.dataset.page === pageId));
            
            if (fab) fab.classList.toggle('fab--visible', [PAGE_IDS.INICIO, PAGE_IDS.PATRIMONIO, PAGE_IDS.ANALISIS, PAGE_IDS.MOVIMIENTOS_FULL].includes(pageId));
        };
        
        const setupTheme = () => { 
    const gridColor = 'rgba(255, 255, 255, 0.1)';
    const textColor = '#FFFFFF';
    Chart.defaults.color = textColor; 
    Chart.defaults.borderColor = gridColor;
    Chart.register(ChartDataLabels);
};
        
        // =================================================================================
        // 6. CORE LOGIC & CALCULATIONS (REFACTORIZADO PARA CONSULTAS EFICIENTES)
        // =================================================================================
		 // ... Pega la nueva función aquí ...

        /**
         * Construye un índice en memoria para sugerencias inteligentes.
         * Recorre los movimientos de más reciente a más antiguo y guarda la primera
         * asociación que encuentra para cada descripción.
         */
        const buildIntelligentIndex = (movementsSource = db.movimientos) => {
            intelligentIndex.clear(); 
            if (!movementsSource || movementsSource.length === 0) return;

            const sortedMovements = [...movementsSource].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            for (const mov of sortedMovements) {
                if (mov.tipo === 'movimiento' && mov.descripcion) {
                    const key = mov.descripcion.trim().toLowerCase();
                    if (!intelligentIndex.has(key)) {
                        intelligentIndex.set(key, {
                            conceptoId: mov.conceptoId,
                            cuentaId: mov.cuentaId
                        });
                    }
                }
            }
            console.log(`Índice inteligente actualizado con ${intelligentIndex.size} entradas.`);
        };
		
		
		const getVisibleAccounts = () => (db.cuentas || []).filter(c => !!c.offBalance === isOffBalanceMode);
        const getLiquidAccounts = () => getVisibleAccounts().filter((c) => !['PROPIEDAD', 'PRÉSTAMO'].includes((c.tipo || '').trim().toUpperCase()));
        const getAllSaldos = () => {
            const saldos = {};
            (db.cuentas || []).forEach(cuenta => {
                saldos[cuenta.id] = cuenta.saldo || 0;
            });
            return saldos;
        };
        async function fetchAllMovementsForBalances() {
            if (!currentUser) return [];
            const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
		// =================================================================================
        // INICIO: NUEVA FUNCIÓN AUXILIAR PARA LA BÚSQUEDA GLOBAL
        // =================================================================================
        /**
         * Obtiene TODOS los movimientos de un usuario desde Firestore para la búsqueda.
         * @returns {Promise<Array<Object>>} Una promesa que resuelve a un array con todos los movimientos.
         */
        const fetchAllMovementsForSearch = async () => {
            if (!currentUser) return [];
            try {
                const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error al obtener todos los movimientos para la búsqueda:", error);
                showToast("Error al realizar la búsqueda en la base de datos.", "danger");
                return []; // Devuelve un array vacío en caso de error
            }
        };
        // =================================================================================
        // FIN: NUEVA FUNCIÓN AUXILIAR
        // =================================================================================
        const getSaldos = async () => {
            const visibleAccounts = getVisibleAccounts();
            const saldos = {};
            visibleAccounts.forEach(cuenta => {
                saldos[cuenta.id] = cuenta.saldo || 0;
            });
            return saldos;
        };
        
        const getFilteredMovements = async (forComparison = false) => {
    if (!currentUser) return { current: [], previous: [], label: '' };

    const visibleAccountIds = getVisibleAccounts().map(c => c.id);
    if (visibleAccountIds.length === 0) {
        return { current: [], previous: [], label: '' };
    }

    const filterPeriodo = select('filter-periodo');
    const p = filterPeriodo ? filterPeriodo.value : 'mes-actual';
    const filterCuenta = select('filter-cuenta');
    const cId = filterCuenta ? filterCuenta.value : null;
    const filterConcepto = select('filter-concepto');
    const coId = filterConcepto ? filterConcepto.value : null;

    let sDate, eDate, prevSDate, prevEDate, now = new Date();

    switch (p) {
        case 'mes-actual':
            sDate = new Date(now.getFullYear(), now.getMonth(), 1);
            eDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            prevSDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            prevEDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
            break;
        case 'año-actual':
            sDate = new Date(now.getFullYear(), 0, 1);
            eDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
            prevSDate = new Date(now.getFullYear() - 1, 0, 1);
            prevEDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999);
            break;
        case 'custom':
            const filterFechaInicio = select('filter-fecha-inicio');
            const filterFechaFin = select('filter-fecha-fin');
            sDate = filterFechaInicio && filterFechaInicio.value ? parseDateStringAsUTC(filterFechaInicio.value) : null;
            eDate = filterFechaFin && filterFechaFin.value ? parseDateStringAsUTC(filterFechaFin.value) : null;
            
            if (eDate) {
                eDate.setUTCHours(23, 59, 59, 999);
			}
			prevSDate = null; prevEDate = null;
            break;
        default: sDate = null; eDate = null; prevSDate = null; prevEDate = null; break;
    }
    
    const fetchMovements = async (startDate, endDate) => {
        if (!startDate || !endDate) return [];
        
        let baseQuery = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
            .where('fecha', '>=', startDate.toISOString())
            .where('fecha', '<=', endDate.toISOString());
        
        let movements = await fetchMovementsInChunks(baseQuery, 'cuentaId', cId ? [cId] : visibleAccountIds);

        if (coId) {
            movements = movements.filter(m => m.conceptoId === coId);
        }

        if(cId) {
            movements = movements.filter(m => {
                return m.cuentaId === cId || m.cuentaOrigenId === cId || m.cuentaDestinoId === cId;
            });
        }
        return movements;
    };

    const currentMovs = await fetchMovements(sDate, eDate);
    if (!forComparison) return currentMovs;

    const prevMovs = await fetchMovements(prevSDate, prevEDate);
    const comparisonLabel = p === 'mes-actual' ? 'vs mes ant.' : (p === 'año-actual' ? 'vs año ant.' : '');
    return { current: currentMovs, previous: prevMovs, label: comparisonLabel };
};
        
        const calculateIRR = (cashflows) => {
            if (cashflows.length < 2) return 0;
            const sortedCashflows = [...cashflows].sort((a, b) => a.date.getTime() - b.date.getTime());
            const firstDate = sortedCashflows[0].date;
            const npv = (rate) => { let total = 0; for (const flow of sortedCashflows) { const years = (flow.date.getTime() - firstDate.getTime()) / (365.25 * 24 * 60 * 60 * 1000); total += flow.amount / Math.pow(1 + rate, years); } return total; };
            const derivative = (rate) => { let total = 0; for (const flow of sortedCashflows) { const years = (flow.date.getTime() - firstDate.getTime()) / (365.25 * 24 * 60 * 60 * 1000); if (years > 0) { total -= years * flow.amount / Math.pow(1 + rate, years + 1); } } return total; };
            let guess = 0.1; const maxIterations = 100; const tolerance = 1e-7;
            for (let i = 0; i < maxIterations; i++) {
                const npvValue = npv(guess); const derivativeValue = derivative(guess); if (Math.abs(derivativeValue) < tolerance) break; const newGuess = guess - npvValue / derivativeValue; if (Math.abs(newGuess - guess) <= tolerance) { return newGuess; } guess = newGuess; }
            return 0;
        };
        
        const calculatePortfolioPerformance = async (cuentaId = null) => {
            // Carga de datos necesarios (sin cambios)
            if (!dataLoaded.inversiones) await loadInversiones();

            const investmentAccounts = getVisibleAccounts().filter(c => c.esInversion && (cuentaId ? c.id === cuentaId : true));
            if (investmentAccounts.length === 0) {
                return { valorActual: 0, capitalInvertido: 0, pnlAbsoluto: 0, pnlPorcentual: 0, irr: 0 };
            }

            let totalValor = 0;
            let totalCapitalInvertido = 0;
            let allIrrCashflows = [];

            // Obtenemos todos los saldos de una vez para mayor eficiencia
            const todosLosSaldos = getAllSaldos();

            for (const cuenta of investmentAccounts) {
                // 1. CÁLCULO DEL CAPITAL INVERTIDO (sin cambios, sigue siendo correcto para la TIR)
                const cashflows = (db.inversion_cashflows || []).filter(cf => cf.cuentaId === cuenta.id);
                const capitalInvertido = cashflows.reduce((sum, cf) => sum + cf.cantidad, 0);

                // 2. CÁLCULO DEL VALOR ACTUAL (¡LA CORRECCIÓN CLAVE!)
                const valoraciones = (db.inversiones_historial || []).filter(v => v.cuentaId === cuenta.id).sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime());
                
                let valorActual;
                if (valoraciones.length > 0) {
                    // Si hay valoraciones manuales, esa es la prioridad número 1.
                    valorActual = valoraciones[0].valor;
                } else {
                    // Si NO hay valoraciones, el valor actual ES el saldo de la cuenta.
                    // Usamos el saldo de la cuenta que ya tenemos calculado.
                    valorActual = todosLosSaldos[cuenta.id] || 0;
                }

                // 3. Acumulamos los totales
                totalValor += valorActual;
                totalCapitalInvertido += capitalInvertido;

                // 4. Construcción de flujos para la TIR (sin cambios)
                const irrCashflows = [];
                cashflows.forEach(cf => {
                    irrCashflows.push({ amount: -cf.cantidad, date: new Date(cf.fecha) });
                });
                
                if (valorActual !== 0) {
                    irrCashflows.push({ amount: valorActual, date: new Date() });
                }
                allIrrCashflows.push(...irrCashflows);
            }

            // El resto de la función para calcular P&L y TIR global no necesita cambios
            const pnlAbsoluto = totalValor - totalCapitalInvertido;
            const pnlPorcentual = totalCapitalInvertido !== 0 ? (pnlAbsoluto / totalCapitalInvertido) * 100 : 0;

            if (cuentaId) {
                const irrUnico = calculateIRR(allIrrCashflows);
                return { valorActual: totalValor, capitalInvertido: totalCapitalInvertido, pnlAbsoluto: pnlAbsoluto, pnlPorcentual: pnlPorcentual, irr: irrUnico };
            }

            const irrGlobal = calculateIRR(allIrrCashflows);
            return { valorActual: totalValor, capitalInvertido: totalCapitalInvertido, pnlAbsoluto, pnlPorcentual, irr: irrGlobal };
        };
        const recalculateAndApplyRunningBalances = (movements) => {
            if (!movements || movements.length === 0) return 0;

            const cuentaId = movements[0].tipo === 'traspaso' 
                ? (movements[0].cuentaOrigenId || movements[0].cuentaDestinoId)
                : movements[0].cuentaId;

            let saldoFinalReal = 0;
            for (const mov of movements) {
                if (mov.tipo === 'traspaso') {
                    if (mov.cuentaOrigenId === cuentaId) saldoFinalReal -= mov.cantidad;
                    if (mov.cuentaDestinoId === cuentaId) saldoFinalReal += mov.cantidad;
                } else {
                    saldoFinalReal += mov.cantidad;
                }
            }

            const sortedMovements = [...movements].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            let runningBalance = saldoFinalReal;
            for (const mov of sortedMovements) {
                mov.runningBalance = runningBalance; 

                if (mov.tipo === 'traspaso') {
                    if (mov.cuentaOrigenId === cuentaId) runningBalance += mov.cantidad;
                    if (mov.cuentaDestinoId === cuentaId) runningBalance -= mov.cantidad;
                } else {
                    runningBalance -= mov.cantidad;
                }
            }
            return saldoFinalReal;
        };
             const processMovementsForRunningBalance = async (movements, forceRecalculate = false) => {
            if (!runningBalancesCache || forceRecalculate) {
                runningBalancesCache = getAllSaldos();
            }

            const sortedMovements = [...movements].sort((a, b) => {
                const dateComparison = new Date(b.fecha) - new Date(a.fecha);
                if (dateComparison !== 0) {
                    return dateComparison;
                }
                return b.id.localeCompare(a.id);
            });

            for (const mov of sortedMovements) {
                if (mov.tipo === 'traspaso') {
                    if (!runningBalancesCache.hasOwnProperty(mov.cuentaOrigenId)) {
                        runningBalancesCache[mov.cuentaOrigenId] = 0;
                    }
                    if (!runningBalancesCache.hasOwnProperty(mov.cuentaDestinoId)) {
                        runningBalancesCache[mov.cuentaDestinoId] = 0;
                    }

                    mov.runningBalanceOrigen = runningBalancesCache[mov.cuentaOrigenId];
                    mov.runningBalanceDestino = runningBalancesCache[mov.cuentaDestinoId];

                    runningBalancesCache[mov.cuentaOrigenId] += mov.cantidad;
                    runningBalancesCache[mov.cuentaDestinoId] -= mov.cantidad;

                } else { // Para 'movimiento'
                    if (!runningBalancesCache.hasOwnProperty(mov.cuentaId)) {
                        runningBalancesCache[mov.cuentaId] = 0;
                    }

                    mov.runningBalance = runningBalancesCache[mov.cuentaId];
                    runningBalancesCache[mov.cuentaId] -= mov.cantidad;
                }
            }
        };
        
        // =================================================================================
        // 7. RENDERING ENGINE & BUDGET FUNCTIONS
        // =================================================================================
        const populateAllDropdowns = () => {
            const visibleAccounts = getVisibleAccounts();
            const populate = (id, data, nameKey, valKey='id', all=false, none=false) => {
                const el = select(id); if (!el) return; const currentVal = el.value;
                let opts = all ? '<option value="">Todos</option>' : ''; if (none) opts += '<option value="">Ninguno</option>';
                [...data].sort((a,b) => (a[nameKey]||"").localeCompare(b[nameKey]||"")).forEach(i => opts += `<option value="${i[valKey]}">${i[nameKey]}</option>`);
                el.innerHTML = opts; 
                const optionsArray = Array.from(el.options);
                el.value = optionsArray.some(o=>o.value===currentVal) ? currentVal : (optionsArray.length > 0 ? optionsArray[0].value : "");
            };
            populate('movimiento-cuenta', visibleAccounts, 'nombre', 'id', false, true);
            
            populateTraspasoDropdowns();
            
            populate('filter-cuenta', visibleAccounts, 'nombre', 'id', true); 
            populate('movimiento-concepto', db.conceptos, 'nombre', 'id', false, true); 
            populate('filter-concepto', db.conceptos, 'nombre', 'id', true);
            const budgetYearSelect = select('budget-year-selector'); if(budgetYearSelect) { const currentVal = budgetYearSelect.value; const currentYear = new Date().getFullYear(); let years = new Set([currentYear]); (db.presupuestos || []).forEach((p) => years.add(p.ano)); budgetYearSelect.innerHTML = [...years].sort((a,b) => b-a).map(y => `<option value="${y}">${y}</option>`).join(''); if(currentVal && [...years].some(y => y == parseInt(currentVal))) budgetYearSelect.value = currentVal; else budgetYearSelect.value = String(currentYear); }
            
            populate('filter-cuenta-informe', visibleAccounts, 'nombre', 'id', true);
            populate('filter-concepto-informe', db.conceptos, 'nombre', 'id', true);
        };

        const populateTraspasoDropdowns = () => {
            const traspasoToggle = select('traspaso-show-all-accounts-toggle');
            const showAll = traspasoToggle ? traspasoToggle.checked : false;
            const accountsToList = showAll ? (db.cuentas || []) : getVisibleAccounts();
            
            const populate = (id, data, none = false) => {
                const el = select(id); if (!el) return;
                const currentVal = el.value;
                let opts = none ? '<option value="">Ninguno</option>' : '';
                data.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(i => opts += `<option value="${i.id}">${i.nombre}</option>`);
                el.innerHTML = opts;
                const optionsArray = Array.from(el.options);
                if (optionsArray.some(o => o.value === currentVal)) {
                    el.value = currentVal;
                } else {
                    el.value = optionsArray.length > 0 ? optionsArray[0].value : "";
                }
            };

            populate('movimiento-cuenta-origen', accountsToList, true);
            populate('movimiento-cuenta-destino', accountsToList, true);
        };
        
               
        const handleUpdateBudgets = () => {
    hapticFeedback('light');

    const initialHtml = `
        <div class="form-group" style="margin-bottom: var(--sp-4);">
            <label for="budget-year-selector-modal" class="form-label">Selecciona el año para gestionar:</label>
            <select id="budget-year-selector-modal" class="form-select"></select>
        </div>
        <div id="budgets-form-container">
            <div class="empty-state" style="background:transparent; border:none; padding-top:0;">
                <p>Selecciona un año para empezar.</p>
            </div>
        </div>`;
    showGenericModal('Gestionar Presupuestos Anuales', initialHtml);

    const renderYearForm = (year) => {
        const container = select('budgets-form-container');
        if (!container) return;

        const budgetsForYear = (db.presupuestos || []).filter(p => p.ano === year);
        const conceptsWithBudget = new Set(budgetsForYear.map(b => b.conceptoId));

        let formHtml = `<form id="update-budgets-form" novalidate>
            <p class="form-label" style="margin-bottom: var(--sp-3)">
                Introduce el límite anual. Usa <b>valores positivos para metas de ingreso</b> y <b>valores negativos para límites de gasto</b>. Deja en blanco o en 0 si no quieres presupuestar un concepto.
            </p>
            <div style="max-height: 45vh; overflow-y: auto; padding-right: var(--sp-2);">`;

        db.conceptos
            .sort((a, b) => a.nombre.localeCompare(b.nombre))
            .forEach(c => {
                const budget = budgetsForYear.find(b => b.ano === year && b.conceptoId === c.id);
                const currentAmount = budget ? (budget.cantidad / 100).toFixed(2).replace('.', ',') : '';
                const placeholder = conceptsWithBudget.has(c.id) ? '' : '0,00';
                formHtml += `
                    <div class="form-group">
                        <label for="budget-input-${c.id}" class="form-label" style="font-weight: 600;">${c.nombre}</label>
                        <input type="text" id="budget-input-${c.id}" data-concept-id="${c.id}" class="form-input" inputmode="decimal" value="${currentAmount}" placeholder="${placeholder}">
                    </div>`;
            });
        
        formHtml += `</div><div class="modal__actions"><button type="submit" class="btn btn--primary btn--full">Guardar Cambios para ${year}</button></div></form>`;
        container.innerHTML = formHtml;
        
        const updateBudgetsForm = select('update-budgets-form');
        if (updateBudgetsForm) {
            updateBudgetsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                setButtonLoading(btn, true, 'Guardando...');

                const inputs = e.target.querySelectorAll('input[data-concept-id]');
                const batch = fbDb.batch();

                for (const input of inputs) {
                    const conceptoId = input.dataset.conceptId;
                    const amountValue = parseCurrencyString(input.value);
                    
                    if (isNaN(amountValue)) continue;

                    const newAmountInCents = Math.round(amountValue * 100);
                    let budget = (db.presupuestos || []).find(b => b.ano === year && b.conceptoId === conceptoId);
                    
                    if (budget) {
                        const ref = fbDb.collection('users').doc(currentUser.uid).collection('presupuestos').doc(budget.id);
                        if (newAmountInCents !== 0) {
                            batch.update(ref, { cantidad: newAmountInCents });
                        } else {
                            batch.delete(ref);
                        }
                    } else if (newAmountInCents !== 0) {
                        const newId = generateId();
                        const ref = fbDb.collection('users').doc(currentUser.uid).collection('presupuestos').doc(newId);
                        batch.set(ref, { id: newId, ano: year, conceptoId: conceptoId, cantidad: newAmountInCents });
                    }
                }

                await batch.commit();
                setButtonLoading(btn, false);
                hideModal('generic-modal');
                hapticFeedback('success');
                showToast(`Presupuestos de ${year} actualizados.`);
                
                renderBudgetTracking(); 
            });
        }
    };

    setTimeout(() => {
        const yearSelect = select('budget-year-selector-modal');
        if (!yearSelect) return;
        
        const currentYear = new Date().getFullYear();
        let years = new Set([currentYear, currentYear + 1]);
        (db.presupuestos || []).forEach(p => years.add(p.ano));
        
        yearSelect.innerHTML = `<option value="">Seleccionar...</option>` + 
            [...years].sort((a, b) => b - a).map(y => `<option value="${y}">${y}</option>`).join('');
        
        yearSelect.addEventListener('change', (e) => {
            const selectedYear = parseInt(e.target.value, 10);
            if (selectedYear) {
                renderYearForm(selectedYear);
            } else {
                const container = select('budgets-form-container');
                if (container) container.innerHTML = `<div class="empty-state" style="background:transparent; border:none; padding-top:0;"><p>Selecciona un año para empezar.</p></div>`;
            }
        });
    }, 0);
};
        
	   const renderBudgetTracking = async () => {
    const dashboardContainer = select('annual-budget-dashboard');
    const placeholder = select('budget-init-placeholder');
    const yearSelector = select('budget-year-selector');
    if (!dashboardContainer || !placeholder || !yearSelector) return;
    
    const year = parseInt(yearSelector.value, 10);
    
    const allYearBudgets = (db.presupuestos || [])
        .filter(b => b.ano === year && db.conceptos.find(c => c.id === b.conceptoId));

    if (allYearBudgets.length === 0) {
        dashboardContainer.classList.add('hidden');
        placeholder.classList.remove('hidden');
        const titleEl = select('budget-placeholder-title');
        const textEl = select('budget-placeholder-text');
        if (titleEl) titleEl.textContent = `Configurar Presupuestos ${year}`;
        if (textEl) textEl.textContent = `Aún no has definido metas de ingreso o límites de gasto para el año ${year}.`;
        return;
    }
    
    dashboardContainer.classList.remove('hidden');
    placeholder.classList.add('hidden');

    const { percentage: yearProgress, daysPassed, daysRemaining, totalDaysInYear } = getYearProgress();
    
    const startDate = new Date(year, 0, 1);
    const endDate = new Date(year, 11, 31, 23, 59, 59, 999);
    let baseQuery = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
        .where('fecha', '>=', startDate.toISOString())
        .where('fecha', '<=', endDate.toISOString())
        .where('tipo', '==', 'movimiento');
    
    const visibleAccountIds = getVisibleAccounts().map(c => c.id);
    const movements = await fetchMovementsInChunks(baseQuery, 'cuentaId', visibleAccountIds);
    
    const monthlyIncomeData = {};
    const monthlyExpenseData = {};
    movements.forEach(mov => {
        const month = new Date(mov.fecha).getMonth();
        if (mov.cantidad > 0) {
            monthlyIncomeData[month] = (monthlyIncomeData[month] || 0) + mov.cantidad;
        } else {
            monthlyExpenseData[month] = (monthlyExpenseData[month] || 0) + Math.abs(mov.cantidad);
        }
    });

    const expenseBudgets = allYearBudgets.filter(b => b.cantidad < 0);
    let totalBudgetedExpense = 0;
    const expenseDetails = expenseBudgets.map(budget => {
        const actualSpent = Math.abs(movements.filter(m => m.conceptoId === budget.conceptoId && m.cantidad < 0).reduce((sum, m) => sum + m.cantidad, 0));
        const budgetLimit = Math.abs(budget.cantidad);
        totalBudgetedExpense += budgetLimit;

        const rawPacePercentage = (budgetLimit > 0 && yearProgress > 0) ? ((actualSpent / budgetLimit) / (yearProgress / 100)) * 100 : (actualSpent > 0 ? 200 : 100);
        const pacePercentage = Math.min(rawPacePercentage, 200);

        let status;
        if (rawPacePercentage > 120) {
            status = { text: 'Excedido', icon: 'cancel', color: 'text-danger' };
        } else if (rawPacePercentage >= 80) {
            status = { text: 'Vas bien', icon: 'check_circle', color: 'text-info' };
        } else {
            status = { text: 'Ahorrando', icon: 'verified', color: 'text-positive' };
        }

        const projectedAnnualSpent = (daysPassed > 0) ? (actualSpent / daysPassed) * totalDaysInYear : 0;
        return { ...budget, actual: actualSpent, limit: budgetLimit, projected: projectedAnnualSpent, pacePercentage, status };
    });
    const totalProjectedExpense = expenseDetails.reduce((sum, b) => sum + b.projected, 0);

    const incomeBudgets = allYearBudgets.filter(b => b.cantidad >= 0);
    let totalBudgetedIncome = 0;
    const incomeDetails = incomeBudgets.map(budget => {
        const actualIncome = movements.filter(m => m.conceptoId === budget.conceptoId && m.cantidad > 0).reduce((sum, m) => sum + m.cantidad, 0);
        const budgetGoal = budget.cantidad;
        totalBudgetedIncome += budgetGoal;

        const rawPacePercentage = (budgetGoal > 0 && yearProgress > 0) ? ((actualIncome / budgetGoal) / (yearProgress / 100)) * 100 : (actualIncome > 0 ? 200 : 0);
        const pacePercentage = Math.min(rawPacePercentage, 200);

        let status;
        if (rawPacePercentage > 120) {
            status = { text: 'Superado', icon: 'rocket_launch', color: 'text-positive' };
        } else if (rawPacePercentage >= 80) {
            status = { text: 'Vas bien', icon: 'check_circle', color: 'text-info' };
        } else {
            status = { text: 'Por debajo del objetivo', icon: 'trending_down', color: 'text-warning' };
        }

        const projectedAnnualIncome = (daysPassed > 0) ? (actualIncome / daysPassed) * totalDaysInYear : 0;
        return { ...budget, actual: actualIncome, limit: budgetGoal, projected: projectedAnnualIncome, pacePercentage, status };
    });
    const totalProjectedIncome = incomeDetails.reduce((sum, b) => sum + b.projected, 0);

    const projectedNet = totalProjectedIncome - totalProjectedExpense;
    const kpiContainer = select('budget-kpi-container');
    if (kpiContainer) kpiContainer.innerHTML = `
        <div class="kpi-item"><h4 class="kpi-item__label">Proyección Ingresos</h4><strong class="kpi-item__value text-positive">${formatCurrency(totalProjectedIncome)}</strong></div>
        <div class="kpi-item"><h4 class="kpi-item__label">Proyección Gastos</h4><strong class="kpi-item__value text-negative">${formatCurrency(totalProjectedExpense)}</strong></div>
        <div class="kpi-item"><h4 class="kpi-item__label">Proyección Neta Anual</h4><strong class="kpi-item__value ${projectedNet >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(projectedNet)}</strong></div>
    `;
    renderBudgetTrendChart(monthlyIncomeData, monthlyExpenseData, totalBudgetedExpense / 12);

    const listContainer = select('budget-details-list');
    let listHtml = '';

    if (incomeDetails.length > 0) {
        listHtml += `<h4 style="margin-top: var(--sp-5);">Metas de Ingresos</h4>`;
        listHtml += incomeDetails.sort((a, b) => (a.projected / (a.limit || 1)) - (b.projected / (b.limit || 1))).map(b => {
            const concepto = db.conceptos.find(c => c.id === b.conceptoId);
            const conceptoNombre = (concepto && concepto.nombre) || 'Concepto no encontrado';
            return `
            <div class="card" style="margin-bottom: var(--sp-3);"><div class="card__content" style="padding: var(--sp-3);">
                <div style="display: grid; grid-template-columns: 80px 1fr; gap: var(--sp-4); align-items: center;">
                    <div style="position: relative; width: 80px; height: 55px;"><canvas id="gauge-chart-${b.id}"></canvas><div style="position: absolute; top: 65%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-weight: 800; font-size: var(--fs-lg);">${b.pacePercentage.toFixed(0)}<span style="font-size: 0.7em;">%</span></div></div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--sp-2);"><h4 style="font-size: var(--fs-base); font-weight: 700;">${conceptoNombre}</h4><span class="${b.status.color}" style="font-weight: 600; font-size: var(--fs-xs); display:flex; align-items:center; gap: 4px;">
    <span class="material-icons" style="font-size: 14px;">${b.status.icon}</span>
    <span>${b.status.text}</span>
    <button class="icon-btn" data-action="show-help-topic" data-topic="pace" style="width: 18px; height: 18px; margin-left: 2px;">
        <span class="material-icons" style="font-size: 14px;">help_outline</span>
    </button>
</span>
                        <div style="font-size: var(--fs-sm);"><strong>Ingresado:</strong> ${formatCurrency(b.actual)} de ${formatCurrency(b.limit)}</div>
                        <div style="font-size: var(--fs-sm); font-weight: 600;"><strong>Proyección:</strong> <span class="${b.projected >= b.limit ? 'text-positive' : 'text-danger'}">${formatCurrency(b.projected)}</span></div>
                    </div>
                </div>
            </div></div>`;
        }).join('');
    }
    
    if (expenseDetails.length > 0) {
        listHtml += `<h4 style="margin-top: var(--sp-5);">Límites de Gasto</h4>`;
        listHtml += expenseDetails.sort((a, b) => (b.projected / (b.limit || 1)) - (a.projected / (a.limit || 1))).map(b => {
            const concepto = db.conceptos.find(c => c.id === b.conceptoId);
            const conceptoNombre = (concepto && concepto.nombre) || 'Concepto no encontrado';
            return `
            <div class="card" style="margin-bottom: var(--sp-3);"><div class="card__content" style="padding: var(--sp-3);">
                <div style="display: grid; grid-template-columns: 80px 1fr; gap: var(--sp-4); align-items: center;">
                    <div style="position: relative; width: 80px; height: 55px;"><canvas id="gauge-chart-${b.id}"></canvas><div style="position: absolute; top: 65%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-weight: 800; font-size: var(--fs-lg);">${b.pacePercentage.toFixed(0)}<span style="font-size: 0.7em;">%</span></div></div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--sp-2);"><h4 style="font-size: var(--fs-base); font-weight: 700;">${conceptoNombre}</h4><span class="${b.status.color}" style="font-weight: 600; font-size: var(--fs-xs); display:flex; align-items:center; gap: 4px;"><span class="material-icons" style="font-size: 14px;">${b.status.icon}</span> ${b.status.text}</span></div>
                        <div style="font-size: var(--fs-sm);"><strong>Gastado:</strong> ${formatCurrency(b.actual)} de ${formatCurrency(b.limit)}</div>
                        <div style="font-size: var(--fs-sm); font-weight: 600;"><strong>Proyección:</strong> <span class="${b.projected > b.limit ? 'text-danger' : 'text-positive'}">${formatCurrency(b.projected)}</span></div>
                    </div>
                </div>
            </div></div>`;
        }).join('');
    }
    
    if (listContainer) listContainer.innerHTML = listHtml;

    setTimeout(() => {
        [...incomeDetails, ...expenseDetails].forEach(b => {
            renderGaugeChart(`gauge-chart-${b.id}`, b.pacePercentage, 100);
        });
    }, 50);
};
	     const handleToggleInvestmentTypeFilter = (type) => {
            hapticFeedback('light');
            if (deselectedInvestmentTypesFilter.has(type)) {
                deselectedInvestmentTypesFilter.delete(type);
            } else {
                deselectedInvestmentTypesFilter.add(type);
            }

            // CORRECCIÓN: En lugar de renderizar TODA la página,
            // solo renderizamos el contenido del portafolio.
            renderInversionesPage('analisis-inversiones-container');
        };
        // =================================================================================
        // 7.5. INVESTMENT & REPORT PAGE RENDERING
        // =================================================================================
        const renderLanguageSelector = () => {
            const container = select('language-selector');
            if (!container) return;
            const languages = { es: 'Español 🇪🇸', en: 'English 🇬🇧', fr: 'Français 🇫🇷' };
            container.innerHTML = Object.entries(languages).map(([id, name]) => `
                <div class="form-checkbox-group">
                    <input type="radio" id="lang-${id}" name="language-option" value="${id}" ${currentLanguage === id ? 'checked' : ''}>
                    <label for="lang-${id}">${name}</label>
                </div>
            `).join('');
        };
        
// =================================================================================
// INICIO: VERSIÓN FINAL (SIN LEYENDA) DE renderInversionesPage
// =================================================================================
const renderInversionesPage = async (targetContainerId) => {
    const container = select(targetContainerId);
    if (!container) return;

    const CHART_COLORS = ['#007AFF', '#30D158', '#FFD60A', '#FF3B30', '#C084FC', '#4ECDC4', '#EF626C', '#A8D58A'];

    if (!db.cuentas || !dataLoaded.inversiones) {
        container.innerHTML = `<div class="skeleton" style="height: 250px; border-radius: var(--border-radius-lg);"></div>`;
        return;
    }

    const allInvestmentAccounts = getVisibleAccounts().filter((c) => c.esInversion);
    if (allInvestmentAccounts.length === 0) {
        container.innerHTML = `<div id="empty-investments" class="empty-state" style="margin-top: 0; border: none; background: transparent;">
                <span class="material-icons">rocket_launch</span>
                <h3>¿Listo para despegar?</h3>
                <p>Para empezar, ve a 'Ajustes' > 'Gestión de Datos' > 'Cuentas' y marca tus cuentas de inversión.</p>
            </div>`;
        return;
    }

    const allAssetsData = await Promise.all(allInvestmentAccounts.map(async (cuenta) => {
        const performance = await calculatePortfolioPerformance(cuenta.id);
        return { cuenta, performance };
    }));

    const allInvestmentTypes = [...new Set(allAssetsData.map(asset => toSentenceCase(asset.cuenta.tipo || 'S/T')))].sort();
    
    const displayAssetsData = allAssetsData.filter(asset => 
        !deselectedInvestmentTypesFilter.has(toSentenceCase(asset.cuenta.tipo || 'S/T'))
    );

    const chartLabels = Object.keys(displayAssetsData.reduce((acc, { cuenta }) => {
        const tipo = toSentenceCase(cuenta.tipo || 'Sin Categoría');
        acc[tipo] = true;
        return acc;
    }, {})).sort();
    
    const colorMap = {};
    chartLabels.forEach((label, index) => {
        colorMap[label] = CHART_COLORS[index % CHART_COLORS.length];
    });

    const pillsHTML = allInvestmentTypes.map(t => {
        const isActive = !deselectedInvestmentTypesFilter.has(t);
        const color = colorMap[t];
        let style = '';
        if (isActive && color) {
            style = `style="background-color: ${color}; border-color: ${color}; color: #FFFFFF; box-shadow: 0 0 8px ${color}70;"`;
        }
        return `<button class="filter-pill ${isActive ? 'filter-pill--active' : ''}" data-action="toggle-investment-type-filter" data-type="${t}" ${style}>${t}</button>`;
    }).join('');

    const displayPerformance = displayAssetsData.reduce((acc, asset) => {
        acc.valorActual += asset.performance.valorActual;
        acc.capitalInvertido += asset.performance.capitalInvertido;
        return acc;
    }, { valorActual: 0, capitalInvertido: 0 });
    
    displayPerformance.pnlAbsoluto = displayPerformance.valorActual - displayPerformance.capitalInvertido;
    displayPerformance.pnlPorcentual = displayPerformance.capitalInvertido !== 0 ? (displayPerformance.pnlAbsoluto / displayPerformance.capitalInvertido) * 100 : 0;
    
    let irrCashflowsForDisplayGroup = [];
    displayAssetsData.forEach(asset => {
        irrCashflowsForDisplayGroup.push({ amount: asset.performance.valorActual, date: new Date() });
        (db.inversion_cashflows || []).filter(cf => cf.cuentaId === asset.cuenta.id).forEach(cf => {
            irrCashflowsForDisplayGroup.push({ amount: -cf.cantidad, date: new Date(cf.fecha) });
        });
    });
    displayPerformance.irr = calculateIRR(irrCashflowsForDisplayGroup);
    
    const pnlClassDisplay = displayPerformance.pnlAbsoluto >= 0 ? 'text-positive' : 'text-negative';
    const irrClassDisplay = displayPerformance.irr >= 0 ? 'text-positive' : 'text-negative';

    const assetCardsHTML = displayAssetsData.map(({ cuenta, performance }) => {
        const pnlClass = performance.pnlAbsoluto >= 0 ? 'text-positive' : 'text-negative';
        return `<div class="investment-asset-card" data-id="${cuenta.id}"><div class="investment-asset-card__header"><div style="cursor: pointer;" data-action="view-investment-detail" data-id="${cuenta.id}"><h3 class="investment-asset-card__name">${escapeHTML(cuenta.nombre)}</h3><small style="color: var(--c-on-surface-secondary);">${escapeHTML(cuenta.tipo)}</small></div><div><div class="investment-asset-card__value">${formatCurrency(performance.valorActual)}</div><div class="investment-asset-card__pnl ${pnlClass}">${performance.pnlAbsoluto >= 0 ? '+' : ''}${formatCurrency(performance.pnlAbsoluto)} (${performance.pnlPorcentual.toFixed(2)}%)</div></div></div></div>`;
    }).join('');

    container.innerHTML = `
        <div class="card card--no-bg accordion-wrapper">
             <details class="accordion" open>
                <summary>
                    <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">pie_chart</span>Asignación y Filtros</h3>
                    <span class="material-icons accordion__icon">expand_more</span>
                </summary>
                <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                    <div class="filter-pills" style="margin-bottom: var(--sp-5);">${pillsHTML}</div>
                    <div class="chart-container" style="height: 220px; margin-bottom: 0;"><canvas id="asset-allocation-chart"></canvas></div>
                </div>
            </details>
        </div>

        <div id="investment-global-kpis" style="margin-top: var(--sp-4);">
            <div style="display: flex; align-items: center; margin-bottom: var(--sp-2);"><h3 class="card__title" style="padding:0; margin:0; font-size: var(--fs-base);">Métricas del Portafolio (Filtrado)</h3></div>
            <div class="kpi-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: var(--sp-3);"><div class="kpi-item"><h4 class="kpi-item__label">Valor Total</h4><strong class="kpi-item__value">${formatCurrency(displayPerformance.valorActual)}</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Capital Total</h4><strong class="kpi-item__value">${formatCurrency(displayPerformance.capitalInvertido)}</strong></div></div>
            <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr;"><div class="kpi-item"><h4 class="kpi-item__label">P&L (€)</h4><strong class="kpi-item__value ${pnlClassDisplay}">${displayPerformance.pnlAbsoluto >= 0 ? '+' : ''}${formatCurrency(displayPerformance.pnlAbsoluto)}</strong></div><div class="kpi-item"><h4 class="kpi-item__label">P&L (%)</h4><strong class="kpi-item__value ${pnlClassDisplay}">${displayPerformance.pnlPorcentual.toFixed(2)}%</strong></div><div class="kpi-item"><h4 class="kpi-item__label" style="display: flex; align-items: center; gap: 4px;">
    <span>TIR Anualizada</span>
    <button class="icon-btn" data-action="show-help-topic" data-topic="tir" style="width: 20px; height: 20px;">
        <span class="material-icons" style="font-size: 16px;">help_outline</span>
    </button>
</h4>><strong class="kpi-item__value ${irrClassDisplay}">${(displayPerformance.irr * 100).toFixed(2)}%</strong></div></div>
        </div>
        
        <div id="investment-assets-list" style="margin-top: var(--sp-4);">${assetCardsHTML}</div>
        
        <div class="card card--no-bg" style="padding:0; margin-top: var(--sp-4);"><div class="form-grid"><button class="btn btn--secondary" data-action="manage-investment-accounts"><span class="material-icons" style="font-size:16px;">checklist</span>Gestionar Activos</button><button class="btn btn--secondary" data-action="add-aportacion"><span class="material-icons" style="font-size:16px;">add_card</span>Aportar/Retirar</button></div></div>
    `;
    
    setTimeout(() => {
        const allocationCtx = select('asset-allocation-chart');
        if (allocationCtx) {
            if (assetAllocationChart) assetAllocationChart.destroy();
            
            const allocationData = displayAssetsData.reduce((acc, { cuenta, performance }) => {
                const tipo = toSentenceCase(cuenta.tipo || 'Sin Categoría');
                if (!acc[tipo]) acc[tipo] = 0;
                acc[tipo] += performance.valorActual;
                return acc;
            }, {});

            const chartValues = chartLabels.map(label => allocationData[label] || 0);
            
            if (chartLabels.length > 0) {
                assetAllocationChart = new Chart(allocationCtx, {
                    type: 'doughnut',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartValues.map(v => v / 100),
                            backgroundColor: chartLabels.map(label => colorMap[label]),
                            borderColor: getComputedStyle(document.body).getPropertyValue('--c-surface'),
                            borderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (evt, elements) => {
                            if (elements.length > 0) {
                                const clickedLabel = assetAllocationChart.data.labels[elements[0].index];
                                deselectedInvestmentTypesFilter.clear();
                                allInvestmentTypes.forEach(type => {
                                    if (type !== clickedLabel) {
                                        deselectedInvestmentTypesFilter.add(type);
                                    }
                                });
                                renderInversionesPage('analisis-inversiones-container');
                            }
                        },
                        onHover: (event, chartElement) => {
                            event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                        },
                        plugins: {
                            // ===== INICIO DEL CAMBIO =====
                            legend: {
                                display: false // ¡Adiós, leyenda!
                            },
                            // ===== FIN DEL CAMBIO =====
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed !== null) { label += formatCurrency(context.parsed * 100); }
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                formatter: (value, context) => {
                                    const sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = sum > 0 ? (value * 100 / sum).toFixed(0) + "%" : "0%";
                                    return percentage;
                                },
                                color: getComputedStyle(document.body).getPropertyValue('--c-on-surface'),
                                font: { weight: 'bold', size: 11 }
                            }
                        }
                    }
                });
            }
        }
    }, 50);
};

        const renderInformesPage = async () => {
            const resultsContainer = select('informe-results-container');
            const emptyState = select('empty-informes');
            const kpiContainer = select('informe-kpi-container');
            const chartCanvas = select('informes-chart');
            const chartCtx = chartCanvas ? chartCanvas.getContext('2d') : null;
        
            if (!resultsContainer || !emptyState || !chartCtx || !kpiContainer) return;
            if (informesChart) { informesChart.destroy(); }
            
            const fechaInicioEl = select('informe-fecha-inicio');
            const fechaFinEl = select('informe-fecha-fin');
            const fechaInicioVal = fechaInicioEl ? fechaInicioEl.value : null;
            const fechaFinVal = fechaFinEl ? fechaFinEl.value : null;
            
            const cuentaIdEl = select('filter-cuenta-informe');
            const conceptoIdEl = select('filter-concepto-informe');
            const cuentaId = cuentaIdEl ? cuentaIdEl.value : null;
            const conceptoId = conceptoIdEl ? conceptoIdEl.value : null;
        
            if (!fechaInicioVal || !fechaFinVal) {
                resultsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
        
            const fechaInicio = parseDateStringAsUTC(fechaInicioVal);
            const fechaFin = parseDateStringAsUTC(fechaFinVal);
            
            const visibleAccountIds = getVisibleAccounts().map(c => c.id);
            if (visibleAccountIds.length === 0) {
                showToast('No hay cuentas seleccionadas en esta contabilidad.', 'info');
                resultsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                const p = emptyState.querySelector('p');
                if (p) p.textContent = "No hay cuentas visibles para generar el informe.";
                return;
            }
        
            let baseQuery = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
                .where('fecha', '>=', fechaInicio.toISOString())
                .where('fecha', '<=', fechaFin.toISOString())
                .where('tipo', '==', 'movimiento');

            if (conceptoId) {
                baseQuery = baseQuery.where('conceptoId', '==', conceptoId);
            }
            
            const accountIdsToQuery = cuentaId ? [cuentaId] : visibleAccountIds;
            const movimientos = await fetchMovementsInChunks(baseQuery, 'cuentaId', accountIdsToQuery);
            
            if (movimientos.length === 0) {
                showToast('No se encontraron movimientos para los filtros seleccionados.', 'info');
                resultsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                const p = emptyState.querySelector('p');
                if (p) p.textContent = "No hay datos para este informe. Prueba a cambiar los filtros.";
                return;
            }
            
        
            resultsContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            const datosAgrupados = movimientos.reduce((acc, mov) => {
                const fecha = new Date(mov.fecha);
                const clave = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                if (!acc[clave]) {
                    acc[clave] = { ingresos: 0, gastos: 0 };
                }

                if (mov.tipo === 'movimiento') {
                    if (mov.cantidad > 0) {
                        acc[clave].ingresos += mov.cantidad;
                    } else {
                        acc[clave].gastos += mov.cantidad;
                    }
                } else if (mov.tipo === 'traspaso') {
                    if (cuentaId) { 
                        if (mov.cuentaDestinoId === cuentaId) {
                            acc[clave].ingresos += mov.cantidad;
                        }
                        if (mov.cuentaOrigenId === cuentaId) {
                            acc[clave].gastos -= mov.cantidad;
                        }
                    }
                }
                return acc;
            }, {});
        
            const etiquetas = Object.keys(datosAgrupados).sort();
            const datosIngresos = etiquetas.map(clave => datosAgrupados[clave].ingresos / 100);
            const datosGastos = etiquetas.map(clave => Math.abs(datosAgrupados[clave].gastos / 100));
        
            const etiquetasFormateadas = etiquetas.map(clave => {
                const [year, month] = clave.split('-');
                return new Date(parseInt(year), parseInt(month) - 1).toLocaleDateString(locales[currentLanguage], { month: 'short', year: '2-digit' });
            });
            
            const totalIngresos = datosIngresos.reduce((sum, val) => sum + (val * 100), 0);
            const totalGastos = datosGastos.reduce((sum, val) => sum + (val * 100), 0);
            const neto = totalIngresos - totalGastos;
            
            kpiContainer.innerHTML = `
                <div class="kpi-item"><h4 class="kpi-item__label">Total Ingresos</h4><strong class="kpi-item__value text-positive">${formatCurrency(totalIngresos)}</strong></div>
                <div class="kpi-item"><h4 class="kpi-item__label">Total Gastos</h4><strong class="kpi-item__value text-negative">${formatCurrency(-totalGastos)}</strong></div>
                <div class="kpi-item"><h4 class="kpi-item__label">Resultado Neto</h4><strong class="kpi-item__value ${neto >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(neto)}</strong></div>
            `;
        
            informesChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: etiquetasFormateadas,
                    datasets: [
                        { label: 'Ingresos', data: datosIngresos, borderColor: getComputedStyle(document.body).getPropertyValue('--c-success'), backgroundColor: 'rgba(48, 209, 88, 0.2)', fill: true, tension: 0.3, pointBackgroundColor: getComputedStyle(document.body).getPropertyValue('--c-success') },
                        { label: 'Gastos', data: datosGastos, borderColor: getComputedStyle(document.body).getPropertyValue('--c-danger'), backgroundColor: 'rgba(255, 59, 48, 0.2)', fill: true, tension: 0.3, pointBackgroundColor: getComputedStyle(document.body).getPropertyValue('--c-danger') }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: (value) => formatCurrency(value * 100).replace(/\s/g, '') } } },
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${formatCurrency(c.parsed.y * 100)}` } }, datalabels: { display: false } }
                }
            });
        };
        
        const renderVirtualListItem = (item) => {
            if (item.type === 'date-header') {
                const dateObj = new Date(item.date + 'T12:00:00Z');
                const day = dateObj.toLocaleDateString(locales[currentLanguage], { weekday: 'short' }).toUpperCase().replace('.', '');
                const dateStr = dateObj.toLocaleDateString(locales[currentLanguage], { day: '2-digit', month: '2-digit', year: 'numeric' });

                return `
                    <div class="movimiento-date-header">
                        <span>${day} ${dateStr}</span>
                        <span>${formatCurrency(item.total)}</span>
                    </div>
                `;
            }

            const m = item.movement;
            let highlightClass = '';
            if (m.id === newMovementIdToHighlight) {
                highlightClass = 'highlight-animation';
                newMovementIdToHighlight = null;
            }

            const formattedDate = new Date(m.fecha).toLocaleDateString(locales[currentLanguage], { day: '2-digit', month: '2-digit', year: 'numeric' });
            let indicatorClass = '';
            
            if (m.tipo === 'traspaso') indicatorClass = 'transaction-card__indicator--transfer';
            else if (m.cantidad >= 0) indicatorClass = 'transaction-card__indicator--income';
            else indicatorClass = 'transaction-card__indicator--expense';

            if (m.tipo === 'traspaso') {
                const origen = db.cuentas.find(c => c.id === m.cuentaOrigenId);
                const destino = db.cuentas.find(c => c.id === m.cuentaDestinoId);
                return `
                    <div class="transaction-card ${highlightClass}" data-action="edit-movement" data-id="${m.id}">
                        <div class="transaction-card__indicator ${indicatorClass}"></div>
                        <div class="transaction-card__content">
                            <div class="transaction-card__details">
                                <div class="transaction-card__concept">${escapeHTML(m.descripcion) || 'Traspaso'}</div>
                                <div class="transaction-card__description">${formattedDate}</div>
                                <div class="transaction-card__transfer-details">
                                    <div class="transaction-card__transfer-row">
                                        <span><span class="material-icons">arrow_upward</span> ${(origen && origen.nombre) || '?'}</span>
                                        <span class="transaction-card__balance">${formatCurrency(m.runningBalanceOrigen)}</span>
                                    </div>
                                    <div class="transaction-card__transfer-row">
                                        <span><span class="material-icons">arrow_downward</span> ${(destino && destino.nombre) || '?'}</span>
                                        <span class="transaction-card__balance">${formatCurrency(m.runningBalanceDestino)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="transaction-card__figures">
                                <div class="transaction-card__amount text-info">${formatCurrency(m.cantidad)}</div>
                            </div>
                        </div>
                    </div>`;
            } else {
                const cuenta = db.cuentas.find(c => c.id === m.cuentaId);
                const concept = db.conceptos.find(c => c.id === m.conceptoId);
                const amountClass = m.cantidad >= 0 ? 'text-positive' : 'text-negative';
                return `
                    <div class="transaction-card ${highlightClass}" data-action="edit-movement" data-id="${m.id}">
                        <div class="transaction-card__indicator ${indicatorClass}"></div>
                        <div class="transaction-card__content">
                            <div class="transaction-card__details">
                                <div class="transaction-card__row-1">${toSentenceCase((concept && concept.nombre) || 'S/C')}</div>
                                <div class="transaction-card__row-2">${formattedDate} • ${escapeHTML(m.descripcion)}</div>
                            </div>
                            <div class="transaction-card__figures">
                                <div class="transaction-card__amount ${amountClass}">${formatCurrency(m.cantidad)}</div>
                                <div class="transaction-card__balance">${formatCurrency(m.runningBalance)}</div>
                                <div class="transaction-card__row-2" style="text-align: right;">${escapeHTML((cuenta && cuenta.nombre) || 'S/C')}</div>
                            </div>
                        </div>
                    </div>`;
            }
        };
        
        const renderVisibleItems = () => {
            if (!vList.scrollerEl || !vList.contentEl) return; 
            const scrollTop = vList.scrollerEl.scrollTop;
            const containerHeight = vList.scrollerEl.clientHeight;
            let startIndex = -1, endIndex = -1;
            
            for (let i = 0; i < vList.itemMap.length; i++) {
                const item = vList.itemMap[i];
                if (startIndex === -1 && item.offset + item.height > scrollTop) {
                    startIndex = Math.max(0, i - vList.renderBuffer);
                }
                if (endIndex === -1 && item.offset + item.height > scrollTop + containerHeight) {
                    endIndex = Math.min(vList.itemMap.length - 1, i + vList.renderBuffer);
                    break;
                }
            }
            if (startIndex === -1 && vList.items.length > 0) startIndex = 0;
            if (endIndex === -1) endIndex = vList.itemMap.length - 1;
            
            if (startIndex === vList.lastRenderedRange.start && endIndex === vList.lastRenderedRange.end) return;
            
            let visibleHtml = ''; 
            for (let i = startIndex; i <= endIndex; i++) {
                if (vList.items[i]) visibleHtml += renderVirtualListItem(vList.items[i]);
            }
            vList.contentEl.innerHTML = visibleHtml; 
            const offsetY = vList.itemMap[startIndex] ? vList.itemMap[startIndex].offset : 0; 
            vList.contentEl.style.transform = `translateY(${offsetY}px)`; 
            vList.lastRenderedRange = { start: startIndex, end: endIndex };
        };
        
        const loadInitialMovements = async () => {
            const emptyEl = select('empty-movimientos'), listContainer = select('movimientos-list-container');
            if (!vList.scrollerEl) {
                vList.scrollerEl = selectOne('.app-layout__main');
                vList.sizerEl = select('virtual-list-sizer');
                vList.contentEl = select('virtual-list-content');
            }
            if (!listContainer || !emptyEl || !vList.sizerEl || !vList.contentEl) return;
            
            listContainer.classList.remove('hidden');
            emptyEl.classList.add('hidden');
            
            lastVisibleMovementDoc = null;
            allMovementsLoaded = false;
            isLoadingMoreMovements = false;
            runningBalancesCache = null;
			db.movimientos = []; // Clear local movements cache
            vList.items = [];
            vList.itemMap = [];
            vList.sizerEl.style.height = '0px';
            vList.contentEl.innerHTML = '';

            await loadMoreMovements(true); // Perform the initial load
        };

        const filterMovementsByLedger = (movements) => {
            const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
            if (visibleAccountIds.size === 0) return [];
            
            return movements.filter(m => {
                if (m.tipo === 'traspaso') {
                    return visibleAccountIds.has(m.cuentaOrigenId) || visibleAccountIds.has(m.cuentaDestinoId);
                } else {
                    return visibleAccountIds.has(m.cuentaId);
                }
            });
        };

        	async function fetchMovementsPage(startAfterDoc = null) {
            if (!currentUser) return [];
            try {
                let query = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
                    .orderBy('fecha', 'desc');

                if (startAfterDoc) {
                    query = query.startAfter(startAfterDoc);
                }

                query = query.limit(MOVEMENTS_PAGE_SIZE);
                const snapshot = await query.get();

                if (snapshot.empty) {
                    allMovementsLoaded = true;
                    return [];
                }

                lastVisibleMovementDoc = snapshot.docs[snapshot.docs.length - 1];

                if (snapshot.docs.length < MOVEMENTS_PAGE_SIZE) {
                    allMovementsLoaded = true;
                }
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            } catch (error) {
                console.error("Error al obtener los movimientos:", error);
                showToast("Error al cargar los movimientos.", "danger");
                return [];
            }
        }
		// REEMPLAZAR la función 'loadMoreMovements' existente con esta versión corregida
const loadMoreMovements = async (isInitial = false) => {
    if (isLoadingMoreMovements || allMovementsLoaded) {
        return;
    }

    isLoadingMoreMovements = true;
    const loader = select('list-loader');
    if (loader) loader.classList.remove('hidden');

    try {
        const visibleAccountIds = getVisibleAccounts().map(c => c.id);
        if (visibleAccountIds.length === 0) {
            allMovementsLoaded = true;
            db.movimientos = []; // Clear current movements if no accounts
            vList.items = [];
            vList.itemMap = [];
            vList.sizerEl.style.height = '0px';
            vList.contentEl.innerHTML = '';
            select('movimientos-list-container')?.classList.add('hidden');
            select('empty-movimientos')?.classList.remove('hidden');
            return;
        }

        let fetchedFilteredCount = 0;
        let processedFilteredMovements = []; // Stores filtered movements from this loading cycle

        // Keep fetching raw batches from Firestore until we have at least MOVEMENTS_PAGE_SIZE *filtered* items
        // or we run out of documents in Firestore.
        while (fetchedFilteredCount < MOVEMENTS_PAGE_SIZE && !allMovementsLoaded) {
            const newRawMovs = await fetchMovementsPage(lastVisibleMovementDoc); // Fetches next raw page from Firestore

            if (newRawMovs.length === 0) {
                allMovementsLoaded = true; // No more raw documents in DB
                break;
            }

            // Filter the current raw batch by ledger
            const filteredBatch = filterMovementsByLedger(newRawMovs);
            processedFilteredMovements.push(...filteredBatch);
            fetchedFilteredCount += filteredBatch.length;

            // Advance the Firestore cursor based on the *last raw document* fetched,
            // regardless of whether it was filtered out. This ensures correct pagination for the raw stream.
            lastVisibleMovementDoc = newRawMovs[newRawMovs.length - 1];

            // If the raw batch was smaller than MOVEMENTS_PAGE_SIZE, it means Firestore has no more documents.
            if (newRawMovs.length < MOVEMENTS_PAGE_SIZE) {
                allMovementsLoaded = true;
            }
        }
        
        // Process only the *filtered* movements accumulated in this loading cycle
        if (processedFilteredMovements.length > 0) {
            await processMovementsForRunningBalance(processedFilteredMovements);
            db.movimientos = [...db.movimientos, ...processedFilteredMovements]; // Append to the global filtered list
            updateVirtualList(processedFilteredMovements, false); // Update the virtual DOM
        } else if (isInitial && db.movimientos.length === 0 && allMovementsLoaded) {
            // If after the initial load, no movements are found for this ledger and all movements are considered loaded
            const listContainer = select('movimientos-list-container');
            const emptyMovimientos = select('empty-movimientos');
            if(listContainer) listContainer.classList.add('hidden');
            if(emptyMovimientos) emptyMovimientos.classList.remove('hidden');
        }

    } catch (error) {
        console.error("Error al cargar más movimientos:", error);
        showToast("No se pudieron cargar más movimientos.", "danger");
    } finally {
        isLoadingMoreMovements = false;
        if (loader) loader.classList.add('hidden');
    }
};
           
        const updateVirtualList = (newItemsChunk, replace = false) => {
            if (replace) {
                db.movimientos = [];
            }
        
            const grouped = {};
            (db.movimientos || []).forEach(mov => {
                const dateKey = mov.fecha.slice(0, 10);
                if (!grouped[dateKey]) {
                    grouped[dateKey] = { movements: [], total: 0 };
                }
                grouped[dateKey].movements.push(mov);
                
                if (mov.tipo === 'traspaso') {
                    const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
                    const origenVisible = visibleAccountIds.has(mov.cuentaOrigenId);
                    const destinoVisible = visibleAccountIds.has(mov.cuentaDestinoId);
                    if (origenVisible && !destinoVisible) {
                        grouped[dateKey].total -= mov.cantidad;
                    } else if (!origenVisible && destinoVisible) {
                        grouped[dateKey].total += mov.cantidad;
                    }
                } else {
                    grouped[dateKey].total += mov.cantidad;
                }
            });

            vList.items = [];
            vList.itemMap = [];
            let currentHeight = 0;
            const sortedDates = Object.keys(grouped).sort((a, b) => b.localeCompare(a));

            for (const dateKey of sortedDates) {
                const group = grouped[dateKey];
        
                vList.items.push({ type: 'date-header', date: dateKey, total: group.total });
                vList.itemMap.push({ height: vList.heights.header, offset: currentHeight });
                currentHeight += vList.heights.header;
        
                for (const mov of group.movements) {
                    const itemHeight = mov.tipo === 'traspaso' ? vList.heights.transfer : vList.heights.transaction;
                    vList.items.push({ type: 'transaction', movement: mov });
                    vList.itemMap.push({ height: itemHeight, offset: currentHeight });
                    currentHeight += itemHeight;
                }
            }
            
            if (vList.sizerEl) {
                vList.sizerEl.style.height = `${currentHeight}px`;
            }
            
            vList.lastRenderedRange = { start: -1, end: -1 };
            renderVisibleItems();
            
            buildIntelligentIndex(); 
        };
		const getYearProgress = () => {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 0);
    const diff = now - start;
    const oneDay = 1000 * 60 * 60 * 24;
    const dayOfYear = Math.floor(diff / oneDay);
    const year = now.getFullYear();
    const isLeap = (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
    const totalDaysInYear = isLeap ? 366 : 365;

    return {
        percentage: (dayOfYear / totalDaysInYear) * 100,
        daysPassed: dayOfYear,
        daysRemaining: totalDaysInYear - dayOfYear,
        totalDaysInYear: totalDaysInYear
    };
};

const renderGaugeChart = (canvasId, percentageConsumed, yearProgressPercentage) => {
    const canvas = select(canvasId);
    const ctx = canvas ? canvas.getContext('2d') : null;
    if (!ctx) return;

    if (Chart.getChart(canvasId)) {
        Chart.getChart(canvasId).destroy();
    }

    const isAheadOfPace = percentageConsumed > yearProgressPercentage;
    
    const spentColor = isAheadOfPace ? 'var(--c-danger)' : 'var(--c-primary)';
    const remainingColor = 'var(--c-surface-variant)';

    const data = {
        datasets: [{
            data: [
                Math.min(percentageConsumed, 100),
                Math.max(0, 100 - Math.min(percentageConsumed, 100))
            ],
            backgroundColor: [spentColor, remainingColor],
            borderColor: 'var(--c-surface)',
            borderWidth: 2,
        }]
    };
    
    const paceLinePlugin = {
        id: 'paceLine',
        afterDraw: chart => {
            const { ctx, chartArea } = chart;
            const angle = Math.PI + (Math.PI * yearProgressPercentage / 100);
            const cx = (chartArea.left + chartArea.right) / 2;
            const cy = (chartArea.top + chartArea.bottom) / 2 + 15;
            const radius = chart.outerRadius;

            ctx.save();
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + radius * Math.sin(angle), cy + radius * Math.cos(angle));
            ctx.strokeStyle = 'var(--c-success)';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.restore();
        }
    };

    new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            rotation: -90,
            circumference: 180,
            cutout: '70%',
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
                datalabels: { display: false }
            }
        },
        plugins: [paceLinePlugin]
    });
};

const renderBudgetTrendChart = (monthlyIncomeData, monthlyExpenseData, averageBudgetedExpense) => {
    const canvasId = 'budget-trend-chart';
    const canvas = select(canvasId);
    const ctx = canvas ? canvas.getContext('2d') : null;
    if (!ctx) return;

    if (Chart.getChart(canvasId)) {
        Chart.getChart(canvasId).destroy();
    }

    const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const incomeData = labels.map((_, i) => (monthlyIncomeData[i] || 0) / 100);
    const expenseData = labels.map((_, i) => (monthlyExpenseData[i] || 0) / 100);
    
    const colorSuccess = getComputedStyle(document.body).getPropertyValue('--c-success').trim();
    const colorDanger = getComputedStyle(document.body).getPropertyValue('--c-danger').trim();
    const colorWarning = getComputedStyle(document.body).getPropertyValue('--c-warning').trim();

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Ingresos Mensuales',
                    data: incomeData,
                    backgroundColor: colorSuccess, 
                    borderRadius: 4,
                    order: 2
                },
                {
                    label: 'Gastos Mensuales',
                    data: expenseData,
                    backgroundColor: colorDanger, 
                    borderRadius: 4,
                    order: 3
                },
                {
                    type: 'line',
                    label: 'Promedio Gasto Presupuestado',
                    data: Array(12).fill(averageBudgetedExpense / 100),
                    borderColor: colorWarning,
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    order: 1,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { callback: value => `€${value}` } },
                x: { grid: { display: false } }
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: { mode: 'index', intersect: false },
                datalabels: { display: false }
            }
        }
    });
};

		const renderCuentas = async (targetContainerId, accountsToRender, totalPatrimonio = 0) => {
    const container = select(targetContainerId);
    if (!container) return;

    const saldos = getAllSaldos();
    const allAccounts = accountsToRender; // <-- AHORA USA LA LISTA PRE-FILTRADA
    const allAccountTypes = [...new Set(allAccounts.map((c) => toSentenceCase(c.tipo || 'S/T')))];

    // El filtro de píldoras sigue funcionando sobre la lista ya filtrada por el gráfico
    const filteredAccountTypes = new Set(allAccountTypes.filter(t => !deselectedAccountTypesFilter.has(t)));

    const accountsByType = allAccounts.reduce((acc, c) => {
        const tipo = toSentenceCase(c.tipo || 'S/T');
        if (!acc[tipo]) acc[tipo] = [];
        acc[tipo].push(c);
        return acc;
    }, {});
    
    const resumenHTML = Object.keys(accountsByType).sort().map(tipo => {
        if (!filteredAccountTypes.has(tipo)) return '';
        
        const accountsInType = accountsByType[tipo];
        const typeBalance = accountsInType.reduce((sum, account) => sum + (saldos[account.id] || 0), 0);
        
        // Ahora el porcentaje se calcula sobre el total del patrimonio visible, que es más correcto
        const porcentajeGlobal = totalPatrimonio > 0 ? (typeBalance / totalPatrimonio) * 100 : 0;

        const accountsHtml = accountsInType.sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => {
            const balance = saldos[c.id] || 0;
            const porcentajeGrupo = typeBalance !== 0 ? (balance / typeBalance) * 100 : 0;
            const investmentIcon = c.esInversion ? `<span class="material-icons text-info" style="font-size: 14px; margin-left: var(--sp-2);" title="Cuenta de Portafolio">trending_up</span>` : '';
            
            return `
                <div class="modal__list-item" data-action="view-account-details" data-id="${c.id}" style="cursor: pointer; padding-left: 0; padding-right: 0;">
                    <div>
                        <span style="display: block; font-weight: 500;">${c.nombre}</span>
                        <small style="color: var(--c-on-surface-secondary); font-weight: 500;">${porcentajeGrupo.toFixed(1)}% del total de ${tipo}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--sp-2);">${formatCurrency(balance)}${investmentIcon}<span class="material-icons" style="font-size: 18px; color: var(--c-on-surface-secondary);">chevron_right</span></div>
                </div>`;
        }).join('');
        
        if (!accountsHtml) return '';
        
        const icon = tipo==='EFECTIVO'?'payments':(tipo.includes('TARJETA')?'credit_card':(tipo==='AHORRO'?'savings':(tipo==='INVERSIÓN'?'trending_up':(tipo==='PROPIEDAD'?'domain':(tipo==='PRÉSTAMO'?'credit_score':'account_balance')))));
        
        return `
            <details class="accordion">
                <summary>
                    <span class="account-group__name"><span class="material-icons" style="vertical-align:bottom;font-size:16px;margin-right:8px">${icon}</span>${tipo}</span>
                    <div style="display:flex; align-items:center; gap:var(--sp-2);">
                        <small style="color: var(--c-on-surface-tertiary); font-weight: 600; margin-right: var(--sp-2);">${porcentajeGlobal.toFixed(1)}%</small>
                        <span class="account-group__balance">${formatCurrency(typeBalance)}</span>
                        <span class="material-icons accordion__icon">expand_more</span>
                    </div>
                </summary>
                <div class="accordion__content">${accountsHtml}</div>
            </details>`;
    }).join('');

    container.innerHTML = `<div class="accordion-wrapper">${resumenHTML}</div>`;
};
                
        
        const loadConfig = () => { 
            (select('config-skip-intro')).checked = !!(db.config && db.config.skipIntro);
            const userEmailEl = select('config-user-email'); 
            if (userEmailEl && currentUser) userEmailEl.textContent = currentUser.email;
            
            
            renderLanguageSelector();
			
        };
        
		 const renderInicioPage = () => {
    const container = select(PAGE_IDS.INICIO);
    if (!container) return;

    if (conceptosChart) {
        conceptosChart.destroy();
        conceptosChart = null;
    }

    container.innerHTML = `
        <div id="inicio-view-switcher" class="filter-pills" style="justify-content: center;">
            <button class="filter-pill filter-pill--active" data-action="set-inicio-view" data-view="recientes">Recientes</button>
            <button class="filter-pill" data-action="set-inicio-view" data-view="resumen">Resumen</button>
        </div>

        <div id="pending-recurrents-container"></div>
        <div id="inicio-view-recientes"></div>

		<div id="inicio-view-resumen" class="hidden">
            <div class="card card--no-bg" id="dashboard-filters-widget">
                <div class="accordion-wrapper">
                    <details class="accordion">
                        <summary><h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">filter_list</span>Filtros</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <div class="form-group">
                                <label for="filter-periodo" class="form-label">Periodo</label>
                                <select id="filter-periodo" class="form-select">
                                    <option value="mes-actual" selected>Mes Actual</option>
                                    <option value="año-actual">Año Actual</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            
                            <div id="custom-date-filters" class="form-grid hidden" style="margin-bottom: var(--sp-3);">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="filter-fecha-inicio" class="form-label">Desde</label>
                                    <input type="date" id="filter-fecha-inicio" class="form-input" />
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="filter-fecha-fin" class="form-label">Hasta</label>
                                    <input type="date" id="filter-fecha-fin" class="form-input" />
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group"><label for="filter-cuenta" class="form-label">Cuenta</label><select id="filter-cuenta" class="form-select"></select></div>
                                <div class="form-group"><label for="filter-concepto" class="form-label">Concepto</label><select id="filter-concepto" class="form-select"></select></div>
                            </div>
                            <button data-action="apply-filters" class="btn btn--primary btn--full">Aplicar Filtros</button>
                        </div>
                    </details>
                </div>
            </div>
            <section id="kpi-container" class="kpi-grid" aria-label="Indicadores clave de rendimiento"></section>
            
            <div id="resumen-content-container"></div>
        </div>
    `;
    
    populateAllDropdowns();
    
    const filterPeriodo = select('filter-periodo');
    if (filterPeriodo) filterPeriodo.dispatchEvent(new Event('change')); 
    renderPendingRecurrents();
    renderInicioResumenView();
    renderInicioRecientesView();
};    
        const renderDashboardKpiSummary = () => {
            return `<div class="kpi-item"><h4 class="kpi-item__label">Ingresos</h4><strong id="kpi-ingresos-value" class="kpi-item__value text-positive skeleton" data-current-value="0">+0,00 €</strong><div id="kpi-ingresos-comparison" class="kpi-item__comparison"></div></div>
                    <div class="kpi-item"><h4 class="kpi-item__label">Gastos</h4><strong id="kpi-gastos-value" class="kpi-item__value text-negative skeleton" data-current-value="0">0,00 €</strong><div id="kpi-gastos-comparison" class="kpi-item__comparison"></div></div>
                    <div class="kpi-item"><h4 class="kpi-item__label">Saldo Neto</h4><strong id="kpi-saldo-value" class="kpi-item__value skeleton" data-current-value="0">0,00 €</strong><div id="kpi-saldo-comparison" class="kpi-item__comparison"></div></div>`;
        };
        
        const renderDashboardConceptTotals = () => {
            return `
                <div class="card card--no-bg" id="concept-totals-widget">
                    <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary><h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">category</span>Totales por Concepto</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);"><div class="chart-container" style="height: 240px; margin-bottom: var(--sp-2);"><canvas id="conceptos-chart"></canvas></div><div id="concepto-totals-list">${Array(3).fill('<div class="skeleton" style="height: 48px; margin-bottom: 2px;"></div>').join('')}</div></div>
                        </details>
                    </div>
                </div>`;
        };
        const renderInicioResumenView = () => {
            const widgetOrder = (db.config && db.config.dashboardWidgets) || DEFAULT_DASHBOARD_WIDGETS;
            const resumenContentContainer = select('resumen-content-container');
            const kpiContainer = select('kpi-container');

            if(!resumenContentContainer || !kpiContainer) return;

            kpiContainer.innerHTML = renderDashboardKpiSummary();
            resumenContentContainer.innerHTML = widgetOrder.map(widgetId => {
                if (widgetId === 'concept-totals') return renderDashboardConceptTotals();
                return '';
            }).join('');
            
            updateDashboardData();
        };

        const _renderRecientesFromCache = async () => {
            const recientesContainer = select('inicio-view-recientes');
            if (!recientesContainer) return;
            
            const movsToDisplay = recentMovementsCache;
            
            if (movsToDisplay.length === 0) {
                recientesContainer.innerHTML = `<div class="empty-state" style="border: none; background: transparent;"><p>No hay movimientos recientes en esta contabilidad.</p></div>`;
                return;
            }

            await processMovementsForRunningBalance(movsToDisplay, true); 

            const grouped = {};
            const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
            movsToDisplay.forEach(mov => {
                const dateKey = mov.fecha.slice(0, 10);
                if (!grouped[dateKey]) {
                    grouped[dateKey] = { movements: [], total: 0 };
                }
                grouped[dateKey].movements.push(mov);
                if (mov.tipo === 'traspaso') {
                    const origenVisible = visibleAccountIds.has(mov.cuentaOrigenId);
                    const destinoVisible = visibleAccountIds.has(mov.cuentaDestinoId);
                    if (origenVisible && !destinoVisible) { grouped[dateKey].total -= mov.cantidad; }
                    else if (!origenVisible && destinoVisible) { grouped[dateKey].total += mov.cantidad; }
                } else {
                    grouped[dateKey].total += mov.cantidad;
                }
            });

            let html = '';
            const sortedDates = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
            for (const dateKey of sortedDates) {
                const group = grouped[dateKey];
                html += renderVirtualListItem({ type: 'date-header', date: dateKey, total: group.total });
                
                group.movements.sort((a, b) => b.id.localeCompare(a.id));

                for (const mov of group.movements) {
                    html += renderVirtualListItem({ type: 'transaction', movement: mov });
                }
            }
            html += `<div style="text-align: center; margin-top: var(--sp-4);"><button class="btn btn--secondary" data-action="navigate" data-page="${PAGE_IDS.MOVIMIENTOS_FULL}">Ver todos los movimientos</button></div>`;
            recientesContainer.innerHTML = html;
        };
		 const renderPendingRecurrents = () => {
            const container = select('pending-recurrents-container');
            if (!container || !db.recurrentes) return;

            const now = new Date();
            const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            
            const pending = db.recurrentes
            .filter(r => {
                const nextDate = parseDateStringAsUTC(r.nextDate);
                const normalizedNextDate = new Date(Date.UTC(nextDate.getUTCFullYear(), nextDate.getUTCMonth(), nextDate.getUTCDate()));
                return normalizedNextDate <= today;
            })
            .sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));

            if (pending.length === 0) {
                container.innerHTML = '';
                return;
            }

            const itemsHTML = pending.map(r => {
                const nextDate = new Date(r.nextDate + 'T12:00:00Z');
                const formattedDate = nextDate.toLocaleDateString(locales[currentLanguage], { day: '2-digit', month: 'short', year: 'numeric' });
                const amountClass = r.cantidad >= 0 ? 'text-positive' : 'text-negative';
                const dateText = `Pendiente desde: ${formattedDate}`;

                return `
                <div class="transaction-card" id="pending-recurrente-${r.id}" style="background-color: color-mix(in srgb, var(--c-warning) 10%, transparent);">
                    <div class="transaction-card__indicator transaction-card__indicator--recurrent"></div>
                    <div class="transaction-card__content">
                        <div class="transaction-card__details">
                            <div class="transaction-card__row-1">${escapeHTML(r.descripcion)}</div>
                            <div class="transaction-card__row-2" style="font-weight: 600; color: var(--c-warning);">${dateText}</div>
                        </div>
                        <div class="transaction-card__figures" style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
							<strong class="transaction-card__amount ${amountClass}">${formatCurrency(r.cantidad)}</strong>
    
						<div style="display: flex; align-items: center; gap: 8px;">
							<button class="btn btn--secondary" data-action="skip-recurrent" data-id="${r.id}" title="Omitir esta vez" style="padding: 4px 8px; font-size: 0.7rem;">
							<span class="material-icons" style="font-size: 14px;">skip_next</span>No añadir
							</button>
							<button class="btn btn--primary" data-action="confirm-recurrent" data-id="${r.id}" title="Crear el movimiento ahora" style="padding: 4px 8px; font-size: 0.7rem;">
							<span class="material-icons" style="font-size: 14px;">check</span>Añadir Ahora
							</button>
						</div>
                    </div>
                </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="card card--no-bg accordion-wrapper" style="margin-top: var(--sp-4);">
                    <details class="accordion" open>
                        <summary>
                            <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">event_repeat</span>
                                Operaciones Recurrentes Pendientes
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: 0 var(--sp-2) var(--sp-2) var(--sp-2);">${itemsHTML}</div>
                    </details>
                </div>
            `;
        };
const renderInicioRecientesView = async () => {
            const recientesContainer = select('inicio-view-recientes');
            if (!recientesContainer) return;
            
            if (unsubscribeRecientesListener) {
                unsubscribeRecientesListener();
            }

            recientesContainer.innerHTML = `<div class="skeleton" style="height: 200px;"></div>`;

            const RECIENTES_COUNT = 30;
            const query = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
                .orderBy('fecha', 'desc')
                .limit(RECIENTES_COUNT);

            unsubscribeRecientesListener = query.onSnapshot(async (snapshot) => {
                const allRecentMovs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                recentMovementsCache = filterMovementsByLedger(allRecentMovs);
                
                buildIntelligentIndex(recentMovementsCache);
                
                _renderRecientesFromCache();

            }, (error) => {
                console.error("Error en el listener de movimientos recientes:", error);
                recientesContainer.innerHTML = `<p class="text-danger">Error al cargar movimientos.</p>`;
            });
        };
 // =================================================================================
// INICIO: VERSIÓN FINAL Y 100% INTERACTIVA DE renderPatrimonioPage
// =================================================================================
const renderPatrimonioPage = async () => {
    const container = select(PAGE_IDS.PATRIMONIO);
    if (!container) return;

    const BASE_COLORS = ['#007AFF', '#30D158', '#FFD60A', '#FF3B30', '#C084FC', '#4ECDC4', '#EF626C', '#A8D58A'];
    const visibleAccounts = getVisibleAccounts();
    const saldos = await getSaldos();
    
    const allAccountTypes = [...new Set(visibleAccounts.map((c) => toSentenceCase(c.tipo || 'S/T')))].sort();
    const filteredAccountTypes = new Set(allAccountTypes.filter(t => !deselectedAccountTypesFilter.has(t)));

    const colorMap = {};
    allAccountTypes.forEach((tipo, index) => {
        colorMap[tipo] = BASE_COLORS[index % BASE_COLORS.length];
    });

    // <-- ¡AQUÍ ESTÁ LA CORRECCIÓN CLAVE! -->
    // 1. Filtramos las cuentas ANTES de preparar los datos para el gráfico.
    const filteredAccountsForChart = visibleAccounts.filter(c => {
        const tipo = toSentenceCase(c.tipo || 'S/T');
        return filteredAccountTypes.has(tipo);
    });

    // 2. Ahora, construimos los datos del árbol usando solo las cuentas filtradas.
    const treeData = [];
    filteredAccountsForChart.forEach(c => { // Usamos la nueva lista filtrada
        const saldo = saldos[c.id] || 0;
        if (saldo > 0) {
            treeData.push({
                tipo: toSentenceCase(c.tipo || 'S/T'),
                nombre: c.nombre,
                saldo: saldo / 100
            });
        }
    });
    
    const pillsHTML = allAccountTypes.map(t => {
        const isActive = !deselectedAccountTypesFilter.has(t);
        const color = colorMap[t];
        let style = '';
        if (isActive && color) {
            style = `style="background-color: ${color}; border-color: ${color}; color: #FFFFFF; box-shadow: 0 0 8px ${color}70;"`;
        }
        return `<button class="filter-pill ${isActive ? 'filter-pill--active' : ''}" data-action="toggle-account-type-filter" data-type="${t}" ${style}>${t}</button>`;
    }).join('') || `<p style="font-size:var(--fs-xs); color:var(--c-on-surface-secondary)">No hay cuentas en esta vista.</p>`;
    
    const totalFiltrado = filteredAccountsForChart.reduce((sum, c) => sum + (saldos[c.id] || 0), 0);

    // El resto del código HTML y de renderizado permanece igual.
    container.innerHTML = `
        <div class="patrimonio-header-grid">
            <div class="patrimonio-header-grid__kpi">
                <h4 class="kpi-item__label">Patrimonio Neto (Seleccionado)</h4>
                <strong id="patrimonio-total-balance" class="kpi-item__value" style="font-size: 2rem; line-height: 1.1;"></strong>
            </div>
            <div class="patrimonio-header-grid__filters">
                 <h4 class="kpi-item__label">Filtros por tipo de cuenta</h4>
                 <div id="filter-account-types-pills" class="filter-pills" style="margin-bottom: 0;">${pillsHTML}</div>
            </div>
        </div>
        <div class="card card--no-bg accordion-wrapper">
            <div id="liquid-assets-chart-container" class="hidden" style="margin-bottom: 0;">
                 <details class="accordion" open>
                    <summary>
                        <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">data_usage</span>Estructura del Patrimonio</h3>
                        <span class="material-icons accordion__icon">expand_more</span>
                    </summary>
                    <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                        <div class="chart-container" style="height: 250px; margin-bottom: 0;">
                            <canvas id="liquid-assets-chart"></canvas>
                        </div>
                    </div>
                </details>
            </div>
        </div>
        <div class="accordion-wrapper">
            <details class="accordion" open>
                <summary><h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">account_balance_wallet</span>Cuentas</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                <div class="accordion__content" style="padding: 0;" id="patrimonio-cuentas-container"></div>
            </details>
        </div>`;
    
    animateCountUp(select('patrimonio-total-balance'), totalFiltrado);
    // 3. El listado de cuentas también usará la lista filtrada para mayor eficiencia.
    renderCuentas('patrimonio-cuentas-container', filteredAccountsForChart, totalFiltrado);
    
    const chartContainer = select(`liquid-assets-chart-container`);
    const chartCanvas = select(`liquid-assets-chart`);
    const chartCtx = chartCanvas ? chartCanvas.getContext('2d') : null;

    if (chartCtx && chartContainer) {
        if (liquidAssetsChart) liquidAssetsChart.destroy();
        
        if (treeData.length > 0) {
            chartContainer.classList.remove('hidden');
            liquidAssetsChart = new Chart(chartCtx, {
                type: 'treemap',
                data: {
                    datasets: [{
                        tree: treeData,
                        key: 'saldo',
                        groups: ['tipo', 'nombre'],
                        spacing: 0.5,
                        borderWidth: 1.5,
                        borderColor: getComputedStyle(document.body).getPropertyValue('--c-background'),
                        backgroundColor: (ctx) => {
                            if (ctx.type === 'data') {
                                const node = ctx.raw._data;
                                const baseColor = colorMap[node.tipo];
                                return baseColor ? `${baseColor}B3` : 'grey';
                            }
                            return 'transparent';
                        },
                        labels: {
                            display: true,
                            color: '#FFFFFF',
                            font: { size: 10, weight: '600' },
                            align: 'center',
                            position: 'middle'
                        }
                    }]
                },
                options: {
                    sunburst: true,
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const node = context.raw._data;
                                    const value = formatCurrency(context.raw.v * 100);
                                    if (node && node.nombre) {
                                        return `${node.nombre}: ${value}`;
                                    }
                                    return `${context.raw.g}: ${value}`;
                                }
                            }
                        },
                        datalabels: { display: false }
                    }
                }
            });
        } else {
            chartContainer.classList.add('hidden');
        }
    }
};
// =================================================================================
// FIN: VERSIÓN FINAL Y 100% INTERACTIVA
// =================================================================================
				const renderAnalisisPage = () => {
            const container = select(PAGE_IDS.ANALISIS);
            if(!container) return;

            // El HTML es idéntico al original, no hay cambios aquí.
            container.innerHTML = `
                <!-- Bloque 1: Presupuestos -->
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">request_quote</span>Presupuestos</h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--sp-4);">
                                <div class="form-group" style="flex-grow: 1; margin: 0;">
                                    <label for="budget-year-selector" class="form-label">Año del Presupuesto</label>
                                    <select id="budget-year-selector" class="form-select"></select>
                                </div>
                                <button data-action="update-budgets" class="btn btn--secondary" style="margin-left: var(--sp-3);"><span class="material-icons" style="font-size: 16px;">edit_calendar</span><span>Gestionar</span></button>
                            </div>
                            <div id="annual-budget-dashboard"><div id="budget-kpi-container" class="kpi-grid"></div><div class="card" style="margin-top: var(--sp-4);"><h3 class="card__title"><span class="material-icons">trending_up</span>Tendencia Ingresos y Gastos</h3><div class="card__content"><div class="chart-container" style="height: 220px;"><canvas id="budget-trend-chart"></canvas></div></div></div><div id="budget-details-list" style="margin-top: var(--sp-4);"></div></div>
                            <div id="budget-init-placeholder" class="empty-state hidden"><span class="material-icons">edit_calendar</span><h3 id="budget-placeholder-title" data-i18n="budget_empty_title">Define tu Plan Financiero</h3><p id="budget-placeholder-text" data-i18n="budget_empty_text">Establece límites de gasto y metas de ingreso para tomar el control de tu año. ¡Empieza ahora!</p><button data-action="update-budgets" class="btn btn--primary" style="margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 16px;">add_circle_outline</span><span data-i18n="budget_empty_cta">Crear Presupuestos</span></button></div>
                        </div>
                    </details>
                </div>

                <!-- Bloque 2: Portafolio -->
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">show_chart</span>Portafolio</h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" id="analisis-inversiones-container" style="padding: var(--sp-3) var(--sp-4);">
                        </div>
                    </details>
                </div>

                <!-- Bloque 3: Informes -->
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">assessment</span>Informes</h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;"><div class="form-group"><label for="informe-fecha-inicio" class="form-label">Desde</label><input type="date" id="informe-fecha-inicio" class="form-input"></div><div class="form-group"><label for="informe-fecha-fin" class="form-label">Hasta</label><input type="date" id="informe-fecha-fin" class="form-input"></div><div class="form-group"><label for="filter-cuenta-informe" class="form-label">Cuenta</label><select id="filter-cuenta-informe" class="form-select"></select></div><div class="form-group"><label for="filter-concepto-informe" class="form-label">Concepto</label><select id="filter-concepto-informe" class="form-select"></select></div></div>
                            <button data-action="apply-informe-filters" class="btn btn--primary btn--full" style="margin-top: var(--sp-2);">Generar Informe</button>
                            <div id="informe-results-container" class="hidden" style="margin-top: var(--sp-4);"><div id="informe-kpi-container" class="kpi-grid"></div><div class="chart-container" style="margin-top: var(--sp-4);"><canvas id="informes-chart"></canvas></div></div>
                            <div id="empty-informes" class="empty-state" style="border: none; background: transparent; padding-top: var(--sp-4);"><span class="material-icons">query_stats</span><h3>Define tus parámetros</h3><p>Selecciona un rango de fechas para generar tu informe personalizado.</p></div>
                        </div>
                    </details>
                </div>
            `;
            
            const budgetYearSelect = select('budget-year-selector');
            if (budgetYearSelect) {
                const currentYear = new Date().getFullYear();
                let years = new Set([currentYear]);
                (db.presupuestos || []).forEach(p => years.add(p.ano));
                
                const currentVal = budgetYearSelect.value;
                budgetYearSelect.innerHTML = [...years].sort((a, b) => b - a).map(y => `<option value="${y}">${y}</option>`).join('');
                
                if (currentVal && [...years].some(y => y == parseInt(currentVal))) {
                    budgetYearSelect.value = currentVal;
                } else {
                    budgetYearSelect.value = String(currentYear);
                }
                
                budgetYearSelect.addEventListener('change', renderBudgetTracking);
            }
            
            populateAllDropdowns();
            renderBudgetTracking();
            renderInversionesPage('analisis-inversiones-container');
        };
        
        const updateDashboardData = async () => {
            const { current, previous, label } = await getFilteredMovements(true);
            const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
            const kpiContainer = select('kpi-container');
            const conceptListContainer = select('concepto-totals-list');
            const chartCanvas = select('conceptos-chart');
            const chartCtx = chartCanvas ? chartCanvas.getContext('2d') : null;
            const filterCuenta = select('filter-cuenta');
            const cId = filterCuenta ? filterCuenta.value : null;
        
            const calculateTotals = (movs) => {
                let ingresos = 0, gastos = 0;
                movs.forEach(m => {
                    if (m.tipo === 'movimiento') { 
                        if (m.cantidad > 0) ingresos += m.cantidad; 
                        else gastos += m.cantidad; 
                    } 
                    else if (m.tipo === 'traspaso') {
                        if (cId) {
                            if (m.cuentaOrigenId === cId) { 
                                gastos += -m.cantidad;
                            }
                            if (m.cuentaDestinoId === cId) { 
                                ingresos += m.cantidad;
                            }
                        } else {
                            const origenVisible = visibleAccountIds.has(m.cuentaOrigenId);
                            const destinoVisible = visibleAccountIds.has(m.cuentaDestinoId);
                            
                            if (origenVisible && !destinoVisible) { 
                                gastos += -m.cantidad;
                            }
                            else if (!origenVisible && destinoVisible) { 
                                ingresos += m.cantidad;
                            }
                        }
                    }
                });
                return { ingresos, gastos };
            };
        
            const currentTotals = calculateTotals(current);
            const previousTotals = calculateTotals(previous);
            
            if (kpiContainer) {
                selectAll('#kpi-container .skeleton').forEach(el => el.classList.remove('skeleton'));
                
                const getComparisonHTML = (currentVal, prevVal, comparisonLabel, lowerIsBetter = false) => {
                    if (!comparisonLabel || prevVal === 0) return '';
                    const isImprovement = lowerIsBetter ? (currentVal < prevVal) : (currentVal > prevVal);
                    const diff = (currentVal - prevVal) / Math.abs(prevVal) * 100;
                    const diffClass = isImprovement ? 'text-positive' : 'text-negative';
                    const icon = isImprovement ? 'arrow_upward' : 'arrow_downward';
                    return `<span class="${diffClass}"><span class="material-icons" style="font-size: 12px; vertical-align: middle;">${icon}</span> ${Math.abs(diff).toFixed(0)}%</span> <span style="color:var(--c-on-surface-secondary)">${comparisonLabel}</span>`;
                };

                const saldoActual = currentTotals.ingresos + currentTotals.gastos;
                const saldoAnterior = previousTotals.ingresos + previousTotals.gastos;
        
                animateCountUp(select('kpi-ingresos-value'), currentTotals.ingresos);
                const kpiIngresosComparison = select('kpi-ingresos-comparison');
                if (kpiIngresosComparison) kpiIngresosComparison.innerHTML = getComparisonHTML(currentTotals.ingresos, previousTotals.ingresos, label);
                
                animateCountUp(select('kpi-gastos-value'), currentTotals.gastos);
                const kpiGastosComparison = select('kpi-gastos-comparison');
                if (kpiGastosComparison) kpiGastosComparison.innerHTML = getComparisonHTML(Math.abs(currentTotals.gastos), Math.abs(previousTotals.gastos), label, true);
                
                const kpiSaldoValueEl = select('kpi-saldo-value');
                if (kpiSaldoValueEl) {
                    kpiSaldoValueEl.classList.remove('text-positive', 'text-negative');
                    kpiSaldoValueEl.classList.add(saldoActual >= 0 ? 'text-positive' : 'text-negative');
                    animateCountUp(kpiSaldoValueEl, saldoActual);
                }
                const kpiSaldoComparison = select('kpi-saldo-comparison');
                if (kpiSaldoComparison) kpiSaldoComparison.innerHTML = getComparisonHTML(saldoActual, saldoAnterior, label);
            }
        
            if (conceptosChart) conceptosChart.destroy();
            if (conceptListContainer && chartCtx) {
                const cTots = current.reduce((a, m) => { if (m.tipo === 'movimiento' && m.conceptoId) { if (!a[m.conceptoId]) { const con = db.conceptos.find((c) => c.id === m.conceptoId); a[m.conceptoId] = { total: 0, movements: [], icon: (con && con.icon) || 'label' }; } a[m.conceptoId].total += m.cantidad; a[m.conceptoId].movements.push(m); } return a; }, {});
                const sortedTotals = Object.entries(cTots).sort(([, a], [, b]) => a.total - b.total);
                const colorSuccess = getComputedStyle(document.body).getPropertyValue('--c-chart-positive').trim(), colorDanger = getComputedStyle(document.body).getPropertyValue('--c-danger').trim();
                conceptosChart = new Chart(chartCtx, { type: 'bar', data: { labels: sortedTotals.map(([id]) => { const con = db.conceptos.find((c) => c.id === id); return toSentenceCase((con && con.nombre) || '?') }), datasets: [{ data: sortedTotals.map(([, data]) => data.total / 100), backgroundColor: sortedTotals.map(([, data]) => data.total >= 0 ? colorSuccess : colorDanger), borderRadius: 6, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { y: { ticks: { callback: (value) => `${value.toLocaleString(locales[currentLanguage])}` } } } } });
                conceptListContainer.innerHTML = sortedTotals.length === 0 ? `<div class="empty-state" style="padding:16px 0; background:transparent; border:none;"><p>Sin datos para los filtros.</p></div>` : sortedTotals.map(([id, data]) => { const con = db.conceptos.find((c) => c.id === id); const t = data.total; return `<details class="accordion" style="background-color: var(--c-surface-variant);"><summary><span style="display: flex; align-items: center; gap: 8px;"><span class="material-icons" style="font-size: 18px;">${data.icon}</span>${toSentenceCase((con && con.nombre) || '?')}</span><span><strong class="${t >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(t)}</strong><span class="material-icons accordion__icon">expand_more</span></span></summary><div class="accordion__content">${data.movements.sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime()).map((mov) => `<div class="transaction-card" data-action="edit-movement" data-id="${mov.id}" style="border:0;"><div class="transaction-card__content" style="padding: var(--sp-1) 0; "><div style="flex-grow:1;min-width:0;"><div class="transaction-card__row-2" style="font-size:0.75rem;">${new Date(mov.fecha).toLocaleDateString(locales[currentLanguage])} - ${escapeHTML(mov.descripcion)}</div></div><div class="transaction-card__amount ${mov.cantidad >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(mov.cantidad)}</div></div></div>`).join('')}</div></details>`; }).join('');
            }
        };
        
        // =================================================================================
        // 8. MODAL & FORM HANDLING
        // =================================================================================
		let suggestionDebounceTimer = null;
        const applyDescriptionSuggestion = (description, conceptoId, cuentaId) => {
            const descriptionInput = select('movimiento-descripcion');
            const conceptoSelect = select('movimiento-concepto');
            const cuentaSelect = select('movimiento-cuenta');

            if (descriptionInput) descriptionInput.value = description;
            if (conceptoSelect && conceptoId) {
                conceptoSelect.value = conceptoId;
                const parentEl = conceptoSelect.parentElement;
                if (parentEl) {
                    parentEl.classList.add('field-highlighted');
                    setTimeout(() => parentEl.classList.remove('field-highlighted'), 1000);
                }
            }
            if (cuentaSelect && cuentaId) {
                cuentaSelect.value = cuentaId;
                const parentEl = cuentaSelect.parentElement;
                if (parentEl) {
                    parentEl.classList.add('field-highlighted');
                    setTimeout(() => parentEl.classList.remove('field-highlighted'), 1000);
                }
            }
            const suggestionsBox = select('description-suggestions');
            if (suggestionsBox) suggestionsBox.style.display = 'none';
        };

                    const showModal = (id) => {
            const m = select(id);
            if (m) {
                const mainScroller = selectOne('.app-layout__main');
                if (mainScroller) { 
                    lastScrollTop = mainScroller.scrollTop;
                }
                m.classList.add('modal-overlay--active');
                
                // SOLO aplicamos el efecto de encogimiento si la carga inicial ha terminado.
                if (isInitialLoadComplete) {
                    const appRoot = select('app-root');
                    if (appRoot) {
                        // Usamos una nueva clase específica para evitar conflictos
                        appRoot.classList.add('app-layout--transformed-by-modal');
                    }
                }

                if (!id.includes('calculator')) {
                    const f = m.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (f) (f).focus();
                }
            }
        };

        const hideModal = (id) => {
            const m = select(id);
            if (m) {
                m.classList.remove('modal-overlay--active');
                
                // Nos aseguramos de quitar la clase de transformación al cerrar.
                const appRoot = select('app-root');
                if (appRoot) {
                    appRoot.classList.remove('app-layout--transformed-by-modal');
                }

                if (id === 'movimiento-modal' && calculatorState.isVisible) {
                    hideCalculator();
                }
            }

            const mainScroller = selectOne('.app-layout__main');
            if (mainScroller && lastScrollTop !== null) {
                requestAnimationFrame(() => {
                    mainScroller.scrollTop = lastScrollTop;
                    lastScrollTop = null;
                });
            }
        };
											   
        let calculatorKeyboardHandler = null;

        const showCalculator = (targetInput) => {
			setTimeout(() => {
    document.addEventListener('click', closeCalculatorOnClickOutside, { once: true });
}, 0);
            const calculatorEl = select('calculator-ui');
            if (!calculatorEl) return;
            
            calculatorState.isVisible = true;
            calculatorState.targetInput = targetInput;
            const currentValue = targetInput.value.trim();
            const parsedValue = parseCurrencyString(currentValue);

            if (!isNaN(parsedValue) && currentValue !== '') { 
                calculatorState.displayValue = String(parsedValue).replace(',', '.');
            } else {
                calculatorState.displayValue = '0';
            }
            calculatorState.waitingForNewValue = true; 
            calculatorState.operand1 = null;
            calculatorState.operator = null;
            calculatorState.isResultDisplayed = false; // Reiniciar este estado al abrir
            updateCalculatorDisplay();
            updateDoneButtonText(); // Actualizar el texto del botón al abrir
            
            // La magia está aquí: añadimos la clase que la hace visible
            calculatorEl.classList.add('calculator-ui--visible');

            // Adjuntamos el listener del teclado
            if (calculatorKeyboardHandler) {
    document.removeEventListener('keydown', calculatorKeyboardHandler);
}

calculatorKeyboardHandler = (e) => {
    // Prevenir acciones por defecto del navegador para que no interfieran
    if ("0123456789,.+-*/".includes(e.key) || ['Enter', 'Backspace', 'Escape', 'Delete'].includes(e.key)) {
        e.preventDefault();
    }

    // Mapeo de teclas a acciones de la calculadora
    if (e.key >= '0' && e.key <= '9') {
        handleCalculatorInput(e.key);
    } else if (e.key === ',' || e.key === '.') {
        handleCalculatorInput('comma');
    } else if (e.key === 'Enter') {
        handleCalculatorInput('done');
    } else if (e.key === 'Backspace') {
        handleCalculatorInput('backspace');
    } else if (e.key === 'Delete') {
        handleCalculatorInput('clear');
    } else if (e.key === 'Escape') {
        hideCalculator(); // Cierra la calculadora con la tecla Escape
    } else if (e.key === '+') {
        handleCalculatorInput('add');
    } else if (e.key === '-') {
        handleCalculatorInput('subtract');
    } else if (e.key === '*' || e.key === 'x') {
        handleCalculatorInput('multiply');
    } else if (e.key === '/') {
        handleCalculatorInput('divide');
    }
}; // <--- ¡LLAVE DE CIERRE AÑADIDA AQUÍ!

document.addEventListener('keydown', calculatorKeyboardHandler); // <--- LÍNEA MOVIDA AQUÍ
 };
const hideCalculator = () => {
    const calculatorEl = select('calculator-ui');
    if (!calculatorEl) return;

    // Y aquí, simplemente la quitamos para que se oculte con la animación
    calculatorEl.classList.remove('calculator-ui--visible');

    calculatorState.targetInput = null;
    calculatorState.isVisible = false;
    calculatorState.isResultDisplayed = false; // Resetear este estado al cerrar
    updateDoneButtonText(); // Asegurarse de que el botón dice "OK" para la próxima vez
    
    if (calculatorKeyboardHandler) {
        document.removeEventListener('keydown', calculatorKeyboardHandler);
        calculatorKeyboardHandler = null;
    }
    document.removeEventListener('click', closeCalculatorOnClickOutside);
};
         // AÑADE ESTAS DOS NUEVAS FUNCIONES junto a hideCalculator y showCalculator
        const closeCalculatorOnClickOutside = (e) => {
            const calculatorEl = select('calculator-ui');
            // Si la calculadora no está visible o si el clic fue dentro de ella, no hacemos nada.
            if (!calculatorState.isVisible || (calculatorEl && calculatorEl.contains(e.target))) {
                 // Si el clic fue dentro, volvemos a poner el listener para el *próximo* clic
                 setTimeout(() => {
                     document.addEventListener('click', closeCalculatorOnClickOutside, { once: true });
                 }, 0);
                return;
            }
            // Si el clic fue fuera, la cerramos.
            hideCalculator();
        };       
	         const handleCalculatorInput = (key) => {
    hapticFeedback('light');
    let { displayValue, waitingForNewValue, operand1, operator, isResultDisplayed } = calculatorState;
    
    const isOperator = ['add', 'subtract', 'multiply', 'divide'].includes(key);
    const isDigitOrComma = (key >= '0' && key <= '9') || key === 'comma';

    if (isResultDisplayed && (isDigitOrComma || isOperator)) {
        isResultDisplayed = false;
        updateDoneButtonText(); 
        if (isDigitOrComma) { 
            displayValue = '0';
            waitingForNewValue = true;
        }
        if (isOperator) {
            operand1 = parseFloat(displayValue);
            operator = key;
            waitingForNewValue = true;
        }
    }

    if (isOperator) {
        if (operand1 !== null && operator !== null && !waitingForNewValue) {
            calculate();
            displayValue = calculatorState.displayValue;
        }
        operand1 = parseFloat(displayValue);
        operator = key;
        waitingForNewValue = true;
    } else {
        switch(key) {
            case 'done': 
                hapticFeedback('medium'); 
                if (isResultDisplayed) { // Second press: close calculator
                    if (calculatorState.targetInput) {
                        const finalValue = parseFloat(displayValue) || 0;
                        calculatorState.targetInput.value = finalValue.toLocaleString(locales[currentLanguage], { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    hideCalculator(); 
                    return;
                } else { // First press: calculate and show result
                    if (operand1 !== null && operator !== null && !waitingForNewValue) {
                        calculate();
                        displayValue = calculatorState.displayValue; 
                        isResultDisplayed = true;
                    } else if (!waitingForNewValue) { 
                        isResultDisplayed = true; 
                    }
                    updateDoneButtonText();
                }
                break;
            case 'comma': 
                if (waitingForNewValue) {
                    displayValue = '0.';
                    waitingForNewValue = false;
                } else if (!displayValue.includes('.')) { 
                    displayValue += '.'; 
                } 
                break;
            case 'clear': 
                displayValue = '0'; 
                waitingForNewValue = true; 
                operand1 = null;
                operator = null;
                isResultDisplayed = false;
                updateDoneButtonText();
                break;
            case 'backspace': 
                displayValue = displayValue.slice(0, -1);
                if (displayValue === '' || displayValue === '-') {
                    displayValue = '0';
                    waitingForNewValue = true;
                }
                isResultDisplayed = false;
                updateDoneButtonText();
                break;
            case 'sign': 
                if (displayValue !== '0') { 
                    displayValue = displayValue.startsWith('-') ? displayValue.slice(1) : `-${displayValue}`; 
                } 
                isResultDisplayed = false;
                updateDoneButtonText();
                break;
            default: // Digits
                if (waitingForNewValue || (displayValue === '0' && key !== '0' && !displayValue.includes('.'))) {
                    displayValue = key; 
                    waitingForNewValue = false; 
                } else if (displayValue === '0' && key === '0' && !displayValue.includes('.')) {
                    displayValue = '0';
                }
                else { 
                    displayValue += key; 
                } 
                isResultDisplayed = false;
                updateDoneButtonText();
                break;
        }
    }
    
    calculatorState.displayValue = displayValue;
    calculatorState.waitingForNewValue = waitingForNewValue;
    calculatorState.operand1 = operand1;
    calculatorState.operator = operator;
    calculatorState.isResultDisplayed = isResultDisplayed;
    updateCalculatorDisplay();
};
                const calculate = () => {
            const val1 = parseFloat(calculatorState.operand1);
            const val2 = parseFloat(calculatorState.displayValue);
            if (isNaN(val1) || isNaN(val2) || !calculatorState.operator) {
                return;
            }

            let result = 0;
            switch (calculatorState.operator) {
                case 'add': result = val1 + val2; break;
                case 'subtract': result = val1 - val2; break;
                case 'multiply': result = val1 * val2; break;
                case 'divide':
                    if (val2 === 0) {
                        showToast("No se puede dividir por cero.", "danger");
                        calculatorState.displayValue = '0';
                        calculatorState.waitingForNewValue = true;
                        calculatorState.operand1 = null;
                        calculatorState.operator = null;
                        return;
                    }
                    result = val1 / val2;
                    break;
            }
            calculatorState.displayValue = String(result);
            calculatorState.operand1 = null; // Clear operand1 after calculation
            calculatorState.operator = null; // Clear operator after calculation
            calculatorState.waitingForNewValue = true; // Next digit should start a new number
            calculatorState.isResultDisplayed = true; // Mark that a result is now displayed
        };
		 const updateDoneButtonText = () => {
            const doneButton = select('calculator-btn-done');
            if (doneButton) {
                doneButton.textContent = calculatorState.isResultDisplayed ? 'Cerrar' : 'OK';
            }
        };
        

                const updateCalculatorDisplay = () => {
            const display = select('calculator-display');
            if (display) { 
                let formattedDisplayValue = calculatorState.displayValue;
                if (formattedDisplayValue === '0.') {
                    formattedDisplayValue = '0,';
                } else if (formattedDisplayValue.endsWith('.')) {
                    formattedDisplayValue = formattedDisplayValue.replace('.', ',');
                } else {
                    const numValue = parseFloat(formattedDisplayValue);
                    if (!isNaN(numValue)) {
                        // If it's a result, format with 2 decimal places, otherwise preserve input precision
                        if (calculatorState.isResultDisplayed) { // NEW: Handle formatting for results
                            formattedDisplayValue = numValue.toLocaleString(locales[currentLanguage], { 
                                useGrouping: false,
                                minimumFractionDigits: 2, 
                                maximumFractionDigits: 2 
                            });
                        } else {
                            const parts = formattedDisplayValue.split('.');
                            const integerPart = parts[0];
                            const decimalPart = parts[1] || '';

                            formattedDisplayValue = numValue.toLocaleString(locales[currentLanguage], { 
                                useGrouping: false,
                                minimumFractionDigits: decimalPart.length,
                                maximumFractionDigits: decimalPart.length
                            });
                            
                            if (formattedDisplayValue.includes(',') && !formattedDisplayValue.endsWith(',') && formattedDisplayValue.split(',')[1].length < decimalPart.length) {
                                formattedDisplayValue += '0'.repeat(decimalPart.length - formattedDisplayValue.split(',')[1].length);
                            } else if (!formattedDisplayValue.includes(',') && decimalPart.length > 0) {
                                formattedDisplayValue += ',' + '0'.repeat(decimalPart.length);
                            }
                        }
                    }
                }
                display.textContent = formattedDisplayValue;
            }
            // Esto se mantiene igual, ya que el input siempre muestra 2 decimales
            if (calculatorState.targetInput) {
                const numValue = parseFloat(calculatorState.displayValue) || 0;
                calculatorState.targetInput.value = numValue.toLocaleString(locales[currentLanguage], { 
                    useGrouping: false,
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            }
        };
        const showGenericModal=(title,html)=>{const titleEl = select('generic-modal-title'); if (titleEl) titleEl.textContent=title; const bodyEl = select('generic-modal-body'); if(bodyEl) bodyEl.innerHTML=html;showModal('generic-modal');};
        const showConfirmationModal=(msg, onConfirm, title="Confirmar Acción")=>{ hapticFeedback('medium'); const id='confirmation-modal';const existingModal = document.getElementById(id); if(existingModal) existingModal.remove(); const overlay=document.createElement('div');overlay.id=id;overlay.className='modal-overlay modal-overlay--active'; overlay.innerHTML=`<div class="modal" role="alertdialog" style="border-radius:var(--border-radius-lg)"><div class="modal__header"><h3 class="modal__title">${title}</h3></div><div class="modal__body"><p>${msg}</p><div style="display:flex;gap:var(--sp-3);margin-top:var(--sp-4);"><button class="btn btn--secondary btn--full" data-action="close-modal" data-modal-id="confirmation-modal">Cancelar</button><button class="btn btn--danger btn--full" data-action="confirm-action">Sí, continuar</button></div></div></div>`; document.body.appendChild(overlay); (overlay.querySelector('[data-action="confirm-action"]')).onclick=()=>{hapticFeedback('medium');onConfirm();overlay.remove();}; (overlay.querySelector('[data-action="close-modal"]')).onclick=()=>overlay.remove(); };
        
        const showAccountMovementsModal = async (cId) => {
            const cuenta = getVisibleAccounts().find((c) => c.id === cId);
            if (!cuenta) return;

            showGenericModal(`Movimientos de ${cuenta.nombre}`, `<div style="text-align:center; padding: var(--sp-5);"><span class="spinner"></span><p style="margin-top: var(--sp-3);">Cargando historial...</p></div>`);

            try {
                const movsRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos');
                
                const regularMovsQuery = movsRef.where('cuentaId', '==', cId).get();
                const originTransfersQuery = movsRef.where('cuentaOrigenId', '==', cId).get();
                const destinationTransfersQuery = movsRef.where('cuentaDestinoId', '==', cId).get();

                const [regularSnapshot, originSnapshot, destinationSnapshot] = await Promise.all([
                    regularMovsQuery, originTransfersQuery, destinationTransfersQuery
                ]);

                const allMovements = new Map();
                const processSnapshot = (snapshot) => {
                    snapshot.forEach(doc => {
                        allMovements.set(doc.id, { id: doc.id, ...doc.data() });
                    });
                };
                processSnapshot(regularSnapshot);
                processSnapshot(originSnapshot);
                processSnapshot(destinationSnapshot);

                const sortedMovements = Array.from(allMovements.values());
                recalculateAndApplyRunningBalances(sortedMovements);
                sortedMovements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                const html = sortedMovements.length === 0 
                    ? `<div class="empty-state" style="background:transparent; border:none;">...</div>` 
                    : `<div class="movements-modal-container">
                           ${sortedMovements.map((m) => renderVirtualListItem({type: 'transaction', movement: m})).join('')}
                       </div>`;

                const modalBody = select('generic-modal-body');
                if (modalBody) {
                    modalBody.innerHTML = html;
                }

            } catch (error) {
                console.error("Error al obtener los movimientos de la cuenta:", error);
                showToast("No se pudo cargar el historial de la cuenta.", "danger");
                const modalBody = select('generic-modal-body');
                if (modalBody) {
                    modalBody.innerHTML = `<p class="text-danger" style="text-align:center;">Ha ocurrido un error al cargar los datos.</p>`;
                }
            }
        };
        
        const setMovimientoFormType = (type) => {
            hapticFeedback('light');
            const isTraspaso = type === 'traspaso';

            select('movimiento-fields').classList.toggle('hidden', isTraspaso);
            select('traspaso-fields').classList.toggle('hidden', !isTraspaso);

            const titleEl = select('form-movimiento-title');
            if (titleEl) titleEl.textContent = isTraspaso ? t('form_type_transfer') : t('form_type_movement');
            
            select('mov-type-btn-movimiento').classList.toggle('filter-pill--active', !isTraspaso);
            select('mov-type-btn-traspaso').classList.toggle('filter-pill--active', isTraspaso);

            if (isTraspaso) {
                const descripcionInput = select('movimiento-descripcion');
                if (descripcionInput && descripcionInput.value.trim() === '') {
                    descripcionInput.value = 'Traspaso';
                }
            }
        };

                const updateDateDisplay = (dateInput) => {
            const dateTextEl = select('movimiento-fecha-text');
            if (!dateTextEl || !dateInput.value) return;

            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            today.setHours(0, 0, 0, 0);
            yesterday.setHours(0, 0, 0, 0);

            const selectedDate = new Date(dateInput.value);
            selectedDate.setMinutes(selectedDate.getMinutes() + selectedDate.getTimezoneOffset());
            selectedDate.setHours(0, 0, 0, 0);

            if (selectedDate.getTime() === today.getTime()) {
                dateTextEl.textContent = "Hoy";
            } else if (selectedDate.getTime() === yesterday.getTime()) {
                dateTextEl.textContent = "Ayer";
            } else {
                dateTextEl.textContent = selectedDate.toLocaleDateString(locales[currentLanguage], {
                    day: '2-digit', month: '2-digit', year: 'numeric'
                });
            }
        };

                const startMovementForm = (id = null, isRecurrent = false) => {
            hapticFeedback('medium');
            const form = select('form-movimiento');
            form.reset();
            clearAllErrors(form.id);
            populateAllDropdowns();

            setMovimientoFormType('movimiento'); 
            
            let data = null;
            let mode = 'new';
            const collectionName = isRecurrent ? 'recurrentes' : 'movimientos';
			if (id) {
                const dataSource = isRecurrent ? db.recurrentes : db.movimientos;
                data = dataSource.find(item => item.id === id);

                if (!data && !isRecurrent) {
                    data = recentMovementsCache.find(item => item.id === id);
                }
                
                if (data) {
                   mode = isRecurrent ? 'edit-recurrent' : 'edit-single';
                }
            }
        
			select('movimiento-mode').value = mode;
            select('movimiento-id').value = id || '';
        
            if (data && data.tipo === 'traspaso') {
                setMovimientoFormType('traspaso');
            }
        
            select('form-movimiento-title').textContent = id && data ? (data.tipo === 'traspaso' ? 'Editar Traspaso' : 'Editar Movimiento') : 'Añadir Movimiento';
            select('movimiento-cantidad').value = data ? `${(data.cantidad / 100).toLocaleString(locales[currentLanguage], { minimumFractionDigits: 2, useGrouping: false })}` : '';
            
            const fechaInput = select('movimiento-fecha');
            const fecha = data && data.fecha ? new Date(data.fecha) : new Date();
            fechaInput.value = new Date(fecha.getTime() - (fecha.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
            updateDateDisplay(fechaInput); // Actualizamos el botón con la fecha correcta

            select('movimiento-descripcion').value = (data && data.descripcion) || '';
        
            if (data && data.tipo === 'traspaso') {
                select('movimiento-cuenta-origen').value = (data && data.cuentaOrigenId) || '';
                select('movimiento-cuenta-destino').value = (data && data.cuentaDestinoId) || '';
            } else {
                select('movimiento-cuenta').value = (data && data.cuentaId) || '';
                select('movimiento-concepto').value = (data && data.conceptoId) || '';
            }
        
            const recurrenteCheckbox = select('movimiento-recurrente');
            const recurrentOptions = select('recurrent-options');
            if (mode === 'edit-recurrent' && data) {
                recurrenteCheckbox.checked = true;
                select('recurrent-frequency').value = data.frequency;
                select('recurrent-next-date').value = data.nextDate;
                select('recurrent-end-date').value = data.endDate || '';
                recurrentOptions.classList.remove('hidden');
            } else {
                recurrenteCheckbox.checked = false;
                recurrentOptions.classList.add('hidden');
            }
            
            select('delete-movimiento-btn').classList.toggle('hidden', !id || !data);
            select('delete-movimiento-btn').dataset.isRecurrent = isRecurrent;
            select('duplicate-movimiento-btn').classList.toggle('hidden', !(mode === 'edit-single' && data));
            
            showModal('movimiento-modal');
        };
        
        
        const showGlobalSearchModal = () => {
            hapticFeedback('medium');
            showModal('global-search-modal');
            setTimeout(() => {
                const input = select('global-search-input');
                if (input) {
                    input.focus();
                    input.value = '';
                    input.dispatchEvent(new Event('input'));
                }
            }, 100);
        };
        
        const performGlobalSearch = async (query) => {
            const resultsContainer = select('global-search-results');
            if (!resultsContainer) return;

            if (!query || query.trim().length < 2) {
                resultsContainer.innerHTML = `<div class="empty-state" style="background:transparent; border: none;"><span class="material-icons">manage_search</span><h3 data-i18n="search_empty_title">Encuéntralo todo</h3><p data-i18n="search_empty_text">Busca movimientos, cuentas o conceptos. <br>Atajo: <strong>Cmd/Ctrl + K</strong></p></div>`;
                return;
            }

            resultsContainer.innerHTML = `<div style="text-align: center; padding: var(--sp-5);"><span class="spinner"></span><p style="margin-top: var(--sp-2);">Buscando en toda tu base de datos...</p></div>`;
            
            const queryLower = query.toLowerCase();
            let resultsHtml = '';
            const MAX_RESULTS_PER_GROUP = 10;

            const allMovements = await fetchAllMovementsForSearch();

            const movs = allMovements
                .map(m => {
                    const concepto = db.conceptos.find(c => c.id === m.conceptoId);
                    const conceptoNombre = (concepto && concepto.nombre) || '';
                    let cuentaInfo = '';
                    if (m.tipo === 'traspaso') {
                        const origen = db.cuentas.find(c => c.id === m.cuentaOrigenId);
                        const destino = db.cuentas.find(c => c.id === m.cuentaDestinoId);
                        cuentaInfo = `${(origen && origen.nombre) || ''} ${(destino && destino.nombre) || ''}`;
                    } else {
                        const cuenta = db.cuentas.find(c => c.id === m.cuentaId);
                        cuentaInfo = (cuenta && cuenta.nombre) || '';
                    }
                    const fecha = new Date(m.fecha).toLocaleDateString(locales[currentLanguage], { day: 'numeric', month: 'long', year: 'numeric' });
                    const importe = (m.cantidad / 100).toLocaleString(locales[currentLanguage]);
                    const searchableText = `${m.descripcion} ${conceptoNombre} ${cuentaInfo} ${fecha} ${importe}`.toLowerCase();
                    return { movement: m, text: searchableText };
                })
                .filter(item => item.text.includes(queryLower))
                .sort((a, b) => new Date(b.movement.fecha) - new Date(a.movement.fecha))
                .slice(0, MAX_RESULTS_PER_GROUP)
                .map(item => item.movement);

            if (movs.length > 0) {
                resultsHtml += `<div class="search-result-group__title">Movimientos Encontrados</div>`;
                movs.forEach(m => {
                    const concepto = db.conceptos.find(c => c.id === m.conceptoId);
                    const conceptoNombre = (concepto && concepto.nombre) || '';
                    const amountClass = m.cantidad >= 0 ? 'text-positive' : 'text-negative';
                    resultsHtml += `
                        <button class="search-result-item" data-action="search-result-movimiento" data-id="${m.id}">
                            <span class="material-icons search-result-item__icon">receipt_long</span>
                            <div class="search-result-item__details" style="flex-grow: 1;">
                                <p>${escapeHTML(m.descripcion)}</p>
                                <small>${new Date(m.fecha).toLocaleDateString(locales[currentLanguage])} • ${escapeHTML(conceptoNombre)}</small>
                            </div>
                            <strong class="${amountClass}">${formatCurrency(m.cantidad)}</strong>
                        </button>`;
                });
            }
        
            const cuentas = (db.cuentas || []).filter(c => c.nombre.toLowerCase().includes(queryLower) || c.tipo.toLowerCase().includes(queryLower)).slice(0, MAX_RESULTS_PER_GROUP);
            if (cuentas.length > 0) {
                resultsHtml += `<div class="search-result-group__title">Cuentas</div>`;
                cuentas.forEach(c => { resultsHtml += `<button class="search-result-item" data-action="search-result-cuenta" data-id="${c.id}"><span class="material-icons search-result-item__icon">account_balance_wallet</span><div class="search-result-item__details"><p>${escapeHTML(c.nombre)}</p><small>${escapeHTML(c.tipo)}</small></div></button>`; });
            }
        
            const conceptos = (db.conceptos || []).filter(c => c.nombre.toLowerCase().includes(queryLower)).slice(0, MAX_RESULTS_PER_GROUP);
            if (conceptos.length > 0) {
                resultsHtml += `<div class="search-result-group__title">Conceptos</div>`;
                conceptos.forEach(c => { resultsHtml += `<button class="search-result-item" data-action="search-result-concepto" data-id="${c.id}"><span class="material-icons search-result-item__icon">label</span><div class="search-result-item__details"><p>${escapeHTML(c.nombre)}</p></div></button>`; });
            }
        
            if (!resultsHtml) {
                resultsHtml = `<div class="empty-state" style="background:transparent; border: none;"><span class="material-icons">search_off</span><h3>Sin resultados</h3><p>No se encontró nada para "${escapeHTML(query)}".</p></div>`;
            }
            resultsContainer.innerHTML = resultsHtml;
        };

        // =================================================================================
        // 9. FORM HANDLERS & MODAL CONTENT
        // =================================================================================
		const showValoracionModal = (cuentaId) => {
            const cuenta = db.cuentas.find(c => c.id === cuentaId);
            if (!cuenta) return;

            const fechaISO = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
            const ultimaValoracion = (db.inversiones_historial || [])
                .filter(v => v.cuentaId === cuentaId)
                .sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime())[0];

            const valorActualInput = ultimaValoracion ? (ultimaValoracion.valor / 100).toLocaleString('es-ES', { useGrouping: false, minimumFractionDigits: 2 }) : '';

            const formHtml = `
            <form id="form-valoracion" data-id="${cuentaId}" novalidate>
                <p class="form-label" style="margin-bottom: var(--sp-3);">
                    Introduce el valor de mercado actual para <strong>${escapeHTML(cuenta.nombre)}</strong>. Esto actualizará el P&L y la TIR.
                </p>
                <div class="form-group">
                    <label for="valoracion-valor" class="form-label">Nuevo Valor Total del Activo</label>
                    <input type="text" id="valoracion-valor" class="form-input input-amount-calculator" inputmode="decimal" required value="${valorActualInput}" placeholder="Ej: 15250,75">
                </div>
                <div class="form-group">
                    <label for="valoracion-fecha" class="form-label">Fecha de la Valoración</label>
                    <input type="date" id="valoracion-fecha" class="form-input" value="${fechaISO}" required>
                </div>
                <div class="modal__actions">
                    <button type="submit" class="btn btn--primary">Guardar Valoración</button>
                </div>
            </form>`;

            showGenericModal(`Actualizar Valor de ${cuenta.nombre}`, formHtml);
        };

        const handleSaveValoracion = async (form, btn) => {
            setButtonLoading(btn, true);
            const cuentaId = form.dataset.id;
            const valor = parseCurrencyString(select('valoracion-valor').value);
            const fecha = select('valoracion-fecha').value;

            if (!cuentaId || isNaN(valor) || !fecha || valor < 0) {
                showToast('El valor debe ser un número positivo y la fecha es obligatoria.', 'warning');
                setButtonLoading(btn, false);
                return;
            }

            const newId = generateId();
            const newValoracion = {
                id: newId,
                cuentaId: cuentaId,
                valor: Math.round(valor * 100),
                fecha: parseDateStringAsUTC(fecha).toISOString()
            };

            await saveDoc('inversiones_historial', newId, newValoracion);
            setButtonLoading(btn, false);
            hideModal('generic-modal');
            hapticFeedback('success');
            showToast('Valor del activo actualizado.');
            
            const activePageEl = document.querySelector('.view--active');
            const activePage = activePageEl ? activePageEl.id : null;
            if (activePage === PAGE_IDS.PATRIMONIO) {
                renderPatrimonioPage();
            }
            if (activePage === PAGE_IDS.ANALISIS) {
                renderAnalisisPage();
            }
        };
		const showHelpModal = () => {
            // Apuntamos a los nuevos IDs del modal de ayuda
            const titleEl = select('help-modal-title');
            const bodyEl = select('help-modal-body');
            
            if (titleEl) {
                titleEl.textContent = t('help_title');
            }
            if (bodyEl) {
                bodyEl.innerHTML = t('help_content');
            }
            
            // Llamamos a showModal con el ID del nuevo modal
            showModal('help-modal');
        };
     
		const updateThemeIcon = (theme) => {
            const themeBtn = select('theme-toggle-btn');
            if (themeBtn) {
                const iconEl = themeBtn.querySelector('.material-icons');
                if (iconEl) {
                    const isDark = theme === 'default';
                    iconEl.textContent = isDark ? 'light_mode' : 'dark_mode';
                    themeBtn.title = isDark ? 'Cambiar a Tema Claro' : 'Cambiar a Tema Oscuro';
                }
            }
        };

        const handleToggleTheme = () => {
            const currentTheme = document.body.dataset.theme || 'default';
            const newTheme = currentTheme === 'default' ? 'crystal' : 'default';
            
            document.body.dataset.theme = newTheme;
            localStorage.setItem('appTheme', newTheme);
            hapticFeedback('light');
            updateThemeIcon(newTheme);

            if (conceptosChart) conceptosChart.destroy();
            if (liquidAssetsChart) liquidAssetsChart.destroy();
            if (informesChart) informesChart.destroy();
            
            const activePageEl = document.querySelector('.view--active');
            const activePageId = activePageEl ? activePageEl.id : null;
            if (activePageId) {
                navigateTo(activePageId, true);
            }
        };
        const showConceptosModal = () => { 
            const html = `
                <form id="add-concepto-form" novalidate style="margin-bottom: var(--sp-4);">
                    <div class="form-grid"><div class="form-group" style="grid-column: 1 / -1;"><label for="new-concepto-nombre" class="form-label">Nombre del Concepto</label><input type="text" id="new-concepto-nombre" class="form-input" placeholder="Ej: Nómina" required></div></div>
                    <button type="submit" class="btn btn--primary btn--full">Añadir Concepto</button>
                </form>
                <hr style="border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-top: var(--sp-4); margin-bottom: var(--sp-2); font-size: var(--fs-base); color: var(--c-on-surface-secondary);">Conceptos Existentes</h4><div id="conceptos-modal-list"></div>`; 
            showGenericModal('Gestionar Conceptos', html); 
            renderConceptosModalList(); 
        };
        
        const renderConceptosModalList = () => { 
            const list = select('conceptos-modal-list'); 
            if (!list) return; 
            list.innerHTML = (db.conceptos || []).length === 0 
                ? `<p style="font-size:var(--fs-sm); color:var(--c-on-surface-secondary); text-align:center; padding: var(--sp-4) 0;">No hay conceptos.</p>` 
                : [...db.conceptos].sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => {
                    const icon = (c && c.icon) || 'label';
                    const nombre = (c && c.nombre) || '';
                    return `<div id="concepto-item-${c.id}" class="modal__list-item"><div style="display: flex; align-items: center; gap: 12px; flex-grow: 1; min-width: 0;"><span class="material-icons" style="color: var(--c-primary);">${icon}</span><span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(nombre)}</span></div><div style="display: flex; align-items: center; gap: var(--sp-1); flex-shrink: 0;"><button class="icon-btn" data-action="edit-concepto" data-id="${c.id}" title="Editar Concepto"><span class="material-icons">edit_note</span></button><button class="icon-btn" data-action="delete-concepto" data-id="${c.id}" title="Eliminar Concepto"><span class="material-icons">delete_outline</span></button></div></div>`;
                }).join(''); 
        };
        
        const showConceptoEditForm = (id) => {
            const itemContainer = select(`concepto-item-${id}`);
            const concepto = db.conceptos.find(c => c.id === id);
            if (!itemContainer || !concepto) return;
            itemContainer.innerHTML = `
                <form class="inline-edit-form" data-id="${id}" novalidate>
                    <div class="form-group" style="margin-bottom: 0;"><label class="form-label" for="edit-concepto-nombre-${id}">Nombre</label><input type="text" id="edit-concepto-nombre-${id}" class="form-input" value="${escapeHTML(concepto.nombre)}" required></div>
                    <div style="display:flex; justify-content: flex-end; gap: var(--sp-2); align-items: center; margin-top: var(--sp-2);"><button type="button" class="btn btn--secondary" data-action="cancel-edit-concepto">Cancelar</button><button type="button" class="btn btn--primary" data-action="save-edited-concepto" data-id="${id}">Guardar</button></div>
                </form>`;
            select(`edit-concepto-nombre-${id}`).focus();
        };
        const handleSaveEditedConcept = async (id, btn) => {
            const nombreInput = select(`edit-concepto-nombre-${id}`);
            const nombre = nombreInput.value.trim();
            if (!nombre) { showToast('El nombre es obligatorio.', 'warning'); nombreInput.classList.add('form-input--invalid'); return; }
            
            await saveDoc('conceptos', id, { nombre }, btn);
			hapticFeedback('success');
			showToast('Concepto actualizado.');
			renderConceptosModalList();
        };

        const showCuentasModal = () => { 
            const existingAccountTypes = [...new Set((db.cuentas || []).map(c => c.tipo))].sort();
            const datalistOptions = existingAccountTypes.map(type => `<option value="${type}"></option>`).join('');
            const html = `
            <form id="add-cuenta-form" novalidate>
                <div class="form-group"><label for="new-cuenta-nombre" class="form-label">Nombre de la Cuenta</label><input type="text" id="new-cuenta-nombre" class="form-input" placeholder="Ej: Cartera personal" required></div>
                <div class="form-group"><label for="new-cuenta-tipo" class="form-label">Tipo de Cuenta</label><input type="text" id="new-cuenta-tipo" class="form-input" list="tipos-cuenta-list" placeholder="Ej: Banco, Cripto, Fintech..." required><datalist id="tipos-cuenta-list">${datalistOptions}</datalist></div>
                <button type="submit" class="btn btn--primary btn--full" style="margin-top: var(--sp-3)">Añadir Cuenta</button>
            </form>
            <hr style="margin: var(--sp-4) 0; border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-top: var(--sp-4); margin-bottom: var(--sp-2); font-size: var(--fs-base); color: var(--c-on-surface-secondary);">Cuentas Existentes</h4><div id="cuentas-modal-list"></div>`; 
            showGenericModal('Gestionar Cuentas', html); 
            renderCuentasModalList(); 
        };
    
        const renderCuentasModalList = () => {
            const list = select('cuentas-modal-list');
            if (!list) return;
            list.innerHTML = (db.cuentas || []).length === 0 
                ? `<p style="font-size:var(--fs-sm); color:var(--c-on-surface-secondary); text-align:center; padding: var(--sp-4) 0;">No hay cuentas.</p>` 
                : [...db.cuentas].sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => `
                    <div class="modal__list-item" id="cuenta-item-${c.id}">
                    <div style="display: flex; flex-direction: column; flex-grow: 1; min-width: 0;"><span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(c.nombre)}</span><small style="color: var(--c-on-surface-secondary); font-size: var(--fs-xs);">${toSentenceCase(escapeHTML(c.tipo))}</small></div>
                    <div style="display: flex; align-items: center; gap: var(--sp-1); flex-shrink: 0;"><div class="form-switch-group" style="gap: var(--sp-2);"><label for="offbalance-toggle-${c.id}" style="font-size: var(--fs-xs); color: var(--c-on-surface-secondary);" title="Marcar como 'Contabilidad B'">B</label><label class="form-switch"><input type="checkbox" id="offbalance-toggle-${c.id}" data-action="toggle-off-balance" data-id="${c.id}" ${c.offBalance ? 'checked' : ''}><span class="slider"></span></label></div><button class="icon-btn" data-action="edit-cuenta" data-id="${c.id}" title="Editar Cuenta"><span class="material-icons">edit_note</span></button><button class="icon-btn" data-action="delete-cuenta" data-id="${c.id}" title="Eliminar Cuenta"><span class="material-icons">delete_outline</span></button></div>
                    </div>`).join('');
        };
    
        const showAccountEditForm = (id) => {
            const itemContainer = select(`cuenta-item-${id}`);
            const cuenta = db.cuentas.find(c => c.id === id);
            if (!itemContainer || !cuenta) return;
            itemContainer.innerHTML = `
                <form class="inline-edit-form" data-id="${id}" novalidate>
                    <div class="form-grid">
                                                <div class="form-group" style="margin-bottom: 0;"><label class="form-label" for="edit-cuenta-nombre-${id}">Nombre</label><input type="text" id="edit-cuenta-nombre-${id}" class="form-input" value="${escapeHTML(cuenta.nombre)}" required></div>
                        <div class="form-group" style="margin-bottom: 0;"><label class="form-label" for="edit-cuenta-tipo-${id}">Tipo</label><input type="text" id="edit-cuenta-tipo-${id}" class="form-input" list="tipos-cuenta-list" value="${escapeHTML(cuenta.tipo)}" required></div>
                    </div>
                    <div style="display:flex; justify-content: flex-end; gap: var(--sp-2); align-items: center; margin-top: var(--sp-2);"><button type="button" class="btn btn--secondary" data-action="cancel-edit-cuenta">Cancelar</button><button type="button" class="btn btn--primary" data-action="save-edited-cuenta" data-id="${id}">Guardar</button></div>
                </form>`;
            select(`edit-cuenta-nombre-${id}`).focus();
        };
    
        const handleSaveEditedAccount = async (id, btn) => {
            const nombreInput = select(`edit-cuenta-nombre-${id}`);
            const tipoInput = select(`edit-cuenta-tipo-${id}`);
            const nombre = nombreInput.value.trim();
            const tipo = toSentenceCase(tipoInput.value.trim());
        
            if (!nombre || !tipo) { showToast('El nombre y el tipo no pueden estar vacíos.', 'warning'); if (!nombre) nombreInput.classList.add('form-input--invalid'); if (!tipo) tipoInput.classList.add('form-input--invalid'); return; }
            
            await saveDoc('cuentas', id, { nombre, tipo }, btn);
            hapticFeedback('success');
            showToast('Cuenta actualizada.');
            renderCuentasModalList();
        };

        const showRecurrentesModal = () => {
            let html = `<p class="form-label" style="margin-bottom: var(--sp-3);">Aquí puedes ver y gestionar tus operaciones programadas. Se crearán automáticamente en su fecha de ejecución.</p><div id="recurrentes-modal-list"></div>`;
            showGenericModal('Gestionar Movimientos Recurrentes', html);
            renderRecurrentesModalList();
        };
				
        const renderRecurrentesModalList = () => {
            const list = select('recurrentes-modal-list');
            if (!list) return;
            const recurrentes = [...(db.recurrentes || [])].sort((a,b) => new Date(a.nextDate) - new Date(b.nextDate));
            list.innerHTML = recurrentes.length === 0 
                ? `<div class="empty-state" style="background:transparent; padding:var(--sp-4) 0; border: none;"><span class="material-icons">event_repeat</span><h3>Sin operaciones programadas</h3><p>Puedes crear una al añadir un nuevo movimiento.</p></div>`
                : recurrentes.map(r => {
                    const nextDate = new Date(r.nextDate).toLocaleDateString(locales[currentLanguage], { day: '2-digit', month: 'short', year: 'numeric' });
                    const frequencyMap = { daily: 'Diaria', weekly: 'Semanal', monthly: 'Mensual', yearly: 'Anual' };
                    const amountClass = r.cantidad >= 0 ? 'text-positive' : 'text-negative';
                    const icon = r.cantidad >= 0 ? 'south_west' : 'north_east';
                    return `
                    <div class="modal__list-item" id="recurrente-item-${r.id}">
                        <div style="display: flex; align-items: center; gap: 12px; flex-grow: 1; min-width: 0;">
                            <span class="material-icons ${amountClass}" style="font-size: 20px;">${icon}</span>
                        <div style="display: flex; flex-direction: column; min-width: 0;">
                                <span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(r.descripcion)}</span>
                                <small style="color: var(--c-on-surface-secondary); font-size: var(--fs-xs);">Próximo: ${nextDate} (${frequencyMap[r.frequency]})</small>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--sp-1); flex-shrink: 0;">
                            <strong class="${amountClass}" style="margin-right: var(--sp-2);">${formatCurrency(r.cantidad)}</strong>
                            <button class="icon-btn" data-action="edit-recurrente" data-id="${r.id}" title="Editar Recurrente"><span class="material-icons">edit</span></button>
                        </div>
                    </div>`
                }).join('');
        };

        const showManageInvestmentAccountsModal = () => {
            const visibleAccounts = getVisibleAccounts().sort((a, b) => a.nombre.localeCompare(b.nombre));
            let formHtml = `
            <form id="manage-investment-accounts-form" novalidate>
                <p class="form-label" style="margin-bottom: var(--sp-3);">
                    Selecciona las cuentas que quieres que formen parte de tu portafolio de inversión. Estas aparecerán en la sección "Portafolio" para un seguimiento detallado de su rentabilidad.
                </p>
                <div style="max-height: 40vh; overflow-y: auto; padding: var(--sp-2); background: var(--c-surface-variant); border-radius: var(--border-radius-md);">`;

            if (visibleAccounts.length > 0) {
                formHtml += visibleAccounts.map(c => `
                    <div class="form-checkbox-group modal__list-item" style="padding: var(--sp-2);">
                        <input type="checkbox" id="investment-toggle-${c.id}" value="${c.id}" ${c.esInversion ? 'checked' : ''}>
                        <label for="investment-toggle-${c.id}" style="flex-grow: 1;">${escapeHTML(c.nombre)} <small>(${toSentenceCase(c.tipo)})</small></label>
                    </div>
                `).join('');
            } else {
                formHtml += `<p class="empty-state" style="background: transparent; border: none;">No hay cuentas en la contabilidad actual para configurar.</p>`;
            }

            formHtml += `
                </div>
                <div class="modal__actions">
                    <button type="submit" class="btn btn--primary btn--full">Guardar Selección</button>
                </div>
            </form>`;

            showGenericModal('Gestionar Activos de Inversión', formHtml);
        };

        const showAportacionModal = (cuentaId = null) => {
            const investmentAccounts = getVisibleAccounts().filter(c => c.esInversion);
            if (investmentAccounts.length === 0) {
                showToast('Primero debes marcar al menos una cuenta como activo de inversión.', 'warning', 4000);
                return;
            }
            
            const fechaISO = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
            
            const accountsOptions = investmentAccounts
                .sort((a, b) => a.nombre.localeCompare(b.nombre))
                .map(c => `<option value="${c.id}" ${cuentaId === c.id ? 'selected' : ''}>${escapeHTML(c.nombre)}</option>`)
                .join('');

            let formHtml = `
            <form id="form-aportacion" novalidate>
                <p class="form-label" style="margin-bottom: var(--sp-3);">
                    Registra una entrada (aportación, positivo) o salida (retiro, negativo) de capital en uno de tus activos. Esto es crucial para calcular correctamente la rentabilidad (TIR).
                </p>
                <div class="form-group">
                    <label for="aportacion-cuenta" class="form-label">Activo de Inversión</label>
                    <select id="aportacion-cuenta" class="form-select">${accountsOptions}</select>
                </div>
                <div class="form-group">
                    <label for="aportacion-cantidad" class="form-label">Cantidad (retiro en negativo)</label>
                    <input type="text" id="aportacion-cantidad" class="form-input input-amount-calculator" inputmode="decimal" required placeholder="Ej: -250,50 para un retiro">
                </div>
                <div class="form-group">
                    <label for="aportacion-fecha" class="form-label">Fecha</label>
                    <input type="date" id="aportacion-fecha" class="form-input" value="${fechaISO}" required>
                </div>
                <div class="form-group">
                    <label for="aportacion-notas" class="form-label">Notas (Opcional)</label>
                    <input type="text" id="aportacion-notas" class="form-input" placeholder="Ej: Aportación periódica">
                </div>
                <div class="modal__actions">
                    <button type="submit" class="btn btn--primary">Guardar</button>
                </div>
            </form>`;

            showGenericModal('Registrar Aportación/Retiro', formHtml);
        };
        // =================================================================================
        // 10. EVENT LISTENERS & HANDLERS
        // =================================================================================
		
				// ===== INICIO: REEMPLAZA TU FUNCIÓN 'attachEventListeners' COMPLETA CON ESTA =====
        const attachEventListeners = () => {
            document.body.addEventListener('click', async (e) => {
                const target = e.target;

                // CASO 1: Abrir la calculadora al hacer clic en el campo de cantidad.
                if (target.matches('.input-amount-calculator')) {
                    e.preventDefault();
                    showCalculator(target);
                    return; // Salimos para no procesar más acciones.
                }

                // CASO 2: Gestionar todos los demás botones con 'data-action'.
                const actionTarget = target.closest('[data-action]');
                
                // Si no se hizo clic en un elemento con 'data-action', no hacemos nada.
                if (!actionTarget) {
                    return;
                }

                // Si llegamos aquí, SÍ hay una acción que procesar.
                const { action, id, page, type, modalId, view, filter } = actionTarget.dataset;
                const btn = actionTarget.closest('button');

                const actions = {
					 'show-help-topic': () => {
    const topic = actionTarget.dataset.topic;
    if (topic) {
        const titleKey = `help_topic_${topic}_title`;
        const contentKey = `help_topic_${topic}_content`;

        // ---- INICIO DEL CAMBIO ----
        // ANTES: Se llamaba a showGenericModal(...) que usaba el modal incorrecto.
        
        // AHORA: Apuntamos directamente a los elementos del modal de ayuda correcto (#help-modal)
        // y lo mostramos.
        const titleEl = select('help-modal-title');
        const bodyEl = select('help-modal-body');
        
        if (titleEl) titleEl.textContent = t(titleKey);
        if (bodyEl) bodyEl.innerHTML = `<div style="padding: 0 var(--sp-2);">${t(contentKey)}</div>`;
        
        showModal('help-modal'); // <-- La llamada clave para mostrar el modal correcto
        // ---- FIN DEL CAMBIO ----
    }
},
					 'use-password-instead': () => showPasswordFallback(),
					'toggle-theme': handleToggleTheme,
                    'toggle-investment-type-filter': () => handleToggleInvestmentTypeFilter(type),
                    'filter-investments': () => handleFilterInvestments(filter),
					                     'confirm-recurrent': async (event) => {
                        const actionTarget = event.target.closest('[data-action]');
                        if (!actionTarget) return;
                        const {
                            id
                        } = actionTarget.dataset;
                        const btn = actionTarget.closest('button');
                        if (!id || !btn) return;
                        try {
                            setButtonLoading(btn, true);
                            const recurrente = db.recurrentes.find(r => r.id === id);
                            if (!recurrente) {
                                showToast('Error: No se encontró la operación recurrente.', 'danger');
                                return;
                            }
                            const fechaDeEjecucion = parseDateStringAsUTC(recurrente.nextDate);
                            const newMovement = {
                                id: generateId(),
                                fecha: fechaDeEjecucion.toISOString(),
                                cantidad: recurrente.cantidad,
                                descripcion: recurrente.descripcion,
                                tipo: recurrente.tipo,
                                cuentaId: recurrente.cuentaId,
                                conceptoId: recurrente.conceptoId,
                                cuentaOrigenId: recurrente.cuentaOrigenId,
                                cuentaDestinoId: recurrente.cuentaDestinoId,
                                sourceRecurrenceId: recurrente.id
                            };
                            const newNextDate = calculateNextDueDate(fechaDeEjecucion, recurrente.frequency);
                            const newNextDateString = newNextDate.toISOString().slice(0, 10);
                            const batch = fbDb.batch();
                            const movRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(newMovement.id);
                            const recRef = fbDb.collection('users').doc(currentUser.uid).collection('recurrentes').doc(id);
                            batch.set(movRef, newMovement);
                            batch.update(recRef, {
                                nextDate: newNextDateString
                            });
                            if (newMovement.tipo === 'traspaso') {
                                await updateAccountBalance(newMovement.cuentaOrigenId, -newMovement.cantidad);
                                await updateAccountBalance(newMovement.cuentaDestinoId, newMovement.cantidad);
                            } else {
                                await updateAccountBalance(newMovement.cuentaId, newMovement.cantidad);
                            }
                            await batch.commit();
                            hapticFeedback('success');
                            showToast('Movimiento programado añadido.');
                            const pendingItem = select(`pending-recurrente-${id}`);
                            if (pendingItem) {
                                pendingItem.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                                pendingItem.style.opacity = '0';
                                pendingItem.style.transform = 'scale(0.95)';
                                setTimeout(() => pendingItem.remove(), 300);
                            }
                        } catch (error) {
                            console.error("Error al confirmar el movimiento recurrente:", error);
                            showToast("No se pudo añadir el movimiento. Revisa tu conexión.", "danger");
                        } finally {
                            setButtonLoading(btn, false);
                        }
                    }, // <-- LLAVE DE CIERRE AÑADIDA
                                        'skip-recurrent': async (event) => {
                        const actionTarget = event.target.closest('[data-action]');
                        if (!actionTarget) return;
                        const {
                            id
                        } = actionTarget.dataset;
                        const recurrente = db.recurrentes.find(r => r.id === id);
                        if (!recurrente) {
                            showToast('Error: No se encontró la operación recurrente.', 'danger');
                            return;
                        }
                        try {
                            const fechaDeEjecucion = parseDateStringAsUTC(recurrente.nextDate);
                            const newNextDate = calculateNextDueDate(fechaDeEjecucion, recurrente.frequency);
                            const newNextDateString = newNextDate.toISOString().slice(0, 10);
                            await saveDoc('recurrentes', id, {
                                nextDate: newNextDateString
                            });
                            hapticFeedback('success');
                            showToast('Operación omitida. Programada para la siguiente fecha.');
                            const pendingItem = select(`pending-recurrente-${id}`);
                            if (pendingItem) {
                                pendingItem.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                                pendingItem.style.opacity = '0';
                                pendingItem.style.transform = 'scale(0.95)';
                                setTimeout(() => pendingItem.remove(), 300);
                            }
                        } catch (error) {
                            console.error("Error al omitir el movimiento recurrente:", error);
                            showToast("No se pudo omitir la operación. Revisa tu conexión.", "danger");
                        }
                    }, // <-- LLAVE DE CIERRE AÑADIDA
                    'navigate': () => navigateTo(page),
                    'help': showHelpModal,
                    'exit': handleExitApp,
                    'forgot-password': (e) => { e.preventDefault(); const email = prompt("Por favor, introduce el correo electrónico de tu cuenta para restablecer la contraseña:"); if (email) { firebase.auth().sendPasswordResetEmail(email).then(() => { showToast('Se ha enviado un correo para restablecer tu contraseña.', 'info', 5000); }).catch((error) => { console.error("Error al enviar correo de recuperación:", error); if (error.code === 'auth/user-not-found') { showToast('No se encontró ninguna cuenta con ese correo.', 'danger'); } else { showToast('Error al intentar restablecer la contraseña.', 'danger'); } }); } },
                    'show-register': (e) => { e.preventDefault(); const mainButton = document.querySelector('#login-form button[data-action="login"]'); handleRegister(mainButton); },
                    'import-csv': showCsvImportWizard,
                    'toggle-ledger': async () => { hapticFeedback('medium'); isOffBalanceMode = !isOffBalanceMode; document.body.dataset.ledgerMode = isOffBalanceMode ? 'B' : 'A'; const activePageEl = selectOne('.view--active'); const activePage = activePageEl ? activePageEl.id : PAGE_IDS.INICIO; navigateTo(activePage, false); showToast(`Mostrando Contabilidad ${isOffBalanceMode ? 'B' : 'A'}.`, 'info'); },
                    'toggle-off-balance': async () => { const checkbox = target.closest('input[type="checkbox"]'); if (!checkbox) return; hapticFeedback('light'); await saveDoc('cuentas', checkbox.dataset.id, { offBalance: checkbox.checked }); },
                    'apply-filters': () => { hapticFeedback('light'); updateDashboardData(); },
                    'apply-informe-filters': () => { hapticFeedback('light'); renderInformesPage(); },
                    'add-movement': () => startMovementForm(),
                    'edit-movement': async () => { if (select('generic-modal')?.classList.contains('modal-overlay--active')) { hideModal('generic-modal'); } let movementData = db.movimientos.find(m => m.id === id); if (!movementData) { movementData = recentMovementsCache.find(item => item.id === id); } if (!movementData && id) { try { const movRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(id); const doc = await movRef.get(); if (doc.exists) { movementData = { id: doc.id, ...doc.data() }; if (!db.movimientos.some(m => m.id === id)) { db.movimientos.push(movementData); } } else { showToast('Error: No se encontró el movimiento.', 'danger'); return; } } catch (error) { console.error("Error al obtener el movimiento:", error); showToast('No se pudo cargar el movimiento para editar.', 'danger'); return; } } startMovementForm(id, false); },
                    'edit-recurrente': () => { hideModal('generic-modal'); startMovementForm(id, true); },
                    'delete-movement-from-modal': () => { const isRecurrent = (actionTarget.dataset.isRecurrent === 'true'); const idToDelete = select('movimiento-id').value; const collection = isRecurrent ? 'recurrentes' : 'movimientos'; const message = isRecurrent ? '¿Seguro que quieres eliminar esta operación recurrente?' : '¿Seguro que quieres eliminar este movimiento?'; showConfirmationModal(message, async () => { const batch = fbDb.batch(); const movRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(idToDelete); if (!isRecurrent) { const doc = await movRef.get(); if (doc.exists) { const movToDelete = doc.data(); const cashflowQuery = await fbDb.collection('users').doc(currentUser.uid).collection('inversion_cashflows').where('sourceMovementId', '==', idToDelete).get(); if (!cashflowQuery.empty) { cashflowQuery.forEach(cfDoc => batch.delete(cfDoc.ref)); } if (movToDelete.tipo === 'traspaso') { await updateAccountBalance(movToDelete.cuentaOrigenId, movToDelete.cantidad); await updateAccountBalance(movToDelete.cuentaDestinoId, -movToDelete.cantidad); } else { await updateAccountBalance(movToDelete.cuentaId, -movToDelete.cantidad); } recentMovementsCache = recentMovementsCache.filter(m => m.id !== idToDelete); } } batch.delete(fbDb.collection('users').doc(currentUser.uid).collection(collection).doc(idToDelete)); await batch.commit(); hideModal('movimiento-modal'); hapticFeedback('success'); showToast('Operación eliminada.'); const currentPageEl = select('.view--active'); const currentPage = currentPageEl ? currentPageEl.id : null; if (currentPage === PAGE_IDS.INICIO) { _renderRecientesFromCache(); updateDashboardData(); } else if (currentPage === PAGE_IDS.MOVIMIENTOS_FULL) { loadInitialMovements(); } }); },
                    'delete-concepto': async () => { const movsCheck = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').where('conceptoId', '==', id).limit(1).get(); if(!movsCheck.empty) { showToast("Concepto en uso, no se puede borrar.","warning"); return; } showConfirmationModal('¿Seguro que quieres eliminar este concepto?', async () => { await deleteDoc('conceptos', id); hapticFeedback('success'); showToast("Concepto eliminado."); }); },
                    'delete-cuenta': async () => { const movsCheck = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').where('cuentaId', '==', id).limit(1).get(); if(!movsCheck.empty) { showToast("Cuenta con movimientos, no se puede borrar.","warning",3500); return; } showConfirmationModal('¿Seguro que quieres eliminar esta cuenta?', async () => { await deleteDoc('cuentas', id); hapticFeedback('success'); showToast("Cuenta eliminada."); }); },
                    'close-modal': () => { const closestOverlay = target.closest('.modal-overlay'); const effectiveModalId = modalId || (closestOverlay ? closestOverlay.id : null); if ((effectiveModalId === 'generic-modal') && detailInvestmentChart) { detailInvestmentChart.destroy(); detailInvestmentChart = null; } if (effectiveModalId) hideModal(effectiveModalId); },
                    'manage-conceptos': showConceptosModal,
                    'manage-cuentas': showCuentasModal,
                    'manage-recurrentes': showRecurrentesModal,
                    'view-account-details': () => showAccountMovementsModal(id),
                    'save-config': () => handleSaveConfig(btn),
                    'export-data': () => handleExportData(btn),
                    'export-csv': () => handleExportCsv(btn),
                    'import-data': () => showImportJSONWizard(),
                    'clear-data': () => { showConfirmationModal('¿Seguro que quieres borrar TODOS tus datos financieros? Esta acción es irreversible.', () => { showConfirmationModal('Esta es tu última oportunidad. ¿Estás absolutamente seguro?', () => { const button = actionTarget.closest('button'); handleDeleteAllData(button); }, 'Confirmación Final'); }); },
                    'toggle-account-type-filter': () => { hapticFeedback('light'); if(deselectedAccountTypesFilter.has(type)) { deselectedAccountTypesFilter.delete(type); } else { deselectedAccountTypesFilter.add(type); } renderPatrimonioPage(); },
                    'create-budgets': () => handleCreateBudgets(btn),
                    'update-budgets': handleUpdateBudgets,
                    'logout': () => showConfirmationModal('¿Seguro que quieres cerrar la sesión?', () => { fbAuth.signOut().then(() => { showToast('Sesión cerrada correctamente.'); }).catch(() => { showToast('Error al cerrar sesión.', 'danger'); }); }, 'Cerrar Sesión'),
                    'delete-account': () => { const button = actionTarget.closest('button'); handleDeleteAccount(button) },
                    'view-investment-detail': () => renderInvestmentAccountDetail(id),
                    'manage-investment-accounts': showManageInvestmentAccountsModal,
                    'add-aportacion': () => showAportacionModal(),
                    'update-asset-value': () => showValoracionModal(id),
                    'global-search': showGlobalSearchModal,
                    'search-result-movimiento': () => { hideModal('global-search-modal'); startMovementForm(id, false); },
                    'search-result-cuenta': () => { hideModal('global-search-modal'); showCuentasModal(); setTimeout(() => { const el = select(`cuenta-item-${id}`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 200); },
                    'search-result-concepto': () => { hideModal('global-search-modal'); showConceptosModal(); setTimeout(() => { const el = select(`concepto-item-${id}`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 200); },
                    'edit-concepto': () => showConceptoEditForm(id),
                    'cancel-edit-concepto': renderConceptosModalList,
                    'save-edited-concepto': () => handleSaveEditedConcept(id, btn),
                    'edit-cuenta': () => showAccountEditForm(id),
                    'cancel-edit-cuenta': renderCuentasModalList,
                    'save-edited-cuenta': () => handleSaveEditedAccount(id, btn),
                    'duplicate-movement': () => handleDuplicateMovement(),
                    'save-dashboard-config': () => handleSaveDashboardConfig(btn),
                    'set-movimiento-type': () => setMovimientoFormType(type),
                    'set-inicio-view': () => { hapticFeedback('light'); const isResumen = view === 'resumen'; selectAll('#inicio-view-switcher .filter-pill').forEach(pill => pill.classList.remove('filter-pill--active')); actionTarget.classList.add('filter-pill--active'); select('inicio-view-resumen').classList.toggle('hidden', !isResumen); select('inicio-view-recientes').classList.toggle('hidden', isResumen); if (isResumen) { updateDashboardData(); } },
                    'recalculate-balances': () => { showConfirmationModal( 'Esta acción leerá todo tu historial de transacciones para recalcular y corregir el saldo de cada una de tus cuentas. Es útil si sospechas que hay errores en los saldos. ¿Quieres continuar?', () => { const button = actionTarget.closest('button'); recalculateAllAccountBalances(button)}, 'Confirmar Recálculo de Saldos' ); },
                    'json-wizard-back-2': () => goToJSONStep(1),
                    'json-wizard-import-final': () => handleFinalJsonImport(btn),
                    'toggle-traspaso-accounts-filter': () => populateTraspasoDropdowns(),
					'set-pin': async () => {
        const pin = prompt("Introduce tu nuevo PIN de 4 dígitos. Déjalo en blanco para eliminarlo.");
        if (pin === null) return; // El usuario canceló

        if (pin === "") {
            localStorage.removeItem('pinUserHash');
            localStorage.removeItem('pinUserEmail');
            showToast('PIN de acceso rápido eliminado.', 'info');
            return;
        }

        if (!/^\d{4}$/.test(pin)) {
            showToast('El PIN debe contener exactamente 4 dígitos numéricos.', 'danger');
            return;
        }

        const pinConfirm = prompt("Confirma tu nuevo PIN de 4 dígitos.");
        if (pin !== pinConfirm) {
            showToast('Los PINs no coinciden. Inténtalo de nuevo.', 'danger');
            return;
        }
        
        const pinHash = await hashPin(pin);
        localStorage.setItem('pinUserHash', pinHash);
        localStorage.setItem('pinUserEmail', currentUser.email);
        hapticFeedback('success');
        showToast('¡PIN de acceso rápido configurado con éxito!', 'info');
    },
                };
                
                if (actions[action]) {
                    actions[action](e);
                }
            });

            document.body.addEventListener('submit', (e) => {
                e.preventDefault();
                const target = e.target;
                const submitter = e.submitter;
                const handlers = {
                    'login-form': () => handleLogin(submitter),
                    'form-movimiento': () => handleSaveMovement(target, submitter),
                    'add-concepto-form': () => handleAddConcept(submitter),
                    'add-cuenta-form': () => handleAddAccount(submitter),
                    'manage-investment-accounts-form': () => handleSaveInvestmentAccounts(target, submitter),
                    'form-aportacion': () => handleSaveAportacion(target, submitter),
                    'form-valoracion': () => handleSaveValoracion(target, submitter),
                };
                if (handlers[target.id]) {
                    handlers[target.id]();
                }
            });

            document.body.addEventListener('input', (e) => {
                const id = e.target.id;
                if (id) {
                    clearError(id);
                    if (id === 'movimiento-cantidad') validateField('movimiento-cantidad', true);
                    if (id === 'movimiento-descripcion') handleDescriptionInput();
                    if (id === 'movimiento-concepto' || id === 'movimiento-cuenta') validateField(id, true);
                    if (id === 'movimiento-cuenta-origen' || id === 'movimiento-cuenta-destino') {
                         validateField('movimiento-cuenta-origen', true);
                         validateField('movimiento-cuenta-destino', true);
                    }
                }
            });

            document.body.addEventListener('blur', (e) => {
                const id = e.target.id;
                if (id) {
                    if (id === 'movimiento-cantidad') validateField('movimiento-cantidad');
                    if (id === 'movimiento-descripcion') {
                        if (!e.relatedTarget || !e.relatedTarget.closest('#description-suggestions')) {
                            const suggestionsBox = select('description-suggestions');
                            if (suggestionsBox) suggestionsBox.style.display = 'none';
                        }
                    }
                    if (id === 'movimiento-concepto' || id === 'movimiento-cuenta') validateField(id);
                    if (id === 'movimiento-cuenta-origen' || id === 'movimiento-cuenta-destino') {
                         validateField('movimiento-cuenta-origen');
                         validateField('movimiento-cuenta-destino');
                    }
                }
            }, true);
            
            document.body.addEventListener('focusin', (e) => {
                if (e.target.matches('.pin-input')) {
                    handlePinInputInteraction();
                }
                if (e.target.id === 'movimiento-descripcion') {
                    handleDescriptionInput();
                }
            });

            document.addEventListener('change', e => {
                const target = e.target;
                if (target.id === 'filter-periodo') { const el = select('custom-date-filters'); if (el) el.classList.toggle('hidden', target.value !== 'custom'); }
                if (target.id === 'movimiento-recurrente') { select('recurrent-options').classList.toggle('hidden', !target.checked); if(target.checked && !select('recurrent-next-date').value) { select('recurrent-next-date').value = select('movimiento-fecha').value; } }
            });

            const importFileInput = select('import-file-input');
            if (importFileInput) importFileInput.addEventListener('change', (e) => { if(e.target.files) handleJSONFileSelect(e.target.files[0]); });
            
            const calculatorGrid = select('calculator-grid');
            if (calculatorGrid) calculatorGrid.addEventListener('click', (e) => { const btn = e.target.closest('button'); if(btn && btn.dataset.key) handleCalculatorInput(btn.dataset.key); });
            
            const searchInput = select('global-search-input');
            if (searchInput) searchInput.addEventListener('input', () => { clearTimeout(globalSearchDebounceTimer); globalSearchDebounceTimer = setTimeout(() => { performGlobalSearch(searchInput.value); }, 250); });
            
            document.body.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); e.stopPropagation(); showGlobalSearchModal(); }
                const tourOverlay = select('onboarding-tour');
                if(tourOverlay && tourOverlay.classList.contains('onboarding-overlay--visible')) {
                    if(e.key === 'ArrowRight') advanceOnboarding();
                    else if (e.key === 'Escape') endOnboarding();
                }
            });

            const mainScroller = selectOne('.app-layout__main');
            if (mainScroller) mainScroller.addEventListener('scroll', () => {
                const activePage = select('.view--active');
                if (!activePage || activePage.id !== PAGE_IDS.MOVIMIENTOS_FULL) return;
                const { scrollTop, scrollHeight, clientHeight } = mainScroller;
                if (scrollHeight - scrollTop - clientHeight < 400) {
                    loadMoreMovements();
                }
            });
            
            const dropZone = select('json-drop-zone');
            if (dropZone) {
                dropZone.addEventListener('click', () => { const el = select('import-file-input'); if (el) el.click() });
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
                dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); const files = e.dataTransfer.files; if (files && files.length > 0) handleJSONFileSelect(files[0]); });
            }

            const suggestionsBox = select('description-suggestions');
            if (suggestionsBox) {
                suggestionsBox.addEventListener('click', (e) => {
                    const suggestionItem = e.target.closest('.suggestion-item');
                    if (suggestionItem) {
                        const description = suggestionItem.dataset.description;
                        const conceptoId = suggestionItem.dataset.conceptoId;
                        const cuentaId = suggestionItem.dataset.cuentaId;
                        applyDescriptionSuggestion(description, conceptoId, cuentaId);
                    }
                });
            }

            const fechaDisplayButton = select('movimiento-fecha-display');
            const fechaRealInput = select('movimiento-fecha');
            if (fechaDisplayButton && fechaRealInput) {
                fechaDisplayButton.addEventListener('click', () => fechaRealInput.showPicker());
                fechaRealInput.addEventListener('input', () => updateDateDisplay(fechaRealInput));
            }
        };
		// ===== FIN: REEMPLAZA TU FUNCIÓN COMPLETA CON ESTA =====

        
        const showImportJSONWizard = () => {
            jsonWizardState = { file: null, data: null, preview: { counts: {}, meta: {} } };
            goToJSONStep(1);
            const errorEl = select('json-file-error');
            const textEl = select('json-drop-zone-text');
            if(errorEl) errorEl.textContent = '';
            if(textEl) textEl.textContent = 'Arrastra tu archivo aquí o haz clic';
            showModal('json-import-wizard-modal');
        };

        const goToJSONStep = (stepNumber) => {
            selectAll('.json-wizard-step').forEach(step => step.style.display = 'none');
            const targetStep = select(`json-wizard-step-${stepNumber}`);
            if (targetStep) targetStep.style.display = 'flex';
        };

        const handleJSONFileSelect = (file) => {
            const errorEl = select('json-file-error');
            if(!errorEl) return;
            errorEl.textContent = '';

            if (!file.type.includes('json')) {
                errorEl.textContent = 'Error: El archivo debe ser de tipo .json.';
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    let data = JSON.parse(event.target.result);
                    let dataToAnalyze = data;

                    if (data.meta && data.data) {
                        jsonWizardState.preview.meta = data.meta;
                        dataToAnalyze = data.data;
                    } else {
                        jsonWizardState.preview.meta = { appName: 'Cuentas (Formato Antiguo)', exportDate: 'N/A' };
                    }

                    if (!dataToAnalyze.cuentas || !dataToAnalyze.conceptos || !dataToAnalyze.movimientos) {
                        throw new Error("El archivo no tiene la estructura de una copia de seguridad válida.");
                    }

                    jsonWizardState.data = dataToAnalyze;
                    
                    const counts = {};
                    for (const key in dataToAnalyze) {
                        if (Array.isArray(dataToAnalyze[key])) {
                            counts[key] = dataToAnalyze[key].length;
                        }
                    }
                    jsonWizardState.preview.counts = counts;
                    
                    renderJSONPreview();
                    goToJSONStep(2);

                } catch (error) {
                    console.error("Error al procesar el archivo JSON:", error);
                    errorEl.textContent = `Error: ${error.message}`;
                }
            };
            reader.readAsText(file);
        };

        const renderJSONPreview = () => {
            const previewList = select('json-preview-list');
            if(!previewList) return;
            const { counts } = jsonWizardState.preview;
            
            const friendlyNames = {
                cuentas: 'Cuentas', conceptos: 'Conceptos', movimientos: 'Movimientos',
                presupuestos: 'Presupuestos', recurrentes: 'Recurrentes',
                inversiones_historial: 'Historial de Inversión', inversion_cashflows: 'Flujos de Capital'
            };
            
            let html = '';
            for(const key in counts) {
                if(counts[key] > 0) {
                    html += `<li><span class="material-icons">check_circle</span> <strong>${counts[key]}</strong> ${friendlyNames[key] || key}</li>`;
                }
            }
            
            previewList.innerHTML = html || `<li><span class="material-icons">info</span>El archivo parece estar vacío.</li>`;
        };

        const handleFinalJsonImport = async (btn) => {
            goToJSONStep(3);
            setButtonLoading(btn, true, 'Importando...');
            select('json-import-progress').style.display = 'block';
            select('json-import-result').style.display = 'none';

            try {
                const dataToImport = jsonWizardState.data;
                const collectionsToClear = ['cuentas', 'conceptos', 'movimientos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];

                for (const collectionName of collectionsToClear) {
                    const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).get();
                    if (snapshot.empty) continue;
                    let batch = fbDb.batch();
                    let count = 0;
                    for (const doc of snapshot.docs) {
                        batch.delete(doc.ref);
                        count++;
                        if (count >= 450) { await batch.commit(); batch = fbDb.batch(); count = 0; }
                    }
                    if(count > 0) await batch.commit();
                }
                
                for (const collectionName of Object.keys(dataToImport)) {
                    const items = dataToImport[collectionName];
                    if (Array.isArray(items) && items.length > 0) {
                        let batch = fbDb.batch();
                        let count = 0;
                        for (const item of items) {
                            if (item.id) {
                                const docRef = fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(item.id);
                                batch.set(docRef, item);
                                count++;
                                if (count >= 450) { await batch.commit(); batch = fbDb.batch(); count = 0; }
                            }
                        }
                        if(count > 0) await batch.commit();
                    } else if (collectionName === 'config') {
                        await fbDb.collection('users').doc(currentUser.uid).set({ config: items }, { merge: true });
                    }
                }
                
                select('json-import-progress').style.display = 'none';
                select('json-import-result').style.display = 'block';
                select('json-result-message').textContent = `Se han importado los datos correctamente. La aplicación se recargará.`;
                hapticFeedback('success');
                
                setTimeout(() => location.reload(), 4000);

            } catch (error) {
                console.error("Error durante la importación final:", error);
                showToast("Error crítico durante la importación.", "danger", 5000);
                select('json-result-title').textContent = '¡Error en la Importación!';
                select('json-result-message').textContent = `Ocurrió un error. Por favor, revisa la consola e inténtalo de nuevo.`;
                select('json-import-result .material-icons').style.color = 'var(--c-danger)';
                setButtonLoading(btn, false);
            }
        };

        const handleDuplicateMovement = () => {
            hapticFeedback('medium');
            select('movimiento-mode').value = 'new';
            select('movimiento-id').value = '';
            select('form-movimiento-title').textContent = 'Duplicar Movimiento';
            select('delete-movimiento-btn').classList.add('hidden');
            select('duplicate-movimiento-btn').classList.add('hidden');
            const today = new Date();
            select('movimiento-fecha').value = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
            showToast('Datos duplicados. Ajusta y guarda.', 'info');
        };

         // =================================================================================
        // INICIO: VERSIÓN CORREGIDA DE handleSaveMovement (CONSCIENTE DE INVERSIONES)
        // =================================================================================
        const handleSaveMovement = async (form, btn) => {
            clearAllErrors(form.id);
            if (!validateMovementForm()) {
                hapticFeedback('error'); 
                showToast('Por favor, revisa los campos marcados en rojo.', 'warning'); 
                return; 
            }
            
            setButtonLoading(btn, true);

            const type = select('mov-type-btn-traspaso').classList.contains('filter-pill--active') ? 'traspaso' : 'movimiento';
            const cantidadValue = parseCurrencyString(select('movimiento-cantidad').value);

            const mode = select('movimiento-mode').value;
            const movementId = select('movimiento-id').value || generateId();
            let oldMovementData = null;

            if (mode.includes('edit')) {
                const oldDocRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(movementId);
                const doc = await oldDocRef.get();
                if (doc.exists) {
                    oldMovementData = doc.data();
                }
            }
            
            const newMovementData = {
                id: movementId,
                cantidad: Math.round(cantidadValue * 100),
                descripcion: (type === 'traspaso' && select('movimiento-descripcion').value.trim() === '') ? 'Traspaso' : select('movimiento-descripcion').value.trim(),
                tipo: type,
                fecha: parseDateStringAsUTC(select('movimiento-fecha').value).toISOString(),
                cuentaId: select('movimiento-cuenta').value,
                conceptoId: select('movimiento-concepto').value,
                cuentaOrigenId: select('movimiento-cuenta-origen').value,
                cuentaDestinoId: select('movimiento-cuenta-destino').value,
            };
            if (newMovementData.tipo === 'traspaso') { newMovementData.cantidad = Math.abs(newMovementData.cantidad); }

            const isRecurrent = select('movimiento-recurrente').checked;
            
            // --- INICIO DE LA NUEVA LÓGICA DE INVERSIÓN ---
            const batch = fbDb.batch();
            const movRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(newMovementData.id);
            batch.set(movRef, newMovementData);
            
            // Comprobamos si las cuentas implicadas son de inversión
            const cuentaDestino = db.cuentas.find(c => c.id === newMovementData.cuentaDestinoId);
            const cuentaOrigen = db.cuentas.find(c => c.id === newMovementData.cuentaOrigenId);
            const cuentaMovimiento = db.cuentas.find(c => c.id === newMovementData.cuentaId);

            // CASO 1: Ingreso o Traspaso HACIA una cuenta de inversión = APORTACIÓN
            if ((newMovementData.tipo === 'traspaso' && cuentaDestino && cuentaDestino.esInversion) || (newMovementData.tipo === 'movimiento' && newMovementData.cantidad > 0 && cuentaMovimiento && cuentaMovimiento.esInversion)) {
                const newCashflowId = generateId();
                const cashflowRef = fbDb.collection('users').doc(currentUser.uid).collection('inversion_cashflows').doc(newCashflowId);
                batch.set(cashflowRef, {
                    id: newCashflowId,
                    cuentaId: newMovementData.tipo === 'traspaso' ? newMovementData.cuentaDestinoId : newMovementData.cuentaId,
                    cantidad: newMovementData.cantidad, // Siempre positivo
                    fecha: newMovementData.fecha,
                    notas: 'Aportación automática',
                    sourceMovementId: newMovementData.id // Vinculamos el cashflow al movimiento original
                });
            }

            // CASO 2: Gasto o Traspaso DESDE una cuenta de inversión = RETIRO
            if ((newMovementData.tipo === 'traspaso' && cuentaOrigen && cuentaOrigen.esInversion) || (newMovementData.tipo === 'movimiento' && newMovementData.cantidad < 0 && cuentaMovimiento && cuentaMovimiento.esInversion)) {
                const newCashflowId = generateId();
                const cashflowRef = fbDb.collection('users').doc(currentUser.uid).collection('inversion_cashflows').doc(newCashflowId);
                batch.set(cashflowRef, {
                    id: newCashflowId,
                    cuentaId: newMovementData.tipo === 'traspaso' ? newMovementData.cuentaOrigenId : newMovementData.cuentaId,
                    cantidad: newMovementData.cantidad, // Aquí la cantidad ya es negativa
                    fecha: newMovementData.fecha,
                    notas: 'Retiro automático',
                    sourceMovementId: newMovementData.id
                });
            }
            // --- FIN DE LA NUEVA LÓGICA DE INVERSIÓN ---

            if (isRecurrent) {
                const recurrentData = { ...newMovementData, frequency: select('recurrent-frequency').value, nextDate: select('recurrent-next-date').value, endDate: select('recurrent-end-date').value || null };
                await saveDoc('recurrentes', movementId, recurrentData);
            } else {
                let balanceUpdates = [];
                if (oldMovementData) { 
                    if (oldMovementData.tipo === 'traspaso') {
                        balanceUpdates.push({ cuentaId: oldMovementData.cuentaOrigenId, amount: oldMovementData.cantidad }); 
                        balanceUpdates.push({ cuentaId: oldMovementData.cuentaDestinoId, amount: -oldMovementData.cantidad });
                    } else {
                        balanceUpdates.push({ cuentaId: oldMovementData.cuentaId, amount: -oldMovementData.cantidad });
                    }
                }
                
                if (newMovementData.tipo === 'traspaso') {
                    balanceUpdates.push({ cuentaId: newMovementData.cuentaOrigenId, amount: -newMovementData.cantidad });
                    balanceUpdates.push({ cuentaId: newMovementData.cuentaDestinoId, amount: newMovementData.cantidad });
                } else {
                    balanceUpdates.push({ cuentaId: newMovementData.cuentaId, amount: newMovementData.cantidad });
                }
                
                const finalUpdates = balanceUpdates.reduce((acc, up) => {
                    if (up.cuentaId) { acc[up.cuentaId] = (acc[up.cuentaId] || 0) + up.amount; }
                    return acc;
                }, {});

                const updatePromises = Object.entries(finalUpdates).map(([cuentaId, amount]) => updateAccountBalance(cuentaId, amount));
                
                await Promise.all([
                    batch.commit(), // Guardamos el movimiento y el cashflow a la vez
                    ...updatePromises
                ]);
            }
            
            if (mode.includes('new') && !isRecurrent) {
                newMovementIdToHighlight = movementId;
            }
            
            setButtonLoading(btn, false);
			hideModal('movimiento-modal');
			hapticFeedback('success');
			showToast(mode === 'new' ? 'Movimiento guardado.' : 'Movimiento actualizado.');
			buildIntelligentIndex();
        };
        // =================================================================================
        // FIN: VERSIÓN CORREGIDA DE handleSaveMovement
        // =================================================================================

        const handleAddConcept = async (btn) => { 
            const nombre = toSentenceCase((select('new-concepto-nombre')).value.trim());
            if (!nombre) { showToast('El nombre es obligatorio.', 'warning'); return; } 
            const newId = generateId();
            await saveDoc('conceptos', newId, { id: newId, nombre, icon: 'label' }, btn);
            hapticFeedback('success'); 
            showToast('Concepto añadido.');
            (select('add-concepto-form')).reset(); 
        };
        const handleAddAccount = async (btn) => { 
            const nombre = (select('new-cuenta-nombre')).value.trim(); 
            const tipo = toSentenceCase((select('new-cuenta-tipo')).value.trim()); 
            if (!nombre || !tipo) { showToast('El nombre y el tipo son obligatorios.', 'warning'); return; } 
            const newId = generateId();
            await saveDoc('cuentas', newId, { id: newId, nombre, tipo, saldo: 0, esInversion: false, offBalance: isOffBalanceMode, fechaCreacion: new Date().toISOString() }, btn);
            hapticFeedback('success'); 
            showToast('Cuenta añadida.');
            (select('add-cuenta-form')).reset(); 
            if (onboardingState.isActive && onboardingSteps[onboardingState.currentStep].waitForAction === 'account-created') {
                advanceOnboarding();
            }
        };
        const handleSaveConfig = async (btn) => { 
            setButtonLoading(btn, true);
            const newConfig = { skipIntro: select('config-skip-intro').checked, dashboardWidgets: (db.config && db.config.dashboardWidgets) || DEFAULT_DASHBOARD_WIDGETS };
            await fbDb.collection('users').doc(currentUser.uid).set({ config: newConfig }, { merge: true });
            localStorage.setItem('skipIntro', String(newConfig.skipIntro));
            setButtonLoading(btn, false);
            hapticFeedback('success'); showToast('Configuración guardada.'); 
        };

                 const handleExportData = async (btn) => {
            if (!currentUser) { showToast("No hay usuario autenticado.", "danger"); return; }
            setButtonLoading(btn, true, 'Exportando...');
            try {
                const dataPayload = {};
                const collections = ['cuentas', 'conceptos', 'movimientos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];
                
                for (const collectionName of collections) {
                    const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).get();
                    dataPayload[collectionName] = snapshot.docs.map(doc => doc.data());
                }
                dataPayload.config = db.config;

                const exportObject = {
                    meta: {
                        appName: "Cuentas aiDANaI",
                        version: "2.0.0",
                        exportDate: new Date().toISOString()
                    },
                    data: dataPayload
                };
                
                const jsonString = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cuentas_aidanai_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("Exportación JSON completada.", "info");
            } catch (error) {
                console.error("Error al exportar datos:", error);
                showToast("Error durante la exportación.", "danger");
            } finally {
                setButtonLoading(btn, false);
            }
        };
		const formatDateForCsv = (isoDateString) => {
            if (!isoDateString) return '';
            const date = new Date(isoDateString);
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        };

        const handleExportCsv = async (btn) => {
            if (!currentUser) { showToast("No hay usuario autenticado.", "danger"); return; }
            setButtonLoading(btn, true, 'Exportando...');
            
            try {
                const allMovements = await fetchAllMovementsForSearch();
                const allCuentas = db.cuentas;
                const allConceptos = db.conceptos;

                const cuentasMap = new Map(allCuentas.map(c => [c.id, c]));
                const conceptosMap = new Map(allConceptos.map(c => [c.id, c]));

                let csvRows = [];
                const csvHeader = ['FECHA', 'CUENTA', 'CONCEPTO', 'IMPORTE', 'DESCRIPCIÓN'];
                csvRows.push(csvHeader.join(';'));
                
                for (const cuenta of allCuentas) {
                    const movementsOfAccount = allMovements.filter(m => {
                        return (m.tipo === 'movimiento' && m.cuentaId === cuenta.id) ||
                               (m.tipo === 'traspaso' && m.cuentaOrigenId === cuenta.id) ||
                               (m.tipo === 'traspaso' && m.cuentaDestinoId === cuenta.id);
                    });

                    const balanceChange = movementsOfAccount.reduce((sum, m) => {
                        if (m.tipo === 'movimiento') return sum + m.cantidad;
                        if (m.tipo === 'traspaso' && m.cuentaOrigenId === cuenta.id) return sum - m.cantidad;
                        if (m.tipo === 'traspaso' && m.cuentaDestinoId === cuenta.id) return sum + m.cantidad;
                        return sum;
                    }, 0);
                    
                    const initialBalance = (cuenta.saldo || 0) - balanceChange;
                    
                    if (initialBalance !== 0) {
                        const cuentaNombre = `${cuenta.offBalance ? 'N-' : ''}${cuenta.nombre}`;
                        const importeStr = (initialBalance / 100).toLocaleString('es-ES', { useGrouping: false, minimumFractionDigits: 2 });
                        const fechaCreacion = cuenta.fechaCreacion ? formatDateForCsv(cuenta.fechaCreacion) : '01/01/2025';

                        csvRows.push([fechaCreacion, `"${cuentaNombre}"`, 'INICIAL', importeStr, '"Saldo Inicial"'].join(';'));
                    }
                }
                
                const sortedMovements = allMovements.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

                for (const mov of sortedMovements) {
                    const fecha = formatDateForCsv(mov.fecha);
                    const descripcion = `"${mov.descripcion.replace(/"/g, '""')}"`;
                    const importeStr = (mov.cantidad / 100).toLocaleString('es-ES', { useGrouping: false, minimumFractionDigits: 2 });

                    if (mov.tipo === 'traspaso') {
                        const cuentaOrigen = cuentasMap.get(mov.cuentaOrigenId);
                        const cuentaDestino = cuentasMap.get(mov.cuentaDestinoId);
                        
                        if (cuentaOrigen && cuentaDestino) {
                            const nombreOrigen = `${cuentaOrigen.offBalance ? 'N-' : ''}${cuentaOrigen.nombre}`;
                            const nombreDestino = `${cuentaDestino.offBalance ? 'N-' : ''}${cuentaDestino.nombre}`;
                            const importeNegativo = (-mov.cantidad / 100).toLocaleString('es-ES', { useGrouping: false, minimumFractionDigits: 2 });
                            
                            csvRows.push([fecha, `"${nombreOrigen}"`, 'TRASPASO', importeNegativo, descripcion].join(';'));
                            csvRows.push([fecha, `"${nombreDestino}"`, 'TRASPASO', importeStr, descripcion].join(';'));
                        }
                    } else {
                        const cuenta = cuentasMap.get(mov.cuentaId);
                        const concepto = conceptosMap.get(mov.conceptoId);

                        if (cuenta && concepto && concepto.nombre !== 'Saldo Inicial') {
                            const nombreCuenta = `${cuenta.offBalance ? 'N-' : ''}${cuenta.nombre}`;
                            csvRows.push([fecha, `"${nombreCuenta}"`, `"${concepto.nombre}"`, importeStr, descripcion].join(';'));
                        }
                    }
                }

                const csvString = csvRows.join('\r\n');
                const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cuentas_aidanai_export_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("Exportación CSV completada.", "info");
                
            } catch (error) {
                console.error("Error al exportar datos a CSV:", error);
                showToast("Error durante la exportación a CSV.", "danger");
            } finally {
                setButtonLoading(btn, false);
            }
        };
        const csv_parseDate = (dateString) => {
            if (!dateString) return null;
            const parts = dateString.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            if (isNaN(day) || isNaN(month) || isNaN(year) || year < 1970) return null;
            return new Date(Date.UTC(year, month, day, 12, 0, 0));
        };

        const csv_parseCurrency = (currencyString) => {
            if (typeof currencyString !== 'string' || !currencyString) return 0;
            const number = parseFloat(
                currencyString
                .replace('€', '')
                .trim()
                .replace(/\./g, '')
                .replace(',', '.')
            );
            return isNaN(number) ? 0 : Math.round(number * 100);
        };

        const csv_inferType = (name) => {
            const upperName = name.toUpperCase();
            if (upperName.includes('TARJETA')) return { tipo: 'Tarjeta', esInversion: false };
            if (upperName.includes('EFECTIVO')) return { tipo: 'Efectivo', esInversion: false };
            if (upperName.includes('PENSIÓN')) return { tipo: 'Pensión', esInversion: true };
            if (upperName.includes('LETRAS')) return { tipo: 'Renta Fija', esInversion: true };
            if (['FONDO', 'FONDOS'].some(t => upperName.includes(t))) return { tipo: 'Fondos', esInversion: true };
            if (['TRADEREPUBLIC', 'MYINVESTOR', 'DEGIRO', 'INTERACTIVEBROKERS', 'INDEXACAPITAL', 'COINBASE', 'CRIPTAN', 'KRAKEN', 'BIT2ME', 'N26', 'FREEDOM24', 'DEBLOCK', 'BBVA', 'CIVISLEND', 'HOUSERS', 'URBANITAE', 'MINTOS', 'HAUSERA'].some(b => upperName.includes(b))) return { tipo: 'Broker', esInversion: true };
            if (upperName.includes('NARANJA') || upperName.includes('AHORRO')) return { tipo: 'Ahorro', esInversion: false };
            return { tipo: 'Banco', esInversion: false };
        };

        const csv_processFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csvData = event.target.result.replace(/^\uFEFF/, '');
                        const lines = csvData.split(/\r?\n/).filter(line => line.trim() !== '' && line.includes(';'));
                        if (lines.length <= 1) {
                            showToast("El archivo CSV está vacío o solo contiene la cabecera.", "warning");
                            return resolve(null);
                        }
                        
                        lines.shift();

                        let rowCount = 0, initialCount = 0;
                        const cuentasMap = new Map();
                        const conceptosMap = new Map();
                        const movimientos = [];
                        const potentialTransfers = [];
                        
                        for (const line of lines) {
                            rowCount++;
                            const columns = line.split(';').map(c => c.trim().replace(/"/g, ''));
                            const [fechaStr, cuentaStr, conceptoStr, importeStr, descripcion = ''] = columns;

                            if (!fechaStr || !cuentaStr || !conceptoStr || !importeStr) {
                                console.warn(`Línea inválida o incompleta #${rowCount + 1}. Saltando...`, line);
                                continue;
                            }
                            
                            const fecha = csv_parseDate(fechaStr);
                            if (!fecha) {
                                 console.warn(`Fecha inválida en la fila ${rowCount + 1}: ${fechaStr}`);
                                 continue;
                            }

                            const conceptoLimpio = conceptoStr.trim().toUpperCase().replace(/\s*;-$/, '');
                            const offBalance = cuentaStr.startsWith('N-');
                            const nombreCuentaLimpio = cuentaStr.replace(/^(D-|N-)/, '');
                            const cantidad = csv_parseCurrency(importeStr);

                            if (!cuentasMap.has(nombreCuentaLimpio)) {
                                const { tipo, esInversion } = csv_inferType(nombreCuentaLimpio);
                                cuentasMap.set(nombreCuentaLimpio, { id: generateId(), nombre: nombreCuentaLimpio, tipo, saldo: 0, esInversion, offBalance, fechaCreacion: new Date(Date.UTC(2025, 0, 1)).toISOString() });
                            }

                            if (conceptoLimpio === 'INICIAL') {
                                initialCount++;
                                if (!conceptosMap.has('SALDO INICIAL')) conceptosMap.set('SALDO INICIAL', { id: generateId(), nombre: 'Saldo Inicial', icon: 'account_balance' });
                                const conceptoInicial = conceptosMap.get('SALDO INICIAL');
                                movimientos.push({ id: generateId(), fecha: fecha.toISOString(), cantidad, descripcion: descripcion || 'Existencia Inicial', tipo: 'movimiento', cuentaId: cuentasMap.get(nombreCuentaLimpio).id, conceptoId: conceptoInicial ? conceptoInicial.id : null });
                                continue;
                            }

                            if (conceptoLimpio && conceptoLimpio !== 'TRASPASO' && !conceptosMap.has(conceptoLimpio)) {
                                conceptosMap.set(conceptoLimpio, { id: generateId(), nombre: toSentenceCase(conceptoLimpio), icon: 'label' });
                            }
                            
                            if (conceptoLimpio === 'TRASPASO') {
                                potentialTransfers.push({ fecha, nombreCuenta: nombreCuentaLimpio, cantidad, descripcion, originalRow: rowCount });
                            } else {
                                const conceptoActual = conceptosMap.get(conceptoLimpio);
                                movimientos.push({ id: generateId(), fecha: fecha.toISOString(), cantidad, descripcion, tipo: 'movimiento', cuentaId: cuentasMap.get(nombreCuentaLimpio).id, conceptoId: conceptoActual ? conceptoActual.id : null });
                            }
                        }

                        let matchedTransfersCount = 0;
                        let unmatchedTransfers = [];
                        const transferGroups = new Map();
                        potentialTransfers.forEach(t => {
                            const key = `${t.fecha.getTime()}_${Math.abs(t.cantidad)}`;
                            if (!transferGroups.has(key)) transferGroups.set(key, []);
                            transferGroups.get(key).push(t);
                        });

                        transferGroups.forEach((group) => {
                            const gastos = group.filter(t => t.cantidad < 0);
                            const ingresos = group.filter(t => t.cantidad > 0);
                            while (gastos.length > 0 && ingresos.length > 0) {
                                const Gasto = gastos.pop();
                                const Ingreso = ingresos.pop();
                                movimientos.push({ id: generateId(), fecha: Gasto.fecha.toISOString(), cantidad: Math.abs(Gasto.cantidad), descripcion: Gasto.descripcion || Ingreso.descripcion || 'Traspaso', tipo: 'traspaso', cuentaOrigenId: cuentasMap.get(Gasto.nombreCuenta).id, cuentaDestinoId: cuentasMap.get(Ingreso.nombreCuenta).id });
                                matchedTransfersCount++;
                            }
                            unmatchedTransfers.push(...gastos, ...ingresos);
                        });
                        
                        const conceptoInicialId = conceptosMap.has('SALDO INICIAL') ? conceptosMap.get('SALDO INICIAL').id : null;
                        const finalData = { cuentas: Array.from(cuentasMap.values()), conceptos: Array.from(conceptosMap.values()), movimientos, presupuestos: [], recurrentes: [], inversiones_historial: [], inversion_cashflows: [], config: getInitialDb().config };
                        const totalMovements = movimientos.filter(m => m.tipo === 'movimiento' && m.conceptoId !== conceptoInicialId).length;

                        resolve({
                            jsonData: finalData,
                            stats: { rowCount, accounts: cuentasMap.size, concepts: conceptosMap.size, movements: totalMovements, transfers: matchedTransfersCount, initials: initialCount, unmatched: unmatchedTransfers.length }
                        });

                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error("No se pudo leer el archivo."));
                reader.readAsText(file, 'ISO-8859-1');
            });
        };

        const showCsvImportWizard = () => {
            const wizardHTML = `
            <div id="csv-wizard-content">
                <div id="csv-wizard-step-1" class="json-wizard-step">
                    <h4>Paso 1: Selecciona tu archivo CSV</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);">
                        Columnas requeridas: <code>FECHA;CUENTA;CONCEPTO;IMPORTE;DESCRIPCIÓN</code>.
                        <br><strong>Atención:</strong> La importación reemplazará <strong>todos</strong> tus datos actuales.
                    </p>
                    <div id="csv-drop-zone" class="upload-area">
                        <p>Arrastra tu archivo <code>.csv</code> aquí o <strong>haz clic para seleccionarlo</strong>.</p>
                        <span id="csv-file-name" class="file-name" style="color: var(--c-success); font-weight: 600; margin-top: 1rem; display: block;"></span>
                    </div>
                    <div id="csv-file-error" class="form-error" style="text-align: center; margin-top: var(--sp-3);"></div>
                    <div class="modal__actions">
                        <button id="csv-process-btn" class="btn btn--primary btn--full" disabled>Analizar Archivo</button>
                    </div>
                </div>

                <div id="csv-wizard-step-2" class="json-wizard-step" style="display: none;">
                    <h4>Paso 2: Revisa y confirma</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);">Hemos analizado tu archivo. Si los datos son correctos, pulsa "Importar" para reemplazar tus datos actuales.</p>
                    <div class="results-log" style="display: block; margin-top: 0;">
                        <h2>Resultados del Análisis</h2>
                        <ul id="csv-preview-list"></ul>
                    </div>
                    <div class="form-error" style="margin-top: var(--sp-2); text-align: center;"><strong>Atención:</strong> Esta acción es irreversible.</div>
                    <div class="modal__actions" style="justify-content: space-between;">
                        <button id="csv-wizard-back-btn" class="btn btn--secondary">Atrás</button>
                        <button id="csv-wizard-import-final" class="btn btn--danger"><span class="material-icons">warning</span>Importar y Reemplazar</button>
                    </div>
                </div>

                <div id="csv-wizard-step-3" class="json-wizard-step" style="display: none; justify-content: center; align-items: center; text-align: center; min-height: 250px;">
                    <div id="csv-import-progress">
                        <span class="spinner" style="width: 48px; height: 48px; border-width: 4px;"></span>
                        <h4 style="margin-top: var(--sp-4);">Importando...</h4>
                        <p>Borrando datos antiguos e importando los nuevos. Por favor, no cierres esta ventana.</p>
                    </div>
                     <div id="csv-import-result" style="display: none;">
                        <span class="material-icons" style="font-size: 60px; color: var(--c-success);">task_alt</span>
                        <h4 id="csv-result-title" style="margin-top: var(--sp-2);"></h4>
                        <p id="csv-result-message"></p>
                        <div class="modal__actions" style="justify: center;">
                            <button class="btn btn--primary" data-action="close-modal" data-modal-id="generic-modal">Finalizar</button>
                        </div>
                     </div>
                </div>
            </div>`;

            showGenericModal('Asistente de Importación CSV', wizardHTML);

            setTimeout(() => {
                let csvFile = null;
                let processedData = null;
                const wizardContent = select('csv-wizard-content');
                if (!wizardContent) return;

                const goToStep = (step) => {
                    wizardContent.querySelectorAll('.json-wizard-step').forEach(s => s.style.display = 'none');
                    wizardContent.querySelector(`#csv-wizard-step-${step}`).style.display = 'flex';
                };

                const fileInput = document.createElement('input');
                fileInput.type = 'file'; fileInput.accept = '.csv, text/csv'; fileInput.className = 'hidden';
                wizardContent.appendChild(fileInput);

                const handleFileSelection = (files) => {
                    const file = files[0];
                    const nameEl = select('csv-file-name'), processBtn = select('csv-process-btn'), errorEl = select('csv-file-error');
                    if (file && (file.type === 'text/csv' || file.name.endsWith('.csv'))) {
                        csvFile = file;
                        nameEl.textContent = `Archivo: ${file.name}`;
                        processBtn.disabled = false;
                        errorEl.textContent = '';
                    } else {
                        csvFile = null;
                        nameEl.textContent = 'Por favor, selecciona un archivo .csv válido.';
                        processBtn.disabled = true;
                    }
                };
                
                const dropZone = select('csv-drop-zone');
                dropZone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', () => handleFileSelection(fileInput.files));
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
                dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFileSelection(e.dataTransfer.files); });

                select('csv-process-btn').addEventListener('click', async (e) => {
                    if (!csvFile) return;
                    const btn = e.target;
                    setButtonLoading(btn, true, 'Analizando...');
                    try {
                        const result = await csv_processFile(csvFile);
                        if (result) {
                            processedData = result.jsonData;
                            const { stats } = result;
                            const previewList = select('csv-preview-list');
                            let html = `
                                <li><span class="label">Filas Válidas Leídas</span><span class="value">${stats.rowCount}</span></li>
                                <li><span class="label">Cuentas a Crear</span><span class="value success">${stats.accounts}</span></li>
                                <li><span class="label">Conceptos a Crear</span><span class="value success">${stats.concepts}</span></li>
                                <li><span class="label">Saldos Iniciales</span><span class="value">${stats.initials}</span></li>
                                <li><span class="label">Movimientos (Ingreso/Gasto)</span><span class="value">${stats.movements}</span></li>
                                <li><span class="label">Transferencias Emparejadas</span><span class="value">${stats.transfers}</span></li>
                                <li><span class="label">Transferencias sin Pareja</span><span class="value ${stats.unmatched > 0 ? 'danger' : 'success'}">${stats.unmatched}</span></li>
                            `;
                            previewList.innerHTML = html;
                            goToStep(2);
                        }
                    } catch (error) {
                        console.error("Error al procesar CSV:", error);
                        select('csv-file-error').textContent = `Error: ${error.message}`;
                    } finally {
                        setButtonLoading(btn, false);
                    }
                });

                select('csv-wizard-back-btn').addEventListener('click', () => goToStep(1));
                select('csv-wizard-import-final').addEventListener('click', (e) => {
                    if (processedData) handleFinalCsvImport(e.target, processedData, goToStep);
                });
            }, 0);
        };

        const handleFinalCsvImport = async (btn, dataToImport, goToStep) => {
            goToStep(3);
            setButtonLoading(btn, true, 'Importando...');

            try {
                const collectionsToClear = ['cuentas', 'conceptos', 'movimientos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];

                for (const collectionName of collectionsToClear) {
                    const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).get();
                    if (snapshot.empty) continue;
                    let batch = fbDb.batch();
                    let count = 0;
                    for (const doc of snapshot.docs) {
                        batch.delete(doc.ref);
                        count++;
                        if (count >= 450) { await batch.commit(); batch = fbDb.batch(); count = 0; }
                    }
                    if (count > 0) await batch.commit();
                }
                
                for (const collectionName of Object.keys(dataToImport)) {
                    const items = dataToImport[collectionName];
                    if (Array.isArray(items) && items.length > 0) {
                        let batch = fbDb.batch();
                        let count = 0;
                        for (const item of items) {
                            if (item.id) {
                                const docRef = fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(item.id);
                                batch.set(docRef, item);
                                count++;
                                if (count >= 450) { await batch.commit(); batch = fbDb.batch(); count = 0; }
                            }
                        }
                        if (count > 0) await batch.commit();
                    } else if (collectionName === 'config') {
                        await fbDb.collection('users').doc(currentUser.uid).set({ config: items }, { merge: true });
                    }
                }
                
                const resultEl = select('csv-import-result');
                select('csv-import-progress').style.display = 'none';
                if(resultEl) {
                    resultEl.style.display = 'block';
                    resultEl.querySelector('#csv-result-title').textContent = '¡Importación Completada!';
                    resultEl.querySelector('#csv-result-message').textContent = 'Los datos se han importado correctamente. La aplicación se recargará.';
                }
                
                hapticFeedback('success');
                showToast('¡Importación completada!', 'info', 4000);
                setTimeout(() => location.reload(), 4500);

            } catch (error) {
                console.error("Error en importación final desde CSV:", error);
                showToast("Error crítico durante la importación.", "danger", 5000);
                const resultEl = select('csv-import-result');
                select('csv-import-progress').style.display = 'none';
                if(resultEl) {
                    resultEl.style.display = 'block';
                    resultEl.querySelector('#csv-result-title').textContent = '¡Error en la Importación!';
                    resultEl.querySelector('#csv-result-message').textContent = 'Ocurrió un error. Revisa la consola e inténtalo de nuevo.';
                    const iconEl = resultEl.querySelector('.material-icons');
                    if (iconEl) iconEl.style.color = 'var(--c-danger)';
                }
                setButtonLoading(btn, false);
            }
        };

        const recalculateAllAccountBalances = async (btn) => {
            if (!currentUser) {
                showToast("Debes iniciar sesión para realizar esta acción.", "danger");
                return;
            }

            setButtonLoading(btn, true, 'Auditando...');
            showToast("Iniciando recálculo de saldos... Esto puede tardar un momento.", 'info', 4000);

            try {
                const userRef = fbDb.collection('users').doc(currentUser.uid);
                const cuentasRef = userRef.collection('cuentas');
                const movimientosRef = userRef.collection('movimientos');

                const cuentasSnapshot = await cuentasRef.get();
                const newBalances = {};
                cuentasSnapshot.forEach(doc => {
                    newBalances[doc.id] = 0;
                });

                const movimientosSnapshot = await movimientosRef.get();
                console.log(`Procesando ${movimientosSnapshot.size} movimientos para el recálculo.`);

                movimientosSnapshot.forEach(doc => {
                    const mov = doc.data();
                    if (mov.tipo === 'traspaso') {
                        if (newBalances.hasOwnProperty(mov.cuentaOrigenId)) {
                            newBalances[mov.cuentaOrigenId] -= mov.cantidad;
                        }
                        if (newBalances.hasOwnProperty(mov.cuentaDestinoId)) {
                            newBalances[mov.cuentaDestinoId] += mov.cantidad;
                        }
                    } else { // tipo 'movimiento'
                        if (newBalances.hasOwnProperty(mov.cuentaId)) {
                            newBalances[mov.cuentaId] += mov.cantidad;
                        }
                    }
                });

                const batch = fbDb.batch();
                for (const cuentaId in newBalances) {
                    const cuentaRef = cuentasRef.doc(cuentaId);
                    batch.update(cuentaRef, { saldo: newBalances[cuentaId] });
                }
                
                await batch.commit();

                hapticFeedback('success');
                showToast("¡Auditoría completada! Todos los saldos han sido recalculados y actualizados.", "info", 5000);
                
                loadCoreData(currentUser.uid);

            } catch (error) {
                console.error("Error crítico durante el recálculo de saldos:", error);
                showToast("Ocurrió un error grave durante el recálculo. Revisa la consola.", "danger");
            } finally {
                setButtonLoading(btn, false);
            }
        };    

        const handleSaveInvestmentAccounts = async (form, btn) => {
            setButtonLoading(btn, true);
            const selectedIds = new Set(Array.from(form.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value));
            const batch = fbDb.batch();
            db.cuentas.forEach(c => {
                const ref = fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(c.id);
                batch.update(ref, { esInversion: selectedIds.has(c.id) });
            });
            await batch.commit();
            setButtonLoading(btn, false);
            hideModal('generic-modal');
            hapticFeedback('success');
            showToast('Portafolio actualizado.');
        };
		const handleSaveAportacion = async (form, btn) => {
             setButtonLoading(btn, true);
            const cuentaId = select('aportacion-cuenta').value;
            const cantidad = parseCurrencyString(select('aportacion-cantidad').value);
            const fecha = select('aportacion-fecha').value;
            const notas = select('aportacion-notas').value.trim();

            if (!cuentaId || isNaN(cantidad) || !fecha) {
                showToast('Completa todos los campos requeridos.', 'warning');
                setButtonLoading(btn, false);
                return;
            }
            
            const newId = generateId();
            const newCashflow = {
                id: newId,
                cuentaId,
                cantidad: Math.round(cantidad * 100),
                fecha: parseDateStringAsUTC(fecha).toISOString(),
                notas
            };
            
            await saveDoc('inversion_cashflows', newId, newCashflow);
            setButtonLoading(btn, false);
            hideModal('generic-modal');
            hapticFeedback('success');
            showToast('Operación de capital registrada.');
            const activePageEl = document.querySelector('.view--active');
            const activePage = activePageEl ? activePageEl.id : null;
            if (activePage === PAGE_IDS.PATRIMONIO) {
                renderPatrimonioPage();
            }
            if (activePage === PAGE_IDS.ANALISIS) {
                renderAnalisisPage();
            }
        };

        async function migrateDataToSubcollections() {
            if (!currentUser) { console.error("No hay usuario logueado."); return; }
            console.log("🚀 Iniciando migración para el usuario:", currentUser.uid);
            try {
                const userDocRef = fbDb.collection('users').doc(currentUser.uid);
                const doc = await userDocRef.get();
                if (!doc.exists || !doc.data().db) { console.warn("No se encontró el campo 'db' para migrar."); return; }
                const oldDb = doc.data().db;
                console.log("Datos antiguos encontrados. Procediendo...");
                let batch = fbDb.batch();
                let operations = 0;
                const commitBatch = async () => { await batch.commit(); console.log(`Lote de ${operations} op. completado.`); batch = fbDb.batch(); operations = 0; };
                const collectionsToMigrate = ['cuentas', 'conceptos', 'movimientos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];
                for (const collectionName of collectionsToMigrate) {
                    if (oldDb[collectionName] && Array.isArray(oldDb[collectionName])) {
                        console.log(`- Migrando ${oldDb[collectionName].length} docs a '${collectionName}'...`);
                        for (const item of oldDb[collectionName]) {
                            const docRef = userDocRef.collection(collectionName).doc(item.id);
                            batch.set(docRef, item);
                            operations++;
                            if (operations >= 400) await commitBatch();
                        }
                    }
                }
                if (operations > 0) await commitBatch();
                console.log("✅ Subcolecciones creadas. Actualizando documento principal...");
                await userDocRef.set({ config: oldDb.config || getInitialDb().config }, { merge: false });
                console.log("🎉 ¡MIGRACIÓN COMPLETADA! Por favor, recarga la aplicación.");
                alert("¡Migración completada! Recarga la página.");
            } catch (error) {
                console.error("❌ ERROR DURANTE LA MIGRACIÓN:", error);
                alert("Ocurrió un error durante la migración. Revisa la consola.");
            }
        }
        window.migrateDataToSubcollections = migrateDataToSubcollections;

        document.addEventListener('DOMContentLoaded', initApp);
		
        const fetchMovementsInChunks = async (baseQuery, field, ids) => {
            if (ids.length === 0) {
                return [];
            }
            const idChunks = chunkArray(ids, 10);
            
            const queryPromises = idChunks.map(chunk => {
                return baseQuery.where(field, 'in', chunk).get();
            });

            const querySnapshots = await Promise.all(queryPromises);

            let movements = [];
            querySnapshots.forEach(snapshot => {
                snapshot.forEach(doc => {
                    movements.push({ id: doc.id, ...doc.data() });
                });
            });

            return movements;
        };

        const validateField = (id, silent = false) => {
            const input = select(id);
            if (!input) return true;

            clearError(id);
            let isValid = true;
            const value = input.value.trim();
            const traspasoPill = select('mov-type-btn-traspaso');
            const type = traspasoPill && traspasoPill.classList.contains('filter-pill--active') ? 'traspaso' : 'movimiento';

            switch (id) {
                case 'movimiento-cantidad':
                    const amount = parseCurrencyString(value);
                    if (isNaN(amount) || value === '') {
                        displayError(id, 'Cantidad no válida.'); isValid = false;
                    }
                    break;
                case 'movimiento-descripcion':
                    if (type !== 'traspaso' && value === '') {
                        displayError(id, 'La descripción es obligatoria.'); isValid = false;
                    }
                    break;
                case 'movimiento-concepto':
                    if (type === 'movimiento' && value === '') {
                        displayError(id, 'El concepto es obligatorio.'); isValid = false;
                    }
                    break;
                case 'movimiento-cuenta':
                    if (type === 'movimiento' && value === '') {
                        displayError(id, 'La cuenta es obligatoria.'); isValid = false;
                    }
                    break;
                case 'movimiento-cuenta-origen':
                case 'movimiento-cuenta-destino':
                    if (type === 'traspaso') {
                        const origen = select('movimiento-cuenta-origen').value;
                        const destino = select('movimiento-cuenta-destino').value;
                        if (value === '') {
                            displayError(id, 'La cuenta es obligatoria.');
                            isValid = false;
                        } else if (origen && destino && origen === destino) {
                            // Only set error on the specific input that caused the conflict for a clearer UX
                            if (input.id === 'movimiento-cuenta-origen') {
                                displayError(id, 'No puede ser la misma cuenta destino.');
                            } else {
                                displayError(id, 'No puede ser la misma cuenta origen.');
                            }
                            isValid = false;
                        }
                    }
                    break;
                case 'movimiento-fecha':
                    if (value === '') {
                        displayError(id, 'La fecha es obligatoria.'); isValid = false;
                    }
                    break;
                case 'new-cuenta-nombre':
                case 'new-cuenta-tipo':
                case 'edit-cuenta-nombre':
                case 'edit-cuenta-tipo':
                    if (value === '') {
                        displayError(id, 'Este campo es obligatorio.'); isValid = false;
                    }
                    break;
                case 'new-concepto-nombre':
                case 'edit-concepto-nombre':
                    if (value === '') {
                        displayError(id, 'Este campo es obligatorio.'); isValid = false;
                    }
                    break;
                 case 'valoracion-valor':
                    const valor = parseCurrencyString(value);
                    if (isNaN(valor) || valor < 0) {
                        displayError(id, 'Valor no válido. Debe ser un número positivo.'); isValid = false;
                    }
                    break;
                case 'valoracion-fecha':
                    if (value === '') {
                        displayError(id, 'La fecha es obligatoria.'); isValid = false;
                    }
                    break;
                case 'aportacion-cantidad':
                    const aportacion = parseCurrencyString(value);
                    if (isNaN(aportacion) || value === '') {
                        displayError(id, 'Cantidad no válida.'); isValid = false;
                    }
                    break;
                case 'aportacion-fecha':
                    if (value === '') {
                        displayError(id, 'La fecha es obligatoria.'); isValid = false;
                    }
                    break;
            }

            if (!isValid && !silent) hapticFeedback('light');

            return isValid;
        };

        const validateMovementForm = () => {
            let isValid = true;
            if (!validateField('movimiento-cantidad')) isValid = false;
            if (!validateField('movimiento-fecha')) isValid = false;

            const traspasoPill = select('mov-type-btn-traspaso');
            const type = traspasoPill && traspasoPill.classList.contains('filter-pill--active') ? 'traspaso' : 'movimiento';

            if (type === 'movimiento') {
                if (!validateField('movimiento-descripcion')) isValid = false;
                if (!validateField('movimiento-concepto')) isValid = false;
                if (!validateField('movimiento-cuenta')) isValid = false;
            } else {
                // Ensure both origin and destination are validated together for cross-field logic
                const origenValid = validateField('movimiento-cuenta-origen');
                const destinoValid = validateField('movimiento-cuenta-destino');
                if (!origenValid || !destinoValid) isValid = false;
            }
            return isValid;
        };

                const handleDescriptionInput = () => {
            clearTimeout(descriptionSuggestionDebounceTimer);
            descriptionSuggestionDebounceTimer = setTimeout(() => {
                const descriptionInput = select('movimiento-descripcion');
                const suggestionsBox = select('description-suggestions');
                if (!descriptionInput || !suggestionsBox) return;

                const query = descriptionInput.value.trim().toLowerCase();
                suggestionsBox.innerHTML = '';

                if (query.length < 3) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                const suggestions = [];
                for (const [desc, data] of intelligentIndex.entries()) {
                    if (desc.includes(query)) {
                        suggestions.push({
                            description: desc,
                            conceptoId: data.conceptoId,
                            cuentaId: data.cuentaId
                        });
                    }
                }

                if (suggestions.length > 0) {
                    suggestions.sort((a, b) => a.description.localeCompare(b.description));
                    let html = '';
                    suggestions.slice(0, DESCRIPTION_SUGGESTION_LIMIT).forEach(s => {
                        const concepto = db.conceptos.find(c => c.id === s.conceptoId);
                        const cuenta = db.cuentas.find(c => c.id === s.cuentaId);
                        html += `
                            <div class="suggestion-item" 
                                data-description="${escapeHTML(s.description)}" 
                                data-concepto-id="${s.conceptoId}" 
                                data-cuenta-id="${s.cuentaId}"
                                tabindex="0"
                            >
                                <p>${escapeHTML(s.description)}</p>
                                <small>${escapeHTML((concepto && concepto.nombre) || 'S/C')} • ${escapeHTML((cuenta && cuenta.nombre) || 'S/C')}</small>
                            </div>
                        `;
                    });
                    suggestionsBox.innerHTML = html;
                    suggestionsBox.style.display = 'block';
                } else {
                    suggestionsBox.style.display = 'none';
                }
            }, 300);
        };
	 
    </script>
</body>
</html>