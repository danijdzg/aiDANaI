<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Cuentas aiDANaI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Cuentas aiDANaI%22,%22short_name%22:%22aiDANaI%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#1C1B1F%22,%22theme_color%22:%22#D0BCFF%22,%22description%22:%22Gestor de finanzas personales y compartidas.%22,%22icons%22:[{%22src%22:%22data:image/svg%2bxml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg%2bxml%22},{%22src%22:%22data:image/svg%2bxml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg%2bxml%22}]}">
    <meta name="theme-color" content="#1C1B1F"/>
    <link rel="apple-touch-icon" href="aiDANaI-Cuentas.jpg">

    <style>
        :root {
            --primary-color: #6750A4; --primary-variant: #4F378B; --secondary-color: #625B71; --background: #FFFBFE; --surface: #FFFFFF; --surface-variant: #F3F0F4; --on-primary: #FFFFFF; --on-secondary: #FFFFFF; --on-background: #1C1B1F; --on-surface: #1C1B1F; --outline: #C0BFC4; --shadow: rgba(0,0,0,0.1);
            --dani-color:#4A90E2; --norma-color:#D0021B; --comun-color:#50E3C2; --común-color:#50E3C2;
            --success-color:#388E3C; --danger-color:#D32F2F; --warning-color:#FBC02D; --info-color: #1976D2;
            --font-roboto: 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        [data-theme="dark"] {
            --primary-color: #D0BCFF; --secondary-color: #CCC2DC; --background: #1C1B1F; --surface: #2B2930; --surface-variant: #49454F; --on-primary: #371E73; --on-background: #E6E1E5; --on-surface: #E6E1E5; --outline: #5F5C63;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; }
        body { font-family: var(--font-roboto); background-color: var(--background); color: var(--on-background); line-height: 1.5; overflow: hidden; min-height: 100vh; min-height: -webkit-fill-available; height: 100vh; transition: background-color 0.3s, color 0.3s; }
        *:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; border-radius: 4px; }
        
        #app-root { display: none; max-width: 500px; margin: 0 auto; height: 100vh; background: var(--background); position: relative; flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; padding-bottom: calc(65px + env(safe-area-inset-bottom)); }
        #app-root.visible { display: flex; opacity: 1; }
        .main-content { flex: 1; display: flex; position: relative; overflow: hidden; }
        .view { display: none; width: 100%; flex-direction: column; animation: fadeIn 0.3s ease-in-out; height: 100%; overflow-y: auto; padding: 16px; padding-top: 70px; padding-bottom: 80px; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .top-bar { position: absolute; top: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background-color: var(--surface); border-bottom: 1px solid var(--outline); z-index: 10; height: 60px;}
        .top-bar-title { font-size: 20px; font-weight: 500; }
        .top-bar-actions { display: flex; align-items: center; gap: 4px; }
        
        .settings-section { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 4px var(--shadow); }
        .section-title { font-size: 18px; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--primary-color); }
        .empty-state { text-align: center; padding: 32px 24px; color: var(--secondary-color); }
        .empty-state .material-icons { font-size: 48px; margin-bottom: 8px; }
        .kpi-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
        .kpi-item { background: var(--surface); border-radius: 12px; padding: 12px; text-align: center; box-shadow: 0 1px 4px var(--shadow); }
        .kpi-item h4 { font-size: 12px; font-weight: 500; color: var(--secondary-color); margin-bottom: 4px; }
        .kpi-item strong { font-size: 16px; font-weight: 700; }

        .list-item-card { display: flex; align-items: center; background: var(--surface); border-radius: 12px; margin-bottom: 4px; box-shadow: 0 1px 4px var(--shadow); transition: all 0.2s; user-select: none; position: relative; padding: 8px 12px; border-left: 5px solid transparent; }
        .list-item-card .item-content { cursor: pointer; display: flex; justify-content: space-between; align-items: center; flex-grow: 1; padding-right: 8px; gap: 8px; }
        .item-details { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        .item-title { font-weight: 500; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 11px; color: var(--secondary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-amount { font-weight: 600; font-size: 14px; text-align: right; flex-shrink: 0; }
        .item-actions { display: flex; align-items: center; flex-shrink: 0; }
        
        .owner-dani-border { border-left-color: var(--dani-color); } .owner-norma-border { border-left-color: var(--norma-color); } .owner-comun-border, .owner-común-border { border-left-color: var(--comun-color); }
        .owner-dani-text { color: var(--dani-color); } .owner-norma-text { color: var(--norma-color); } .owner-comun-text, .owner-común-text { color: var(--comun-color); }

        details.accordion-item { margin-bottom: 4px; background-color: var(--surface); border-radius: 12px; box-shadow: 0 1px 4px var(--shadow); overflow: hidden;}
        details.accordion-item summary { font-weight: 500; cursor: pointer; padding: 8px 16px; display: flex; align-items: center; justify-content: space-between; list-style: none; font-size: 16px;}
        details.accordion-item summary::-webkit-details-marker { display: none; }
        details.accordion-item summary .expand-icon { transition: transform 0.2s; color: var(--secondary-color); }
        details.accordion-item[open] summary .expand-icon { transform: rotate(180deg); }
        .accordion-content { padding: 0 16px 12px; border-top: 1px solid var(--outline); }
        .accordion-content .list-item-card { box-shadow: none; border-radius: 8px; background-color: var(--surface-variant); padding: 8px; }
        .accordion-content .list-item-card .item-content { cursor: default; }

        .budget-item { padding: 8px; }
        .budget-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .budget-info-text strong { display: block; font-size: 14px; font-weight: 500; margin-bottom: 2px; }
        .budget-info-text span { color: var(--secondary-color); font-size: 11px; }
        .budget-progress { width: 100%; height: 8px; border-radius: 4px; -webkit-appearance: none; appearance: none; overflow: hidden; background-color: rgba(120,120,128,.2); }
        .budget-progress::-webkit-progress-bar { background-color: transparent; }
        .budget-progress.progress-ok::-webkit-progress-value { background-color:var(--success-color); }
        .budget-progress.progress-warning::-webkit-progress-value { background-color:var(--warning-color); }
        .budget-progress.progress-danger::-webkit-progress-value { background-color:var(--danger-color); }

        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--secondary-color); }
        .form-input, .form-select { width: 100%; padding: 10px; border: 2px solid var(--outline); border-radius: 8px; background: var(--surface); color: var(--on-surface); font-size: 14px; -webkit-appearance: none; appearance: none; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-color); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 12px; padding-right: 30px; }
        [data-theme=dark] .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23FFF' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .form-group-with-action { display: flex; align-items: flex-end; gap: 8px; }
        .form-group-with-action .form-group { flex-grow: 1; margin-bottom: 0; }
        .error-message{ color:var(--danger-color); font-size: 12px; margin-top:4px; min-height:16px; display:block; }
        .is-invalid { border-color:var(--danger-color) !important; }

        .btn { padding: 10px 20px; border: none; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary-color); color: var(--on-primary); }
        .btn-secondary { background: var(--surface-variant); color: var(--on-surface); }
        .btn-full { width: 100%; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: black; }
        .icon-button { background: none; border: none; color: var(--secondary-color); cursor: pointer; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s; }
        .icon-button:hover { background-color: var(--surface-variant); color: var(--on-surface); }
        .fab { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); right: 24px; width: 56px; height: 56px; background: var(--primary-color); color: var(--on-primary); border: none; border-radius: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px var(--shadow); transition: all 0.2s; z-index: 50; }
        .fab:hover { transform: scale(1.1); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background: var(--surface); border-top: 1px solid var(--outline); display: flex; padding: 4px 0 calc(8px + env(safe-area-inset-bottom)) 0; z-index: 100; box-shadow: 0 -2px 8px var(--shadow); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 4px 8px; cursor: pointer; transition: color 0.2s; color: var(--secondary-color); border: none; background: none; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item .material-icons { font-size: 24px; margin-bottom: 2px; }
        .nav-label { font-size: 11px; font-weight: 500; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 200; padding: 16px; animation: modalFadeIn 0.3s; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--surface); border-radius: 24px; padding: 20px; width: 100%; max-width: 420px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px var(--shadow); }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 500; }
        .modal-body { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
        .modal-list-item { display:flex; justify-content:space-between; align-items:center; padding:8px 4px; border-bottom:1px solid var(--surface-variant); }
        .modal-list-item:last-child { border-bottom: none; }
        .modal-list-item .item-details { flex-grow: 1; }
        #help-modal-content h3 { margin-top: 1em; margin-bottom: 0.5em; color: var(--primary-color); }
        #help-modal-content hr { margin: 16px 0; border: 0; border-top: 1px solid var(--outline); }
        #help-modal-content code { background-color: var(--surface-variant); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        #help-modal-content pre { background-color: var(--surface-variant); padding: 12px; border-radius: 8px; white-space: pre-wrap; word-break: break-all; margin-top: 8px; }

        .text-positive{color:var(--success-color)} .text-negative{color:var(--danger-color)} .text-warning{color:var(--warning-color)} .text-info{color:var(--info-color)}
        .hidden{display:none!important}
        .btn-loading { pointer-events:none; opacity:.8; }
        .btn-text { margin-right: 8px; }
        .spinner { display: inline-block; width: 1em; height: 1em; border: .15em solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin .8s linear infinite; vertical-align: middle; }
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .filter-pill { background-color: var(--surface-variant); border: 1px solid var(--outline); color: var(--on-surface); padding: 6px 14px; font-size: 13px; border-radius: 20px; cursor: pointer; transition: all .2s; }
        .filter-pill.active { background-color: var(--primary-color); color: var(--on-primary); border-color: var(--primary-color); font-weight: 500; }

        .intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; background: #000; transition: opacity 0.5s ease-out; }
        #splashScreen #splashImage { width: 250px; height: auto; opacity: 0; animation: growAndFade 2.5s ease-in-out forwards; border-radius: 24px;}
        @keyframes growAndFade { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
        #quoteScreen { text-align: center; color: #FFF; padding: 20px; opacity: 0; transition: opacity 1.5s; }
        #quoteScreen.visible { opacity: 1; }
        #quoteText { font-size: 22px; font-style: italic; font-weight: 300; max-width: 600px; }
        #quoteAuthor { display: block; font-size: 16px; margin-top: 12px; font-weight: 500; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 16px; opacity: 0; transition: opacity .5s; background-color: var(--background); }
        #login-screen.visible { display: flex; opacity: 1; }
        .login-card { background-color: var(--surface); padding: 24px; border-radius: 24px; box-shadow: 0 8px 32px var(--shadow); width: 100%; max-width: 360px; text-align: center; }
        .login-card h2 { font-size: 22px; margin-bottom: 20px; }

        #toast-container { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 2000; width: max-content; max-width: 90%; pointer-events: none; }
        .toast { background-color: rgba(40, 40, 40, 0.95); backdrop-filter: blur(5px); color: white; padding: 10px 16px; border-radius: 8px; margin-bottom: 6px; box-shadow: 0 2px 6px var(--shadow); display: flex; align-items: center; animation: toastFadeIn 0.3s, toastFadeOut 0.3s 2.7s; font-size: 14px; }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }

        .movements-modal .modal-body { padding-top: 0; }
        .movements-modal .list-item-card { margin-bottom: 4px; }
        .movements-modal .item-meta { font-size: 10px; }
        .movements-modal .item-amount { font-size: 13px; }
        .movements-modal .item-title { font-size: 14px; font-weight: 500; }
    
        /* --- ESTILOS PARA COMPACTAR EL FORMULARIO DE MOVIMIENTOS --- */
        #movimiento-modal .modal {
            padding: 16px;
            padding-top: 12px;
        }
        #movimiento-modal .modal-header {
            margin-bottom: 12px; /* Reducido de 16px */
        }
        #movimiento-modal .modal-body {
            padding-right: 4px; /* Pequeño ajuste para la barra de scroll si aparece */
        }
        #movimiento-modal .form-group {
            margin-bottom: 8px; /* El cambio más importante, reducido de 12px */
        }
        #movimiento-modal .form-label {
            margin-bottom: 4px; /* Reducido de 6px */
            font-size: 12px;   /* Etiqueta un poco más pequeña */
        }
        #movimiento-modal .form-input, 
        #movimiento-modal .form-select {
            padding: 8px 10px; /* Reduce la altura del campo, de 10px a 8px vertical */
            font-size: 14px;
        }
        #movimiento-modal .form-grid {
            gap: 10px; /* Un poco menos de espacio entre columnas */
        }
        #movimiento-modal .modal-actions {
            margin-top: 16px; /* Reducido de 20px */
            padding-top: 8px;
        }
        #movimiento-modal .error-message {
            margin-top: 2px; /* Menos espacio sobre el mensaje de error */
            min-height: 14px; /* Menos altura reservada */
        }
        /* --- FIN DE ESTILOS DE COMPACTACIÓN --- */

</style>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div id="splashScreen" class="intro-screen"><img id="splashImage" src="aiDANaI-Cuentas.jpg" alt="Logo aiDANaI"></div>
<div id="quoteScreen" class="intro-screen" style="display:none;"><p id="quoteText"></p><span id="quoteAuthor"></span></div>

<div id="login-screen">
    <div class="login-card">
        <h2 id="login-title">💰 Cuentas aiDANaI</h2>
        <form id="login-form" novalidate>
            <div class="form-group"><input type="email" id="login-email" class="form-input" placeholder="Correo electrónico" required autocomplete="email" autocapitalize="none"><span class="error-message" id="login-email-error"></span></div>
            <div class="form-group"><input type="password" id="login-password" class="form-input" placeholder="Contraseña" required autocomplete="current-password"><span class="error-message" id="login-password-error"></span></div>
            <div class="form-grid" style="margin-top: 20px;"><button type="button" id="login-btn" class="btn btn-primary">Iniciar Sesión</button><button type="button" id="register-btn" class="btn btn-secondary">Registrarse</button></div>
            <p id="login-error" class="error-message" style="min-height: 20px; margin-top: 10px;"></p>
        </form>
    </div>
</div>

<div id="app-root">
    <main class="main-content">
        <div id="panel-control-page" class="view">
            <div class="top-bar">
                <h1 class="top-bar-title">Panel de Control</h1>
                <div class="top-bar-actions">
                    <button id="ai-advice-btn" class="icon-button" title="Asesor IA"><span class="material-icons">psychology_alt</span></button>
                    <button id="help-btn" class="icon-button" title="Ayuda"><span class="material-icons">lightbulb</span></button>
                    <button id="theme-toggle-panel" class="icon-button" title="Cambiar Tema"><span class="material-icons">light_mode</span></button>
                    <button id="logout-btn-panel" class="icon-button" title="Cerrar Sesión"><span class="material-icons">logout</span></button>
                </div>
            </div>
            
            <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">filter_list</span>Filtros</h3>
                <div class="form-group"><label for="filter-periodo" class="form-label">Periodo</label><select id="filter-periodo" class="form-select"><option value="mes-actual">Mes Actual</option><option value="ano-actual">Año Actual</option><option value="siempre">Siempre</option><option value="custom">Personalizado</option></select></div>
                <div id="custom-date-filters" class="hidden form-grid"><div class="form-group"><label for="filter-fecha-inicio" class="form-label">Desde</label><input type="date" id="filter-fecha-inicio" class="form-input"></div><div class="form-group"><label for="filter-fecha-fin" class="form-label">Hasta</label><input type="date" id="filter-fecha-fin" class="form-input"></div></div>
                <div class="form-grid"><div class="form-group"><label for="filter-beneficiario" class="form-label">Propietario</label><select id="filter-beneficiario" class="form-select"></select></div><div class="form-group"><label for="filter-cuenta" class="form-label">Cuenta</label><select id="filter-cuenta" class="form-select"></select></div></div>
                <div class="form-group"><label for="filter-concepto" class="form-label">Concepto</label><select id="filter-concepto" class="form-select"></select></div>
                <button id="apply-filters-btn" class="btn btn-primary btn-full">Aplicar Filtros</button>
            </section>

            <section id="kpi-container" aria-label="Indicadores clave de rendimiento"></section>
            
            <section class="settings-section" aria-labelledby="concepto-totals-title">
                <h3 id="concepto-totals-title" class="section-title"><span class="material-icons">category</span>Totales por Concepto</h3>
                <div id="concepto-totals-list"></div>
            </section>

            <section class="settings-section" aria-labelledby="filtered-movements-title">
                <h3 id="filtered-movements-title" class="section-title"><span class="material-icons">list_alt</span>Detalle de Movimientos (Todos)</h3>
                <div id="filtered-movements-list"></div>
                <div id="filtered-movements-summary" style="text-align: right; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--outline);"></div>
            </section>
        </div>

        <div id="movimientos-page" class="view">
            <div class="top-bar">
                <h1 class="top-bar-title">Movimientos</h1>
                <div class="top-bar-actions">
                     <input type="search" id="search-movimientos" class="form-input" placeholder="Buscar..." style="width: 150px; height: 38px;">
                </div>
            </div>
            <div id="movimientos-list"></div>
            <div id="empty-movimientos" class="empty-state" style="display: none;">
                <span class="material-icons">receipt_long</span>
                <h3>Sin Movimientos</h3>
                <p>Añade tu primer movimiento con el botón de abajo.</p>
            </div>
        </div>

        <div id="cuentas-page" class="view">
             <div class="top-bar"><h1 class="top-bar-title">Cuentas</h1></div>
             <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">person</span>Saldos por Propietario</h3>
                <div class="form-group">
                    <label class="form-label">Filtrar por Tipo de Cuenta Líquida:</label>
                    <div id="filter-account-types-pills" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;"></div>
                </div>
                <div id="resumen-propietario-container"></div>
             </section>
             <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">account_balance</span>Saldos por Tipo</h3>
                <div id="cuentas-accordion-container"></div>
             </section>
        </div>

        <div id="presupuestos-page" class="view">
            <div class="top-bar"><h1 class="top-bar-title">Presupuestos</h1></div>
            <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">add_circle_outline</span>Nuevo Presupuesto</h3>
                <form id="form-presupuesto" novalidate>
                    <div class="form-grid">
                        <div class="form-group"><label for="presupuesto-ano" class="form-label">Año</label><input type="number" id="presupuesto-ano" required placeholder="2024" min="2000" max="2100" class="form-input"><span class="error-message" id="presupuesto-ano-error"></span></div>
                        <div class="form-group"><label for="presupuesto-beneficiario-p" class="form-label">Propietario</label><select id="presupuesto-beneficiario-p" required class="form-select"></select><span class="error-message" id="presupuesto-beneficiario-p-error"></span></div>
                    </div>
                    <div class="form-group"><label for="presupuesto-concepto" class="form-label">Concepto</label><select id="presupuesto-concepto" required class="form-select"></select><span class="error-message" id="presupuesto-concepto-error"></span></div>
                    <div class="form-group"><label for="presupuesto-cantidad" class="form-label">Límite Gasto Anual</label><input type="text" id="presupuesto-cantidad" inputmode="decimal" required placeholder="1200,00" class="form-input"><span class="error-message" id="presupuesto-cantidad-error"></span></div>
                    <button type="submit" class="btn btn-primary btn-full" id="save-presupuesto-btn">Guardar Presupuesto</button>
                </form>
            </section>
            <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">track_changes</span>Seguimiento Anual</h3>
                <div id="presupuestos-list"></div>
                 <div id="empty-presupuestos" class="empty-state" style="display: none;">
                    <span class="material-icons">pie_chart_outline</span>
                    <h3>Sin Presupuestos</h3>
                    <p>Crea tu primer presupuesto para empezar a hacer seguimiento de tus gastos.</p>
                </div>
            </section>
        </div>

        <div id="configuracion-page" class="view">
            <div class="top-bar"><h1 class="top-bar-title">Configuración</h1></div>
            <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">badge</span>Configuración General</h3>
                <div class="form-group"><label for="config-beneficiarios" class="form-label">Propietarios (separados por coma)</label><input type="text" id="config-beneficiarios" placeholder="Dani, Norma, Común" class="form-input"><span class="error-message" id="config-beneficiarios-error"></span></div>
                <button id="save-config-btn" class="btn btn-primary btn-full">Guardar Configuración</button>
            </section>
            <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">backup</span>Gestión de Datos</h3>
                <p style="font-size: 13px; color: var(--secondary-color); margin-top: -8px; margin-bottom: 12px;">Importar reemplazará todos los datos actuales.</p>
                <div class="form-grid">
                    <button id="export-data-btn" class="btn btn-secondary"><span class="material-icons" style="font-size: 18px;">file_download</span>Exportar</button>
                    <button id="import-data-btn" class="btn btn-warning"><span class="material-icons" style="font-size: 18px;">file_upload</span>Importar</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
                <button id="clear-all-data-btn" class="btn btn-danger btn-full" style="margin-top: 12px;">Borrar Todos los Datos</button>
            </section>
        </div>
    </main>

    <button id="fab-add-movimiento" class="fab hidden" title="Añadir Movimiento"><span class="material-icons">add</span></button>

    <nav class="bottom-nav">
        <button id="nav-panel-control" class="nav-item active" data-page="panel-control-page" data-title="Panel" aria-current="page"><span class="material-icons">dashboard</span><span class="nav-label">Panel</span></button>
        <button id="nav-movimientos" class="nav-item" data-page="movimientos-page" data-title="Movimientos"><span class="material-icons">swap_horiz</span><span class="nav-label">Movim.</span></button>
        <button id="nav-cuentas" class="nav-item" data-page="cuentas-page" data-title="Cuentas"><span class="material-icons">account_balance_wallet</span><span class="nav-label">Cuentas</span></button>
        <button id="nav-presupuestos" class="nav-item" data-page="presupuestos-page" data-title="Presupuestos"><span class="material-icons">pie_chart</span><span class="nav-label">Presup.</span></button>
        <button id="nav-configuracion" class="nav-item" data-page="configuracion-page" data-title="Config."><span class="material-icons">settings</span><span class="nav-label">Config.</span></button>
    </nav>
</div>

<div id="toast-container" aria-live="assertive"></div>

<div id="movimiento-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="form-movimiento-title" class="modal-title">Añadir Movimiento</h3>
            <button class="icon-button close-btn" title="Cerrar"><span class="material-icons">close</span></button>
        </div>
        <div class="modal-body">
             <form id="form-movimiento" novalidate>
                 <input type="hidden" id="movimiento-id">
                 <div class="form-group"><label for="movimiento-tipo-selector" class="form-label">Tipo</label><select id="movimiento-tipo-selector" class="form-select"><option value="movimiento">Movimiento</option><option value="traspaso">Traspaso</option></select></div>
                 <div class="form-grid">
                     <div class="form-group"><label for="movimiento-cantidad" class="form-label">Cantidad (neg=gasto)</label><input type="text" id="movimiento-cantidad" class="form-input" inputmode="decimal" required placeholder="Ej: 50,25"><span class="error-message" id="movimiento-cantidad-error"></span></div>
                     <div class="form-group"><label for="movimiento-fecha" class="form-label">Fecha y Hora</label><input type="datetime-local" id="movimiento-fecha" class="form-input" required><span class="error-message" id="movimiento-fecha-error"></span></div>
                 </div>
                 <div class="form-group"><label for="movimiento-descripcion" class="form-label">Descripción</label><input type="text" id="movimiento-descripcion" class="form-input" required placeholder="Ej: Compra semanal"><span class="error-message" id="movimiento-descripcion-error"></span></div>
                 
                 <div id="movimiento-fields">
                     <div class="form-group-with-action">
                         <div class="form-group"><label for="movimiento-concepto" class="form-label">Concepto</label><select id="movimiento-concepto" class="form-select" required></select><span class="error-message" id="movimiento-concepto-error"></span></div>
                         <button type="button" class="icon-button" id="manage-conceptos-btn" title="Gestionar Conceptos"><span class="material-icons">more_vert</span></button>
                     </div>
                     <div class="form-group-with-action">
                         <div class="form-group"><label for="movimiento-cuenta" class="form-label">Cuenta</label><select id="movimiento-cuenta" class="form-select" required></select><span class="error-message" id="movimiento-cuenta-error"></span></div>
                         <button type="button" class="icon-button" id="manage-cuentas-btn" title="Gestionar Cuentas"><span class="material-icons">more_vert</span></button>
                     </div>
                     <div class="form-group"><label for="movimiento-beneficiario" class="form-label">Propietario</label><select id="movimiento-beneficiario" class="form-select" required></select><span class="error-message" id="movimiento-beneficiario-error"></span></div>
                 </div>
                 
                 <div id="traspaso-fields" class="hidden form-grid">
                     <div class="form-group"><label for="movimiento-cuenta-origen" class="form-label">Origen</label><select id="movimiento-cuenta-origen" class="form-select" required></select><span class="error-message" id="movimiento-cuenta-origen-error"></span></div>
                     <div class="form-group"><label for="movimiento-cuenta-destino" class="form-label">Destino</label><select id="movimiento-cuenta-destino" class="form-select" required></select><span class="error-message" id="movimiento-cuenta-destino-error"></span></div>
                 </div>
                 
                 <div class="modal-actions">
                    <button type="button" id="delete-movimiento-btn" class="btn btn-danger hidden" style="margin-right: auto;" title="Eliminar"><span class="material-icons">delete</span></button>
                    <button type="submit" class="btn btn-primary" id="save-movimiento-btn">Guardar</button>
                 </div>
             </form>
        </div>
    </div>
</div>

<div id="generic-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="generic-modal-title" class="modal-title"></h3>
            <button class="icon-button close-btn" title="Cerrar"><span class="material-icons">close</span></button>
        </div>
        <div id="generic-modal-body" class="modal-body"></div>
    </div>
</div>

<div id="ai-advisor-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="ai-advisor-modal-title" class="modal-title">🤖 Asesor de Inversión IA</h3>
            <button class="icon-button close-btn" title="Cerrar"><span class="material-icons">close</span></button>
        </div>
        <div id="ai-advisor-modal-body" class="modal-body">
            <form id="ai-advisor-form" novalidate>
                <p style="font-size: 14px; color: var(--secondary-color); margin-bottom: 16px;">
                    Selecciona un usuario y su perfil de riesgo para recibir un análisis de su capacidad de ahorro y sugerencias de inversión personalizadas.
                </p>
                <div class="form-group">
                    <label for="ai-user-select" class="form-label">Usuario a analizar</label>
                    <select id="ai-user-select" class="form-select" required></select>
                </div>
                <div class="form-group">
                    <label for="ai-risk-level" class="form-label">Nivel de Riesgo Asumido</label>
                    <select id="ai-risk-level" class="form-select" required>
                        <option value="Bajo">Bajo</option>
                        <option value="Medio">Medio</option>
                        <option value="Alto">Alto</option>
                    </select>
                </div>
                <div class="modal-actions">
                     <button type="submit" class="btn btn-primary" id="ai-analyze-btn">Analizar y Sugerir</button>
                </div>
            </form>
            <div id="ai-results-container" class="hidden" style="margin-top: 16px;">
                </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // NOTA IMPORTANTE DEL DESARROLLADOR: No olvides configurar las REGLAS DE SEGURIDAD en la consola de Firebase.
    // La aplicación cliente NO ES SEGURA sin ellas. Ve a Firestore -> Reglas y establece:
    // rules_version = '2';
    // service cloud.firestore {
    //   match /databases/{database}/documents {
    //     match /users/{userId}/{documents=**} {
    //       allow read, write: if request.auth.uid == userId;
    //     }
    //   }
    // }

    // =================================================================================
    // 1. STATE & GLOBAL VARIABLES
    // =================================================================================
    const quotesData = [ { "cita": "Los inversores conservadores duermen bien.", "autor": "Benjamin Graham" }, { "cita": "Nunca asciendas a alguien que no ha cometido errores, porque si lo haces, estás ascendiendo a alguien que nunca ha hecho nada.", "autor": "Benjamin Graham" }, { "cita": "Si se han hecho los deberes antes de comprar una acción, el momento de venderla es: normalmente, nunca.", "autor": "Benjamin Graham" }, { "cita": "Mientras que el entusiasmo es necesario para conseguir grandes logros en cualquier lugar, en Wall Street suele conducir al desastre.", "autor": "John Templeton" }, { "cita": "Sin tener fe en el futuro, nadie invertiría. Para ser inversor, debes creer en un mañana mejor.", "autor": "John Templeton" }, { "cita": "Las cuatro palabras más caras de nuestro lenguaje son: 'Esta vez es diferente'.", "autor": "John Templeton" }, { "cita": "Céntrate en el valor porque la mayoría de los inversores se fijan en perspectivas y tendencias.", "autor": "Peter Lynch" }, { "cita": "El éxito es un proceso de búsqueda continua de respuestas a nuevas preguntas.", "autor": "Peter Lynch" }, { "cita": "Conoce en lo que inviertes, y por qué.", "autor": "Peter Lynch" }, { "cita": "Cuando vendes en momentos de desesperación, siempre vendes barato.", "autor": "Peter Lynch" }, { "cita": "Una persona que posee una propiedad y tiene una participación en la empresa probablemente trabajará más duro, se sentirá más feliz y hará un mejor trabajo que otra que no tiene nada.", "autor": "Peter Lynch" }, { "cita": "El riesgo viene de no saber lo que se está haciendo.", "autor": "Warren Buffett" }, { "cita": "Cuesta 20 años construir una reputación y 5 minutos destruirla. Si piensas sobre ello, harás las cosas de manera diferente.", "autor": "Warren Buffett" }, { "cita": "En el mundo de los negocios, el espejo retrovisor está siempre más claro que el parabrisas.", "autor": "Warren Buffett" }, { "cita": "La inversión más importante que puedes hacer es en uno mismo.", "autor": "Warren Buffett" }, { "cita": "Sé temeroso cuando otros sean avariciosos, sé avaricioso cuando otros sean temerosos.", "autor": "Warren Buffett" }, { "cita": "Sé consciente de lo que no sabes. Siéntete a gusto entendiendo tus errores y debilidades.", "autor": "Charlie Munger" }, { "cita": "Para hacer dinero en los mercados, tienes que pensar diferente y ser humilde.", "autor": "Charlie Munger" }, { "cita": "El principal problema del inversor, e incluso su peor enemigo, es probablemente él mismo", "autor": "Benjamin Graham" }, { "cita": "Las personas que no pueden controlar sus emociones no son aptas para obtener beneficios mediante la inversión", "autor": "Benjamin Graham" }, { "cita": "Trato de comprar acciones en los negocios que son tan maravillosos que un tonto podría manejarlos. Tarde o temprano uno lo hará", "autor": "Warren Buffett" }, { "cita": "Un inversor debería actuar como si tuviera una tarjeta con sólo 20 decisiones (de compra) para tomar a lo largo de su vida", "autor": "Warren Buffett" }, { "cita": "Regla número 1: nunca pierdas dinero. Regla número 2: nunca olvides la regla número 1", "autor": "Warren Buffett" }, { "cita": "Se gana dinero descontando lo obvio y apostando a lo inesperado", "autor": "George Soros" }, { "cita": "El problema no es lo que uno no sabe, sino lo que uno cree que sabe estando equivocado", "autor": "George Soros" }, { "cita": "Si invertir es entretenido, si te estás divirtiendo, probablemente no estés ganando dinero. Las buenas inversiones son aburridas", "autor": "George Soros" }, { "cita": "Se puede perder dinero a corto plazo, pero necesitas del largo plazo para ganar dinero", "autor": "Peter Lynch" }, { "cita": "La mejor empresa para comprar puede ser alguna que ya tienes en cartera", "autor": "Peter Lynch" }, { "cita": "La clave para ganar dinero con las acciones es no tenerles miedo", "autor": "Peter Lynch" }, { "cita": "Los mercados alcistas nacen en el pesimismo, crecen en el escepticismo, maduran en el optimismo y mueren en la euforia", "autor": "John Templeton" }, { "cita": "El momento de máximo pesimismo es el mejor para comprar y el momento de máximo optimismo es el mejor para vender", "autor": "John Templeton" }, { "cita": "Un inversor que tiene todas las respuestas ni siquiera entiende las preguntas", "autor": "John Templeton" }, { "cita": "La inversión es un negocio a largo plazo donde la paciencia marca la rentabilidad", "autor": "Francisco García Paramés" }, { "cita": "¿Cuándo vendemos un valor?, respondemos siempre: cuando haya una oportunidad mejor. Ese es nuestro objetivo permanente, mejorar la cartera cada día", "autor": "Francisco García Paramés" }, { "cita": "Lo que en la Bolsa saben todos, no me interesa", "autor": "André Kostolany" }, { "cita": "No sirve para nada proclamar la verdad en economía o recomendar cosas útiles. Es la mejor manera de hacerse enemigos", "autor": "André Kostolany" }, { "cita": "Un inversionista pierde la capacidad de raciocinio cuando gana los primeros diez mil dólares. A partir de entonces se convierte en un pelele fácilmente manipulable", "autor": "André Kostolany" }, { "cita": "Comprar títulos, acciones de empresas, tomarse unas pastillas para dormir durante 20/30 años y cuando uno despierta, voilà! es millonario", "autor": "André Kostolany" }, { "cita": "No sé si los próximos 1.000 puntos del Dow Jones serán hacia arriba o hacia abajo, pero estoy seguro de que los próximos 10.000 serán hacia arriba", "autor": "Peter Lynch" }, { "cita": "El destino de un inversor lo marca su estómago , no su cerebro", "autor": "Peter Lynch" }, { "cita": "No siga mis pasos porque aún en el caso de que acierte al comprar usted no sabrá cuándo vendo", "autor": "Peter Lynch" }, { "cita": "Calcule las 'ganancias del dueño' para conseguir una reflexión verdadera del valor", "autor": "Warren Buffett" }, { "cita": "Busque compañías con altos márgenes de beneficio", "autor": "Warren Buffett" }, { "cita": "Invierta siempre para el largo plazo", "autor": "Warren Buffett" }, { "cita": "El consejo de que 'usted nunca quiebra tomando un beneficio' es absurdo", "autor": "Warren Buffett" }, { "cita": "¿El negocio tiene una historia de funcionamiento constante?", "autor": "Warren Buffett" }, { "cita": "Recuerde que el mercado de valores es maniaco-depresivo", "autor": "Benjamin Graham" }, { "cita": "Compre un negocio, no alquile la acción", "autor": "Warren Buffett" }, { "cita": "Mientras más absurdo sea el comportamiento del mercado mejor será la oportunidad para el inversor metódico", "autor": "Benjamin Graham" }, { "cita": "Se puede perder dinero a corto plazo, pero usted sigue siendo un idiota", "autor": "Joel Greenblatt" }, { "cita": "Los mercados alcistas no tienen resistencia y los bajistas no tienen soporte", "autor": "Ed Downs" }, { "cita": "El pánico causa que vendas en el bajón, y la codicia causa que compres cerca a la cima", "autor": "Stan Weinstein" }, { "cita": "Las dos grandes fuerzas que mueven los mercados son la codicia y el miedo", "autor": "Anónimo" }, { "cita": "Todo lo que sube baja y todo lo que baja sube", "autor": "Anónimo" }, { "cita": "Si no sientes miedo en el momento de comprar es que estás comprando mal", "autor": "Anónimo" }, { "cita": "Que el último duro lo gane otro", "autor": "Anónimo" }, { "cita": "La clave para hacer dinero en acciones es no asustarse de ellas", "autor": "Peter Lynch" }, { "cita": "El precio es lo que pagas, el valor es lo que recibes", "autor": "Warren Buffett" }, { "cita": "No es necesario hacer cosas extraordinarias para conseguir resultados extraordinarios", "autor": "Warren Buffett" }, { "cita": "Alguien está sentado en la sombra hoy porque alguien plantó un árbol mucho tiempo atrás", "autor": "Warren Buffett" }, { "cita": "Únicamente cuando la marea baja, descubres quién ha estado nadando desnudo", "autor": "Warren Buffett" }, { "cita": "No tenemos que ser más inteligentes que el resto, tenemos que ser más disciplinados que el resto", "autor": "Warren Buffett" }, { "cita": "Si compras cosas que no necesitas, pronto tendrás que vender cosas que necesitas", "autor": "Warren Buffett" }, { "cita": "Nunca inviertas en un negocio que no puedas entender", "autor": "Warren Buffett" }, { "cita": "El tiempo es amigo de las empresas maravillosas y enemigo de las mediocres", "autor": "Warren Buffett" }, { "cita": "Nuestro período de espera favorito es para siempre", "autor": "Warren Buffett" }, { "cita": "Wall Street es el único lugar al que las personas van en un Rolls-Royce, para recibir asesoría de quienes toman el metro", "autor": "Warren Buffett" }, { "cita": "Llega un momento en el que debes empezar a hacer lo que realmente quieres. Busca un trabajo que te guste y saltarás de la cama cada mañana con fuerza", "autor": "Warren Buffett" }, { "cita": "Es siempre mejor pasar el tiempo con gente mejor que tú. Escoge asociados cuyo comportamiento es mejor que el tuyo e irás en esa dirección", "autor": "Warren Buffett" }, { "cita": "Toma 20 años en construir una reputación y 5 minutos en arruinarla. Si piensas sobre ello, harás las cosas de forma diferente", "autor": "Warren Buffett" }, { "cita": "No importa el talento o los esfuerzos, hay cosas que llevan tiempo. No puedes producir un bebé en un mes dejando embarazadas a 9 mujeres", "autor": "Warren Buffett" }, { "cita": "Las oportunidades aparecen pocas veces. Cuando llueva oro sal a la calle con un cesto grande y no con un dedal", "autor": "Warren Buffett" }, { "cita": "La gente siempre me pregunta dónde deberían trabajar y yo siempre les digo que vayan a trabajar con aquellos a los que más admiran", "autor": "Warren Buffett" }, { "cita": "¿Cuando hay que vender una acción? Pues cuando tengamos una oportunidad mejor a la vista", "autor": "Francisco García Paramés" }, { "cita": "Nunca acudo a las OPV, me gusta estar en las empresas que pueden ser opadas por competidores, no en las salidas a bolsa", "autor": "Francisco García Paramés" }, { "cita": "Si en el mercado hay más tontos que papel, la bolsa va to subir, si hay más papel que tontos, la bolsa baja", "autor": "André Kostolany" }, { "cita": "No persiga nunca una acción, tenga paciencia que la próxima oportunidad va a llegar con toda seguridad", "autor": "André Kostolany" }, { "cita": "Lo que todos saben en la bolsa, no nos interesa a los especuladores", "autor": "André Kostolany" }, { "cita": "Las inversiones exitosas consisten en saber gestionar el riesgo, no en evitarlo.", "autor": "Benjamin Graham" }, { "cita": "Una gran compañía no es una buena inversión si pagas mucho por la acción", "autor": "Benjamin Graham" }, { "cita": "A veces es mejor pensar una hora sobre el dinero que dedicar una semana a trabajar para obtenerlo.", "autor": "André Kostolany" }, { "cita": "En la Bolsa, con frecuencia, hay que cerrar los ojos para ver mejor.", "autor": "André Kostolany" }, { "cita": "Si la inversión es entretenida, si te estás divirtiendo, es probable que no estés ganando dinero. Una buena inversión es aburrida.", "autor": "George Soros" }, { "cita": "Las burbujas del mercado de valores no crecen de la nada. Tienen una base sólida en la realidad, pero la realidad está distorsionada por un malentendido.", "autor": "George Soros" }, { "cita": "Nunca digas que no puedes permitirte algo. Esa es la aptitud de un hombre pobre. Pregúntate cómo permitírtelo.", "autor": "Robert Kiyosaki" }, { "cita": "Una diferencia importante es que los ricos compran los lujos a final, mientras que los pobres y la clase media tienden a comprar los lujos primero.", "autor": "Robert Kiyosaki" }, { "cita": "Mantén tus activos bajo mínimos, reduce los pasivos y, con mucha disciplina, ve construyendo una base de activos sólida.", "autor": "Robert Kiyosaki" }, { "cita": "No ahorres lo que queda después de gastar, sino gasta lo que queda después de ahorrar.", "autor": "Warren Buffett" }, { "cita": "El riesgo viene de no saber lo que estás haciendo.", "autor": "Warren Buffett" }, { "cita": "Sea temeroso cuando otros son codiciosos, y sea codicioso cuando otros son temerosos.", "autor": "Warren Buffett" }, { "cita": "No compres cosas que no necesitas, con dinero que no tienes, para impresionar a gente que no te importa.", "autor": "Dave Ramsey" } ];
    const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };
    
    let currentUser = null;
    let unsubscribeFromDb = null;
    let saveTimeout = null;
    let db = {};
    let selectedAccountTypesFilter = new Set();
    const originalButtonTexts = new Map();

    // =================================================================================
    // 2. FIREBASE & DATA HANDLING
    // =================================================================================
    firebase.initializeApp(firebaseConfig);
    const fbAuth = firebase.auth();
    const fbDb = firebase.firestore();
    
    const getInitialDb = () => ({ 
        cuentas: [], 
        conceptos: [], 
        movimientos: [], 
        presupuestos: [], 
        config: { beneficiarios: ["Dani", "Norma", "Común"] } 
    });

    const saveData = (buttonElement = null, successCallback = () => {}) => {
        if (!currentUser) { showToast("Error: No hay usuario autenticado."); return; }
        clearTimeout(saveTimeout);
        if (buttonElement) setButtonLoading(buttonElement, true, 'Guardando...');
        
        saveTimeout = setTimeout(() => {
            fbDb.collection('users').doc(currentUser.uid).set({ db })
                .then(() => { 
                    if (buttonElement) setButtonLoading(buttonElement, false); 
                    successCallback(); 
                })
                .catch(error => { 
                    console.error("Error al guardar datos: ", error); 
                    showToast("Error al guardar en la nube."); 
                    if (buttonElement) setButtonLoading(buttonElement, false); 
                });
        }, 800); // Debounce para evitar escrituras excesivas
    };

    const loadData = (uid) => {
        const userDocRef = fbDb.collection('users').doc(uid);
        if (unsubscribeFromDb) unsubscribeFromDb(); // Detener listener anterior si existe

        unsubscribeFromDb = userDocRef.onSnapshot(doc => {
            let dataNeedsMigration = false;
            if (doc.exists) {
                db = doc.data().db || getInitialDb();
                // Validaciones y migraciones de datos
                if (!db.presupuestos) { db.presupuestos = []; dataNeedsMigration = true; }
                if (!db.config || !db.config.beneficiarios || db.config.beneficiarios.length === 0) { 
                    db.config = { beneficiarios: ["Dani", "Norma", "Común"] }; 
                    dataNeedsMigration = true;
                }
                if ((db.movimientos || []).some(m => !Number.isInteger(m.cantidad))) {
                    (db.movimientos || []).forEach(m => m.cantidad = Math.round((parseFloat(m.cantidad) || 0) * 100));
                    dataNeedsMigration = true;
                    showToast("Migrando datos de movimientos...");
                }
                 if ((db.presupuestos || []).some(p => !Number.isInteger(p.cantidad))) {
                    (db.presupuestos || []).forEach(p => p.cantidad = Math.round((parseFloat(p.cantidad) || 0) * 100));
                    dataNeedsMigration = true;
                    showToast("Migrando datos de presupuestos...");
                }
            } else { 
                db = getInitialDb(); 
                dataNeedsMigration = true;
            }
            
            if (dataNeedsMigration) saveData();
            startMainApp();

        }, error => { 
            console.error("Error de conexión con Firestore:", error); 
            showToast("Error de conexión a la base de datos."); 
        });
    };

    // =================================================================================
    // 3. UI UTILITIES & HELPERS
    // =================================================================================
    const select = id => document.getElementById(id);
    const selectAll = s => document.querySelectorAll(s);
    const vibrate = (duration = 10) => { if ('vibrate' in navigator) { try { navigator.vibrate(duration); } catch (e) { /* ignored */ } } };
    const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
    const formatCurrency = (numInCents) => {
        const num = (numInCents || 0) / 100;
        return num.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    const showToast = (message, duration = 3000) => {
        const container = select('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        toast.style.animation = `toastFadeIn 0.3s, toastFadeOut 0.3s ${duration / 1000 - 0.3}s`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), duration);
    };

    const setButtonLoading = (buttonEl, isLoading, loadingText = 'Cargando...') => {
        if (!buttonEl) return;
        if (isLoading) {
            if (!originalButtonTexts.has(buttonEl)) originalButtonTexts.set(buttonEl, buttonEl.innerHTML);
            buttonEl.disabled = true;
            buttonEl.classList.add('btn-loading');
            buttonEl.innerHTML = `<span class="btn-text">${loadingText}</span> <span class="spinner"></span>`;
        } else {
            buttonEl.disabled = false;
            buttonEl.classList.remove('btn-loading');
            if (originalButtonTexts.has(buttonEl)) {
                buttonEl.innerHTML = originalButtonTexts.get(buttonEl);
                originalButtonTexts.delete(buttonEl);
            }
        }
    };
    
    const displayError = (elementId, message) => { const errorEl = select(`${elementId}-error`); if (errorEl) { errorEl.textContent = message; errorEl.setAttribute('role', 'alert'); const inputEl = select(elementId); if (inputEl) inputEl.classList.add('is-invalid'); } };
    const clearError = (elementId) => { const errorEl = select(`${elementId}-error`); if (errorEl) { errorEl.textContent = ''; errorEl.removeAttribute('role'); const inputEl = select(elementId); if (inputEl) inputEl.classList.remove('is-invalid'); } };
    const clearAllErrors = (formId) => { const form = select(formId); if (!form) return; form.querySelectorAll('.error-message').forEach(el => { el.textContent = ''; }); form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid')); };
    
    // =================================================================================
    // 4. APP INITIALIZATION & AUTH
    // =================================================================================
    const initApp = async () => {
        setupTheme();
        attachEventListeners();
        const splashScreen = select('splashScreen');
        const quoteScreen = select('quoteScreen');

        await wait(2500); // Splash screen duration
        if (splashScreen) {
            splashScreen.style.opacity = '0';
            await wait(500);
            splashScreen.remove();
        }

        if (quoteScreen && quotesData.length > 0) {
            const randomQuote = quotesData[Math.floor(Math.random() * quotesData.length)];
            select('quoteText').textContent = `"${randomQuote.cita}"`;
            select('quoteAuthor').textContent = `- ${randomQuote.autor}`;
            quoteScreen.style.display = 'flex';
            await wait(50);
            quoteScreen.classList.add('visible');
            await wait(3500); // Quote screen duration
            quoteScreen.style.opacity = '0';
            await wait(500);
            quoteScreen.remove();
        }

        checkAuthState();
    };

    const checkAuthState = () => { fbAuth.onAuthStateChanged(user => { if (user) { currentUser = user; loadData(user.uid); } else { currentUser = null; if (unsubscribeFromDb) unsubscribeFromDb(); db = getInitialDb(); showLoginScreen(); } }); };
    const startMainApp = () => { select('login-screen').classList.remove('visible'); select('app-root').classList.add('visible'); document.body.style.overflow = ''; renderAll(); navigateTo(select('.nav-item.active')?.dataset.page || 'panel-control-page'); };
    const showLoginScreen = () => { select('app-root').classList.remove('visible'); select('login-screen').classList.add('visible'); document.body.style.overflow = 'hidden'; };
    const handleLogin = () => { const email = select('login-email').value.trim(), password = select('login-password').value, errorEl = select('login-error'), loginBtn = select('login-btn'); clearAllErrors('login-form'); errorEl.textContent = ''; let valid = true; if (!email) { displayError('login-email', 'El correo es obligatorio.'); valid = false; } if (!password) { displayError('login-password', 'La contraseña es obligatoria.'); valid = false; } if (!valid) return; setButtonLoading(loginBtn, true, 'Iniciando...'); fbAuth.signInWithEmailAndPassword(email, password).then(() => { showToast(`Bienvenido/a de nuevo!`); setButtonLoading(loginBtn, false); }).catch(error => { setButtonLoading(loginBtn, false); if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') { errorEl.textContent = 'Error: Credenciales incorrectas.'; } else if (error.code === 'auth/invalid-email') { displayError('login-email', 'Formato de correo no válido.'); } else { errorEl.textContent = 'Error al iniciar sesión.'; } }); };
    const handleRegister = () => { const email = select('login-email').value.trim(), password = select('login-password').value, errorEl = select('login-error'), registerBtn = select('register-btn'); clearAllErrors('login-form'); errorEl.textContent = ''; let valid = true; if (!email) { displayError('login-email', 'El correo es obligatorio.'); valid = false; } if (password.length < 6) { displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); valid = false; } if (!valid) return; setButtonLoading(registerBtn, true, 'Registrando...'); fbAuth.createUserWithEmailAndPassword(email, password).then(() => { showToast(`Registro completado. ¡Bienvenido/a!`); setButtonLoading(registerBtn, false); }).catch(error => { setButtonLoading(registerBtn, false); if (error.code == 'auth/weak-password') { displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); } else if (error.code == 'auth/email-already-in-use') { displayError('login-email', 'El correo ya está registrado.'); } else if (error.code === 'auth/invalid-email') { displayError('login-email', 'Formato de correo no válido.'); } else { errorEl.textContent = 'Error en el registro.'; } }); };
    const handleLogout = () => { fbAuth.signOut().then(() => {showToast("Sesión cerrada."); location.reload()}).catch(() => showToast("Error al cerrar sesión.")); };
    
    // =================================================================================
    // 5. NAVIGATION & UI CONTROL
    // =================================================================================
    const navigateTo = (pageId) => { 
        if(!pageId) return; 
        vibrate(); 
        selectAll('.view').forEach(p => p.classList.remove('active')); 
        select(pageId)?.classList.add('active'); 
        selectAll('.nav-item').forEach(b => { b.classList.remove('active'); b.removeAttribute('aria-current'); }); 
        const activeBtn = document.querySelector(`.nav-item[data-page="${pageId}"]`); 
        if (activeBtn) { activeBtn.classList.add('active'); activeBtn.setAttribute('aria-current', 'page'); }
        select('fab-add-movimiento').classList.toggle('hidden', pageId !== 'movimientos-page');
    };
    
    const setupTheme = () => { const theme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', theme); selectAll('.icon-button[title="Cambiar Tema"] .material-icons').forEach(icon => icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode'); };
    
    // =================================================================================
    // 6. CORE LOGIC & CALCULATIONS
    // =================================================================================
    const getLiquidAccounts = () => { const NON_LIQUID_TYPES = ['PROPIEDAD', 'PRÉSTAMO']; return (db.cuentas || []).filter(c => !NON_LIQUID_TYPES.includes((c.tipo || '').trim().toUpperCase())); };
    
    const getSaldos = () => {
        const saldos = (db.cuentas || []).reduce((acc, c) => ({ ...acc, [c.id]: 0 }), {});
        (db.movimientos || []).forEach(m => {
            if (m.tipo === 'traspaso') {
                if (saldos[m.cuentaOrigenId] !== undefined) saldos[m.cuentaOrigenId] -= m.cantidad;
                if (saldos[m.cuentaDestinoId] !== undefined) saldos[m.cuentaDestinoId] += m.cantidad;
            } else {
                if (saldos[m.cuentaId] !== undefined) saldos[m.cuentaId] += m.cantidad;
            }
        });
        return saldos;
    };
    
    const getFilteredMovements = () => { const periodo = select('filter-periodo').value, beneficiario = select('filter-beneficiario').value, cuentaId = select('filter-cuenta').value, conceptoId = select('filter-concepto').value; let startDate, endDate, now = new Date(); switch (periodo) { case 'mes-actual': startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999); break; case 'ano-actual': startDate = new Date(now.getFullYear(), 0, 1); endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999); break; case 'custom': const startVal = select('filter-fecha-inicio').value, endVal = select('filter-fecha-fin').value; startDate = startVal ? new Date(startVal) : null; if(startDate) startDate.setHours(0,0,0,0); endDate = endVal ? new Date(endVal) : null; if(endDate) endDate.setHours(23,59,59,999); break; default: startDate = null; endDate = null; break; } let filtered = db.movimientos || []; if (startDate && endDate) { filtered = filtered.filter(m => { const mDate = new Date(m.fecha); return mDate >= startDate && mDate <= endDate; }); } if (beneficiario) filtered = filtered.filter(m => m.beneficiario === beneficiario); if (conceptoId) filtered = filtered.filter(m => m.conceptoId === conceptoId); if (cuentaId) { filtered = filtered.filter(m => m.cuentaId === cuentaId || m.cuentaOrigenId === cuentaId || m.cuentaDestinoId === cuentaId); } return filtered.filter(m => m.tipo === 'movimiento' || m.tipo === 'traspaso'); };
    
    // =================================================================================
    // 7. RENDERING FUNCTIONS
    // =================================================================================
    const renderAll = () => { populateAllDropdowns(); renderMovimientos(); renderCuentas(); renderPresupuestos(); loadConfig(); updateDashboard(); };

    const populateAllDropdowns = () => { const populate = (el, data, nameKey, valKey = 'id', allOption = false, noneOption = false) => { if (!el) return; const currentVal = el.value; let options = allOption ? '<option value="">Todos</option>' : ''; if (noneOption) options += '<option value="">Ninguno</option>'; [...data].sort((a, b) => (a[nameKey] || "").localeCompare(b[nameKey] || "")).forEach(i => { options += `<option value="${i[valKey]}">${i[nameKey]}</option>`; }); el.innerHTML = options; if (Array.from(el.options).some(opt => opt.value === currentVal)) { el.value = currentVal; } else if (!allOption && !noneOption && el.options.length > 0) { el.value = el.options[0].value; } else { el.value = ""; } }; const owners = (db.config.beneficiarios || []).map(b => ({ id: b, nombre: b })); populate(select('movimiento-beneficiario'), owners, 'nombre', 'id'); populate(select('presupuesto-beneficiario-p'), owners, 'nombre', 'id'); populate(select('filter-beneficiario'), owners, 'nombre', 'id', true); populate(select('movimiento-cuenta'), db.cuentas, 'nombre', 'id', false, true); populate(select('movimiento-cuenta-origen'), db.cuentas, 'nombre', 'id', false, true); populate(select('movimiento-cuenta-destino'), db.cuentas, 'nombre', 'id', false, true); populate(select('filter-cuenta'), db.cuentas, 'nombre', 'id', true); populate(select('movimiento-concepto'), db.conceptos, 'nombre', 'id', false, true); populate(select('presupuesto-concepto'), db.conceptos, 'nombre', 'id'); populate(select('filter-concepto'), db.conceptos, 'nombre', 'id', true); };
    
    const renderCuentas = () => {
        const accordionContainer = select('cuentas-accordion-container'), resumenContainer = select('resumen-propietario-container'), filterPillsContainer = select('filter-account-types-pills');
        if (!accordionContainer || !resumenContainer || !filterPillsContainer) return;
        const saldos = getSaldos();
        const allLiquidAccounts = getLiquidAccounts();

        const distinctLiquidTypes = [...new Set(allLiquidAccounts.map(c => (c.tipo || 'SIN TIPO').trim().toUpperCase()))].sort();
        filterPillsContainer.innerHTML = '';
        distinctLiquidTypes.forEach(type => {
            const pill = document.createElement('button');
            pill.className = `filter-pill ${selectedAccountTypesFilter.has(type) ? 'active' : ''}`;
            pill.dataset.type = type; pill.textContent = type;
            pill.onclick = () => { vibrate(); if (selectedAccountTypesFilter.has(type)) { selectedAccountTypesFilter.delete(type); } else { selectedAccountTypesFilter.add(type); } renderCuentas(); };
            filterPillsContainer.appendChild(pill);
        });

        const renderCuentasByOwner = () => {
            resumenContainer.innerHTML = '';
            const filteredAccounts = selectedAccountTypesFilter.size === 0 ? allLiquidAccounts : allLiquidAccounts.filter(c => selectedAccountTypesFilter.has((c.tipo || 'SIN TIPO').trim().toUpperCase()));
            (db.config.beneficiarios || []).filter(b => b.toLowerCase() !== 'común').forEach(owner => {
                const ownerAccounts = filteredAccounts.filter(c => c.propietario === owner || c.propietario === 'Común');
                const saldoNetoEnCentimos = ownerAccounts.reduce((sum, c) => sum + (saldos[c.id] || 0), 0);
                
                const details = document.createElement('details'); details.className = 'accordion-item';
                const ownerClass = owner.toLowerCase().replace(/\s|ú/g, (match) => match === 'ú' ? 'u' : '');
                details.innerHTML = `
                    <summary>
                        <span class="owner-${ownerClass}-text" style="font-weight: bold;">${owner === "Dani" ? "👨‍💼" : "👩‍💼"} ${owner}</span>
                        <span><strong class="owner-${ownerClass}-text">${formatCurrency(saldoNetoEnCentimos)} €</strong><span class="material-icons expand-icon">expand_more</span></span>
                    </summary>
                    <div class="accordion-content">
                        ${ownerAccounts.length > 0 ? ownerAccounts.sort((a, b) => a.nombre.localeCompare(b.nombre)).map(c => `
                            <div class="list-item-card owner-${c.propietario.toLowerCase().replace(/\s|ú/g, (match) => match === 'ú' ? 'u' : '')}-border">
                                <div class="item-content" data-account-id="${c.id}">
                                    <div class="item-details"><div class="item-title">${c.nombre}</div><div class="item-meta">${c.tipo} | ${c.propietario}</div></div>
                                    <div class="item-amount"><strong>${formatCurrency(saldos[c.id])} €</strong></div>
                                </div>
                            </div>`).join('') : '<div class="empty-state" style="padding: 16px 0;"><p>No hay cuentas para el filtro.</p></div>'
                        }
                    </div>`;
                resumenContainer.appendChild(details);
            });
        };

        const renderCuentasByType = () => {
            accordionContainer.innerHTML = '';
            const cuentasPorTipo = (db.cuentas || []).reduce((acc, c) => {
                const tipo = (c.tipo || 'SIN TIPO').trim().toUpperCase(); (acc[tipo] = acc[tipo] || []).push(c); return acc;
            }, {});

            const totalPatrimonio = Object.values(saldos).reduce((sum, s) => sum + s, 0);

            Object.keys(cuentasPorTipo).sort().forEach(tipo => {
                const details = document.createElement('details'); details.className = 'accordion-item';
                const saldoGrupoEnCentimos = cuentasPorTipo[tipo].reduce((s, c) => s + (saldos[c.id] || 0), 0);
                const porcText = totalPatrimonio !== 0 ? `<span style="font-size:11px;color:var(--secondary-color);margin-left:8px;font-weight:400;">(${(saldoGrupoEnCentimos / totalPatrimonio * 100).toFixed(1)}%)</span>` : '';
                const icon = tipo === 'EFECTIVO' ? 'payments' : (tipo.includes('TARJETA') ? 'credit_card' : (tipo === 'AHORRO' ? 'savings' : (tipo === 'INVERSIÓN' ? 'trending_up' : (tipo === 'PROPIEDAD' ? 'domain' : 'account_balance'))));
                
                details.innerHTML = `
                    <summary>
                        <span><span class="material-icons" style="vertical-align: bottom; font-size: 20px; margin-right: 8px;">${icon}</span>${tipo}</span>
                        <span><strong>${formatCurrency(saldoGrupoEnCentimos)} €</strong>${porcText}<span class="material-icons expand-icon">expand_more</span></span>
                    </summary>
                    <div class="accordion-content">
                        ${cuentasPorTipo[tipo].sort((a,b) => a.nombre.localeCompare(b.nombre)).map(c => `
                            <div class="list-item-card owner-${c.propietario.toLowerCase().replace(/\s|ú/g, (match) => match === 'ú' ? 'u' : '')}-border">
                                <div class="item-content" data-account-id="${c.id}">
                                    <div class="item-details"><div class="item-title">${c.nombre}</div><div class="item-meta">${c.propietario}</div></div>
                                    <div class="item-amount"><strong>${formatCurrency(saldos[c.id])} €</strong></div>
                                </div>
                            </div>`).join('')
                        }
                    </div>`;
                accordionContainer.appendChild(details);
            });
        };
        
        renderCuentasByOwner();
        renderCuentasByType();
    };
    
    const renderMovimientos = (filterText = '') => {
        const listContainer = select('movimientos-list');
        const emptyState = select('empty-movimientos');
        if (!listContainer || !emptyState) return;

        const lowerFilter = filterText.toLowerCase();
        const filtered = (db.movimientos || []).filter(m => {
            const concept = db.conceptos.find(c => c.id === m.conceptoId)?.nombre || '';
            const account = m.tipo === 'traspaso' ? `${db.cuentas.find(c => c.id === m.cuentaOrigenId)?.nombre || ''} ${db.cuentas.find(c => c.id === m.cuentaDestinoId)?.nombre || ''}` : (db.cuentas.find(c => c.id === m.cuentaId)?.nombre || '');
            return m.descripcion.toLowerCase().includes(lowerFilter) || concept.toLowerCase().includes(lowerFilter) || account.toLowerCase().includes(lowerFilter);
        });

        listContainer.innerHTML = '';
        if (filtered.length === 0) {
            emptyState.style.display = 'block';
            emptyState.querySelector('p').textContent = filterText ? 'No hay movimientos que coincidan.' : 'Añade tu primer movimiento con el botón (+).';
            return;
        }
        
        emptyState.style.display = 'none';
        filtered.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(m => {
            const item = document.createElement('div');
            const ownerClass = m.beneficiario ? `owner-${m.beneficiario.toLowerCase().replace(/\s|ú/g, (match) => match === 'ú' ? 'u' : '')}-border` : '';
            const amountHtml = m.tipo === 'traspaso' ? `<span class="text-info">${formatCurrency(m.cantidad)} €</span>` : (m.cantidad < 0 ? `<span class="text-negative">${formatCurrency(m.cantidad)} €</span>` : `<span class="text-positive">+${formatCurrency(m.cantidad)} €</span>`);
            const metaInfo = m.tipo === 'traspaso' ? `Traspaso: ${(db.cuentas.find(c => c.id === m.cuentaOrigenId)?.nombre || '?')} → ${(db.cuentas.find(c => c.id === m.cuentaDestinoId)?.nombre || '?')}` : `${(db.conceptos.find(c => c.id === m.conceptoId)?.nombre || 'Sin Concepto')} en ${(db.cuentas.find(c => c.id === m.cuentaId)?.nombre || 'Sin Cuenta')}`;
            
            item.className = `list-item-card ${ownerClass}`;
            item.innerHTML = `
                <div class="item-content" data-movimiento-id="${m.id}" data-action="edit">
                    <div class="item-amount">${amountHtml}</div>
                    <div class="item-details"><div class="item-title">${m.descripcion}</div><div class="item-meta">${new Date(m.fecha).toLocaleString('es-ES', {day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</div><div class="item-meta">${metaInfo}</div></div>
                </div>
                <div class="item-actions"><button class="icon-button" data-movimiento-id="${m.id}" data-action="delete" title="Eliminar"><span class="material-icons">delete_outline</span></button></div>`;
            listContainer.appendChild(item);
        });
    };
    
    const renderPresupuestos = () => {
        const listContainer = select('presupuestos-list'), emptyState = select('empty-presupuestos');
        if (!listContainer || !emptyState) return;

        const sortedPresupuestos = (db.presupuestos || []).sort((a,b) => b.ano - a.ano || a.beneficiario.localeCompare(b.beneficiario));
        listContainer.innerHTML = '';
        if (sortedPresupuestos.length === 0) { emptyState.style.display = 'block'; return; }

        emptyState.style.display = 'none';
        sortedPresupuestos.forEach(budget => {
            const gastoReal = (db.movimientos || []).filter(m => new Date(m.fecha).getFullYear() === budget.ano && m.beneficiario === budget.beneficiario && m.conceptoId === budget.conceptoId && m.cantidad < 0).reduce((sum, m) => sum + Math.abs(m.cantidad), 0);
            const limite = budget.cantidad;
            const percentage = limite > 0 ? (gastoReal / limite) * 100 : 0;
            let progressClass = 'progress-ok';
            if (percentage >= 100) progressClass = 'progress-danger'; else if (percentage >= 75) progressClass = 'progress-warning';
            
            const conceptoNombre = db.conceptos.find(c => c.id === budget.conceptoId)?.nombre || 'Desconocido';
            const ownerClass = `owner-${budget.beneficiario.toLowerCase().replace(/\s|ú/g, (match) => match === 'ú' ? 'u' : '')}-border`;
            
            const budgetElement = document.createElement('div');
            budgetElement.className = `list-item-card budget-item ${ownerClass}`;
            budgetElement.innerHTML = `
                <div style="width: 100%;">
                    <div class="budget-info">
                        <div class="budget-info-text"><strong>${conceptoNombre} (${budget.beneficiario} ${budget.ano})</strong><span class="text-negative">Gasto: ${formatCurrency(gastoReal)}€</span><span class="text-positive">Límite: ${formatCurrency(limite)}€</span></div>
                        <button class="icon-button delete-presupuesto" data-id="${budget.id}" title="Borrar Presupuesto"><span class="material-icons">delete_outline</span></button>
                    </div><progress class="budget-progress ${progressClass}" value="${gastoReal}" max="${limite}"></progress>
                </div>`;
            listContainer.appendChild(budgetElement);
        });
    };
    
    const loadConfig = () => { const configBeneficiarios = select('config-beneficiarios'); if(configBeneficiarios) configBeneficiarios.value = (db.config.beneficiarios || []).join(', '); };
    
    const updateDashboard = () => {
        const movements = getFilteredMovements();
        const kpiContainer = select('kpi-container'), conceptTotalsContainer = select('concepto-totals-list'), listContainer = select('filtered-movements-list'), summaryContainer = select('filtered-movements-summary');
        if (!kpiContainer || !conceptTotalsContainer || !listContainer || !summaryContainer) return;
        
        const ingresos = movements.filter(m => m.cantidad > 0 && m.tipo !== 'traspaso').reduce((sum, m) => sum + m.cantidad, 0);
        const gastos = movements.filter(m => m.cantidad < 0).reduce((sum, m) => sum + m.cantidad, 0);
        const saldo = ingresos + gastos;
        
        kpiContainer.innerHTML = `<div class="kpi-item"><h4 class="text-positive">Ingresos</h4><strong class="text-positive">+${formatCurrency(ingresos)} €</strong></div><div class="kpi-item"><h4 class="text-negative">Gastos</h4><strong class="text-negative">${formatCurrency(gastos)} €</strong></div><div class="kpi-item"><h4>Saldo Neto</h4><strong class="${saldo >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(saldo)} €</strong></div>`;
        
        const conceptTotals = movements.reduce((acc, m) => { if (m.tipo === 'movimiento' && m.conceptoId) { if (!acc[m.conceptoId]) { acc[m.conceptoId] = { total: 0, movements: [] }; } acc[m.conceptoId].total += m.cantidad; acc[m.conceptoId].movements.push(m); } return acc; }, {});
        conceptTotalsContainer.innerHTML = Object.keys(conceptTotals).length === 0 ? '<div class="empty-state" style="padding: 16px 0;"><p>Sin datos para los filtros.</p></div>' : Object.entries(conceptTotals).sort(([,a],[,b]) => a.total - b.total).map(([id, data]) => {
            const concept = db.conceptos.find(c => c.id === id);
            const total = data.total;
            const movementsHtml = data.movements.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).map(mov => {
                const ownerClass = mov.beneficiario ? `owner-${mov.beneficiario.toLowerCase().replace(/\s|ú/g, (match) => match === 'ú' ? 'u' : '')}-border` : '';
                return `
                <div class="list-item-card ${ownerClass}">
                    <div class="item-content" data-movimiento-id="${mov.id}" data-action="edit">
                        <div class="item-amount ${mov.cantidad >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(mov.cantidad)} €</div>
                        <div class="item-details"><div class="item-title">${mov.descripcion}</div><div class="item-meta">${new Date(mov.fecha).toLocaleDateString('es-ES')}</div></div>
                    </div>
                </div>`}).join('');

            return `<details class="accordion-item">
                        <summary>
                            <span>${concept?.nombre || 'Desconocido'}</span>
                            <span><strong class="${total >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(total)} €</strong><span class="material-icons expand-icon">expand_more</span></span>
                        </summary>
                        <div class="accordion-content">${movementsHtml}</div>
                    </details`;
        }).join('');
        
        listContainer.innerHTML = ''; summaryContainer.innerHTML = '';
        if (movements.length > 0) {
            movements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(m => {
                const ownerClass = m.beneficiario ? `owner-${m.beneficiario.toLowerCase().replace(/\s|ú/g, (match) => match === 'ú' ? 'u' : '')}-border` : '';
                const amountHtml = m.tipo === 'traspaso' ? `<span class="text-info">${formatCurrency(m.cantidad)} €</span>` : (m.cantidad < 0 ? `<span class="text-negative">${formatCurrency(m.cantidad)} €</span>` : `<span class="text-positive">+${formatCurrency(m.cantidad)} €</span>`);
                const metaInfo = m.tipo === 'traspaso' ? `Traspaso` : `${(db.conceptos.find(c => c.id === m.conceptoId)?.nombre || 'Sin Concepto')}`;
                const listItem = document.createElement('div'); listItem.className = `list-item-card ${ownerClass}`;
                listItem.innerHTML = `<div class="item-content" data-movimiento-id="${m.id}" data-action="edit"><div class="item-amount">${amountHtml}</div><div class="item-details"><div class="item-title">${m.descripcion}</div><div class="item-meta">${new Date(m.fecha).toLocaleDateString('es-ES')} - ${metaInfo}</div></div></div>`;
                listContainer.appendChild(listItem);
            });
            const totalSum = movements.reduce((sum, m) => sum + (m.tipo === 'traspaso' ? 0 : m.cantidad), 0);
            summaryContainer.innerHTML = `<span style="color: var(--secondary-color);">Total Filtrado (sin traspasos):</span><br><strong style="font-size: 18px;" class="${totalSum >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(totalSum)} €</strong>`;
        } else {
            listContainer.innerHTML = '<div class="empty-state" style="padding: 16px 0;"><p>No se encontraron movimientos.</p></div>';
        }
    };
    
    // =================================================================================
    // 8. MODAL HANDLING & MANAGEMENT
    // =================================================================================
    const showModal = (title, contentHTML) => {
        select('generic-modal-title').textContent = title;
        select('generic-modal-body').innerHTML = contentHTML;
        select('generic-modal').classList.add('active');
    };
    
    const hideModal = () => {
        select('generic-modal').classList.remove('active');
    };

    const showConfirmationModal = (message, onConfirm, title = "Confirmar Acción") => { const modalId = 'confirmation-modal'; document.getElementById(modalId)?.remove(); const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay active'; modalOverlay.innerHTML = `<div class="modal" role="alertdialog"><div class="modal-header"><h3 class="modal-title">${title}</h3></div><div class="modal-body"><p>${message}</p><div class="modal-actions"><button id="confirm-no-btn" class="btn btn-secondary">Cancelar</button><button id="confirm-yes-btn" class="btn btn-danger">Sí, continuar</button></div></div></div>`; document.body.appendChild(modalOverlay); const confirmYesBtn = select('confirm-yes-btn'), confirmNoBtn = select('confirm-no-btn'); const closeModal = () => modalOverlay.remove(); confirmYesBtn.onclick = () => { onConfirm(); closeModal(); }; confirmNoBtn.onclick = closeModal; modalOverlay.onclick = e => { if (e.target === modalOverlay) closeModal(); }; };
    
    const showAccountMovementsModal = (cuenta) => {
        const accountMovements = db.movimientos.filter(m => m.cuentaId === cuenta.id || m.cuentaOrigenId === cuenta.id || m.cuentaDestinoId === cuenta.id).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        let movementsHtml = accountMovements.length === 0 ? `<div class="empty-state"><span class="material-icons">receipt_long</span><h3>Sin Movimientos</h3><p>No hay movimientos registrados para esta cuenta.</p></div>` : accountMovements.map(m => {
            const ownerClass = m.beneficiario ? `owner-${m.beneficiario.toLowerCase().replace(/\s|ú/g, (match) => match === 'ú' ? 'u' : '')}-border` : '';
            const amountHtml = m.tipo === 'traspaso' ? `<span class="text-info">${formatCurrency(m.cantidad)} €</span>` : (m.cantidad < 0 ? `<span class="text-negative">${formatCurrency(m.cantidad)} €</span>` : `<span class="text-positive">+${formatCurrency(m.cantidad)} €</span>`);
            let metaInfo = m.tipo === 'traspaso' ? (m.cuentaOrigenId === cuenta.id ? `Traspaso a ${(db.cuentas.find(c => c.id === m.cuentaDestinoId)?.nombre || '?')}` : `Traspaso de ${(db.cuentas.find(c => c.id === m.cuentaOrigenId)?.nombre || '?')}`) : (db.conceptos.find(c => c.id === m.conceptoId)?.nombre || 'Sin Concepto');

            return `<div class="list-item-card ${ownerClass}"><div class="item-content" data-movimiento-id="${m.id}" data-action="edit"><div class="item-amount">${amountHtml}</div><div class="item-details"><div class="item-title">${m.descripcion}</div><div class="item-meta">${new Date(m.fecha).toLocaleString('es-ES', {day: '2-digit', month: 'short', year:'2-digit', hour: '2-digit', minute: '2-digit'})} | ${metaInfo}</div></div></div></div>`;
        }).join('');
        
        showModal(`Movimientos de ${cuenta.nombre}`, `<div class="movements-modal">${movementsHtml}</div>`);
    };

    const startEditMovement = (id) => {
        const modal = select('movimiento-modal');
        const form = select('form-movimiento');
        form.reset(); clearAllErrors('form-movimiento');
        
        const mov = id ? db.movimientos.find(m => m.id === id) : null;
        
        select('form-movimiento-title').textContent = mov ? '' : '';
        select('movimiento-id').value = mov?.id || '';
        select('movimiento-tipo-selector').value = mov?.tipo || 'movimiento';
        select('movimiento-tipo-selector').dispatchEvent(new Event('change'));
        
        select('movimiento-cantidad').value = mov ? formatCurrency(mov.cantidad).replace(/\./g,'') : '';
        select('movimiento-fecha').value = mov ? new Date(new Date(mov.fecha).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : new Date(Date.now() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        select('movimiento-descripcion').value = mov?.descripcion || '';
        
        if (mov?.tipo === 'traspaso') {
            select('movimiento-cuenta-origen').value = mov.cuentaOrigenId;
            select('movimiento-cuenta-destino').value = mov.cuentaDestinoId;
        } else {
            select('movimiento-cuenta').value = mov?.cuentaId || '';
            select('movimiento-concepto').value = mov?.conceptoId || '';
            select('movimiento-beneficiario').value = mov?.beneficiario || '';
        }
        
        select('delete-movimiento-btn').classList.toggle('hidden', !mov);
        if (mov) { select('delete-movimiento-btn').onclick = () => confirmDeleteMovement(mov.id); }
        
        modal.classList.add('active');
    };
    
    const confirmDeleteMovement = (id) => { showConfirmationModal('¿Seguro que quieres eliminar este movimiento?', () => { db.movimientos = db.movimientos.filter(m => m.id !== id); saveData(null, () => { renderAll(); showToast('Movimiento eliminado.'); select('movimiento-modal').classList.remove('active'); }); }); };
    
    // =================================================================================
    // 9. NEW MODAL IMPLEMENTATIONS (HELP, CONCEPTS, CUENTAS)
    // =================================================================================

    const showHelpModal = () => {
        const helpHTML = `
            <div id="help-modal-content">
                <p>¡Bienvenido/a a <strong>Cuentas aiDANaI</strong>! Esta guía te ayudará a entender cómo funciona cada parte de la aplicación para que puedas sacarle el máximo partido a la gestión de tus finanzas.</p>
                <h3>1. Conceptos Clave</h3>
                <p>Para entender la aplicación, es importante conocer tres conceptos básicos:</p>
                <ul>
                    <li><strong>Propietarios:</strong> Son las personas que participan en las finanzas (ej: Dani, Norma). También existe el propietario "Común" para gastos o ingresos compartidos. Puedes personalizarlos en <code>Configuración</code>.</li>
                    <li><strong>Cuentas:</strong> Representan dónde está tu dinero. Pueden ser cuentas bancarias, tarjetas de crédito, efectivo, etc. Cada cuenta tiene un nombre, un tipo y un propietario.</li>
                    <li><strong>Conceptos:</strong> Son las categorías para tus movimientos (ej: Nómina, Supermercado, Ocio). Te ayudan a clasificar y analizar en qué gastas tu dinero.</li>
                </ul>
                <hr>
                <h3>2. Secciones de la Aplicación</h3>
                <p>La barra inferior te da acceso a las cinco secciones principales.</p>
                <h4>📈 Panel de Control</h4>
                <p>Es tu centro de operaciones. Aquí puedes ver un resumen de tu situación financiera basado en los filtros que apliques (Periodo, Propietario, etc.). Recuerda pulsar "Aplicar Filtros" para actualizar la vista.</p>
                <h4>↔️ Movimientos</h4>
                <p>Aquí puedes ver y gestionar todas tus transacciones. Pulsa el botón <code>+</code> para añadir un <strong>Movimiento</strong> (gasto/ingreso) o un <strong>Traspaso</strong> (mover dinero entre tus cuentas). Pulsa sobre un movimiento para editarlo o eliminarlo.</p>
                <h4>🏦 Cuentas</h4>
                <p>Esta sección te ofrece una visión clara de dónde está tu dinero, agrupado por propietario o por tipo. Pulsa sobre cualquier cuenta para ver su historial de movimientos.</p>
                <h4>📊 Presupuestos</h4>
                <p>Te permite fijar límites de gasto anuales por concepto y propietario, y hacer un seguimiento visual de ellos mediante una barra de progreso.</p>
                <h4>⚙️ Configuración</h4>
                <p>Aquí puedes personalizar la lista de propietarios y gestionar tus datos: <strong>Exportar</strong> (crear copia de seguridad), <strong>Importar</strong> (restaurar desde copia) y <strong>Borrar Todos los Datos</strong> (¡acción irreversible!).</p>
                <hr>
                <h3>3. Notas de Seguridad</h3>
                <p>Tu información está protegida por tu contraseña. La seguridad de la base de datos depende de que configures correctamente las <strong>Reglas de Seguridad</strong> en tu consola de Firebase. Sin ellas, tus datos podrían ser públicos. La regla mínima recomendada es:</p>
                <pre><code>match /users/{userId}/{documents=**} {
  allow read, write: if request.auth.uid == userId;
}</code></pre>
            </div>`;
        showModal("Guía de la Aplicación", helpHTML);
    };

    const showConceptosModal = () => {
        let contentHTML = '<div id="conceptos-list-modal"></div>';
        contentHTML += `
            <form id="add-concepto-form" class="form-group-with-action" style="margin-top:20px;">
                <div class="form-group">
                    <label for="new-concepto-nombre" class="form-label">Nuevo Concepto</label>
                    <input type="text" id="new-concepto-nombre" class="form-input" placeholder="Ej: Restaurantes" required>
                </div>
                <button type="submit" class="btn btn-primary" style="height:42px;"><span class="material-icons">add</span></button>
            </form>`;
        
        showModal("Gestionar Conceptos", contentHTML);
        renderConceptosModalList();
    };

    const renderConceptosModalList = () => {
        const container = select('conceptos-list-modal');
        if (!container) return;
        const sortedConceptos = (db.conceptos || []).sort((a,b) => a.nombre.localeCompare(b.nombre));
        if (sortedConceptos.length === 0) {
            container.innerHTML = '<p class="empty-state" style="padding: 10px 0;">No hay conceptos. Añade el primero.</p>';
            return;
        }
        container.innerHTML = sortedConceptos.map(c => `
            <div class="modal-list-item">
                <span>${c.nombre}</span>
                <button class="icon-button" data-action="delete-concepto" data-id="${c.id}" title="Eliminar"><span class="material-icons">delete_outline</span></button>
            </div>
        `).join('');
    };

    const showCuentasModal = () => {
        let contentHTML = '<div id="cuentas-list-modal"></div>';
        const ownerOptions = (db.config.beneficiarios || []).map(b => `<option value="${b}">${b}</option>`).join('');
        contentHTML += `
            <form id="add-cuenta-form" novalidate style="margin-top:20px; padding-top: 20px; border-top: 1px solid var(--outline);">
                <h4 style="margin-bottom:12px;">Añadir Nueva Cuenta</h4>
                <div class="form-group">
                    <label for="new-cuenta-nombre" class="form-label">Nombre de la Cuenta</label>
                    <input type="text" id="new-cuenta-nombre" class="form-input" placeholder="Ej: Banco Principal" required>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="new-cuenta-tipo" class="form-label">Tipo</label>
                        <input type="text" id="new-cuenta-tipo" class="form-input" placeholder="Ej: Corriente, Ahorro" required>
                    </div>
                    <div class="form-group">
                        <label for="new-cuenta-propietario" class="form-label">Propietario</label>
                        <select id="new-cuenta-propietario" class="form-select" required>${ownerOptions}</select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Añadir Cuenta</button>
            </form>`;
        
        showModal("Gestionar Cuentas", contentHTML);
        renderCuentasModalList();
    };

    const renderCuentasModalList = () => {
        const container = select('cuentas-list-modal');
        if (!container) return;
        const sortedCuentas = (db.cuentas || []).sort((a,b) => a.nombre.localeCompare(b.nombre));
        if (sortedCuentas.length === 0) {
            container.innerHTML = '<p class="empty-state" style="padding: 10px 0;">No hay cuentas. Añade la primera.</p>';
            return;
        }
        container.innerHTML = sortedCuentas.map(c => `
            <div class="modal-list-item">
                <div class="item-details">
                    <div class="item-title">${c.nombre}</div>
                    <div class="item-meta">${c.tipo} | ${c.propietario}</div>
                </div>
                <button class="icon-button" data-action="delete-cuenta" data-id="${c.id}" title="Eliminar"><span class="material-icons">delete_outline</span></button>
            </div>
        `).join('');
    };

    // =================================================================================
    // 10. AI ADVISOR LOGIC
    // =================================================================================
    const showAiAdvisorModal = () => {
        const modal = select('ai-advisor-modal');
        if (!modal) return;

        // Reset view to form
        select('ai-advisor-form').classList.remove('hidden');
        select('ai-results-container').classList.add('hidden');
        select('ai-results-container').innerHTML = '';
        
        // Populate users, ensuring only Dani and Norma are options as requested
        const userSelect = select('ai-user-select');
        const validUsers = ['Dani', 'Norma'];
        const availableUsers = (db.config.beneficiarios || []).filter(u => validUsers.includes(u));
        userSelect.innerHTML = availableUsers.map(u => `<option value="${u}">${u}</option>`).join('');
        
        if (availableUsers.length === 0) {
            showToast("Los usuarios 'Dani' o 'Norma' no se encuentran en la configuración.", 4000);
            return;
        }

        modal.classList.add('active');
    };

    const handleAiAnalysis = (form) => {
        const user = select('ai-user-select').value;
        const risk = select('ai-risk-level').value;
        const analyzeBtn = select('ai-analyze-btn');

        if (!user || !risk) {
            showToast("Por favor, selecciona un usuario y un nivel de riesgo.");
            return;
        }

        setButtonLoading(analyzeBtn, true, 'Analizando...');

        setTimeout(() => {
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

            let totalIncome = 0;
            let totalExpenses = 0;

            (db.movimientos || []).filter(m => {
                const movDate = new Date(m.fecha);
                return movDate >= sixMonthsAgo && (m.beneficiario === user || m.beneficiario === 'Común') && m.tipo !== 'traspaso';
            }).forEach(m => {
                const amount = m.cantidad;
                const share = (m.beneficiario === 'Común') ? 0.5 : 1.0;
                
                if (amount > 0) {
                    totalIncome += amount * share;
                } else {
                    totalExpenses += Math.abs(amount) * share;
                }
            });
            
            const netSavings = totalIncome - totalExpenses;
            const monthlyAverageSavings = netSavings / 6;

            const suggestions = getInvestmentSuggestions(risk, monthlyAverageSavings, user);
            
            const resultsContainer = select('ai-results-container');
            let savingsSummaryHtml = `
                <h4>Análisis de Ahorro para ${user}</h4>
                <p style="font-size: 14px; margin-bottom: 8px;">
                    Basado en los movimientos de los últimos 6 meses (incluyendo un 50% de los 'Comunes'):
                </p>
                <ul style="list-style-position: inside; padding-left: 8px;">
                    <li><strong>Ingresos Totales Asignados:</strong> <span class="text-positive">${formatCurrency(totalIncome)} €</span></li>
                    <li><strong>Gastos Totales Asignados:</strong> <span class="text-negative">${formatCurrency(totalExpenses)} €</span></li>
                    <li><strong>Ahorro Neto en 6 meses:</strong> <strong class="${netSavings >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(netSavings)} €</strong></li>
                    <li><strong>Capacidad de Ahorro Mensual Promedio:</strong> <strong style="font-size: 1.1em;" class="${monthlyAverageSavings >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(monthlyAverageSavings)} €</strong></li>
                </ul>
                <hr>`;
                
            if (monthlyAverageSavings <= 0) {
                savingsSummaryHtml += `
                    <p style="margin-top: 16px; font-weight: 500; text-align: center;">
                        Tu capacidad de ahorro promedio es nula o negativa. Antes de invertir, sería recomendable revisar tus gastos para intentar generar un excedente mensual.
                    </p>`;
                resultsContainer.innerHTML = savingsSummaryHtml;
            } else {
                resultsContainer.innerHTML = savingsSummaryHtml + suggestions;
            }

            form.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            setButtonLoading(analyzeBtn, false);

        }, 500);
    };

    const getInvestmentSuggestions = (riskLevel, monthlySavings, userName) => {
        let suggestionsHtml = `
            <h4 style="margin-top: 16px;">Sugerencias de Inversión (Riesgo ${riskLevel})</h4>
            <p style="font-size: 14px; margin-bottom: 8px;">
                Con una capacidad de ahorro de <strong>${formatCurrency(monthlySavings)} €/mes</strong>, podrías considerar diversificar en:
            </p>
            <ul style="list-style-position: inside; padding-left: 8px;">`;

        switch (riskLevel) {
            case 'Bajo':
                suggestionsHtml += `
                    <li><strong>Cuentas de Ahorro Remuneradas:</strong> Busca bancos que ofrezcan un interés por tu dinero sin riesgo. Ideal para tu fondo de emergencia.</li>
                    <li><strong>Depósitos a Plazo Fijo:</strong> Ofrecen una rentabilidad fija y conocida si mantienes el dinero durante un tiempo determinado.</li>
                    <li><strong>Fondos Monetarios:</strong> Invierten en activos de deuda a muy corto plazo. Son muy líquidos y de bajísimo riesgo.</li>
                    <li><strong>Bonos del Estado (Letras del Tesoro):</strong> Deuda pública a corto plazo. Se considera uno de los activos más seguros.</li>`;
                break;
            case 'Medio':
                suggestionsHtml += `
                    <li><strong>Fondos de Inversión Indexados:</strong> Invierte de forma diversificada en un índice completo (como el S&P 500 o el MSCI World) con costes muy bajos. Es una excelente estrategia a largo plazo.</li>
                    <li><strong>ETFs (Fondos Cotizados):</strong> Similares a los fondos indexados pero se compran y venden como acciones. Permiten diversificar fácilmente.</li>
                    <li><strong>Acciones de Empresas "Blue Chip":</strong> Compañías grandes y consolidadas con un historial estable de beneficios (ej. Inditex, Iberdrola, Coca-Cola).</li>
                    <li><strong>Plataformas de Robo-Advisors:</strong> Gestores automatizados que invierten tu dinero en una cartera diversificada según tu perfil de riesgo.</li>`;
                break;
            case 'Alto':
                suggestionsHtml += `
                    <li><strong>Acciones de Empresas de Crecimiento (Growth):</strong> Compañías de sectores como la tecnología o la biotecnología con alto potencial de revalorización, pero también mayor volatilidad.</li>
                    <li><strong>ETFs Sectoriales o Temáticos:</strong> Fondos cotizados que se centran en un sector específico (ej. energías renovables, inteligencia artificial, videojuegos).</li>
                    <li><strong>Criptomonedas:</strong> Como Bitcoin o Ethereum. Inversión de muy alto riesgo y volatilidad extrema. Dedica solo un pequeño porcentaje de tu cartera que estés dispuesto/a a perder.</li>
                    <li><strong>Inversión en Startups (Crowdequity):</strong> Plataformas que te permiten invertir en empresas emergentes. Potencial de gran retorno, pero con un riesgo muy elevado de perder toda la inversión.</li>`;
                break;
        }

        suggestionsHtml += `
            </ul>
            <hr>
            <div style="margin-top: 16px; padding: 12px; border-radius: 8px; background-color: var(--surface-variant);">
                <p style="font-weight: bold; color: var(--warning-color); text-align: center; margin-bottom: 8px;">
                    <span class="material-icons" style="vertical-align: bottom;">warning</span> ADVERTENCIA IMPORTANTE
                </p>
                <p style="font-size: 12px; text-align: justify;">
                    Como inteligencia artificial, estas son únicamente <strong>sugerencias genéricas y educativas</strong> basadas en los datos proporcionados y el perfil de riesgo seleccionado. <strong>No constituyen un consejo de inversión profesional.</strong>
                    La decisión final sobre en qué y cómo invertir es exclusivamente tuya. <strong>${userName}</strong>, ya eres lo suficientemente inteligente como para saber en qué inviertes, es <strong>responsabilidad tuya</strong>. Se recomienda siempre investigar a fondo cada producto y, si es necesario, consultar con un asesor financiero certificado.
                </p>
            </div>`;

        return suggestionsHtml;
    };

    // =================================================================================
    // 11. EVENT LISTENERS
    // =================================================================================
    function attachEventListeners() {
        document.body.addEventListener('click', (e) => {
            const target = e.target;
            const button = target.closest('button');
            const accountCard = target.closest('.item-content[data-account-id]');
            const movementCard = target.closest('.item-content[data-movimiento-id][data-action="edit"]');
            const modalOverlay = target.closest('.modal-overlay');

            if (modalOverlay && e.target === modalOverlay) return modalOverlay.classList.remove('active');
            
            if (button) {
                if (button.closest('.nav-item')) return navigateTo(button.closest('.nav-item').dataset.page);
                if (button.closest('.close-btn')) return button.closest('.modal-overlay')?.classList.remove('active');
                if (button.id.startsWith('theme-toggle')) { vibrate(); const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); selectAll('.icon-button[title="Cambiar Tema"] .material-icons').forEach(icon => icon.textContent = newTheme === 'light' ? 'dark_mode' : 'light_mode'); return; }
                if (button.id === 'fab-add-movimiento') return startEditMovement(null);
                if (button.id === 'login-btn') return handleLogin();
                if (button.id === 'register-btn') return handleRegister();
                if (button.id.startsWith('logout-btn')) return handleLogout();
                if (button.id === 'help-btn') return showHelpModal();
                if (button.id === 'ai-advice-btn') return showAiAdvisorModal();
                if (button.id === 'apply-filters-btn') { vibrate(20); setButtonLoading(button, true, 'Aplicando...'); updateDashboard(); setTimeout(() => setButtonLoading(button, false), 400); return; }
                if (button.id === 'manage-conceptos-btn') { vibrate(); showConceptosModal(); return; }
                if (button.id === 'manage-cuentas-btn') { vibrate(); showCuentasModal(); return; }
                if (button.id === 'save-config-btn') { const beneficiarios = select('config-beneficiarios').value.split(',').map(s => s.trim()).filter(Boolean); if (beneficiarios.length === 0) { displayError('config-beneficiarios', 'Debe haber al menos un propietario.'); return; } setButtonLoading(button, true, 'Guardando...'); db.config.beneficiarios = beneficiarios; saveData(button, () => { renderAll(); showToast('Configuración guardada.'); }); return; }
                if (button.id === 'clear-all-data-btn') { showConfirmationModal('¿Seguro que quieres borrar TODOS tus datos? Esta acción es irreversible.', () => { db = getInitialDb(); saveData(null, () => { renderAll(); showToast('Todos los datos han sido borrados.'); }); }); return; }
                if (button.id === 'export-data-btn') { setButtonLoading(button, true, 'Exportando...'); const dataStr = JSON.stringify({db}, null, 2); const blob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `cuentas_aiDANaI_export_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Copia de seguridad exportada.'); setButtonLoading(button, false); return; }
                if (button.id === 'import-data-btn') { select('import-file-input').click(); return; }
                if (button.classList.contains('delete-presupuesto')) { const budgetId = button.dataset.id; showConfirmationModal('¿Seguro que quieres eliminar este presupuesto?', () => { db.presupuestos = db.presupuestos.filter(p => p.id !== budgetId); saveData(null, () => { renderPresupuestos(); showToast('Presupuesto eliminado.'); }); }); }
                if (button.dataset.action === 'delete-movimiento' || (button.dataset.action === 'delete' && button.dataset.movimientoId)) { return confirmDeleteMovement(button.dataset.movimientoId); }
                
                // New listeners for modal item deletion
                if (button.dataset.action === 'delete-concepto') {
                    const conceptoId = button.dataset.id;
                    if (db.movimientos.some(m => m.conceptoId === conceptoId)) {
                        showToast("No se puede borrar un concepto en uso.", 3000);
                        return;
                    }
                    showConfirmationModal('¿Seguro que quieres eliminar este concepto?', () => {
                        db.conceptos = db.conceptos.filter(c => c.id !== conceptoId);
                        saveData(null, () => {
                            showToast("Concepto eliminado.");
                            renderConceptosModalList();
                            populateAllDropdowns();
                        });
                    });
                }
                if (button.dataset.action === 'delete-cuenta') {
                    const cuentaId = button.dataset.id;
                    if (db.movimientos.some(m => m.cuentaId === cuentaId || m.cuentaOrigenId === cuentaId || m.cuentaDestinoId === cuentaId)) {
                        showToast("No se puede borrar una cuenta con movimientos asociados.", 3500);
                        return;
                    }
                     showConfirmationModal('¿Seguro que quieres eliminar esta cuenta?', () => {
                        db.cuentas = db.cuentas.filter(c => c.id !== cuentaId);
                        saveData(null, () => {
                            showToast("Cuenta eliminada.");
                            renderCuentasModalList();
                            populateAllDropdowns();
                        });
                    });
                }
            }
            
            if (accountCard) {
                vibrate();
                const cuenta = db.cuentas.find(c => c.id === accountCard.dataset.accountId);
                if(cuenta) showAccountMovementsModal(cuenta);
            }
            
            if (movementCard) {
                startEditMovement(movementCard.dataset.movimientoId);
            }
        });
        
        document.body.addEventListener('input', (e) => { const targetId = e.target.id; if (['login-email', 'login-password', 'config-beneficiarios', 'movimiento-cantidad', 'movimiento-fecha', 'movimiento-descripcion', 'movimiento-concepto', 'movimiento-cuenta', 'movimiento-beneficiario', 'movimiento-cuenta-origen', 'movimiento-cuenta-destino', 'presupuesto-ano', 'presupuesto-beneficiario-p', 'presupuesto-concepto', 'presupuesto-cantidad'].includes(targetId)) clearError(targetId); if(targetId === 'search-movimientos') renderMovimientos(e.target.value); });
        
        document.body.addEventListener('change', (e) => {
            if(e.target.id === 'filter-periodo') select('custom-date-filters')?.classList.toggle('hidden', e.target.value !== 'custom');
            if(e.target.id === 'movimiento-tipo-selector') {
                const isTraspaso = e.target.value === 'traspaso';
                select('movimiento-fields').style.display = isTraspaso ? 'none' : 'block';
                select('traspaso-fields').classList.toggle('hidden', !isTraspaso);
                select('movimiento-concepto').required = !isTraspaso;
                select('movimiento-cuenta').required = !isTraspaso;
                select('movimiento-beneficiario').required = !isTraspaso;
                select('movimiento-cuenta-origen').required = isTraspaso;
                select('movimiento-cuenta-destino').required = isTraspaso;
                clearAllErrors('form-movimiento');
            }
            if(e.target.id === 'import-file-input') {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    try {
                        let importedData = JSON.parse(re.target.result); if (importedData.db) importedData = importedData.db; 
                        if ((importedData.movimientos || []).some(m => !Number.isInteger(m.cantidad)) || (importedData.presupuestos || []).some(p => !Number.isInteger(p.cantidad))) { showToast("Detectado formato antiguo. Migrando datos..."); if(importedData.movimientos) importedData.movimientos.forEach(m => m.cantidad = Math.round((parseFloat(m.cantidad) || 0) * 100)); if(importedData.presupuestos) importedData.presupuestos.forEach(p => p.cantidad = Math.round((parseFloat(p.cantidad) || 0) * 100)); }
                        if (importedData.recurringMovements) delete importedData.recurringMovements; // Cleanup old data structures
                        showConfirmationModal('Importar reemplazará TODOS tus datos en la nube. ¿Estás seguro?', () => { db = importedData; saveData(null, () => { renderAll(); showToast('Datos importados y sincronizados.'); }); }, 'Confirmar Importación');
                    } catch (error) { showToast('Error: Archivo JSON no válido.'); console.error("Import error:", error); }
                };
                reader.readAsText(file); e.target.value = '';
            }
        });

        document.body.addEventListener('submit', (e) => {
            e.preventDefault();
            if (e.target.id === 'ai-advisor-form') {
                handleAiAnalysis(e.target);
                return;
            }
            if (e.target.id === 'form-movimiento') {
                vibrate(20); clearAllErrors('form-movimiento');
                const id = select('movimiento-id').value, tipo = select('movimiento-tipo-selector').value, fecha = select('movimiento-fecha').value, descripcion = select('movimiento-descripcion').value.trim(), saveMovBtn = select('save-movimiento-btn');
                const cantidadStr = select('movimiento-cantidad').value.trim().replace(/\./g, '').replace(',', '.'); const cantidadFloat = parseFloat(cantidadStr); const cantidadEnCentimos = Math.round(cantidadFloat * 100);
                let valid = true;
                if (isNaN(cantidadFloat) || cantidadFloat === 0) { displayError('movimiento-cantidad', 'Cantidad inválida o cero.'); valid = false; }
                if (!fecha) { displayError('movimiento-fecha', 'Fecha y hora son obligatorias.'); valid = false; }
                if (!descripcion) { displayError('movimiento-descripcion', 'La descripción es obligatoria.'); valid = false; }
                let newMov = { id: id || generateId(), tipo, cantidad: cantidadEnCentimos, fecha: fecha ? new Date(fecha).toISOString() : new Date().toISOString(), descripcion };
                if(tipo === 'traspaso') {
                    newMov.cuentaOrigenId = select('movimiento-cuenta-origen').value; newMov.cuentaDestinoId = select('movimiento-cuenta-destino').value; newMov.beneficiario = 'Común';
                    if (!newMov.cuentaOrigenId) { displayError('movimiento-cuenta-origen', 'Cuenta origen es obligatoria.'); valid = false; }
                    if (!newMov.cuentaDestinoId) { displayError('movimiento-cuenta-destino', 'Cuenta destino es obligatoria.'); valid = false; }
                    if (newMov.cuentaOrigenId === newMov.cuentaDestinoId) { displayError('movimiento-cuenta-destino', 'Origen y destino no pueden ser iguales.'); valid = false; }
                    if (cantidadEnCentimos <= 0) { displayError('movimiento-cantidad', 'Para traspasos, la cantidad debe ser positiva.'); valid = false; }
                } else {
                    newMov.cuentaId = select('movimiento-cuenta').value; newMov.conceptoId = select('movimiento-concepto').value; newMov.beneficiario = select('movimiento-beneficiario').value;
                    if (!newMov.cuentaId) { displayError('movimiento-cuenta', 'Cuenta es obligatoria.'); valid = false; }
                    if (!newMov.conceptoId) { displayError('movimiento-concepto', 'Concepto es obligatorio.'); valid = false; }
                    if (!newMov.beneficiario) { displayError('movimiento-beneficiario', 'Propietario es obligatorio.'); valid = false; }
                }
                if (!valid) return;
                setButtonLoading(saveMovBtn, true, 'Guardando...');
                if (id) { const index = db.movimientos.findIndex(m => m.id === id); if (index > -1) db.movimientos[index] = newMov; } 
                else { db.movimientos.push(newMov); }
                saveData(saveMovBtn, () => { e.target.reset(); select('movimiento-modal').classList.remove('active'); showToast(id ? 'Movimiento actualizado' : 'Movimiento añadido'); renderAll(); });
            }
            if (e.target.id === 'form-presupuesto') {
                clearAllErrors('form-presupuesto');
                const ano = parseInt(select('presupuesto-ano').value), beneficiario = select('presupuesto-beneficiario-p').value, conceptoId = select('presupuesto-concepto').value, savePresupuestoBtn = select('save-presupuesto-btn');
                const cantidadStr = select('presupuesto-cantidad').value.trim().replace(/\./g, '').replace(',', '.'); const cantidadFloat = parseFloat(cantidadStr); const cantidadEnCentimos = Math.round(cantidadFloat * 100);
                let valid = true;
                if (isNaN(ano) || ano < 2000 || ano > 2100) { displayError('presupuesto-ano', 'Año inválido.'); valid = false; }
                if (!beneficiario) { displayError('presupuesto-beneficiario-p', 'Propietario es obligatorio.'); valid = false; }
                if (!conceptoId) { displayError('presupuesto-concepto', 'Concepto es obligatorio.'); valid = false; }
                if (isNaN(cantidadFloat) || cantidadFloat <= 0) { displayError('presupuesto-cantidad', 'Cantidad debe ser un número positivo.'); valid = false; }
                if (db.presupuestos.some(p => p.ano === ano && p.beneficiario === beneficiario && p.conceptoId === conceptoId)) { displayError('presupuesto-concepto', 'Ya existe un presupuesto con estos parámetros.'); valid = false; }
                if (!valid) return;
                setButtonLoading(savePresupuestoBtn, true, 'Guardando...');
                const newPresupuesto = { id: generateId(), ano, beneficiario, conceptoId, cantidad: cantidadEnCentimos };
                db.presupuestos.push(newPresupuesto);
                saveData(savePresupuestoBtn, () => { e.target.reset(); showToast('Presupuesto guardado.'); renderAll(); });
            }
            // New form handlers
            if (e.target.id === 'add-concepto-form') {
                const input = select('new-concepto-nombre');
                const nombre = input.value.trim();
                if (nombre) {
                    db.conceptos.push({ id: generateId(), nombre });
                    saveData(null, () => {
                        input.value = '';
                        showToast('Concepto añadido.');
                        renderConceptosModalList();
                        populateAllDropdowns();
                    });
                }
            }
            if (e.target.id === 'add-cuenta-form') {
                const nombre = select('new-cuenta-nombre').value.trim();
                const tipo = select('new-cuenta-tipo').value.trim().toUpperCase();
                const propietario = select('new-cuenta-propietario').value;
                if(nombre && tipo && propietario) {
                    db.cuentas.push({ id: generateId(), nombre, tipo, propietario });
                    saveData(null, () => {
                        e.target.reset();
                        showToast('Cuenta añadida.');
                        renderCuentasModalList();
                        populateAllDropdowns();
                    });
                } else {
                    showToast("Por favor, rellena todos los campos.", 3000);
                }
            }
        });
    }

    // =================================================================================
    // 12. APP ENTRY POINT
    // =================================================================================
    initApp();
});
</script>
</body>
</html>