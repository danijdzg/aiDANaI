<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Cuentas aiDANaI</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="manifest" href="data:application/manifest+json,{
        %22name%22:%22Cuentas aiDANaI%22,
        %22short_name%22:%22aiDANaI%22,
        %22start_url%22:%22.%22,
        %22display%22:%22standalone%22,
        %22background_color%22:%22#111827%22,
        %22theme_color%22:%22#7F56D9%22,
        %22description%22:%22Gestor de finanzas personales y compartidas, elegante y profesional.%22,
        %22icons%22:[
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg%2bxml%22},
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg%2bxml%22}
        ]
    }">
    <meta name="theme-color" content="#111827"/>
    <link rel="apple-touch-icon" href="aiDANaI-Cuentas.jpg">

    <style>
        :root {
            --c-primary: #6941C6; --c-primary-hover: #5735A2; --c-background: #F9FAFB; --c-surface: #FFFFFF; --c-surface-variant: #F3F4F6; --c-on-surface: #1F2937; --c-on-surface-secondary: #6B7280; --c-outline: #D1D5DB; --c-success: #059669; --c-danger: #D92D20; --c-warning: #F79009; --c-info: #0284C7; --c-white: #FFFFFF; --c-black: #000000; --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --c-owner-dani: #3B82F6; --c-owner-norma: #EC4899; --c-owner-comun: #10B981; --c-owner-común: #10B981;
            --font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            --fs-xs: 0.7rem; --fs-sm: 0.825rem; --fs-base: 0.95rem; --fs-lg: 1.05rem; --fs-xl: 1.2rem;
            --fw-normal: 400; --fw-medium: 500; --fw-semibold: 600; --fw-bold: 700;
            --sp-1: 0.2rem; --sp-2: 0.4rem; --sp-3: 0.6rem; --sp-4: 0.8rem; --sp-5: 1rem; --sp-6: 1.25rem;
            --border-radius-md: 12px; --border-radius-lg: 16px;
        }
        [data-theme="dark"] {
            --c-primary: #9E77ED; --c-primary-hover: #B592F6; --c-background: #111827; --c-surface: #1F2937; --c-surface-variant: #374151; --c-on-surface: #F9FAFB; --c-on-surface-secondary: #9CA3AF; --c-outline: #4B5563; --c-success: #34D399; --c-danger: #F87171; --c-warning: #FBBF24; --c-info: #60A5FA; --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15); --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; scroll-behavior: smooth; }
        body { font-family: var(--font-family); background-color: var(--c-background); color: var(--c-on-surface); line-height: 1.5; min-height: 100vh; min-height: -webkit-fill-available; transition: background-color 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow: hidden; }
        *:focus-visible { outline: 2px solid var(--c-primary); outline-offset: 2px; border-radius: var(--sp-2); }
        
        @keyframes pop-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes highlight-card { 0% { background-color: color-mix(in srgb, var(--c-primary) 15%, transparent); } 100% { background-color: transparent; } }
        .highlight-animation { animation: highlight-card 1.5s ease-out; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton {
            background-color: var(--c-surface-variant);
            background-image: linear-gradient(90deg, var(--c-surface-variant), color-mix(in srgb, var(--c-outline) 20%, var(--c-surface-variant)), var(--c-surface-variant));
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: var(--sp-2);
            color: transparent !important;
            user-select: none;
        }
        .skeleton > * { visibility: hidden; }
        
        /* === MODIFICACIÓN: Animación de Carga Mejorada === */
        .intro-screen { position: fixed; inset: 0; z-index: 9999; display: flex; justify-content: center; align-items: center; background-color: #111827; transition: opacity 0.75s ease-in-out; }
        .starry-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(1px 1px at 10% 20%,#fff,transparent),radial-gradient(1px 1px at 80% 30%,#fff,transparent),radial-gradient(2px 2px at 50% 50%,#fff,transparent),radial-gradient(1px 1px at 30% 80%,#fff,transparent),radial-gradient(2px 2px at 90% 90%,#fff,transparent); background-size: 300px 300px; animation: twinkle 15s linear infinite; }
        @keyframes twinkle { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .intro-screen__logo { 
            width: 250px; 
            height: auto; 
            border-radius: 24px; 
            opacity: 0; 
            position: absolute;
            animation: logoExplode 4s cubic-bezier(0.5, 0, 0.5, 1) forwards;
        }
        @keyframes logoExplode {
            0% { transform: scale(0.2) rotate(-25deg); opacity: 0; }
            30% { transform: scale(1.1) rotate(10deg); opacity: 1; }
            50% { transform: scale(0.95) rotate(-8deg); opacity: 1; }
            80% { transform: scale(1.5) rotate(5deg); opacity: 1; }
            100% { transform: scale(12) rotate(20deg); opacity: 0; }
        }
        .intro-screen__quote-container { text-align: center; color: var(--c-white); padding: var(--sp-5); max-width: 800px; z-index: 1; opacity: 0; transition: opacity 1.5s ease-in-out; }
        .intro-screen__quote-container.visible { opacity: 1; }
        .intro-screen__quote-text { font-size: clamp(1.5rem, 5vw, 2.2rem); font-style: italic; font-weight: var(--fw-normal); line-height: 1.4; margin-bottom: 20px; text-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        .intro-screen__quote-author { display: block; font-size: clamp(1rem, 3vw, 1.25rem); color: var(--c-on-surface-secondary); font-weight: var(--fw-medium); }
        
        /* Resto del CSS sin cambios... */
        .app-layout { display: none; max-width: 500px; margin: 0 auto; height: 100vh; background-color: var(--c-background); position: relative; flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; }
        .app-layout--visible { display: flex; opacity: 1; }
        .app-layout__main { flex: 1; position: relative; overflow: hidden; }
        .view { position: absolute; inset: 0; display: flex; flex-direction: column; overflow-y: auto; padding: var(--sp-4); padding-top: calc(60px + var(--sp-4)); padding-bottom: calc(75px + var(--sp-4) + env(safe-area-inset-bottom)); opacity: 0; transform: translateX(10px); transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; pointer-events: none; }
        .view--active { opacity: 1; transform: translateX(0); pointer-events: auto; }
        #movimientos-page { overflow: hidden; padding-bottom: calc(75px + env(safe-area-inset-bottom)); } /* Ajuste para la lista virtualizada */

        .top-bar { position: absolute; top: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: space-between; padding: var(--sp-3) var(--sp-4); background-color: color-mix(in srgb, var(--c-surface) 80%, transparent); backdrop-filter: blur(8px); border-bottom: 1px solid var(--c-outline); z-index: 10; height: 60px; }
        .top-bar__title { font-size: var(--fs-xl); font-weight: var(--fw-bold); }
        .top-bar__actions { display: flex; align-items: center; gap: var(--sp-1); }
        
        .card { background: var(--c-surface); border-radius: var(--border-radius-lg); padding: var(--sp-4); margin-bottom: var(--sp-3); box-shadow: var(--shadow-sm); border: 1px solid var(--c-outline); animation: pop-in 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .card__title { font-size: var(--fs-lg); font-weight: var(--fw-semibold); margin-bottom: var(--sp-3); display: flex; align-items: center; gap: var(--sp-2); color: var(--c-primary); }
        .card__title .material-icons { font-size: var(--fs-xl); }

        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--sp-3); margin-bottom: var(--sp-3); }
        .kpi-item { background: var(--c-surface); border-radius: var(--border-radius-md); padding: var(--sp-3); text-align: center; box-shadow: var(--shadow-sm); transition: background-color 0.3s; }
        .kpi-item__label { font-size: var(--fs-xs); font-weight: var(--fw-medium); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-1); text-transform: uppercase; }
        .kpi-item__value { font-size: var(--fs-base); font-weight: var(--fw-bold); }
        
        #movimientos-list-container { height: 100%; overflow-y: auto; position: relative; -webkit-overflow-scrolling: touch; }
        #virtual-list-sizer { position: relative; width: 100%; }
        #virtual-list-content { position: absolute; top: 0; left: 0; width: 100%; }
        .transaction-card { display: flex; position: relative; border-left: 5px solid transparent; overflow: hidden; box-shadow: var(--shadow-sm); background-color: var(--c-surface); border-radius: var(--border-radius-md); margin-bottom: var(--sp-2); }
        #movimientos-list-container .transaction-card { height: 82px; /* Altura fija para la virtualización */ margin-bottom: var(--sp-2); }
        .transaction-card__swipe-content { display: flex; justify-content: space-between; align-items: center; flex-grow: 1; padding: var(--sp-2) var(--sp-3); gap: var(--sp-3); width: 100%; position: relative; z-index: 2; background: inherit; transition: transform 0.3s ease; cursor: pointer; border-radius: inherit; }
        .transaction-card__details { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        .transaction-card__description { font-weight: var(--fw-medium); font-size: var(--fs-sm); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__meta { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__amount { font-weight: var(--fw-semibold); font-size: var(--fs-sm); text-align: right; flex-shrink: 0; }
        .transaction-card__actions { position: absolute; top: 0; bottom: 0; width: 65px; display: flex; align-items: center; justify-content: center; z-index: 1; }
        .transaction-card__actions--left { left: 0; background-color: var(--c-info); }
        .transaction-card__actions--right { right: 0; background-color: var(--c-danger); }
        .transaction-card__actions .icon-btn { color: white; width: 100%; height: 100%; border-radius: 0; }
        .transaction-card--swiped-left .transaction-card__swipe-content { transform: translateX(-65px); }
        .transaction-card--swiped-right .transaction-card__swipe-content { transform: translateX(65px); }
        .transaction-card--owner-dani { border-left-color: var(--c-owner-dani); } .transaction-card--owner-norma { border-left-color: var(--c-owner-norma); } .transaction-card--owner-comun, .transaction-card--owner-común { border-left-color: var(--c-owner-comun); }
        
        .accordion { margin-bottom: var(--sp-2); background-color: var(--c-surface); border-radius: var(--border-radius-md); box-shadow: var(--shadow-sm); overflow: hidden; border: 1px solid var(--c-outline);}
        .accordion > summary { font-weight: var(--fw-semibold); cursor: pointer; padding: var(--sp-3); display: flex; align-items: center; justify-content: space-between; list-style: none; font-size: var(--fs-base); }
        .accordion > summary::-webkit-details-marker { display: none; }
        .accordion > summary .accordion__icon { transition: transform 0.2s; color: var(--c-on-surface-secondary); }
        .accordion[open] > summary .accordion__icon { transform: rotate(180deg); }
        .accordion__content { padding: 0 var(--sp-4) var(--sp-3); border-top: 1px solid var(--c-outline); }
        .accordion__content .transaction-card { box-shadow: none; background-color: var(--c-surface-variant); height: auto; }

        .form-group { margin-bottom: var(--sp-3); }
        .form-label { display: block; font-size: var(--fs-sm); font-weight: var(--fw-medium); margin-bottom: var(--sp-2); color: var(--c-on-surface-secondary); }
        .form-input, .form-select { width: 100%; padding: var(--sp-2) var(--sp-3); border: 1px solid var(--c-outline); border-radius: var(--sp-2); background: var(--c-surface); color: var(--c-on-surface); font-size: var(--fs-base); appearance: none; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--c-primary); box-shadow: 0 0 0 2px color-mix(in srgb, var(--c-primary) 20%, transparent); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 12px center; background-size: 14px; padding-right: 40px; }
        [data-theme=dark] .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23FFF' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--sp-3); }
        .form-group-addon { display: flex; align-items: flex-end; gap: var(--sp-2); }
        .form-group-addon .form-group { flex-grow: 1; margin-bottom: 0; }
        .form-error { color: var(--c-danger); font-size: var(--fs-xs); margin-top: var(--sp-1); min-height: 16px; display: block; }
        .form-input--invalid { border-color: var(--c-danger) !important; }

        .btn { padding: var(--sp-2) var(--sp-4); border: 1px solid transparent; border-radius: 20px; font-size: var(--fs-sm); font-weight: var(--fw-semibold); cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: var(--sp-2); -webkit-user-select: none; user-select: none; }
        .btn:active { transform: scale(0.97); }
        .btn--primary { background-color: var(--c-primary); color: var(--c-white); } .btn--primary:hover { background-color: var(--c-primary-hover); }
        .btn--secondary { background-color: var(--c-surface-variant); color: var(--c-on-surface); border-color: var(--c-outline); } .btn--secondary:hover { background-color: color-mix(in srgb, var(--c-outline) 20%, var(--c-surface-variant)); }
        .btn--danger { background-color: var(--c-danger); color: var(--c-white); } .btn--full { width: 100%; } .btn--loading { pointer-events: none; opacity: .8; }
        
        .icon-btn { background: none; border: none; color: var(--c-on-surface-secondary); cursor: pointer; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s, transform 0.2s; }
        .icon-btn:hover { background-color: var(--c-surface-variant); color: var(--c-on-surface); }
        .icon-btn:active { transform: scale(0.9); }

        .fab { position: fixed; bottom: calc(85px + env(safe-area-inset-bottom)); right: var(--sp-6); width: 56px; height: 56px; background-color: var(--c-primary); color: var(--c-white); border: none; border-radius: var(--border-radius-lg); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md); z-index: 50; transform: scale(0); opacity: 0; transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .fab--visible { transform: scale(1); opacity: 1; }
        .fab:hover { transform: scale(1.1) !important; } .fab .material-icons { font-size: 28px; }

        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background-color: var(--c-surface); border-top: 1px solid var(--c-outline); display: flex; padding: var(--sp-2) 0 calc(var(--sp-2) + env(safe-area-inset-bottom)) 0; z-index: 100; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); }
        .bottom-nav__item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: var(--sp-1) var(--sp-2); cursor: pointer; transition: color 0.2s; color: var(--c-on-surface-secondary); border: none; background: none; }
        .bottom-nav__item--active { color: var(--c-primary); }
        .bottom-nav__item .material-icons { font-size: 26px; } .bottom-nav__label { font-size: 11px; font-weight: var(--fw-medium); margin-top: 2px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: flex-end; justify-content: center; z-index: 200; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        @media (min-width: 500px) { .modal-overlay { align-items: center; } }
        .modal-overlay--active { opacity: 1; pointer-events: auto; }
        .modal { background: var(--c-surface); border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: var(--sp-5); width: 100%; max-width: 460px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: var(--shadow-md); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); animation: pop-in 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-overlay--active .modal { transform: translateY(0); }
        @media (min-width: 500px) { .modal { border-radius: var(--border-radius-lg); } .modal-overlay--active .modal { transform: translateY(0) scale(1); } .modal { transform: translateY(20px) scale(0.95); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s; } }
        .modal__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--sp-3); flex-shrink: 0;}
        .modal__title { font-size: var(--fs-lg); font-weight: var(--fw-semibold); }
        .modal__body { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; padding-right: var(--sp-2); margin-right: calc(-1 * var(--sp-2)); }
        .modal__actions { display: flex; gap: var(--sp-3); justify-content: flex-end; margin-top: var(--sp-4); flex-shrink: 0; }
        .modal__list-item { display:flex; justify-content:space-between; align-items:center; padding: var(--sp-2) var(--sp-1); border-bottom:1px solid var(--c-surface-variant); }
        .modal__list-item:last-child { border-bottom: none; }
        #help-modal-content h3, #generic-modal-body h3 { font-size: var(--fs-lg); margin-top: 1.5em; margin-bottom: 0.75em; color: var(--c-primary); } #help-modal-content h4, #generic-modal-body h4 { font-size: var(--fs-base); margin-top: 1.25em; margin-bottom: 0.5em; font-weight: 600; } #help-modal-content p, #help-modal-content li, #generic-modal-body p, #help-modal-content small, #generic-modal-body ul li { color: var(--c-on-surface-secondary); line-height: 1.6; } #help-modal-content ul { list-style-position: inside; padding-left: var(--sp-2); } #help-modal-content ul li { margin-bottom: 8px; }
        #help-modal-content code { background-color: var(--c-surface-variant); padding: 2px 6px; border-radius: 4px; font-family: monospace; color: var(--c-on-surface); }
        #help-modal-content .pro-tip { border-left: 3px solid var(--c-info); padding-left: var(--sp-3); margin: var(--sp-4) 0; font-size: var(--fs-sm); }
        #ai-results-container h4 { margin-top: 1em; margin-bottom: 0.5em; color: var(--c-primary); } #ai-results-container ul { list-style-position: inside; } #ai-results-container li { margin-bottom: 8px; } #ai-results-container small { display: block; margin-top: 1.5em; font-style: italic; }

        .login-view { position: fixed; inset: 0; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: var(--sp-4); opacity: 0; transition: opacity .5s; background-color: var(--c-background); }
        .login-view--visible { display: flex; opacity: 1; }
        .login-view__card { background-color: var(--c-surface); padding: var(--sp-6); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md); width: 100%; max-width: 380px; text-align: center; animation: pop-in 0.3s ease-out; }
        .login-view__title { font-size: var(--fs-xl); font-weight: var(--fw-bold); margin-bottom: var(--sp-5); }
        
        .empty-state { text-align: center; padding: var(--sp-6) var(--sp-4); color: var(--c-on-surface-secondary); animation: fade-in 0.3s; }
        .empty-state .material-icons { font-size: 48px; margin-bottom: var(--sp-2); }
        .empty-state h3 { font-size: var(--fs-lg); font-weight: var(--fw-semibold); color: var(--c-on-surface); margin-bottom: var(--sp-2); }

        .filter-pills { display: flex; flex-wrap: wrap; gap: var(--sp-2); }
        .filter-pill { padding: var(--sp-1) var(--sp-3); border: 1px solid var(--c-outline); border-radius: 20px; font-size: var(--fs-xs); font-weight: var(--fw-medium); background-color: var(--c-surface-variant); color: var(--c-on-surface-secondary); cursor: pointer; transition: all 0.2s; }
        .filter-pill:hover { border-color: var(--c-primary); }
        .filter-pill--active { background-color: var(--c-primary); color: var(--c-white); border-color: var(--c-primary); }

        #movimiento-modal .modal__body { padding-right: var(--sp-1); margin-right: calc(-1 * var(--sp-1)); }
        #movimiento-modal .form-group { margin-bottom: var(--sp-2); }
        #movimiento-modal .form-label { margin-bottom: 4px; font-size: var(--fs-xs); }
        #movimiento-modal .form-input,
        #movimiento-modal .form-select { padding: var(--sp-2); font-size: var(--fs-sm); }
        #movimiento-modal .form-select { background-position: right 8px center; padding-right: 32px; }
        #movimiento-modal .form-group-addon .icon-btn { height: 34px; width: 34px; align-self: center; }
        #movimiento-modal .form-group-addon .form-group { margin-bottom: 0; }
        #movimiento-modal .modal__actions { margin-top: var(--sp-3); }
        
        .text-positive { color: var(--c-success); } .text-negative { color: var(--c-danger); } .text-warning { color: var(--c-warning); } .text-info { color: var(--c-info); }
        .hidden { display: none !important; }
        .spinner { display: inline-block; width: 1em; height: 1em; border: .15em solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin .8s linear infinite; vertical-align: middle; }
        @keyframes spin { to { transform:rotate(360deg); } }
    </style>
</head>
<body>

<div id="introScreen" class="intro-screen">
    <div class="starry-background"></div>
    <img id="splashImage" class="intro-screen__logo" src="aiDANaI-Cuentas.jpg" alt="Logo aiDANaI">
    <div id="quoteContainer" class="intro-screen__quote-container">
        <p id="quoteText" class="intro-screen__quote-text"></p>
        <span id="quoteAuthor" class="intro-screen__quote-author"></span>
    </div>
</div>

<div id="login-screen" class="login-view">
    <div class="login-view__card">
        <h2 id="login-title" class="login-view__title">💰 Cuentas aiDANaI</h2>
        <form id="login-form" novalidate>
            <div class="form-group"><input type="email" id="login-email" class="form-input" placeholder="Correo electrónico" required autocomplete="email" autocapitalize="none"><span class="form-error" id="login-email-error"></span></div>
            <div class="form-group"><input type="password" id="login-password" class="form-input" placeholder="Contraseña" required autocomplete="current-password"><span class="form-error" id="login-password-error"></span></div>
            <div class="form-grid" style="margin-top: 20px;">
                <button type="button" data-action="login" class="btn btn--primary">Iniciar Sesión</button>
                <button type="button" data-action="register" class="btn btn--secondary">Registrarse</button>
            </div>
            <p id="login-error" class="form-error" style="min-height: 20px; margin-top: 10px;"></p>
        </form>
    </div>
</div>

<div id="app-root" class="app-layout">
    <main class="app-layout__main">
        <section id="panel-control-page" class="view" role="region" aria-labelledby="panel-control-title">
            <header class="top-bar">
                <h1 id="panel-control-title" class="top-bar__title">Panel</h1>
                <div class="top-bar__actions">
                    <button data-action="ai-advisor" class="icon-btn" title="Asesor IA"><span class="material-icons">psychology_alt</span></button>
                    <button data-action="theme-toggle" class="icon-btn" title="Cambiar Tema"><span class="material-icons">light_mode</span></button>
                    <button data-action="logout" class="icon-btn" title="Cerrar Sesión"><span class="material-icons">logout</span></button>
                </div>
            </header>
            <div class="card">
                <h3 class="card__title"><span class="material-icons">filter_list</span>Filtros</h3>
                <div class="form-group"><label for="filter-periodo" class="form-label">Periodo</label><select id="filter-periodo" class="form-select"><option value="mes-actual">Mes Actual</option><option value="ano-actual">Año Actual</option><option value="siempre">Siempre</option><option value="custom">Personalizado</option></select></div>
                <div id="custom-date-filters" class="hidden form-grid"><div class="form-group"><label for="filter-fecha-inicio" class="form-label">Desde</label><input type="date" id="filter-fecha-inicio" class="form-input"></div><div class="form-group"><label for="filter-fecha-fin" class="form-label">Hasta</label><input type="date" id="filter-fecha-fin" class="form-input"></div></div>
                <div class="form-grid"><div class="form-group"><label for="filter-beneficiario" class="form-label">Propietario</label><select id="filter-beneficiario" class="form-select"></select></div><div class="form-group"><label for="filter-cuenta" class="form-label">Cuenta</label><select id="filter-cuenta" class="form-select"></select></div></div>
                <div class="form-group"><label for="filter-concepto" class="form-label">Concepto</label><select id="filter-concepto" class="form-select"></select></div>
                <button data-action="apply-filters" class="btn btn--primary btn--full">Aplicar Filtros</button>
            </div>
            <section id="kpi-container" class="kpi-grid" aria-label="Indicadores clave de rendimiento"></section>
            <div class="card">
                <h3 class="card__title"><span class="material-icons">category</span>Totales por Concepto</h3>
                <div id="concepto-totals-list"></div>
            </div>
        </section>

        <section id="movimientos-page" class="view" role="region" aria-labelledby="movimientos-title">
            <header class="top-bar">
                <h1 id="movimientos-title" class="top-bar__title">Movimientos</h1>
                <div class="top-bar__actions">
                    <input type="search" id="search-movimientos" class="form-input" placeholder="Buscar..." style="width: 160px; height: 38px;">
                </div>
            </header>
            <div id="movimientos-list-container"></div> <div id="empty-movimientos" class="empty-state hidden">
                <span class="material-icons">receipt_long</span>
                <h3>Sin Movimientos</h3>
                <p>Añade tu primer movimiento con el botón de abajo.</p>
            </div>
        </section>

        <section id="cuentas-page" class="view" role="region" aria-labelledby="cuentas-title">
            <header class="top-bar"><h1 id="cuentas-title" class="top-bar__title">Cuentas</h1></header>
            <div class="card">
                <h3 class="card__title"><span class="material-icons">person</span>Fondos Líquidos por Propietario</h3>
                <div class="form-group">
                    <label class="form-label">Filtrar por Tipo de Cuenta:</label>
                    <div id="filter-account-types-pills" class="filter-pills"></div>
                </div>
                <div id="resumen-propietario-container"></div>
            </div>
            <div class="card">
                <h3 class="card__title"><span class="material-icons">account_balance</span>Desglose de Patrimonio Neto</h3>
                <div id="cuentas-accordion-container"></div>
            </div>
        </section>

        <section id="presupuestos-page" class="view" role="region" aria-labelledby="presupuestos-title">
            <header class="top-bar"><h1 id="presupuestos-title" class="top-bar__title">Presupuestos</h1></header>
            <div class="card">
                <h3 class="card__title"><span class="material-icons">add_circle_outline</span>Nuevo Presupuesto</h3>
                <form id="form-presupuesto" novalidate>
                    <div class="form-grid"><div class="form-group"><label for="presupuesto-ano" class="form-label">Año</label><input type="number" id="presupuesto-ano" required placeholder="2025" min="2000" max="2100" class="form-input"><span class="form-error" id="presupuesto-ano-error"></span></div><div class="form-group"><label for="presupuesto-beneficiario-p" class="form-label">Propietario</label><select id="presupuesto-beneficiario-p" required class="form-select"></select><span class="form-error" id="presupuesto-beneficiario-p-error"></span></div></div>
                    <div class="form-group"><label for="presupuesto-concepto" class="form-label">Concepto</label><select id="presupuesto-concepto" required class="form-select"></select><span class="form-error" id="presupuesto-concepto-error"></span></div>
                    <div class="form-group"><label for="presupuesto-cantidad" class="form-label">Límite Gasto Anual</label><input type="text" id="presupuesto-cantidad" inputmode="decimal" required placeholder="1.200,00" class="form-input"><span class="form-error" id="presupuesto-cantidad-error"></span></div>
                    <button type="submit" class="btn btn--primary btn--full">Guardar Presupuesto</button>
                </form>
            </div>
            <div class="card">
                <h3 class="card__title"><span class="material-icons">track_changes</span>Seguimiento Anual</h3>
                <div id="presupuestos-list"></div>
                <div id="empty-presupuestos" class="empty-state hidden"><span class="material-icons">pie_chart_outline</span><h3>Sin Presupuestos</h3><p>Crea tu primer presupuesto para empezar.</p></div>
            </div>
        </section>

        <section id="configuracion-page" class="view" role="region" aria-labelledby="config-title">
            <header class="top-bar"><h1 id="config-title" class="top-bar__title">Configuración</h1></header>
            <div class="card">
                <h3 class="card__title"><span class="material-icons">badge</span>Configuración General</h3>
                <div class="form-group"><label for="config-beneficiarios" class="form-label">Propietarios (separados por coma)</label><input type="text" id="config-beneficiarios" placeholder="Dani, Norma, Común" class="form-input"><span class="form-error" id="config-beneficiarios-error"></span></div>
                <button data-action="save-config" class="btn btn--primary btn--full">Guardar Configuración</button>
            </div>
            <div class="card">
                <h3 class="card__title"><span class="material-icons">edit_note</span>Gestión de Cuentas / Conceptos</h3>
                <div class="form-grid">
                    <button data-action="manage-cuentas" class="btn btn--secondary"><span class="material-icons" style="font-size: 18px;">account_balance</span>Cuentas</button>
                    <button data-action="manage-conceptos" class="btn btn--secondary"><span class="material-icons" style="font-size: 18px;">category</span>Conceptos</button>
                </div>
            </div>
            <div class="card">
                <h3 class="card__title"><span class="material-icons">backup</span>Gestión de Datos</h3>
                <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-top: calc(-1 * var(--sp-2)); margin-bottom: var(--sp-4);">Importar reemplazará todos los datos actuales.</p>
                <div class="form-grid">
                    <button data-action="export-data" class="btn btn--secondary"><span class="material-icons" style="font-size: 18px;">file_download</span>Exportar</button>
                    <button data-action="import-data" class="btn btn--secondary"><span class="material-icons" style="font-size: 18px;">file_upload</span>Importar</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
                <button data-action="clear-data" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);">Borrar Todos los Datos</button>
            </div>
             <div class="card">
                <h3 class="card__title"><span class="material-icons">help_outline</span>Ayuda</h3>
                <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-top: calc(-1 * var(--sp-2)); margin-bottom: var(--sp-4);">
                    Consulta la guía de usuario y las últimas novedades.
                </p>
                <button data-action="help" class="btn btn--secondary btn--full">
                    <span class="material-icons" style="font-size: 18px;">menu_book</span>Ver Guía Completa
                </button>
            </div>
        </section>
    </main>

    <button data-action="add-movement" id="fab-add-movimiento" class="fab" title="Añadir Movimiento" aria-label="Añadir Movimiento"><span class="material-icons">add</span></button>
    <nav class="bottom-nav">
        <button data-action="navigate" data-page="panel-control-page" class="bottom-nav__item"><span class="material-icons">dashboard</span><span class="bottom-nav__label">Panel</span></button>
        <button data-action="navigate" data-page="movimientos-page" class="bottom-nav__item"><span class="material-icons">swap_horiz</span><span class="bottom-nav__label">Movim.</span></button>
        <button data-action="navigate" data-page="cuentas-page" class="bottom-nav__item"><span class="material-icons">account_balance_wallet</span><span class="bottom-nav__label">Cuentas</span></button>
        <button data-action="navigate" data-page="presupuestos-page" class="bottom-nav__item"><span class="material-icons">pie_chart</span><span class="bottom-nav__label">Presup.</span></button>
        <button data-action="navigate" data-page="configuracion-page" class="bottom-nav__item"><span class="material-icons">settings</span><span class="bottom-nav__label">Config.</span></button>
    </nav>
</div>

<div id="toast-container" class="toast-container" aria-live="assertive"></div>
<div id="movimiento-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="form-movimiento-title">
    <div class="modal">
        <header class="modal__header">
            <h3 id="form-movimiento-title" class="modal__title">Añadir Movimiento</h3>
            <button class="icon-btn" data-action="close-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
        </header>
        <div class="modal__body">
             <form id="form-movimiento" novalidate>
                <input type="hidden" id="movimiento-id">
                <div class="form-group"><label for="movimiento-tipo-selector" class="form-label">Tipo</label><select id="movimiento-tipo-selector" class="form-select"><option value="movimiento">Movimiento</option><option value="traspaso">Traspaso</option></select></div>
                <div class="form-grid"><div class="form-group"><label for="movimiento-cantidad" class="form-label">Cantidad (gasto en negativo)</label><input type="text" id="movimiento-cantidad" class="form-input" inputmode="decimal" required placeholder="Ej: -50,25"><span class="form-error" id="movimiento-cantidad-error"></span></div><div class="form-group"><label for="movimiento-fecha" class="form-label">Fecha y Hora</label><input type="datetime-local" id="movimiento-fecha" class="form-input" required><span class="form-error" id="movimiento-fecha-error"></span></div></div>
                <div class="form-group"><label for="movimiento-descripcion" class="form-label">Descripción</label><input type="text" id="movimiento-descripcion" class="form-input" required placeholder="Ej: Compra semanal"><span class="form-error" id="movimiento-descripcion-error"></span></div>
                <div id="movimiento-fields">
                    <div class="form-group-addon"><div class="form-group"><label for="movimiento-concepto" class="form-label">Concepto</label><select id="movimiento-concepto" class="form-select" required></select><span class="form-error" id="movimiento-concepto-error"></span></div><button type="button" data-action="manage-conceptos" class="icon-btn" title="Gestionar Conceptos"><span class="material-icons">more_vert</span></button></div>
                    <div class="form-group-addon"><div class="form-group"><label for="movimiento-cuenta" class="form-label">Cuenta</label><select id="movimiento-cuenta" class="form-select" required></select><span class="form-error" id="movimiento-cuenta-error"></span></div><button type="button" data-action="manage-cuentas" class="icon-btn" title="Gestionar Cuentas"><span class="material-icons">more_vert</span></button></div>
                    <div class="form-group"><label for="movimiento-beneficiario" class="form-label">Propietario</label><select id="movimiento-beneficiario" class="form-select" required></select><span class="form-error" id="movimiento-beneficiario-error"></span></div>
                </div>
                <div id="traspaso-fields" class="hidden form-grid"><div class="form-group"><label for="movimiento-cuenta-origen" class="form-label">Origen</label><select id="movimiento-cuenta-origen" class="form-select" required></select><span class="form-error" id="movimiento-cuenta-origen-error"></span></div><div class="form-group"><label for="movimiento-cuenta-destino" class="form-label">Destino</label><select id="movimiento-cuenta-destino" class="form-select" required></select><span class="form-error" id="movimiento-cuenta-destino-error"></span></div></div>
                <div class="modal__actions"><button type="button" data-action="delete-movement-from-modal" id="delete-movimiento-btn" class="btn btn--danger hidden" style="margin-right: auto;" title="Eliminar"><span class="material-icons">delete</span></button><button type="submit" id="save-movimiento-btn" class="btn btn--primary">Guardar</button></div>
             </form>
        </div>
    </div>
</div>
<div id="generic-modal" class="modal-overlay">
    <div class="modal">
        <header class="modal__header"><h3 id="generic-modal-title" class="modal__title"></h3><button class="icon-btn" data-action="close-modal" title="Cerrar"><span class="material-icons">close</span></button></header>
        <div id="generic-modal-body" class="modal__body"></div>
    </div>
</div>
<div id="ai-advisor-modal" class="modal-overlay">
    <div class="modal">
        <header class="modal__header"><h3 id="ai-advisor-modal-title" class="modal__title">🤖 Asesor de Inversión IA</h3><button class="icon-btn" data-action="close-modal" title="Cerrar"><span class="material-icons">close</span></button></header>
        <div id="ai-advisor-modal-body" class="modal__body">
            <form id="ai-advisor-form" novalidate>
                <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-4);">Selecciona un usuario, los meses a analizar y su perfil de riesgo para recibir un análisis de su capacidad de ahorro y sugerencias de inversión personalizadas.</p>
                <div class="form-group"><label for="ai-user-select" class="form-label">Usuario a analizar</label><select id="ai-user-select" class="form-select" required></select></div>
                <div class="form-group"><label for="ai-months-study" class="form-label">Meses a estudiar</label><input type="number" id="ai-months-study" class="form-input" required value="6" min="1" max="60"></div>
                <div class="form-group"><label for="ai-risk-level" class="form-label">Nivel de Riesgo Asumido</label><select id="ai-risk-level" class="form-select" required><option value="Bajo">Bajo (Conservador)</option><option value="Medio">Medio (Moderado)</option><option value="Alto">Alto (Agresivo)</option></select></div>
                <div class="modal__actions"><button type="submit" class="btn btn--primary">Analizar y Sugerir</button></div>
            </form>
            <div id="ai-results-container" class="hidden" style="margin-top: var(--sp-4);"></div>
        </div>
    </div>
</div>


<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // =================================================================================
    // 1. STATE & GLOBAL VARIABLES
    // =================================================================================
    const quotesData = [ { "cita": "Los inversores conservadores duermen bien.", "autor": "Benjamin Graham" }, { "cita": "Nunca asciendas a alguien que no ha cometido errores, porque si lo haces, estás ascendiendo a alguien que nunca ha hecho nada.", "autor": "Benjamin Graham" }, { "cita": "Si se han hecho los deberes antes de comprar una acción, el momento de venderla es: normalmente, nunca.", "autor": "Benjamin Graham" }, { "cita": "Mientras que el entusiasmo é necessario para conseguir grandes logros en cualquier lugar, en Wall Street suele conducir al desastre.", "autor": "John Templeton" }, { "cita": "Sin tener fe en el futuro, nadie invertiría. Para ser inversor, debes creer en un mañana mejor.", "autor": "John Templeton" }, { "cita": "Las cuatro palabras más caras de nuestro lenguaje son: 'Esta vez es diferente'.", "autor": "John Templeton" }, { "cita": "Céntrate en el valor porque la mayoría de los inversores se fijan en perspectivas y tendencias.", "autor": "Peter Lynch" }, { "cita": "El éxito es un proceso de búsqueda continua de respuestas a nuevas preguntas.", "autor": "Peter Lynch" }, { "cita": "Conoce en lo que inviertes, y por qué.", "autor": "Peter Lynch" }, { "cita": "Cuando vendes en momentos de desesperación, siempre vendes barato.", "autor": "Peter Lynch" }, { "cita": "Una persona que posee una propiedad y tiene una participación en la empresa probablemente trabajará más duro, se sentirá más feliz y hará un mejor trabajo que otra que no tiene nada.", "autor": "Peter Lynch" }, { "cita": "El riesgo viene de no saber lo que se está haciendo.", "autor": "Warren Buffett" }, { "cita": "Cuesta 20 años construir una reputación y 5 minutos destruirla. Si piensas sobre ello, harás las cosas de manera diferente.", "autor": "Warren Buffett" }, { "cita": "En el mundo de los negocios, el espejo retrovisor está siempre más claro que el parabrisas.", "autor": "Warren Buffett" }, { "cita": "La inversión más importante que puedes hacer es en uno mismo.", "autor": "Warren Buffett" }, { "cita": "Sé temeroso cuando otros sean avariciosos, sé avaricioso cuando otros sean temerosos.", "autor": "Warren Buffett" }, { "cita": "Sé consciente de lo que no sabes. Siéntete a gusto entendiendo tus errores y debilidades.", "autor": "Charlie Munger" }, { "cita": "Para hacer dinero en los mercados, tienes que pensar diferente y ser humilde.", "autor": "Charlie Munger" }, { "cita": "El principal problema del inversor, e incluso su peor enemigo, es probablemente él mismo", "autor": "Benjamin Graham" }, { "cita": "Las personas que no pueden controlar sus emociones no son aptas para obtener beneficios mediante la inversión", "autor": "Benjamin Graham" }, { "cita": "Trato de comprar acciones en los negocios que son tan maravillosos que un tonto podría manejarlos. Tarde o temprano uno lo hará", "autor": "Warren Buffett" }, { "cita": "Un inversor debería actuar como si tuviera una tarjeta con sólo 20 decisiones (de compra) para tomar a lo largo de su vida", "autor": "Warren Buffett" }, { "cita": "Regla número 1: nunca pierdas dinero. Regla número 2: nunca olvides la regla número 1", "autor": "Warren Buffett" }, { "cita": "Se gana dinero descontando lo obvio y apostando a lo inesperado", "autor": "George Soros" }, { "cita": "El problema no es lo que uno no sabe, sino lo que uno cree que sabe estando equivocado", "autor": "George Soros" }, { "cita": "Si invertir es entretenido, si te estás divirtiendo, probablemente no estés ganando dinero. Las buenas inversiones son aburridas", "autor": "George Soros" }, { "cita": "Se puede perder dinero a corto plazo, pero necesitas del largo plazo para ganar dinero", "autor": "Peter Lynch" }, { "cita": "La mejor empresa para comprar puede ser alguna que ya tienes en cartera", "autor": "Peter Lynch" }, { "cita": "La clave para ganar dinero con las acciones es no tenerles miedo", "autor": "Peter Lynch" }, { "cita": "Los mercados alcistas nacen en el pesimismo, crecen en el escepticismo, maduran en el optimismo y mueren en la euforia", "autor": "John Templeton" }, { "cita": "El momento de máximo pesimismo es el mejor para comprar y el momento de máximo optimismo es el mejor para vender", "autor": "John Templeton" }, { "cita": "Un inversor que tiene todas las respuestas ni siquiera entiende las preguntas", "autor": "John Templeton" }, { "cita": "La inversión es un negocio a largo plazo donde la paciencia marca la rentabilidad", "autor": "Francisco García Paramés" }, { "cita": "¿Cuándo vendemos un valor?, respondemos siempre: cuando haya una oportunidad mejor. Ese es nuestro objetivo permanente, mejorar la cartera cada día", "autor": "Francisco García Paramés" }, { "cita": "Lo que en la Bolsa saben todos, no me interesa", "autor": "André Kostolany" }, { "cita": "No sirve para nada proclamar la verdad en economía o recomendar cosas útiles. Es la mejor manera de hacerse enemigos", "autor": "André Kostolany" }, { "cita": "Un inversionista pierde la capacidad de raciocinio cuando gana los primeros diez mil dólares. A partir de entonces se convierte en un pelele fácilmente manipulable", "autor": "André Kostolany" }, { "cita": "Comprar títulos, acciones de empresas, tomarse unas pastillas para dormir durante 20/30 años y cuando uno despierta, voilà! es millonario", "autor": "André Kostolany" }, { "cita": "No sé si los próximos 1.000 puntos del Dow Jones serán hacia arriba o hacia abajo, pero estoy seguro de que los próximos 10.000 serán hacia arriba", "autor": "Peter Lynch" }, { "cita": "El destino de un inversor lo marca su estómago , no su cerebro", "autor": "Peter Lynch" }, { "cita": "No siga mis pasos porque aún en el caso de que acierte al comprar usted no sabrá cuándo vendo", "autor": "Peter Lynch" }, { "cita": "Calcule las 'ganancias del dueño' para conseguir una reflexión verdadera del valor", "autor": "Warren Buffett" }, { "cita": "Busque compañías con altos márgenes de beneficio", "autor": "Warren Buffett" }, { "cita": "Invierta siempre para el largo plazo", "autor": "Warren Buffett" }, { "cita": "El consejo de que 'usted nunca quiebra tomando un beneficio' es absurdo", "autor": "Warren Buffett" }, { "cita": "¿El negocio tiene una historia de funcionamiento constante?", "autor": "Warren Buffett" }, { "cita": "Recuerde que el mercado de valores es maniaco-depresivo", "autor": "Benjamin Graham" }, { "cita": "Compre un negocio, no alquile la acción", "autor": "Warren Buffett" }, { "cita": "Mientras más absurdo sea el comportamiento del mercado mejor será la oportunidad para el inversor metódico", "autor": "Benjamin Graham" }, { "cita": "Se puede perder dinero a corto plazo, pero usted sigue siendo un idiota", "autor": "Joel Greenblatt" }, { "cita": "Los mercados alcistas no tienen resistencia y los bajistas no tienen soporte", "autor": "Ed Downs" }, { "cita": "El pánico causa que vendas en el bajón, y la codicia causa que compres cerca a la cima", "autor": "Stan Weinstein" }, { "cita": "Las dos grandes fuerzas que mueven los mercados son la codicia y el miedo", "autor": "Anónimo" }, { "cita": "Todo lo que sube baja y todo lo que baja sube", "autor": "Anónimo" }, { "cita": "Si no sientes miedo en el momento de comprar es que estás comprando mal", "autor": "Anónimo" }, { "cita": "Que el último duro lo gane otro", "autor": "Anónimo" }, { "cita": "La clave para hacer dinero en acciones es no asustarse de ellas", "autor": "Peter Lynch" }, { "cita": "El precio es lo que pagas, el valor es lo que recibes", "autor": "Warren Buffett" }, { "cita": "No es necesario hacer cosas extraordinarias para conseguir resultados extraordinarios", "autor": "Warren Buffett" }, { "cita": "Alguien está sentado en la sombra hoy porque alguien plantó un árbol mucho tiempo atrás", "autor": "Warren Buffett" }, { "cita": "Únicamente cuando la marea baja, descubres quién ha estado nadando desnudo", "autor": "Warren Buffett" }, { "cita": "No tenemos que ser más inteligentes que el resto, tenemos que ser más disciplinados que el resto", "autor": "Warren Buffett" }, { "cita": "Si compras cosas que no necesitas, pronto tendrás que vender cosas que necesitas", "autor": "Warren Buffett" }, { "cita": "Nunca inviertas en un negocio que no puedas entender", "autor": "Warren Buffett" }, { "cita": "El tiempo es amigo de las empresas maravillosas y enemigo de las mediocres", "autor": "Warren Buffett" }, { "cita": "Nuestro período de espera favorito es para siempre", "autor": "Warren Buffett" }, { "cita": "Wall Street es el único lugar al que las personas van en un Rolls-Royce, para recibir asesoría de quienes toman el metro", "autor": "Warren Buffett" }, { "cita": "Llega un momento en el que debes empezar a hacer lo que realmente quieres. Busca un trabajo que te guste y saltarás de la cama cada mañana con fuerza", "autor": "Warren Buffett" }, { "cita": "Es siempre mejor pasar el tiempo con gente mejor que tú. Escoge asociados cuyo comportamiento es mejor que el tuyo e irás en esa dirección", "autor": "Warren Buffett" }, { "cita": "Toma 20 años en construir una reputación y 5 minutos en arruinarla. Si piensas sobre ello, harás las cosas de forma diferente", "autor": "Warren Buffett" }, { "cita": "No importa el talento o los esfuerzos, hay cosas que llevan tiempo. No puedes producir un bebé en un mes dejando embarazadas a 9 mujeres", "autor": "Warren Buffett" }, { "cita": "Las oportunidades aparecen pocas veces. Cuando llueva oro sal a la calle con un cesto grande y no con un dedal", "autor": "Warren Buffett" }, { "cita": "La gente siempre me pregunta dónde deberían trabajar y yo siempre les digo que vayan a trabajar con aquellos a los que más admiran", "autor": "Warren Buffett" }, { "cita": "¿Cuando hay que vender una acción? Pues cuando tengamos una oportunidad mejor a la vista", "autor": "Francisco García Paramés" }, { "cita": "Nunca acudo a las OPV, me gusta estar en las empresas que pueden ser opadas por competidores, no en las salidas a bolsa", "autor": "Francisco García Paramés" }, { "cita": "Si en el mercado hay más tontos que papel, la bolsa va to subir, si hay más papel que tontos, la bolsa baja", "autor": "André Kostolany" }, { "cita": "No persiga nunca una acción, tenga paciencia que la próxima oportunidad va a llegar con toda seguridad", "autor": "André Kostolany" }, { "cita": "Lo que todos saben en la bolsa, no nos interesa a los especuladores", "autor": "André Kostolany" }, { "cita": "Las inversiones exitosas consisten en saber gestionar el riesgo, no en evitarlo.", "autor": "Benjamin Graham" }, { "cita": "Una gran compañía no es una buena inversión si pagas mucho por la acción", "autor": "Benjamin Graham" }, { "cita": "A veces es mejor pensar una hora sobre el dinero que dedicar una semana a trabajar para obtenerlo.", "autor": "André Kostolany" }, { "cita": "En la Bolsa, con frecuencia, hay que cerrar los ojos para ver mejor.", "autor": "André Kostolany" }, { "cita": "Si la inversión es entretenida, si te estás divirtiendo, es probable que no estés ganando dinero. Una buena inversión es aburrida.", "autor": "George Soros" }, { "cita": "Las burbujas del mercado de valores no crecen de la nada. Tienen una base sólida en la realidad, pero la realidad está distorsionada por un malentendido.", "autor": "George Soros" }, { "cita": "Nunca digas que no puedes permitirte algo. Esa es la aptitud de un hombre pobre. Pregúntate cómo permitírtelo.", "autor": "Robert Kiyosaki" }, { "cita": "Una diferencia importante es que los ricos compran los lujos a final, mientras que los pobres y la clase media tienden a comprar los lujos primero.", "autor": "Robert Kiyosaki" }, { "cita": "Mantén tus activos bajo mínimos, reduce los pasivos y, con mucha disciplina, ve construyendo una base de activos sólida.", "autor": "Robert Kiyosaki" }, { "cita": "No ahorres lo que queda después de gastar, sino gasta lo que queda después de ahorrar.", "autor": "Warren Buffett" }, { "cita": "El riesgo viene de no saber lo que estás haciendo.", "autor": "Warren Buffett" }, { "cita": "Sea temeroso cuando otros son codiciosos, y sea codicioso cuando otros son temerosos.", "autor": "Warren Buffett" }, { "cita": "No compres cosas que no necesitas, con dinero que no tienes, para impresionar a gente que no te importa.", "autor": "Dave Ramsey" } ];
    const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };
    let currentUser = null, unsubscribeFromDb = null, saveTimeout = null, db = {}, deselectedAccountTypesFilter = new Set();
    const originalButtonTexts = new Map();
    let vList = { container: null, items: [], itemHeight: 82, sizer: null, content: null, lastRendered: { start: -1 } };

    // =================================================================================
    // 2. FIREBASE & DATA HANDLING
    // =================================================================================
    firebase.initializeApp(firebaseConfig);
    const fbAuth = firebase.auth(), fbDb = firebase.firestore();
    const getInitialDb = () => ({ cuentas: [], conceptos: [], movimientos: [], presupuestos: [], config: { beneficiarios: ["Dani", "Norma", "Común"] } });
    const saveData = (buttonElement = null, successCallback = () => {}) => {
        if (!currentUser) { showToast("Error: No hay usuario autenticado.", "danger"); return; }
        clearTimeout(saveTimeout);
        if (buttonElement) setButtonLoading(buttonElement, true, 'Guardando...');
        saveTimeout = setTimeout(() => {
            fbDb.collection('users').doc(currentUser.uid).set({ db })
                .then(() => { if (buttonElement) setButtonLoading(buttonElement, false); successCallback(); })
                .catch(error => { console.error("Error al guardar datos:", error); showToast("Error al guardar.", "danger"); if (buttonElement) setButtonLoading(buttonElement, false); });
        }, 300);
    };
    const loadData = uid => {
        const userDocRef = fbDb.collection('users').doc(uid);
        if (unsubscribeFromDb) unsubscribeFromDb();
        unsubscribeFromDb = userDocRef.onSnapshot(doc => {
            let dataNeedsMigration = false;
            if (doc.exists && doc.data().db) {
                db = doc.data().db;
                if (!db.presupuestos) { db.presupuestos = []; dataNeedsMigration = true; }
                if (!db.config?.beneficiarios?.length) { db.config = { beneficiarios: ["Dani", "Norma", "Común"] }; dataNeedsMigration = true; }
                if ((db.movimientos || []).some(m => !Number.isInteger(m.cantidad))) { (db.movimientos || []).forEach(m => m.cantidad = Math.round((parseFloat(m.cantidad) || 0) * 100)); dataNeedsMigration = true; showToast("Migrando datos de movimientos...", "info"); }
                if ((db.presupuestos || []).some(p => !Number.isInteger(p.cantidad))) { (db.presupuestos || []).forEach(p => p.cantidad = Math.round((parseFloat(p.cantidad) || 0) * 100)); dataNeedsMigration = true; showToast("Migrando datos de presupuestos...", "info"); }
            } else { db = getInitialDb(); dataNeedsMigration = true; }
            if (dataNeedsMigration) saveData();
            startMainApp();
        }, error => { console.error("Error con Firestore:", error); showToast("Error de conexión.", "danger"); });
    };

    // =================================================================================
    // 3. UI UTILITIES & HELPERS
    // =================================================================================
    const select = id => document.getElementById(id), selectAll = s => document.querySelectorAll(s);
    const vibrate = (d=10) => { if ('vibrate' in navigator) { try { navigator.vibrate(d); } catch (e) {} } };
    const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
    const formatCurrency = numInCents => ((numInCents || 0) / 100).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const showToast = (message, type = 'default', duration = 3000) => {
        const c = select('toast-container'); if (!c) return;
        const t = document.createElement('div'); t.className = `toast toast--${type}`; t.textContent = message; t.style.animation = `pop-in 0.3s, fade-in 0.3s ${duration / 1000 - 0.3}s reverse forwards`; c.appendChild(t); setTimeout(() => t.remove(), duration);
    };
    const setButtonLoading = (btn, isLoading, text = 'Cargando...') => {
        if (!btn) return;
        if (isLoading) { if (!originalButtonTexts.has(btn)) originalButtonTexts.set(btn, btn.innerHTML); btn.disabled = true; btn.classList.add('btn--loading'); btn.innerHTML = `<span class="spinner"></span> <span>${text}</span>`;
        } else { btn.disabled = false; btn.classList.remove('btn--loading'); if (originalButtonTexts.has(btn)) { btn.innerHTML = originalButtonTexts.get(btn); originalButtonTexts.delete(btn); } }
    };
    const displayError = (id, msg) => { const err = select(`${id}-error`); if (err) { err.textContent = msg; err.setAttribute('role', 'alert'); } const inp = select(id); if (inp) inp.classList.add('form-input--invalid'); };
    const clearError = id => { const err = select(`${id}-error`); if (err) { err.textContent = ''; err.removeAttribute('role'); } const inp = select(id); if (inp) inp.classList.remove('form-input--invalid'); };
    const clearAllErrors = formId => { const f = select(formId); if (!f) return; f.querySelectorAll('.form-error').forEach(e => e.textContent = ''); f.querySelectorAll('.form-input--invalid').forEach(e => e.classList.remove('form-input--invalid')); };

    // =================================================================================
    // 4. APP INITIALIZATION & AUTH
    // =================================================================================
    const initApp = async () => {
        setupTheme();
        attachEventListeners();
        const intro = select('introScreen'), quoteContainer = select('quoteContainer');
        
        // MODIFICACIÓN: Timings ajustados para la nueva animación
        await wait(1000); // Muestra la cita antes
        if (intro && quoteContainer && quotesData.length) {
            const r = quotesData[Math.floor(Math.random() * quotesData.length)];
            select('quoteText').textContent = `"${r.cita}"`;
            select('quoteAuthor').textContent = `— ${r.autor}`;
            quoteContainer.classList.add('visible');
            await wait(3500); // Espera un total de 4.5s
            intro.style.opacity = '0';
            await wait(750); 
            intro.remove();
        } else if (intro) { intro.remove(); }
        checkAuthState();
    };
    const checkAuthState = () => fbAuth.onAuthStateChanged(user => { if (user) { currentUser = user; loadData(user.uid); } else { currentUser = null; if (unsubscribeFromDb) unsubscribeFromDb(); db = getInitialDb(); showLoginScreen(); } });
    const startMainApp = () => { select('login-screen').classList.remove('login-view--visible'); select('app-root').classList.add('app-layout--visible'); renderAll(); navigateTo('panel-control-page', true); };
    const showLoginScreen = () => { select('app-root').classList.remove('app-layout--visible'); select('login-screen').classList.add('login-view--visible'); };
    const handleLogin = btn => {
        vibrate();
        const email = select('login-email').value.trim(), password = select('login-password').value, errEl = select('login-error'); clearAllErrors('login-form'); errEl.textContent = ''; let v = true;
        if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
        if (!password) { displayError('login-password', 'La contraseña es obligatoria.'); v = false; }
        if (!v) return; setButtonLoading(btn, true, 'Iniciando...');
        fbAuth.signInWithEmailAndPassword(email, password).then(() => showToast(`¡Bienvenido/a de nuevo!`)).catch(err => { setButtonLoading(btn, false); if (['auth/wrong-password', 'auth/user-not-found', 'auth/invalid-credential'].includes(err.code)) errEl.textContent = 'Error: Credenciales incorrectas.'; else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no válido.'); else errEl.textContent = 'Error al iniciar sesión.'; });
    };
    const handleRegister = btn => {
        vibrate();
        const email = select('login-email').value.trim(), password = select('login-password').value, errEl = select('login-error'); clearAllErrors('login-form'); errEl.textContent = ''; let v = true;
        if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
        if (password.length < 6) { displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); v = false; }
        if (!v) return; setButtonLoading(btn, true, 'Registrando...');
        fbAuth.createUserWithEmailAndPassword(email, password).then(() => showToast(`¡Registro completado!`)).catch(err => { setButtonLoading(btn, false); if (err.code == 'auth/weak-password') displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); else if (err.code == 'auth/email-already-in-use') displayError('login-email', 'El correo ya está registrado.'); else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no válido.'); else errEl.textContent = 'Error en el registro.'; });
    };
    const handleLogout = () => { vibrate(); fbAuth.signOut().then(() => { showToast("Sesión cerrada."); window.location.href = 'https://danijdzg.github.io/aiDANaI/menu/'; }).catch(() => showToast("Error al cerrar sesión.", "danger")); };
    
    // =================================================================================
    // 5. NAVIGATION & UI CONTROL
    // =================================================================================
    const navigateTo = (pageId, isInitial = false) => {
        if (!isInitial) vibrate();
        selectAll('.view').forEach(p => p.classList.remove('view--active'));
        select(pageId)?.classList.add('view--active');
        selectAll('.bottom-nav__item').forEach(b => {
            b.classList.toggle('bottom-nav__item--active', b.dataset.page === pageId);
            if (b.dataset.page === pageId) b.setAttribute('aria-current', 'page'); else b.removeAttribute('aria-current');
        });
        const fabVisiblePages = ['panel-control-page', 'movimientos-page', 'cuentas-page', 'presupuestos-page'];
        select('fab-add-movimiento').classList.toggle('fab--visible', fabVisiblePages.includes(pageId));
    };
    const setupTheme = () => { const theme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', theme); selectAll('button[data-action="theme-toggle"] .material-icons').forEach(icon => icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode'); };
    const toggleTheme = () => { vibrate(); const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); setupTheme(); };
    
    // =================================================================================
    // 6. CORE LOGIC & CALCULATIONS
    // =================================================================================
    const getLiquidAccounts = () => (db.cuentas || []).filter(c => !['PROPIEDAD', 'PRÉSTAMO'].includes((c.tipo || '').trim().toUpperCase()));
    const getSaldos = () => {
        const saldos = (db.cuentas || []).reduce((acc, c) => ({ ...acc, [c.id]: 0 }), {});
        (db.movimientos || []).forEach(m => {
            if (m.tipo === 'traspaso') { if (saldos[m.cuentaOrigenId] !== undefined) saldos[m.cuentaOrigenId] -= m.cantidad; if (saldos[m.cuentaDestinoId] !== undefined) saldos[m.cuentaDestinoId] += m.cantidad;
            } else { if (saldos[m.cuentaId] !== undefined) saldos[m.cuentaId] += m.cantidad; }
        }); return saldos;
    };
    const getFilteredMovements = () => {
        const p = select('filter-periodo').value, b = select('filter-beneficiario').value, cId = select('filter-cuenta').value, coId = select('filter-concepto').value; let sDate, eDate, now = new Date();
        switch (p) { case 'mes-actual': sDate=new Date(now.getFullYear(),now.getMonth(),1); eDate=new Date(now.getFullYear(),now.getMonth()+1,0,23,59,59,999); break; case 'ano-actual': sDate=new Date(now.getFullYear(),0,1); eDate=new Date(now.getFullYear(),11,31,23,59,59,999); break; case 'custom': const sVal=select('filter-fecha-inicio').value, eVal=select('filter-fecha-fin').value; sDate=sVal?new Date(sVal):null; if(sDate)sDate.setHours(0,0,0,0); eDate=eVal?new Date(eVal):null; if(eDate)eDate.setHours(23,59,59,999); break; default: sDate=null; eDate=null; break; }
        let f = db.movimientos || [];
        if (sDate && eDate) f = f.filter(m => { const d = new Date(m.fecha); return d >= sDate && d <= eDate; });
        if (b) f = f.filter(m => m.beneficiario === b); if (coId) f = f.filter(m => m.conceptoId === coId);
        if (cId) f = f.filter(m => m.cuentaId === cId || m.cuentaOrigenId === cId || m.cuentaDestinoId === cId);
        return f.filter(m => ['movimiento', 'traspaso'].includes(m.tipo));
    };

    // =================================================================================
    // 7. RENDERING & VIRTUALIZATION ENGINE
    // =================================================================================
    const renderAll = () => { if (!db || !currentUser) return; populateAllDropdowns(); renderMovimientos(); renderCuentas(); renderPresupuestos(); loadConfig(); updateDashboard(); };
    const populateAllDropdowns = () => {
        const populate = (id, data, nameKey, valKey='id', all=false, none=false) => {
            const el = select(id); if (!el) return; const currentVal = el.value;
            let opts = all ? '<option value="">Todos</option>' : ''; if (none) opts += '<option value="">Ninguno</option>';
            [...data].sort((a,b) => (a[nameKey]||"").localeCompare(b[nameKey]||"")).forEach(i => opts += `<option value="${i[valKey]}">${i[nameKey]}</option>`);
            el.innerHTML = opts; el.value = Array.from(el.options).some(o=>o.value===currentVal) ? currentVal : (el.options[0]?.value || "");
        };
        const owners = (db.config?.beneficiarios || []).map(b => ({id:b, nombre:b}));
        populate('movimiento-beneficiario', owners, 'nombre', 'id'); populate('presupuesto-beneficiario-p', owners, 'nombre', 'id'); populate('filter-beneficiario', owners, 'nombre', 'id', true);
        populate('movimiento-cuenta', db.cuentas, 'nombre', 'id', false, true); populate('movimiento-cuenta-origen', db.cuentas, 'nombre', 'id', false, true); populate('movimiento-cuenta-destino', db.cuentas, 'nombre', 'id', false, true);
        populate('filter-cuenta', db.cuentas, 'nombre', 'id', true); populate('movimiento-concepto', db.conceptos, 'nombre', 'id', false, true);
        populate('presupuesto-concepto', db.conceptos, 'nombre', 'id'); populate('filter-concepto', db.conceptos, 'nombre', 'id', true);
    };

    const initVirtualizedList = (items) => {
        vList.container = select('movimientos-list-container');
        if (!vList.container) return;
        
        vList.container.innerHTML = `<div id="virtual-list-sizer"><div id="virtual-list-content"></div></div>`;
        vList.sizer = select('virtual-list-sizer');
        vList.content = select('virtual-list-content');
        
        vList.container.removeEventListener('scroll', renderVisibleItems);
        vList.container.addEventListener('scroll', renderVisibleItems, { passive: true });
        
        updateVirtualizedList(items);
    };

    const updateVirtualizedList = (newItems) => {
        vList.items = newItems;
        if (!vList.sizer) return;
        vList.sizer.style.height = `${newItems.length * vList.itemHeight}px`;
        vList.lastRendered = { start: -1 }; // Forzar re-render
        renderVisibleItems();
    };

    const renderVisibleItems = () => {
        if (!vList.container || !vList.content) return;
        
        requestAnimationFrame(() => {
            if (!vList.container) return; // Comprobar si el contenedor sigue existiendo
            const scrollTop = vList.container.scrollTop;
            const viewportHeight = vList.container.clientHeight;
            
            const startIndex = Math.max(0, Math.floor(scrollTop / vList.itemHeight));
            const endIndex = Math.min(vList.items.length - 1, startIndex + Math.ceil(viewportHeight / vList.itemHeight) + 1);

            if (startIndex === vList.lastRendered.start) return; 

            vList.content.style.transform = `translateY(${startIndex * vList.itemHeight}px)`;
            
            let html = '';
            for (let i = startIndex; i <= endIndex; i++) {
                if(vList.items[i]) html += renderMovementCard(vList.items[i]);
            }
            vList.content.innerHTML = html;
            vList.lastRendered.start = startIndex;
        });
    };
    
    const renderMovementCard = (m) => {
        const oClass = m.beneficiario ? `transaction-card--owner-${m.beneficiario.toLowerCase().replace('ú','u')}` : '';
        const amount = m.tipo === 'traspaso' ? `<span class="text-info">${formatCurrency(m.cantidad)} €</span>` : (m.cantidad < 0 ? `<span class="text-negative">${formatCurrency(m.cantidad)} €</span>` : `<span class="text-positive">+${formatCurrency(m.cantidad)} €</span>`);
        const meta = m.tipo === 'traspaso' ? `Traspaso: ${(db.cuentas.find(c=>c.id===m.cuentaOrigenId)?.nombre||'?')} → ${(db.cuentas.find(c=>c.id===m.cuentaDestinoId)?.nombre||'?')}` : `${(db.conceptos.find(c=>c.id===m.conceptoId)?.nombre||'S/C')} en ${(db.cuentas.find(c=>c.id===m.cuentaId)?.nombre||'S/C')}`;
        
        return `<div class="transaction-card ${oClass}" data-id="${m.id}">
                    <div class="transaction-card__actions transaction-card__actions--left">
                        <button class="icon-btn" data-action="copy-movement-swipe" title="Copiar"><span class="material-icons">content_copy</span></button>
                    </div>
                    <div class="transaction-card__swipe-content" data-action="edit-movement" data-id="${m.id}">
                        <div class="transaction-card__amount">${amount}</div>
                        <div class="transaction-card__details">
                            <div class="transaction-card__description">${m.descripcion}</div>
                            <div class="transaction-card__meta">${new Date(m.fecha).toLocaleString('es-ES',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
                            <div class="transaction-card__meta">${meta}</div>
                        </div>
                    </div>
                    <div class="transaction-card__actions transaction-card__actions--right">
                        <button class="icon-btn" data-action="delete-movement-swipe" title="Eliminar"><span class="material-icons">delete</span></button>
                    </div>
                </div>`;
    };

    const renderMovimientos = (filterText = '') => {
        const listCont = select('movimientos-list-container'), empty = select('empty-movimientos');
        if (!listCont || !empty) return;
        
        const lowerF = (filterText || '').toLowerCase();
        const filtered = (db.movimientos || [])
            .filter(m => {
                const concept = db.conceptos.find(c => c.id === m.conceptoId)?.nombre || '';
                const acc = m.tipo === 'traspaso' ? `${db.cuentas.find(c => c.id === m.cuentaOrigenId)?.nombre || ''} ${db.cuentas.find(c => c.id === m.cuentaDestinoId)?.nombre || ''}` : (db.cuentas.find(c => c.id === m.cuentaId)?.nombre || '');
                return m.descripcion.toLowerCase().includes(lowerF) || concept.toLowerCase().includes(lowerF) || acc.toLowerCase().includes(lowerF);
            })
            .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        if (filtered.length === 0) {
            empty.classList.remove('hidden');
            empty.querySelector('p').textContent = filterText ? 'No hay movimientos que coincidan.' : 'Añade tu primer movimiento.';
            listCont.innerHTML = '';
            vList.container = null;
            return;
        }
        empty.classList.add('hidden');

        if (!vList.container || !document.body.contains(vList.container)) {
            initVirtualizedList(filtered);
        } else {
            updateVirtualizedList(filtered);
        }
    };
    
    const renderCuentas = () => {
        const accCont = select('cuentas-accordion-container'), resCont = select('resumen-propietario-container'), pillsCont = select('filter-account-types-pills');
        if (!accCont || !resCont || !pillsCont) return;
        const saldos = getSaldos();
        const allLiquid = getLiquidAccounts();
        const types = [...new Set(allLiquid.map(c => (c.tipo||'S/T').toUpperCase()))].sort();
        pillsCont.innerHTML = types.map(t => `<button class="filter-pill ${!deselectedAccountTypesFilter.has(t)?'filter-pill--active':''}" data-action="toggle-account-type-filter" data-type="${t}">${t}</button>`).join('') || `<p style="font-size:var(--fs-xs); color:var(--c-on-surface-secondary)">No hay cuentas líquidas.</p>`;
        const filteredAccs = allLiquid.filter(c => !deselectedAccountTypesFilter.has((c.tipo||'S/T').toUpperCase()));
        const mainOwnersCount = (db.config.beneficiarios || []).filter(b => b.toLowerCase() !== 'común' && b.toLowerCase() !== 'comun').length || 1;
        resCont.innerHTML = (db.config.beneficiarios || []).filter(owner => owner.toLowerCase() !== 'común' && owner.toLowerCase() !== 'comun').map(owner => {
            const ownerAccounts = filteredAccs.filter(c => c.propietario === owner);
            const ownerSaldo = ownerAccounts.reduce((sum, c) => sum + (saldos[c.id] || 0), 0);
            const commonAccounts = filteredAccs.filter(c => c.propietario === 'Común' || c.propietario === 'Comun');
            const commonSaldoShare = commonAccounts.reduce((sum, c) => sum + (saldos[c.id] || 0), 0) / mainOwnersCount;
            const saldoNeto = ownerSaldo + commonSaldoShare;
            const oClass = `owner-${owner.toLowerCase().replace('ú','u')}`;
            const accountsForDetails = filteredAccs.filter(c => c.propietario === owner || c.propietario === 'Común' || c.propietario === 'Comun');
            return `<details class="accordion" open><summary><span style="font-weight:bold;color:var(--c-${oClass})">${owner==="Dani"?"👨‍💼":"👩‍💼"} ${owner}</span><span><strong style="color:var(--c-${oClass})">${formatCurrency(saldoNeto)} €</strong><span class="material-icons accordion__icon">expand_more</span></span></summary><div class="accordion__content">${accountsForDetails.length>0?accountsForDetails.sort((a,b)=>a.nombre.localeCompare(b.nombre)).map(c=>`<div class="transaction-card" data-action="view-account-details" data-id="${c.id}"><div class="transaction-card__swipe-content"><div class="transaction-card__details"><div class="transaction-card__description">${c.nombre}</div><div class="transaction-card__meta">${c.tipo} | ${c.propietario}</div></div><div class="transaction-card__amount"><strong>${formatCurrency(saldos[c.id])} €</strong></div></div></div>`).join(''):`<div class="empty-state" style="padding:16px 0"><p>No hay cuentas para el filtro.</p></div>`}</div></details>`;
        }).join('');
        const porTipo = (db.cuentas||[]).reduce((acc,c)=>{const t=(c.tipo||'S/T').toUpperCase();(acc[t]=acc[t]||[]).push(c);return acc;},{});
        const totalPat = Object.values(saldos).reduce((s,v)=>s+v,0);
        accCont.innerHTML = Object.keys(porTipo).sort().map(tipo => {
            const saldoG = porTipo[tipo].reduce((s,c)=>s+(saldos[c.id]||0),0);
            const porcTxt = totalPat!==0?`<span style="font-size:11px;color:var(--c-on-surface-secondary);margin-left:8px;font-weight:400">(${(saldoG/totalPat*100).toFixed(1)}%)</span>`:'';
            const icon = tipo==='EFECTIVO'?'payments':(tipo.includes('TARJETA')?'credit_card':(tipo==='AHORRO'?'savings':(tipo==='INVERSIÓN'?'trending_up':(tipo==='PROPIEDAD'?'domain':(tipo==='PRÉSTAMO'?'credit_score':'account_balance')))));
            return `<details class="accordion"><summary><span><span class="material-icons" style="vertical-align:bottom;font-size:20px;margin-right:8px">${icon}</span>${tipo}</span><span><strong>${formatCurrency(saldoG)} €</strong>${porcTxt}<span class="material-icons accordion__icon">expand_more</span></span></summary><div class="accordion__content">${porTipo[tipo].sort((a,b)=>a.nombre.localeCompare(b.nombre)).map(c=>{
                let amountHTML = `<strong>${formatCurrency(saldos[c.id])} €</strong>`;
                if (tipo === 'PRÉSTAMO') {
                    amountHTML = `<strong class="text-warning">${formatCurrency(Math.abs(saldos[c.id]))} €</strong>`;
                }
                return `<div class="transaction-card" data-action="view-account-details" data-id="${c.id}"><div class="transaction-card__swipe-content"><div class="transaction-card__details"><div class="transaction-card__description">${c.nombre}</div><div class="transaction-card__meta">${c.propietario}</div></div><div class="transaction-card__amount">${amountHTML}</div></div></div>`;
            }).join('')}</div></details>`;
        }).join('');
    };
    const renderPresupuestos = () => {
        const listCont=select('presupuestos-list'), empty=select('empty-presupuestos'); if(!listCont||!empty)return;
        const sorted = (db.presupuestos||[]).sort((a,b)=>b.ano-a.ano||a.beneficiario.localeCompare(b.beneficiario));
        if(sorted.length===0){empty.classList.remove('hidden');listCont.innerHTML='';return;}
        empty.classList.add('hidden');
        listCont.innerHTML=sorted.map(b=>{
            const gasto=db.movimientos.filter(m=>new Date(m.fecha).getFullYear()===b.ano&&m.beneficiario===b.beneficiario&&m.conceptoId===b.conceptoId&&m.cantidad<0).reduce((sum,m)=>sum+Math.abs(m.cantidad),0);
            const limite=b.cantidad, perc=limite>0?(gasto/limite)*100:0;
            let pClass='budget-item__progress--ok'; if(perc>=100)pClass='budget-item__progress--danger';else if(perc>=75)pClass='budget-item__progress--warning';
            const cName=db.conceptos.find(c=>c.id===b.conceptoId)?.nombre||'?', oClass=`transaction-card--owner-${b.beneficiario.toLowerCase().replace('ú','u')}`;
            return `<div class="transaction-card budget-item ${oClass}" style="cursor:default;"><div style="width:100%"><div class="budget-item__info"><div class="budget-item__text"><strong>${cName} (${b.beneficiario} ${b.ano})</strong><span class="text-negative">Gasto: ${formatCurrency(gasto)}€</span><span class="text-positive">Límite: ${formatCurrency(limite)}€</span></div><button class="icon-btn" data-action="delete-budget" data-id="${b.id}" title="Borrar"><span class="material-icons">delete_outline</span></button></div><progress class="budget-item__progress ${pClass}" value="${gasto}" max="${limite}"></progress></div></div>`;
        }).join('');
    };
    const loadConfig = () => {select('config-beneficiarios').value=(db.config?.beneficiarios||[]).join(', ');};
    const updateDashboard = () => {
        const kpiCont = select('kpi-container'), concCont = select('concepto-totals-list');
        if(!kpiCont || !concCont) return;
        kpiCont.innerHTML = Array(3).fill('<div class="kpi-item skeleton" style="height: 70px;"></div>').join('');
        concCont.innerHTML = Array(4).fill('<div class="skeleton" style="height: 50px; margin-bottom: 8px;"></div>').join('');
        setTimeout(() => {
            const movs = getFilteredMovements();
            const ing = movs.filter(m=>m.cantidad>0 && m.tipo!=='traspaso').reduce((s,m)=>s+m.cantidad,0);
            const gas = movs.filter(m=>m.cantidad<0).reduce((s,m)=>s+m.cantidad,0);
            const sal = ing+gas;
            kpiCont.innerHTML = `<div class="kpi-item"><h4 class="kpi-item__label">Ingresos</h4><strong class="kpi-item__value text-positive">+${formatCurrency(ing)} €</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Gastos</h4><strong class="kpi-item__value text-negative">${formatCurrency(gas)} €</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Saldo Neto</h4><strong class="kpi-item__value ${sal>=0?'text-positive':'text-negative'}">${formatCurrency(sal)} €</strong></div>`;
            const cTots = movs.reduce((a,m)=>{if(m.tipo==='movimiento'&&m.conceptoId){if(!a[m.conceptoId])a[m.conceptoId]={total:0,movements:[]};a[m.conceptoId].total+=m.cantidad;a[m.conceptoId].movements.push(m);}return a;},{});
            concCont.innerHTML = Object.keys(cTots).length===0?'<div class="empty-state" style="padding:16px 0"><p>Sin datos para los filtros.</p></div>':Object.entries(cTots).sort(([,a],[,b])=>a.total-b.total).map(([id,data])=>{const con=db.conceptos.find(c=>c.id===id),t=data.total;return `<details class="accordion"><summary><span>${con?.nombre||'?'}</span><span><strong class="${t>=0?'text-positive':'text-negative'}">${formatCurrency(t)} €</strong><span class="material-icons accordion__icon">expand_more</span></span></summary><div class="accordion__content">${data.movements.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).map(mov=>`<div class="transaction-card transaction-card--owner-${mov.beneficiario?mov.beneficiario.toLowerCase().replace('ú','u'):''}" data-action="edit-movement" data-id="${mov.id}"><div class="transaction-card__swipe-content"><div class="transaction-card__amount ${mov.cantidad>=0?'text-positive':'text-negative'}">${formatCurrency(mov.cantidad)} €</div><div class="transaction-card__details"><div class="transaction-card__description">${mov.descripcion}</div><div class="transaction-card__meta">${new Date(mov.fecha).toLocaleDateString('es-ES')}</div></div></div></div>`).join('')}</div></details>`;}).join('');
        }, 150); 
    };
    
    // =================================================================================
    // 8. MODAL HANDLING & MANAGEMENT
    // =================================================================================
    const showModal=id=>{const m=select(id);if(m){m.classList.add('modal-overlay--active');const f=m.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(f)f.focus();}};
    const hideModal=id=>{const m=select(id);if(m)m.classList.remove('modal-overlay--active');};
    const showGenericModal=(title,html)=>{select('generic-modal-title').textContent=title;select('generic-modal-body').innerHTML=html;showModal('generic-modal');};
    const showConfirmationModal=(msg,onConfirm,title="Confirmar Acción")=>{
        vibrate(20);
        const id='confirmation-modal';document.getElementById(id)?.remove();
        const overlay=document.createElement('div');overlay.id=id;overlay.className='modal-overlay modal-overlay--active';
        overlay.innerHTML=`<div class="modal" role="alertdialog" style="border-radius:var(--border-radius-lg)"><div class="modal__header"><h3 class="modal__title">${title}</h3></div><div class="modal__body"><p>${msg}</p><div class="modal__actions"><button class="btn btn--secondary" data-action="close-confirmation">Cancelar</button><button class="btn btn--danger" data-action="confirm-action">Sí, continuar</button></div></div></div>`;
        document.body.appendChild(overlay);
        overlay.querySelector('[data-action="confirm-action"]').onclick=()=>{vibrate();onConfirm();overlay.remove();};
        overlay.querySelector('[data-action="close-confirmation"]').onclick=()=>overlay.remove();
    };
    const showAccountMovementsModal=cId=>{const c=db.cuentas.find(c=>c.id===cId);if(!c)return;const movs=db.movimientos.filter(m=>m.cuentaId===cId||m.cuentaOrigenId===cId||m.cuentaDestinoId===cId).sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));let html=movs.length===0?`<div class="empty-state"><span class="material-icons">receipt_long</span><h3>Sin Movimientos</h3><p>No hay movimientos en esta cuenta.</p></div>`:movs.map(m=>{const oC=m.beneficiario?`transaction-card--owner-${m.beneficiario.toLowerCase().replace('ú','u')}`:'',amt=m.tipo==='traspaso'?`<span class="text-info">${formatCurrency(m.cantidad)} €</span>`:(m.cantidad<0?`<span class="text-negative">${formatCurrency(m.cantidad)} €</span>`:`<span class="text-positive">+${formatCurrency(m.cantidad)} €</span>`),meta=m.tipo==='traspaso'?(m.cuentaOrigenId===cId?`Traspaso a ${(db.cuentas.find(c=>c.id===m.cuentaDestinoId)?.nombre||'?')}`:`Traspaso de ${(db.cuentas.find(c=>c.id===m.cuentaOrigenId)?.nombre||'?')}`):(db.conceptos.find(c=>c.id===m.conceptoId)?.nombre||'S/C');return `<div class="transaction-card ${oC}" data-action="edit-movement" data-id="${m.id}"><div class="transaction-card__swipe-content"><div class="transaction-card__amount">${amt}</div><div class="transaction-card__details"><div class="transaction-card__description">${m.descripcion}</div><div class="transaction-card__meta">${new Date(m.fecha).toLocaleString('es-ES',{day:'2-digit',month:'short',year:'2-digit',hour:'2-digit',minute:'2-digit'})} | ${meta}</div></div></div></div>`;}).join('');showGenericModal(`Movimientos de ${c.nombre}`,`<div class="movements-modal">${html}</div>`);};
    const startEditMovement=id=>{
        hideModal('generic-modal');
        const f=select('form-movimiento');
        f.reset();
        clearAllErrors('form-movimiento');
        const mov=id?db.movimientos.find(m=>m.id===id):null;
        select('form-movimiento-title').textContent = mov ? 'Editar Movimiento' : 'Añadir Movimiento';
        select('movimiento-id').value=mov?.id||'';
        select('movimiento-tipo-selector').value=mov?.tipo||'movimiento';
        select('movimiento-tipo-selector').dispatchEvent(new Event('change'));
        select('movimiento-cantidad').value = mov ? formatCurrency(mov.cantidad) : '';
        const fecha=mov?new Date(mov.fecha):new Date();
        select('movimiento-fecha').value=new Date(fecha.getTime()-(fecha.getTimezoneOffset()*60000)).toISOString().slice(0,16);
        select('movimiento-descripcion').value=mov?.descripcion||'';
        if(mov?.tipo==='traspaso'){
            select('movimiento-cuenta-origen').value=mov.cuentaOrigenId;
            select('movimiento-cuenta-destino').value=mov.cuentaDestinoId;
        } else {
            select('movimiento-cuenta').value=mov?.cuentaId||'';
            select('movimiento-concepto').value=mov?.conceptoId||'';
            select('movimiento-beneficiario').value=mov?.beneficiario||'';
        }
        select('delete-movimiento-btn').classList.toggle('hidden',!mov);
        showModal('movimiento-modal');
    };
    
    // =================================================================================
    // 9. FORM HANDLERS & MODAL CONTENT
    // =================================================================================
    const showHelpModal = () => showGenericModal("Guía Completa y Novedades de Cuentas aiDANaI", `
        <div id="help-modal-content">
            <h3><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom;">auto_awesome</span> Guía Maestra de la Aplicación</h3>
            <p>¡Bienvenido a la experiencia financiera definitiva! Esta guía te desvelará todos los secretos de <strong>Cuentas aiDANaI</strong>. Ha sido diseñada desde cero no solo para funcionar, sino para sentirse como una herramienta profesional, increíblemente rápida y extraordinariamente intuitiva en cada interacción.</p>
            
            <div class="pro-tip">
                <h4><span class="material-icons" style="font-size: 1em; vertical-align: sub;">rocket_launch</span> Una Aplicación de Nueva Generación</h4>
                <p>Esta no es una simple página web. Ha sido construida como una <strong>Progressive Web App (PWA)</strong>, lo que significa que puedes instalarla en tu móvil u ordenador (busca la opción "Instalar aplicación" o "Añadir a pantalla de inicio" en tu navegador) para tener un icono de acceso directo y una experiencia idéntica a una aplicación nativa.</p>
                <p>Para garantizar una experiencia de usuario superior, hemos incorporado tecnologías de alto rendimiento:</p>
                <ul>
                    <li><b>Rendimiento Extremo con Listas Virtualizadas:</b> ¿Tienes cientos o miles de movimientos? No hay problema. La lentitud es cosa del pasado. La lista de movimientos utiliza "virtualización", una técnica profesional que dibuja únicamente los elementos que ves en pantalla en cada momento. Esto permite manejar un volumen de datos masivo con una fluidez y velocidad constantes, sin importar cuánta información tengas.</li>
                    <li><b>Feedback Inteligente y Estados de Carga:</b> La aplicación se comunica contigo. Cuando filtras o procesas datos, verás unos elegantes "esqueletos" (skeletons) animados que te indican que la app está trabajando. Cada toque en un botón importante responde con una sutil vibración y animación (feedback háptico y visual), creando una experiencia de uso satisfactoria, natural y que te da confianza.</li>
                </ul>
            </div>

            <h3><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom;">grid_view</span> Guía Rápida por Pestañas</h3>
            <p>La navegación principal se encuentra en la barra inferior, con 5 pestañas que te dan acceso a cada aspecto de tus finanzas.</p>
            
            <h4><span class="material-icons" style="font-size: 1em; vertical-align: sub;">dashboard</span> Panel: Tu Centro de Mando</h4>
            <p>Esta es la pantalla de inicio, una radiografía instantánea de tu salud financiera. Todo lo que ves aquí depende de los filtros que apliques.</p>
            <ul>
                <li><b>Filtros Globales:</b> Son el cerebro del análisis. Puedes filtrar por <b>periodo</b> (Mes Actual, Año Actual, Siempre, o un rango de fechas Personalizado), por un <b>propietario</b> específico, una <b>cuenta</b> o un <b>concepto</b> concreto. Pulsa "Aplicar Filtros" y verás los resultados actualizarse al instante.</li>
                <li><b>Indicadores Clave (KPIs):</b> Las tres tarjetas superiores te dan el resumen más importante: tus <b>Ingresos</b> totales, <b>Gastos</b> totales y el <b>Saldo Neto</b> resultante para el periodo y los filtros seleccionados.</li>
                <li><b>Análisis por Concepto:</b> ¿En qué gastas más? Esta sección agrupa todos tus movimientos por concepto y te muestra el total. Puedes desplegar cada concepto para ver la lista de transacciones individuales que lo componen.</li>
            </ul>

            <h4><span class="material-icons" style="font-size: 1em; vertical-align: sub;">swap_horiz</span> Movimientos: El Corazón de la App</h4>
            <p>Aquí reside el historial completo de tus transacciones. Es la sección más interactiva de la aplicación.</p>
            <ul>
                <li><b>Añadir y Editar:</b> Usa el gran botón flotante morado con el signo <code>+</code> para añadir nuevos movimientos o traspasos. Para editar una transacción existente, simplemente púlsala en la lista.</li>
                <li><b>Gestos Táctiles (Swipe):</b> Hemos diseñado una forma rápida e intuitiva de gestionar tus movimientos directamente desde la lista, ¡como en las mejores apps!
                    <ul>
                        <li><b style="color:var(--c-info)">Desliza una tarjeta hacia la DERECHA</b> para revelar el botón de <b>Copiar</b>. Esto es increíblemente útil para gastos que repites, como el café de la mañana o el parking. Con un toque, creas un movimiento nuevo con los mismos datos, solo para que ajustes la fecha.</li>
                        <li><b style="color:var(--c-danger)">Desliza una tarjeta hacia la IZQUIERDA</b> para revelar el botón de <b>Eliminar</b>. Rápido, visual y seguro, ya que te pedirá confirmación.</li>
                    </ul>
                </li>
                 <li><b>Búsqueda Instantánea:</b> La barra de búsqueda en la parte superior te permite encontrar cualquier movimiento al instante. Filtra en tiempo real por descripción, concepto o cuenta mientras escribes.</li>
                 <li><b>Identificador de Propietario:</b> La delgada línea de color a la izquierda de cada movimiento te indica visualmente a quién pertenece (según los colores definidos para cada propietario).</li>
            </ul>

            <h4><span class="material-icons" style="font-size: 1em; vertical-align: sub;">account_balance_wallet</span> Cuentas: Tu Patrimonio Real</h4>
            <p>Esta sección te ayuda a entender la estructura de tu capital, dónde está tu dinero y a quién pertenece.</p>
            <ul>
                <li><b>Fondos Líquidos por Propietario:</b> Esta es una de las funciones más potentes. No solo suma el dinero de las cuentas privadas de cada persona, sino que también <strong>calcula y asigna la parte proporcional del saldo de las cuentas comunes</strong>. Así, cada propietario tiene una visión real y precisa de su capital líquido disponible.</li>
                <li><b>Desglose de Patrimonio Neto:</b> Aquí agrupamos todas tus cuentas por tipo (Efectivo, Ahorro, Inversión, Propiedad, Préstamo...). Te permite visualizar de un vistazo cómo se distribuyen tus activos (lo que tienes) y tus pasivos (lo que debes), dándote una imagen clara de tu patrimonio total.</li>
                <li><b>Detalles de Cuenta:</b> Pulsa sobre cualquier cuenta en esta pantalla para abrir una ventana con el historial completo de sus movimientos.</li>
            </ul>

            <h4><span class="material-icons" style="font-size: 1em; vertical-align: sub;">pie_chart</span> Presupuestos: Control y Previsión</h4>
            <p>Define límites de gasto anuales para mantener tus finanzas bajo control y evitar sorpresas.</p>
            <ul>
                <li><b>Creación Sencilla:</b> Crea un presupuesto definiendo el <b>Año</b>, el <b>Propietario</b> responsable, el <b>Concepto</b> de gasto a vigilar (ej. "Restaurantes") y el <b>Límite Anual</b>.</li>
                <li><b>Seguimiento Visual:</b> La aplicación comparará tus gastos reales con el límite presupuestado y te mostrará el progreso con una barra de color. Se pondrá <b>amarilla</b> si te acercas al límite (75%) y <b>roja</b> si lo superas (100%), permitiéndote tomar decisiones a tiempo.</li>
            </ul>

            <h4><span class="material-icons" style="font-size: 1em; vertical-align: sub;">settings</span> Configuración: Tu App, a tu Manera</h4>
            <p>El centro neurálgico para personalizar y gestionar los datos de la aplicación.</p>
            <ul>
                <li><b>Gestión de Propietarios, Cuentas y Conceptos:</b> Aquí puedes añadir o eliminar los elementos básicos que organizan tus finanzas. Define quiénes son los propietarios, en qué cuentas se mueve el dinero y en qué conceptos se gasta o ingresa.</li>
                <li><b>Gestión de Datos Profesional:</b> Tu información es tuya, y te damos control total sobre ella.
                    <ul>
                        <li><b>Exportar:</b> Crea una copia de seguridad completa de <strong>todos tus datos</strong> (movimientos, cuentas, presupuestos, etc.) en un único archivo <code>.json</code>. Guárdalo en un lugar seguro. Es una buena práctica hacerlo periódicamente.</li>
                        <li><b>Importar:</b> Restaura la aplicación a un estado anterior usando un archivo de exportación. <strong>¡MÁXIMA ATENCIÓN!</strong> Esta acción es irreversible y <strong>reemplazará todos los datos que tengas actualmente</strong> en la aplicación.</li>
                        <li><b>Borrar Datos:</b> Realiza un reinicio total de la aplicación, como si la acabases de instalar. Por seguridad, te pedirá confirmación dos veces antes de proceder.</li>
                    </ul>
                </li>
            </ul>
        </div>
    `);
    
    // ...resto de funciones sin cambios...
    const showConceptosModal = () => { /* ...código sin cambios... */ };
    const renderConceptosModalList = () => { /* ...código sin cambios... */ };
    const showCuentasModal = () => { /* ...código sin cambios... */ };
    const renderCuentasModalList = () => { /* ...código sin cambios... */ };
    
    // =================================================================================
    // 10. AI ADVISOR LOGIC (IMPLEMENTACIÓN COMPLETA)
    // =================================================================================
    const showAiAdvisorModal = () => {
        const userSelect = select('ai-user-select');
        const resultsContainer = select('ai-results-container');
        if (!userSelect || !resultsContainer) return;
        
        // Populate user dropdown, excluding "Común"
        const owners = (db.config?.beneficiarios || []).filter(b => b.toLowerCase() !== 'común' && b.toLowerCase() !== 'comun');
        userSelect.innerHTML = owners.map(o => `<option value="${o}">${o}</option>`).join('');
        
        // Reset state
        resultsContainer.classList.add('hidden');
        resultsContainer.innerHTML = '';
        select('ai-advisor-form').reset();
        
        showModal('ai-advisor-modal');
    };

    const handleAiAnalysis = () => {
        vibrate();
        const form = select('ai-advisor-form');
        const btn = form.querySelector('button[type="submit"]');
        setButtonLoading(btn, true, 'Analizando...');

        const selectedUser = select('ai-user-select').value;
        const monthsToStudy = parseInt(select('ai-months-study').value, 10);
        const riskLevel = select('ai-risk-level').value;
        const resultsContainer = select('ai-results-container');
        resultsContainer.innerHTML = '<div class="skeleton" style="height: 150px;"></div>';
        resultsContainer.classList.remove('hidden');

        // Simulate analysis delay for better UX
        setTimeout(() => {
            if (!selectedUser || !monthsToStudy || monthsToStudy <= 0) {
                resultsContainer.innerHTML = `<p class="text-danger">Por favor, selecciona un usuario y un número de meses válido.</p>`;
                setButtonLoading(btn, false);
                return;
            }

            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(endDate.getMonth() - monthsToStudy);
            startDate.setHours(0, 0, 0, 0);

            const mainOwnersCount = (db.config.beneficiarios || []).filter(b => b.toLowerCase() !== 'común' && b.toLowerCase() !== 'comun').length || 1;

            let totalNet = 0;
            (db.movimientos || []).forEach(m => {
                const movDate = new Date(m.fecha);
                if (movDate >= startDate && movDate <= endDate && m.tipo === 'movimiento') {
                    if (m.beneficiario === selectedUser) {
                        totalNet += m.cantidad;
                    } else if (m.beneficiario && (m.beneficiario.toLowerCase() === 'común' || m.beneficiario.toLowerCase() === 'comun')) {
                        totalNet += m.cantidad / mainOwnersCount;
                    }
                }
            });

            const averageMonthlySavings = totalNet / monthsToStudy;
            const suggestions = getInvestmentSuggestions(riskLevel, averageMonthlySavings);

            let resultsHTML = `<h4>Análisis para ${selectedUser}</h4>`;
            if (averageMonthlySavings > 0) {
                resultsHTML += `<p>En los últimos ${monthsToStudy} meses, tu <strong>capacidad de ahorro media mensual ha sido de <span class="text-positive">${formatCurrency(averageMonthlySavings)} €</span></strong>.</p>`;
                resultsHTML += `<p>Basado en este ahorro y tu perfil de riesgo <strong>${riskLevel}</strong>, aquí tienes algunas sugerencias de inversión:</p>`;
            } else {
                resultsHTML += `<p>En los últimos ${monthsToStudy} meses, tu <strong>balance medio mensual ha sido de <span class="text-negative">${formatCurrency(averageMonthlySavings)} €</span></strong>.</p>`;
                resultsHTML += `<p>Tu prioridad debería ser revisar tus gastos para generar un excedente de ahorro. Una vez consigas un ahorro mensual positivo, podrás plantearte las siguientes estrategias según tu perfil de riesgo <strong>${riskLevel}</strong>:</p>`;
            }
            resultsHTML += `<ul>${suggestions.map(s => `<li>${s}</li>`).join('')}</ul>`;
            resultsHTML += `<small><strong>Aviso:</strong> Esto no es asesoramiento financiero. Son sugerencias generadas automáticamente basadas en los datos de la aplicación. Consulta siempre con un profesional financiero antes de tomar decisiones de inversión.</small>`;
            
            resultsContainer.innerHTML = resultsHTML;
            setButtonLoading(btn, false);

        }, 500);
    };

    const getInvestmentSuggestions = (risk, avg) => {
        const canInvest = avg > 0;
        switch (risk) {
            case 'Bajo':
                return [
                    "<strong>Cuentas de Ahorro de Alta Rentabilidad:</strong> Ofrecen seguridad y una pequeña rentabilidad, ideal para tu fondo de emergencia.",
                    "<strong>Depósitos a Plazo Fijo:</strong> Comprometes tu dinero por un tiempo a cambio de un interés fijo y garantizado.",
                    "<strong>Fondos Monetarios:</strong> Invierten en activos de deuda a muy corto plazo y de bajo riesgo. Son muy líquidos.",
                    "<strong>Bonos del Estado (Letras del Tesoro):</strong> Deuda pública considerada como una de las inversiones más seguras."
                ];
            case 'Medio':
                return [
                    "<strong>Fondos Indexados (MSCI World, S&P 500):</strong> Invierte de forma diversificada en las mayores empresas del mundo con costes muy bajos. La estrategia más recomendada a largo plazo.",
                    "<strong>ETFs de Sectores Diversificados:</strong> Similar a los fondos pero cotizan como acciones, permitiendo diversificar en sectores (tecnología, salud...).",
                    "<strong>Inversión Inmobiliaria (Crowdfunding):</strong> Participa en proyectos inmobiliarios con pequeñas cantidades, diversificando tu cartera.",
                    "<strong>Acciones de Empresas Consolidadas (Blue Chips):</strong> Invertir en empresas grandes y estables con un historial de dividendos."
                ];
            case 'Alto':
                return [
                    "<strong>Acciones de Crecimiento (Growth Stocks):</strong> Empresas con alto potencial de crecimiento, aunque más volátiles (ej. sector tecnológico).",
                    "<strong>Fondos de Inversión de Gestión Activa:</strong> Gestores profesionales intentan superar al mercado (suelen tener comisiones más altas).",
                    "<strong>Criptoactivos (Bitcoin, Ethereum):</strong> Inversión de muy alto riesgo y volatilidad. Destina solo un pequeño porcentaje de tu cartera que estés dispuesto a perder (<1-5%).",
                    "<strong>Venture Capital o Private Equity (a través de plataformas):</strong> Invertir en startups y empresas no cotizadas, con alto potencial y alto riesgo."
                ];
            default:
                return ["No se pudo determinar un perfil de riesgo."];
        }
    };

    // =================================================================================
    // 11. EVENT LISTENERS & HANDLERS
    // =================================================================================
    const attachEventListeners = () => {
        let currentSwipedCard = null;
        let debounceTimer;

        document.body.addEventListener('click', e => {
            if (currentSwipedCard && !currentSwipedCard.contains(e.target)) {
                currentSwipedCard.classList.remove('transaction-card--swiped-left', 'transaction-card--swiped-right');
                currentSwipedCard = null;
            }

            const target = e.target, actionTarget = target.closest('[data-action]');
            if (target.closest('.modal-overlay') && e.target === target.closest('.modal-overlay')) return hideModal(target.closest('.modal-overlay').id);
            if (!actionTarget) return; 
            
            const {action, id, page, type} = actionTarget.dataset;
            const btn = actionTarget.closest('button');
            const cardElement = actionTarget.closest('.transaction-card');
            
            switch (action) {
                case 'login': handleLogin(btn); break;
                case 'register': handleRegister(btn); break;
                case 'logout': handleLogout(); break;
                case 'navigate': navigateTo(page); break;
                case 'theme-toggle': toggleTheme(); break;
                case 'help': showHelpModal(); break;
                case 'ai-advisor': showAiAdvisorModal(); break;
                case 'apply-filters': vibrate(); setButtonLoading(btn, true, 'Aplicando...'); updateDashboard(); setTimeout(() => setButtonLoading(btn, false), 400); break;
                case 'add-movement': vibrate(); startEditMovement(null); break;
                case 'edit-movement': vibrate(); startEditMovement(actionTarget.dataset.id); break;
                case 'delete-movement-swipe': showConfirmationModal('¿Seguro que quieres eliminar este movimiento?', ()=>{db.movimientos=db.movimientos.filter(m=>m.id!==cardElement.dataset.id);saveData(null,()=>{renderMovimientos(select('search-movimientos').value);showToast('Movimiento eliminado.');});}); break;
                case 'copy-movement-swipe': handleCopyMovement(cardElement.dataset.id); break;
                case 'delete-movement-from-modal': showConfirmationModal('¿Seguro que quieres eliminar este movimiento?', ()=>{db.movimientos=db.movimientos.filter(m=>m.id!==select('movimiento-id').value);saveData(null,()=>{hideModal('movimiento-modal');renderAll();showToast('Movimiento eliminado.');});}); break;
                case 'delete-budget': showConfirmationModal('¿Seguro que quieres eliminar este presupuesto?', ()=>{db.presupuestos=db.presupuestos.filter(p=>p.id!==id);saveData(null,()=>{renderPresupuestos();showToast('Presupuesto eliminado.');});}); break;
                case 'delete-concepto': if(db.movimientos.some(m=>m.conceptoId===id)){showToast("Concepto en uso, no se puede borrar.","warning");return;} showConfirmationModal('¿Seguro que quieres eliminar este concepto?',()=>{db.conceptos=db.conceptos.filter(c=>c.id!==id);saveData(null,()=>{showToast("Concepto eliminado.");renderConceptosModalList();populateAllDropdowns();});}); break;
                case 'delete-cuenta': if(db.movimientos.some(m=>m.cuentaId===id||m.cuentaOrigenId===id||m.cuentaDestinoId===id)){showToast("Cuenta con movimientos, no se puede borrar.","warning",3500);return;} showConfirmationModal('¿Seguro que quieres eliminar esta cuenta?',()=>{db.cuentas=db.cuentas.filter(c=>c.id!==id);saveData(null,()=>{showToast("Cuenta eliminada.");renderCuentasModalList();populateAllDropdowns();renderCuentas();});}); break;
                case 'close-modal': hideModal(target.closest('.modal-overlay').id); break;
                case 'manage-conceptos': showConceptosModal(); break;
                case 'manage-cuentas': showCuentasModal(); break;
                case 'view-account-details': showAccountMovementsModal(id); break;
                case 'save-config': handleSaveConfig(btn); break;
                case 'export-data': handleExportData(btn); break;
                case 'import-data': select('import-file-input').click(); break;
                case 'clear-data': showConfirmationModal('¿Seguro que quieres borrar TODOS tus datos? Esta acción es irreversible.',()=>{showConfirmationModal('Esta acción no se puede deshacer. ¿Continuar con el borrado?', () => {db=getInitialDb();saveData(null,()=>{renderAll();showToast('Datos borrados.','danger');});}, 'Confirmación Final')}); break;
                case 'toggle-account-type-filter': vibrate(); if(deselectedAccountTypesFilter.has(type)) { deselectedAccountTypesFilter.delete(type); } else { deselectedAccountTypesFilter.add(type); } renderCuentas(); break;
            }
        });

        document.body.addEventListener('submit', e => { e.preventDefault();
            switch(e.target.id) { case 'form-movimiento':handleSaveMovement(e.target);break; case 'form-presupuesto':handleSaveBudget(e.target);break; case 'add-concepto-form':handleAddConcept(e.target);break; case 'add-cuenta-form':handleAddAccount(e.target);break; case 'ai-advisor-form':handleAiAnalysis();break; }
        });
        
        document.body.addEventListener('input', e => {
            const id=e.target.id;
            if(id && select(`${id}-error`)) clearError(id);
            if(id === 'search-movimientos') {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    renderMovimientos(e.target.value);
                }, 250); // Debounce para mejorar rendimiento en la búsqueda
            }
        });
        
        select('filter-periodo').addEventListener('change', e => select('custom-date-filters').classList.toggle('hidden', e.target.value !== 'custom'));
        select('movimiento-tipo-selector').addEventListener('change', e => { const isT=e.target.value==='traspaso';select('movimiento-fields').classList.toggle('hidden',isT);select('traspaso-fields').classList.toggle('hidden',!isT);['movimiento-concepto','movimiento-cuenta','movimiento-beneficiario'].forEach(id=>select(id).required=!isT);['movimiento-cuenta-origen','movimiento-cuenta-destino'].forEach(id=>select(id).required=isT); });
        select('import-file-input').addEventListener('change', e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=re=>{try{let d=JSON.parse(re.target.result);if(d.db)d=d.db;showConfirmationModal('Importar reemplazará TODOS tus datos. ¿Estás seguro?',()=>{db=d;saveData(null,()=>{renderAll();showToast('Datos importados.');});});}catch(err){showToast('Error: Archivo JSON no válido.','danger');console.error("Import error:",err);}};r.readAsText(f);e.target.value='';});

        let touchStartX = 0, touchStartY = 0;
        const listContainer = select('movimientos-page');
        
        listContainer.addEventListener('touchstart', e => {
            const card = e.target.closest('.transaction-card');
            if (!card || !select('movimientos-list-container')?.contains(card)) return;
            if (currentSwipedCard && currentSwipedCard !== card) {
                currentSwipedCard.classList.remove('transaction-card--swiped-left', 'transaction-card--swiped-right');
            }
            currentSwipedCard = card;
            touchStartX = e.targetTouches[0].clientX;
            touchStartY = e.targetTouches[0].clientY;
        }, { passive: true });

        listContainer.addEventListener('touchmove', e => {
            if (!currentSwipedCard || !e.targetTouches[0]) return;
            const diffX = e.targetTouches[0].clientX - touchStartX;
            const diffY = e.targetTouches[0].clientY - touchStartY;

            if (Math.abs(diffY) > Math.abs(diffX) + 5) {
                if (currentSwipedCard) {
                    currentSwipedCard.classList.remove('transaction-card--swiped-left', 'transaction-card--swiped-right');
                }
                currentSwipedCard = null;
                return;
            }
            
            const SWIPE_THRESHOLD = 50;
            if (diffX > SWIPE_THRESHOLD) {
                currentSwipedCard.classList.add('transaction-card--swiped-right');
                currentSwipedCard.classList.remove('transaction-card--swiped-left');
            } else if (diffX < -SWIPE_THRESHOLD) {
                currentSwipedCard.classList.add('transaction-card--swiped-left');
                currentSwipedCard.classList.remove('transaction-card--swiped-right');
            } else {
                currentSwipedCard.classList.remove('transaction-card--swiped-left', 'transaction-card--swiped-right');
            }
        }, { passive: true });
    };

    const handleSaveConfig = btn => { vibrate(); const bens = select('config-beneficiarios').value.split(',').map(s=>s.trim()).filter(Boolean); if(bens.length===0){displayError('config-beneficiarios','Debe haber al menos un propietario.');return;}setButtonLoading(btn,true,'Guardando...');db.config.beneficiarios=bens;saveData(btn,()=>{renderAll();showToast('Configuración guardada.');});};
    const handleExportData = (btn) => {
        vibrate();
        setButtonLoading(btn, true, 'Exportando...');
        try {
            const dataToExport = { db };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
            a.download = `cuentas-aidanai-backup-${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        } catch (error) {
            console.error("Error al exportar datos:", error);
            showToast('Error al exportar los datos.', 'danger');
        } finally {
            setButtonLoading(btn, false);
        }
    };
    
    const handleCopyMovement = (idToCopy) => {
        vibrate();
        const originalMov = db.movimientos.find(m => m.id === idToCopy);
        if (!originalMov) { showToast('Error: No se encontró el movimiento.', 'danger'); return; }
        const newMov = JSON.parse(JSON.stringify(originalMov));
        newMov.id = generateId();
        newMov.fecha = new Date().toISOString();
        db.movimientos.push(newMov);
        saveData(null, () => {
            showToast('Movimiento copiado.');
            renderMovimientos(select('search-movimientos').value);
            setTimeout(() => {
                const newCardContent = document.querySelector(`.transaction-card[data-id="${newMov.id}"] .transaction-card__swipe-content`);
                if (newCardContent) {
                    newCardContent.classList.add('highlight-animation');
                    setTimeout(() => newCardContent.classList.remove('highlight-animation'), 1500);
                }
            }, 250);
        });
    };

    const handleSaveMovement = form => {
        vibrate();
        clearAllErrors(form.id);
        const id = select('movimiento-id').value;
        const tipo = select('movimiento-tipo-selector').value;
        const fecha = select('movimiento-fecha').value;
        const desc = select('movimiento-descripcion').value.trim();
        const btn = select('save-movimiento-btn');
        const cantStr = select('movimiento-cantidad').value.trim().replace(/\./g, '').replace(',', '.');
        const cantCent = Math.round(parseFloat(cantStr) * 100);
        let v = true;
        if (isNaN(cantCent)) { displayError('movimiento-cantidad', 'Cantidad inválida.'); v = false; }
        if (!fecha) { displayError('movimiento-fecha', 'Fecha obligatoria.'); v = false; }
        if (!desc) { displayError('movimiento-descripcion', 'Descripción obligatoria.'); v = false; }
        const newMov = { id: id || generateId(), tipo, cantidad: cantCent, fecha: new Date(fecha).toISOString(), descripcion: desc };
        if (tipo === 'traspaso') {
            newMov.cuentaOrigenId = select('movimiento-cuenta-origen').value;
            newMov.cuentaDestinoId = select('movimiento-cuenta-destino').value;
            newMov.beneficiario = 'Común';
            if (!newMov.cuentaOrigenId || !newMov.cuentaDestinoId || newMov.cuentaOrigenId === newMov.cuentaDestinoId) { displayError('movimiento-cuenta-destino', 'Cuentas de origen y destino deben ser válidas y diferentes.'); v = false; }
            if (cantCent <= 0) { displayError('movimiento-cantidad', 'En traspasos, la cantidad debe ser positiva.'); v = false; }
        } else {
            newMov.cuentaId = select('movimiento-cuenta').value;
            newMov.conceptoId = select('movimiento-concepto').value;
            newMov.beneficiario = select('movimiento-beneficiario').value;
            if (!newMov.cuentaId) { displayError('movimiento-cuenta', 'Cuenta obligatoria.'); v = false; }
            if (!newMov.conceptoId) { displayError('movimiento-concepto', 'Concepto obligatorio.'); v = false; }
            if (!newMov.beneficiario) { displayError('movimiento-beneficiario', 'Propietario obligatorio.'); v = false; }
        }
        if (!v) return;
        setButtonLoading(btn, true, 'Guardando...');
        const idx = id ? db.movimientos.findIndex(m => m.id === id) : -1;
        if (idx > -1) db.movimientos[idx] = newMov;
        else db.movimientos.push(newMov);
        
        saveData(btn, () => {
            hideModal('movimiento-modal');
            showToast(id ? 'Movimiento actualizado' : 'Movimiento añadido');
            renderAll();
        });
    };
    const handleSaveBudget = form => { vibrate(); clearAllErrors(form.id); const btn=form.querySelector('button[type="submit"]'); const ano=parseInt(select('presupuesto-ano').value),ben=select('presupuesto-beneficiario-p').value,con=select('presupuesto-concepto').value; const cantCent=Math.round(parseFloat(select('presupuesto-cantidad').value.trim().replace(/\./g,'').replace(',','.'))*100); let v=true; if(isNaN(ano)||ano<2000||ano>2100){displayError('presupuesto-ano','Año inválido.');v=false;} if(!ben){displayError('presupuesto-beneficiario-p','Propietario obligatorio.');v=false;} if(!con){displayError('presupuesto-concepto','Concepto obligatorio.');v=false;} if(db.presupuestos.some(p=>p.ano===ano&&p.beneficiario===ben&&p.conceptoId===con)){displayError('presupuesto-concepto','Ya existe un presupuesto con estos parámetros.');v=false;} if(!v)return; setButtonLoading(btn,true,'Guardando...'); db.presupuestos.push({id:generateId(),ano,beneficiario:ben,conceptoId:con,cantidad:cantCent}); saveData(btn,()=>{form.reset();showToast('Presupuesto guardado.');renderAll();});};
    const handleAddConcept = form => { vibrate(); const input=form.querySelector('input'),nombre=input.value.trim();if(nombre){db.conceptos.push({id:generateId(),nombre});saveData(null,()=>{input.value='';showToast('Concepto añadido.');renderConceptosModalList();populateAllDropdowns();});}};
    const handleAddAccount = form => { vibrate(); const nom=select('new-cuenta-nombre').value.trim(),tip=select('new-cuenta-tipo').value.trim().toUpperCase(),pro=select('new-cuenta-propietario').value;if(nom&&tip&&pro){db.cuentas.push({id:generateId(),nombre:nom,tipo:tip,propietario:pro});saveData(null,()=>{form.reset();showToast('Cuenta añadida.');renderCuentasModalList();populateAllDropdowns();renderCuentas();});}else{showToast("Rellena todos los campos.","warning");}};

    // =================================================================================
    // 12. APP ENTRY POINT
    // =================================================================================
    initApp();
});
</script>

</body>
</html>