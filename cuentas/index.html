<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Cuentas Personales</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="manifest" href="data:application/manifest+json,{
        %22name%22:%22Gestor de Cuentas%22,
        %22short_name%22:%22Cuentas%22,
        %22start_url%22:%22.%22,
        %22display%22:%22standalone%22,
        %22background_color%22:%22#000000%22,
        %22theme_color%22:%22#0A84FF%22,
        %22description%22:%22Gestor de finanzas personales, elegante y profesional.%22,
        %22icons%22:[
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg%2bxml%22},
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg%2bxml%22}
        ]
    }">
    <meta name="theme-color" content="#000000"/>
    <link rel="apple-touch-icon" href="aiDANaI.webp">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        /* ================================================================= */
        /* === ESTILOS BASE Y MOBILE-FIRST (CÓDIGO ORIGINAL MODIFICADO) === */
        /* ================================================================= */
        :root {
            /* iOS-style Color Palette */
            --c-primary: #0A84FF; --c-primary-hover: #0076e6;
            --c-background: #F2F2F7; /* iOS Grey Background */
            --c-surface: #FFFFFF;
            --c-surface-variant: #E9E9EB;
            --c-on-surface: #000000;
            --c-on-surface-secondary: #8A8A8E;
            --c-outline: #D1D1D6;
            --c-success: #34C759; --c-danger: #FF3B30; --c-warning: #FF9500; --c-info: #5AC8FA; --c-white: #FFFFFF; --c-black: #000000;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 6px 20px 0 rgba(0, 0, 0, 0.1);
            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --fs-xs: 0.75rem; --fs-sm: 0.875rem; --fs-base: 1rem; --fs-lg: 1.125rem; --fs-xl: 1.25rem;
            --sp-1: 0.25rem; --sp-2: 0.5rem; --sp-3: 0.75rem; --sp-4: 1rem; --sp-5: 1.25rem; --sp-6: 1.5rem;
            --border-radius-md: 10px; --border-radius-lg: 18px;
        }
        [data-theme="dark"] {
            --c-primary: #0A84FF; --c-primary-hover: #339aff;
            --c-background: #000000; /* True black for OLED */
            --c-surface: #1C1C1E;
            --c-surface-variant: #2C2C2E;
            --c-on-surface: #FFFFFF;
            --c-on-surface-secondary: #8D8D93;
            --c-outline: #38383A;
            --c-success: #30D158; --c-danger: #FF453A; --c-warning: #FF9F0A; --c-info: #64D2FF;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
            --shadow-md: 0 6px 20px 0 rgba(0, 0, 0, 0.25);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; scroll-behavior: smooth; }
        body { font-family: var(--font-family); background-color: var(--c-background); color: var(--c-on-surface); line-height: 1.4; min-height: 100vh; min-height: -webkit-fill-available; transition: background-color 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow: hidden; /* Se cambia a 'auto' en desktop */ font-weight: 400; }
        *:focus-visible { outline: 2px solid var(--c-primary); outline-offset: 2px; border-radius: var(--sp-2); }
        
        @keyframes pop-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes highlight-card { 0% { background-color: color-mix(in srgb, var(--c-primary) 15%, transparent); } 100% { background-color: transparent; } }
        .highlight-animation { animation: highlight-card 1.5s ease-out; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton {
            background-color: var(--c-surface-variant);
            background-image: linear-gradient(90deg, var(--c-surface-variant), color-mix(in srgb, var(--c-outline) 20%, var(--c-surface-variant)), var(--c-surface-variant));
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: var(--sp-2);
            color: transparent !important;
            user-select: none;
        }
        .skeleton > * { visibility: hidden; }
        
        .intro-screen { position: fixed; inset: 0; z-index: 9999; display: flex; justify-content: center; align-items: center; background-color: #111827; transition: opacity 0.75s ease-in-out; }
        .starry-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(1px 1px at 10% 20%,#fff,transparent),radial-gradient(1px 1px at 80% 30%,#fff,transparent),radial-gradient(2px 2px at 50% 50%,#fff,transparent),radial-gradient(1px 1px at 30% 80%,#fff,transparent),radial-gradient(2px 2px at 90% 90%,#fff,transparent); background-size: 300px 300px; animation: twinkle 15s linear infinite; }
        @keyframes twinkle { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .intro-screen__logo { width: 250px; height: auto; border-radius: 24px; opacity: 0; position: absolute; animation: logoExplode 2.5s cubic-bezier(0.5, 0, 0.5, 1) forwards; }
        @keyframes logoExplode { 0% { transform: scale(0.2) rotate(-25deg); opacity: 0; } 30% { transform: scale(1.1) rotate(10deg); opacity: 1; } 50% { transform: scale(0.95) rotate(-8deg); opacity: 1; } 80% { transform: scale(1.5) rotate(5deg); opacity: 1; } 100% { transform: scale(12) rotate(20deg); opacity: 0; } }
        .intro-screen__quote-container { text-align: center; color: var(--c-white); padding: var(--sp-5); max-width: 800px; z-index: 1; opacity: 0; transition: opacity 1.5s ease-in-out; }
        .intro-screen__quote-container.visible { opacity: 1; }
        .intro-screen__quote-text { font-size: clamp(1.2rem, 4vw, 1.8rem); font-style: italic; font-weight: 400; line-height: 1.4; margin-bottom: 16px; text-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        .intro-screen__quote-author { display: block; font-size: clamp(0.8rem, 2.4vw, 1rem); color: var(--c-on-surface-secondary); font-weight: 500; }
        
        /* Contenedor principal de la app */
        .app-layout { display: none; max-width: 500px; /* Ancho máximo para móviles */ margin: 0 auto; height: 100vh; background-color: var(--c-background); flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; }
        .app-layout--visible { display: flex; opacity: 1; }

        /* El área de contenido principal con scroll */
        .app-layout__main { 
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            /* Se añade padding superior e inferior para la cabecera y la navegación fija */
            padding: 44px 0 48px 0; 
        }
        .view {
            display: none;
            flex-direction: column;
            width: 100%;
            padding: 0 var(--sp-4);
        }
        .view--active {
            display: flex;
            animation: fade-in 0.3s ease-in-out;
        }
        
        /* Cabecera superior */
        .top-bar { 
            display: flex; align-items: center; justify-content: space-between; padding: var(--sp-2) var(--sp-4); 
            background-color: color-mix(in srgb, var(--c-surface) 80%, transparent); 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); 
            border-bottom: 1px solid var(--c-outline); z-index: 200; 
            height: 44px; /* Aumentado ligeramente para mejor toque */
            position: fixed; top: 0; left: 50%; transform: translateX(-50%); 
            width: 100%; max-width: 500px; /* Ancho máximo para móviles */
            transition: background-color 0.3s ease-in-out;
        }
        .top-bar__title { font-size: var(--fs-lg); font-weight: 700; margin-right: auto; padding-left: var(--sp-2); }
        .top-bar__actions { display: flex; align-items: center; gap: var(--sp-1); }
        .top-bar__left-button { min-width: 85px; }

        /* Barra de navegación inferior */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); 
            width: 100%; max-width: 500px; /* Ancho máximo para móviles */
            background-color: var(--c-surface); 
            border-top: 1px solid var(--c-outline); display: flex; 
            padding-bottom: env(safe-area-inset-bottom); /* Respetar notch del iPhone */
            z-index: 200; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); 
            height: 48px; /* Aumentado ligeramente */
        }
        .bottom-nav__item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--sp-1) var(--sp-2); cursor: pointer; transition: color 0.2s; color: var(--c-on-surface-secondary); border: none; background: none; }
        .bottom-nav__item--active { color: var(--c-primary); }
        .bottom-nav__item .material-icons { font-size: 22px; } 
        .bottom-nav__label { 
            display: none; /* Oculto en móvil */
            font-size: var(--fs-xs);
            margin-top: 2px;
        }

        /* Botón de acción flotante (FAB) */
        .fab { position: fixed; 
            bottom: calc(56px + env(safe-area-inset-bottom)); /* Ajustado para no solapar la nav */
            right: var(--sp-5); width: 56px; height: 56px; background-color: var(--c-primary); color: var(--c-white); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md); z-index: 50; transform: scale(0); opacity: 0; transition: transform 0.2s ease-out, opacity 0.2s ease-out; 
        }
        .fab--visible { transform: scale(1); opacity: 1; }
        .fab:hover { transform: scale(1.08) !important; } .fab .material-icons { font-size: 28px; }
        
        /* Estilos de Modales */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(4px); display: flex; align-items: flex-end; /* Alineado abajo por defecto */
            justify-content: center; z-index: 1050; opacity: 0; transition: opacity 0.3s; 
            pointer-events: none; 
        }
        .modal-overlay--active { opacity: 1; pointer-events: auto; }
        .modal { 
            background: var(--c-surface); 
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; /* Bordes redondeados solo arriba */
            padding: var(--sp-5); width: 100%; max-width: 420px; max-height: 90vh; 
            display: flex; flex-direction: column; box-shadow: var(--shadow-md); 
            transform: translateY(100%); /* Animación de entrada desde abajo */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            animation: pop-in 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .modal-overlay--active .modal { transform: translateY(0); }
        
        .card { background: var(--c-surface); border: none; box-shadow: var(--shadow-sm); padding: 0; margin-bottom: var(--sp-4); border-radius: var(--border-radius-lg); overflow: hidden; }
        .card__title { font-size: var(--fs-lg); font-weight: 600; margin-bottom: var(--sp-3); display: flex; align-items: center; gap: var(--sp-2); color: var(--c-primary); padding: var(--sp-4) var(--sp-4) 0 var(--sp-4); }
        .card__content { padding: 0 var(--sp-4) var(--sp-4) var(--sp-4); }
        .card__title .material-icons { font-size: var(--fs-lg); }
        .card--no-bg { background: none; border: none; box-shadow: none; padding: 0; border-radius: 0; }
        .chart-container { position: relative; height: 220px; width: 100%; margin-bottom: var(--sp-4); }
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--sp-3); margin-bottom: var(--sp-4); }
        .kpi-item { background: var(--c-surface); border-radius: var(--border-radius-lg); padding: var(--sp-3); text-align: center; transition: background-color 0.3s; }
        .kpi-item__label { font-size: var(--fs-xs); font-weight: 500; color: var(--c-on-surface-secondary); margin-bottom: var(--sp-1); text-transform: uppercase; }
        .kpi-item__value { font-size: var(--fs-base); font-weight: 700; }
        .kpi-item__comparison { font-size: var(--fs-xs); font-weight: 500; margin-top: var(--sp-1); height: 14px; }
        #movimientos-list-container { position: relative; padding: 0 var(--sp-4); }
        #virtual-list-sizer { position: relative; width: 100%; }
        #virtual-list-content { position: absolute; top: 0; left: 0; width: 100%; }
        .transaction-card { display: flex; position: relative; overflow: hidden; background-color: var(--c-surface); margin-bottom: 4px; border-radius: var(--border-radius-md); transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .transaction-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .transaction-card__swipe-content { display: flex; justify-content: space-between; align-items: center; flex-grow: 1; padding: var(--sp-2) var(--sp-3); gap: var(--sp-2); width: 100%; position: relative; z-index: 2; background: inherit; transition: transform 0.3s ease; cursor: pointer; border-radius: inherit; border-bottom: none; }
        .transaction-card__icon { flex-shrink: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background-color: var(--c-surface-variant); border-radius: 50%; margin-right: var(--sp-2); color: var(--c-on-surface-secondary); }
        .transaction-card__icon .material-icons { font-size: 18px; }
        .transaction-card__details { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        .transaction-card__description { font-weight: 500; font-size: var(--fs-sm); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__meta { font-size: 0.7rem; color: var(--c-on-surface-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
        .transaction-card__amount { font-weight: 600; font-size: var(--fs-sm); text-align: right; flex-shrink: 0; }
        .transaction-card__actions { position: absolute; top: 0; bottom: 0; width: 65px; display: flex; align-items: center; justify-content: center; z-index: 1; }
        .transaction-card__actions--left { left: 0; background-color: var(--c-info); }
        .transaction-card__actions--right { right: 0; background-color: var(--c-danger); }
        .transaction-card__actions .icon-btn { color: white; width: 100%; height: 100%; border-radius: 0; }
        .transaction-card--swiped-left .transaction-card__swipe-content { transform: translateX(-65px); }
        .transaction-card--swiped-right .transaction-card__swipe-content { transform: translateX(65px); }
        .accordion { margin-bottom: 0; background-color: var(--c-surface); overflow: hidden; }
        .accordion-wrapper > .accordion:first-child { border-top-left-radius: var(--border-radius-lg); border-top-right-radius: var(--border-radius-lg); }
        .accordion-wrapper > .accordion:last-child { border-bottom-left-radius: var(--border-radius-lg); border-bottom-right-radius: var(--border-radius-lg); }
        .accordion-wrapper > .accordion:last-child > summary { border-bottom: none; }
        .accordion[open] > summary { border-bottom: 1px solid var(--c-outline); }
        .accordion > summary { font-weight: 600; cursor: pointer; padding: var(--sp-3) var(--sp-4); display: flex; align-items: center; justify-content: space-between; list-style: none; font-size: var(--fs-base); border-bottom: 1px solid var(--c-outline); }
        .accordion > summary::-webkit-details-marker { display: none; }
        .accordion > summary .accordion__icon { transition: transform 0.2s; color: var(--c-on-surface-secondary); }
        .accordion[open] > summary .accordion__icon { transform: rotate(180deg); }
        .accordion__content { padding: 0; }
        .card > .accordion { border-radius: 0; }
        .account-group { background: var(--c-surface); border-radius: var(--border-radius-lg); margin-bottom: var(--sp-3); overflow: hidden; }
        .account-group__header { display: flex; justify-content: space-between; align-items: center; padding: var(--sp-2) var(--sp-4); border-bottom: 1px solid var(--c-outline); }
        .account-group__name { font-size: var(--fs-base); font-weight: 600; }
        .account-group__balance { font-size: var(--fs-sm); font-weight: 500; }
        .account-group .modal__list-item { padding: var(--sp-2) var(--sp-4); }
        .form-group { margin-bottom: var(--sp-3); position: relative; }
        .form-label { display: block; font-size: var(--fs-sm); font-weight: 500; margin-bottom: var(--sp-2); color: var(--c-on-surface-secondary); }
        .form-input, .form-select { width: 100%; padding: var(--sp-3); border: 1px solid var(--c-outline); border-radius: var(--border-radius-md); background: var(--c-surface-variant); color: var(--c-on-surface); font-size: var(--fs-base); appearance: none; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--c-primary); background-color: var(--c-surface); box-shadow: 0 0 0 3px color-mix(in srgb, var(--c-primary) 20%, transparent); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 12px center; background-size: 14px; padding-right: 36px; }
        [data-theme=dark] .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23FFF' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--sp-3); }
        .form-group-addon { display: flex; align-items: flex-end; gap: var(--sp-2); }
        .form-group-addon .form-group { flex-grow: 1; margin-bottom: 0; }
        .form-error { color: var(--c-danger); font-size: var(--fs-xs); margin-top: var(--sp-1); min-height: 14px; display: block; }
        .form-input--invalid { border-color: var(--c-danger) !important; }
        .form-checkbox-group { display: flex; align-items: center; gap: var(--sp-2); margin-bottom: var(--sp-2); }
        .form-checkbox-group label { margin-bottom: 0; font-weight: normal; }
        .form-checkbox-group input[type="radio"], .form-checkbox-group input[type="checkbox"] { accent-color: var(--c-primary); }
        .form-switch-group { display: flex; align-items: center; justify-content: space-between; }
        .form-switch { position: relative; display: inline-block; width: 44px; height: 26px; }
        .form-switch input { opacity: 0; width: 0; height: 0; }
        .form-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--c-surface-variant); transition: .4s; border-radius: 34px; }
        .form-switch .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        .form-switch input:checked + .slider { background-color: var(--c-success); }
        .form-switch input:checked + .slider:before { transform: translateX(18px); }
        .btn { padding: var(--sp-3) var(--sp-4); border: 1px solid transparent; border-radius: var(--border-radius-md); font-size: var(--fs-sm); font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: var(--sp-2); -webkit-user-select: none; user-select: none; }
        .btn:active { transform: scale(0.97); }
        .btn--primary { background-color: var(--c-primary); color: var(--c-white); } .btn--primary:hover { background-color: var(--c-primary-hover); }
        .btn--secondary { background-color: var(--c-surface-variant); color: var(--c-on-surface); } .btn--secondary:hover { background-color: color-mix(in srgb, var(--c-outline) 20%, var(--c-surface-variant)); }
        .btn--danger { background-color: var(--c-danger); color: var(--c-white); } .btn--full { width: 100%; } .btn--loading { pointer-events: none; opacity: .8; }
        .icon-btn { background: none; border: none; color: var(--c-on-surface-secondary); cursor: pointer; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s, transform 0.2s; }
        .icon-btn .material-icons { font-size: 20px; }
        .icon-btn:hover { background-color: var(--c-surface-variant); color: var(--c-on-surface); }
        .icon-btn:active { transform: scale(0.9); }
        .modal__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--sp-3); flex-shrink: 0;}
        .modal__title { font-size: var(--fs-lg); font-weight: 600; }
        .modal__body { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; padding-right: var(--sp-2); margin-right: calc(-1 * var(--sp-2)); }
        .modal__list-item { display:flex; justify-content:space-between; align-items:center; padding: var(--sp-3) 0; border-bottom:1px solid var(--c-outline); gap: var(--sp-2); }
        .modal__list-item:last-child { border-bottom: none; }
        .modal__actions { margin-top: var(--sp-4); display: flex; justify-content: flex-end; gap: var(--sp-2); width: 100%;}
        #generic-modal-body h3, #generic-modal-body h4 { margin-top: 1.2em; margin-bottom: 0.6em; color: var(--c-primary); } 
        #generic-modal-body h4 { font-size: var(--fs-base); font-weight: 600; } 
        #generic-modal-body p, #generic-modal-body li, #generic-modal-body small { color: var(--c-on-surface-secondary); line-height: 1.5; } 
        #generic-modal-body ul, #generic-modal-body ol { list-style-position: inside; padding-left: var(--sp-2); } 
        #generic-modal-body ul li, #generic-modal-body ol li { margin-bottom: 6px; }
        #generic-modal-body ul ul { margin-top: 6px; }
        #generic-modal-body a { color: var(--c-primary); text-decoration: none; }
        #generic-modal-body a:hover { text-decoration: underline; }
        .login-view { position: fixed; inset: 0; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: var(--sp-4); opacity: 0; transition: opacity .5s; background-color: var(--c-background); }
        .login-view--visible { display: flex; opacity: 1; }
        .login-view__card { background-color: var(--c-surface); padding: var(--sp-5); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md); width: 100%; max-width: 340px; text-align: center; animation: pop-in 0.3s ease-out; }
        .login-view__title { margin-bottom: var(--sp-4); font-size: var(--fs-lg); }
        .empty-state { text-align: center; padding: var(--sp-5) 0; color: var(--c-on-surface-secondary); animation: fade-in 0.3s; background: var(--c-surface); border-radius: var(--border-radius-lg); }
        .empty-state .material-icons { font-size: 40px; margin-bottom: var(--sp-2); }
        .empty-state h3 { font-size: var(--fs-lg); font-weight: 600; color: var(--c-on-surface); margin-bottom: var(--sp-2); }
        .filter-pills { display: flex; flex-wrap: wrap; gap: var(--sp-2); }
        .filter-pill { padding: var(--sp-1) var(--sp-3); border: none; border-radius: 99px; font-size: var(--fs-xs); font-weight: 500; background-color: var(--c-surface-variant); color: var(--c-on-surface); cursor: pointer; transition: all 0.2s; }
        .filter-pill:hover { opacity: 0.8; }
        .filter-pill--active { background-color: var(--c-primary); color: var(--c-white); font-weight: 600; }
        #movimiento-modal .modal__body { padding-right: var(--sp-1); margin-right: calc(-1 * var(--sp-1)); }
        #movimiento-modal .form-group { margin-bottom: var(--sp-2); }
        #movimiento-modal .form-label { margin-bottom: 4px; font-size: var(--fs-xs); }
        #movimiento-modal .form-input,
        #movimiento-modal .form-select { padding: var(--sp-2); font-size: var(--fs-sm); }
        #movimiento-modal .form-select { background-position: right 8px center; padding-right: 32px; }
        #movimiento-modal .form-group-addon .icon-btn { height: 38px; width: 38px; align-self: flex-end; margin-bottom: 2px; }
        #movimiento-modal .form-group-addon .form-group { margin-bottom: 0; }
        .toast-container { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: var(--sp-2); pointer-events: none;}
        .toast { background-color: var(--c-black); color: var(--c-white); padding: var(--sp-2) var(--sp-4); border-radius: var(--border-radius-md); box-shadow: var(--shadow-md); pointer-events: all;}
        .toast--danger { background-color: var(--c-danger); }
        .toast--warning { background-color: var(--c-warning); }
        .toast--info { background-color: var(--c-info); }
        .text-positive { color: var(--c-success); } .text-negative { color: var(--c-danger); } .text-warning { color: var(--c-warning); } .text-info { color: var(--c-info); }
        .hidden { display: none !important; }
        .spinner { display: inline-block; width: 1em; height: 1em; border: .15em solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin .8s linear infinite; vertical-align: middle; }
        @keyframes spin { to { transform:rotate(360deg); } }
        #description-suggestions { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: var(--c-surface); border-radius: var(--border-radius-md); box-shadow: var(--shadow-md); z-index: 1060; max-height: 150px; overflow-y: auto; border: 1px solid var(--c-outline); }
        .suggestion-item { padding: var(--sp-2) var(--sp-3); cursor: pointer; font-size: var(--fs-sm); }
        .suggestion-item:hover { background-color: var(--c-surface-variant); }
        .suggestion-item small { color: var(--c-on-surface-secondary); font-size: var(--fs-xs); }
        .budget-track-item { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: var(--sp-3); padding: var(--sp-2) 0; border-bottom: 1px solid var(--c-outline); }
        .budget-track-item:last-child { border-bottom: none; }
        .budget-track-item__main { display: flex; flex-direction: column; gap: var(--sp-1); min-width: 0; }
        .budget-track-item__concept-name { font-weight: 600; font-size: var(--fs-sm); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .budget-track-item__figures { display: flex; flex-direction: column; align-items: flex-end; text-align: right; font-size: var(--fs-xs); }
        .budget-track-item__amount { color: var(--c-on-surface-secondary); }
        .budget-track-item__amount strong { color: var(--c-on-surface); font-weight: 500;}
        .budget-track-item__difference { font-weight: 600; }
        .budget-item__progress { width: 100%; -webkit-appearance: none; appearance: none; height: 6px; border-radius: 99px; overflow: hidden; background-color: var(--c-surface-variant); }
        .budget-item__progress::-webkit-progress-bar { background-color: var(--c-surface-variant); }
        .budget-item__progress::-webkit-progress-value { background-color: var(--c-primary); transition: width 0.3s ease; }
        .budget-item__progress.budget-item__progress--danger::-webkit-progress-value { background-color: var(--c-danger); }
        .budget-item__progress.budget-item__progress--warning::-webkit-progress-value { background-color: var(--c-warning); }
        .investment-asset-card { background-color: var(--c-surface); border-radius: var(--border-radius-lg); padding: var(--sp-3); margin-bottom: var(--sp-2); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .investment-asset-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .investment-asset-card__header { display: grid; grid-template-columns: 1fr auto; align-items: flex-start; gap: var(--sp-2); }
        .investment-asset-card__name { font-size: var(--fs-base); font-weight: 600; }
        .investment-asset-card__value { font-size: var(--fs-lg); font-weight: 700; text-align: right; }
        .investment-asset-card__pnl { font-size: var(--fs-xs); font-weight: 500; text-align: right; }
        .investment-timeline-item { display: flex; align-items: center; gap: var(--sp-3); padding: var(--sp-2) 0; border-bottom: 1px solid var(--c-outline); }
        .investment-timeline-item:last-child { border-bottom: none; }
        .investment-timeline-item__icon { flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: var(--c-surface-variant); border-radius: 50%; }
        .investment-timeline-item__icon .material-icons { font-size: 18px; }
        .investment-timeline-item__details { flex-grow: 1; }
        .investment-timeline-item__description { font-weight: 500; font-size: var(--fs-sm); }
        .investment-timeline-item__date { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); }
        .investment-timeline-item__amount { font-weight: 600; font-size: var(--fs-sm); }
        #exit-screen { display: none; opacity: 0; position: fixed; inset: 0; background-color: var(--c-background); color: var(--c-on-surface); flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-size: 1.5rem; text-align: center; transition: opacity 0.5s ease; }
        .calculator-overlay { align-items: flex-end; background: rgba(0,0,0,0.3); }
        .calculator-ui { width: 100%; max-width: 500px; margin: 0 auto; background-color: var(--c-surface-variant); color: var(--c-on-surface); border-top-left-radius: var(--border-radius-lg); border-top-right-radius: var(--border-radius-lg); padding: var(--sp-4) var(--sp-4) env(safe-area-inset-bottom) var(--sp-4); box-shadow: 0 -5px 20px rgba(0,0,0,0.1); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-overlay--active .calculator-ui { transform: translateY(0); }
        .calculator-display { font-size: 2.5rem; font-weight: 300; text-align: right; padding: var(--sp-2) var(--sp-3); margin-bottom: var(--sp-3); min-height: 60px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--sp-3); }
        .calculator-btn { font-family: var(--font-family); font-size: 1.5rem; font-weight: 400; height: 64px; border-radius: 99px; border: none; background-color: var(--c-surface); color: var(--c-on-surface); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, transform 0.1s; }
        .calculator-btn:active { transform: scale(0.95); }
        .calculator-btn.btn-operator { background-color: var(--c-surface-variant); color: var(--c-on-surface); font-weight: 500; }
        [data-theme="light"] .calculator-btn.btn-operator { background-color: #D1D1D6; }
        .calculator-btn.btn-confirm { background-color: var(--c-primary); color: var(--c-white); font-weight: 500; }
        .calculator-btn.zero { grid-column: span 2; }
        .material-icons.backspace-icon { font-size: 1.5rem; }
        
        /* === Dual Ledger Styles === */
        body[data-ledger-mode="B"] .top-bar {
            background-color: color-mix(in srgb, var(--c-warning) 85%, transparent);
        }
        body[data-ledger-mode="B"] .bottom-nav__item--active {
            color: var(--c-warning);
        }
        #ledger-toggle-btn {
            font-weight: 600;
            padding: 6px 10px;
            font-size: 0.8rem;
            min-width: 80px;
            transition: background-color 0.3s, color 0.3s;
        }


        /* ===================================================================== */
        /* === INICIO DE LOS ESTILOS RESPONSIVE AÑADIDOS ======================= */
        /* ===================================================================== */

        /* --- TABLET STYLES (768px y más) --- */
        @media (min-width: 768px) {
            /* Aumentar el ancho del contenedor principal para aprovechar el espacio */
            .app-layout {
                max-width: 95%;
            }
            .top-bar, .bottom-nav {
                max-width: 100%; /* La cabecera y nav ahora ocupan el ancho del layout */
            }
             /* Centrar el modal en lugar de mostrarlo desde abajo */
            .modal-overlay {
                align-items: center;
            }
            .modal {
                border-radius: var(--border-radius-lg); /* Bordes redondeados por todas partes */
                transform: translateY(0) scale(0.95); /* Animación de entrada con zoom */
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            }
            .modal-overlay--active .modal {
                transform: translateY(0) scale(1);
            }
             /* Más espaciado en las vistas */
            .view {
                padding: 0 var(--sp-5);
            }
            /* Hacer la cuadrícula de KPIs más flexible */
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: var(--sp-4);
            }
        }

        /* --- DESKTOP STYLES (1024px y más) --- */
        @media (min-width: 1024px) {
            /* Permitir el scroll normal del navegador en escritorio */
            body {
                overflow-y: auto;
            }
            /* Reconfigurar el layout principal a un sistema de Sidebar + Contenido */
            .app-layout {
                flex-direction: row; /* Elementos en fila: nav y main */
                max-width: 100%;
                height: 100vh;
            }

            /* --- Transformar la barra de navegación inferior en una barra lateral fija --- */
            .bottom-nav {
                position: fixed; /* Fija en la pantalla */
                flex-direction: column; /* Botones en columna */
                width: 240px; /* Ancho de la barra lateral */
                height: 100vh; /* Altura completa */
                left: 0; /* Pegada a la izquierda */
                top: 0;
                transform: none; /* Resetear transformación móvil */
                border-top: none; /* Quitar borde superior */
                border-right: 1px solid var(--c-outline); /* Añadir borde derecho */
                padding: var(--sp-5) var(--sp-3);
                justify-content: flex-start; /* Alinear items al inicio */
                gap: var(--sp-2);
                box-shadow: none;
            }
            .bottom-nav__item {
                flex: 0 0 auto; /* No crecer, no encoger, base automática */
                flex-direction: row; /* Icono y texto en fila */
                justify-content: flex-start; /* Alinear a la izquierda */
                width: 100%;
                height: auto;
                padding: var(--sp-2) var(--sp-3);
                border-radius: var(--border-radius-md);
            }
            .bottom-nav__item:hover {
                background-color: var(--c-surface-variant);
            }
            .bottom-nav__item--active {
                background-color: var(--c-primary);
                color: var(--c-white);
            }
            body[data-ledger-mode="B"] .bottom-nav__item--active {
                background-color: var(--c-warning);
                color: var(--c-black);
            }
            .bottom-nav__item--active:hover {
                 background-color: var(--c-primary-hover);
            }
            .bottom-nav__item .material-icons {
                margin-right: var(--sp-3); /* Espacio entre icono y texto */
                font-size: 20px;
            }
            /* Mostrar las etiquetas de texto en la barra lateral */
            .bottom-nav__label {
                display: inline-block; /* Hacer visible el texto */
                font-size: var(--fs-sm);
                font-weight: 500;
                margin-top: 0;
            }

            /* --- Ajustar el contenido principal --- */
            .app-layout__main {
                margin-left: 240px; /* Dejar espacio para la barra lateral */
                width: calc(100% - 240px); /* Ocupar el resto del ancho */
                height: 100vh;
                padding: 60px var(--sp-6) var(--sp-6) var(--sp-6); /* Padding para cabecera y bordes */
            }
            /* Limitar el ancho del contenido dentro de .app-layout__main para mejorar la legibilidad */
            .view {
                max-width: 1100px;
                margin: 0 auto;
                padding: 0;
            }
            /* Ajustar cabecera para que ocupe solo el área de contenido */
            .top-bar {
                max-width: none;
                width: calc(100% - 240px); /* Ancho del área de contenido */
                left: auto; /* Desanclar de la izquierda */
                right: 0; /* Anclar a la derecha */
                transform: none; /* Resetear transformación */
                padding-left: var(--sp-6);
                padding-right: var(--sp-6);
            }
            
            /* === INICIO DE LA CORRECCIÓN === */
            /* Se ha eliminado la regla que ocultaba el botón flotante en escritorio. */
            /* El FAB ahora será visible en todas las resoluciones. */
            /*
            .fab {
                display: none;
            }
            */
            /* === FIN DE LA CORRECCIÓN === */
            
            /* Ajustar la posición del contenedor de toasts */
            .toast-container {
                bottom: var(--sp-4);
                left: auto;
                right: calc(240px / 2); /* Centrado en la barra lateral */
                transform: translateX(50%);
            }
        }
        
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.1.0/"
  }
}
</script>
</head>
<body data-ledger-mode="A">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    
    <div id="introScreen" class="intro-screen">
        <div class="starry-background"></div>
        <img id="splashImage" class="intro-screen__logo" src="aiDANaI.webp" alt="Logo App" />
        <div id="quoteContainer" class="intro-screen__quote-container">
            <p id="quoteText" class="intro-screen__quote-text"></p>
            <span id="quoteAuthor" class="intro-screen__quote-author"></span>
        </div>
    </div>

    <div id="login-screen" class="login-view">
        <div class="login-view__card">
            <h2 id="login-title" class="login-view__title">💰 Cuentas aiDANaI</h2>
            <form id="login-form" noValidate>
                <div class="form-group"><input type="email" id="login-email" class="form-input" placeholder="Correo electrónico" required autoComplete="email" autoCapitalize="none" /><span class="form-error" id="login-email-error"></span></div>
                <div class="form-group"><input type="password" id="login-password" class="form-input" placeholder="Contraseña" required autoComplete="current-password" /><span class="form-error" id="login-password-error"></span></div>
                <div class="form-grid" style="margin-top: 16px;">
                    <button type="button" data-action="login" class="btn btn--primary">Iniciar Sesión</button>
                    <button type="button" data-action="register" class="btn btn--secondary">Registrarse</button>
                </div>
                <p id="login-error" class="form-error" style="min-height: 16px; margin-top: 8px;"></p>
            </form>
        </div>
    </div>
    
    <div id="app-root" class="app-layout">
        <nav class="bottom-nav">
            <button data-action="navigate" data-page="movimientos-page" class="bottom-nav__item">
                <span class="material-icons">swap_horiz</span>
                <span class="bottom-nav__label">Movimientos</span>
            </button>
            <button data-action="navigate" data-page="panel-control-page" class="bottom-nav__item">
                <span class="material-icons">dashboard</span>
                <span class="bottom-nav__label">Panel Control</span>
            </button>
            <button data-action="navigate" data-page="cuentas-page" class="bottom-nav__item">
                <span class="material-icons">account_balance_wallet</span>
                <span class="bottom-nav__label">Cuentas</span>
            </button>
            <button data-action="navigate" data-page="informes-page" class="bottom-nav__item">
                <span class="material-icons">analytics</span>
                <span class="bottom-nav__label">Informes</span>
            </button>
            <button data-action="navigate" data-page="inversiones-page" class="bottom-nav__item">
                <span class="material-icons">trending_up</span>
                <span class="bottom-nav__label">Portafolio</span>
            </button>
            <button data-action="navigate" data-page="presupuestos-page" class="bottom-nav__item">
                <span class="material-icons">pie_chart</span>
                <span class="bottom-nav__label">Presupuestos</span>
            </button>
            <button data-action="navigate" data-page="configuracion-page" class="bottom-nav__item">
                <span class="material-icons">settings</span>
                <span class="bottom-nav__label">Ajustes</span>
            </button>
        </nav>

        <header id="app-top-bar" class="top-bar">
            <div id="top-bar-left-button" class="top-bar__left-button">
                 <button id="ledger-toggle-btn" class="btn btn--secondary" data-action="toggle-ledger" title="Cambiar Contabilidad">Cont. A</button>
            </div>
            <h1 id="top-bar-title" class="top-bar__title"></h1>
            <div id="top-bar-actions" class="top-bar__actions"></div>
        </header>

        <main class="app-layout__main">
            <section id="panel-control-page" class="view">
                <div class="card card--no-bg">
                    <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary>
                                <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">filter_list</span>Filtros</h3>
                                <span class="material-icons accordion__icon">expand_more</span>
                            </summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                <div class="form-group"><label for="filter-periodo" class="form-label">Periodo</label><select id="filter-periodo" class="form-select"><option value="mes-actual">Mes Actual</option><option value="año-actual">Año Actual</option><option value="siempre">Siempre</option><option value="custom">Personalizado</option></select></div>
                                <div id="custom-date-filters" class="hidden form-grid"><div class="form-group"><label for="filter-fecha-inicio" class="form-label">Desde</label><input type="date" id="filter-fecha-inicio" class="form-input" /></div><div class="form-group"><label for="filter-fecha-fin" class="form-label">Hasta</label><input type="date" id="filter-fecha-fin" class="form-input" /></div></div>
                                <div class="form-grid"><div class="form-group"><label for="filter-cuenta" class="form-label">Cuenta</label><select id="filter-cuenta" class="form-select"></select></div><div class="form-group"><label for="filter-concepto" class="form-label">Concepto</label><select id="filter-concepto" class="form-select"></select></div></div>
                                <button data-action="apply-filters" class="btn btn--primary btn--full">Aplicar Filtros</button>
                            </div>
                        </details>
                    </div>
                </div>
                <section id="kpi-container" class="kpi-grid" aria-label="Indicadores clave de rendimiento">
                </section>
                
                <div class="card card--no-bg">
                    <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary>
                                <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">category</span>Totales por Concepto</h3>
                                <span class="material-icons accordion__icon">expand_more</span>
                            </summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                <div class="chart-container" style="height: 240px; margin-bottom: var(--sp-2);">
                                    <canvas id="conceptos-chart"></canvas>
                                </div>
                                <div id="concepto-totals-list"></div>
                            </div>
                        </details>
                    </div>
                </div>
            </section>

            <section id="movimientos-page" class="view" style="padding: 0;">
                <div id="movimientos-list-container">
                    <div id="virtual-list-sizer">
                        <div id="virtual-list-content"></div>
                    </div>
                </div> 
                <div id="empty-movimientos" class="empty-state hidden" style="margin: 0 var(--sp-4);">
                    <span class="material-icons">receipt_long</span>
                    <h3>Tu historial empieza aquí</h3>
                    <p>Pulsa el botón `+` para añadir tu primer ingreso o gasto.</p>
                </div>
            </section>
            
            <section id="inversiones-page" class="view">
                <div id="investment-list-view">
                    <div id="investment-global-kpis"></div>
                    <div class="card card--no-bg" style="padding:0; margin-bottom: var(--sp-3);">
                         <div class="form-grid">
                            <button class="btn btn--secondary" data-action="manage-investment-accounts"><span class="material-icons" style="font-size:16px;">checklist</span>Gestionar Activos</button>
                            <button class="btn btn--secondary" data-action="add-aportacion"><span class="material-icons" style="font-size:16px;">add_card</span>Aportar/Retirar</button>
                        </div>
                    </div>
                    <div id="investment-assets-list"></div>
                    <div id="empty-investments" class="empty-state hidden">
                        <span class="material-icons">rocket_launch</span>
                        <h3>¿Listo para despegar?</h3>
                        <p>Para empezar, pulsa en "Gestionar Activos" y selecciona las cuentas que quieres incluir en tu portafolio.</p>
                    </div>
                </div>
                <div id="investment-detail-view" class="hidden"></div>
            </section>

            <section id="cuentas-page" class="view">
                <div class="card">
                    <div class="kpi-item" style="text-align: left; padding: var(--sp-4); background: none;">
                        <h4 class="kpi-item__label" style="text-align: left;">Saldo Total Seleccionado</h4>
                        <strong id="cuentas-total-balance" class="kpi-item__value" style="font-size: var(--fs-xl);">0,00 €</strong>
                    </div>
                </div>
                <div class="card card--no-bg">
                    <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary>
                                <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">account_balance_wallet</span>Fondos y Cuentas</h3>
                                <span class="material-icons accordion__icon">expand_more</span>
                            </summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                <h3 class="card__title" style="font-size: var(--fs-base); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-2); padding: 0;">
                                    <span class="material-icons" style="font-size: var(--fs-base);">filter_alt</span>
                                    Filtro por tipo de cuenta
                                </h3>
                                <div class="form-group">
                                    <div id="filter-account-types-pills" class="filter-pills"></div>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                <div id="resumen-cuentas-container"></div>

                <div class="card card--no-bg accordion-wrapper">
                    <div id="liquid-assets-chart-container" class="hidden accordion" style="margin-bottom: var(--sp-4);">
                        <div style="padding: var(--sp-3) var(--sp-4);">
                           <h4 class="kpi-item__label" style="text-align: center; margin-bottom: var(--sp-2);">Distribución de Activos Líquidos</h4>
                            <div class="chart-container" style="height: 200px; margin-bottom: 0;">
                                <canvas id="liquid-assets-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="presupuestos-page" class="view">
                 <div class="card card--no-bg">
                     <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary>
                                <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">query_stats</span>Gestión de Presupuestos</h3>
                                <span class="material-icons accordion__icon">expand_more</span>
                            </summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                <div id="budget-controls" style="display: flex; gap: var(--sp-3); margin-bottom: var(--sp-4); flex-wrap: wrap;">
                                    <select id="budget-year-selector" class="form-select" style="flex-basis: 120px; flex-grow: 1;"></select>
                                    <button data-action="update-budgets" class="btn btn--secondary" title="Editar presupuestos del año seleccionado">
                                        <span class="material-icons" style="font-size: 16px;">edit</span>
                                        <span>Editar Año</span>
                                    </button>
                                </div>
                                <div id="budget-tracking-list"></div>
                                <div id="budget-init-placeholder" class="empty-state hidden" style="background: transparent; padding: var(--sp-2) 0;">
                                    <span class="material-icons">auto_fix_high</span>
                                    <h3 id="budget-placeholder-title">Crear Presupuestos</h3>
                                    <p id="budget-placeholder-text">Aún no se han creado los presupuestos para el año seleccionado.</p>
                                    <button data-action="create-budgets" class="btn btn--primary" style="margin-top: var(--sp-3);">Crear Ahora</button>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </section>

            <section id="informes-page" class="view">
                <div class="card card--no-bg">
                    <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary>
                                <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">filter_list</span>Filtros del Informe</h3>
                                <span class="material-icons accordion__icon">expand_more</span>
                            </summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="informe-fecha-inicio" class="form-label">Desde</label>
                                        <input type="date" id="informe-fecha-inicio" class="form-input" />
                                    </div>
                                    <div class="form-group">
                                        <label for="informe-fecha-fin" class="form-label">Hasta</label>
                                        <input type="date" id="informe-fecha-fin" class="form-input" />
                                    </div>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="informe-cuenta" class="form-label">Cuenta</label>
                                        <select id="informe-cuenta" class="form-select"></select>
                                    </div>
                                    <div class="form-group">
                                        <label for="informe-concepto" class="form-label">Concepto</label>
                                        <select id="informe-concepto" class="form-select"></select>
                                    </div>
                                </div>
                                <button data-action="apply-informe-filters" class="btn btn--primary btn--full">Generar Informe</button>
                            </div>
                        </details>
                    </div>
                </div>

                <div id="informe-results-container" class="hidden">
                     <section id="informe-kpi-container" class="kpi-grid" aria-label="Resumen del informe">
                        <!-- KPIs se insertarán aquí -->
                     </section>
                    <div class="card">
                        <h3 class="card__title"><span class="material-icons">timeline</span>Evolución Mensual</h3>
                        <div class="card__content">
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="informes-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="empty-informes" class="empty-state" style="margin: 0 var(--sp-4);">
                    <span class="material-icons">analytics</span>
                    <h3>Genera tu Informe</h3>
                    <p>Selecciona los filtros y pulsa "Generar Informe" para ver la evolución de tus finanzas.</p>
                </div>
            </section>

            <section id="configuracion-page" class="view">
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion" open>
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">account_circle</span>
                                Cuenta de Usuario
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <div class="modal__list-item" style="padding-left: 0; padding-right: 0;">
                                <span>Sesión iniciada como:</span>
                                <strong id="config-user-email">cargando...</strong>
                            </div>
                            <button data-action="logout" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);">
                                <span class="material-icons" style="font-size: 16px;">logout</span>
                                Cerrar Sesión
                            </button>
                            <button data-action="delete-account" class="btn btn--danger btn--full" style="margin-top: var(--sp-2); background-color: var(--c-black); border: 1px solid var(--c-danger);">
                                <span class="material-icons" style="font-size: 16px;">delete_forever</span>
                                Eliminar Mi Cuenta Permanentemente
                            </button>
                        </div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                     <details class="accordion" open>
                        <summary><h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">badge</span>Configuración General</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                         <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <h3 class="card__title" style="margin-top: 0; font-size: var(--fs-base); padding: 0;"><span class="material-icons">rocket_launch</span>Opciones de Arranque</h3>
                             <div class="form-checkbox-group">
                                <input type="checkbox" id="config-skip-intro" />
                                <label for="config-skip-intro">Omitir intro y cita al iniciar la app</label>
                            </div>
                            <button data-action="save-config" class="btn btn--primary btn--full" style="margin-top: var(--sp-4);">Guardar Configuración</button>
                        </div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary><h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">edit_note</span>Gestión de Cuentas / Conceptos</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                             <div class="form-grid">
                                <button data-action="manage-cuentas" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">account_balance</span>Cuentas</button>
                                <button data-action="manage-conceptos" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">category</span>Conceptos</button>
                            </div>
                        </div>
                    </details>
                </div>
                 <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary><h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">backup</span>Gestión de Datos</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                             <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-4);">La importación de JSON reemplazará todos los datos actuales. Se recomienda exportar primero. La importación de CSV añade nuevos movimientos desde un archivo.</p>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <button data-action="export-data" class="btn btn--secondary" title="Exportar una copia de seguridad completa en formato JSON."><span class="material-icons" style="font-size: 16px;">save</span>Exportar JSON</button>
                                <button data-action="import-data" class="btn btn--secondary" title="Importar desde un archivo de seguridad JSON."><span class="material-icons" style="font-size: 16px;">file_upload</span>Importar JSON</button>
                                <button data-action="export-csv" class="btn btn--secondary" title="Exportar movimientos a un archivo CSV para abrir en hojas de cálculo."><span class="material-icons" style="font-size: 16px;">list_alt</span>Exportar CSV</button>
                                <button data-action="import-csv-wizard" class="btn btn--secondary" title="Importar movimientos desde un archivo CSV con un asistente."><span class="material-icons" style="font-size: 16px;">file_download</span>Importar CSV</button>
                                <input type="file" id="import-file-input" class="hidden" accept=".json" />
                                <input type="file" id="import-csv-file-input" class="hidden" accept=".csv,text/csv" />
                            </div>
                            <button data-action="clear-data" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);">Borrar Todos los Datos</button>
                        </div>
                    </details>
                </div>
            </section>
        </main>
        
        <button data-action="add-movement" id="fab-add-movimiento" class="fab" title="Añadir Movimiento" aria-label="Añadir Movimiento"><span class="material-icons">add</span></button>

    </div>

    <div id="toast-container" aria-live="assertive"></div>
    <div id="movimiento-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="form-movimiento-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="form-movimiento-title" class="modal__title">Añadir Movimiento</h3>
                <div style="display: flex; align-items: center; gap: var(--sp-1); margin-left: auto;">
                    <button class="icon-btn" data-action="copy-last-movement" title="Copiar último movimiento" aria-label="Copiar último movimiento"><span class="material-icons">history</span></button>
                    <button class="icon-btn" data-action="close-modal" data-modal-id="movimiento-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
                </div>
            </header>
            <div class="modal__body">
                 <form id="form-movimiento" noValidate>
                    <input type="hidden" id="movimiento-id" />
                    <div class="form-group"><label for="movimiento-tipo-selector" class="form-label">Tipo</label><select id="movimiento-tipo-selector" class="form-select"><option value="movimiento">Movimiento</option><option value="traspaso">Traspaso</option></select></div>
                    <div class="form-grid"><div class="form-group"><label for="movimiento-cantidad" class="form-label">Cantidad (gasto en negativo)</label><input type="text" id="movimiento-cantidad" class="form-input input-amount-calculator" readonly required placeholder="Ej: -50,25" /><span class="form-error" id="movimiento-cantidad-error"></span></div><div class="form-group"><label for="movimiento-fecha" class="form-label">Fecha y Hora</label><input type="datetime-local" id="movimiento-fecha" class="form-input" required /><span class="form-error" id="movimiento-fecha-error"></span></div></div>
                    <div class="form-group">
                        <label for="movimiento-descripcion" class="form-label">Descripción</label>
                        <input type="text" id="movimiento-descripcion" class="form-input" required placeholder="Ej: Compra semanal" />
                        <span class="form-error" id="movimiento-descripcion-error"></span>
                        <div id="description-suggestions"></div>
                    </div>
                    <div id="movimiento-fields">
                        <div class="form-group-addon"><div class="form-group"><label for="movimiento-concepto" class="form-label">Concepto</label><select id="movimiento-concepto" class="form-select" required></select><span class="form-error" id="movimiento-concepto-error"></span></div><button type="button" data-action="manage-conceptos" class="icon-btn" title="Gestionar Conceptos"><span class="material-icons">more_vert</span></button></div>
                        <div class="form-group-addon"><div class="form-group"><label for="movimiento-cuenta" class="form-label">Cuenta</label><select id="movimiento-cuenta" class="form-select" required></select><span class="form-error" id="movimiento-cuenta-error"></span></div><button type="button" data-action="manage-cuentas" class="icon-btn" title="Gestionar Cuentas"><span class="material-icons">more_vert</span></button></div>
                    </div>
                    <div id="traspaso-fields" class="hidden">
                        <div class="form-group"><label for="movimiento-cuenta-origen" class="form-label">Cuenta Origen</label><select id="movimiento-cuenta-origen" class="form-select"></select></div>
                        <div class="form-group"><label for="movimiento-cuenta-destino" class="form-label">Cuenta Destino</label><select id="movimiento-cuenta-destino" class="form-select"></select><span class="form-error" id="movimiento-cuenta-destino-error"></span></div>
                    </div>
                    <div class="modal__actions">
                        <button type="button" id="delete-movimiento-btn" data-action="delete-movement-from-modal" class="btn btn--danger hidden" style="margin-right:auto;">Borrar</button>
                        <button type="button" data-action="close-modal" data-modal-id="movimiento-modal" class="btn btn--secondary">Cancelar</button>
                        <button id="save-movimiento-btn" type="submit" class="btn btn--primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="generic-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="generic-modal-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="generic-modal-title" class="modal__title"></h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="generic-modal" title="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="generic-modal-body" class="modal__body"></div>
        </div>
    </div>

    <div id="export-csv-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="export-csv-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="export-csv-title" class="modal__title">Exportar Movimientos a CSV</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="export-csv-modal" title="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div class="modal__body">
                <form id="export-csv-form" novalidate>
                    <div class="form-group">
                        <label class="form-label">Rango de Fechas</label>
                        <div class="form-checkbox-group">
                            <input type="radio" id="csv-export-all" name="csv-export-range" value="all" checked>
                            <label for="csv-export-all">Todos los movimientos</label>
                        </div>
                        <div class="form-checkbox-group">
                            <input type="radio" id="csv-export-range" name="csv-export-range" value="range">
                            <label for="csv-export-range">Seleccionar rango</label>
                        </div>
                    </div>
                    <div id="csv-date-filters" class="hidden form-grid">
                        <div class="form-group"><label for="csv-fecha-inicio" class="form-label">Desde</label><input type="date" id="csv-fecha-inicio" class="form-input" /></div>
                        <div class="form-group"><label for="csv-fecha-fin" class="form-label">Hasta</label><input type="date" id="csv-fecha-fin" class="form-input" /></div>
                    </div>
                    <div class="modal__actions">
                        <button type="submit" class="btn btn--primary btn--full">Generar y Descargar CSV</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="manage-investment-accounts-modal" class="modal-overlay"></div>
    <div id="valoracion-modal" class="modal-overlay"></div>
    <div id="aportacion-modal" class="modal-overlay"></div>
    <div id="import-csv-wizard-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="import-csv-wizard-title">
        <div class="modal" style="max-width: 95%; max-height: 90vh; width: 600px;">
            <header class="modal__header">
                <h3 id="import-csv-wizard-title" class="modal__title">Asistente de Importación CSV</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="import-csv-wizard-modal" title="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="import-csv-wizard-body" class="modal__body">
                <!-- Contenido dinámico del asistente -->
            </div>
            <div id="import-csv-wizard-actions" class="modal__actions">
                <!-- Botones dinámicos del asistente -->
            </div>
        </div>
    </div>
    
    <div id="calculator-modal" class="modal-overlay calculator-overlay">
        <div class="calculator-ui">
            <div id="calculator-display" class="calculator-display">0</div>
            <div id="calculator-grid" class="calculator-grid">
                <button class="calculator-btn btn-operator" data-key="clear">C</button>
                <button class="calculator-btn btn-operator" data-key="sign">+/-</button>
                <button class="calculator-btn btn-operator" data-key="backspace"><span class="material-icons backspace-icon">backspace</span></button>
                <button class="calculator-btn btn-confirm" data-key="done">OK</button>
                
                <button class="calculator-btn" data-key="7">7</button>
                <button class="calculator-btn" data-key="8">8</button>
                <button class="calculator-btn" data-key="9">9</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-1" style="visibility: hidden;"></button>

                <button class="calculator-btn" data-key="4">4</button>
                <button class="calculator-btn" data-key="5">5</button>
                <button class="calculator-btn" data-key="6">6</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-2" style="visibility: hidden;"></button>
                
                <button class="calculator-btn" data-key="1">1</button>
                <button class="calculator-btn" data-key="2">2</button>
                <button class="calculator-btn" data-key="3">3</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-3" style="visibility: hidden;"></button>

                <button class="calculator-btn zero" data-key="0">0</button>
                <button class="calculator-btn" data-key="comma">,</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-4" style="visibility: hidden;"></button>
            </div>
        </div>
    </div>

    <div id="exit-screen">
        <p>🧮✨ ¡Tus números están en orden, es hora de descansar! ✨🧮<br>💰 Tu asistente de finanzas personales se queda cuidando tus cuentas 💰</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script type="module">
// =================================================================================
// 0. TYPE DEFINITIONS & DECLARATIONS
// =================================================================================
// For browser environment, we'll declare global variables provided by imported scripts
// declare var firebase: any;
// declare var Chart: any;
// declare var ChartDataLabels: any;

// =================================================================================
// 1. STATE & GLOBAL VARIABLES
// =================================================================================
const quotesData = [ { "cita": "Los inversores conservadores duermen bien.", "autor": "Benjamin Graham" }, { "cita": "Nunca asciendas a alguien que no ha cometido errores, porque si lo haces, estás ascendiendo a alguien que nunca ha hecho nada.", "autor": "Benjamin Graham" }, { "cita": "Si se han hecho los deberes antes de comprar una acción, el momento de venderla es: normalmente, nunca.", "autor": "Benjamin Graham" }, { "cita": "Mientras que el entusiasmo es necesario para conseguir grandes logros en cualquier lugar, en Wall Street suele conducir al desastre.", "autor": "John Templeton" }, { "cita": "Sin tener fe en el futuro, nadie invertiría. Para ser inversor, debes creer en un mañana mejor.", "autor": "John Templeton" }, { "cita": "Las cuatro palabras más caras de nuestro lenguaje son: 'Esta vez es diferente'.", "autor": "John Templeton" }, { "cita": "Céntrate en el valor porque la mayoría de los inversores se fijan en perspectivas y tendencias.", "autor": "Peter Lynch" }, { "cita": "El éxito es un proceso de búsqueda continua de respuestas a nuevas preguntas.", "autor": "Peter Lynch" }, { "cita": "Conoce en lo que inviertes, y por qué.", "autor": "Peter Lynch" }, { "cita": "Cuando vendes en momentos de desesperación, siempre vendes barato.", "autor": "Peter Lynch" }, { "cita": "Una persona que posee una propiedad y tiene una participación en la empresa probablemente trabajará más duro, se sentirá más feliz y hará un mejor trabajo que otra que no tiene nada.", "autor": "Peter Lynch" }, { "cita": "El riesgo viene de no saber lo que se está haciendo.", "autor": "Warren Buffett" }, { "cita": "Cuesta 20 años construir una reputación y 5 minutos destruirla. Si piensas sobre ello, harás las cosas de manera diferente.", "autor": "Warren Buffett" }, { "cita": "En el mundo de los negocios, el espejo retrovisor está siempre más claro que el parabrisas.", "autor": "Warren Buffett" }, { "cita": "La inversión más importante que puedes hacer es en uno mismo.", "autor": "Warren Buffett" }, { "cita": "Sé temeroso cuando otros sean avariciosos, sé avaricioso cuando otros sean temerosos.", "autor": "Warren Buffett" }, { "cita": "Sé consciente de lo que no sabes. Siéntete a gusto entendiendo tus errores y debilidades.", "autor": "Charlie Munger" }, { "cita": "Para hacer dinero en los mercados, tienes que pensar diferente y ser humilde.", "autor": "Charlie Munger" }, { "cita": "El principal problema del inversor, e incluso su peor enemigo, es probablemente él mismo", "autor": "Benjamin Graham" }, { "cita": "Las personas que no pueden controlar sus emociones no son aptas para obtener beneficios mediante la inversión", "autor": "Benjamin Graham" }, { "cita": "Trato de comprar acciones en los negocios que son tan maravillosos que un tonto podría manejarlos. Tarde o temprano uno lo hará", "autor": "Warren Buffett" }, { "cita": "Un inversor debería actuar como si tuviera una tarjeta con solo 20 decisiones (de compra) para tomar a lo largo de su vida", "autor": "Warren Buffett" }, { "cita": "Regla número 1: nunca pierdas dinero. Regla número 2: nunca olvides la regla número 1", "autor": "Warren Buffett" }, { "cita": "Se gana dinero descontando lo obvio y apostando a lo inesperado", "autor": "George Soros" }, { "cita": "El problema no es lo que uno no sabe, sino lo que uno cree que sabe estando equivocado", "autor": "George Soros" }, { "cita": "Si invertir es entretenido, si te estás divirtiendo, probablemente no estés ganando dinero. Las buenas inversiones son aburridas", "autor": "George Soros" }, { "cita": "Se puede perder dinero a corto plazo, pero necesitas del largo plazo para ganar dinero", "autor": "Peter Lynch" }, { "cita": "La mejor empresa para comprar puede ser alguna que ya tienes en cartera", "autor": "Peter Lynch" }, { "cita": "La clave para ganar dinero con las acciones es no tenerles miedo", "autor": "Peter Lynch" }, { "cita": "Los mercados alcistas nacen en el pesimismo, crecen en el escepticismo, maduran en el optimismo y mueren en la euforia", "autor": "John Templeton" }, { "cita": "El momento de máximo pesimismo es el mejor para comprar y el momento de máximo optimismo es el mejor para vender", "autor": "John Templeton" }, { "cita": "Un inversor que tiene todas las respuestas ni siquiera entiende las preguntas", "autor": "John Templeton" }, { "cita": "La inversión es un negocio a largo plazo donde la paciencia marca la rentabilidad", "autor": "Francisco García Paramés" }, { "cita": "¿Cuándo vendemos un valor? Respondemos siempre: cuando haya una oportunidad mejor. Ese es nuestro objetivo permanente, mejorar la cartera cada día", "autor": "Francisco García Paramés" }, { "cita": "Lo que en la Bolsa saben todos, no me interesa", "autor": "André Kostolany" }, { "cita": "No sirve para nada proclamar la verdad en economía o recomendar cosas útiles. Es la mejor manera de hacerse enemigos", "autor": "André Kostolany" }, { "cita": "Un inversionista pierde la capacidad de raciocinio cuando gana los primeros diez mil dólares. A partir de entonces se convierte en un pelele fácilmente manipulable", "autor": "André Kostolany" }, { "cita": "Comprar títulos, acciones de empresas, tomarse unas pastillas para dormir durante 20/30 años y cuando uno despierta, ¡voilà! es millonario", "autor": "André Kostolany" }, { "cita": "No sé si los próximos 1.000 puntos del Dow Jones serán hacia arriba o hacia abajo, pero estoy seguro de que los próximos 10.000 serán hacia arriba", "autor": "Peter Lynch" }, { "cita": "El destino de un inversor lo marca su estómago , no su cerebro", "autor": "Peter Lynch" }, { "cita": "No siga mis pasos porque aun en el caso de que acierte al comprar usted no sabrá cuando vendo", "autor": "Peter Lynch" }, { "cita": "Calcule las 'ganancias del dueño' para conseguir una reflexión verdadera del valor", "autor": "Warren Buffett" }, { "cita": "Busque compañías con altos márgenes de beneficio", "autor": "Warren Buffett" }, { "cita": "Invierta siempre para el largo plazo", "autor": "Warren Buffett" }, { "cita": "El consejo de que 'usted nunca quiebra tomando un beneficio' es absurdo", "autor": "Warren Buffett" }, { "cita": "¿El negocio tiene una historia de funcionamiento constante?", "autor": "Warren Buffett" }, { "cita": "Recuerde que el mercado de valores es maníaco-depresivo", "autor": "Benjamin Graham" }, { "cita": "Compre un negocio, no alquile la acción", "autor": "Warren Buffett" }, { "cita": "Mientras más absurdo sea el comportamiento del mercado mejor será la oportunidad para el inversor metódico", "autor": "Benjamin Graham" }, { "cita": "Se puede perder dinero a corto plazo, pero usted sigue siendo un idiota", "autor": "Joel Greenblatt" }, { "cita": "Los mercados alcistas no tienen resistencia y los bajistas no tienen soporte", "autor": "Ed Downs" }, { "cita": "El pánico causa que vendas en el bajón, y la codicia causa que compres cerca a la cima", "autor": "Stan Weinstein" }, { "cita": "Las dos grandes fuerzas que mueven los mercados son la codicia y el miedo", "autor": "Anónimo" }, { "cita": "Todo lo que sube baja y todo lo que baja sube", "autor": "Anónimo" }, { "cita": "Si no sientes miedo en el momento de comprar es que estás comprando mal", "autor": "Anónimo" }, { "cita": "Que el último duro lo gane otro", "autor": "Anónimo" }, { "cita": "La clave para hacer dinero en acciones es no asustarse de ellas", "autor": "Peter Lynch" }, { "cita": "El precio es lo que pagas, el valor es lo que recibes", "autor": "Warren Buffett" }, { "cita": "No es necesario hacer cosas extraordinarias para conseguir resultados extraordinarios", "autor": "Warren Buffett" }, { "cita": "Alguien está sentado en la sombra hoy porque alguien plantó un árbol mucho tiempo atrás", "autor": "Warren Buffett" }, { "cita": "Únicamente cuando la marea baja, descubres quién ha estado nadando desnudo", "autor": "Warren Buffett" }, { "cita": "No tenemos que ser más inteligentes que el resto, tenemos que ser más disciplinados que el resto", "autor": "Warren Buffett" }, { "cita": "Si compras cosas que no necesitas, pronto tendrás que vender cosas que necesitas", "autor": "Warren Buffett" }, { "cita": "Nunca inviertas en un negocio que no puedas entender", "autor": "Warren Buffett" }, { "cita": "El tiempo es amigo de las empresas maravillosas y enemigo de las mediocres", "autor": "Warren Buffett" }, { "cita": "Nuestro periodo de espera favorito es para siempre", "autor": "Warren Buffett" }, { "cita": "Wall Street es el único lugar al que las personas van en un Rolls-Royce, para recibir asesoría de quienes toman el metro", "autor": "Warren Buffett" }, { "cita": "Llega un momento en el que debes empezar a hacer lo que realmente quieres. Busca un trabajo que te guste y saltarás de la cama cada mañana con fuerza", "autor": "Warren Buffett" }, { "cita": "Es siempre mejor pasar el tiempo con gente mejor que tú. Escoge asociados cuyo comportamiento es mejor que el tuyo e irás en esa dirección", "autor": "Warren Buffett" }, { "cita": "Toma 20 años en construir una reputación y 5 minutos en arruinarla. Si piensas sobre ello, harás las cosas de forma diferente", "autor": "Warren Buffett" }, { "cita": "No importa el talento o los esfuerzos, hay cosas que llevan tiempo. No puedes producir un bebé en un mes dejando embarazadas a 9 mujeres", "autor": "Warren Buffett" }, { "cita": "Las oportunidades aparecen pocas veces. Cuando llueva oro sal a la calle con un cesto grande y no con un dedal", "autor": "Warren Buffett" }, { "cita": "La gente siempre me pregunta dónde deberían trabajar y yo siempre les digo que vayan a trabajar con aquellos a los que más admiran", "autor": "Warren Buffett" }, { "cita": "¿Cuándo hay que vender una acción? Pues cuando tengamos una oportunidad mejor a la vista", "autor": "Francisco García Paramés" }, { "cita": "Nunca acudo a las OPV, me gusta estar en las empresas que pueden ser opadas por competidores, no en las salidas a bolsa", "autor": "Francisco García Paramés" }, { "cita": "Si en el mercado hay más tontos que papel, la bolsa va a subir, si hay más papel que tontos, la bolsa baja", "autor": "André Kostolany" }, { "cita": "No persiga nunca una acción, tenga paciencia que la próxima oportunidad va a llegar con toda seguridad", "autor": "André Kostolany" }, { "cita": "Lo que todos saben en la bolsa, no nos interesa a los especuladores", "autor": "André Kostolany" }, { "cita": "Las inversiones exitosas consisten en saber gestionar el riesgo, no en evitarlo.", "autor": "Benjamin Graham" }, { "cita": "Una gran compañía no es una buena inversión si pagas mucho por la acción", "autor": "Benjamin Graham" }, { "cita": "A veces es mejor pensar una hora sobre el dinero que dedicar una semana a trabajar para obtenerlo.", "autor": "André Kostolany" }, { "cita": "En la Bolsa, con frecuencia, hay que cerrar los ojos para ver mejor.", "autor": "André Kostolany" }, { "cita": "Si la inversión es entretenida, si te estás divirtiendo, es probable que no estés ganando dinero. Una buena inversión es aburrida.", "autor": "George Soros" }, { "cita": "Las burbujas del mercado de valores no crecen de la nada. Tienen una base sólida en la realidad, pero la realidad está distorsionada por un malentendido.", "autor": "George Soros" }, { "cita": "Nunca digas que no puedes permitirte algo. Esa es la aptitud de un hombre pobre. Pregúntate cómo permitírtelo.", "autor": "Robert Kiyosaki" }, { "cita": "Una diferencia importante es que los ricos compran los lujos al final, mientras que los pobres y la clase media tienden a comprar los lujos primero.", "autor": "Robert Kiyosaki" }, { "cita": "Mantén tus activos bajo mínimos, reduce los pasivos y, con mucha disciplina, ve construyendo una base de activos sólida.", "autor": "Robert Kiyosaki" }, { "cita": "No ahorres lo que queda después de gastar, sino gasta lo que queda después de ahorrar.", "autor": "Warren Buffett" }, { "cita": "El riesgo viene de no saber lo que estás haciendo.", "autor": "Warren Buffett" }, { "cita": "Sea temeroso cuando otros son codiciosos, y sea codicioso cuando otros son temerosos.", "autor": "Warren Buffett" }, { "cita": "No compres cosas que no necesitas, con dinero que no tienes, para impresionar a gente que no te importa.", "autor": "Dave Ramsey" } ];
const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };

const getInitialDb = () => ({ 
    cuentas: [], conceptos: [], movimientos: [], presupuestos: [], 
    inversiones_historial: [],
    inversion_cashflows: [],
    config: { skipIntro: false } 
});

let currentUser = null, unsubscribeFromDb = null, saveTimeout = null, db = getInitialDb(), deselectedAccountTypesFilter = new Set();
let isOffBalanceMode = false;
let descriptionIndex = {};
const originalButtonTexts = new Map();
let conceptosChart = null, liquidAssetsChart = null, detailInvestmentChart = null, informesChart = null;

const vList = {
    scrollerEl: null, sizerEl: null, contentEl: null, items: [], itemMap: [], 
    heights: { transaction: 64 }, 
    renderBuffer: 10, lastRenderedRange: { start: -1, end: -1 }, isScrolling: null
};

const calculatorState = {
    displayValue: '0',
    waitingForNewValue: true,
    targetInput: null,
};

// =================================================================================
// 2. FIREBASE & DATA HANDLING
// =================================================================================
firebase.initializeApp(firebaseConfig);
const fbAuth = firebase.auth();
fbAuth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
const fbDb = firebase.firestore();

fbDb.enablePersistence({synchronizeTabs: true})
  .catch((err) => {
    if (err.code == 'failed-precondition') {
      console.warn('La persistencia de Firestore falló. Esto puede ocurrir si tienes varias pestañas de la app abiertas.');
      showToast('Modo offline no disponible en esta pestaña (múltiples abiertas).', 'warning', 5000);
    } else if (err.code == 'unimplemented') {
      console.warn('La persistencia de Firestore no está disponible en este navegador.');
      showToast('Tu navegador no soporta el modo offline.', 'warning');
    }
  });
  
const saveData = (buttonElement = null, successCallback = () => {}) => {
    if (!currentUser) { showToast("Error: No hay usuario autenticado.", "danger"); return; }
    if (saveTimeout) clearTimeout(saveTimeout);
    if (buttonElement) setButtonLoading(buttonElement, true, 'Guardando...');
    saveTimeout = setTimeout(() => {
        fbDb.collection('users').doc(currentUser.uid).set({ db })
            .then(() => { if (buttonElement) setButtonLoading(buttonElement, false); successCallback(); })
            .catch((error) => { console.error("Error al guardar datos:", error); showToast("Error al guardar.", "danger"); if (buttonElement) setButtonLoading(buttonElement, false); });
    }, 300);
};

const buildDescriptionIndex = () => {
    descriptionIndex = {};
    (db.movimientos || []).forEach(m => {
        if (!m.descripcion || m.tipo !== 'movimiento') return;
        const desc = m.descripcion.toLowerCase().trim();
        if (!descriptionIndex[desc]) {
            descriptionIndex[desc] = { count: 0, lastConceptId: m.conceptoId, lastAmount: m.cantidad, fullDescription: m.descripcion };
        }
        descriptionIndex[desc].count++;
        descriptionIndex[desc].lastConceptId = m.conceptoId;
        descriptionIndex[desc].lastAmount = m.cantidad;
        descriptionIndex[desc].fullDescription = m.descripcion;
    });
};


const loadData = (uid) => {
    const userDocRef = fbDb.collection('users').doc(uid);
    if (unsubscribeFromDb) unsubscribeFromDb();
    unsubscribeFromDb = userDocRef.onSnapshot((doc) => {
        let dataNeedsMigration = false;
        if (doc.exists && doc.data().db) {
            db = doc.data().db;
            
            if (db.config?.beneficiarios) { delete db.config.beneficiarios; dataNeedsMigration = true; }
            if (db.config?.visibleOwners) { delete db.config.visibleOwners; dataNeedsMigration = true; }
            if ((db.movimientos || []).some((m) => m.hasOwnProperty('beneficiario'))) { (db.movimientos || []).forEach((m) => delete m.beneficiario); dataNeedsMigration = true; }
            if ((db.cuentas || []).some((c) => c.hasOwnProperty('propietario'))) { (db.cuentas || []).forEach((c) => delete c.propietario); dataNeedsMigration = true; }
            if ((db.presupuestos || []).some((p) => p.hasOwnProperty('beneficiario'))) { (db.presupuestos || []).forEach((p) => delete p.beneficiario); dataNeedsMigration = true; }
            if ((db.inversiones_historial || []).some((v) => v.cuentaId === undefined)) {
                const firstInvestmentAccountId = (db.cuentas || []).find((c) => c.esInversion)?.id;
                if (firstInvestmentAccountId) {
                    db.inversiones_historial.forEach((v) => { if (v.cuentaId === undefined) v.cuentaId = firstInvestmentAccountId; });
                    dataNeedsMigration = true;
                }
            }
            if ((db.inversion_cashflows || []).some((cf) => cf.cuentaId === undefined)) {
                const firstInvestmentAccountId = (db.cuentas || []).find((c) => c.esInversion)?.id;
                if (firstInvestmentAccountId) {
                    db.inversion_cashflows.forEach((cf) => { if (cf.cuentaId === undefined) cf.cuentaId = firstInvestmentAccountId; });
                    dataNeedsMigration = true;
                }
            }
            if (!db.presupuestos) { db.presupuestos = []; dataNeedsMigration = true; }
            if (db.config.skipIntro === undefined) { db.config.skipIntro = false; dataNeedsMigration = true; }
            if ((db.movimientos || []).some((m) => !Number.isInteger(m.cantidad))) { (db.movimientos || []).forEach((m) => m.cantidad = Math.round((parseFloat(m.cantidad) || 0) * 100)); dataNeedsMigration = true; showToast("Migrando datos de movimientos...", "info"); }
            if ((db.presupuestos || []).some((p) => !Number.isInteger(p.cantidad))) { (db.presupuestos || []).forEach((p) => p.cantidad = Math.round((parseFloat(p.cantidad) || 0) * 100)); dataNeedsMigration = true; showToast("Migrando datos de presupuestos...", "info"); }
            if ((db.conceptos || []).some((c) => c.icon === undefined)) {
                (db.conceptos || []).forEach((c) => { if (c.icon === undefined) c.icon = 'label'; });
                dataNeedsMigration = true;
                showToast("Actualizando conceptos...", "info");
            }
            if ((db.cuentas || []).some((c) => c.offBalance === undefined)) {
                (db.cuentas || []).forEach((c) => { c.offBalance = false; });
                dataNeedsMigration = true;
                showToast("Añadiendo contabilidad dual...", "info");
            }

        } else { 
            db = getInitialDb(); 
            dataNeedsMigration = true; 
        }
        localStorage.setItem('skipIntro', db.config?.skipIntro || 'false');
        if (dataNeedsMigration) saveData();
        
        buildDescriptionIndex();
        startMainApp();
    }, (error) => { console.error("Error con Firestore:", error); showToast("Error de conexión.", "danger"); });
};

// =================================================================================
// 3. UI UTILITIES & HELPERS
// =================================================================================
const select = (id) => document.getElementById(id);
const selectAll = (s) => document.querySelectorAll(s);
const selectOne = (s) => document.querySelector(s);
const vibrate = (d=10) => { if ('vibrate' in navigator) { try { navigator.vibrate(d); } catch (e) {} } };
const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
const formatCurrency = (numInCents) => {
    const number = (numInCents || 0) / 100;
    return new Intl.NumberFormat('es-ES', {
        style: 'currency',
        currency: 'EUR'
    }).format(number);
};
const showToast = (message, type = 'default', duration = 3000) => {
    const c = select('toast-container'); if (!c) return;
    const t = document.createElement('div');
    t.className = `toast toast--${type}`;
    t.textContent = message;
    t.style.animation = `pop-in 0.3s, fade-in 0.3s ${duration / 1000 - 0.3}s reverse forwards`;
    c.appendChild(t);
    setTimeout(() => t.remove(), duration);
};
const setButtonLoading = (btn, isLoading, text = 'Cargando...') => {
    if (!btn) return;
    if (isLoading) { if (!originalButtonTexts.has(btn)) originalButtonTexts.set(btn, btn.innerHTML); btn.setAttribute('disabled', 'true'); btn.classList.add('btn--loading'); btn.innerHTML = `<span class="spinner"></span> <span>${text}</span>`;
    } else { btn.removeAttribute('disabled'); btn.classList.remove('btn--loading'); if (originalButtonTexts.has(btn)) { btn.innerHTML = originalButtonTexts.get(btn); originalButtonTexts.delete(btn); } }
};
const displayError = (id, msg) => { const err = select(`${id}-error`); if (err) { err.textContent = msg; err.setAttribute('role', 'alert'); } const inp = select(id); if (inp) inp.classList.add('form-input--invalid'); };
const clearError = (id) => { const err = select(`${id}-error`); if (err) { err.textContent = ''; err.removeAttribute('role'); } const inp = select(id); if (inp) inp.classList.remove('form-input--invalid'); };
const clearAllErrors = (formId) => { const f = select(formId); if (!f) return; f.querySelectorAll('.form-error').forEach((e) => e.textContent = ''); f.querySelectorAll('.form-input--invalid').forEach(e => e.classList.remove('form-input--invalid')); };
const animateCountUp = (el, end, duration = 700, formatAsCurrency = true, prefix = '', suffix = '') => {
    if (!el) return;
    const start = parseFloat(el.dataset.currentValue || '0');
    const endValue = end / 100;
    if (start === endValue || !el.offsetParent) { el.textContent = formatAsCurrency ? formatCurrency(end) : `${prefix}${end}${suffix}`; el.dataset.currentValue = String(endValue); return; }
    el.dataset.currentValue = String(endValue); let startTime = null;
    const step = (timestamp) => { if (!startTime) startTime = timestamp; const p = Math.min((timestamp - startTime) / duration, 1); const current = p * (end - start*100) + start*100; el.textContent = formatAsCurrency ? formatCurrency(current) : `${prefix}${current.toFixed(2)}${suffix}`; if (p < 1) requestAnimationFrame(step); else el.textContent = formatAsCurrency ? formatCurrency(end) : `${prefix}${end/100}${suffix}`; };
    requestAnimationFrame(step);
};

// =================================================================================
// 4. APP INITIALIZATION & AUTH
// =================================================================================
const initApp = async () => {
    setupTheme();
    attachEventListeners();
    Chart.register(ChartDataLabels);
    const intro = select('introScreen'), quoteContainer = select('quoteContainer');
    if (localStorage.getItem('skipIntro') === 'true') { if (intro) intro.remove(); } 
    else if (intro && quoteContainer && quotesData.length) {
        const r = quotesData[Math.floor(Math.random() * quotesData.length)];
        const quoteTextEl = select('quoteText');
        const quoteAuthorEl = select('quoteAuthor');
        if(quoteTextEl) quoteTextEl.textContent = `"${r.cita}"`;
        if(quoteAuthorEl) quoteAuthorEl.textContent = `— ${r.autor}`;
        await wait(2500); quoteContainer.classList.add('visible');
        await wait(4000); (intro).style.opacity = '0';
        await wait(750); intro.remove();
    } else if (intro) { intro.remove(); }
    checkAuthState();
};
const checkAuthState = () => fbAuth.onAuthStateChanged((user) => { if (user) { currentUser = user; loadData(user.uid); } else { currentUser = null; if (unsubscribeFromDb) unsubscribeFromDb(); db = getInitialDb(); showLoginScreen(); } });
const startMainApp = () => { select('login-screen')?.classList.remove('login-view--visible'); select('app-root')?.classList.add('app-layout--visible'); renderAll(); navigateTo('movimientos-page', true); };
const showLoginScreen = () => { select('app-root')?.classList.remove('app-layout--visible'); select('login-screen')?.classList.add('login-view--visible'); };
const handleLogin = (btn) => {
    const email = (select('login-email')).value.trim(), password = (select('login-password')).value, errEl = select('login-error'); clearAllErrors('login-form'); if(errEl) errEl.textContent = ''; let v = true;
    if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
    if (!password) { displayError('login-password', 'La contraseña es obligatoria.'); v = false; }
    if (!v) return; setButtonLoading(btn, true, 'Iniciando...');
    fbAuth.signInWithEmailAndPassword(email, password).then(() => showToast(`¡Bienvenido/a de nuevo!`)).catch((err) => { setButtonLoading(btn, false); if (['auth/wrong-password', 'auth/user-not-found', 'auth/invalid-credential'].includes(err.code)) (errEl).textContent = 'Error: Credenciales incorrectas.'; else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no válido.'); else (errEl).textContent = 'Error al iniciar sesión.'; });
};
const handleRegister = (btn) => {
    const email = (select('login-email')).value.trim(), password = (select('login-password')).value, errEl = select('login-error'); clearAllErrors('login-form'); if(errEl) errEl.textContent = ''; let v = true;
    if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
    if (password.length < 6) { displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); v = false; }
    if (!v) return; setButtonLoading(btn, true, 'Registrando...');
    fbAuth.createUserWithEmailAndPassword(email, password).then(() => showToast(`¡Registro completado!`)).catch((err) => { setButtonLoading(btn, false); if (err.code == 'auth/weak-password') displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); else if (err.code == 'auth/email-already-in-use') displayError('login-email', 'El correo ya está registrado.'); else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no válido.'); else (errEl).textContent = 'Error en el registro.'; });
};
const handleExitApp = () => {
    const exitScreen = select('exit-screen');
    if (exitScreen) {
        exitScreen.style.display = 'flex';
        setTimeout(() => exitScreen.style.opacity = '1', 50);
    }
};

// =================================================================================
// 5. NAVIGATION & UI CONTROL
// =================================================================================
const navigateTo = (pageId, isInitial = false) => {
    if (!isInitial) vibrate();
    
    const titleEl = select('top-bar-title'), actionsEl = select('top-bar-actions'), leftEl = select('top-bar-left-button'), fab = select('fab-add-movimiento');
    const ledgerButtonHTML = `<button id="ledger-toggle-btn" class="btn btn--secondary" data-action="toggle-ledger" title="Cambiar Contabilidad">${isOffBalanceMode ? 'Cont. B' : 'Cont. A'}</button>`;

    if(leftEl && !(pageId === 'inversiones-page' && !select('investment-detail-view')?.classList.contains('hidden'))) {
        leftEl.innerHTML = ledgerButtonHTML;
    } else if (leftEl) {
        leftEl.innerHTML = '';
    }
    const standardActions = `<button data-action="help" class="icon-btn" title="Ayuda"><span class="material-icons">help_outline</span></button> <button data-action="theme-toggle" class="icon-btn" title="Cambiar Tema"><span class="material-icons">${document.documentElement.getAttribute('data-theme') === 'dark' ? 'light_mode' : 'dark_mode'}</span></button> <button data-action="exit" class="icon-btn" title="Salir"><span class="material-icons">exit_to_app</span></button>`;
    
    const pageRenderers = {
        'movimientos-page': { title: 'Movimientos', render: renderMovimientos, actions: `<input type="search" id="search-movimientos" class="form-input" placeholder="Buscar..." style="width: 150px; height: 34px; font-size: var(--fs-sm);">` },
        'panel-control-page': { title: 'Panel de Control', render: updateDashboard, actions: standardActions },
        'cuentas-page': { title: 'Cuentas', render: renderCuentas, actions: standardActions },
        'inversiones-page': { title: 'Portafolio', render: renderInversionesPage, actions: standardActions },
        'presupuestos-page': { title: 'Presupuestos', render: renderBudgetTracking, actions: standardActions },
        'informes-page': { title: 'Informes', render: renderInformesPage, actions: standardActions },
        'configuracion-page': { title: 'Configuración', render: loadConfig, actions: standardActions }
    };
    
    if (pageRenderers[pageId]) {
         if (pageId === 'inversiones-page' && !select('investment-detail-view')?.classList.contains('hidden')) {
            // Title is handled by renderInvestmentAccountDetail
        } else if (titleEl) {
            titleEl.textContent = pageRenderers[pageId].title;
        }
        if (actionsEl) actionsEl.innerHTML = pageRenderers[pageId].actions;
        if(pageId === 'movimientos-page') {
            select('search-movimientos')?.addEventListener('input', e => { clearTimeout(window.debounceTimer); window.debounceTimer = setTimeout(() => renderMovimientos(), 250); });
        }
        if (!isInitial) pageRenderers[pageId].render();
    }
    
    const mainScroller = selectOne('.app-layout__main'); if (mainScroller) mainScroller.scrollTop = 0;
    selectAll('.view').forEach(p => p.classList.remove('view--active'));
    select(pageId)?.classList.add('view--active');
    selectAll('.bottom-nav__item').forEach(b => b.classList.toggle('bottom-nav__item--active', (b).dataset.page === pageId));
    
    // Universal FAB logic: always visible except on the config page.
    fab?.classList.toggle('fab--visible', !['configuracion-page'].includes(pageId));
};

const setupTheme = () => { 
    const theme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', theme); 
    selectAll('button[data-action="theme-toggle"] .material-icons').forEach((icon) => icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode');
    const gridColor = theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    const textColor = theme === 'dark' ? '#F9FAFB' : '#1F2937';
    Chart.defaults.color = textColor; Chart.defaults.borderColor = gridColor;
};
const toggleTheme = () => { vibrate(); const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); renderAll(); };

// =================================================================================
// 6. CORE LOGIC & CALCULATIONS
// =================================================================================
const getVisibleAccounts = () => (db.cuentas || []).filter(c => !!c.offBalance === isOffBalanceMode);

const getLiquidAccounts = () => getVisibleAccounts().filter((c) => !['PROPIEDAD', 'PRÉSTAMO'].includes((c.tipo || '').trim().toUpperCase()));

const getSaldos = () => {
    const visibleAccounts = getVisibleAccounts();
    const visibleAccountIds = new Set(visibleAccounts.map(c => c.id));
    const saldos = visibleAccounts.reduce((acc, c) => ({ ...acc, [c.id]: 0 }), {});

    (db.movimientos || []).forEach((m) => {
        if (m.tipo === 'traspaso') {
            const origenVisible = visibleAccountIds.has(m.cuentaOrigenId);
            const destinoVisible = visibleAccountIds.has(m.cuentaDestinoId);
            if(origenVisible && !destinoVisible) { // Sale de A, va a B
                saldos[m.cuentaOrigenId] -= m.cantidad;
            } else if (!origenVisible && destinoVisible) { // Entra a A, viene de B
                saldos[m.cuentaDestinoId] += m.cantidad;
            } else if (origenVisible && destinoVisible) { // Se mueve dentro de A
                saldos[m.cuentaOrigenId] -= m.cantidad;
                saldos[m.cuentaDestinoId] += m.cantidad;
            }
        } else {
            if (visibleAccountIds.has(m.cuentaId)) {
                saldos[m.cuentaId] += m.cantidad;
            }
        }
    });
    return saldos;
};

const calculateRunningBalancesForAll = (movements) => {
    const visibleAccounts = getVisibleAccounts();
    const visibleAccountIds = new Set(visibleAccounts.map(c => c.id));

    const movs = JSON.parse(JSON.stringify(movements || [])).filter(m => {
        if (m.tipo === 'traspaso') {
            return visibleAccountIds.has(m.cuentaOrigenId) || visibleAccountIds.has(m.cuentaDestinoId);
        }
        return visibleAccountIds.has(m.cuentaId);
    });
    
    movs.sort((a, b) => new Date(a.fecha).getTime() - new Date(b.fecha).getTime());

    const runningBalances = visibleAccounts.reduce((acc, c) => ({ ...acc, [c.id]: 0 }), {});

    movs.forEach((mov) => {
        if (mov.tipo === 'traspaso') {
            if (runningBalances.hasOwnProperty(mov.cuentaOrigenId)) runningBalances[mov.cuentaOrigenId] -= mov.cantidad;
            if (runningBalances.hasOwnProperty(mov.cuentaDestinoId)) runningBalances[mov.cuentaDestinoId] += mov.cantidad;
            mov.saldoPostMovimiento = runningBalances[mov.cuentaOrigenId];
            mov.saldoPostMovimientoDestino = runningBalances[mov.cuentaDestinoId];
        } else if (mov.tipo === 'movimiento') {
            if (runningBalances.hasOwnProperty(mov.cuentaId)) {
                runningBalances[mov.cuentaId] += mov.cantidad;
                mov.saldoPostMovimiento = runningBalances[mov.cuentaId];
            }
        }
    });
    return movs;
};

const getFilteredMovements = (forComparison = false) => {
    const p = (select('filter-periodo')).value, cId = (select('filter-cuenta')).value, coId = (select('filter-concepto')).value;
    let sDate, eDate, prevSDate, prevEDate, now = new Date();

    switch (p) {
        case 'mes-actual':
            sDate = new Date(now.getFullYear(), now.getMonth(), 1);
            eDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            prevSDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            prevEDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
            break;
        case 'año-actual':
            sDate = new Date(now.getFullYear(), 0, 1);
            eDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
            prevSDate = new Date(now.getFullYear() - 1, 0, 1);
            prevEDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999);
            break;
        case 'custom':
            const sVal = (select('filter-fecha-inicio')).value;
            const eVal = (select('filter-fecha-fin')).value;
            sDate = sVal ? new Date(sVal) : null;
            if (sDate) sDate.setHours(0, 0, 0, 0);
            eDate = eVal ? new Date(eVal) : null;
            if (eDate) eDate.setHours(23, 59, 59, 999);
            prevSDate = null; prevEDate = null;
            break;
        default: 
            sDate = null; eDate = null; prevSDate = null; prevEDate = null;
            break;
    }
    
    const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));

    const filterLogic = (m) => {
        const cuentaMatch = !cId || m.cuentaId === cId || m.cuentaOrigenId === cId || m.cuentaDestinoId === cId;
        const conceptoMatch = !coId || m.conceptoId === coId;
        
        let ledgerMatch = false;
        if (m.tipo === 'traspaso') {
            const origenVisible = visibleAccountIds.has(m.cuentaOrigenId);
            const destinoVisible = visibleAccountIds.has(m.cuentaDestinoId);
            ledgerMatch = origenVisible || destinoVisible; 
        } else {
            ledgerMatch = visibleAccountIds.has(m.cuentaId);
        }
        
        return cuentaMatch && conceptoMatch && ledgerMatch;
    };

    const allMovements = db.movimientos || [];
    const currentMovs = allMovements.filter(m => {
        const d = new Date(m.fecha);
        const dateMatch = (!sDate || !eDate) ? true : (d >= sDate && d <= eDate);
        return dateMatch && filterLogic(m);
    });

    if (!forComparison) {
        return currentMovs;
    }

    const prevMovs = (!prevSDate || !prevEDate) ? [] : allMovements.filter(m => {
        const d = new Date(m.fecha);
        const dateMatch = (d >= prevSDate && d <= prevEDate);
        return dateMatch && filterLogic(m);
    });
    
    const comparisonLabel = p === 'mes-actual' ? 'vs mes ant.' : (p === 'año-actual' ? 'vs año ant.' : '');

    return { current: currentMovs, previous: prevMovs, label: comparisonLabel };
};


const calculateInvestmentAccountPerformance = (cuentaId) => {
    const cuenta = getVisibleAccounts().find((c) => c.id === cuentaId);
    if (!cuenta) return { valorActual: 0, capitalInvertido: 0, pnlAbsoluto: 0, pnlPorcentual: 0 };

    const saldos = getSaldos();
    const capitalBase = saldos[cuentaId] || 0;
    const cashflows = (db.inversion_cashflows || []).filter((cf) => cf.cuentaId === cuentaId);
    const netCashflow = cashflows.reduce((sum, cf) => sum + cf.cantidad, 0);
    const capitalInvertido = capitalBase + netCashflow;
    
    const valoraciones = (db.inversiones_historial || []).filter((v) => v.cuentaId === cuentaId).sort((a, b) => new Date(a.fecha).getTime() - new Date(b.fecha).getTime());
    const valorActual = valoraciones.length > 0 ? valoraciones[valoraciones.length - 1].valor : capitalInvertido;
    const pnlAbsoluto = valorActual - capitalInvertido;
    const pnlPorcentual = capitalInvertido !== 0 ? (pnlAbsoluto / capitalInvertido) * 100 : 0;

    return { valorActual, capitalInvertido, pnlAbsoluto, pnlPorcentual };
};

// =================================================================================
// 7. RENDERING ENGINE & BUDGET FUNCTIONS
// =================================================================================
const renderAll = () => { if (!db || !currentUser) return; populateAllDropdowns(); renderMovimientos(); renderCuentas(); loadConfig(); updateDashboard(); renderInversionesPage(); renderBudgetTracking(); renderInformesPage(); };

const populateAllDropdowns = () => {
    const visibleAccounts = getVisibleAccounts();
    const populate = (id, data, nameKey, valKey='id', all=false, none=false) => {
        const el = select(id); if (!el) return; const currentVal = el.value;
        let opts = all ? '<option value="">Todos</option>' : ''; if (none) opts += '<option value="">Ninguno</option>';
        [...data].sort((a,b) => (a[nameKey]||"").localeCompare(b[nameKey]||"")).forEach(i => opts += `<option value="${i[valKey]}">${i[nameKey]}</option>`);
        el.innerHTML = opts; el.value = Array.from(el.options).some(o=>o.value===currentVal) ? currentVal : (el.options[0]?.value || "");
    };
    populate('movimiento-cuenta', visibleAccounts, 'nombre', 'id', false, true); 
    populate('movimiento-cuenta-origen', db.cuentas, 'nombre', 'id', false, true); 
    populate('movimiento-cuenta-destino', db.cuentas, 'nombre', 'id', false, true); 
    populate('filter-cuenta', visibleAccounts, 'nombre', 'id', true); 
    populate('movimiento-concepto', db.conceptos, 'nombre', 'id', false, true); 
    populate('filter-concepto', db.conceptos, 'nombre', 'id', true);
    const budgetYearSelect = select('budget-year-selector'); if(budgetYearSelect) { const currentVal = budgetYearSelect.value; const currentYear = new Date().getFullYear(); let years = new Set([currentYear]); (db.presupuestos || []).forEach((p) => years.add(p.ano)); budgetYearSelect.innerHTML = [...years].sort((a,b) => b-a).map(y => `<option value="${y}">${y}</option>`).join(''); if(currentVal && [...years].some(y => y == parseInt(currentVal))) budgetYearSelect.value = currentVal; else budgetYearSelect.value = String(currentYear); }
    populate('informe-cuenta', visibleAccounts, 'nombre', 'id', true);
    populate('informe-concepto', db.conceptos, 'nombre', 'id', true);
};

const handleCreateBudgets = (year, btn) => { vibrate(); if (btn) setButtonLoading(btn, true, 'Creando...'); const existingBudgets = new Set((db.presupuestos || []).filter((p) => p.ano === year).map((p) => p.conceptoId)); const newBudgets = []; db.conceptos.forEach((concepto) => { if (!existingBudgets.has(concepto.id)) { newBudgets.push({ id: generateId(), ano: year, conceptoId: concepto.id, cantidad: 0 }); } }); if (newBudgets.length > 0) { db.presupuestos.push(...newBudgets); saveData(null, () => { if (btn) setButtonLoading(btn, false); showToast(`Presupuestos para ${year} creados.`); renderBudgetTracking(); }); } else { if (btn) setButtonLoading(btn, false); showToast(`Todos los presupuestos para ${year} ya existían.`, 'info'); renderBudgetTracking(); } };

const handleUpdateBudgets = () => { vibrate(); const year = parseInt((select('budget-year-selector')).value); if(!year) { showToast('Selecciona un año.', 'warning'); return; } const budgetsToUpdate = (db.presupuestos || []).filter((p) => p.ano === year); let formHtml = `<form id="update-budgets-form" novalidate><p class="form-label" style="margin-bottom: var(--sp-3)">Introduce el límite anual. Usa <b>valores positivos para metas de ingreso</b> y <b>valores negativos para límites de gasto</b>.</p>`; const conceptsWithBudget = new Set(budgetsToUpdate.map((b) => b.conceptoId)); db.conceptos.filter((c) => conceptsWithBudget.has(c.id)).sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach((c) => { const budget = budgetsToUpdate.find((b) => b.conceptoId === c.id); const currentAmount = budget ? (budget.cantidad / 100).toFixed(2) : '0.00'; formHtml += `<div class="form-group"><label for="budget-input-${c.id}" class="form-label" style="font-weight: 600;">${c.nombre}</label><input type="text" id="budget-input-${c.id}" data-concept-id="${c.id}" class="form-input" inputmode="decimal" value="${currentAmount.replace('.', ',')}"></div>`; }); const missingConcepts = db.conceptos.filter((c) => !conceptsWithBudget.has(c.id)); if(missingConcepts.length > 0) { formHtml += `<hr style="margin: var(--sp-4) 0; border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-bottom: var(--sp-2);">Añadir nuevos conceptos al presupuesto</h4>`; missingConcepts.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach((c) => { formHtml += `<div class="form-group"><label for="budget-input-${c.id}" class="form-label" style="font-weight: 600;">${c.nombre}</label><input type="text" id="budget-input-${c.id}" data-concept-id="${c.id}" class="form-input" inputmode="decimal" placeholder="0,00"></div>`; }); } formHtml += `<div class="modal__actions"><button type="submit" class="btn btn--primary btn--full">Guardar Cambios</button></div></form>`; showGenericModal(`Gestionar Presupuestos de ${year}`, formHtml); setTimeout(() => { const modalForm = select('update-budgets-form'); if (modalForm) { modalForm.addEventListener('submit', (e) => { e.preventDefault(); const btn = modalForm.querySelector('button[type="submit"]'); setButtonLoading(btn, true, 'Guardando...'); const inputs = modalForm.querySelectorAll('input[data-concept-id]'); inputs.forEach((input) => { const conceptoId = (input).dataset.conceptId; const newAmountStr = (input).value.trim().replace(/\./g, '').replace(',', '.'); if (newAmountStr === '') return; const newAmountInCents = Math.round(parseFloat(newAmountStr) * 100); if (!isNaN(newAmountInCents)) { let budget = (db.presupuestos || []).find((b) => b.ano === year && b.conceptoId === conceptoId); if (budget) { budget.cantidad = newAmountInCents; } else { db.presupuestos.push({ id: generateId(), ano: year, conceptoId: conceptoId, cantidad: newAmountInCents }); } } }); saveData(btn, () => { hideModal('generic-modal'); showToast('Presupuestos actualizados.'); renderBudgetTracking(); }); }); } }, 0); };

const renderBudgetTracking = () => {
    const listContainer = select('budget-tracking-list'), placeholder = select('budget-init-placeholder'), yearSelector = select('budget-year-selector');
    if (!listContainer || !placeholder || !yearSelector) return;
    const year = parseInt((yearSelector).value, 10);
    if (!year) { listContainer.classList.add('hidden'); placeholder.classList.add('hidden'); return; }
    const yearBudgets = (db.presupuestos || []).filter((b) => b.ano === year);
    if (yearBudgets.length === 0) { listContainer.innerHTML = ''; listContainer.classList.add('hidden'); placeholder.classList.remove('hidden'); (select('budget-placeholder-title')).textContent = `Crear Presupuestos ${year}`; (select('budget-placeholder-text')).textContent = `Aún no se han creado los presupuestos para el año ${year}.`; return; }
    listContainer.classList.remove('hidden'); placeholder.classList.add('hidden');
    
    const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
    const visibleMovements = (db.movimientos || []).filter(m => {
        const movDate = new Date(m.fecha);
        const yearMatch = movDate.getFullYear() === year;
        const ledgerMatch = visibleAccountIds.has(m.cuentaId);
        return yearMatch && ledgerMatch && m.tipo === 'movimiento';
    });

    let html = '';
    yearBudgets.sort((a,b) => (db.conceptos.find((c) => c.id === a.conceptoId)?.nombre || '').localeCompare(db.conceptos.find((c) => c.id === b.conceptoId)?.nombre || '')).forEach((budget) => {
        const concepto = db.conceptos.find((c) => c.id === budget.conceptoId); if (!concepto || budget.cantidad === 0) return;
        const isIncomeBudget = budget.cantidad > 0;
        const actualAmount = visibleMovements.filter((m) => m.conceptoId === budget.conceptoId).reduce((sum, m) => sum + m.cantidad, 0);
        const budgetLimit = Math.abs(budget.cantidad), actualValue = isIncomeBudget ? actualAmount : Math.abs(actualAmount);
        const difference = isIncomeBudget ? (actualAmount - budgetLimit) : (budgetLimit - actualValue); const differenceClass = difference >= 0 ? 'text-positive' : 'text-negative';
        const progressValue = actualValue, progressMax = budgetLimit; let progressClass = ''; const percentage = progressMax > 0 ? (progressValue / progressMax) * 100 : 0;
        if (percentage > 100) progressClass = 'budget-item__progress--danger'; else if (percentage >= 85) progressClass = 'budget-item__progress--warning';
        
        html += `<div class="budget-track-item">
            <div class="budget-track-item__main">
                <span class="budget-track-item__concept-name">${concepto.nombre}</span>
                <progress class="budget-item__progress ${progressClass}" value="${progressValue}" max="${progressMax > 0 ? progressMax : 1}"></progress>
            </div>
            <div class="budget-track-item__figures">
                <span class="budget-track-item__amount"><strong>${formatCurrency(actualValue)}</strong> / ${formatCurrency(budgetLimit)}</span>
                <span class="budget-track-item__difference ${differenceClass}">${formatCurrency(difference)}</span>
            </div>
        </div>`;
    });
    listContainer.innerHTML = `<div class="card"><div class="card__content" style="padding: 0 var(--sp-4) var(--sp-2) var(--sp-4);">${html || `<p class='form-label' style='text-align: center; padding: var(--sp-4) 0;'>No hay presupuestos para mostrar en esta vista.</p>`}</div></div>`;
};

// =================================================================================
// 7.5. INVESTMENT & REPORT PAGE RENDERING
// =================================================================================
const renderInversionesPage = () => {
    (select('investment-list-view'))?.classList.remove('hidden');
    (select('investment-detail-view'))?.classList.add('hidden');
    const topBarTitle = select('top-bar-title');
    if (topBarTitle) topBarTitle.textContent = 'Portafolio';
    const topBarLeftButton = select('top-bar-left-button');
    if (topBarLeftButton) topBarLeftButton.innerHTML = `<button id="ledger-toggle-btn" class="btn btn--secondary" data-action="toggle-ledger" title="Cambiar Contabilidad">${isOffBalanceMode ? 'Cont. B' : 'Cont. A'}</button>`;

    const investmentAccounts = getVisibleAccounts().filter((c) => c.esInversion);
    const kpisContainer = select('investment-global-kpis');
    const assetsListContainer = select('investment-assets-list');
    const emptyState = select('empty-investments');

    if (!kpisContainer || !assetsListContainer || !emptyState) return;
    
    if (investmentAccounts.length === 0) {
        kpisContainer.innerHTML = '';
        assetsListContainer.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
    }

    emptyState.classList.add('hidden');
    let totalValor = 0, totalCapital = 0;
    assetsListContainer.innerHTML = investmentAccounts.map((cuenta) => {
        const performance = calculateInvestmentAccountPerformance(cuenta.id);
        totalValor += performance.valorActual;
        totalCapital += performance.capitalInvertido;
        const pnlClass = performance.pnlAbsoluto >= 0 ? 'text-positive' : 'text-negative';
        return `<div class="investment-asset-card" data-action="view-investment-detail" data-id="${cuenta.id}">
            <div class="investment-asset-card__header">
                <div>
                    <h3 class="investment-asset-card__name">${cuenta.nombre}</h3>
                    <small style="color: var(--c-on-surface-secondary);">${cuenta.tipo}</small>
                </div>
                <div>
                    <div class="investment-asset-card__value">${formatCurrency(performance.valorActual)}</div>
                    <div class="investment-asset-card__pnl ${pnlClass}">${performance.pnlAbsoluto >= 0 ? '+' : ''}${formatCurrency(performance.pnlAbsoluto)} (${performance.pnlPorcentual.toFixed(2)}%)</div>
                </div>
            </div>
        </div>`;
    }).join('');

    const totalPnlAbsoluto = totalValor - totalCapital;
    const totalPnlPorcentual = totalCapital !== 0 ? (totalPnlAbsoluto / totalCapital) * 100 : 0;
    const totalPnlClass = totalPnlAbsoluto >= 0 ? 'text-positive' : 'text-negative';
    kpisContainer.innerHTML = `<div class="kpi-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: var(--sp-3);"><div class="kpi-item"><h4 class="kpi-item__label">Valor Total</h4><strong class="kpi-item__value">${formatCurrency(totalValor)}</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Capital Total</h4><strong class="kpi-item__value">${formatCurrency(totalCapital)}</strong></div></div><div class="kpi-grid" style="grid-template-columns: 1fr 1fr;"><div class="kpi-item"><h4 class="kpi-item__label">P&L (€)</h4><strong class="kpi-item__value ${totalPnlClass}">${totalPnlAbsoluto >= 0 ? '+' : ''}${formatCurrency(totalPnlAbsoluto)}</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Rendimiento (%)</h4><strong class="kpi-item__value ${totalPnlClass}">${totalPnlPorcentual.toFixed(2)}%</strong></div></div>`;
};

const renderInvestmentAccountDetail = (cuentaId) => {
    const cuenta = getVisibleAccounts().find((c) => c.id === cuentaId);
    if (!cuenta) { renderInversionesPage(); return; }
    
    (select('investment-list-view'))?.classList.add('hidden');
    const detailContainer = select('investment-detail-view');
    if(!detailContainer) return;
    detailContainer.classList.remove('hidden');

    const topBarTitle = select('top-bar-title');
    if (topBarTitle) topBarTitle.textContent = cuenta.nombre;
    const topBarLeftButton = select('top-bar-left-button');
    if (topBarLeftButton) {
         topBarLeftButton.innerHTML = `<button class="icon-btn" data-action="back-to-investment-list"><span class="material-icons">arrow_back_ios</span></button>`;
    }
    
    if (detailInvestmentChart) detailInvestmentChart.destroy();

    const performance = calculateInvestmentAccountPerformance(cuentaId);
    const pnlClass = performance.pnlAbsoluto >= 0 ? 'text-positive' : 'text-negative';
    const saldos = getSaldos();
    const capitalBase = saldos[cuentaId] || 0;
    const cashflows = (db.inversion_cashflows || []).filter((cf) => cf.cuentaId === cuentaId).sort((a, b) => new Date(a.fecha).getTime() - new Date(b.fecha).getTime());
    const valoraciones = (db.inversiones_historial || []).filter((v) => v.cuentaId === cuentaId).sort((a, b) => new Date(a.fecha).getTime() - new Date(b.fecha).getTime());

    detailContainer.innerHTML = `<div class="kpi-grid" style="grid-template-columns: 1fr 1fr;"><div class="kpi-item"><h4 class="kpi-item__label">Valor Actual</h4><strong class="kpi-item__value">${formatCurrency(performance.valorActual)}</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Capital Invertido</h4><strong class="kpi-item__value">${formatCurrency(performance.capitalInvertido)}</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Rendimiento (€)</h4><strong class="kpi-item__value ${pnlClass}">${performance.pnlAbsoluto >= 0 ? '+' : ''}${formatCurrency(performance.pnlAbsoluto)}</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Rendimiento (%)</h4><strong class="kpi-item__value ${pnlClass}">${performance.pnlPorcentual.toFixed(2)}%</strong></div></div><div class="card"><h3 class="card__title"><span class="material-icons">show_chart</span>Evolución</h3><div class="card__content"><div class="chart-container" style="height: 200px; margin-bottom: 0;"><canvas id="detail-investment-chart"></canvas></div></div></div><div class="card"><h3 class="card__title"><span class="material-icons">history</span>Historial</h3><div class="card__content" id="investment-detail-timeline" style="padding-top: 0;"></div></div>`;

    setTimeout(() => {
        const ctx = (select('detail-investment-chart'))?.getContext('2d');
        if (ctx) {
            let runningCapital = capitalBase;
            const capitalData = [{ x: new Date(cuenta.fechaCreacion || Date.now()).getTime(), y: capitalBase / 100 }];
            cashflows.forEach((cf) => { runningCapital += cf.cantidad; capitalData.push({ x: new Date(cf.fecha).getTime(), y: runningCapital / 100 }); });
            const valoracionData = valoraciones.map((v) => ({ x: new Date(v.fecha).getTime(), y: v.valor / 100 }));
            detailInvestmentChart = new Chart(ctx, { type: 'line', data: { datasets: [ { label: 'Valor Activo', data: valoracionData, borderColor: 'var(--c-primary)', backgroundColor: 'rgba(10, 132, 255, 0.2)', tension: 0.1, fill: true }, { label: 'Capital Invertido', data: capitalData, borderColor: 'var(--c-info)', stepped: true, fill: false } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, datalabels: { display: false } }, scales: { x: { type: 'time', time: { unit: 'month' } }, y: { ticks: { callback: (value) => `€${value.toLocaleString('es-ES')}` } } } } });
        }
    }, 50);
    
    const timelineContainer = select('investment-detail-timeline');
    const timelineItems = [ ...valoraciones.map((v) => ({...v, type: 'valoracion'})), ...cashflows.map((c) => ({...c, type: c.cantidad > 0 ? 'aportacion' : 'reembolso'})) ].sort((a,b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime());
    if (timelineContainer) {
        if (timelineItems.length === 0) {
            timelineContainer.innerHTML = `<p style="text-align:center; padding: var(--sp-3) 0; color: var(--c-on-surface-secondary);">No hay historial para este activo.</p>`;
        } else {
            timelineContainer.innerHTML = timelineItems.map((item) => {
                let icon, text, amount, amountClass = '', action;
                const date = new Date(item.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                switch (item.type) {
                    case 'valoracion': icon = 'check_circle_outline'; text = 'Valoración'; amount = formatCurrency((item).valor); amountClass = 'text-info'; action='edit-valoracion'; break;
                    case 'aportacion': icon = 'add_circle_outline'; text = `Aportación ${(item).notas ? `(${(item).notas})` : ''}`; amount = `+${formatCurrency((item).cantidad)}`; amountClass = 'text-positive'; action='edit-aportacion'; break;
                    case 'reembolso': icon = 'remove_circle_outline'; text = `Reembolso ${(item).notas ? `(${(item).notas})` : ''}`; amount = `${formatCurrency((item).cantidad)}`; amountClass = 'text-negative'; action='edit-aportacion'; break;
                }
                return `<div class="investment-timeline-item" data-action="${action}" data-id="${item.id}" data-cuenta-id="${cuentaId}" style="cursor: pointer;"><div class="investment-timeline-item__icon ${amountClass}"><span class="material-icons">${icon}</span></div><div class="investment-timeline-item__details"><div class="investment-timeline-item__description">${text}</div><div class="investment-timeline-item__date">${date}</div></div><div class="investment-timeline-item__amount ${amountClass}">${amount}</div></div>`;
            }).join('');
        }
    }
};

const renderInformesPage = () => {
    const resultsContainer = select('informe-results-container');
    const emptyState = select('empty-informes');
    const kpiContainer = select('informe-kpi-container');
    const chartCtx = select('informes-chart')?.getContext('2d');

    if (!resultsContainer || !emptyState || !chartCtx || !kpiContainer) return;

    if (informesChart) {
        informesChart.destroy();
    }
    
    const fechaInicioVal = select('informe-fecha-inicio').value;
    const fechaFinVal = select('informe-fecha-fin').value;
    const cuentaId = select('informe-cuenta').value;
    const conceptoId = select('informe-concepto').value;

    if (!fechaInicioVal || !fechaFinVal) {
        resultsContainer.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }

    const fechaInicio = new Date(fechaInicioVal);
    fechaInicio.setHours(0, 0, 0, 0);
    const fechaFin = new Date(fechaFinVal);
    fechaFin.setHours(23, 59, 59, 999);
    
    const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));

    let movimientos = (db.movimientos || []).filter(m => {
        const movDate = new Date(m.fecha);
        const enRango = movDate >= fechaInicio && movDate <= fechaFin;
        const cuentaMatch = !cuentaId || m.cuentaId === cuentaId;
        const conceptoMatch = !conceptoId || m.conceptoId === conceptoId;
        const ledgerMatch = visibleAccountIds.has(m.cuentaId);
        return enRango && cuentaMatch && conceptoMatch && m.tipo === 'movimiento' && ledgerMatch;
    });
    
    if (movimientos.length === 0) {
        showToast('No se encontraron movimientos para los filtros seleccionados.', 'info');
        resultsContainer.classList.add('hidden');
        emptyState.classList.remove('hidden');
        emptyState.querySelector('p').textContent = "No hay datos para este informe. Prueba a cambiar los filtros.";
        return;
    }

    resultsContainer.classList.remove('hidden');
    emptyState.classList.add('hidden');
    
    const datosAgrupados = movimientos.reduce((acc, mov) => {
        const fecha = new Date(mov.fecha);
        const clave = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
        if (!acc[clave]) {
            acc[clave] = { ingresos: 0, gastos: 0 };
        }
        if (mov.cantidad > 0) {
            acc[clave].ingresos += mov.cantidad;
        } else {
            acc[clave].gastos += mov.cantidad;
        }
        return acc;
    }, {});

    const etiquetas = Object.keys(datosAgrupados).sort();
    const datosIngresos = etiquetas.map(clave => datosAgrupados[clave].ingresos / 100);
    const datosGastos = etiquetas.map(clave => Math.abs(datosAgrupados[clave].gastos / 100));

    const etiquetasFormateadas = etiquetas.map(clave => {
        const [year, month] = clave.split('-');
        return new Date(parseInt(year), parseInt(month) - 1).toLocaleDateString('es-ES', { month: 'short', year: '2-digit' });
    });
    
    const totalIngresos = datosIngresos.reduce((sum, val) => sum + (val * 100), 0);
    const totalGastos = datosGastos.reduce((sum, val) => sum + (val * 100), 0);
    const neto = totalIngresos - totalGastos;
    
    kpiContainer.innerHTML = `
        <div class="kpi-item"><h4 class="kpi-item__label">Total Ingresos</h4><strong class="kpi-item__value text-positive">${formatCurrency(totalIngresos)}</strong></div>
        <div class="kpi-item"><h4 class="kpi-item__label">Total Gastos</h4><strong class="kpi-item__value text-negative">${formatCurrency(-totalGastos)}</strong></div>
        <div class="kpi-item"><h4 class="kpi-item__label">Resultado Neto</h4><strong class="kpi-item__value ${neto >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(neto)}</strong></div>
    `;

    informesChart = new Chart(chartCtx, {
        type: 'line',
        data: {
            labels: etiquetasFormateadas,
            datasets: [
                {
                    label: 'Ingresos',
                    data: datosIngresos,
                    borderColor: getComputedStyle(document.body).getPropertyValue('--c-success'),
                    backgroundColor: 'rgba(52, 199, 89, 0.2)',
                    fill: true,
                    tension: 0.3,
                    pointBackgroundColor: getComputedStyle(document.body).getPropertyValue('--c-success')
                },
                {
                    label: 'Gastos',
                    data: datosGastos,
                    borderColor: getComputedStyle(document.body).getPropertyValue('--c-danger'),
                    backgroundColor: 'rgba(255, 59, 48, 0.2)',
                    fill: true,
                    tension: 0.3,
                    pointBackgroundColor: getComputedStyle(document.body).getPropertyValue('--c-danger')
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: (value) => formatCurrency(value * 100).replace(/\s/g, '') }
                }
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${formatCurrency(c.parsed.y * 100)}` } },
                datalabels: { display: false }
            }
        }
    });
};


const renderVirtualListItem = (item) => {
    if (item.type === 'transaction') {
        const m = item.movement;
        
        const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
        const origenVisible = visibleAccountIds.has(m.cuentaOrigenId);
        const destinoVisible = visibleAccountIds.has(m.cuentaDestinoId);
        
        let amount, meta = '', saldoHtml = '', conceptIcon = 'label';
        const dateString = new Date(m.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
        
        if (m.tipo === 'traspaso') { 
            const origen = db.cuentas.find((c)=>c.id===m.cuentaOrigenId)?.nombre||'?'; 
            const destino = db.cuentas.find((c)=>c.id===m.cuentaDestinoId)?.nombre||'?';
            conceptIcon = 'swap_horiz';
            amount = `<span class="text-info">${formatCurrency(m.cantidad)}</span>`;
            
            if (origenVisible && !destinoVisible) { // Traspaso de A a B (Gasto para A)
                 meta = `${dateString} &bull; ${origen} → ${destino} (B)`;
                 amount = `<span class="text-negative">${formatCurrency(-m.cantidad)}</span>`;
            } else if (!origenVisible && destinoVisible) { // Traspaso de B a A (Ingreso para A)
                meta = `${dateString} &bull; ${origen} (B) → ${destino}`;
                amount = `<span class="text-positive">+${formatCurrency(m.cantidad)}</span>`;
            } else { // Traspaso dentro de la misma contabilidad
                meta = `${dateString} &bull; ${origen} → ${destino}`;
            }
        } else {
            const concept = m.conceptoId ? db.conceptos.find((c) => c.id === m.conceptoId) : null;
            if(concept && concept.icon) conceptIcon = concept.icon;
            amount = (m.cantidad < 0 ? `<span class="text-negative">${formatCurrency(m.cantidad)}</span>` : `<span class="text-positive">+${formatCurrency(m.cantidad)}</span>`);
            const cuenta = db.cuentas.find((c) => c.id === m.cuentaId); 
            if (cuenta) { 
                meta = `${dateString} &bull; ${cuenta.nombre}`; 
                if (m.hasOwnProperty('saldoPostMovimiento')) { 
                    saldoHtml = `<div style="font-size: 0.7rem; color: var(--c-on-surface-secondary); margin-top: 2px;">${formatCurrency(m.saldoPostMovimiento)}</div>`; 
                } 
            } else { 
                meta = dateString; 
            } 
        }
        
        return `<div class="transaction-card" data-id="${m.id}"><div class="transaction-card__actions transaction-card__actions--left"><button class="icon-btn" data-action="copy-movement-swipe" title="Copiar"><span class="material-icons">content_copy</span></button></div><div class="transaction-card__swipe-content" data-action="edit-movement" data-id="${m.id}"><div class="transaction-card__icon"><span class="material-icons">${conceptIcon}</span></div><div class="transaction-card__details"><div class="transaction-card__description">${m.descripcion}</div><div class="transaction-card__meta">${meta}</div></div><div class="transaction-card__amount">${amount}${saldoHtml}</div></div><div class="transaction-card__actions transaction-card__actions--right"><button class="icon-btn" data-action="delete-movement-swipe" title="Eliminar"><span class="material-icons">delete</span></button></div></div>`;
    }
    return '';
};

const renderVisibleItems = () => {
    if (!vList.scrollerEl || !vList.contentEl) return; 
    const scrollTop = vList.scrollerEl.scrollTop, containerHeight = vList.scrollerEl.clientHeight;
    let startIndex = -1, endIndex = -1;
    
    for (let i = 0; i < vList.itemMap.length; i++) { const item = vList.itemMap[i]; if (startIndex === -1 && item.offset + item.height > scrollTop) startIndex = Math.max(0, i - vList.renderBuffer); if (endIndex === -1 && item.offset + item.height > scrollTop + containerHeight) { endIndex = Math.min(vList.itemMap.length - 1, i + vList.renderBuffer); break; } }
    if (startIndex === -1 && vList.items.length > 0) startIndex = 0;
    if (endIndex === -1) endIndex = vList.itemMap.length - 1;
    
    if (startIndex === vList.lastRenderedRange.start && endIndex === vList.lastRenderedRange.end) return;
    
    let visibleHtml = ''; 
    for (let i = startIndex; i <= endIndex; i++) { 
        if (vList.items[i]) visibleHtml += renderVirtualListItem(vList.items[i]); 
    }
    vList.contentEl.innerHTML = visibleHtml; 
    const offsetY = vList.itemMap[startIndex]?.offset || 0; 
    vList.contentEl.style.transform = `translateY(${offsetY}px)`; 
    vList.lastRenderedRange = { start: startIndex, end: endIndex };
};

const renderMovimientos = () => {
    const emptyEl = select('empty-movimientos'), listContainer = select('movimientos-list-container');
    if (!vList.scrollerEl) { vList.scrollerEl = selectOne('.app-layout__main'); vList.sizerEl = select('virtual-list-sizer'); vList.contentEl = select('virtual-list-content'); if(vList.scrollerEl) { vList.scrollerEl.addEventListener('scroll', () => { if (select('movimientos-page')?.classList.contains('view--active')) { if (window.debounceTimer) cancelAnimationFrame(window.debounceTimer); window.debounceTimer = requestAnimationFrame(renderVisibleItems); } }); } }
    if (!listContainer || !emptyEl || !vList.sizerEl) return;
    
    const allMovementsWithBalances = calculateRunningBalancesForAll(db.movimientos);
    const filterText = (select('search-movimientos')?.value || '').toLowerCase();
    
    const filtered = allMovementsWithBalances.filter((m) => {
        if (filterText) {
            const concept = db.conceptos.find((c) => c.id === m.conceptoId)?.nombre || '';
            let acc = '';
            if (m.tipo === 'traspaso') {
                const origen = db.cuentas.find((c) => c.id === m.cuentaOrigenId)?.nombre || '';
                const destino = db.cuentas.find((c) => c.id === m.cuentaDestinoId)?.nombre || '';
                acc = `${origen} ${destino}`;
            } else {
                 acc = db.cuentas.find((c) => c.id === m.cuentaId)?.nombre || '';
            }
            return m.descripcion.toLowerCase().includes(filterText) || concept.toLowerCase().includes(filterText) || acc.toLowerCase().includes(filterText);
        }
        return true;
    }).sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime());

    if (filtered.length === 0) { listContainer.classList.add('hidden'); emptyEl.classList.remove('hidden'); vList.sizerEl.style.height = '0px'; vList.contentEl.innerHTML = ''; return; }
    listContainer.classList.remove('hidden'); emptyEl.classList.add('hidden');
    vList.items = []; vList.itemMap = []; let totalHeight = 0;
    
    filtered.forEach((mov) => {
        const transactionItem = { type: 'transaction', movement: mov }; 
        vList.items.push(transactionItem); 
        vList.itemMap.push({ height: vList.heights.transaction, offset: totalHeight }); 
        totalHeight += vList.heights.transaction; 
    });

    vList.sizerEl.style.height = `${totalHeight}px`; 
    vList.lastRenderedRange = { start: -1, end: -1 }; 
    renderVisibleItems();
};

const renderCuentas = () => {
    const resCont = select('resumen-cuentas-container'), pillsCont = select('filter-account-types-pills'), totalBalanceEl = select('cuentas-total-balance');
    if (!resCont || !pillsCont || !totalBalanceEl) return;
    if (liquidAssetsChart) liquidAssetsChart.destroy();
    
    const saldos = getSaldos();
    const allAccounts = getVisibleAccounts();
    const allAccountTypes = [...new Set(allAccounts.map((c) => (c.tipo || 'S/T').toUpperCase()))].sort();
    
    pillsCont.innerHTML = allAccountTypes.map(t => `<button class="filter-pill ${!deselectedAccountTypesFilter.has(t) ? 'filter-pill--active' : ''}" data-action="toggle-account-type-filter" data-type="${t}">${t}</button>`).join('') || `<p style="font-size:var(--fs-xs); color:var(--c-on-surface-secondary)">No hay cuentas en esta vista.</p>`;
    
    const filteredAccountTypes = new Set(allAccountTypes.filter(t => !deselectedAccountTypesFilter.has(t)));
    
    let totalSelectedBalance = 0;
    allAccounts.forEach((c) => {
        const tipo = (c.tipo || 'S/T').toUpperCase();
        if (filteredAccountTypes.has(tipo)) {
            totalSelectedBalance += (saldos[c.id] || 0);
        }
    });
    animateCountUp(totalBalanceEl, totalSelectedBalance, 500);

    const accountsByType = allAccounts.reduce((acc, c) => {
        const tipo = (c.tipo || 'S/T').toUpperCase();
        if (!acc[tipo]) acc[tipo] = [];
        acc[tipo].push(c);
        return acc;
    }, {});
    
    resCont.innerHTML = Object.keys(accountsByType).sort().map(tipo => {
        if (!filteredAccountTypes.has(tipo)) return '';
        const accountsInType = accountsByType[tipo];
        let typeBalance = 0;
        const accountsHtml = accountsInType.sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => {
            const balance = saldos[c.id] || 0;
            typeBalance += balance;
            let amountHTML = `<strong>${formatCurrency(balance)}</strong>`;
            if (tipo === 'PRÉSTAMO') amountHTML = `<strong class="text-warning">${formatCurrency(Math.abs(balance))}</strong>`;
            const investmentIcon = c.esInversion ? `<span class="material-icons text-info" style="font-size: 14px; margin-left: var(--sp-2);" title="Cuenta de Portafolio">trending_up</span>` : '';
            return `<div class="modal__list-item" data-action="view-account-details" data-id="${c.id}" style="cursor: pointer;">
                        <div><span style="display: block; font-weight: 500;">${c.nombre}</span></div>
                        <div style="display: flex; align-items: center; gap: var(--sp-2);">${amountHTML}${investmentIcon}<span class="material-icons" style="font-size: 18px; color: var(--c-on-surface-secondary);">chevron_right</span></div>
                    </div>`;
        }).join('');
        
        if (!accountsHtml) return '';
        
        const icon = tipo==='EFECTIVO'?'payments':(tipo.includes('TARJETA')?'credit_card':(tipo==='AHORRO'?'savings':(tipo==='INVERSIÓN'?'trending_up':(tipo==='PROPIEDAD'?'domain':(tipo==='PRÉSTAMO'?'credit_score':'account_balance')))));
        
        return `<div class="account-group">
                    <div class="account-group__header">
                        <span class="account-group__name"><span class="material-icons" style="vertical-align:bottom;font-size:16px;margin-right:8px">${icon}</span>${tipo}</span>
                        <span class="account-group__balance">${formatCurrency(typeBalance)}</span>
                    </div>
                    <div>${accountsHtml}</div>
                </div>`;
    }).join('');

    const chartContainer = select(`liquid-assets-chart-container`);
    const chartCtx = (select(`liquid-assets-chart`))?.getContext('2d');
    if (chartCtx && chartContainer) {
        const saldosPorTipoChart = {};
        getLiquidAccounts().filter((c) => filteredAccountTypes.has((c.tipo || 'S/T').toUpperCase())).forEach((c) => {
            const tipo = (c.tipo || 'S/T').toUpperCase();
            saldosPorTipoChart[tipo] = (saldosPorTipoChart[tipo] || 0) + (saldos[c.id] || 0);
        });
        const chartData = Object.entries(saldosPorTipoChart).filter(([,saldo]) => saldo > 0);
        if (chartData.length > 0) {
            chartContainer.classList.remove('hidden');
            liquidAssetsChart = new Chart(chartCtx, {
                type: 'pie',
                data: {
                    labels: chartData.map(([tipo]) => tipo),
                    datasets: [{
                        data: chartData.map(([, saldo]) => saldo / 100),
                        backgroundColor: ['#0A84FF', '#FF9500', '#34C759', '#5AC8FA', '#FF3B30', '#AF52DE'],
                        borderColor: getComputedStyle(document.body).getPropertyValue('--c-surface'),
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { boxWidth: 12, padding: 15 } },
                        datalabels: {
                            formatter: (v,c)=>{let s=c.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);return s > 0 ? (v*100/s).toFixed(0)+"%" : "0%";},
                            color: '#fff',
                            font: { weight: 'bold', size: 10 }
                        }
                    }
                }
            });
        } else {
            chartContainer.classList.add('hidden');
        }
    }
};

const loadConfig = () => { 
    (select('config-skip-intro')).checked = !!db.config?.skipIntro; 
    const userEmailEl = select('config-user-email'); 
    if (userEmailEl && currentUser) userEmailEl.textContent = currentUser.email; 
};

const updateDashboard = () => {
    const kpiCont = select('kpi-container'), concCont = select('concepto-totals-list'), chartCtx = (select('conceptos-chart'))?.getContext('2d');
    if (!kpiCont || !concCont || !chartCtx) return;

    if (!kpiCont.innerHTML.trim()) {
        kpiCont.innerHTML = `
            <div class="kpi-item">
                <h4 class="kpi-item__label">Ingresos</h4>
                <strong id="kpi-ingresos-value" class="kpi-item__value text-positive" data-current-value="0">+0,00 €</strong>
                <div id="kpi-ingresos-comparison" class="kpi-item__comparison"></div>
            </div>
            <div class="kpi-item">
                <h4 class="kpi-item__label">Gastos</h4>
                <strong id="kpi-gastos-value" class="kpi-item__value text-negative" data-current-value="0">0,00 €</strong>
                <div id="kpi-gastos-comparison" class="kpi-item__comparison"></div>
            </div>
            <div class="kpi-item">
                <h4 class="kpi-item__label">Saldo Neto</h4>
                <strong id="kpi-saldo-value" class="kpi-item__value" data-current-value="0">0,00 €</strong>
                <div id="kpi-saldo-comparison" class="kpi-item__comparison"></div>
            </div>`;
    }

    concCont.innerHTML = Array(4).fill('<div class="skeleton" style="height: 48px; margin-bottom: 2px;"></div>').join('');
    if (conceptosChart) conceptosChart.destroy();

    setTimeout(() => {
        const { current, previous, label } = getFilteredMovements(true);
        const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));

        const calculateTotals = (movs) => {
            let ingresos = 0, gastos = 0;
            movs.forEach(m => {
                if(m.tipo === 'movimiento') {
                    if (m.cantidad > 0) ingresos += m.cantidad;
                    else gastos += m.cantidad;
                } else if (m.tipo === 'traspaso') {
                    const origenVisible = visibleAccountIds.has(m.cuentaOrigenId);
                    const destinoVisible = visibleAccountIds.has(m.cuentaDestinoId);
                    if(origenVisible && !destinoVisible) gastos -= m.cantidad;
                    else if (!origenVisible && destinoVisible) ingresos += m.cantidad;
                }
            });
            return { ingresos, gastos };
        };

        const currentTotals = calculateTotals(current);
        const previousTotals = calculateTotals(previous);

        const getComparisonHTML = (currentVal, prevVal, comparisonLabel) => {
            if (!comparisonLabel || prevVal === 0) return '';
            const diff = (currentVal - prevVal) / Math.abs(prevVal) * 100;
            const diffClass = (currentVal >= prevVal) ? 'text-positive' : 'text-negative';
            const icon = (currentVal >= prevVal) ? 'arrow_upward' : 'arrow_downward';
            return `<span class="${diffClass}"><span class="material-icons" style="font-size: 12px; vertical-align: middle;">${icon}</span> ${Math.abs(diff).toFixed(0)}%</span> <span style="color:var(--c-on-surface-secondary)">${comparisonLabel}</span>`;
        };
        
        const saldoActual = currentTotals.ingresos + currentTotals.gastos;
        const saldoAnterior = previousTotals.ingresos + previousTotals.gastos;

        animateCountUp(select('kpi-ingresos-value'), currentTotals.ingresos);
        select('kpi-ingresos-comparison').innerHTML = getComparisonHTML(currentTotals.ingresos, previousTotals.ingresos, label);

        animateCountUp(select('kpi-gastos-value'), currentTotals.gastos);
        select('kpi-gastos-comparison').innerHTML = getComparisonHTML(Math.abs(currentTotals.gastos), Math.abs(previousTotals.gastos), label).replace('text-positive','text-negative').replace('text-negative','text-positive'); // Invert for expenses

        const kpiSaldoValueEl = select('kpi-saldo-value');
        if (kpiSaldoValueEl) {
            kpiSaldoValueEl.classList.remove('text-positive', 'text-negative');
            kpiSaldoValueEl.classList.add(saldoActual >= 0 ? 'text-positive' : 'text-negative');
            animateCountUp(kpiSaldoValueEl, saldoActual);
        }
        select('kpi-saldo-comparison').innerHTML = getComparisonHTML(saldoActual, saldoAnterior, label);

        const cTots = current.reduce((a,m)=>{if(m.tipo==='movimiento'&&m.conceptoId){if(!a[m.conceptoId])a[m.conceptoId]={total:0,movements:[],icon:db.conceptos.find((c)=>c.id===m.conceptoId)?.icon||'label'};a[m.conceptoId].total+=m.cantidad;a[m.conceptoId].movements.push(m);}return a;},{});
        const sortedTotals = Object.entries(cTots).sort(([,a],[,b])=>a.total-b.total);
        const colorSuccess = getComputedStyle(document.body).getPropertyValue('--c-success').trim(), colorDanger = getComputedStyle(document.body).getPropertyValue('--c-danger').trim();
        conceptosChart = new Chart(chartCtx, { type: 'bar', data: { labels: sortedTotals.map(([id]) => db.conceptos.find((c)=>c.id===id)?.nombre || '?'), datasets: [{ data: sortedTotals.map(([,data]) => data.total / 100), backgroundColor: sortedTotals.map(([,data]) => data.total >= 0 ? colorSuccess : colorDanger), borderRadius: 6, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { y: { ticks: { callback: (value) => `${value.toLocaleString('es-ES')}` } } } } });
        concCont.innerHTML = sortedTotals.length===0?'<div class="empty-state" style="padding:16px 0; background:transparent;"><p>Sin datos para los filtros.</p></div>' : sortedTotals.map(([id, data]) => { const con = db.conceptos.find((c) => c.id === id); const t = data.total; return `<details class="accordion" style="background-color: var(--c-surface-variant);"><summary><span style="display: flex; align-items: center; gap: 8px;"><span class="material-icons" style="font-size: 18px;">${data.icon}</span>${con?.nombre || '?'}</span><span><strong class="${t >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(t)}</strong><span class="material-icons accordion__icon">expand_more</span></span></summary><div class="accordion__content">${data.movements.sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime()).map((mov) => `<div class="transaction-card" data-action="edit-movement" data-id="${mov.id}"><div class="transaction-card__swipe-content" style="background:transparent;"><div class="transaction-card__amount ${mov.cantidad >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(mov.cantidad)}</div><div class="transaction-card__details"><div class="transaction-card__description">${mov.descripcion}</div><div class="transaction-card__meta">${new Date(mov.fecha).toLocaleDateString('es-ES')}</div></div></div></div>`).join('')}</div></details>`; }).join('');
    }, 150); 
};

// =================================================================================
// 8. MODAL & CALCULATOR HANDLING
// =================================================================================
const showModal=(id)=>{const m=select(id);if(m){m.classList.add('modal-overlay--active');if(!id.includes('calculator')){const f=m.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(f)(f).focus();}}};
const hideModal=(id)=>{const m=select(id);if(m)m.classList.remove('modal-overlay--active');};
const showGenericModal=(title,html)=>{(select('generic-modal-title')).textContent=title;(select('generic-modal-body')).innerHTML=html;showModal('generic-modal');};
const showConfirmationModal=(msg, onConfirm, title="Confirmar Acción")=>{ vibrate(20); const id='confirmation-modal';document.getElementById(id)?.remove(); const overlay=document.createElement('div');overlay.id=id;overlay.className='modal-overlay modal-overlay--active'; overlay.innerHTML=`<div class="modal" role="alertdialog" style="border-radius:var(--border-radius-lg)"><div class="modal__header"><h3 class="modal__title">${title}</h3></div><div class="modal__body"><p>${msg}</p><div style="display:flex;gap:var(--sp-3);margin-top:var(--sp-4);"><button class="btn btn--secondary btn--full" data-action="close-confirmation">Cancelar</button><button class="btn btn--danger btn--full" data-action="confirm-action">Sí, continuar</button></div></div></div>`; document.body.appendChild(overlay); (overlay.querySelector('[data-action="confirm-action"]')).onclick=()=>{vibrate();onConfirm();overlay.remove();}; (overlay.querySelector('[data-action="close-confirmation"]')).onclick=()=>overlay.remove(); };

const showAccountMovementsModal = (cId) => {
    const cuenta = getVisibleAccounts().find((c) => c.id === cId); if (!cuenta) return;
    const allMovementsWithBalances = calculateRunningBalancesForAll(db.movimientos);
    const movs = allMovementsWithBalances.filter((m) => m.cuentaId === cId || m.cuentaOrigenId === cId || m.cuentaDestinoId === cId).sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime());
    const html = movs.length === 0 ? `<div class="empty-state"><span class="material-icons">receipt_long</span><h3>Sin Movimientos</h3><p>No hay movimientos en esta cuenta.</p></div>` : `<div class="movements-modal-container">${movs.map((m) => renderVirtualListItem({type: 'transaction', movement: m})).join('')}</div>`;
    showGenericModal(`Movimientos de ${cuenta.nombre}`, html);
};

const startEditMovement=(id)=>{ hideModal('generic-modal'); const f=select('form-movimiento'); f.reset(); clearAllErrors('form-movimiento'); const mov=id?db.movimientos.find((m)=>m.id===id):null; (select('form-movimiento-title')).textContent = mov ? 'Editar Movimiento' : 'Añadir Movimiento'; (select('movimiento-id')).value=mov?.id||''; (select('movimiento-tipo-selector')).value=mov?.tipo||'movimiento'; (select('movimiento-tipo-selector')).dispatchEvent(new Event('change')); (select('movimiento-cantidad')).value = mov ? (mov.cantidad/100).toLocaleString('es-ES') : ''; const fecha=mov?new Date(mov.fecha):new Date(); (select('movimiento-fecha')).value=new Date(fecha.getTime()-(fecha.getTimezoneOffset()*60000)).toISOString().slice(0,16); (select('movimiento-descripcion')).value=mov?.descripcion||''; populateAllDropdowns(); if(mov?.tipo==='traspaso'){ (select('movimiento-cuenta-origen')).value=mov.cuentaOrigenId; (select('movimiento-cuenta-destino')).value=mov.cuentaDestinoId; } else { (select('movimiento-cuenta')).value=mov?.cuentaId||''; (select('movimiento-concepto')).value=mov?.conceptoId||''; } select('delete-movimiento-btn')?.classList.toggle('hidden',!mov); showModal('movimiento-modal'); };

const showCalculator = (targetInput) => {
    calculatorState.targetInput = targetInput;
    const currentValue = targetInput.value.trim();
    if (currentValue && !isNaN(parseFloat(currentValue.replace(',', '.')))) {
        calculatorState.displayValue = currentValue.replace('.', '');
    } else {
        calculatorState.displayValue = '0';
    }
    calculatorState.waitingForNewValue = true;
    updateCalculatorDisplay();
    showModal('calculator-modal');
};

const hideCalculator = () => {
    hideModal('calculator-modal');
    calculatorState.targetInput = null;
};

const updateCalculatorDisplay = () => {
    const display = select('calculator-display');
    if (display) {
        display.textContent = calculatorState.displayValue.replace('.', ',');
    }
    if (calculatorState.targetInput) {
        calculatorState.targetInput.value = calculatorState.displayValue.replace('.', ',');
    }
};

const handleCalculatorInput = (key) => {
    vibrate();
    const { displayValue, waitingForNewValue } = calculatorState;

    switch(key) {
        case 'done':
            hideCalculator();
            break;
        case 'comma':
            if (!displayValue.includes('.')) {
                calculatorState.displayValue += '.';
            }
            break;
        case 'clear':
            calculatorState.displayValue = '0';
            calculatorState.waitingForNewValue = true;
            break;
        case 'backspace':
            calculatorState.displayValue = displayValue.slice(0, -1) || '0';
            break;
        case 'sign':
            if (displayValue !== '0') {
                calculatorState.displayValue = displayValue.startsWith('-')
                    ? displayValue.slice(1)
                    : `-${displayValue}`;
            }
            break;
        default: // Digit
            if (waitingForNewValue || displayValue === '0') {
                calculatorState.displayValue = key;
                calculatorState.waitingForNewValue = false;
            } else {
                calculatorState.displayValue += key;
            }
            break;
    }
    updateCalculatorDisplay();
};

// =================================================================================
// 9. FORM HANDLERS & MODAL CONTENT
// =================================================================================
const showHelpModal = () => {
    const helpHTML = `
        <h3><span class="material-icons" style="font-size:1.2em; vertical-align: bottom; margin-right: 8px;">school</span>Guía Maestra de tu Universo Financiero</h3>
        <p>¡Bienvenido/a! Esta no es solo una app, es tu centro de mando personal para entender, controlar y mejorar tu salud financiera. Hemos diseñado cada detalle para que sea potente, intuitivo y, sobre todo, útil.</p>

        <h4 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);">Lo Esencial para Empezar</h4>
        <p>Para dominar tus finanzas, primero debes conocer las piezas del puzle:</p>
        <ul>
            <li><strong>Cuentas:</strong> Representan cualquier lugar donde tienes dinero o deudas. Ejemplos: "Cartera" (Efectivo), "Banco Santander" (Cuenta Corriente), "Tarjeta VISA" (Tarjeta de Crédito), "Préstamo Coche", etc.</li>
            <li><strong>Conceptos:</strong> Son las etiquetas o categorías de tus transacciones. Te ayudan a entender <em>en qué</em> gastas o de <em>dónde</em> ingresas dinero. Ejemplos: "Nómina", "Supermercado", "Restaurantes", "Gasolina", "Ocio".</li>
            <li><strong>Movimiento:</strong> Es una transacción única, un <strong>ingreso</strong> (dinero que entra) o un <strong>gasto</strong> (dinero que sale). Cada movimiento se asocia a una <strong>Cuenta</strong> y un <strong>Concepto</strong>.</li>
            <li><strong>Traspaso:</strong> Es mover dinero <em>entre tus propias cuentas</em>. Por ejemplo, sacar dinero de un cajero (un traspaso de "Banco Santander" a "Cartera"). No es un gasto, es una reorganización de tu dinero.</li>
        </ul>

        <h4 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);">La Gran Novedad: Contabilidad Dual (A / B)</h4>
        <p>Esta potente función te permite mantener dos libros de contabilidad completamente separados. Es ideal para gestionar finanzas personales y de un negocio de forma independiente, llevar un control de "caja B" o cualquier escenario que requiera discreción.</p>
        <ul>
            <li><strong>Cómo funciona:</strong> Usa el botón <strong>Cont. A / Cont. B</strong> en la esquina superior izquierda. Al pulsarlo, toda la app (saldos, informes, movimientos) cambiará para mostrar únicamente los datos de la contabilidad seleccionada. ¡La interfaz incluso cambia de color para que siempre sepas dónde estás!</li>
            <li><strong>Asignar Cuentas a "B":</strong> Ve a <span class="material-icons" style="font-size:1em; vertical-align: text-bottom;">settings</span> <strong>Ajustes</strong> &rarr; <strong>Gestión de Cuentas</strong>. Al lado de cada cuenta, verás un interruptor con la letra "B". Actívalo para mover esa cuenta (y todos sus movimientos asociados) a la Contabilidad B.</li>
        </ul>

        <h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size:1.2em; vertical-align: bottom; margin-right: 8px;">explore</span>Un Tour por las Pestañas</h3>
        <p>Cada pestaña de la barra de navegación tiene un propósito específico:</p>
        <ul>
            <li><span class="material-icons" style="font-size:1em; vertical-align: text-bottom;">swap_horiz</span> <strong>Movimientos:</strong> Tu historial completo. Aquí ves todas tus transacciones. Desliza una transacción hacia la izquierda para <strong>eliminarla</strong> o hacia la derecha para <strong>copiarla</strong> rápidamente. Usa la barra de búsqueda para filtrar al instante.</li>
            <li><span class="material-icons" style="font-size:1em; vertical-align: text-bottom;">dashboard</span> <strong>Panel de Control:</strong> Tu vista de pájaro. Muestra tus ingresos, gastos y el saldo neto del periodo que elijas. Analiza en qué conceptos se ha ido el dinero con el gráfico y la lista detallada.</li>
            <li><span class="material-icons" style="font-size:1em; vertical-align: text-bottom;">account_balance_wallet</span> <strong>Cuentas:</strong> Tu patrimonio neto. Ve el saldo de cada una de tus cuentas agrupadas por tipo. Filtra por tipos de cuenta y visualiza la distribución de tus activos líquidos en un gráfico.</li>
            <li><span class="material-icons" style="font-size:1em; vertical-align: text-bottom;">analytics</span> <strong>Informes:</strong> Profundiza en tus datos. Selecciona un rango de fechas para generar un informe sobre la evolución de tus ingresos y gastos a lo largo del tiempo.</li>
            <li><span class="material-icons" style="font-size:1em; vertical-align: text-bottom;">trending_up</span> <strong>Portafolio:</strong> Tu centro de inversiones. Marca cuentas como "de inversión" en Ajustes y podrás seguir aquí su rendimiento, registrar aportaciones, retiradas y valoraciones periódicas para ver cómo crece tu capital.</li>
            <li><span class="material-icons" style="font-size:1em; vertical-align: text-bottom;">pie_chart</span> <strong>Presupuestos:</strong> Planifica tu futuro. Define presupuestos anuales para cada concepto (metas de ingreso o límites de gasto). La app te mostrará tu progreso en tiempo real para que no te desvíes de tus objetivos.</li>
            <li><span class="material-icons" style="font-size:1em; vertical-align: text-bottom;">settings</span> <strong>Ajustes:</strong> La sala de máquinas. Gestiona tus cuentas y conceptos, importa o exporta tus datos, y configura las opciones de la app.</li>
        </ul>

        <h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size:1.2em; vertical-align: bottom; margin-right: 8px;">star</span>Consejos de Experto</h3>
        <ul>
            <li><strong>Calculadora Integrada:</strong> Al añadir o editar un movimiento, pulsa en el campo de la cantidad para abrir una calculadora integrada. ¡Se acabaron los errores de dedo!</li>
            <li><strong>Sugerencias Inteligentes:</strong> Al escribir una descripción, la app te sugerirá movimientos anteriores que coincidan, rellenando automáticamente el concepto y la cantidad.</li>
            <li><strong>¡Haz Copias de Seguridad!:</strong> En <strong>Ajustes &rarr; Gestión de Datos</strong>, usa la opción <strong>Exportar JSON</strong> regularmente. Es tu seguro de vida digital. Guárdalo en un lugar seguro.</li>
            <li><strong>Importación CSV:</strong> ¿Vienes de otra app o del extracto de tu banco? Usa el <strong>Asistente de Importación CSV</strong> en Ajustes para añadir movimientos en masa de forma sencilla.</li>
        </ul>

        <p style="text-align: center; margin-top: var(--sp-5); font-style: italic; color: var(--c-on-surface-secondary);">Ahora eres el maestro/a de tus finanzas. ¡Explora, registra y toma el control!</p>
    `;
    showGenericModal("Guía Completa de Usuario", helpHTML);
};

const showConceptosModal = () => { const html = `<form id="add-concepto-form" novalidate style="margin-bottom: var(--sp-4);"><div class="form-grid"><div class="form-group" style="grid-column: 1 / 2;"><label for="new-concepto-nombre" class="form-label">Nombre del Concepto</label><input type="text" id="new-concepto-nombre" class="form-input" placeholder="Ej: Nómina" required></div><div class="form-group" style="grid-column: 2 / 3;"><label for="new-concepto-icon" class="form-label">Icono (Material)</label><input type="text" id="new-concepto-icon" class="form-input" placeholder="Ej: shopping_cart"></div></div><p style="font-size: var(--fs-xs); color: var(--c-on-surface-secondary); margin-top: calc(-1 * var(--sp-2)); margin-bottom: var(--sp-3);">Busca iconos en <a href="https://fonts.google.com/icons" target="_blank" rel="noopener noreferrer">Google Fonts</a>.</p><button type="submit" class="btn btn--primary btn--full">Añadir Concepto</button></form><hr style="border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-top: var(--sp-4); margin-bottom: var(--sp-2); font-size: var(--fs-base); color: var(--c-on-surface-secondary);">Conceptos Existentes</h4><div id="conceptos-modal-list"></div>`; showGenericModal('Gestionar Conceptos', html); renderConceptosModalList(); };
const renderConceptosModalList = () => { const list = select('conceptos-modal-list'); if (!list) return; list.innerHTML = (db.conceptos || []).length === 0 ? `<p style="font-size:var(--fs-sm); color:var(--c-on-surface-secondary); text-align:center; padding: var(--sp-4) 0;">No hay conceptos.</p>` : [...db.conceptos].sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => `<div class="modal__list-item"><span style="display: flex; align-items: center; gap: 12px;"><span class="material-icons" style="color: var(--c-primary);">${c.icon || 'label'}</span>${c.nombre}</span><button class="icon-btn" data-action="delete-concepto" data-id="${c.id}" title="Eliminar Concepto"><span class="material-icons">delete_outline</span></button></div>`).join(''); };
const showCuentasModal = () => { const html = `<form id="add-cuenta-form" novalidate><div class="form-group"><label for="new-cuenta-nombre" class="form-label">Nombre de la Cuenta</label><input type="text" id="new-cuenta-nombre" class="form-input" placeholder="Ej: Cartera personal" required></div><div class="form-group"><label for="new-cuenta-tipo" class="form-label">Tipo de Cuenta</label><input type="text" id="new-cuenta-tipo" class="form-input" list="tipos-cuenta-list" placeholder="Ej: Efectivo" required><datalist id="tipos-cuenta-list"><option value="Efectivo"></option><option value="Cuenta Corriente"></option><option value="Ahorro"></option><option value="Inversión"></option><option value="Tarjeta de Crédito"></option><option value="Préstamo"></option><option value="Propiedad"></option><option value="Plan de Pensiones"></option></datalist></div><button type="submit" class="btn btn--primary btn--full" style="margin-top: var(--sp-3)">Añadir Cuenta</button></form><hr style="margin: var(--sp-4) 0; border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-top: var(--sp-4); margin-bottom: var(--sp-2); font-size: var(--fs-base); color: var(--c-on-surface-secondary);">Cuentas Existentes</h4><div id="cuentas-modal-list"></div>`; showGenericModal('Gestionar Cuentas', html); renderCuentasModalList(); };
const showAccountEditForm = (id) => {
    const itemContainer = select(`cuenta-item-${id}`);
    const cuenta = db.cuentas.find(c => c.id === id);
    if (!itemContainer || !cuenta) return;
    const escapeHTML = str => str.replace(/[&<>"']/g, match => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[match]);
    const formHtml = `
        <div class="cuenta-item-edit-form" data-id="${id}" style="width:100%; display:flex; flex-direction:column; gap: var(--sp-2); padding: var(--sp-2) 0;">
            <div class="form-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="edit-cuenta-nombre-${id}" style="font-size: var(--fs-xs);">Nombre</label>
                    <input type="text" id="edit-cuenta-nombre-${id}" class="form-input" style="padding: var(--sp-2);" value="${escapeHTML(cuenta.nombre)}" required>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="edit-cuenta-tipo-${id}" style="font-size: var(--fs-xs);">Tipo</label>
                    <input type="text" id="edit-cuenta-tipo-${id}" class="form-input" style="padding: var(--sp-2);" list="tipos-cuenta-list" value="${escapeHTML(cuenta.tipo)}" required>
                </div>
            </div>
            <div style="display:flex; justify-content: flex-end; gap: var(--sp-2); align-items: center; margin-top: var(--sp-2);">
                <button type="button" class="btn btn--secondary" data-action="cancel-edit-cuenta">Cancelar</button>
                <button type="button" class="btn btn--primary" data-action="save-edited-cuenta" data-id="${id}">Guardar</button>
            </div>
        </div>
    `;
    itemContainer.innerHTML = formHtml;
    select(`edit-cuenta-nombre-${id}`).focus();
};
const handleSaveEditedAccount = (id, btn) => {
    const nombre = (select(`edit-cuenta-nombre-${id}`)).value.trim();
    const tipo = (select(`edit-cuenta-tipo-${id}`)).value.trim().toUpperCase();
    if (!nombre || !tipo) { showToast('El nombre y el tipo no pueden estar vacíos.', 'warning'); return; }
    const cuentaIndex = db.cuentas.findIndex(c => c.id === id);
    if (cuentaIndex > -1) {
        setButtonLoading(btn, true);
        db.cuentas[cuentaIndex].nombre = nombre;
        db.cuentas[cuentaIndex].tipo = tipo;
        saveData(btn, () => {
            showToast('Cuenta actualizada.');
            renderCuentasModalList();
            renderAll();
        });
    }
};
const renderCuentasModalList = () => {
    const list = select('cuentas-modal-list');
    if (!list) return;
    list.innerHTML = (db.cuentas || []).length === 0
        ? `<p style="font-size:var(--fs-sm); color:var(--c-on-surface-secondary); text-align:center; padding: var(--sp-4) 0;">No hay cuentas.</p>`
        : [...db.cuentas].sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => `
            <div class="modal__list-item" id="cuenta-item-${c.id}">
                <div style="display: flex; flex-direction: column; flex-grow: 1; min-width: 0;">
                    <span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.nombre}</span>
                    <small style="color: var(--c-on-surface-secondary); font-size: var(--fs-xs);">${c.tipo.toUpperCase()}</small>
                </div>
                <div style="display: flex; align-items: center; gap: var(--sp-1); flex-shrink: 0;">
                    <div class="form-switch-group" style="gap: var(--sp-2);">
                        <label for="offbalance-toggle-${c.id}" style="font-size: var(--fs-xs); color: var(--c-on-surface-secondary);" title="Marcar como 'Contabilidad B'">B</label>
                        <label class="form-switch">
                            <input type="checkbox" id="offbalance-toggle-${c.id}" data-action="toggle-off-balance" data-id="${c.id}" ${c.offBalance ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button class="icon-btn" data-action="edit-cuenta" data-id="${c.id}" title="Editar Cuenta"><span class="material-icons">edit_note</span></button>
                    <button class="icon-btn" data-action="delete-cuenta" data-id="${c.id}" title="Eliminar Cuenta"><span class="material-icons">delete_outline</span></button>
                </div>
            </div>`).join('');
};

// =================================================================================
// 10. ROBUST CSV IMPORT WIZARD
// =================================================================================
const csvWizardState = { file: null, rawText: '', parsedData: [], headers: [], previewRows: [], mapping: {}, finalMovements: [], };
const startCsvImportWizard = (file) => {
    if (!file) return; csvWizardState.file = file; const reader = new FileReader();
    reader.onload = (event) => {
        if (!event.target?.result) return;
        csvWizardState.rawText = event.target.result; csvWizardState.parsedData = robustCsvParse(csvWizardState.rawText);
        if (csvWizardState.parsedData.length < 2) { showToast('Archivo CSV inválido o con menos de una fila de datos.', 'danger'); return; }
        csvWizardState.headers = csvWizardState.parsedData[0]; csvWizardState.previewRows = csvWizardState.parsedData.slice(1, 6);
        renderCsvStep1_Mapping(); showModal('import-csv-wizard-modal');
    };
    reader.onerror = () => showToast('Error al leer el archivo.', 'danger'); reader.readAsText(file);
};
const renderCsvStep1_Mapping = () => {
    (select('import-csv-wizard-title')).textContent = 'Paso 1: Asignar Columnas';
    const appFields = [ { value: 'ignore', text: 'Ignorar Columna' }, { value: 'descripcion', text: 'Descripción (Obligatorio)' }, { value: 'fecha', text: 'Fecha (Obligatorio)' }, { value: 'importe', text: 'Importe (una columna, gasto en negativo)' }, { value: 'ingreso', text: 'Importe (Ingresos)' }, { value: 'gasto', text: 'Importe (Gastos, usar positivo)' }, { value: 'cuenta', text: 'Cuenta (Para Movimientos)' }, { value: 'cuentaOrigen', text: 'Cuenta Origen (Para Traspasos)' }, { value: 'cuentaDestino', text: 'Cuenta Destino (Para Traspasos)' }, { value: 'concepto', text: 'Concepto' }, ];
    const optionsHtml = appFields.map(f => `<option value="${f.value}">${f.text}</option>`).join('');
    let mappingTableHtml = `<p class="form-label" style="margin-bottom: var(--sp-3)">Asigna cada columna de tu archivo CSV al campo correspondiente. La app creará cuentas y conceptos que no existan.</p><div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; text-align: left;"><thead><tr><th style="padding: 8px; border-bottom: 1px solid var(--c-outline);">Columna CSV</th><th style="padding: 8px; border-bottom: 1px solid var(--c-outline);">Asignar a...</th></tr></thead><tbody>`;
    csvWizardState.headers.forEach((header, index) => {
        let selected = 'ignore'; const h = header.toLowerCase().trim(); if (h.includes('fecha') || h.includes('date')) selected = 'fecha'; if (h.includes('descrip') || h.includes('concept') || h.includes('detail')) selected = 'descripcion'; if (h.includes('import') || h.includes('amount') || h.includes('valor')) selected = 'importe'; if (h.includes('debe') || h.includes('debit') || h.includes('gasto')) selected = 'gasto'; if (h.includes('haber') || h.includes('credit') || h.includes('ingreso')) selected = 'ingreso'; if (h.includes('cuenta') || h.includes('account')) selected = 'cuenta';
        mappingTableHtml += `<tr><td style="padding: 8px; border-bottom: 1px solid var(--c-outline);"><strong>${header}</strong><br><small style="color:var(--c-on-surface-secondary);">${csvWizardState.previewRows[0]?.[index] || '...'}</small></td><td style="padding: 8px; border-bottom: 1px solid var(--c-outline);"><select class="form-select csv-mapping-select" data-header="${header}">${optionsHtml.replace(`value="${selected}"`, `value="${selected}" selected`)}</select></td></tr>`;
    });
    mappingTableHtml += '</tbody></table></div>';
    (select('import-csv-wizard-body')).innerHTML = mappingTableHtml;
    (select('import-csv-wizard-actions')).innerHTML = `<button data-action="csv-wizard-next-step" class="btn btn--primary">Siguiente: Previsualizar</button>`;
};
const processMappingAndRenderPreview = () => {
    csvWizardState.mapping = {};
    selectAll('.csv-mapping-select').forEach(selectEl => {
        const sel = selectEl;
        if (sel.value !== 'ignore') {
            if (sel.value === 'descripcion') { if (!csvWizardState.mapping[sel.value]) csvWizardState.mapping[sel.value] = []; (csvWizardState.mapping[sel.value]).push(sel.dataset.header); } else { if (csvWizardState.mapping[sel.value]) { showToast(`El campo '${sel.options[sel.selectedIndex].text}' ha sido asignado múltiples veces.`, 'warning'); throw new Error('Duplicate mapping'); } csvWizardState.mapping[sel.value] = sel.dataset.header; }
        }
    });
    if (!csvWizardState.mapping.fecha || !csvWizardState.mapping.descripcion) { showToast('Debes asignar las columnas de Fecha y Descripción.', 'danger'); throw new Error('Missing required mapping'); }
    const hasAmount = csvWizardState.mapping.importe || (csvWizardState.mapping.ingreso && csvWizardState.mapping.gasto) || csvWizardState.mapping.ingreso || csvWizardState.mapping.gasto; if (!hasAmount) { showToast('Debes asignar al menos una columna de importe.', 'danger'); throw new Error('Missing amount mapping'); }
    renderCsvStep2_Preview();
};
const interpretCsvRow = (rowObject) => {
    const { mapping } = csvWizardState; let mov = { _raw: rowObject, _errors: [], descripcion: '', fecha: null, cantidad: 0, cuenta: null, concepto: null, tipo: 'movimiento' };
    const dateStr = rowObject[mapping.fecha]; if (dateStr) { let parsedDate = new Date(dateStr.replace(/(\d{2})[\\/.-](\d{2})[\\/.-](\d{4})/, '$3-$2-$1')); if (isNaN(parsedDate.getTime())) parsedDate = new Date(dateStr); if (isNaN(parsedDate.getTime())) mov._errors.push('Fecha inválida'); else mov.fecha = parsedDate; } else { mov._errors.push('Fecha no encontrada'); }
    if (Array.isArray(mapping.descripcion)) { mov.descripcion = mapping.descripcion.map(header => rowObject[header]).join(' - '); } else { mov.descripcion = rowObject[mapping.descripcion] || ''; } if (!mov.descripcion) mov._errors.push('Descripción vacía');
    let ingreso = 0, gasto = 0; if (mapping.importe) { const amount = parseFloat(String(rowObject[mapping.importe]).replace(/[^0-9-.,]/g, '').replace(',', '.')); if (isNaN(amount)) mov._errors.push('Importe no numérico'); else mov.cantidad = Math.round(amount * 100); } else { if (mapping.ingreso && rowObject[mapping.ingreso]) { ingreso = parseFloat(String(rowObject[mapping.ingreso]).replace(/[^0-9-.,]/g, '').replace(',', '.')); if (isNaN(ingreso)) mov._errors.push('Ingreso no numérico'); } if (mapping.gasto && rowObject[mapping.gasto]) { gasto = parseFloat(String(rowObject[mapping.gasto]).replace(/[^0-9-.,]/g, '').replace(',', '.')); if (isNaN(gasto)) mov._errors.push('Gasto no numérico'); } mov.cantidad = Math.round((ingreso - gasto) * 100); }
    const cuentaOrigen = mapping.cuentaOrigen ? rowObject[mapping.cuentaOrigen] : null; const cuentaDestino = mapping.cuentaDestino ? rowObject[mapping.cuentaDestino] : null;
    if (cuentaOrigen && cuentaDestino) { mov.tipo = 'traspaso'; mov.cuentaOrigen = cuentaOrigen; mov.cuentaDestino = cuentaDestino; mov.cantidad = Math.abs(mov.cantidad); } else { mov.tipo = 'movimiento'; mov.cuenta = mapping.cuenta ? rowObject[mapping.cuenta] : 'Cuenta Importada'; }
    mov.concepto = mapping.concepto ? rowObject[mapping.concepto] : 'Importado'; return mov;
};
const renderCsvStep2_Preview = () => {
    (select('import-csv-wizard-title')).textContent = 'Paso 2: Previsualizar y Validar';
    let previewTable = `<p class="form-label" style="margin-bottom: var(--sp-3)">Así es como la app interpretará tus datos. Las filas con errores (en rojo) no se importarán.</p><div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; text-align: left;"><thead><tr><th style="padding: 8px; border-bottom: 1px solid var(--c-outline);">Fecha</th><th style="padding: 8px; border-bottom: 1px solid var(--c-outline);">Descripción</th><th style="padding: 8px; border-bottom: 1px solid var(--c-outline);">Cuenta</th><th style="padding: 8px; border-bottom: 1px solid var(--c-outline);">Importe</th><th style="padding: 8px; border-bottom: 1px solid var(--c-outline);">Estado</th></tr></thead><tbody>`;
    csvWizardState.finalMovements = [];
    csvWizardState.parsedData.slice(1).forEach(row => { const rowObject = csvWizardState.headers.reduce((obj, header, i) => ({ ...obj, [header]: row[i] }), {}); csvWizardState.finalMovements.push(interpretCsvRow(rowObject)); });
    csvWizardState.finalMovements.slice(0, 10).forEach(mov => {
        const hasError = mov._errors.length > 0; const cuentaText = mov.tipo === 'traspaso' ? `${mov.cuentaOrigen} → ${mov.cuentaDestino}` : mov.cuenta;
        previewTable += `<tr style="${hasError ? 'background-color: color-mix(in srgb, var(--c-danger) 15%, transparent);' : ''}"><td style="padding: 8px; border-bottom: 1px solid var(--c-outline);">${mov.fecha ? mov.fecha.toLocaleDateString('es-ES') : '---'}</td><td style="padding: 8px; border-bottom: 1px solid var(--c-outline);">${mov.descripcion}</td><td style="padding: 8px; border-bottom: 1px solid var(--c-outline);">${cuentaText}</td><td style="padding: 8px; border-bottom: 1px solid var(--c-outline);" class="${mov.cantidad >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(mov.cantidad)}</td><td style="padding: 8px; border-bottom: 1px solid var(--c-outline);">${hasError ? mov._errors.join(', ') : '<span class="text-positive">OK</span>'}</td></tr>`;
    });
    previewTable += '</tbody></table></div>'; (select('import-csv-wizard-body')).innerHTML = previewTable;
    const validCount = csvWizardState.finalMovements.filter(m => m._errors.length === 0).length;
    (select('import-csv-wizard-actions')).innerHTML = `<span style="margin-right: auto; color: var(--c-on-surface-secondary);">Se importarán <strong>${validCount}</strong> de <strong>${csvWizardState.finalMovements.length}</strong> filas.</span><button data-action="csv-wizard-back-step" class="btn btn--secondary">Atrás</button><button data-action="csv-wizard-import" class="btn btn--primary" ${validCount === 0 ? 'disabled' : ''}>Confirmar e Importar</button>`;
};
const processAndSaveCsvImport = (btn) => {
    setButtonLoading(btn, true, 'Importando...');
    const validMovements = csvWizardState.finalMovements.filter(m => m._errors.length === 0), newAccounts = new Map(), newConcepts = new Map();
    const getAccountId = (name) => { if (newAccounts.has(name)) return newAccounts.get(name); const existing = db.cuentas.find(c => c.nombre.toLowerCase() === name.toLowerCase()); if (existing) return existing.id; const newId = generateId(); db.cuentas.push({ id: newId, nombre: name, tipo: 'IMPORTADO', esInversion: false, offBalance: isOffBalanceMode, fechaCreacion: new Date().toISOString() }); newAccounts.set(name, newId); return newId; };
    const getConceptId = (name) => { if (newConcepts.has(name)) return newConcepts.get(name); const existing = db.conceptos.find(c => c.nombre.toLowerCase() === name.toLowerCase()); if (existing) return existing.id; const newId = generateId(); db.conceptos.push({ id: newId, nombre: name, icon: 'file_upload' }); newConcepts.set(name, newId); return newId; };
    validMovements.forEach(mov => { const finalMov = { id: generateId(), fecha: mov.fecha.toISOString(), descripcion: mov.descripcion, cantidad: mov.cantidad, tipo: mov.tipo }; if (mov.tipo === 'traspaso') { finalMov.cuentaOrigenId = getAccountId(mov.cuentaOrigen); finalMov.cuentaDestinoId = getAccountId(mov.cuentaDestino); } else { finalMov.cuentaId = getAccountId(mov.cuenta); finalMov.conceptoId = getConceptId(mov.concepto); } db.movimientos.push(finalMov); });
    saveData(btn, () => renderCsvStep3_Summary(validMovements.length, csvWizardState.finalMovements.length - validMovements.length, newAccounts.size, newConcepts.size));
};
const renderCsvStep3_Summary = (imported, skipped, newAcc, newCon) => {
    (select('import-csv-wizard-title')).textContent = 'Importación Completada';
    (select('import-csv-wizard-body')).innerHTML = `<div class="empty-state" style="padding: var(--sp-5);"><span class="material-icons text-positive" style="font-size: 48px;">check_circle</span><h3>¡Éxito!</h3><p style="max-width: 350px; margin: auto;">Tu archivo ha sido procesado. Aquí tienes el resumen:</p><div style="text-align: left; max-width: 250px; margin: var(--sp-4) auto 0 auto;"><div class="modal__list-item"><span>Movimientos importados:</span><strong>${imported}</strong></div><div class="modal__list-item"><span>Filas omitidas (con errores):</span><strong>${skipped}</strong></div><div class="modal__list-item"><span>Nuevas cuentas creadas:</span><strong>${newAcc}</strong></div><div class="modal__list-item"><span>Nuevos conceptos creados:</span><strong>${newCon}</strong></div></div></div>`;
    (select('import-csv-wizard-actions')).innerHTML = `<button data-action="close-modal" data-modal-id="import-csv-wizard-modal" class="btn btn--primary btn--full">Entendido</button>`;
    buildDescriptionIndex();
    renderAll();
};

// =================================================================================
// 11. EVENT LISTENERS & HANDLERS
// =================================================================================
const attachEventListeners = () => {
    let currentSwipedCard = null; window.debounceTimer = undefined; let touchStartX = 0, touchStartY = 0;
    document.body.addEventListener('click', (e) => {
        const target = e.target;
        if (currentSwipedCard && !currentSwipedCard.contains(target)) { currentSwipedCard.classList.remove('transaction-card--swiped-left', 'transaction-card--swiped-right'); currentSwipedCard = null; }
        
        const actionTarget = target.closest('[data-action]');
        
        const suggestionsBox = select('description-suggestions');
        if (suggestionsBox && suggestionsBox.style.display === 'block' && !target.closest('#movimiento-descripcion') && !target.closest('#description-suggestions')) {
            suggestionsBox.style.display = 'none';
        }

        const modalOverlay = target.closest('.modal-overlay');
        if (modalOverlay && target === modalOverlay && !modalOverlay.id.includes('calculator')) return hideModal(modalOverlay.id);
        if (!actionTarget) return; 
        const {action, id, page, type, cuentaId, modalId} = (actionTarget).dataset, btn = actionTarget.closest('button'), cardElement = actionTarget.closest('.transaction-card');
        
        const actions = {
            'login': () => handleLogin(btn), 'register': () => handleRegister(btn), 'exit': handleExitApp,
            'navigate': () => navigateTo(page), 'theme-toggle': toggleTheme, 'help': showHelpModal,
            'toggle-ledger': () => handleToggleLedger(),
            'toggle-off-balance': () => {
                const checkbox = target.closest('input[type="checkbox"]'); if (!checkbox) return;
                vibrate();
                const account = db.cuentas.find(c => c.id === checkbox.dataset.id);
                if (account) { account.offBalance = checkbox.checked; saveData(null, () => renderAll()); }
            },
            'apply-filters': () => { vibrate(); updateDashboard(); renderCuentas(); },
            'apply-informe-filters': () => { vibrate(); renderInformesPage(); },
            'add-movement': () => { vibrate(); startEditMovement(null); },
            'edit-movement': () => { vibrate(); startEditMovement(id); },
            'delete-movement-swipe': () => showConfirmationModal('¿Seguro que quieres eliminar este movimiento?', ()=>{db.movimientos=db.movimientos.filter((m)=>m.id!==cardElement.dataset.id);saveData(null,()=>{buildDescriptionIndex();renderAll();showToast('Movimiento eliminado.');});}),
            'copy-movement-swipe': () => handleCopyMovement(cardElement.dataset.id),
            'copy-last-movement': handleCopyLastMovement,
            'delete-movement-from-modal': () => showConfirmationModal('¿Seguro que quieres eliminar este movimiento?', () => { const idToDelete = (select('movimiento-id')).value; db.movimientos = db.movimientos.filter((m) => m.id !== idToDelete); saveData(null, () => { hideModal('movimiento-modal'); showToast('Movimiento eliminado.'); buildDescriptionIndex(); renderAll(); }); }),
            'delete-concepto': () => { if(db.movimientos.some((m)=>m.conceptoId===id)){showToast("Concepto en uso, no se puede borrar.","warning");return;} showConfirmationModal('¿Seguro que quieres eliminar este concepto?',()=>{db.conceptos=db.conceptos.filter((c)=>c.id!==id);saveData(null,()=>{showToast("Concepto eliminado.");renderConceptosModalList();populateAllDropdowns();});}); },
            'delete-cuenta': () => { if(db.movimientos.some((m)=>m.cuentaId===id||m.cuentaOrigenId===id||m.cuentaDestinoId===id)){showToast("Cuenta con movimientos, no se puede borrar.","warning",3500);return;} showConfirmationModal('¿Seguro que quieres eliminar esta cuenta?',()=>{db.cuentas=db.cuentas.filter((c)=>c.id!==id);saveData(null,()=>{showToast("Cuenta eliminada.");renderCuentasModalList();populateAllDropdowns();renderAll();});}); },
            'close-modal': () => hideModal(modalId || target.closest('.modal-overlay').id), 'manage-conceptos': showConceptosModal, 'manage-cuentas': showCuentasModal, 'view-account-details': () => showAccountMovementsModal(id),
            'save-config': () => handleSaveConfig(btn), 'export-data': () => handleExportData(btn), 'export-csv': showExportCsvModal,
            'import-data': () => (select('import-file-input')).click(),
            'import-csv-wizard': () => (select('import-csv-file-input')).click(),
            'clear-data': () => showConfirmationModal('¿Seguro que quieres borrar TODOS tus datos financieros? Esta acción es irreversible y no eliminará tu cuenta de usuario.',()=>{showConfirmationModal('Esta acción no se puede deshacer. ¿Continuar con el borrado de datos?', () => {db=getInitialDb();saveData(null,()=>{buildDescriptionIndex(); renderAll();showToast('Datos borrados.','danger');});}, 'Confirmación Final')}),
            'toggle-account-type-filter': () => { vibrate(); if(deselectedAccountTypesFilter.has(type)) { deselectedAccountTypesFilter.delete(type); } else { deselectedAccountTypesFilter.add(type); } renderCuentas(); },
            'create-budgets': () => handleCreateBudgets(parseInt((select('budget-year-selector')).value, 10), btn),
            'update-budgets': handleUpdateBudgets,
            'logout': () => showConfirmationModal('¿Seguro que quieres cerrar la sesión?', () => { fbAuth.signOut().then(() => { showToast('Sesión cerrada correctamente.'); }).catch(() => { showToast('Error al cerrar sesión.', 'danger'); }); }, 'Cerrar Sesión'),
            'delete-account': () => handleDeleteAccount(btn),
            'back-to-investment-list': renderInversionesPage,
            'view-investment-detail': () => renderInvestmentAccountDetail(id),
            'update-investment-value': (ev) => { ev.stopPropagation(); hideModal('generic-modal'); showValoracionModal(id); },
            'manage-investment-accounts': showManageInvestmentAccountsModal,
            'add-aportacion': () => showAportacionModal(),
            'edit-valoracion': () => showValoracionModal(cuentaId, id),
            'edit-aportacion': () => showAportacionModal(cuentaId, id),
            'delete-valoracion': () => showConfirmationModal('¿Eliminar esta valoración?', () => { const form = select('valoracion-modal')?.querySelector('form'); if(!form) return; const idToDelete = (form.querySelector('#valoracion-id')).value; const currentCuentaId = (form.querySelector('#valoracion-cuenta-id')).value; db.inversiones_historial = (db.inversiones_historial || []).filter((v) => v.id !== idToDelete); saveData(null, () => { hideModal('valoracion-modal'); if (!select('investment-detail-view')?.classList.contains('hidden')) renderInvestmentAccountDetail(currentCuentaId); else renderInversionesPage(); }); }),
            'delete-aportacion': () => showConfirmationModal('¿Eliminar este flujo de capital?', () => { const form = select('aportacion-modal')?.querySelector('form'); if(!form) return; const idToDelete = (form.querySelector('#aportacion-id')).value; const currentCuentaId = (form.querySelector('#aportacion-cuenta-id')).value; db.inversion_cashflows = (db.inversion_cashflows || []).filter((cf) => cf.id !== idToDelete); saveData(null, () => { hideModal('aportacion-modal'); if (!select('investment-detail-view')?.classList.contains('hidden')) renderInvestmentAccountDetail(currentCuentaId); else renderInversionesPage(); }); }),
            'csv-wizard-next-step': () => { try { processMappingAndRenderPreview(); } catch (e) { console.error(e); } },
            'csv-wizard-back-step': () => renderCsvStep1_Mapping(),
            'csv-wizard-import': () => processAndSaveCsvImport(btn),
            'edit-cuenta': () => showAccountEditForm(id),
            'cancel-edit-cuenta': renderCuentasModalList,
            'save-edited-cuenta': () => handleSaveEditedAccount(id, btn),
        };
        if (actions[action]) actions[action](e);
    });

    document.body.addEventListener('submit', (e) => { e.preventDefault(); const target = e.target; const handlers = {'form-movimiento':handleSaveMovement, 'add-concepto-form':handleAddConcept, 'add-cuenta-form':handleAddAccount, 'export-csv-form': handleExportCsv, 'form-valoracion': handleSaveValoracion, 'manage-investment-accounts-form': handleSaveInvestmentAccounts, 'form-aportacion': handleSaveAportacion }; if(handlers[target.id]) handlers[target.id](target); });
    document.body.addEventListener('input', (e) => { const id=(e.target).id; if(id && select(`${id}-error`)) clearError(id); });
    document.body.addEventListener('focusin', (e) => { if (e.target.matches('.input-amount-calculator')) { e.preventDefault(); showCalculator(e.target); } });

    select('filter-periodo')?.addEventListener('change', (e) => select('custom-date-filters')?.classList.toggle('hidden', (e.target).value !== 'custom'));
    select('movimiento-tipo-selector')?.addEventListener('change', (e) => { const isT=(e.target).value==='traspaso';select('movimiento-fields')?.classList.toggle('hidden',isT);select('traspaso-fields')?.classList.toggle('hidden',!isT);['movimiento-concepto','movimiento-cuenta'].forEach(id=>(select(id)).required=!isT);['movimiento-cuenta-origen','movimiento-cuenta-destino'].forEach(id=>(select(id)).required=isT); });
    select('import-file-input')?.addEventListener('change', (e)=>{const f=(e.target).files?.[0];if(!f)return;const r=new FileReader();r.onload=(re)=>{try{let d=JSON.parse(re.target.result);if(d.db)d=d.db;showConfirmationModal('La importación de JSON reemplazará TODOS tus datos. ¿Estás seguro?',()=>{db=d;saveData(null,()=>{buildDescriptionIndex();renderAll();showToast('Datos importados.');});});}catch(err){showToast('Error: Archivo JSON no válido.','danger');console.error("Import error:",err);}};r.readAsText(f);(e.target).value='';});
    select('import-csv-file-input')?.addEventListener('change', (e) => { const file = (e.target).files?.[0]; if (file) { startCsvImportWizard(file); } (e.target).value = ''; });
    
    select('calculator-grid')?.addEventListener('click', (e) => { const btn = e.target.closest('button'); if(btn && btn.dataset.key) handleCalculatorInput(btn.dataset.key); });
    
    const descInput = select('movimiento-descripcion');
    const suggestionsBox = select('description-suggestions');

    descInput?.addEventListener('input', () => {
        const query = descInput.value.toLowerCase();
        if (query.length < 2) {
            suggestionsBox.innerHTML = '';
            suggestionsBox.style.display = 'none';
            return;
        }

        const suggestions = Object.keys(descriptionIndex)
            .filter(key => key.includes(query))
            .sort((a, b) => descriptionIndex[b].count - descriptionIndex[a].count)
            .slice(0, 5);

        if (suggestions.length > 0) {
            suggestionsBox.innerHTML = suggestions.map(key => {
                const item = descriptionIndex[key];
                const conceptName = db.conceptos.find(c => c.id === item.lastConceptId)?.nombre || 'S/C';
                return `<div class="suggestion-item" data-desc="${item.fullDescription}" data-concept-id="${item.lastConceptId}" data-amount="${item.lastAmount}">
                            <strong>${item.fullDescription}</strong><br>
                            <small>${conceptName} &bull; ${formatCurrency(item.lastAmount)}</small>
                        </div>`;
            }).join('');
            suggestionsBox.style.display = 'block';
        } else {
            suggestionsBox.style.display = 'none';
        }
    });

    suggestionsBox?.addEventListener('click', (e) => {
        const item = e.target.closest('.suggestion-item');
        if (item) {
            vibrate();
            select('movimiento-descripcion').value = item.dataset.desc;
            select('movimiento-concepto').value = item.dataset.conceptId;
            select('movimiento-cantidad').value = (item.dataset.amount / 100).toLocaleString('es-ES');
            suggestionsBox.style.display = 'none';
            select('movimiento-concepto').focus();
        }
    });

    const listContainer = select('movimientos-page');
    listContainer?.addEventListener('touchstart', (e) => { const card = (e.target).closest('.transaction-card'); if (!card || !select('movimientos-list-container')?.contains(card)) return; if (currentSwipedCard && currentSwipedCard !== card) { currentSwipedCard.classList.remove('transaction-card--swiped-left', 'transaction-card--swiped-right'); } currentSwipedCard = card; touchStartX = e.targetTouches[0].clientX; touchStartY = e.targetTouches[0].clientY; }, { passive: true });
    listContainer?.addEventListener('touchmove', (e) => { if (!touchStartX || !currentSwipedCard) return; const touchEndX = e.targetTouches[0].clientX; const touchEndY = e.targetTouches[0].clientY; const diffX = touchStartX - touchEndX; const diffY = touchStartY - touchEndY; if (Math.abs(diffX) > Math.abs(diffY)) { e.preventDefault(); currentSwipedCard.querySelector('.transaction-card__swipe-content').style.transform = `translateX(${-diffX}px)`; } }, { passive: false });
    listContainer?.addEventListener('touchend', (e) => { if (!touchStartX || !currentSwipedCard) return; const touchEndX = e.changedTouches[0].clientX; const diffX = touchEndX - touchStartX; const swipeThreshold = 50; const swipeContent = currentSwipedCard.querySelector('.transaction-card__swipe-content'); swipeContent.style.transition = 'transform 0.3s ease'; if (diffX > swipeThreshold) { currentSwipedCard.classList.add('transaction-card--swiped-right'); } else if (diffX < -swipeThreshold) { currentSwipedCard.classList.add('transaction-card--swiped-left'); } swipeContent.style.transform = ''; touchStartX = 0; });
};
const handleToggleLedger = () => {
    vibrate();
    isOffBalanceMode = !isOffBalanceMode;
    document.body.dataset.ledgerMode = isOffBalanceMode ? 'B' : 'A';
    const activePage = selectOne('.view--active')?.id || 'movimientos-page';
    navigateTo(activePage, true);
    renderAll();
    const btn = select('ledger-toggle-btn');
    if (btn) btn.textContent = isOffBalanceMode ? 'Cont. B' : 'Cont. A';
    showToast(`Mostrando Contabilidad ${isOffBalanceMode ? 'B' : 'A'}.`, 'info');
}
const handleSaveMovement = (form) => {
    const btn = form.querySelector('button[type="submit"]'); setButtonLoading(btn, true); clearAllErrors(form.id); let valid = true;
    const tipo = (select('movimiento-tipo-selector')).value;
    const cantidadStr = (select('movimiento-cantidad')).value.trim().replace(/\./g, '').replace(',', '.'); const cantidad = Math.round(parseFloat(cantidadStr) * 100);
    const fecha = (select('movimiento-fecha')).value; const descripcion = (select('movimiento-descripcion')).value.trim();
    if (isNaN(cantidad)) { displayError('movimiento-cantidad', 'Cantidad inválida.'); valid = false; }
    if (!fecha) { displayError('movimiento-fecha', 'La fecha es obligatoria.'); valid = false; }
    if (!descripcion) { displayError('movimiento-descripcion', 'La descripción es obligatoria.'); valid = false; }
    const id = (select('movimiento-id')).value; let mov = id ? db.movimientos.find((m) => m.id === id) : { id: generateId() };
    Object.assign(mov, { tipo, cantidad, fecha: new Date(fecha).toISOString(), descripcion });
    if (tipo === 'traspaso') {
        const origen = (select('movimiento-cuenta-origen')).value, destino = (select('movimiento-cuenta-destino')).value;
        if (origen === destino) { displayError('movimiento-cuenta-destino', 'Las cuentas de origen y destino no pueden ser iguales.'); valid = false; }
        if (!origen || !destino) { showToast('Debes seleccionar cuenta de origen y destino.', 'warning'); valid = false; }
        Object.assign(mov, { cuentaOrigenId: origen, cuentaDestinoId: destino, cuentaId: null, conceptoId: null });
        mov.cantidad = Math.abs(mov.cantidad); // Traspasos siempre positivos
    } else {
        const cuenta = (select('movimiento-cuenta')).value, concepto = (select('movimiento-concepto')).value;
        if (!cuenta) { displayError('movimiento-cuenta', 'Selecciona una cuenta.'); valid = false; }
        if (!concepto) { displayError('movimiento-concepto', 'Selecciona un concepto.'); valid = false; }
        Object.assign(mov, { cuentaId: cuenta, conceptoId: concepto, cuentaOrigenId: null, cuentaDestinoId: null });
    }
    if (!valid) { setButtonLoading(btn, false); return; }
    if (!id) { db.movimientos.push(mov); }
    saveData(btn, () => { hideModal('movimiento-modal'); showToast(id ? 'Movimiento actualizado.' : 'Movimiento añadido.'); buildDescriptionIndex(); renderAll(); });
};
const handleAddConcept = () => { const nombre = (select('new-concepto-nombre')).value.trim(); const icon = (select('new-concepto-icon')).value.trim() || 'label'; if (!nombre) { showToast('El nombre es obligatorio.', 'warning'); return; } db.conceptos.push({ id: generateId(), nombre, icon }); saveData(null, () => { showToast('Concepto añadido.'); (select('add-concepto-form')).reset(); renderConceptosModalList(); populateAllDropdowns(); }); };
const handleAddAccount = () => { const nombre = (select('new-cuenta-nombre')).value.trim(); const tipo = (select('new-cuenta-tipo')).value.trim().toUpperCase(); if (!nombre || !tipo) { showToast('El nombre y el tipo son obligatorios.', 'warning'); return; } db.cuentas.push({ id: generateId(), nombre, tipo, esInversion: false, offBalance: isOffBalanceMode, fechaCreacion: new Date().toISOString() }); saveData(null, () => { showToast('Cuenta añadida.'); (select('add-cuenta-form')).reset(); renderCuentasModalList(); populateAllDropdowns(); renderAll(); }); };
const handleSaveConfig = (btn) => { db.config.skipIntro = (select('config-skip-intro')).checked; localStorage.setItem('skipIntro', String(db.config.skipIntro)); saveData(btn, () => showToast('Configuración guardada.')); };
const handleExportData = (btn) => { setButtonLoading(btn, true); const dataStr = JSON.stringify({ db }, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `cuentas-backup-${new Date().toISOString().slice(0, 10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); setButtonLoading(btn, false); };
const handleExportCsv = (form) => { const formData = new FormData(form); const range = formData.get('csv-export-range'); const fechaInicio = (select('csv-fecha-inicio')).value; const fechaFin = (select('csv-fecha-fin')).value; let movsToExport = [...db.movimientos]; if (range === 'range' && fechaInicio && fechaFin) { const start = new Date(fechaInicio).getTime(); const end = new Date(fechaFin).getTime() + 86399999; movsToExport = movsToExport.filter(m => { const d = new Date(m.fecha).getTime(); return d >= start && d <= end; }); } const data = movsToExport.map(m => ({ fecha: new Date(m.fecha).toLocaleString('es-ES'), tipo: m.tipo, descripcion: m.descripcion, cantidad: m.cantidad / 100, concepto: db.conceptos.find(c => c.id === m.conceptoId)?.nombre || '', cuenta: m.tipo === 'traspaso' ? '' : db.cuentas.find(c => c.id === m.cuentaId)?.nombre || '', cuenta_origen: m.tipo === 'traspaso' ? db.cuentas.find(c => c.id === m.cuentaOrigenId)?.nombre : '', cuenta_destino: m.tipo === 'traspaso' ? db.cuentas.find(c => c.id === m.cuentaDestinoId)?.nombre : '', })); const csv = [Object.keys(data[0]).join(';'), ...data.map(row => Object.values(row).map(v => typeof v === 'string' ? `"${v.replace(/"/g, '""')}"` : v).join(';'))].join('\n'); const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'export_movimientos.csv'; link.click(); URL.revokeObjectURL(link.href); hideModal('export-csv-modal'); };
const handleCopyMovement = (id) => { const mov = db.movimientos.find((m)=>m.id===id); if (mov) { startEditMovement(null); setTimeout(() => { (select('movimiento-tipo-selector')).value=mov.tipo; (select('movimiento-tipo-selector')).dispatchEvent(new Event('change')); (select('movimiento-cantidad')).value = (mov.cantidad/100).toLocaleString('es-ES'); (select('movimiento-descripcion')).value=mov.descripcion; if (mov.tipo === 'traspaso') { (select('movimiento-cuenta-origen')).value = mov.cuentaOrigenId; (select('movimiento-cuenta-destino')).value = mov.cuentaDestinoId; } else { (select('movimiento-cuenta')).value = mov.cuentaId; (select('movimiento-concepto')).value = mov.conceptoId; } showToast('Movimiento copiado al formulario.', 'info'); }, 100); } };
const handleCopyLastMovement = () => { if (db.movimientos.length > 0) { const lastMov = [...db.movimientos].sort((a,b)=>new Date(b.fecha).getTime()-new Date(a.fecha).getTime())[0]; handleCopyMovement(lastMov.id); } else { showToast('No hay movimientos para copiar.', 'info'); } };
const handleDeleteAccount = (btn) => { showConfirmationModal('Esto eliminará tu cuenta y TODOS tus datos de forma PERMANENTE e IRREVERSIBLE. ¿Seguro que quieres continuar?', () => { showConfirmationModal('Confirmación final: ¿realmente quieres borrar tu cuenta y todos tus datos? No se podrá recuperar.', () => { const user = fbAuth.currentUser; if (user) { setButtonLoading(btn, true, 'Eliminando...'); user.delete().then(() => { showToast('Cuenta eliminada permanentemente.', 'danger'); }).catch(error => { setButtonLoading(btn, false); showToast(`Error: ${error.message}`, 'danger'); if (error.code === 'auth/requires-recent-login') { showToast('Por seguridad, vuelve a iniciar sesión antes de eliminar tu cuenta.', 'warning', 5000); fbAuth.signOut(); } }); } }, 'Eliminación Permanente') }, '¡Atención!') };
const robustCsvParse = (csvText) => { const lines = csvText.trim().split('\n'); const delimiter = [',', ';', '\t'].find(d => lines[0].includes(d)) || ','; const result = []; for (const line of lines) { const values = []; let current = ''; let inQuotes = false; for (let i = 0; i < line.length; i++) { const char = line[i]; if (char === '"') { inQuotes = !inQuotes; } else if (char === delimiter && !inQuotes) { values.push(current.trim()); current = ''; } else { current += char; } } values.push(current.trim()); result.push(values); } return result; };
const showExportCsvModal = () => { showModal('export-csv-modal'); };
const showManageInvestmentAccountsModal = () => { let html = `<form id="manage-investment-accounts-form"><p class="form-label" style="margin-bottom: var(--sp-3)">Selecciona las cuentas que quieres tratar como activos de inversión en tu portafolio.</p>`; (db.cuentas || []).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(c => { html += `<div class="form-switch-group modal__list-item" style="padding: var(--sp-2) 0;"><label for="is-investment-${c.id}">${c.nombre}</label><label class="form-switch"><input type="checkbox" id="is-investment-${c.id}" value="${c.id}" ${c.esInversion ? 'checked' : ''}><span class="slider"></span></label></div>`; }); html += `<div class="modal__actions"><button type="submit" class="btn btn--primary btn--full">Guardar</button></div></form>`; showGenericModal('Gestionar Activos de Portafolio', html); };
const handleSaveInvestmentAccounts = (form) => { const btn = form.querySelector('button[type="submit"]'); setButtonLoading(btn, true); const selectedIds = new Set(Array.from(form.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value)); db.cuentas.forEach(c => c.esInversion = selectedIds.has(c.id)); saveData(btn, () => { hideModal('generic-modal'); renderAll(); showToast('Portafolio actualizado.'); }); };
const showValoracionModal = (cuentaId, valoracionId = null) => { hideModal('generic-modal'); const valoracion = valoracionId ? (db.inversiones_historial || []).find(v => v.id === valoracionId) : null; const cuenta = (db.cuentas || []).find(c => c.id === cuentaId); if (!cuenta && !valoracion) { showToast('No se encontró la cuenta.', 'danger'); return; } const targetCuentaId = valoracion ? valoracion.cuentaId : cuentaId; const fecha = valoracion ? new Date(valoracion.fecha) : new Date(); const fechaStr = new Date(fecha.getTime() - (fecha.getTimezoneOffset() * 60000)).toISOString().slice(0, 16); let html = `<form id="form-valoracion" novalidate><input type="hidden" id="valoracion-id" value="${valoracion?.id || ''}"><input type="hidden" id="valoracion-cuenta-id" value="${targetCuentaId}"><div class="form-group"><label for="valoracion-cuenta-nombre" class="form-label">Activo</label><input type="text" id="valoracion-cuenta-nombre" class="form-input" value="${(db.cuentas || []).find(c => c.id === targetCuentaId)?.nombre || ''}" readonly></div><div class="form-group"><label for="valoracion-valor" class="form-label">Valor de Mercado Actual</label><input type="text" id="valoracion-valor" class="form-input input-amount-calculator" readonly required value="${valoracion ? (valoracion.valor / 100).toLocaleString('es-ES') : ''}"><span class="form-error" id="valoracion-valor-error"></span></div><div class="form-group"><label for="valoracion-fecha" class="form-label">Fecha de Valoración</label><input type="datetime-local" id="valoracion-fecha" class="form-input" value="${fechaStr}" required></div><div class="modal__actions"><button type="button" class="btn btn--danger" data-action="delete-valoracion" style="margin-right: auto; ${!valoracionId ? 'display:none;' : ''}">Borrar</button><button type="submit" class="btn btn--primary">Guardar Valoración</button></div></form>`; showGenericModal('Actualizar Valor de Activo', html); };
const handleSaveValoracion = (form) => { const btn = form.querySelector('button[type="submit"]'); setButtonLoading(btn, true); let valid = true; const valorStr = (form.querySelector('#valoracion-valor')).value.trim().replace(/\./g, '').replace(',', '.'); const valor = Math.round(parseFloat(valorStr) * 100); const fecha = (form.querySelector('#valoracion-fecha')).value; const cuentaId = (form.querySelector('#valoracion-cuenta-id')).value; if (isNaN(valor) || valor < 0) { valid = false; displayError('valoracion-valor', 'Valor inválido.'); } if (!valid) { setButtonLoading(btn, false); return; } const id = (form.querySelector('#valoracion-id')).value; if (id) { const v = (db.inversiones_historial || []).find(val => val.id === id); if (v) { v.valor = valor; v.fecha = new Date(fecha).toISOString(); } } else { if (!db.inversiones_historial) db.inversiones_historial = []; db.inversiones_historial.push({ id: generateId(), cuentaId, valor, fecha: new Date(fecha).toISOString() }); } saveData(btn, () => { hideModal('generic-modal'); if (!select('investment-detail-view')?.classList.contains('hidden')) renderInvestmentAccountDetail(cuentaId); else renderInversionesPage(); showToast('Valoración guardada.'); }); };
const showAportacionModal = (cuentaId = null, aportacionId = null) => { hideModal('generic-modal'); const aportacion = aportacionId ? (db.inversion_cashflows || []).find(cf => cf.id === aportacionId) : null; const targetCuentaId = aportacion ? aportacion.cuentaId : cuentaId; const investmentAccounts = (db.cuentas || []).filter(c => c.esInversion); if (investmentAccounts.length === 0) { showToast('No hay cuentas de inversión.', 'info'); return; } const fecha = aportacion ? new Date(aportacion.fecha) : new Date(); const fechaStr = new Date(fecha.getTime() - (fecha.getTimezoneOffset() * 60000)).toISOString().slice(0, 16); let html = `<form id="form-aportacion" novalidate><input type="hidden" id="aportacion-id" value="${aportacion?.id || ''}"><div class="form-group"><label for="aportacion-cuenta-id" class="form-label">Activo</label><select id="aportacion-cuenta-id" class="form-select">${investmentAccounts.map(c => `<option value="${c.id}" ${c.id === targetCuentaId ? 'selected' : ''}>${c.nombre}</option>`).join('')}</select></div><div class="form-group"><label for="aportacion-cantidad" class="form-label">Cantidad (negativo para retirar)</label><input type="text" id="aportacion-cantidad" class="form-input input-amount-calculator" readonly required value="${aportacion ? (aportacion.cantidad / 100).toLocaleString('es-ES') : ''}"><span class="form-error" id="aportacion-cantidad-error"></span></div><div class="form-group"><label for="aportacion-fecha" class="form-label">Fecha</label><input type="datetime-local" id="aportacion-fecha" class="form-input" value="${fechaStr}" required></div><div class="form-group"><label for="aportacion-notas" class="form-label">Notas (opcional)</label><input type="text" id="aportacion-notas" class="form-input" value="${aportacion?.notas || ''}"></div><div class="modal__actions"><button type="button" class="btn btn--danger" data-action="delete-aportacion" style="margin-right: auto; ${!aportacionId ? 'display:none;' : ''}">Borrar</button><button type="submit" class="btn btn--primary">Guardar Flujo</button></div></form>`; showGenericModal(aportacionId ? 'Editar Flujo de Capital' : 'Aportar o Retirar Capital', html); };
const handleSaveAportacion = (form) => { const btn = form.querySelector('button[type="submit"]'); setButtonLoading(btn, true); let valid = true; const cantidadStr = (form.querySelector('#aportacion-cantidad')).value.trim().replace(/\./g, '').replace(',', '.'); const cantidad = Math.round(parseFloat(cantidadStr) * 100); const fecha = (form.querySelector('#aportacion-fecha')).value; const cuentaId = (form.querySelector('#aportacion-cuenta-id')).value; const notas = (form.querySelector('#aportacion-notas')).value.trim(); if (isNaN(cantidad)) { valid = false; displayError('aportacion-cantidad', 'Cantidad inválida.'); } if (!valid) { setButtonLoading(btn, false); return; } const id = (form.querySelector('#aportacion-id')).value; if (id) { const cf = (db.inversion_cashflows || []).find(c => c.id === id); if (cf) { Object.assign(cf, { cuentaId, cantidad, fecha: new Date(fecha).toISOString(), notas }); } } else { if (!db.inversion_cashflows) db.inversion_cashflows = []; db.inversion_cashflows.push({ id: generateId(), cuentaId, cantidad, fecha: new Date(fecha).toISOString(), notas }); } saveData(btn, () => { hideModal('generic-modal'); if (!select('investment-detail-view')?.classList.contains('hidden')) renderInvestmentAccountDetail(cuentaId); else renderInversionesPage(); showToast('Flujo de capital guardado.'); }); };

// Initialize the app
document.addEventListener('DOMContentLoaded', initApp);

</script>
</body>
</html>