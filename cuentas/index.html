<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Cuentas aiDANaI</title>
    <link rel="preload" href="aiDANaI-Cuentas.jpg" as="image">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js" as="script">
    <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Cuentas aiDANaI&quot;,&quot;short_name&quot;:&quot;aiDANaI&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#000000&quot;,&quot;theme_color&quot;:&quot;#007AFF&quot;,&quot;description&quot;:&quot;Gestor de finanzas personales y compartidas.&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3Eüí∞%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3Eüí∞%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    <meta name="theme-color" content="#007AFF"/>
    <style id="critical-css">:root{--primary-color:#007AFF;--secondary-color:#8A8A8E;--success-color:#30D158;--danger-color:#FF453A;--warning-color:#FF9F0A;--dani-color:#0A84FF;--norma-color:#FF375F;--comun-color:#30D158;--info-color:#5E5CE6;--font-family-sans:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;--border-radius:8px;--shadow-sm:0 1px 3px rgba(0,0,0,.05);--spacing-unit:8px;--nav-height:48px}[data-theme=dark]{--bg-color:#000;--text-color:#EAEAEB;--card-bg:#1C1C1E;--border-color:#38383A;--input-bg:#2C2C2E;--input-text:#EAEAEB;--secondary-color:#8D8D92}[data-theme=light]{--bg-color:#F2F2F7;--text-color:#1D1D1F;--card-bg:#fff;--border-color:#E5E5EA;--input-bg:#EFEFF4;--input-text:#1D1D1F}html,body{height:100%;margin:0;overscroll-behavior-y:contain;font-family:var(--font-family-sans);-webkit-font-smoothing:antialiased;line-height:1.3;font-size:14px;overflow:hidden}body{background-color:var(--bg-color);color:var(--text-color);font-size:clamp(.8rem,2.2vw,.85rem);display:flex;flex-direction:column;transition:background-color .3s,color .3s}#app-container{display:none;flex-direction:column;height:100%}header{background-color:var(--card-bg);padding:.4rem var(--spacing-unit);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;border-bottom:1px solid var(--border-color);z-index:10;height:50px;box-sizing:border-box}header h1{font-size:clamp(.95rem,2.8vw,1.05rem);margin:0;font-weight:700}.header-actions button{background:0 0;border:0;color:var(--primary-color);font-size:1.2rem;cursor:pointer;padding:.2rem;margin-left:.2rem;-webkit-tap-highlight-color:transparent;min-width:44px;min-height:44px;border-radius:50%;transition:background-color .2s,transform .1s}main{flex-grow:1;overflow-y:auto;padding:var(--spacing-unit);padding-bottom:calc(var(--nav-height) + var(--spacing-unit));-webkit-overflow-scrolling:touch}nav{display:flex;justify-content:space-around;border-top:1px solid var(--border-color);background-color:var(--card-bg);padding:.2rem;flex-shrink:0;box-shadow:0 -2px 5px rgba(0,0,0,.05);z-index:10;user-select:none;position:fixed;bottom:0;width:100%;left:0;box-sizing:border-box;height:var(--nav-height)}nav button{background:0 0;border:0;color:var(--secondary-color);cursor:pointer;padding:.2rem;font-size:clamp(.6rem,1.7vw,.65rem);display:flex;flex-direction:column;align-items:center;justify-content:center;flex-grow:1;flex-basis:0;text-align:center;transition:color .2s,background-color .2s;-webkit-tap-highlight-color:transparent;min-height:44px;border-radius:var(--border-radius)}.page{display:none}.page.active{display:block;animation:fadeIn .3s ease-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}#splash-screen{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#000;z-index:1050;display:flex;justify-content:center;align-items:center;transition:opacity .5s ease-out}#splash-image{max-width:80%;height:auto;border-radius:12px;animation:splash-amplify-explode 3s cubic-bezier(.25,.46,.45,.94) forwards}@keyframes splash-amplify-explode{0%{transform:scale(.5);opacity:0}25%{transform:scale(1);opacity:1}75%{transform:scale(1.2);opacity:1;filter:blur(0)}100%{transform:scale(3);opacity:0;filter:blur(15px)}}#login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--bg-color);color:var(--text-color);z-index:1040;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:var(--spacing-unit);box-sizing:border-box;opacity:0;transition:opacity .5s}#login-screen.visible{opacity:1}.login-card{background-color:var(--card-bg);padding:calc(var(--spacing-unit)*1.5);border-radius:var(--border-radius);box-shadow:var(--shadow-sm);width:100%;max-width:360px;text-align:center}.login-card h2{font-size:1.3rem;margin-bottom:var(--spacing-unit)}button{padding:.4rem .6rem;border:0;border-radius:var(--border-radius);cursor:pointer;font-weight:600;font-size:clamp(.8rem,2.2vw,.85rem);-webkit-tap-highlight-color:transparent;transition:background-color .2s,transform .1s,box-shadow .2s;min-height:44px}.btn-primary{background-color:var(--primary-color);color:#fff}.btn-secondary{background-color:var(--secondary-color);color:#fff}.form-group{margin-bottom:calc(var(--spacing-unit)*.8)}input,select{width:100%;padding:.4rem .5rem;border:1px solid var(--border-color);border-radius:var(--border-radius);box-sizing:border-box;background-color:var(--input-bg);color:var(--input-text);font-size:clamp(.8rem,2.2vw,.85rem);-webkit-appearance:none;appearance:none;transition:border-color .2s,box-shadow .2s;height:40px}.error-message{color:var(--danger-color);font-size:clamp(.6rem,1.7vw,.65rem);margin-top:2px;min-height:14px;display:block}.hidden{display:none!important}</style>
    <template id="deferred-css-template"><style>
#quote-splash-screen{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#000;color:#fff;z-index:1045;display:flex;justify-content:center;align-items:center;text-align:center;padding:20px;box-sizing:border-box;opacity:0;transition:opacity .5s ease-out}
#quote-content{max-width:90vw;font-family:var(--font-family-sans);font-style:normal;}
#quote-content .quote-text{margin-bottom:20px;font-size:clamp(1.5rem, 8vw, 6rem);line-height:1.3;font-weight:700;}
#quote-content .quote-author{font-size:clamp(1rem, 3vw, 2rem);font-weight:400;color:#bbb;margin-top:40px}
#login-error{color:var(--danger-color);font-size:clamp(.65rem,1.8vw,.7rem);margin-top:8px;min-height:18px}#toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background-color:rgba(20,20,20,.85);color:#fff;padding:8px 16px;border-radius:16px;z-index:1060;opacity:0;transition:opacity .3s,bottom .3s;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);box-shadow:0 4px 15px rgba(0,0,0,.2);pointer-events:none}.card{background-color:var(--card-bg);border-radius:var(--border-radius);margin-bottom:var(--spacing-unit);box-shadow:var(--shadow-sm)}.card>header{padding:calc(var(--spacing-unit)*.7) var(--spacing-unit);border-bottom:1px solid var(--border-color)}.card>header h2,.card>header h3{margin:0;font-weight:600;font-size:clamp(.8rem,2.4vw,.85rem)}.card-body{padding:var(--spacing-unit)}.card-body.no-padding{padding:0}.list-item{display:flex;justify-content:space-between;align-items:center;padding:calc(var(--spacing-unit)*.7) var(--spacing-unit);font-size:clamp(.75rem,2.1vw,.8rem);border-bottom:1px solid var(--border-color)}.list-item:last-child{border-bottom:0}.list-item-info{flex-grow:1;display:flex;flex-direction:column;gap:1px}.list-item-title{font-weight:500}.list-item-meta{font-size:clamp(.6rem,1.7vw,.65rem);color:var(--secondary-color)}.list-item-amount strong{font-size:clamp(.85rem,2.6vw,.95rem);font-weight:600}.owner-Dani{color:var(--dani-color)}.owner-Norma{color:var(--norma-color)}.owner-Comun{color:var(--comun-color)}.list-item.owner-Dani,.list-item.owner-Dani strong,summary.owner-Dani strong{color:var(--dani-color)}.list-item.owner-Norma,.list-item.owner-Norma strong,summary.owner-Norma strong{color:var(--norma-color)}.list-item.owner-Com√∫n,.list-item.owner-Com√∫n strong{color:var(--comun-color)}.list-item.owner-Dani .list-item-meta,.list-item.owner-Norma .list-item-meta,.list-item.owner-Com√∫n .list-item-meta{color:inherit;opacity:.8}details.accordion-item{margin-bottom:calc(var(--spacing-unit)*.5);border:1px solid var(--border-color);border-radius:var(--border-radius);overflow:hidden;background-color:var(--card-bg)}details.accordion-item summary{cursor:pointer;padding:var(--spacing-unit);font-weight:600;display:flex;justify-content:space-between;align-items:center;list-style:none;-webkit-tap-highlight-color:transparent;min-height:44px}details.accordion-item summary::-webkit-details-marker{display:none}details.accordion-item summary::after{content:'‚Ä∫';font-size:22px;transform:rotate(90deg);transition:transform .2s ease-in-out;color:var(--secondary-color);padding-left:6px}details.accordion-item[open] summary{border-bottom:1px solid var(--border-color)}details.accordion-item[open] summary::after{transform:rotate(-90deg)}.text-positive{color:var(--success-color)}.text-negative{color:var(--danger-color)}.form-group label{display:block;margin-bottom:3px;font-weight:500;font-size:clamp(.6rem,1.7vw,.65rem);color:var(--secondary-color)}input[type=checkbox]{width:auto;height:auto;-webkit-appearance:checkbox;appearance:checkbox;min-width:16px;min-height:16px;margin-right:6px}input:focus,select:focus{outline:0;border-color:var(--primary-color);box-shadow:0 0 0 2px rgba(0,122,255,.25)}select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238E8E93'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;background-size:14px;padding-right:30px}button:active{transform:scale(.98)}.btn-danger{background-color:var(--danger-color);color:#fff}.btn-warning{background-color:var(--warning-color);color:#fff}.btn-full{width:100%;margin-top:6px}.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:calc(var(--spacing-unit)*.75)}.form-group-with-action{display:flex;align-items:flex-end;gap:6px}.form-group-with-action .form-group{flex-grow:1;margin-bottom:0}
.manage-item-btn{flex-shrink:0;min-width:44px;height:40px;padding:0 10px;margin-bottom:0;background-color:transparent;border:1px solid var(--border-color);border-radius:var(--border-radius);color:var(--secondary-color);font-size:18px;line-height:1;display:flex;align-items:center;justify-content:center}
button.btn-loading{position:relative;pointer-events:none;opacity:.8;display:flex;align-items:center;justify-content:center}.spinner{display:inline-block;width:1em;height:1em;border:.15em solid currentColor;border-radius:50%;border-top-color:transparent;animation:spin .8s linear infinite;vertical-align:middle;margin-left:.5em;flex-shrink:0}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}input.is-invalid,select.is-invalid{border-color:var(--danger-color)!important;box-shadow:0 0 0 2px rgba(255,69,58,.25)!important}#kpi-container{display:flex;background-color:var(--card-bg);border-radius:var(--border-radius);box-shadow:var(--shadow-sm);margin-bottom:var(--spacing-unit);padding:4px;gap:4px}.kpi-item{flex:1;text-align:center;padding:2px 4px}.kpi-item h4{font-size:clamp(.6rem,1.7vw,.65rem);margin:0 0 2px;color:var(--secondary-color);font-weight:500}.kpi-item strong{font-size:clamp(.85rem,2.8vw,.95rem);font-weight:700}
.movimiento-item-wrapper{position:relative;overflow:hidden;background-color:var(--card-bg);border-bottom:1px solid var(--border-color)}
#movimientos-list .movimiento-item-wrapper:last-child{border-bottom:0}
.movimiento-item{display:flex;align-items:center;padding:6px var(--spacing-unit);background-color:var(--card-bg);transition:transform .3s ease-out;position:relative;z-index:2;user-select:none;line-height:1.2}
.swipe-actions{position:absolute;top:0;right:0;height:100%;display:flex;align-items:center;z-index:1}
.swipe-actions button{height:100%;border:0;color:#fff;font-size:18px;padding:0 20px;min-width:50px;border-radius:0}
.swipe-actions .edit-movimiento{background-color:var(--warning-color)}.swipe-actions .delete-movimiento{background-color:var(--danger-color)}
.movimiento-item.swipe-open{transform:translateX(-140px)}
.movimiento-details{flex-grow:1;margin-right:6px}.movimiento-desc{font-weight:500;margin-bottom:1px;font-size:0.9em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.movimiento-meta{font-size:clamp(.6rem,1.7vw,.65rem);color:var(--secondary-color);line-height:1.2}
.movimiento-actions-container{display:flex;align-items:center;gap:4px;min-width:85px;justify-content:flex-end}
.movimiento-amount{font-weight:600;text-align:right;font-size:.9rem}
.options-btn{background:0 0;border:0;color:var(--secondary-color);cursor:pointer;padding:8px;border-radius:50%;-webkit-tap-highlight-color:transparent;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}.options-btn:focus,.options-btn:hover{background-color:rgba(128,128,128,.1)}
#filtered-movements-summary{padding:var(--spacing-unit);text-align:right;font-size:clamp(.85rem,2.6vw,.9rem);font-weight:700;background-color:var(--card-bg);border-top:1px solid var(--border-color)}#filtered-movements-summary span{font-size:clamp(.6rem,1.7vw,.65rem);font-weight:400;color:var(--secondary-color);display:block}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:1050;display:flex;justify-content:center;align-items:flex-start;padding:var(--spacing-unit);box-sizing:border-box;animation:fadeIn .3s ease-out;padding-top:5vh}.modal-content{background-color:var(--card-bg);border-radius:var(--border-radius);padding:var(--spacing-unit);width:100%;max-width:480px;max-height:85vh;display:flex;flex-direction:column;animation:slideInUp .3s ease-out}.modal-content .modal-body{overflow-y:auto;flex-grow:1;padding-right:4px}.modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:calc(var(--spacing-unit)*.5);margin-bottom:var(--spacing-unit)}.modal-header h4{margin:0;font-size:clamp(.9rem,2.6vw,1rem);font-weight:700}.modal-header .close-btn{font-size:1.5rem;background:0 0;border:0;color:var(--secondary-color);cursor:pointer;padding:6px;-webkit-tap-highlight-color:transparent;min-width:44px;min-height:44px;border-radius:50%}.modal-list-item{display:flex;justify-content:space-between;align-items:center;padding:5px 2px;border-bottom:1px solid var(--border-color)}.modal-list-item:last-child{border-bottom:0}.modal-list-item .actions{display:flex;gap:4px}.modal-list-item button{padding:2px 5px;font-size:clamp(.6rem,1.7vw,.65rem);min-height:30px}#filter-account-types-pills{display:flex;flex-wrap:wrap;gap:6px}.filter-pill{background-color:var(--input-bg);border:1px solid var(--border-color);color:var(--text-color);padding:4px 10px;font-size:clamp(.6rem,1.7vw,.65rem);border-radius:16px;transition:background-color .2s,color .2s,border-color .2s;-webkit-tap-highlight-color:transparent}.filter-pill.active{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color);font-weight:600}
.ai-disclaimer{background-color:rgba(255,159,10,.1);border:1px solid var(--warning-color);padding:10px;border-radius:var(--border-radius);margin-bottom:16px;font-size:clamp(.65rem,1.8vw,.7rem)}.ai-disclaimer label{display:inline;font-weight:400;color:var(--text-color)}#ai-advice-content h5{font-size:clamp(.9rem,2.6vw,1rem);margin:16px 0 8px;color:var(--primary-color)}#ai-advice-content p,#ai-advice-content ul{font-size:clamp(.7rem,2vw,.75rem);line-height:1.5;margin-bottom:12px;margin-top:0;} #ai-advice-content ul { padding-left: 20px; } #ai-advice-content li { margin-bottom: 6px; } .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; } .summary-item { background: var(--input-bg); padding: 8px; border-radius: var(--border-radius); text-align: center; } .summary-item h6 { margin: 0 0 4px; font-size: clamp(.6rem,1.7vw,.65rem); color: var(--secondary-color); font-weight: 500; } .summary-item strong { font-size: clamp(.85rem,2.6vw,.95rem); }
nav button .icon{font-size:1.1rem;margin-bottom:1px}nav button.active{color:var(--primary-color);background-color:rgba(0,122,255,.1)}
.action-sheet-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1100;display:flex;justify-content:center;align-items:flex-end;animation:fadeIn .2s ease-out}
.action-sheet-content{background-color:var(--card-bg);width:100%;max-width:480px;border-top-left-radius:12px;border-top-right-radius:12px;padding:8px;box-sizing:border-box;animation:slideInUp .3s ease-out}
.action-sheet-header{padding:8px;text-align:center;font-weight:600;color:var(--secondary-color);font-size:.8rem;border-bottom:1px solid var(--border-color);margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.action-sheet-btn{display:block;width:100%;padding:14px;font-size:1rem;background-color:transparent;border:0;border-radius:var(--border-radius);text-align:center;cursor:pointer;color:var(--primary-color);-webkit-tap-highlight-color:transparent}
.action-sheet-btn.text-negative{color:var(--danger-color)}.action-sheet-btn.cancel-btn{font-weight:700;margin-top:8px}.action-sheet-btn:hover{background-color:rgba(128,128,128,.1)}
@keyframes slideInUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}@media (min-width:600px){:root{--spacing-unit:10px}main{padding:var(--spacing-unit) calc(var(--spacing-unit)*1.5)}}@media (min-width:1024px){:root{--spacing-unit:12px}body{align-items:center}#app-container{max-width:768px;width:100%;border-radius:var(--border-radius);overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2)}}
#help-modal .modal-body h3 { font-size: clamp(1rem, 2.8vw, 1.1rem); color: var(--primary-color); margin-top: 1.5em; margin-bottom: 0.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 4px;} #help-modal .modal-body p, #help-modal .modal-body li { line-height: 1.6; font-size: clamp(.75rem, 2.1vw, .8rem); } #help-modal .modal-body ul { padding-left: 20px; } #help-modal .modal-body strong { color: var(--text-color); font-weight: 600; } #help-modal .modal-body .special-feature { color: var(--primary-color); font-weight: 700; }
.budget-item{background-color:var(--input-bg);padding:10px;border-radius:var(--border-radius);margin-bottom:10px}.budget-info{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}.budget-info-text strong{display:block;font-size:clamp(.8rem,2.2vw,.85rem);font-weight:600;margin-bottom:2px}.budget-info-text span{color:var(--secondary-color);font-size:clamp(.6rem,1.7vw,.65rem)}.budget-progress{width:100%;height:10px;border-radius:5px;-webkit-appearance:none;appearance:none;overflow:hidden}.budget-progress::-webkit-progress-bar{background-color:rgba(120,120,128,.2)}.budget-progress.progress-ok::-webkit-progress-value{background-color:var(--success-color)}.budget-progress.progress-warning::-webkit-progress-value{background-color:var(--warning-color)}.budget-progress.progress-danger::-webkit-progress-value{background-color:var(--danger-color)}.budget-progress.progress-ok::-moz-progress-bar{background-color:var(--success-color)}.budget-progress.progress-warning::-moz-progress-bar{background-color:var(--warning-color)}.budget-progress.progress-danger::-moz-progress-bar{background-color:var(--danger-color)}
</style></template>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>
<div id="splash-screen" role="status" aria-label="Cargando aplicaci√≥n"><img id="splash-image" src="aiDANaI-Cuentas.jpg" alt="Logo aiDANaI"></div>
<div id="quote-splash-screen" role="status" class="hidden"><div id="quote-content"><p class="quote-text"></p><p class="quote-author"></p></div></div>
<div id="login-screen" class="hidden" role="dialog" aria-modal="true" aria-labelledby="login-title">
    <div class="login-card">
        <h2 id="login-title">üí∞ Cuentas aiDANaI</h2>
        <form id="login-form" novalidate>
            <div class="form-group"><input type="email" id="login-email" placeholder="Correo electr√≥nico" required autocomplete="email" autocapitalize="none" aria-describedby="login-email-error"><span class="error-message" id="login-email-error" role="alert"></span></div>
            <div class="form-group"><input type="password" id="login-password" placeholder="Contrase√±a" required autocomplete="current-password" aria-describedby="login-password-error"><span class="error-message" id="login-password-error" role="alert"></span></div>
            <div class="form-grid"><button type="button" id="login-btn" class="btn-primary">Iniciar Sesi√≥n</button><button type="button" id="register-btn" class="btn-secondary">Registrarse</button></div>
            <p id="login-error" role="alert"></p>
        </form>
    </div>
</div>
<div id="app-container">
    <header role="banner">
        <h1 id="header-title"></h1>
        <div class="header-actions">
            <button id="ai-advice-btn" aria-label="Abrir Asesor IA">üß†</button>
            <button id="help-btn" aria-label="Abrir Ayuda">üí°</button>
            <button id="theme-toggle" aria-label="Cambiar Tema" role="switch" aria-checked="false">‚òÄÔ∏è</button>
            <button id="logout-btn" aria-label="Cerrar Sesi√≥n">‚û°Ô∏è</button>
        </div>
    </header>
    <main id="main-content">
        <article id="panel-control-page" class="page" role="tabpanel" aria-labelledby="nav-panel-control">
            <section class="card"><div class="card-body"><div class="form-group"><label for="filter-periodo">Periodo</label><select id="filter-periodo"><option value="mes-actual">Mes Actual</option><option value="ano-actual">A√±o Actual</option><option value="siempre">Siempre</option><option value="custom">Personalizado</option></select></div><div id="custom-date-filters" class="hidden form-grid"><div class="form-group"><label for="filter-fecha-inicio">Desde</label><input type="date" id="filter-fecha-inicio"></div><div class="form-group"><label for="filter-fecha-fin">Hasta</label><input type="date" id="filter-fecha-fin"></div></div><div class="form-grid"><div class="form-group"><label for="filter-beneficiario">Propietario</label><select id="filter-beneficiario"></select></div><div class="form-group"><label for="filter-cuenta">Cuenta</label><select id="filter-cuenta"></select></div></div><div class="form-group"><label for="filter-concepto">Concepto</label><select id="filter-concepto"></select></div><button id="apply-filters-btn" class="btn-primary btn-full">Aplicar Filtros</button></div></section>
            <section id="kpi-container" aria-label="Indicadores clave de rendimiento"></section>
            <section class="card" aria-labelledby="concepto-totals-title"><header><h2 id="concepto-totals-title">Totales por Concepto</h2></header><div class="card-body no-padding" id="concepto-totals-list"></div></section>
            <section class="card" aria-labelledby="filtered-movements-title"><header><h2 id="filtered-movements-title">Detalle de Movimientos</h2></header><div class="card-body no-padding" id="filtered-movements-list"></div><div id="filtered-movements-summary"></div></section>
        </article>
        <article id="movimientos-page" class="page" role="tabpanel" aria-labelledby="nav-movimientos">
            <section class="card" aria-labelledby="form-movimiento-title"><header><h2 id="form-movimiento-title">A√±adir / Editar Movimiento</h2></header><div class="card-body"><form id="form-movimiento" novalidate><input type="hidden" id="movimiento-id"><div class="form-group"><label for="movimiento-tipo-selector">Tipo</label><select id="movimiento-tipo-selector"><option value="movimiento">Movimiento</option><option value="traspaso">Traspaso</option></select></div><div class="form-grid"><div class="form-group"><label for="movimiento-cantidad">Cantidad (neg=gasto)</label><input type="text" id="movimiento-cantidad" inputmode="decimal" required placeholder="Ej: 50,25"><span class="error-message" id="movimiento-cantidad-error"></span></div><div class="form-group"><label for="movimiento-fecha">Fecha y Hora</label><input type="datetime-local" id="movimiento-fecha" required><span class="error-message" id="movimiento-fecha-error"></span></div></div><div class="form-group"><label for="movimiento-descripcion">Descripci√≥n</label><input type="text" id="movimiento-descripcion" required placeholder="Ej: Compra semanal"><span class="error-message" id="movimiento-descripcion-error"></span></div><div id="movimiento-fields"><div class="form-group-with-action"><div class="form-group"><label for="movimiento-concepto">Concepto</label><select id="movimiento-concepto" required></select><span class="error-message" id="movimiento-concepto-error"></span></div>
            <button type="button" class="manage-item-btn" id="manage-conceptos-btn" aria-label="Gestionar Conceptos"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" role="presentation"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg></button></div><div class="form-group-with-action"><div class="form-group"><label for="movimiento-cuenta">Cuenta</label><select id="movimiento-cuenta" required></select><span class="error-message" id="movimiento-cuenta-error"></span></div>
            <button type="button" class="manage-item-btn" id="manage-cuentas-btn" aria-label="Gestionar Cuentas"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" role="presentation"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg></button></div><div class="form-group"><label for="movimiento-beneficiario">Propietario</label><select id="movimiento-beneficiario" required></select><span class="error-message" id="movimiento-beneficiario-error"></span></div></div><div id="traspaso-fields" class="hidden form-grid"><div class="form-group"><label for="movimiento-cuenta-origen">Origen</label><select id="movimiento-cuenta-origen" required></select><span class="error-message" id="movimiento-cuenta-origen-error"></span></div><div class="form-group"><label for="movimiento-cuenta-destino">Destino</label><select id="movimiento-cuenta-destino" required></select><span class="error-message" id="movimiento-cuenta-destino-error"></span></div></div><button type="submit" class="btn-primary btn-full" id="save-movimiento-btn">Guardar Movimiento</button><button type="button" id="cancel-edit-movimiento" class="btn-secondary btn-full hidden">Cancelar Edici√≥n</button></form></div></section>
            <section class="card" aria-labelledby="historial-title"><header><h2 id="historial-title">Historial de Movimientos</h2></header><div class="card-body"><div class="form-group" style="margin-bottom:0"><input type="search" id="search-movimientos" placeholder="Buscar movimientos..." inputmode="search"></div></div><div class="card-body no-padding" id="movimientos-list"></div></section>
        </article>
        <article id="cuentas-page" class="page" role="tabpanel" aria-labelledby="nav-cuentas">
            <section class="card"><header><h2>Cuentas L√≠quidas por Propietario</h2></header><div class="card-body"><div class="form-group"><label>Filtrar por Tipo de Cuenta:</label><div id="filter-account-types-pills" style="margin-top:6px"></div></div><div id="resumen-propietario-container"></div></div></section>
            <section class="card"><header><h2>Cuentas L√≠quidas por Tipo</h2></header><div class="card-body no-padding" id="cuentas-accordion-container"></div></section>
        </article>
        <article id="presupuestos-page" class="page" role="tabpanel" aria-labelledby="nav-presupuestos">
            <section class="card"><header><h2>Nuevo Presupuesto</h2></header><div class="card-body"><form id="form-presupuesto" novalidate><div class="form-grid"><div class="form-group"><label for="presupuesto-ano">A√±o</label><input type="number" id="presupuesto-ano" required placeholder="2024" min="2000" max="2100"><span class="error-message" id="presupuesto-ano-error"></span></div><div class="form-group"><label for="presupuesto-beneficiario-p">Propietario</label><select id="presupuesto-beneficiario-p" required></select><span class="error-message" id="presupuesto-beneficiario-p-error"></span></div></div><div class="form-group"><label for="presupuesto-concepto">Concepto</label><select id="presupuesto-concepto" required></select><span class="error-message" id="presupuesto-concepto-error"></span></div><div class="form-group"><label for="presupuesto-cantidad">L√≠mite Gasto Anual</label><input type="text" id="presupuesto-cantidad" inputmode="decimal" required placeholder="1200,00"><span class="error-message" id="presupuesto-cantidad-error"></span></div><button type="submit" class="btn-primary btn-full" id="save-presupuesto-btn">Guardar Presupuesto</button></form></div></section>
            <section class="card"><header><h2>Seguimiento Anual</h2></header><div class="card-body no-padding" id="presupuestos-list"></div></section>
        </article>
        <article id="configuracion-page" class="page" role="tabpanel" aria-labelledby="nav-configuracion">
            <section class="card"><header><h2>Configuraci√≥n General</h2></header><div class="card-body"><div class="form-group"><label for="config-beneficiarios">Propietarios (separados por coma)</label><input type="text" id="config-beneficiarios" placeholder="Dani, Norma, Com√∫n"><span class="error-message" id="config-beneficiarios-error"></span></div><button id="save-config-btn" class="btn-primary btn-full">Guardar Configuraci√≥n</button></div></section>
            <section class="card"><header><h2>Gesti√≥n de Datos</h2></header><div class="card-body"><p style="font-size:var(--font-size-sm);margin-top:0">Importar reemplazar√° todos los datos actuales.</p><div style="display:flex;gap:8px;margin-top:8px"><button id="export-data-btn" class="btn-secondary" style="flex:1">Exportar</button><button id="import-data-btn" class="btn-warning" style="flex:1">Importar</button><input type="file" id="import-file-input" class="hidden" accept=".json"></div><button id="clear-all-data-btn" class="btn-danger btn-full">Borrar Todos los Datos</button></div></section>
        </article>
    </main>
    <nav id="bottom-nav">
        <button id="nav-panel-control" class="nav-btn active" data-page="panel-control-page" data-title="Panel" aria-current="page"><span class="icon">üìä</span><span class="label">Panel</span></button>
        <button id="nav-movimientos" class="nav-btn" data-page="movimientos-page" data-title="Movimientos"><span class="icon">‚ÜîÔ∏è</span><span class="label">Movim.</span></button>
        <button id="nav-cuentas" class="nav-btn" data-page="cuentas-page" data-title="Cuentas"><span class="icon">üè¶</span><span class="label">Cuentas</span></button>
        <button id="nav-presupuestos" class="nav-btn" data-page="presupuestos-page" data-title="Presupuestos"><span class="icon">üéØ</span><span class="label">Presup.</span></button>
        <button id="nav-configuracion" class="nav-btn" data-page="configuracion-page" data-title="Config."><span class="icon">‚öôÔ∏è</span><span class="label">Config.</span></button>
    </nav>
</div>
<div id="toast" role="status" aria-live="polite"></div>
<script defer>
window.addEventListener('DOMContentLoaded', () => { const template = document.getElementById('deferred-css-template'); if (template) { const style = document.createElement('style'); style.textContent = template.content.firstElementChild.textContent; document.head.appendChild(style); template.remove(); } });

document.addEventListener('DOMContentLoaded', () => {
    // NOTA IMPORTANTE DEL DESARROLLADOR: No olvides configurar las REGLAS DE SEGURIDAD en la consola de Firebase.
    // La aplicaci√≥n cliente NO ES SEGURA sin ellas. Ve a Firestore -> Reglas y establece:
    // match /users/{userId} { allow read, write: if request.auth.uid == userId; }

    const quotesData = [ { "cita": "Los inversores conservadores duermen bien.", "autor": "Benjamin Graham" }, { "cita": "Nunca asciendas a alguien que no ha cometido errores, porque si lo haces, est√°s ascendiendo a alguien que nunca ha hecho nada.", "autor": "Benjamin Graham" }, { "cita": "Si se han hecho los deberes antes de comprar una acci√≥n, el momento de venderla es: normalmente, nunca.", "autor": "Benjamin Graham" }, { "cita": "Mientras que el entusiasmo es necesario para conseguir grandes logros en cualquier lugar, en Wall Street suele conducir al desastre.", "autor": "John Templeton" }, { "cita": "Sin tener fe en el futuro, nadie invertir√≠a. Para ser inversor, debes creer en un ma√±ana mejor.", "autor": "John Templeton" }, { "cita": "Las cuatro palabras m√°s caras de nuestro lenguaje son: 'Esta vez es diferente'.", "autor": "John Templeton" }, { "cita": "C√©ntrate en el valor porque la mayor√≠a de los inversores se fijan en perspectivas y tendencias.", "autor": "Peter Lynch" }, { "cita": "El √©xito es un proceso de b√∫squeda continua de respuestas a nuevas preguntas.", "autor": "Peter Lynch" }, { "cita": "Conoce en lo que inviertes, y por qu√©.", "autor": "Peter Lynch" }, { "cita": "Cuando vendes en momentos de desesperaci√≥n, siempre vendes barato.", "autor": "Peter Lynch" }, { "cita": "Una persona que posee una propiedad y tiene una participaci√≥n en la empresa probablemente trabajar√° m√°s duro, se sentir√° m√°s feliz y har√° un mejor trabajo que otra que no tiene nada.", "autor": "Peter Lynch" }, { "cita": "El riesgo viene de no saber lo que se est√° haciendo.", "autor": "Warren Buffett" }, { "cita": "Cuesta 20 a√±os construir una reputaci√≥n y 5 minutos destruirla. Si piensas sobre ello, har√°s las cosas de manera diferente.", "autor": "Warren Buffett" }, { "cita": "En el mundo de los negocios, el espejo retrovisor est√° siempre m√°s claro que el parabrisas.", "autor": "Warren Buffett" }, { "cita": "La inversi√≥n m√°s importante que puedes hacer es en uno mismo.", "autor": "Warren Buffett" }, { "cita": "S√© temeroso cuando otros sean avariciosos, s√© avaricioso cuando otros sean temerosos.", "autor": "Warren Buffett" }, { "cita": "S√© consciente de lo que no sabes. Si√©ntete a gusto entendiendo tus errores y debilidades.", "autor": "Charlie Munger" }, { "cita": "Para hacer dinero en los mercados, tienes que pensar diferente y ser humilde.", "autor": "Charlie Munger" }, { "cita": "El mayor error que los inversores hacen es creer que lo que ha pasado en el pasado reciente probablemente persistir√°.", "autor": "Charlie Munger" }, { "cita": "El principal problema del inversor, e incluso su peor enemigo, es probablemente √©l mismo", "autor": "Benjamin Graham" }, { "cita": "Las personas que no pueden controlar sus emociones no son aptas para obtener beneficios mediante la inversi√≥n", "autor": "Benjamin Graham" }, { "cita": "Trato de comprar acciones en los negocios que son tan maravillosos que un tonto podr√≠a manejarlos. Tarde o temprano uno lo har√°", "autor": "Warren Buffett" }, { "cita": "Un inversor deber√≠a actuar como si tuviera una tarjeta con s√≥lo 20 decisiones (de compra) para tomar a lo largo de su vida", "autor": "Warren Buffett" }, { "cita": "Regla n√∫mero 1: nunca pierdas dinero. Regla n√∫mero 2: nunca olvides la regla n√∫mero 1", "autor": "Warren Buffett" }, { "cita": "Se gana dinero descontando lo obvio y apostando a lo inesperado", "autor": "George Soros" }, { "cita": "El problema no es lo que uno no sabe, sino lo que uno cree que sabe estando equivocado", "autor": "George Soros" }, { "cita": "Si invertir es entretenido, si te est√°s divirtiendo, probablemente no est√©s ganando dinero. Las buenas inversiones son aburridas", "autor": "George Soros" }, { "cita": "Se puede perder dinero a corto plazo, pero necesitas del largo plazo para ganar dinero", "autor": "Peter Lynch" }, { "cita": "La mejor empresa para comprar puede ser alguna que ya tienes en cartera", "autor": "Peter Lynch" }, { "cita": "La clave para ganar dinero con las acciones es no tenerles miedo", "autor": "Peter Lynch" }, { "cita": "Los mercados alcistas nacen en el pesimismo, crecen en el escepticismo, maduran en el optimismo y mueren en la euforia", "autor": "John Templeton" }, { "cita": "El momento de m√°ximo pesimismo es el mejor para comprar y el momento de m√°ximo optimismo es el mejor para vender", "autor": "John Templeton" }, { "cita": "Un inversor que tiene todas las respuestas ni siquiera entiende las preguntas", "autor": "John Templeton" }, { "cita": "La inversi√≥n es un negocio a largo plazo donde la paciencia marca la rentabilidad", "autor": "Francisco Garc√≠a Param√©s" }, { "cita": "¬øCu√°ndo vendemos un valor?, respondemos siempre: cuando haya una oportunidad mejor. Ese es nuestro objetivo permanente, mejorar la cartera cada d√≠a", "autor": "Francisco Garc√≠a Param√©s" }, { "cita": "Lo que en la Bolsa saben todos, no me interesa", "autor": "Andr√© Kostolany" }, { "cita": "No sirve para nada proclamar la verdad en econom√≠a o recomendar cosas √∫tiles. Es la mejor manera de hacerse enemigos", "autor": "Andr√© Kostolany" }, { "cita": "Un inversionista pierde la capacidad de raciocinio cuando gana los primeros diez mil d√≥lares. A partir de entonces se convierte en un pelele f√°cilmente manipulable", "autor": "Andr√© Kostolany" }, { "cita": "Comprar t√≠tulos, acciones de empresas, tomarse unas pastillas para dormir durante 20/30 a√±os y cuando uno despierta, voil√†! es millonario", "autor": "Andr√© Kostolany" }, { "cita": "No s√© si los pr√≥ximos 1.000 puntos del Dow Jones ser√°n hacia arriba o hacia abajo, pero estoy seguro de que los pr√≥ximos 10.000 ser√°n hacia arriba", "autor": "Peter Lynch" }, { "cita": "El destino de un inversor lo marca su est√≥mago , no su cerebro", "autor": "Peter Lynch" }, { "cita": "No siga mis pasos porque a√∫n en el caso de que acierte al comprar usted no sabr√° cu√°ndo vendo", "autor": "Peter Lynch" }, { "cita": "Calcule las 'ganancias del due√±o' para conseguir una reflexi√≥n verdadera del valor", "autor": "Warren Buffett" }, { "cita": "Busque compa√±√≠as con altos m√°rgenes de beneficio", "autor": "Warren Buffett" }, { "cita": "Invierta siempre para el largo plazo", "autor": "Warren Buffett" }, { "cita": "El consejo de que 'usted nunca quiebra tomando un beneficio' es absurdo", "autor": "Warren Buffett" }, { "cita": "¬øEl negocio tiene una historia de funcionamiento constante?", "autor": "Warren Buffett" }, { "cita": "Recuerde que el mercado de valores es maniaco-depresivo", "autor": "Benjamin Graham" }, { "cita": "Compre un negocio, no alquile la acci√≥n", "autor": "Warren Buffett" }, { "cita": "Mientras m√°s absurdo sea el comportamiento del mercado mejor ser√° la oportunidad para el inversor met√≥dico", "autor": "Benjamin Graham" }, { "cita": "Puedes sobrevivir, pero sigues siendo un idiota", "autor": "Joel Greenblatt" }, { "cita": "Los mercados alcistas no tienen resistencia y los bajistas no tienen soporte", "autor": "Ed Downs" }, { "cita": "El p√°nico causa que vendas en el baj√≥n, y la codicia causa que compres cerca a la cima", "autor": "Stan Weinstein" }, { "cita": "Las dos grandes fuerzas que mueven los mercados son la codicia y el miedo", "autor": "An√≥nimo" }, { "cita": "Todo lo que sube baja y todo lo que baja sube", "autor": "An√≥nimo" }, { "cita": "Si no sientes miedo en el momento de comprar es que est√°s comprando mal", "autor": "An√≥nimo" }, { "cita": "Que el √∫ltimo duro lo gane otro", "autor": "An√≥nimo" }, { "cita": "La clave para hacer dinero en acciones es no asustarse de ellas", "autor": "Peter Lynch" }, { "cita": "El precio es lo que pagas, el valor es lo que recibes", "autor": "Warren Buffett" }, { "cita": "No es necesario hacer cosas extraordinarias para conseguir resultados extraordinarios", "autor": "Warren Buffett" }, { "cita": "Alguien est√° sentado en la sombra hoy porque alguien plant√≥ un √°rbol mucho tiempo atr√°s", "autor": "Warren Buffett" }, { "cita": "√önicamente cuando la marea baja, descubres qui√©n ha estado nadando desnudo", "autor": "Warren Buffett" }, { "cita": "No tenemos que ser m√°s inteligentes que el resto, tenemos que ser m√°s disciplinados que el resto", "autor": "Warren Buffett" }, { "cita": "Si compras cosas que no necesitas, pronto tendr√°s que vender cosas que necesitas", "autor": "Warren Buffett" }, { "cita": "Nunca inviertas en un negocio que no puedas entender", "autor": "Warren Buffett" }, { "cita": "El tiempo es amigo de las empresas maravillosas y enemigo de las mediocres", "autor": "Warren Buffett" }, { "cita": "Nuestro per√≠odo de espera favorito es para siempre", "autor": "Warren Buffett" }, { "cita": "Wall Street es el √∫nico lugar al que las personas van en un Rolls-Royce, para recibir asesor√≠a de quienes toman el metro", "autor": "Warren Buffett" }, { "cita": "Llega un momento en el que debes empezar a hacer lo que realmente quieres. Busca un trabajo que te guste y saltar√°s de la cama cada ma√±ana con fuerza", "autor": "Warren Buffett" }, { "cita": "Es siempre mejor pasar el tiempo con gente mejor que t√∫. Escoge asociados cuyo comportamiento es mejor que el tuyo e ir√°s en esa direcci√≥n", "autor": "Warren Buffett" }, { "cita": "Toma 20 a√±os en construir una reputaci√≥n y 5 minutos en arruinarla. Si piensas sobre ello, har√°s las cosas de forma diferente", "autor": "Warren Buffett" }, { "cita": "No importa el talento o los esfuerzos, hay cosas que llevan tiempo. No puedes producir un beb√© en un mes dejando embarazadas a 9 mujeres", "autor": "Warren Buffett" }, { "cita": "Las oportunidades aparecen pocas veces. Cuando llueva oro sal a la calle con un cesto grande y no con un dedal", "autor": "Warren Buffett" }, { "cita": "La gente siempre me pregunta d√≥nde deber√≠an trabajar y yo siempre les digo que vayan a trabajar con aquellos a los que m√°s admiran", "autor": "Warren Buffett" }, { "cita": "¬øCuando hay que vender una acci√≥n? Pues cuando tengamos una oportunidad mejor a la vista", "autor": "Francisco Garc√≠a Param√©s" }, { "cita": "Nunca acudo a las OPV, me gusta estar en las empresas que pueden ser opadas por competidores, no en las salidas a bolsa", "autor": "Francisco Garc√≠a Param√©s" }, { "cita": "Si en el mercado hay m√°s tontos que papel, la bolsa va to subir, si hay m√°s papel que tontos, la bolsa baja", "autor": "Andr√© Kostolany" }, { "cita": "No persiga nunca una acci√≥n, tenga paciencia que la pr√≥xima oportunidad va a llegar con toda seguridad", "autor": "Andr√© Kostolany" }, { "cita": "Lo que todos saben en la bolsa, no nos interesa a los especuladores", "autor": "Andr√© Kostolany" }, { "cita": "Los mercados financieros est√°n dise√±ados para transferir dinero del impaciente al paciente.", "autor": "Warren Buffett" }, { "cita": "Invertir es como hacer dieta.", "autor": "Warren Buffett" }, { "cita": "Lo que aprendemos de la historia es que las personas no aprenden de la historia.", "autor": "Warren Buffett" }, { "cita": "Invierte en negocios que hasta un tonto podr√≠a dirigir. Porque m√°s pronto que tarde uno acabar√° haci√©ndolo.", "autor": "Warren Buffett" }, { "cita": "Las empresas sin deuda no puede quebrar", "autor": "Warren Buffett" }, { "cita": "Invierte en empresas sencillas, sin brillo, mundanas, al margen de las modas y que no hayan llamado la atenci√≥n de Wall Street.", "autor": "Warren Buffett" }, { "cita": "Invierte s√≥lo en empresas en las que estar√≠as tranquilo si no puedes conocer la cotizaci√≥n diaria.", "autor": "Warren Buffett" }, { "cita": "Las inversiones exitosas consisten en saber gestionar el riesgo, no en evitarlo.", "autor": "Benjamin Graham" }, { "cita": "Una gran compa√±√≠a no es una buena inversi√≥n si pagas mucho por la acci√≥n", "autor": "Benjamin Graham" }, { "cita": "A veces es mejor pensar una hora sobre el dinero que dedicar una semana a trabajar para obtenerlo.", "autor": "Andr√© Kostolany" }, { "cita": "En la Bolsa, con frecuencia, hay que cerrar los ojos para ver mejor.", "autor": "Andr√© Kostolany" }, { "cita": "Si la inversi√≥n es entretenida, si te est√°s divirtiendo, es probable que no est√©s ganando dinero. Una buena inversi√≥n es aburrida.", "autor": "George Soros" }, { "cita": "Las burbujas del mercado de valores no crecen de la nada. Tienen una base s√≥lida en la realidad, pero la realidad est√° distorsionada por un malentendido.", "autor": "George Soros" }, { "cita": "Nunca digas que no puedes permitirte algo. Esa es la aptitud de un hombre pobre. Preg√∫ntate c√≥mo permit√≠rtelo.", "autor": "Robert Kiyosaki" }, { "cita": "Una diferencia importante es que los ricos compran los lujos a final, mientras que los pobres y la clase media tienden a comprar los lujos primero.", "autor": "Robert Kiyosaki" }, { "cita": "Mant√©n tus activos bajo m√≠nimos, reduce los pasivos y, con mucha disciplina, ve construyendo una base de activos s√≥lida.", "autor": "Robert Kiyosaki" }, { "cita": "No ahorres lo que queda despu√©s de gastar, sino gasta lo que queda despu√©s de ahorrar.", "autor": "Warren Buffett" }, { "cita": "El riesgo viene de no saber lo que est√°s haciendo.", "autor": "Warren Buffett" }, { "cita": "Sea temeroso cuando otros son codiciosos, y sea codicioso cuando otros son temerosos.", "autor": "Warren Buffett" }, { "cita": "No compres cosas que no necesitas, con dinero que no tienes, para impresionar a gente que no te importa.", "autor": "Dave Ramsey" } ];
    
    const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };
    firebase.initializeApp(firebaseConfig);
    const fbAuth = firebase.auth();
    const fbDb = firebase.firestore();
    let currentUser = null;
    let unsubscribeFromDb = null;
    let saveTimeout = null;
    const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    let db = {};
    const getInitialDb = () => ({ cuentas: [], conceptos: [], movimientos: [], presupuestos: [], config: { beneficiarios: ["Dani", "Norma", "Com√∫n"] } });
    const saveData = (buttonElement = null, successCallback = () => {}) => {
        if (!currentUser) { showToast("No hay usuario autenticado para guardar datos."); return; }
        clearTimeout(saveTimeout);
        if (buttonElement) setButtonLoading(buttonElement, true, 'Guardando...');
        saveTimeout = setTimeout(() => {
            fbDb.collection('users').doc(currentUser.uid).set({ db })
                .then(() => { if (buttonElement) setButtonLoading(buttonElement, false); successCallback(); })
                .catch(error => { console.error("Error al guardar: ", error); showToast("Error al guardar en la nube."); if (buttonElement) setButtonLoading(buttonElement, false); });
        }, 800);
    };
    const loadData = (uid) => {
        const userDocRef = fbDb.collection('users').doc(uid);
        if (unsubscribeFromDb) unsubscribeFromDb();
        unsubscribeFromDb = userDocRef.onSnapshot(doc => {
            if (doc.exists) {
                db = doc.data().db || getInitialDb();
                if (!db.presupuestos) db.presupuestos = [];
                if (!db.config || !db.config.beneficiarios || db.config.beneficiarios.length === 0) { db.config = { beneficiarios: ["Dani", "Norma", "Com√∫n"] }; }
            } else { db = getInitialDb(); saveData(); }
            startMainApp();
        }, error => { console.error("Error de conexi√≥n:", error); showToast("Error de conexi√≥n a la base de datos."); });
    };
    const select = id => document.getElementById(id);
    const selectAll = s => document.querySelectorAll(s);
    const vibrate = (duration = 10) => { if ('vibrate' in navigator) { try { navigator.vibrate(duration); } catch (e) {} } };
    const showToast = (message) => { const t = select('toast'); if (!t) return; t.textContent = message; t.style.opacity = '1'; t.style.bottom = '60px'; setTimeout(() => { t.style.opacity = '0'; t.style.bottom = '50px'; }, 3000); };
    const formatNumber = (num) => (num || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const originalButtonTexts = new Map();
    const setButtonLoading = (buttonEl, isLoading, loadingText = 'Cargando...') => {
        if (!buttonEl) return;
        if (isLoading) { if (!originalButtonTexts.has(buttonEl)) { originalButtonTexts.set(buttonEl, buttonEl.innerHTML); } buttonEl.disabled = true; buttonEl.classList.add('btn-loading'); if (!buttonEl.querySelector('.spinner')) { buttonEl.innerHTML = `${loadingText} <span class="spinner"></span>`; } else { buttonEl.firstChild.nodeValue = `${loadingText} `; }
        } else { buttonEl.disabled = false; buttonEl.classList.remove('btn-loading'); if (originalButtonTexts.has(buttonEl)) { buttonEl.innerHTML = originalButtonTexts.get(buttonEl); originalButtonTexts.delete(buttonEl); } }
    };
    const displayError = (elementId, message) => { const errorEl = select(`${elementId}-error`); if (errorEl) { errorEl.textContent = message; errorEl.setAttribute('role', 'alert'); const inputEl = select(elementId); if (inputEl) { inputEl.classList.add('is-invalid'); inputEl.setAttribute('aria-invalid', 'true'); } } };
    const clearError = (elementId) => { const errorEl = select(`${elementId}-error`); if (errorEl) { errorEl.textContent = ''; errorEl.removeAttribute('role'); const inputEl = select(elementId); if (inputEl) { inputEl.classList.remove('is-invalid'); inputEl.removeAttribute('aria-invalid'); } } };
    const clearAllErrors = (formId) => { const form = select(formId); if (!form) return; form.querySelectorAll('.error-message').forEach(el => { el.textContent = ''; el.removeAttribute('role'); }); form.querySelectorAll('.is-invalid').forEach(el => { el.classList.remove('is-invalid'); el.removeAttribute('aria-invalid'); }); };
    function getRandomQuote() { return quotesData[Math.floor(Math.random() * quotesData.length)]; }

    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    const initApp = async () => {
        setupTheme();
        attachEventListeners();
        const splashScreen = select('splash-screen');
        const quoteSplashScreen = select('quote-splash-screen');

        await wait(3000);
        if (splashScreen) {
            splashScreen.style.opacity = '0';
            await wait(500);
            splashScreen.remove();
        }

        if (quoteSplashScreen && quotesData.length > 0) {
            const quoteTextEl = quoteSplashScreen.querySelector('.quote-text');
            const quoteAuthorEl = quoteSplashScreen.querySelector('.quote-author');
            const randomQuote = getRandomQuote();
            quoteTextEl.textContent = `"${randomQuote.cita}"`;
            quoteAuthorEl.textContent = `- ${randomQuote.autor}`;
            
            quoteSplashScreen.classList.remove('hidden');
            await wait(50);
            quoteSplashScreen.style.opacity = '1';

            await wait(3500);
            quoteSplashScreen.style.opacity = '0';
            await wait(500);
            quoteSplashScreen.remove();
        }

        checkAuthState();
    };

    const startMainApp = () => { select('login-screen').classList.remove('visible'); select('login-screen').classList.add('hidden'); select('app-container').style.display = 'flex'; document.body.style.overflow = ''; renderAll(); navigateTo(select('.nav-btn.active')?.dataset.page || 'panel-control-page'); };
    const showLoginScreen = () => { select('app-container').style.display = 'none'; select('login-screen').classList.remove('hidden'); setTimeout(() => select('login-screen').classList.add('visible'), 50); document.body.style.overflow = 'hidden'; };
    const renderAll = () => { populateAllDropdowns(); renderMovimientos(); renderCuentas(); renderPresupuestos(); loadConfig(); };
    const checkAuthState = () => { fbAuth.onAuthStateChanged(user => { if (user) { currentUser = user; loadData(user.uid); } else { currentUser = null; if (unsubscribeFromDb) unsubscribeFromDb(); db = getInitialDb(); showLoginScreen(); } }); };
    const handleLogin = () => { const email = select('login-email').value.trim(), password = select('login-password').value, errorEl = select('login-error'), loginBtn = select('login-btn'); clearAllErrors('login-form'); errorEl.textContent = ''; let valid = true; if (!email) { displayError('login-email', 'El correo es obligatorio.'); valid = false; } if (!password) { displayError('login-password', 'La contrase√±a es obligatoria.'); valid = false; } if (!valid) return; setButtonLoading(loginBtn, true, 'Iniciando...'); fbAuth.signInWithEmailAndPassword(email, password).then(() => { showToast(`Bienvenido/a de nuevo!`); setButtonLoading(loginBtn, false); }).catch(error => { setButtonLoading(loginBtn, false); if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') { errorEl.textContent = 'Error: Credenciales incorrectas.'; } else if (error.code === 'auth/invalid-email') { displayError('login-email', 'Formato de correo no v√°lido.'); } else { errorEl.textContent = 'Error al iniciar sesi√≥n.'; } }); };
    const handleRegister = () => { const email = select('login-email').value.trim(), password = select('login-password').value, errorEl = select('login-error'), registerBtn = select('register-btn'); clearAllErrors('login-form'); errorEl.textContent = ''; let valid = true; if (!email) { displayError('login-email', 'El correo es obligatorio.'); valid = false; } if (!password) { displayError('login-password', 'La contrase√±a es obligatoria.'); valid = false; } if (!valid) return; setButtonLoading(registerBtn, true, 'Registrando...'); fbAuth.createUserWithEmailAndPassword(email, password).then(() => { showToast(`Registro completado. ¬°Bienvenido/a!`); setButtonLoading(registerBtn, false); }).catch(error => { setButtonLoading(registerBtn, false); if (error.code == 'auth/weak-password') { displayError('login-password', 'La contrase√±a debe tener al menos 6 caracteres.'); } else if (error.code == 'auth/email-already-in-use') { displayError('login-email', 'El correo ya est√° registrado.'); } else if (error.code === 'auth/invalid-email') { displayError('login-email', 'Formato de correo no v√°lido.'); } else { errorEl.textContent = 'Error en el registro.'; } }); };
    const handleLogout = () => { fbAuth.signOut().then(() => showToast("Sesi√≥n cerrada.")).catch(() => showToast("Error al cerrar sesi√≥n.")); };
    const navigateTo = (pageId) => { if(!pageId) return; vibrate(); selectAll('.page').forEach(p => p.classList.remove('active')); select(pageId)?.classList.add('active'); selectAll('.nav-btn').forEach(b => { b.classList.remove('active'); b.removeAttribute('aria-current'); }); const activeBtn = document.querySelector(`.nav-btn[data-page="${pageId}"]`); if (activeBtn) { activeBtn.classList.add('active'); activeBtn.setAttribute('aria-current', 'page'); select('header-title').textContent = activeBtn.dataset.title || 'aiDANaI'; } if (pageId === 'panel-control-page') updateDashboard(); if (pageId === 'cuentas-page') renderCuentas(); if (pageId === 'presupuestos-page') renderPresupuestos(); };
    const setupTheme = () => { const themeToggle = select('theme-toggle'); const theme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', theme); if (themeToggle) { themeToggle.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è'; themeToggle.setAttribute('aria-checked', theme === 'dark'); } };
    let selectedAccountTypesFilter = new Set();
    const getLiquidAccounts = () => { const NON_LIQUID_TYPES = ['PROPIEDAD', 'PR√âSTAMO']; return (db.cuentas || []).filter(c => !NON_LIQUID_TYPES.includes((c.tipo || '').trim().toUpperCase())); };
    
    const getSaldos = () => {
        const saldos = (db.cuentas || []).reduce((acc, c) => ({ ...acc, [c.id]: 0 }), {});
        (db.movimientos || []).forEach(m => {
            if (m.tipo === 'traspaso') {
                if (saldos[m.cuentaOrigenId] !== undefined) saldos[m.cuentaOrigenId] -= m.cantidad;
                if (saldos[m.cuentaDestinoId] !== undefined) saldos[m.cuentaDestinoId] += m.cantidad;
            } else {
                if (saldos[m.cuentaId] !== undefined) saldos[m.cuentaId] += m.cantidad;
            }
        });
        return saldos;
    };

    const populateAllDropdowns = () => { const populate = (el, data, nameKey, valKey = 'id', allOption = false) => { if (!el) return; const currentVal = el.value; el.innerHTML = allOption ? '<option value="">Todos</option>' : ''; [...data].sort((a, b) => (a.nombre || "").localeCompare(b.nombre || "")).forEach(i => { const option = document.createElement('option'); option.value = i[valKey]; option.textContent = i[nameKey]; el.appendChild(option); }); if (Array.from(el.options).some(opt => opt.value === currentVal)) { el.value = currentVal; } else if (!allOption && el.options.length > 0) { el.value = el.options[0].value; } }; const owners = (db.config.beneficiarios || []).map(b => ({ id: b, nombre: b })); populate(select('movimiento-beneficiario'), owners, 'nombre', 'id'); populate(select('presupuesto-beneficiario-p'), owners, 'nombre', 'id'); populate(select('filter-beneficiario'), owners, 'nombre', 'id', true); populate(select('movimiento-cuenta'), db.cuentas, 'nombre', 'id'); populate(select('movimiento-cuenta-origen'), db.cuentas, 'nombre', 'id'); populate(select('movimiento-cuenta-destino'), db.cuentas, 'nombre', 'id'); populate(select('filter-cuenta'), db.cuentas, 'nombre', 'id', true); populate(select('movimiento-concepto'), db.conceptos, 'nombre', 'id'); populate(select('presupuesto-concepto'), db.conceptos, 'nombre', 'id'); populate(select('filter-concepto'), db.conceptos, 'nombre', 'id', true); };
    
    const renderCuentas = () => {
        const accordionContainer = select('cuentas-accordion-container'), resumenContainer = select('resumen-propietario-container'), filterPillsContainer = select('filter-account-types-pills');
        if (!accordionContainer || !resumenContainer || !filterPillsContainer) return;
        const saldos = getSaldos();
        const allLiquidAccounts = getLiquidAccounts();

        const distinctLiquidTypes = [...new Set(allLiquidAccounts.map(c => (c.tipo || '').trim().toUpperCase()))].sort();
        filterPillsContainer.innerHTML = '';
        distinctLiquidTypes.forEach(type => {
            const pill = document.createElement('button');
            pill.className = 'filter-pill'; pill.dataset.type = type; pill.textContent = type;
            if (selectedAccountTypesFilter.has(type)) pill.classList.add('active');
            pill.onclick = () => { vibrate(); pill.classList.toggle('active'); pill.classList.contains('active') ? selectedAccountTypesFilter.add(type) : selectedAccountTypesFilter.delete(type); renderCuentasByOwner(); };
            filterPillsContainer.appendChild(pill);
        });

        const renderCuentasByOwner = () => {
            resumenContainer.innerHTML = '';
            const filteredAccounts = selectedAccountTypesFilter.size === 0 ? allLiquidAccounts : allLiquidAccounts.filter(c => selectedAccountTypesFilter.has((c.tipo || 'SIN TIPO').trim().toUpperCase()));
            (db.config.beneficiarios || []).filter(b => b !== 'Com√∫n').forEach(owner => {
                const ownerAccounts = filteredAccounts.filter(c => c.propietario === owner || c.propietario === 'Com√∫n');
                const saldoNetoEnCentimos = ownerAccounts.reduce((sum, c) => sum + (saldos[c.id] || 0), 0);
                const details = document.createElement('details');
                details.className = 'accordion-item';
                const summary = document.createElement('summary');
                summary.className = `owner-${owner}`;
                summary.innerHTML = `<span>${owner === "Dani" ? "üë®‚Äçüíº" : "üë©‚Äçüíº"} ${owner}</span><strong class="owner-${owner}">${formatNumber(saldoNetoEnCentimos / 100)} ‚Ç¨</strong>`;
                details.appendChild(summary);
                const list = document.createElement('div');
                if (ownerAccounts.length > 0) {
                    ownerAccounts.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(c => {
                        const el = document.createElement('div');
                        el.className = `list-item owner-${c.propietario.replace(/\s/g, '-')}`;
                        el.innerHTML = `<div class="list-item-info"><span class="list-item-title">${c.nombre}</span><span class="list-item-meta">${c.propietario}</span></div><div class="list-item-amount"><strong>${formatNumber((saldos[c.id] || 0) / 100)} ‚Ç¨</strong></div>`;
                        list.appendChild(el);
                    });
                } else {
                    list.innerHTML = `<div class="list-item"><span class="list-item-meta">No hay cuentas para el filtro.</span></div>`;
                }
                details.appendChild(list);
                resumenContainer.appendChild(details);
            });
        };

        const renderCuentasByType = () => {
            accordionContainer.innerHTML = '';
            const totalLiquidoEnCentimos = allLiquidAccounts.reduce((sum, c) => sum + (saldos[c.id] || 0), 0);
            const cuentasPorTipo = allLiquidAccounts.reduce((acc, c) => {
                const tipo = (c.tipo || 'SIN TIPO').trim().toUpperCase();
                (acc[tipo] = acc[tipo] || []).push(c);
                return acc;
            }, {});
            Object.keys(cuentasPorTipo).sort().forEach(tipo => {
                const details = document.createElement('details');
                details.className = 'accordion-item';
                const summary = document.createElement('summary');
                const saldoGrupoEnCentimos = cuentasPorTipo[tipo].reduce((s, c) => s + (saldos[c.id] || 0), 0);
                const porcText = totalLiquidoEnCentimos !== 0 ? `<span style="font-size:var(--font-size-sm);color:var(--secondary-color);margin-left:6px;font-weight:400;">(${(saldoGrupoEnCentimos / totalLiquidoEnCentimos * 100).toFixed(1)}%)</span>` : '';
                summary.innerHTML = `<span>${tipo === 'EFECTIVO' ? 'üíµ' : (tipo.includes('TARJETA') ? 'üí≥' : 'üè¶')} ${tipo}</span><span><strong>${formatNumber(saldoGrupoEnCentimos / 100)} ‚Ç¨</strong>${porcText}</span>`;
                details.appendChild(summary);
                const list = document.createElement('div');
                cuentasPorTipo[tipo].sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(c => {
                    const el = document.createElement('div');
                    el.className = `list-item owner-${c.propietario.replace(/\s/g, '-')}`;
                    el.innerHTML = `<div class="list-item-info"><span class="list-item-title">${c.nombre}</span><span class="list-item-meta">${c.propietario}</span></div><div class="list-item-amount"><strong>${formatNumber((saldos[c.id] || 0) / 100)} ‚Ç¨</strong></div>`;
                    list.appendChild(el);
                });
                details.appendChild(list);
                accordionContainer.appendChild(details);
            });
        };
        renderCuentasByOwner();
        renderCuentasByType();
    };
    
    const renderMovimientos = (filterText = '') => {
        const listContainer = select('movimientos-list');
        if (!listContainer) return;
        const lowerFilter = filterText.toLowerCase();
        const filtered = (db.movimientos || []).filter(m => {
            const concept = db.conceptos.find(c => c.id === m.conceptoId)?.nombre || '';
            const account = m.tipo === 'traspaso' ? `${db.cuentas.find(c => c.id === m.cuentaOrigenId)?.nombre || ''} ${db.cuentas.find(c => c.id === m.cuentaDestinoId)?.nombre || ''}` : (db.cuentas.find(c => c.id === m.cuentaId)?.nombre || '');
            return m.descripcion.toLowerCase().includes(lowerFilter) || concept.toLowerCase().includes(lowerFilter) || account.toLowerCase().includes(lowerFilter);
        });
        listContainer.innerHTML = '';
        if (filtered.length === 0) {
            listContainer.innerHTML = `<p style="padding: 20px; text-align:center;color:var(--secondary-color);font-size:var(--font-size-sm);">No hay movimientos${filterText ? ' que coincidan' : ''}.</p>`;
            return;
        }
        filtered.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(m => {
            const wrapper = document.createElement('div');
            wrapper.className = 'movimiento-item-wrapper';
            wrapper.dataset.id = m.id;

            const ownerClass = m.beneficiario ? `owner-${m.beneficiario.replace(/\s/g, '-')}` : '';
            const cantidadEnEuros = m.cantidad / 100;
            const amountHtml = m.tipo === 'traspaso' ? `<span style="color: var(--info-color)">${formatNumber(cantidadEnEuros)} ‚Ç¨</span>` : (cantidadEnEuros < 0 ? `<span class="text-negative">${formatNumber(cantidadEnEuros)} ‚Ç¨</span>` : `<span class="text-positive">+${formatNumber(cantidadEnEuros)} ‚Ç¨</span>`);
            const metaInfo = m.tipo === 'traspaso' ? `Traspaso de ${(db.cuentas.find(c => c.id === m.cuentaOrigenId)?.nombre || '?')} a ${(db.cuentas.find(c => c.id === m.cuentaDestinoId)?.nombre || '?')}` : `${(db.conceptos.find(c => c.id === m.conceptoId)?.nombre || 'Sin Concepto')} en ${(db.cuentas.find(c => c.id === m.cuentaId)?.nombre || 'Sin Cuenta')}`;
            
            wrapper.innerHTML = `
                <div class="swipe-actions">
                    <button class="edit-movimiento" data-id="${m.id}" aria-label="Editar movimiento">‚úèÔ∏è</button>
                    <button class="delete-movimiento" data-id="${m.id}" aria-label="Eliminar movimiento">üóëÔ∏è</button>
                </div>
                <div class="movimiento-item ${ownerClass}">
                    <div class="movimiento-details">
                        <div class="movimiento-desc">${m.descripcion}</div>
                        <div class="movimiento-meta">${new Date(m.fecha).toLocaleString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})} - ${metaInfo}</div>
                    </div>
                    <div class="movimiento-actions-container">
                         <div class="movimiento-amount">${amountHtml}</div>
                         <button class="options-btn" aria-label="M√°s opciones para ${m.descripcion}" aria-haspopup="true">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" role="img" aria-hidden="true"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                        </button>
                    </div>
                </div>
            `;
            listContainer.appendChild(wrapper);
        });
    };

    const renderPresupuestos = () => {
        const listContainer = select('presupuestos-list');
        if (!listContainer) return;

        const sortedPresupuestos = (db.presupuestos || []).sort((a,b) => a.ano - b.ano);
        listContainer.innerHTML = '';

        if (sortedPresupuestos.length === 0) {
            listContainer.innerHTML = `<p style="padding: 20px; text-align:center;color:var(--secondary-color);font-size:var(--font-size-sm);">No has creado ning√∫n presupuesto.</p>`;
            return;
        }

        sortedPresupuestos.forEach(budget => {
            const gastoReal = (db.movimientos || [])
                .filter(m => {
                    const movYear = new Date(m.fecha).getFullYear();
                    return movYear === budget.ano &&
                           m.beneficiario === budget.beneficiario &&
                           m.conceptoId === budget.conceptoId &&
                           m.cantidad < 0;
                })
                .reduce((sum, m) => sum + Math.abs(m.cantidad), 0);
            
            const limite = budget.cantidad;
            const percentage = limite > 0 ? (gastoReal / limite) * 100 : 0;
            let progressClass = 'progress-ok';
            if (percentage >= 100) {
                progressClass = 'progress-danger';
            } else if (percentage >= 75) {
                progressClass = 'progress-warning';
            }
            
            const conceptoNombre = db.conceptos.find(c => c.id === budget.conceptoId)?.nombre || 'Desconocido';

            const budgetElement = document.createElement('div');
            budgetElement.className = 'budget-item';
            budgetElement.innerHTML = `
                <div class="budget-info">
                    <div class="budget-info-text">
                        <strong>${conceptoNombre} (${budget.beneficiario} ${budget.ano})</strong>
                        <span class="text-negative">Gasto: ${formatNumber(gastoReal / 100)}‚Ç¨</span>
                        <span class="text-positive">L√≠mite: ${formatNumber(limite / 100)}‚Ç¨</span>
                    </div>
                    <button class="btn-danger delete-presupuesto" data-id="${budget.id}">Borrar</button>
                </div>
                <progress class="budget-progress ${progressClass}" value="${gastoReal}" max="${limite}"></progress>
            `;
            listContainer.appendChild(budgetElement);
        });
    };
    
    const loadConfig = () => { const configBeneficiarios = select('config-beneficiarios'); if(configBeneficiarios) configBeneficiarios.value = (db.config.beneficiarios || []).join(', '); };
    const getFilteredMovements = () => { const periodo = select('filter-periodo').value, beneficiario = select('filter-beneficiario').value, cuentaId = select('filter-cuenta').value, conceptoId = select('filter-concepto').value; let startDate, endDate, now = new Date(); switch (periodo) { case 'mes-actual': startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59); break; case 'ano-actual': startDate = new Date(now.getFullYear(), 0, 1); endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59); break; case 'custom': const startVal = select('filter-fecha-inicio').value, endVal = select('filter-fecha-fin').value; startDate = startVal ? new Date(startVal) : null; if(startDate) startDate.setHours(0,0,0,0); endDate = endVal ? new Date(endVal) : null; if(endDate) endDate.setHours(23,59,59,999); break; default: startDate = null; endDate = null; break; } let filtered = db.movimientos || []; if (startDate && endDate) { filtered = filtered.filter(m => new Date(m.fecha) >= startDate && new Date(m.fecha) <= endDate); } if (beneficiario) filtered = filtered.filter(m => m.beneficiario === beneficiario); if (conceptoId) filtered = filtered.filter(m => m.conceptoId === conceptoId); if (cuentaId) { filtered = filtered.filter(m => m.cuentaId === cuentaId || m.cuentaOrigenId === cuentaId || m.cuentaDestinoId === cuentaId); } return filtered.filter(m => m.tipo === 'movimiento' || m.tipo === 'traspaso'); };

    const updateDashboard = () => {
        const movements = getFilteredMovements();
        const kpiContainer = select('kpi-container'), conceptTotalsContainer = select('concepto-totals-list'), listContainer = select('filtered-movements-list'), summaryContainer = select('filtered-movements-summary');
        if (!kpiContainer || !conceptTotalsContainer || !listContainer || !summaryContainer) return;
        
        const ingresos = movements.filter(m => m.cantidad > 0 && m.tipo !== 'traspaso').reduce((sum, m) => sum + m.cantidad, 0);
        const gastos = movements.filter(m => m.cantidad < 0).reduce((sum, m) => sum + m.cantidad, 0);
        const saldo = ingresos + gastos;
        
        kpiContainer.innerHTML = `<div class="kpi-item"><h4 class="text-positive">Ingresos</h4><strong class="text-positive">+${formatNumber(ingresos / 100)} ‚Ç¨</strong></div><div class="kpi-item"><h4 class="text-negative">Gastos</h4><strong class="text-negative">${formatNumber(gastos / 100)} ‚Ç¨</strong></div><div class="kpi-item"><h4>Saldo Neto</h4><strong class="${saldo >= 0 ? 'text-positive' : 'text-negative'}">${formatNumber(saldo / 100)} ‚Ç¨</strong></div>`;
        
        const conceptTotals = movements.reduce((acc, m) => { if (m.tipo === 'movimiento' && m.conceptoId) { acc[m.conceptoId] = (acc[m.conceptoId] || 0) + m.cantidad; } return acc; }, {});
        conceptTotalsContainer.innerHTML = Object.keys(conceptTotals).length === 0 ? '<p style="padding: 20px; text-align:center;color:var(--secondary-color);font-size:var(--font-size-sm);">Sin datos para los filtros.</p>' : Object.entries(conceptTotals).sort(([,a],[,b]) => a - b).map(([id, total]) => `<div class="list-item"><span class="list-item-title">${db.conceptos.find(c => c.id === id)?.nombre || 'Desconocido'}</span><strong class="${total >= 0 ? 'text-positive' : 'text-negative'}">${formatNumber(total / 100)} ‚Ç¨</strong></div>`).join('');
        
        listContainer.innerHTML = ''; summaryContainer.innerHTML = '';
        if (movements.length > 0) {
            movements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(m => {
                const ownerClass = m.beneficiario ? `owner-${m.beneficiario.replace(/\s/g, '-')}` : '';
                const cantidadEnEuros = m.cantidad / 100;
                const amountHtml = m.tipo === 'traspaso' ? `<span style="color: var(--info-color)">${formatNumber(cantidadEnEuros)} ‚Ç¨</span>` : (cantidadEnEuros < 0 ? `<span class="text-negative">${formatNumber(cantidadEnEuros)} ‚Ç¨</span>` : `<span class="text-positive">+${formatNumber(cantidadEnEuros)} ‚Ç¨</span>`);
                const metaInfo = m.tipo === 'traspaso' ? `Traspaso` : `${(db.conceptos.find(c => c.id === m.conceptoId)?.nombre || 'Sin Concepto')}`;
                listContainer.innerHTML += `<div class="movimiento-item ${ownerClass}"><div class="movimiento-details"><div class="movimiento-desc">${m.descripcion}</div><div class="movimiento-meta">${new Date(m.fecha).toLocaleDateString('es-ES')} - ${metaInfo}</div></div><div class="movimiento-amount">${amountHtml}</div></div>`;
            });
            const totalSum = movements.reduce((sum, m) => sum + (m.tipo === 'traspaso' ? 0 : m.cantidad), 0);
            summaryContainer.innerHTML = `<span>Total Filtrado (sin traspasos)</span><strong class="${totalSum >= 0 ? 'text-positive' : 'text-negative'}">${formatNumber(totalSum / 100)} ‚Ç¨</strong>`;
        } else {
            listContainer.innerHTML = '<p style="padding: 20px; text-align:center;color:var(--secondary-color);font-size:var(--font-size-sm);">No se encontraron movimientos.</p>';
        }
    };
    
    // MODIFICADO: Asesor Financiero IA
    const analyzeFinancials = (beneficiario, riskLevel) => {
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        const recentMovements = (db.movimientos || []).filter(m => new Date(m.fecha) > sixMonthsAgo && m.tipo === 'movimiento' && !m.descripcion.toLowerCase().includes('saldo inicial'));
        
        let totalIncome = 0, totalExpenses = 0, expenseByCategory = {};
        recentMovements.forEach(m => {
            let amount = m.cantidad;
            const share = (m.beneficiario === 'Com√∫n' && beneficiario !== 'Com√∫n') ? 0.5 : 1;
            const belongsToUser = m.beneficiario === beneficiario || (m.beneficiario === 'Com√∫n');

            if (belongsToUser) {
                 if (amount > 0) totalIncome += amount * share;
                 else totalExpenses += Math.abs(amount) * share;
            }
           
            if (m.cantidad < 0 && belongsToUser) {
                const categoryName = (db.conceptos.find(c => c.id === m.conceptoId)?.nombre) || 'Sin Categor√≠a';
                expenseByCategory[categoryName] = (expenseByCategory[categoryName] || 0) + (Math.abs(amount) * share);
            }
        });
        
        const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpenses) / totalIncome) * 100 : (totalExpenses > 0 ? -100 : 0);
        const avgMonthlyExpenses = totalExpenses / 6;
        const saldos = getSaldos();
        const EMERGENCY_ACCOUNT_TYPES = ['EFECTIVO', 'CUENTA BANCARIA', 'AHORRO'];
        let emergencyFundTotal = 0, liquidNetWorth = 0, totalDebt = 0;
        
        (db.cuentas || []).forEach(c => {
            const share = (c.propietario === 'Com√∫n' && beneficiario !== 'Com√∫n') ? 0.5 : 1;
            const belongsToUser = c.propietario === beneficiario || c.propietario === 'Com√∫n';
            if(!belongsToUser) return;

            const saldo = saldos[c.id] || 0;
            const tipo = (c.tipo || '').toUpperCase();

            if (!['PROPIEDAD'].includes(tipo)) {
                 if(tipo === 'PR√âSTAMO' || tipo === 'TARJETA DE CR√âDITO') {
                     if(saldo < 0) totalDebt += Math.abs(saldo * share);
                     liquidNetWorth += saldo * share;
                 } else {
                     liquidNetWorth += saldo * share;
                 }
            }
            if (EMERGENCY_ACCOUNT_TYPES.includes(tipo)) {
                emergencyFundTotal += saldo * share;
            }
        });
        
        const emergencyMonths = avgMonthlyExpenses > 0 ? emergencyFundTotal / avgMonthlyExpenses : 99;
        const topExpenses = Object.entries(expenseByCategory).sort((a, b) => b[1] - a[1]).slice(0, 3);
        let strengths = [], improvements = [], investmentSuggestions = [];
        let profile = "Estableciendo Perfil...";
        
        // Determinar el perfil financiero y las sugerencias de inversi√≥n
        if (emergencyMonths < 3) {
            profile = "Fase 1: Construcci√≥n de Cimientos";
            improvements.push(`üî• **Prioridad Absoluta: Fondo de Emergencia.** Tu colch√≥n de seguridad es de solo ${emergencyMonths.toFixed(1)} meses. El objetivo m√≠nimo son 3 meses de gastos. Antes de invertir, es crucial que te centres en aumentar tu ahorro l√≠quido para cubrir imprevistos.`);
            investmentSuggestions.push("‚ùå **No inviertas todav√≠a.** Cualquier dinero extra debe ir directamente a construir tu fondo de emergencia en cuentas seguras y l√≠quidas (ahorro, cuenta corriente). Invertir sin este colch√≥n es extremadamente arriesgado.");
        } else if (liquidNetWorth < 0 && beneficiario !== 'Com√∫n' && totalDebt > 0) {
            profile = "Fase 2: Reducci√≥n de Deuda";
            strengths.push(`üëç ¬°Bien hecho! Tienes un fondo de emergencia adecuado (${emergencyMonths.toFixed(1)} meses). Esta es tu mayor fortaleza y te da seguridad para afrontar el siguiente paso.`);
            improvements.push(`üìâ **Prioridad: Eliminar Deuda de alto inter√©s.** Tu patrimonio l√≠quido es negativo. Conc√©ntrate en pagar las deudas con el inter√©s m√°s alto (tarjetas de cr√©dito, pr√©stamos personales). Cada euro destinado a esto es un retorno garantizado y libre de riesgo.`);
            investmentSuggestions.push("‚ö†Ô∏è **La mejor 'inversi√≥n' ahora es pagar deuda.** Considera pausar o reducir las inversiones para acelerar la eliminaci√≥n de deudas. El rendimiento que obtienes al no pagar intereses altos suele superar al del mercado.");
        } else {
            profile = "Fase 3: Crecimiento y Consolidaci√≥n";
            if (savingsRate >= 15) strengths.push(`‚úÖ ¬°Excelente tasa de ahorro (${savingsRate.toFixed(1)}%)! Este es el motor principal para tu crecimiento financiero y te permitir√° alcanzar tus metas mucho m√°s r√°pido.`);
            else if (savingsRate > 5) strengths.push(`üëç Buena tasa de ahorro (${savingsRate.toFixed(1)}%). Vas por buen camino. Intenta optimizarla un poco m√°s para acelerar tus objetivos.`);
            else strengths.push(`ü§î Tu tasa de ahorro (${savingsRate.toFixed(1)}%) es mejorable. Revisa tus gastos para ver d√≥nde puedes optimizar y aumentar tu capacidad de inversi√≥n.`);

            if (emergencyMonths >= 6) strengths.push(`‚úÖ Fondo de emergencia s√≥lido (${emergencyMonths.toFixed(1)} meses). Te proporciona una gran tranquilidad y la libertad de asumir m√°s riesgos en tus inversiones a largo plazo.`);
            else strengths.push(`üëç Fondo de emergencia funcional (${emergencyMonths.toFixed(1)} meses). Est√°s cubierto para lo b√°sico. Considera aumentarlo hasta 6 meses para una seguridad total.`);
            
            // Sugerencias de inversi√≥n basadas en el riesgo
            switch(riskLevel) {
                case 'bajo':
                    investmentSuggestions.push("üõ°Ô∏è **Enfoque Conservador:** Prioriza la preservaci√≥n del capital. Una cartera podr√≠a consistir en: <strong>Fondos de Renta Fija a corto plazo</strong> (bonos de gobiernos solventes), <strong>dep√≥sitos a plazo</strong>, y una peque√±a parte (10-20%) en un <strong>fondo indexado global diversificado</strong> (ej. MSCI World) para un crecimiento modesto.");
                    investmentSuggestions.push("<strong>Cuentas de ahorro remuneradas</strong> tambi√©n son una excelente opci√≥n sin riesgo para la parte de tu dinero que quieres que crezca lentamente pero segura.");
                    break;
                case 'medio':
                    investmentSuggestions.push("‚öñÔ∏è **Enfoque Equilibrado:** Busca un balance entre crecimiento y seguridad. Una cartera diversificada podr√≠a ser: <strong>60-70% en fondos indexados de renta variable global</strong> (MSCI World, S&P 500) para el crecimiento a largo plazo.");
                    investmentSuggestions.push("<strong>30-40% en fondos de renta fija</strong> (bonos globales) para reducir la volatilidad de la cartera. Puedes considerar a√±adir una peque√±a parte a <strong>REITs (fondos inmobiliarios)</strong> para mayor diversificaci√≥n.");
                    break;
                case 'alto':
                    investmentSuggestions.push("üöÄ **Enfoque de Crecimiento:** Prioriza la rentabilidad asumiendo una mayor volatilidad. Una cartera agresiva podr√≠a incluir: <strong>80-95% en Renta Variable</strong>, combinando un n√∫cleo de <strong>fondos indexados globales</strong> con fondos sectoriales (tecnolog√≠a, salud) o de <strong>mercados emergentes</strong>.");
                    investmentSuggestions.push("Puedes destinar una peque√±a parte (1-5%) a <strong>activos de alto riesgo</strong> como criptomonedas (Bitcoin, Ethereum), entendiendo que es capital especulativo que podr√≠as perder. Se requiere una fuerte disciplina y un horizonte temporal muy largo.");
                    break;
            }
        }
        
        return {
            metrics: { savingsRate, emergencyMonths, liquidNetWorth, avgMonthlyExpenses, topExpenses },
            advice: { strengths, improvements, investmentSuggestions, profile }
        };
    };

    const showAIAdviceModal = () => {
        const modalId = 'ai-advice-modal'; document.getElementById(modalId)?.remove();
        const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay';
        let ownerOptions = (db.config.beneficiarios || []).filter(o => o !== 'Com√∫n').map(o => `<option value="${o}">${o}</option>`).join('');
        modalOverlay.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h4><span style="margin-right: 8px;">üß†</span>Asesor Financiero IA</h4>
                    <button class="close-btn" aria-label="Cerrar asesor">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-grid" style="align-items: flex-end;">
                        <div class="form-group">
                            <label for="ai-analyze-beneficiario">Analizar a:</label>
                            <select id="ai-analyze-beneficiario">${ownerOptions}</select>
                        </div>
                        <div class="form-group">
                            <label for="ai-risk-level">Grado de Riesgo:</label>
                            <select id="ai-risk-level">
                                <option value="bajo">Bajo</option>
                                <option value="medio" selected>Medio</option>
                                <option value="alto">Alto</option>
                            </select>
                        </div>
                    </div>
                    <button id="generate-ai-report-btn" class="btn-primary btn-full" style="margin-top:8px;">Generar An√°lisis</button>
                    <div id="ai-advice-content" style="margin-top:16px;"></div>
                </div>
            </div>`;
        document.body.appendChild(modalOverlay);
        modalOverlay.querySelector('.close-btn').onclick = () => modalOverlay.remove();
        modalOverlay.querySelector('#generate-ai-report-btn').onclick = (e) => {
            const btn = e.currentTarget; setButtonLoading(btn, true, 'Analizando...');
            const beneficiario = select('ai-analyze-beneficiario').value;
            const riskLevel = select('ai-risk-level').value;
            const contentDiv = select('ai-advice-content');
            setTimeout(() => {
                const analysis = analyzeFinancials(beneficiario, riskLevel); const { metrics, advice } = analysis;
                let reportHTML = `<div class="ai-disclaimer"><strong>AVISO IMPORTANTE:</strong> Este es un an√°lisis autom√°tico y <strong>NO es un consejo financiero profesional.</strong> Las sugerencias son gen√©ricas para fines informativos y educativos. Consulta siempre con un asesor financiero cualificado antes de tomar decisiones de inversi√≥n.</div>`;
                reportHTML += `<h5>Informe para ${beneficiario} (Riesgo ${riskLevel})</h5><p>An√°lisis basado en los √∫ltimos 6 meses. <strong>Perfil detectado: ${advice.profile}</strong></p><div class="summary-grid"><div class="summary-item"><h6>Patrimonio L√≠quido</h6><strong class="${metrics.liquidNetWorth >= 0 ? 'text-positive' : 'text-negative'}">${formatNumber(metrics.liquidNetWorth / 100)} ‚Ç¨</strong></div><div class="summary-item"><h6>Tasa de Ahorro</h6><strong class="${metrics.savingsRate >= 10 ? 'text-positive' : 'text-warning'}">${metrics.savingsRate.toFixed(1)}%</strong></div><div class="summary-item"><h6>Fondo Emergencia</h6><strong class="${metrics.emergencyMonths >= 3 ? 'text-positive' : 'text-warning'}">${metrics.emergencyMonths.toFixed(1)} meses</strong></div><div class="summary-item"><h6>Gasto Mensual Medio</h6><strong>${formatNumber(metrics.avgMonthlyExpenses / 100)} ‚Ç¨</strong></div></div>`;
                if (advice.strengths.length > 0) { reportHTML += '<h5>‚úÖ Puntos Fuertes</h5><ul>'; advice.strengths.forEach(item => { reportHTML += `<li>${item}</li>`; }); reportHTML += '</ul>'; }
                if (advice.improvements.length > 0) { reportHTML += '<h5>üéØ √Åreas de Mejora</h5><ul>'; advice.improvements.forEach(item => { reportHTML += `<li>${item}</li>`; }); reportHTML += '</ul>'; }
                if (advice.investmentSuggestions.length > 0) { reportHTML += '<h5>üí° Posibilidades de Inversi√≥n</h5><ul>'; advice.investmentSuggestions.forEach(item => { reportHTML += `<li>${item}</li>`; }); reportHTML += '</ul>'; }
                if(metrics.topExpenses.length > 0){ reportHTML += `<h5>Top 3 Categor√≠as de Gasto (6 meses)</h5><ul>`; metrics.topExpenses.forEach(([name, amount]) => { reportHTML += `<li><strong>${name}:</strong> ${formatNumber(amount / 100)} ‚Ç¨</li>`; }); reportHTML += '</ul>'; }
                contentDiv.innerHTML = reportHTML; setButtonLoading(btn, false);
            }, 500);
        };
    };

    // MODIFICADO: Gu√≠a de Ayuda
    const showHelpModal = () => {
        const modalId = 'help-modal'; document.getElementById(modalId)?.remove();
        const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay';
        modalOverlay.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h4><span style="margin-right: 8px;">üí°</span>Gu√≠a de Cuentas aiDANaI</h4>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <p>¬°Bienvenido a <strong>Cuentas aiDANaI</strong>! Esta aplicaci√≥n est√° dise√±ada para darte el control total sobre tus finanzas personales y compartidas de una manera sencilla, potente e inteligente.</p>
                    
                    <h3>üìä Panel de Control</h3>
                    <p>Es tu centro de mando. Aqu√≠ obtienes una vista r√°pida y filtrada de tu salud financiera.</p>
                    <ul>
                        <li><strong>Filtros Potentes:</strong> Filtra tus movimientos por <strong>periodo</strong> (mes, a√±o, personalizado), <strong>propietario</strong>, <strong>cuenta</strong> y <strong>concepto</strong>. ¬°Comb√≠nalos para obtener la vista que necesitas!</li>
                        <li><strong>KPIs Claros:</strong> Visualiza al instante tus <strong>Ingresos, Gastos y el Saldo Neto</strong> del periodo que hayas filtrado.</li>
                        <li><strong>An√°lisis por Concepto:</strong> Descubre r√°pidamente a d√≥nde va tu dinero con un resumen de gastos e ingresos por cada categor√≠a.</li>
                    </ul>

                    <h3>‚ÜîÔ∏è Movimientos</h3>
                    <p>El coraz√≥n de la aplicaci√≥n. Aqu√≠ registras y gestionas toda tu actividad financiera.</p>
                    <ul>
                        <li><strong>Tipos de Registro:</strong> Puedes a√±adir <strong>movimientos</strong> (ingresos/gastos) o <strong>traspasos</strong> entre tus propias cuentas.</li>
                        <li><strong>Gesti√≥n R√°pida (‚ãÆ):</strong> Junto a los campos de <strong>Concepto</strong> y <strong>Cuenta</strong>, el bot√≥n (‚ãÆ) abre un gestor para a√±adir nuevos elementos sobre la marcha, sin salir de la pantalla de movimientos.</li>
                        <li><strong>Historial Interactivo:</strong> Busca en todo tu historial. En dispositivos m√≥viles, puedes <strong>deslizar un movimiento hacia la izquierda</strong> para revelar las opciones r√°pidas de <strong>Editar</strong> y <strong>Borrar</strong>. En cualquier dispositivo, puedes usar el men√∫ (‚ãÆ) de cada movimiento para acceder a estas opciones.</li>
                    </ul>

                    <h3>üè¶ Cuentas</h3>
                    <p>Organiza, visualiza y ajusta tu patrimonio.</p>
                    <ul>
                        <li><strong>M√∫ltiples Vistas:</strong> Agrupa y visualiza el saldo de tus cuentas por <strong>Propietario</strong> (incluyendo saldos compartidos) o por <strong>Tipo de Cuenta</strong>.</li>
                        <li><strong class="special-feature">Ajuste a Cero:</strong> Una funci√≥n clave. Si el saldo de una cuenta en la app no coincide con la realidad (por peque√±os descuadres o movimientos no registrados), puedes ajustarla. Ve a la pantalla de Movimientos -> ‚ãÆ junto al campo 'Cuenta' -> Gestionar Cuentas. El bot√≥n <strong>"Ajustar a Cero"</strong> crear√° autom√°ticamente un movimiento de ajuste para cuadrar el saldo.</li>
                    </ul>

                    <h3>üéØ Presupuestos</h3>
                    <p>Define tus metas de gasto y mant√©n tus finanzas bajo control.</p>
                    <ul>
                        <li>Crea <strong>l√≠mites de gasto anuales</strong> por propietario y concepto. La aplicaci√≥n te mostrar√° tu progreso con una barra visual para que sepas si vas por buen camino, te est√°s acercando al l√≠mite o lo has superado.</li>
                    </ul>
                    
                    <h3>‚ú® Funciones Especiales e Inteligentes</h3>
                    <ul>
                        <li><strong class="special-feature">üß† Asesor IA (Mejorado):</strong> Tu consejero financiero personal. Esta herramienta va m√°s all√° de un simple resumen:
                            <ul>
                                <li>Analiza tus finanzas de los <strong>√∫ltimos 6 meses</strong>.</li>
                                <li>Te pide que selecciones tu <strong>tolerancia al riesgo</strong> (bajo, medio o alto).</li>
                                <li>En base a todo ello, identifica tu <strong>fase financiera actual</strong> (construcci√≥n de cimientos, reducci√≥n de deuda o crecimiento).</li>
                                <li>Te ofrece <strong>puntos fuertes, √°reas de mejora y posibilidades de inversi√≥n</strong> realistas y adaptadas tanto a tu situaci√≥n como a tu perfil de riesgo.</li>
                                <li><strong>Importante:</strong> Siempre recuerda que son orientaciones educativas y no un consejo financiero profesional.</li>
                            </ul>
                        </li>
                        <li><strong>‚òÄÔ∏è/üåô Tema Oscuro y Claro:</strong> Cambia la apariencia de la app para tu comodidad visual.</li>
                    </ul>

                    <h3>‚öôÔ∏è Configuraci√≥n y Seguridad de Datos</h3>
                    <p>Personaliza la app y, lo m√°s importante, s√© el due√±o de tus datos.</p>
                    <ul>
                        <li><strong>Propietarios:</strong> Define qui√©n participa en las finanzas (Ej: Dani, Norma, Com√∫n).</li>
                        <li><strong>Gesti√≥n de Datos: ¬°ACCI√ìN CR√çTICA!</strong>
                            <ul>
                                <li><strong>Exportar:</strong> Crea una copia de seguridad COMPLETA de todos tus datos en un archivo local. <strong>¬°Hazlo regularmente! Es la mejor forma de proteger tu informaci√≥n.</strong></li>
                                <li><strong>Importar:</strong> Restaura tus datos desde un archivo exportado. Ten cuidado, esto reemplazar√° todos los datos actuales en la nube.</li>
                                <li><strong>Borrar Datos:</strong> Elimina permanentemente toda la informaci√≥n de tu cuenta en la nube. √ösalo con extrema precauci√≥n.</li>
                            </ul>
                        </li>
                    </ul>
                    <p style="text-align:center; margin-top:20px;"><strong>¬°Ahora tienes todo lo que necesitas para tomar el control de tus finanzas!</strong></p>
                </div>
            </div>`;
        document.body.appendChild(modalOverlay);
        modalOverlay.querySelector('.close-btn').onclick = () => modalOverlay.remove();
        modalOverlay.onclick = e => { if(e.target === modalOverlay) modalOverlay.remove(); };
    };

    const showConceptosModal = () => {
        const modalId = 'conceptos-modal'; document.getElementById(modalId)?.remove();
        const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay';
        modalOverlay.innerHTML = `<div class="modal-content"><div class="modal-header"><h4>Gestionar Conceptos</h4><button class="close-btn">&times;</button></div><div class="modal-body"><form id="form-concepto-modal"><h4>Nuevo Concepto</h4><div class="form-group"><label for="concepto-nombre-modal">Nombre del Concepto</label><input type="text" id="concepto-nombre-modal" required placeholder="Ej: Supermercado, Ocio..."><span class="error-message" id="concepto-nombre-modal-error"></span></div><button type="submit" class="btn-primary btn-full" id="add-concepto-modal-btn">A√±adir Concepto</button></form><h4 style="margin-top:20px;">Conceptos Existentes</h4><div id="conceptos-list-modal"></div></div></div>`;
        document.body.appendChild(modalOverlay);
        const listContainer = modalOverlay.querySelector('#conceptos-list-modal');
        const renderList = () => { listContainer.innerHTML = ''; (db.conceptos || []).sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(c => { listContainer.innerHTML += `<div class="modal-list-item"><span>${c.nombre}</span><div class="actions"><button class="btn-danger delete-concepto-modal" data-id="${c.id}">Borrar</button></div></div>`; }); };
        renderList();
        modalOverlay.querySelector('.close-btn').onclick = () => modalOverlay.remove();
        const conceptoNombreInput = select('concepto-nombre-modal'), addConceptoBtn = select('add-concepto-modal-btn');
        conceptoNombreInput.addEventListener('input', () => clearError('concepto-nombre-modal'));
        modalOverlay.querySelector('#form-concepto-modal').onsubmit = (e) => {
            e.preventDefault(); clearAllErrors('form-concepto-modal'); const nombre = conceptoNombreInput.value.trim();
            let valid = true; if (!nombre) { displayError('concepto-nombre-modal', 'El nombre es obligatorio.'); valid = false; }
            if (db.conceptos.some(c => c.nombre.toLowerCase() === nombre.toLowerCase())) { displayError('concepto-nombre-modal', 'Ya existe un concepto con ese nombre.'); valid = false; }
            if (!valid) return;
            setButtonLoading(addConceptoBtn, true, 'A√±adiendo...'); const newConcepto = { id: generateId(), nombre }; db.conceptos.push(newConcepto);
            saveData(addConceptoBtn, () => { renderAll(); showConceptosModal(); showToast(`Concepto '${nombre}' creado.`); });
        };
        listContainer.addEventListener('click', e => { if (e.target.classList.contains('delete-concepto-modal')) { const id = e.target.dataset.id; const deleteBtn = e.target; const isInUse = db.movimientos.some(m => m.conceptoId === id) || db.presupuestos.some(p => p.conceptoId === id); if (isInUse) { showToast('Error: Concepto en uso por un movimiento o presupuesto.'); return; } showConfirmationModal('¬øEliminar este concepto?', () => { setButtonLoading(deleteBtn, true, 'Borrando...'); db.conceptos = db.conceptos.filter(c => c.id !== id); saveData(deleteBtn, () => { renderAll(); showConceptosModal(); showToast('Concepto eliminado.'); }); }); } });
    };
    
    const showCuentasModal = () => {
        const ACCOUNT_TYPES = ['EFECTIVO', 'CUENTA BANCARIA', 'TARJETA DE CR√âDITO', 'AHORRO', 'INVERSI√ìN', 'CRIPTOMONEDAS', 'PROPIEDAD', 'PR√âSTAMO', 'OTROS'];
        const modalId = 'cuentas-modal'; document.getElementById(modalId)?.remove();
        const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay';
        let ownerOptions = (db.config.beneficiarios || []).map(o => `<option value="${o}">${o}</option>`).join('');
        let accountTypeOptions = ACCOUNT_TYPES.map(t => `<option value="${t}">${t.charAt(0) + t.slice(1).toLowerCase()}</option>`).join('');
        
        modalOverlay.innerHTML = `<div class="modal-content"><div class="modal-header"><h4>Gestionar Cuentas</h4><button class="close-btn">&times;</button></div><div class="modal-body"><form id="form-cuenta-modal"><h4>Nueva Cuenta</h4><div class="form-group"><label for="cuenta-nombre-modal">Nombre</label><input type="text" id="cuenta-nombre-modal" required placeholder="Ej: Cartera Dani"><span class="error-message" id="cuenta-nombre-modal-error"></span></div><div class="form-grid"><div class="form-group"><label for="cuenta-tipo-modal">Tipo</label><select id="cuenta-tipo-modal" required>${accountTypeOptions}</select><span class="error-message" id="cuenta-tipo-modal-error"></span></div><div class="form-group"><label for="cuenta-propietario-modal">Propietario</label><select id="cuenta-propietario-modal">${ownerOptions}</select><span class="error-message" id="cuenta-propietario-modal-error"></span></div></div><div class="form-group"><label for="cuenta-saldo-inicial-modal">Saldo Inicial (opcional)</label><input type="text" id="cuenta-saldo-inicial-modal" inputmode="decimal" placeholder="Ej: 100,00"><span class="error-message" id="cuenta-saldo-inicial-modal-error"></span></div><button type="submit" class="btn-primary btn-full" id="add-cuenta-modal-btn">A√±adir Cuenta</button></form><h4 style="margin-top:20px;">Cuentas Existentes</h4><div id="cuentas-list-modal"></div></div></div>`;
        document.body.appendChild(modalOverlay);
        const listContainer = modalOverlay.querySelector('#cuentas-list-modal');
        const renderList = () => {
            const saldos = getSaldos();
            listContainer.innerHTML = '';
            (db.cuentas || []).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(c => {
                const saldoActual = (saldos[c.id] || 0) / 100;
                listContainer.innerHTML += `<div class="modal-list-item">
                    <div>
                        <span>${c.nombre}</span>
                        <em style="display:block; font-size:var(--font-size-sm); color:var(--secondary-color)">(${c.tipo} - ${c.propietario}) | Saldo: ${formatNumber(saldoActual)}‚Ç¨</em>
                    </div>
                    <div class="actions">
                        <button class="btn-secondary adjust-cuenta-cero" data-id="${c.id}" aria-label="Ajustar a cero">Ajustar a Cero</button>
                        <button class="btn-danger delete-cuenta-modal" data-id="${c.id}">Borrar</button>
                    </div>
                </div>`;
            });
        };
        renderList();
        modalOverlay.querySelector('.close-btn').onclick = () => modalOverlay.remove();
        const cuentaNombreInput = select('cuenta-nombre-modal'), addCuentaBtn = select('add-cuenta-modal-btn');
        cuentaNombreInput.addEventListener('input', () => clearError('cuenta-nombre-modal'));
        
        modalOverlay.querySelector('#form-cuenta-modal').onsubmit = (e) => {
            e.preventDefault(); clearAllErrors('form-cuenta-modal');
            const nombre = cuentaNombreInput.value.trim(), tipo = select('cuenta-tipo-modal').value, propietario = select('cuenta-propietario-modal').value;
            const saldoInicialStr = select('cuenta-saldo-inicial-modal').value.trim().replace(',', '.');
            const saldoInicialEnCentimos = Math.round((parseFloat(saldoInicialStr) || 0) * 100);
            let valid = true;
            if (!nombre) { displayError('cuenta-nombre-modal', 'El nombre es obligatorio.'); valid = false; }
            if (db.cuentas.some(c => c.nombre.toLowerCase() === nombre.toLowerCase())) { displayError('cuenta-nombre-modal', 'Ya existe una cuenta con ese nombre.'); valid = false; }
            if (!valid) return;
            setButtonLoading(addCuentaBtn, true, 'A√±adiendo...');
            const newCuenta = { id: generateId(), nombre, tipo, propietario };
            db.cuentas.push(newCuenta);
            if (saldoInicialEnCentimos !== 0) {
                db.movimientos.push({ id: generateId(), tipo: 'movimiento', descripcion: `Saldo inicial de ${nombre}`, cantidad: saldoInicialEnCentimos, fecha: new Date().toISOString(), cuentaId: newCuenta.id, beneficiario: newCuenta.propietario, conceptoId: null });
            }
            saveData(addCuentaBtn, () => { renderAll(); showCuentasModal(); showToast(`Cuenta '${nombre}' creada.`); });
        };
        listContainer.addEventListener('click', e => {
            const target = e.target;
            const id = target.dataset.id;
            if (target.classList.contains('delete-cuenta-modal')) {
                if (db.movimientos.some(m => m.cuentaId === id || m.cuentaOrigenId === id || m.cuentaDestinoId === id)) { showToast('Error: Cuenta en uso por un movimiento. Aj√∫stala a cero primero.'); return; }
                const deleteBtn = target;
                showConfirmationModal('¬øEliminar esta cuenta? Solo es posible si no tiene movimientos.', () => {
                    setButtonLoading(deleteBtn, true, 'Borrando...');
                    db.cuentas = db.cuentas.filter(c => c.id !== id);
                    saveData(deleteBtn, () => { renderAll(); showCuentasModal(); showToast('Cuenta eliminada.'); });
                });
            } else if (target.classList.contains('adjust-cuenta-cero')) {
                const cuenta = db.cuentas.find(c => c.id === id);
                if (!cuenta) return;
                const saldos = getSaldos();
                const saldoActualEnCentimos = saldos[id] || 0;
                if (saldoActualEnCentimos === 0) {
                    showToast('La cuenta ya tiene saldo cero.');
                    return;
                }
                const ajuste = -saldoActualEnCentimos;
                showConfirmationModal(`¬øCrear un movimiento de ajuste de ${formatNumber(ajuste / 100)}‚Ç¨ para poner la cuenta "${cuenta.nombre}" a cero?`, () => {
                    const ajusteMov = {
                        id: generateId(),
                        tipo: 'movimiento',
                        descripcion: `Ajuste a cero de cuenta ${cuenta.nombre}`,
                        cantidad: ajuste,
                        fecha: new Date().toISOString(),
                        cuentaId: cuenta.id,
                        beneficiario: cuenta.propietario,
                        conceptoId: null
                    };
                    db.movimientos.push(ajusteMov);
                    saveData(null, () => {
                        showToast('Cuenta ajustada a cero.');
                        renderAll();
                        showCuentasModal();
                    });
                });
            }
        });
    };

    const showConfirmationModal = (message, onConfirm, title = "Confirmar Acci√≥n") => { const modalId = 'confirmation-modal'; document.getElementById(modalId)?.remove(); const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay'; modalOverlay.innerHTML = `<div class="modal-content" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-msg"><div class="modal-header"><h4 id="confirm-title">${title}</h4><button class="close-btn" aria-label="Cerrar di√°logo">&times;</button></div><div class="modal-body"><p id="confirm-msg">${message}</p><div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;"><button id="confirm-no-btn" class="btn-secondary">No</button><button id="confirm-yes-btn" class="btn-danger">S√≠</button></div></div></div>`; document.body.appendChild(modalOverlay); const confirmYesBtn = select('confirm-yes-btn'), confirmNoBtn = select('confirm-no-btn'), closeConfirmBtn = modalOverlay.querySelector('.close-btn'); confirmYesBtn.onclick = () => { onConfirm(); modalOverlay.remove(); }; confirmNoBtn.onclick = () => modalOverlay.remove(); closeConfirmBtn.onclick = () => modalOverlay.remove(); };
    
    function attachEventListeners() {
        document.body.addEventListener('click', (e) => {
            const loginBtn = e.target.closest('#login-btn'); if (loginBtn) return handleLogin();
            const registerBtn = e.target.closest('#register-btn'); if (registerBtn) return handleRegister();
            const logoutBtn = e.target.closest('#logout-btn'); if (logoutBtn) return handleLogout();
            const navBtn = e.target.closest('.nav-btn'); if (navBtn) return navigateTo(navBtn.dataset.page);
            const aiAdviceBtn = e.target.closest('#ai-advice-btn'); if (aiAdviceBtn) return showAIAdviceModal();
            const helpBtn = e.target.closest('#help-btn'); if (helpBtn) return showHelpModal();
            const themeToggle = e.target.closest('#theme-toggle'); if (themeToggle) { vibrate(); const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); themeToggle.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è'; themeToggle.setAttribute('aria-checked', newTheme === 'dark'); return; }
            const applyFiltersBtn = e.target.closest('#apply-filters-btn'); if (applyFiltersBtn) { vibrate(20); setButtonLoading(applyFiltersBtn, true, 'Aplicando...'); updateDashboard(); setTimeout(() => setButtonLoading(applyFiltersBtn, false), 400); return; }
            const manageConceptosBtn = e.target.closest('#manage-conceptos-btn'); if (manageConceptosBtn) { vibrate(); showConceptosModal(); return; }
            const manageCuentasBtn = e.target.closest('#manage-cuentas-btn'); if (manageCuentasBtn) { vibrate(); showCuentasModal(); return; }
            const cancelEditMovimientoBtn = e.target.closest('#cancel-edit-movimiento'); if(cancelEditMovimientoBtn) { select('form-movimiento').reset(); select('movimiento-id').value = ''; cancelEditMovimientoBtn.classList.add('hidden'); clearAllErrors('form-movimiento'); select('movimiento-tipo-selector').dispatchEvent(new Event('change')); return; }
            const saveConfigBtn = e.target.closest('#save-config-btn'); if (saveConfigBtn) { const beneficiarios = select('config-beneficiarios').value.split(',').map(s => s.trim()).filter(Boolean); if (beneficiarios.length === 0) { displayError('config-beneficiarios', 'Debe haber al menos un propietario.'); return; } setButtonLoading(saveConfigBtn, true, 'Guardando...'); db.config.beneficiarios = beneficiarios; saveData(saveConfigBtn, () => { renderAll(); showToast('Configuraci√≥n guardada.'); }); return; }
            const clearAllDataBtn = e.target.closest('#clear-all-data-btn'); if(clearAllDataBtn) { showConfirmationModal('¬øSeguro que quieres borrar TODOS tus datos en la nube? Esta acci√≥n es irreversible.', () => { db = getInitialDb(); saveData(null, () => { renderAll(); showToast('Todos los datos han sido borrados.'); }); }); return; }
            const exportDataBtn = e.target.closest('#export-data-btn'); if (exportDataBtn) { setButtonLoading(exportDataBtn, true, 'Exportando...'); const dataStr = JSON.stringify({db}, null, 2); const blob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `cuentas_aiDANaI_export_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Copia de seguridad local exportada.'); setButtonLoading(exportDataBtn, false); return; }
            const importDataBtn = e.target.closest('#import-data-btn'); if (importDataBtn) { select('import-file-input').click(); return; }
            if (e.target.classList.contains('delete-presupuesto')) {
                const budgetId = e.target.dataset.id;
                showConfirmationModal('¬øSeguro que quieres eliminar este presupuesto?', () => {
                    db.presupuestos = db.presupuestos.filter(p => p.id !== budgetId);
                    saveData(null, () => {
                        renderPresupuestos();
                        showToast('Presupuesto eliminado.');
                    });
                });
            }
        });
        document.body.addEventListener('input', (e) => { const targetId = e.target.id; if (['login-email', 'login-password', 'config-beneficiarios'].includes(targetId)) clearError(targetId); const movInputs = ['movimiento-cantidad', 'movimiento-fecha', 'movimiento-descripcion', 'movimiento-concepto', 'movimiento-cuenta', 'movimiento-beneficiario', 'movimiento-cuenta-origen', 'movimiento-cuenta-destino']; if(movInputs.includes(targetId)) clearError(targetId); const presInputs = ['presupuesto-ano', 'presupuesto-beneficiario-p', 'presupuesto-concepto', 'presupuesto-cantidad']; if(presInputs.includes(targetId)) clearError(targetId); if(targetId === 'search-movimientos') renderMovimientos(e.target.value); });
        
        document.body.addEventListener('change', (e) => {
            if(e.target.id === 'filter-periodo') select('custom-date-filters')?.classList.toggle('hidden', e.target.value !== 'custom');
            if(e.target.id === 'movimiento-tipo-selector') {
                const isTraspaso = e.target.value === 'traspaso';
                select('movimiento-fields').style.display = isTraspaso ? 'none' : 'block';
                select('traspaso-fields').classList.toggle('hidden', !isTraspaso);
                select('movimiento-concepto').required = !isTraspaso;
                select('movimiento-cuenta').required = !isTraspaso;
                select('movimiento-beneficiario').required = !isTraspaso;
                select('movimiento-cuenta-origen').required = isTraspaso;
                select('movimiento-cuenta-destino').required = isTraspaso;
                clearAllErrors('form-movimiento');
            }
            if(e.target.id === 'import-file-input') {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    try {
                        let importedData = JSON.parse(re.target.result);
                        if (importedData.db) importedData = importedData.db; 
                        
                        const needsMigration = (importedData.movimientos || []).some(m => !Number.isInteger(m.cantidad)) || 
                                               (importedData.presupuestos || []).some(p => !Number.isInteger(p.cantidad));

                        if (needsMigration) {
                            showToast("Detectado formato antiguo. Migrando datos...");
                            if(importedData.movimientos) importedData.movimientos.forEach(m => m.cantidad = Math.round(m.cantidad * 100));
                            if(importedData.presupuestos) importedData.presupuestos.forEach(p => p.cantidad = Math.round(p.cantidad * 100));
                        }
                        if (importedData.recurringMovements) delete importedData.recurringMovements;

                        showConfirmationModal('Importar reemplazar√° TODOS tus datos en la nube. ¬øEst√°s seguro?', () => {
                            db = importedData;
                            saveData(null, () => {
                                renderAll();
                                showToast('Datos importados y sincronizados.');
                            });
                        }, 'Confirmar Importaci√≥n');
                    } catch (error) {
                        showToast('Error: Archivo JSON no v√°lido.');
                        console.error("Import error:", error);
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            }
        });

        document.body.addEventListener('submit', (e) => {
            if (e.target.id === 'form-movimiento') {
                e.preventDefault(); vibrate(20); clearAllErrors('form-movimiento');
                const id = select('movimiento-id').value, tipo = select('movimiento-tipo-selector').value, fecha = select('movimiento-fecha').value, descripcion = select('movimiento-descripcion').value.trim(), saveMovBtn = select('save-movimiento-btn');
                
                const cantidadStr = select('movimiento-cantidad').value.trim().replace(',', '.');
                const cantidadFloat = parseFloat(cantidadStr);
                const cantidadEnCentimos = Math.round(cantidadFloat * 100);

                let valid = true;
                if (isNaN(cantidadFloat) || cantidadFloat === 0) { displayError('movimiento-cantidad', 'Cantidad inv√°lida o cero.'); valid = false; }
                if (!fecha) { displayError('movimiento-fecha', 'Fecha y hora son obligatorias.'); valid = false; }
                if (!descripcion) { displayError('movimiento-descripcion', 'La descripci√≥n es obligatoria.'); valid = false; }
                
                let newMov = { id: id || generateId(), tipo, cantidad: cantidadEnCentimos, fecha: fecha ? new Date(fecha).toISOString() : new Date().toISOString(), descripcion };
                if(tipo === 'traspaso') {
                    newMov.cuentaOrigenId = select('movimiento-cuenta-origen').value; newMov.cuentaDestinoId = select('movimiento-cuenta-destino').value; newMov.beneficiario = 'Com√∫n';
                    if (!newMov.cuentaOrigenId) { displayError('movimiento-cuenta-origen', 'Cuenta origen es obligatoria.'); valid = false; }
                    if (!newMov.cuentaDestinoId) { displayError('movimiento-cuenta-destino', 'Cuenta destino es obligatoria.'); valid = false; }
                    if (newMov.cuentaOrigenId === newMov.cuentaDestinoId) { displayError('movimiento-cuenta-destino', 'Origen y destino no pueden ser iguales.'); valid = false; }
                    if (cantidadEnCentimos <= 0) { displayError('movimiento-cantidad', 'Para traspasos, la cantidad debe ser positiva.'); valid = false; }
                } else {
                    newMov.cuentaId = select('movimiento-cuenta').value; newMov.conceptoId = select('movimiento-concepto').value; newMov.beneficiario = select('movimiento-beneficiario').value;
                    if (!newMov.cuentaId) { displayError('movimiento-cuenta', 'Cuenta es obligatoria.'); valid = false; }
                    if (!newMov.conceptoId) { displayError('movimiento-concepto', 'Concepto es obligatorio.'); valid = false; }
                    if (!newMov.beneficiario) { displayError('movimiento-beneficiario', 'Propietario es obligatorio.'); valid = false; }
                }
                if (!valid) return;
                setButtonLoading(saveMovBtn, true, 'Guardando...');
                if (id) {
                    const index = db.movimientos.findIndex(m => m.id === id);
                    if (index > -1) db.movimientos[index] = newMov;
                } else {
                    db.movimientos.push(newMov);
                }
                saveData(saveMovBtn, () => { e.target.reset(); select('movimiento-id').value = ''; select('cancel-edit-movimiento').classList.add('hidden'); select('movimiento-tipo-selector').dispatchEvent(new Event('change')); showToast(id ? 'Movimiento actualizado' : 'Movimiento a√±adido'); renderAll(); updateDashboard(); });
            }
            if (e.target.id === 'form-presupuesto') {
                e.preventDefault(); clearAllErrors('form-presupuesto');
                const ano = parseInt(select('presupuesto-ano').value), beneficiario = select('presupuesto-beneficiario-p').value, conceptoId = select('presupuesto-concepto').value, savePresupuestoBtn = select('save-presupuesto-btn');
                const cantidadStr = select('presupuesto-cantidad').value.trim().replace(',', '.');
                const cantidadFloat = parseFloat(cantidadStr);
                const cantidadEnCentimos = Math.round(cantidadFloat * 100);
                
                let valid = true;
                if (isNaN(ano) || ano < 2000 || ano > 2100) { displayError('presupuesto-ano', 'A√±o inv√°lido.'); valid = false; }
                if (!beneficiario) { displayError('presupuesto-beneficiario-p', 'Propietario es obligatorio.'); valid = false; }
                if (!conceptoId) { displayError('presupuesto-concepto', 'Concepto es obligatorio.'); valid = false; }
                if (isNaN(cantidadFloat) || cantidadFloat <= 0) { displayError('presupuesto-cantidad', 'Cantidad debe ser un n√∫mero positivo mayor que cero.'); valid = false; }
                if (db.presupuestos.some(p => p.ano === ano && p.beneficiario === beneficiario && p.conceptoId === conceptoId)) { displayError('presupuesto-concepto', 'Ya existe un presupuesto con estos par√°metros.'); valid = false; }
                if (!valid) return;
                setButtonLoading(savePresupuestoBtn, true, 'Guardando...');
                const newPresupuesto = { id: generateId(), ano, beneficiario, conceptoId, cantidad: cantidadEnCentimos };
                db.presupuestos.push(newPresupuesto);
                saveData(savePresupuestoBtn, () => { e.target.reset(); showToast('Presupuesto guardado.'); renderAll(); });
            }
        });
        
        let touchStartX = 0, currentSwipedItem = null; const movimientosList = select('movimientos-list');
        movimientosList.addEventListener('touchstart', e => { const targetItem = e.target.closest('.movimiento-item'); if (!targetItem) return; touchStartX = e.changedTouches[0].screenX; if (currentSwipedItem && currentSwipedItem !== targetItem) { currentSwipedItem.classList.remove('swipe-open'); } currentSwipedItem = targetItem; }, { passive: true });
        movimientosList.addEventListener('touchend', e => { if (!currentSwipedItem) return; const touchEndX = e.changedTouches[0].screenX; if (touchStartX - touchEndX > 50) { currentSwipedItem.classList.add('swipe-open'); } else if (touchEndX - touchStartX > 50) { currentSwipedItem.classList.remove('swipe-open'); } touchStartX = 0; });
        movimientosList.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;

            const wrapper = e.target.closest('.movimiento-item-wrapper');
            const id = wrapper?.dataset.id;
            
            if (button.classList.contains('delete-movimiento') && id) { confirmDeleteMovement(id); }
            else if (button.classList.contains('edit-movimiento') && id) { startEditMovement(id); }
            else if (button.classList.contains('options-btn') && id) { showMovementOptions(id); }
        });
    }

    const showMovementOptions = (movimientoId) => {
        document.getElementById('movement-options-menu')?.remove();
        const mov = db.movimientos.find(m => m.id === movimientoId);
        if (!mov) return;

        const menuOverlay = document.createElement('div');
        menuOverlay.id = 'movement-options-menu';
        menuOverlay.className = 'action-sheet-overlay';
        menuOverlay.innerHTML = `
            <div class="action-sheet-content">
                <div class="action-sheet-header">${mov.descripcion}</div>
                <button class="action-sheet-btn edit-btn">‚úèÔ∏è Editar</button>
                <button class="action-sheet-btn delete-btn text-negative">üóëÔ∏è Eliminar</button>
                <button class="action-sheet-btn cancel-btn">Cancelar</button>
            </div>
        `;
        document.body.appendChild(menuOverlay);

        const closeMenu = () => menuOverlay.remove();
        menuOverlay.querySelector('.cancel-btn').onclick = closeMenu;
        menuOverlay.onclick = (e) => { if (e.target === menuOverlay) closeMenu(); };

        menuOverlay.querySelector('.edit-btn').onclick = () => { closeMenu(); startEditMovement(movimientoId); };
        menuOverlay.querySelector('.delete-btn').onclick = () => { closeMenu(); confirmDeleteMovement(movimientoId); };
    };

    const startEditMovement = (id) => {
        const mov = db.movimientos.find(m => m.id === id);
        if (mov) {
            navigateTo('movimientos-page');
            select('movimiento-id').value = mov.id;
            select('movimiento-tipo-selector').value = mov.tipo;
            select('movimiento-tipo-selector').dispatchEvent(new Event('change'));
            
            const cantidadParaEditar = mov.cantidad / 100;
            select('movimiento-cantidad').value = cantidadParaEditar.toFixed(2).replace('.', ',');

            select('movimiento-fecha').value = new Date(mov.fecha).toISOString().slice(0, 16);
            select('movimiento-descripcion').value = mov.descripcion;
            if(mov.tipo === 'traspaso') {
                select('movimiento-cuenta-origen').value = mov.cuentaOrigenId;
                select('movimiento-cuenta-destino').value = mov.cuentaDestinoId;
            } else {
                select('movimiento-cuenta').value = mov.cuentaId;
                select('movimiento-concepto').value = mov.conceptoId;
                select('movimiento-beneficiario').value = mov.beneficiario;
            }
            select('cancel-edit-movimiento').classList.remove('hidden');
            select('form-movimiento').scrollIntoView({ behavior: 'smooth' });
            clearAllErrors('form-movimiento');
        }
    };
    
    const confirmDeleteMovement = (id) => {
        showConfirmationModal('¬øSeguro que quieres eliminar este movimiento?', () => {
            db.movimientos = db.movimientos.filter(m => m.id !== id);
            saveData(null, () => {
                renderAll();
                updateDashboard();
                showToast('Movimiento eliminado.');
            });
        });
    };

    initApp();
});
</script>
</body>
</html>