<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Cuentas aiDANaI</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="manifest" href="data:application/manifest+json,{
        %22name%22:%22Cuentas aiDANaI%22,
        %22short_name%22:%22aiDANaI%22,
        %22start_url%22:%22.%22,
        %22display%22:%22standalone%22,
        %22background_color%22:%22#000000%22,
        %22theme_color%22:%22#0A84FF%22,
        %22description%22:%22Gestor de finanzas personales y compartidas, elegante y profesional.%22,
        %22icons%22:[
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg%2bxml%22},
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg%2bxml%22}
        ]
    }">
    <meta name="theme-color" content="#000000"/>
    <link rel="apple-touch-icon" href="aiDANaI-Cuentas.jpg">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        :root {
            /* iOS-style Color Palette */
            --c-primary: #0A84FF; --c-primary-hover: #0076e6;
            --c-background: #F2F2F7; /* iOS Grey Background */
            --c-surface: #FFFFFF;
            --c-surface-variant: #E9E9EB;
            --c-on-surface: #000000;
            --c-on-surface-secondary: #8A8A8E;
            --c-outline: #D1D1D6;
            --c-success: #34C759; --c-danger: #FF3B30; --c-warning: #FF9500; --c-info: #5AC8FA; --c-white: #FFFFFF; --c-black: #000000;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 6px 20px 0 rgba(0, 0, 0, 0.1);

            --c-owner-dani: #0A84FF; --c-owner-norma: #FF2D55; --c-owner-comun: #34C759; --c-owner-comÃºn: #34C759;
            
            /* iOS-first Font Stack */
            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            
            /* Font Sizes */
            --fs-xs: 0.75rem; --fs-sm: 0.875rem; --fs-base: 1rem; --fs-lg: 1.125rem; --fs-xl: 1.25rem;
            
            /* Spacing units */
            --sp-1: 0.25rem; --sp-2: 0.5rem; --sp-3: 0.75rem; --sp-4: 1rem; --sp-5: 1.25rem; --sp-6: 1.5rem;
            
            /* iOS-style Border Radius */
            --border-radius-md: 10px; --border-radius-lg: 18px;
        }
        [data-theme="dark"] {
            --c-primary: #0A84FF; --c-primary-hover: #339aff;
            --c-background: #000000; /* True black for OLED */
            --c-surface: #1C1C1E;
            --c-surface-variant: #2C2C2E;
            --c-on-surface: #FFFFFF;
            --c-on-surface-secondary: #8D8D93;
            --c-outline: #38383A;
            --c-success: #30D158; --c-danger: #FF453A; --c-warning: #FF9F0A; --c-info: #64D2FF;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
            --shadow-md: 0 6px 20px 0 rgba(0, 0, 0, 0.25);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; scroll-behavior: smooth; }
        body { font-family: var(--font-family); background-color: var(--c-background); color: var(--c-on-surface); line-height: 1.4; min-height: 100vh; min-height: -webkit-fill-available; transition: background-color 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow: hidden; font-weight: 400; }
        *:focus-visible { outline: 2px solid var(--c-primary); outline-offset: 2px; border-radius: var(--sp-2); }
        
        @keyframes pop-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes highlight-card { 0% { background-color: color-mix(in srgb, var(--c-primary) 15%, transparent); } 100% { background-color: transparent; } }
        .highlight-animation { animation: highlight-card 1.5s ease-out; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton {
            background-color: var(--c-surface-variant);
            background-image: linear-gradient(90deg, var(--c-surface-variant), color-mix(in srgb, var(--c-outline) 20%, var(--c-surface-variant)), var(--c-surface-variant));
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: var(--sp-2);
            color: transparent !important;
            user-select: none;
        }
        .skeleton > * { visibility: hidden; }
        
        .intro-screen { position: fixed; inset: 0; z-index: 9999; display: flex; justify-content: center; align-items: center; background-color: #111827; transition: opacity 0.75s ease-in-out; }
        .starry-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(1px 1px at 10% 20%,#fff,transparent),radial-gradient(1px 1px at 80% 30%,#fff,transparent),radial-gradient(2px 2px at 50% 50%,#fff,transparent),radial-gradient(1px 1px at 30% 80%,#fff,transparent),radial-gradient(2px 2px at 90% 90%,#fff,transparent); background-size: 300px 300px; animation: twinkle 15s linear infinite; }
        @keyframes twinkle { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .intro-screen__logo { width: 250px; height: auto; border-radius: 24px; opacity: 0; position: absolute; animation: logoExplode 2.5s cubic-bezier(0.5, 0, 0.5, 1) forwards; }
        @keyframes logoExplode { 0% { transform: scale(0.2) rotate(-25deg); opacity: 0; } 30% { transform: scale(1.1) rotate(10deg); opacity: 1; } 50% { transform: scale(0.95) rotate(-8deg); opacity: 1; } 80% { transform: scale(1.5) rotate(5deg); opacity: 1; } 100% { transform: scale(12) rotate(20deg); opacity: 0; } }
        .intro-screen__quote-container { text-align: center; color: var(--c-white); padding: var(--sp-5); max-width: 800px; z-index: 1; opacity: 0; transition: opacity 1.5s ease-in-out; }
        .intro-screen__quote-container.visible { opacity: 1; }
        .intro-screen__quote-text { font-size: clamp(1.2rem, 4vw, 1.8rem); font-style: italic; font-weight: var(--fw-normal); line-height: 1.4; margin-bottom: 16px; text-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        .intro-screen__quote-author { display: block; font-size: clamp(0.8rem, 2.4vw, 1rem); color: var(--c-on-surface-secondary); font-weight: var(--fw-medium); }
        
        .app-layout { display: none; max-width: 500px; margin: 0 auto; height: 100vh; background-color: var(--c-background); position: relative; flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; }
        .app-layout--visible { display: flex; opacity: 1; }
        .app-layout__main { flex: 1; position: relative; overflow: hidden; padding-top: 56px; }
        .view { position: absolute; inset: 0; display: flex; flex-direction: column; overflow-y: auto; padding: var(--sp-4) var(--sp-4); padding-bottom: calc(68px + var(--sp-4) + env(safe-area-inset-bottom)); opacity: 0; transform: translateX(10px); transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; pointer-events: none; }
        .view--active { opacity: 1; transform: translateX(0); pointer-events: auto; }
        #movimientos-page { overflow: hidden; padding: 0; padding-top: var(--sp-4); }
        
        .top-bar { display: flex; align-items: center; justify-content: space-between; padding: var(--sp-2) var(--sp-4); background-color: color-mix(in srgb, var(--c-surface) 80%, transparent); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--c-outline); z-index: 200; height: 56px; position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; }
        .top-bar__title { font-size: var(--fs-xl); font-weight: 700; }
        .top-bar__actions { display: flex; align-items: center; gap: var(--sp-1); }
        
        .card { background: none; border: none; box-shadow: none; padding: 0; margin-bottom: var(--sp-4); }
        .card__title { font-size: var(--fs-lg); font-weight: 600; margin-bottom: var(--sp-3); display: flex; align-items: center; gap: var(--sp-2); color: var(--c-primary); }
        .card__title .material-icons { font-size: var(--fs-lg); }

        .chart-container { position: relative; height: 220px; width: 100%; margin-bottom: var(--sp-4); }

        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--sp-3); margin-bottom: var(--sp-4); }
        .kpi-item { background: var(--c-surface); border-radius: var(--border-radius-lg); padding: var(--sp-3); text-align: center; transition: background-color 0.3s; }
        .kpi-item__label { font-size: var(--fs-xs); font-weight: 500; color: var(--c-on-surface-secondary); margin-bottom: var(--sp-1); text-transform: uppercase; }
        .kpi-item__value { font-size: var(--fs-base); font-weight: 700; }
        
        #movimientos-list-container { height: 100%; overflow-y: auto; position: relative; -webkit-overflow-scrolling: touch; padding: 0 var(--sp-4); }
        #virtual-list-sizer { position: relative; width: 100%; }
        #virtual-list-content { position: absolute; top: 0; left: 0; width: 100%; }
        
        .transaction-card {
            display: flex;
            position: relative;
            overflow: hidden;
            background-color: var(--c-surface);
            margin-bottom: var(--sp-2);
            border-radius: var(--border-radius-lg);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .transaction-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .transaction-card__swipe-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-grow: 1;
            padding: var(--sp-3) var(--sp-4);
            padding-left: calc(var(--sp-4) + 12px);
            gap: var(--sp-3);
            width: 100%;
            position: relative;
            z-index: 2;
            background: inherit;
            transition: transform 0.3s ease;
            cursor: pointer;
            border-radius: inherit; 
            border-bottom: none;
        }

        .transaction-card__details { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        .transaction-card__description { font-weight: 500; font-size: var(--fs-sm); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__meta { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__amount { font-weight: 600; font-size: var(--fs-sm); text-align: right; flex-shrink: 0; }
        .transaction-card__actions { position: absolute; top: 0; bottom: 0; width: 65px; display: flex; align-items: center; justify-content: center; z-index: 1; }
        .transaction-card__actions--left { left: 0; background-color: var(--c-info); }
        .transaction-card__actions--right { right: 0; background-color: var(--c-danger); }
        .transaction-card__actions .icon-btn { color: white; width: 100%; height: 100%; border-radius: 0; }
        .transaction-card--swiped-left .transaction-card__swipe-content { transform: translateX(-65px); }
        .transaction-card--swiped-right .transaction-card__swipe-content { transform: translateX(65px); }
        
        .transaction-card__swipe-content::before { content: ''; display: block; width: 8px; height: 8px; border-radius: 50%; background-color: var(--c-outline); position: absolute; left: var(--sp-3); top: 50%; transform: translateY(-50%); }
        .transaction-card--owner-dani .transaction-card__swipe-content::before { background-color: var(--c-owner-dani); }
        .transaction-card--owner-norma .transaction-card__swipe-content::before { background-color: var(--c-owner-norma); }
        .transaction-card--owner-comun .transaction-card__swipe-content::before, .transaction-card--owner-comÃºn .transaction-card__swipe-content::before { background-color: var(--c-owner-comun); }
        
        .card > .accordion { margin-bottom: 0; background-color: var(--c-surface); overflow: hidden; }
        .card > .accordion:first-child { border-top-left-radius: var(--border-radius-lg); border-top-right-radius: var(--border-radius-lg); }
        .card > .accordion:last-child { border-bottom-left-radius: var(--border-radius-lg); border-bottom-right-radius: var(--border-radius-lg); }
        .card > .accordion:last-child > summary { border-bottom: none; }
        .accordion > summary { font-weight: 600; cursor: pointer; padding: var(--sp-3) var(--sp-4); display: flex; align-items: center; justify-content: space-between; list-style: none; font-size: var(--fs-base); border-bottom: 1px solid var(--c-outline); }
        .accordion[open] > summary { border-bottom: 1px solid var(--c-outline); }
        .accordion > summary::-webkit-details-marker { display: none; }
        .accordion > summary .accordion__icon { transition: transform 0.2s; color: var(--c-on-surface-secondary); }
        .accordion[open] > summary .accordion__icon { transform: rotate(180deg); }
        .accordion__content { padding: 0; }
        .accordion__content .modal__list-item { padding-left: var(--sp-4); padding-right: var(--sp-4); }

        .cuentas-owner-name { font-size: var(--fs-xl); font-weight: 700; }
        .cuentas-type-name { font-size: var(--fs-lg); font-weight: 600; }

        .form-group { margin-bottom: var(--sp-3); }
        .form-label { display: block; font-size: var(--fs-sm); font-weight: 500; margin-bottom: var(--sp-2); color: var(--c-on-surface-secondary); }
        .form-input, .form-select { width: 100%; padding: var(--sp-3); border: 1px solid var(--c-outline); border-radius: var(--border-radius-md); background: var(--c-surface-variant); color: var(--c-on-surface); font-size: var(--fs-base); appearance: none; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--c-primary); background-color: var(--c-surface); box-shadow: 0 0 0 3px color-mix(in srgb, var(--c-primary) 20%, transparent); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 12px center; background-size: 14px; padding-right: 36px; }
        [data-theme=dark] .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23FFF' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--sp-3); }
        .form-group-addon { display: flex; align-items: flex-end; gap: var(--sp-2); }
        .form-group-addon .form-group { flex-grow: 1; margin-bottom: 0; }
        .form-error { color: var(--c-danger); font-size: var(--fs-xs); margin-top: var(--sp-1); min-height: 14px; display: block; }
        .form-input--invalid { border-color: var(--c-danger) !important; }
        .form-checkbox-group { display: flex; align-items: center; gap: var(--sp-2); margin-bottom: var(--sp-2); }
        .form-checkbox-group label { margin-bottom: 0; font-weight: normal; }

        .btn { padding: var(--sp-3) var(--sp-4); border: 1px solid transparent; border-radius: var(--border-radius-md); font-size: var(--fs-sm); font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: var(--sp-2); -webkit-user-select: none; user-select: none; }
        .btn:active { transform: scale(0.97); }
        .btn--primary { background-color: var(--c-primary); color: var(--c-white); } .btn--primary:hover { background-color: var(--c-primary-hover); }
        .btn--secondary { background-color: var(--c-surface-variant); color: var(--c-on-surface); } .btn--secondary:hover { background-color: color-mix(in srgb, var(--c-outline) 20%, var(--c-surface-variant)); }
        .btn--danger { background-color: var(--c-danger); color: var(--c-white); } .btn--full { width: 100%; } .btn--loading { pointer-events: none; opacity: .8; }
        
        .icon-btn { background: none; border: none; color: var(--c-on-surface-secondary); cursor: pointer; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s, transform 0.2s; }
        .icon-btn .material-icons { font-size: 20px; }
        .icon-btn:hover { background-color: var(--c-surface-variant); color: var(--c-on-surface); }
        .icon-btn:active { transform: scale(0.9); }
        
        .fab { position: fixed; bottom: calc(78px + env(safe-area-inset-bottom)); right: var(--sp-5); width: 56px; height: 56px; background-color: var(--c-primary); color: var(--c-white); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md); z-index: 50; transform: scale(0); opacity: 0; transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .fab--visible { transform: scale(1); opacity: 1; }
        .fab:hover { transform: scale(1.08) !important; } .fab .material-icons { font-size: 28px; }

        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background-color: var(--c-surface); border-top: 1px solid var(--c-outline); display: flex; padding: var(--sp-1) 0 calc(var(--sp-1) + env(safe-area-inset-bottom)) 0; z-index: 100; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); height: 68px; }
        .bottom-nav__item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--sp-1) var(--sp-2); cursor: pointer; transition: color 0.2s; color: var(--c-on-surface-secondary); border: none; background: none; }
        .bottom-nav__item--active { color: var(--c-primary); }
        .bottom-nav__item .material-icons { font-size: 24px; } .bottom-nav__label { font-size: 11px; font-weight: 500; margin-top: 2px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: flex-end; justify-content: center; z-index: 1050; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        @media (min-width: 500px) { .modal-overlay { align-items: center; } }
        .modal-overlay--active { opacity: 1; pointer-events: auto; }
        .modal { background: var(--c-surface); border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: var(--sp-5); width: 100%; max-width: 420px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: var(--shadow-md); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); animation: pop-in 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-overlay--active .modal { transform: translateY(0); }
        @media (min-width: 500px) { .modal { border-radius: var(--border-radius-lg); } .modal-overlay--active .modal { transform: translateY(0) scale(1); } .modal { transform: translateY(20px) scale(0.95); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s; } }
        .modal__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--sp-3); flex-shrink: 0;}
        .modal__title { font-size: var(--fs-lg); font-weight: 600; }
        .modal__body { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; padding-right: var(--sp-2); margin-right: calc(-1 * var(--sp-2)); }
        .modal__list-item { display:flex; justify-content:space-between; align-items:center; padding: var(--sp-3) 0; border-bottom:1px solid var(--c-outline); }
        .modal__list-item:last-child { border-bottom: none; }
        #help-modal-content h3, #generic-modal-body h3 { font-size: var(--fs-lg); margin-top: 1.2em; margin-bottom: 0.6em; color: var(--c-primary); } #help-modal-content h4, #generic-modal-body h4 { font-size: var(--fs-base); margin-top: 1em; margin-bottom: 0.4em; font-weight: 600; } #help-modal-content p, #help-modal-content li, #generic-modal-body p, #help-modal-content small, #generic-modal-body ul li, #generic-modal-body ol li { color: var(--c-on-surface-secondary); line-height: 1.5; } #help-modal-content ul, #help-modal-content ol { list-style-position: inside; padding-left: var(--sp-2); } #help-modal-content ul li, #help-modal-content ol li { margin-bottom: 6px; }
        #help-modal-content code { background-color: var(--c-surface-variant); padding: 2px 5px; border-radius: 4px; font-family: monospace; color: var(--c-on-surface); }
        #help-modal-content .pro-tip { border-left: 3px solid var(--c-info); padding-left: var(--sp-3); margin: var(--sp-4) 0; font-size: var(--fs-sm); }
        #ai-results-container h4 { margin-top: 1em; margin-bottom: 0.5em; color: var(--c-primary); } #ai-results-container ul { list-style-position: inside; } #ai-results-container li { margin-bottom: 6px; } #ai-results-container small { display: block; margin-top: 1.2em; font-style: italic; }

        .movements-modal-container {
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            background-color: var(--c-surface);
        }
        .movements-modal-container .transaction-card {
            margin-bottom: 0;
            background-color: transparent;
        }
        .movements-modal-container .transaction-card:first-of-type,
        .movements-modal-container .transaction-card:last-of-type {
            border-radius: 0;
        }
        .movements-modal-container .transaction-card:last-of-type .transaction-card__swipe-content {
            border-bottom: none;
        }
        
        .login-view { position: fixed; inset: 0; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: var(--sp-4); opacity: 0; transition: opacity .5s; background-color: var(--c-background); }
        .login-view--visible { display: flex; opacity: 1; }
        .login-view__card { background-color: var(--c-surface); padding: var(--sp-5); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md); width: 100%; max-width: 340px; text-align: center; animation: pop-in 0.3s ease-out; }
        .login-view__title { font-size: var(--fs-xl); font-weight: 700; margin-bottom: var(--sp-4); }
        
        .empty-state { text-align: center; padding: var(--sp-5) var(--sp-4); color: var(--c-on-surface-secondary); animation: fade-in 0.3s; background: var(--c-surface); border-radius: var(--border-radius-lg); }
        .empty-state .material-icons { font-size: 40px; margin-bottom: var(--sp-2); }
        .empty-state h3 { font-size: var(--fs-lg); font-weight: 600; color: var(--c-on-surface); margin-bottom: var(--sp-2); }

        .filter-pills { display: flex; flex-wrap: wrap; gap: var(--sp-2); }
        .filter-pill { padding: var(--sp-1) var(--sp-3); border: none; border-radius: 99px; font-size: var(--fs-xs); font-weight: 500; background-color: var(--c-surface-variant); color: var(--c-on-surface); cursor: pointer; transition: all 0.2s; }
        .filter-pill:hover { opacity: 0.8; }
        .filter-pill--active { background-color: var(--c-primary); color: var(--c-white); font-weight: 600; }

        #movimiento-modal .modal__body { padding-right: var(--sp-1); margin-right: calc(-1 * var(--sp-1)); }
        #movimiento-modal .form-group { margin-bottom: var(--sp-2); }
        #movimiento-modal .form-label { margin-bottom: 4px; font-size: var(--fs-xs); }
        #movimiento-modal .form-input,
        #movimiento-modal .form-select { padding: var(--sp-2); font-size: var(--fs-sm); }
        #movimiento-modal .form-select { background-position: right 8px center; padding-right: 32px; }
        #movimiento-modal .form-group-addon .icon-btn { height: 38px; width: 38px; align-self: flex-end; margin-bottom: 2px; }
        #movimiento-modal .form-group-addon .form-group { margin-bottom: 0; }
        .modal__actions { margin-top: var(--sp-4); display: flex; justify-content: flex-end; gap: var(--sp-2); width: 100%;}
        
        .text-positive { color: var(--c-success); } .text-negative { color: var(--c-danger); } .text-warning { color: var(--c-warning); } .text-info { color: var(--c-info); }
        .hidden { display: none !important; }
        .spinner { display: inline-block; width: 1em; height: 1em; border: .15em solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin .8s linear infinite; vertical-align: middle; }
        @keyframes spin { to { transform:rotate(360deg); } }

        .movimiento-group-header {
            padding: var(--sp-4) 0 var(--sp-2) 0;
            background-color: var(--c-background);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--c-on-surface-secondary);
            font-size: var(--fs-base);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .transaction-card__tags { margin-top: var(--sp-1); }
        .transaction-card__tag { display: inline-block; padding: 2px 8px; font-size: 0.65rem; font-weight: 500; border-radius: 12px; color: var(--c-on-surface-secondary); background-color: var(--c-surface-variant); }

        /* ====== ESTILOS PARA SEGUIMIENTO DE PRESUPUESTO ====== */
        .budget-track-item {
            padding: var(--sp-2) 0;
            border-bottom: 1px solid var(--c-outline);
        }
        .budget-track-item:last-child {
            border-bottom: none;
        }
        .budget-track-item__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--sp-2);
        }
        .budget-track-item__concept-name {
            font-weight: 600;
            font-size: var(--fs-sm);
        }
        .budget-track-item__details {
            display: flex;
            justify-content: space-between;
            font-size: var(--fs-xs);
            color: var(--c-on-surface-secondary);
            margin-bottom: var(--sp-2);
        }
        .budget-track-item__diff--positive {
            color: var(--c-success);
            font-weight: 600;
        }
        .budget-track-item__diff--negative {
            color: var(--c-danger);
            font-weight: 600;
        }
        .budget-item__progress {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 99px;
            overflow: hidden;
            border: 1px solid var(--c-outline);
        }
        .budget-item__progress::-webkit-progress-bar {
            background-color: var(--c-surface-variant);
        }
        .budget-item__progress::-webkit-progress-value {
            background-color: var(--c-primary);
            transition: width 0.3s ease;
        }
        .budget-item__progress.budget-item__progress--danger::-webkit-progress-value {
            background-color: var(--c-danger);
        }
        .budget-item__progress.budget-item__progress--warning::-webkit-progress-value {
            background-color: var(--c-warning);
        }

    </style>
</head>
<body>

<div id="introScreen" class="intro-screen">
    <div class="starry-background"></div>
    <img id="splashImage" class="intro-screen__logo" src="aiDANaI-Cuentas.jpg" alt="Logo aiDANaI">
    <div id="quoteContainer" class="intro-screen__quote-container">
        <p id="quoteText" class="intro-screen__quote-text"></p>
        <span id="quoteAuthor" class="intro-screen__quote-author"></span>
    </div>
</div>

<div id="login-screen" class="login-view">
    <div class="login-view__card">
        <h2 id="login-title" class="login-view__title">ð° Cuentas aiDANaI</h2>
        <form id="login-form" novalidate>
            <div class="form-group"><input type="email" id="login-email" class="form-input" placeholder="Correo electrÃ³nico" required autocomplete="email" autocapitalize="none"><span class="form-error" id="login-email-error"></span></div>
            <div class="form-group"><input type="password" id="login-password" class="form-input" placeholder="ContraseÃ±a" required autocomplete="current-password"><span class="form-error" id="login-password-error"></span></div>
            <div class="form-grid" style="margin-top: 16px;">
                <button type="button" data-action="login" class="btn btn--primary">Iniciar SesiÃ³n</button>
                <button type="button" data-action="register" class="btn btn--secondary">Registrarse</button>
            </div>
            <p id="login-error" class="form-error" style="min-height: 16px; margin-top: 8px;"></p>
        </form>
    </div>
</div>

<div id="app-root" class="app-layout">
    <header id="app-top-bar" class="top-bar">
        <h1 id="top-bar-title" class="top-bar__title"></h1>
        <div id="top-bar-actions" class="top-bar__actions"></div>
    </header>

    <main class="app-layout__main">
        <section id="panel-control-page" class="view" role="region" aria-labelledby="top-bar-title">
            <div class="card">
                <div class="accordion" open>
                    <summary>
                        <h3 class="card__title" style="margin: 0; color: var(--c-on-surface);"><span class="material-icons">filter_list</span>Filtros</h3>
                        <span class="material-icons accordion__icon">expand_more</span>
                    </summary>
                    <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                        <div class="form-group"><label for="filter-periodo" class="form-label">Periodo</label><select id="filter-periodo" class="form-select"><option value="mes-actual">Mes Actual</option><option value="ano-actual">AÃ±o Actual</option><option value="siempre">Siempre</option><option value="custom">Personalizado</option></select></div>
                        <div id="custom-date-filters" class="hidden form-grid"><div class="form-group"><label for="filter-fecha-inicio" class="form-label">Desde</label><input type="date" id="filter-fecha-inicio" class="form-input"></div><div class="form-group"><label for="filter-fecha-fin" class="form-label">Hasta</label><input type="date" id="filter-fecha-fin" class="form-input"></div></div>
                        <div class="form-grid"><div class="form-group"><label for="filter-beneficiario" class="form-label">Propietario</label><select id="filter-beneficiario" class="form-select"></select></div><div class="form-group"><label for="filter-cuenta" class="form-label">Cuenta</label><select id="filter-cuenta" class="form-select"></select></div></div>
                        <div class="form-group"><label for="filter-concepto" class="form-label">Concepto</label><select id="filter-concepto" class="form-select"></select></div>
                        <button data-action="apply-filters" class="btn btn--primary btn--full">Aplicar Filtros</button>
                    </div>
                </div>
            </div>
            <section id="kpi-container" class="kpi-grid" aria-label="Indicadores clave de rendimiento">
            </section>
            <div class="card">
                 <div class="accordion" open>
                    <summary>
                        <h3 class="card__title" style="margin: 0; color: var(--c-on-surface);"><span class="material-icons">category</span>Totales por Concepto</h3>
                        <span class="material-icons accordion__icon">expand_more</span>
                    </summary>
                    <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                        <div class="chart-container" style="height: 240px; margin-bottom: var(--sp-2);">
                            <canvas id="conceptos-chart"></canvas>
                        </div>
                        <div id="concepto-totals-list"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="movimientos-page" class="view" role="region" aria-labelledby="top-bar-title">
            <div id="movimientos-list-container">
                <div id="virtual-list-sizer">
                    <div id="virtual-list-content"></div>
                </div>
            </div> 
            <div id="empty-movimientos" class="empty-state hidden">
                <span class="material-icons">receipt_long</span>
                <h3>Sin Movimientos</h3>
                <p>AÃ±ade tu primer movimiento con el botÃ³n de abajo.</p>
            </div>
        </section>

        <section id="cuentas-page" class="view" role="region" aria-labelledby="top-bar-title">
            <div class="card">
                <div class="accordion" open>
                    <summary>
                         <h3 class="card__title" style="margin: 0; color: var(--c-on-surface);"><span class="material-icons">account_balance_wallet</span>Fondos y Cuentas</h3>
                         <span class="material-icons accordion__icon">expand_more</span>
                    </summary>
                    <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                        <h3 class="card__title" style="font-size: var(--fs-base); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-2);">
                            <span class="material-icons" style="font-size: var(--fs-base);">filter_alt</span>
                            Filtro por tipo de cuenta
                        </h3>
                        <div class="form-group">
                            <div id="filter-account-types-pills" class="filter-pills"></div>
                        </div>
                     </div>
                </div>
            </div>
             <div class="card">
                <div id="resumen-propietario-container"></div>
             </div>
             <div class="card">
                <div id="owner-charts-container">
                    <div id="fondos-dani-container" class="hidden accordion" style="margin-bottom: var(--sp-4);">
                        <div style="padding: var(--sp-3) var(--sp-4);">
                           <h4 class="kpi-item__label" style="text-align: center; margin-bottom: var(--sp-2);">Activos LÃ­quidos Dani</h4>
                            <div class="chart-container" style="height: 150px; margin-bottom: 0;">
                                <canvas id="fondos-dani-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div id="fondos-norma-container" class="hidden accordion">
                         <div style="padding: var(--sp-3) var(--sp-4);">
                            <h4 class="kpi-item__label" style="text-align: center; margin-bottom: var(--sp-2);">Activos LÃ­quidos Norma</h4>
                            <div class="chart-container" style="height: 150px; margin-bottom: 0;">
                                <canvas id="fondos-norma-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="presupuestos-page" class="view" role="region" aria-labelledby="top-bar-title">
             <div class="card">
                 <div class="accordion" open>
                    <summary>
                        <h3 class="card__title" style="margin: 0; color: var(--c-on-surface);"><span class="material-icons">query_stats</span>GestiÃ³n de Presupuestos</h3>
                        <span class="material-icons accordion__icon">expand_more</span>
                    </summary>
                    <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                        <div id="budget-controls" style="display: flex; gap: var(--sp-3); margin-bottom: var(--sp-4); flex-wrap: wrap;">
                            <select id="budget-year-selector" class="form-select" style="flex-basis: 120px; flex-grow: 1;"></select>
                            <select id="budget-owner-selector" class="form-select" style="flex-basis: 180px; flex-grow: 2;"></select>
                        </div>
                         <div style="margin-bottom: var(--sp-4);">
                            <button data-action="update-budgets" class="btn btn--primary btn--full">
                                <span class="material-icons" style="font-size: 16px;">edit</span>
                                Gestionar Presupuestos
                            </button>
                        </div>
                        <div id="budget-tracking-list"></div>
                         <div id="budget-init-placeholder" class="empty-state hidden" style="background: transparent; padding: var(--sp-2) 0;">
                            <span class="material-icons">auto_fix_high</span>
                            <h3 id="budget-placeholder-title">Crear Presupuestos</h3>
                            <p id="budget-placeholder-text">AÃºn no se han creado los presupuestos para el usuario y aÃ±o seleccionados.</p>
                            <button data-action="create-budgets" class="btn btn--primary" style="margin-top: var(--sp-3);">Crear Ahora</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="configuracion-page" class="view" role="region" aria-labelledby="top-bar-title">
            <div class="card">
                 <div class="accordion" open>
                    <summary><h3 class="card__title" style="margin:0; color: var(--c-on-surface);"><span class="material-icons">badge</span>ConfiguraciÃ³n General</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                     <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                        <div class="form-group"><label for="config-beneficiarios" class="form-label">Propietarios (separados por coma)</label><input type="text" id="config-beneficiarios" placeholder="Dani, Norma, ComÃºn" class="form-input"><span class="form-error" id="config-beneficiarios-error"></span></div>
                        
                        <h3 class="card__title" style="margin-top: var(--sp-4); font-size: var(--fs-base);"><span class="material-icons">visibility</span>Visibilidad de Propietarios</h3>
                        <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-top: calc(-1 * var(--sp-2)); margin-bottom: var(--sp-3);">
                            Selecciona los propietarios cuyos datos quieres ver en la aplicaciÃ³n.
                        </p>
                        <div id="config-visible-owners-container" class="form-group"></div>

                        <h3 class="card__title" style="margin-top: var(--sp-4); font-size: var(--fs-base);"><span class="material-icons">rocket_launch</span>Opciones de Arranque</h3>
                         <div class="form-checkbox-group">
                            <input type="checkbox" id="config-skip-intro">
                            <label for="config-skip-intro">Omitir intro y cita al iniciar la app</label>
                        </div>

                        <button data-action="save-config" class="btn btn--primary btn--full" style="margin-top: var(--sp-4);">Guardar ConfiguraciÃ³n</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="accordion">
                    <summary><h3 class="card__title" style="margin:0; color: var(--c-on-surface);"><span class="material-icons">edit_note</span>GestiÃ³n de Cuentas / Conceptos</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                    <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                         <div class="form-grid">
                            <button data-action="manage-cuentas" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">account_balance</span>Cuentas</button>
                            <button data-action="manage-conceptos" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">category</span>Conceptos</button>
                        </div>
                    </div>
                </div>
            </div>
             <div class="card">
                <div class="accordion">
                    <summary><h3 class="card__title" style="margin:0; color: var(--c-on-surface);"><span class="material-icons">backup</span>GestiÃ³n de Datos</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                    <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                         <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-4);">Importar reemplazarÃ¡ todos los datos actuales.</p>
                        <div class="form-grid">
                            <button data-action="export-data" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">file_download</span>Exportar</button>
                            <button data-action="import-data" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">file_upload</span>Importar</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                        </div>
                        <button data-action="clear-data" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);">Borrar Todos los Datos</button>
                    </div>
                </div>
            </div>
             <div class="card">
                <div class="accordion">
                    <summary><h3 class="card__title" style="margin:0; color: var(--c-on-surface);"><span class="material-icons">help_outline</span>Ayuda</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                    <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                         <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-4);">
                            Consulta la guÃ­a de usuario y las Ãºltimas novedades.
                        </p>
                        <button data-action="help" class="btn btn--secondary btn--full">
                            <span class="material-icons" style="font-size: 16px;">menu_book</span>Ver GuÃ­a Completa
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <button data-action="add-movement" id="fab-add-movimiento" class="fab" title="AÃ±adir Movimiento" aria-label="AÃ±adir Movimiento"><span class="material-icons">add</span></button>
    <nav class="bottom-nav">
        <button data-action="navigate" data-page="panel-control-page" class="bottom-nav__item"><span class="material-icons">dashboard</span><span class="bottom-nav__label">Panel</span></button>
        <button data-action="navigate" data-page="movimientos-page" class="bottom-nav__item"><span class="material-icons">swap_horiz</span><span class="bottom-nav__label">Movim.</span></button>
        <button data-action="navigate" data-page="cuentas-page" class="bottom-nav__item"><span class="material-icons">account_balance_wallet</span><span class="bottom-nav__label">Cuentas</span></button>
        <button data-action="navigate" data-page="presupuestos-page" class="bottom-nav__item"><span class="material-icons">pie_chart</span><span class="bottom-nav__label">Presup.</span></button>
        <button data-action="navigate" data-page="configuracion-page" class="bottom-nav__item"><span class="material-icons">settings</span><span class="bottom-nav__label">Config.</span></button>
    </nav>
</div>

<div id="toast-container" class="toast-container" aria-live="assertive"></div>
<div id="movimiento-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="form-movimiento-title">
    <div class="modal">
        <header class="modal__header">
            <h3 id="form-movimiento-title" class="modal__title">AÃ±adir Movimiento</h3>
            <button class="icon-btn" data-action="close-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
        </header>
        <div class="modal__body">
             <form id="form-movimiento" novalidate>
                <input type="hidden" id="movimiento-id">
                <div class="form-group"><label for="movimiento-tipo-selector" class="form-label">Tipo</label><select id="movimiento-tipo-selector" class="form-select"><option value="movimiento">Movimiento</option><option value="traspaso">Traspaso</option></select></div>
                <div class="form-grid"><div class="form-group"><label for="movimiento-cantidad" class="form-label">Cantidad (gasto en negativo)</label><input type="text" id="movimiento-cantidad" class="form-input" inputmode="decimal" required placeholder="Ej: -50,25"><span class="form-error" id="movimiento-cantidad-error"></span></div><div class="form-group"><label for="movimiento-fecha" class="form-label">Fecha y Hora</label><input type="datetime-local" id="movimiento-fecha" class="form-input" required><span class="form-error" id="movimiento-fecha-error"></span></div></div>
                <div class="form-group"><label for="movimiento-descripcion" class="form-label">DescripciÃ³n</label><input type="text" id="movimiento-descripcion" class="form-input" required placeholder="Ej: Compra semanal"><span class="form-error" id="movimiento-descripcion-error"></span></div>
                <div id="movimiento-fields">
                    <div class="form-group-addon"><div class="form-group"><label for="movimiento-concepto" class="form-label">Concepto</label><select id="movimiento-concepto" class="form-select" required></select><span class="form-error" id="movimiento-concepto-error"></span></div><button type="button" data-action="manage-conceptos" class="icon-btn" title="Gestionar Conceptos"><span class="material-icons">more_vert</span></button></div>
                    <div class="form-group-addon"><div class="form-group"><label for="movimiento-cuenta" class="form-label">Cuenta</label><select id="movimiento-cuenta" class="form-select" required></select><span class="form-error" id="movimiento-cuenta-error"></span></div><button type="button" data-action="manage-cuentas" class="icon-btn" title="Gestionar Cuentas"><span class="material-icons">more_vert</span></button></div>
                    <div class="form-group"><label for="movimiento-beneficiario" class="form-label">Propietario</label><select id="movimiento-beneficiario" class="form-select" required></select><span class="form-error" id="movimiento-beneficiario-error"></span></div>
                </div>
                <div id="traspaso-fields" class="hidden form-grid"><div class="form-group"><label for="movimiento-cuenta-origen" class="form-label">Origen</label><select id="movimiento-cuenta-origen" class="form-select" required></select><span class="form-error" id="movimiento-cuenta-origen-error"></span></div><div class="form-group"><label for="movimiento-cuenta-destino" class="form-label">Destino</label><select id="movimiento-cuenta-destino" class="form-select" required></select><span class="form-error" id="movimiento-cuenta-destino-error"></span></div></div>
                <div class="modal__actions"><button type="button" data-action="delete-movement-from-modal" id="delete-movimiento-btn" class="btn btn--danger hidden" style="margin-right: auto;" title="Eliminar"><span class="material-icons">delete</span></button><button type="submit" id="save-movimiento-btn" class="btn btn--primary">Guardar</button></div>
             </form>
        </div>
    </div>
</div>
<div id="generic-modal" class="modal-overlay">
    <div class="modal">
        <header class="modal__header"><h3 id="generic-modal-title" class="modal__title"></h3><button class="icon-btn" data-action="close-modal" title="Cerrar"><span class="material-icons">close</span></button></header>
        <div id="generic-modal-body" class="modal__body"></div>
    </div>
</div>
<div id="ai-advisor-modal" class="modal-overlay">
    <div class="modal">
        <header class="modal__header"><h3 id="ai-advisor-modal-title" class="modal__title">ð¤ Asesor de InversiÃ³n IA</h3><button class="icon-btn" data-action="close-modal" title="Cerrar"><span class="material-icons">close</span></button></header>
        <div id="ai-advisor-modal-body" class="modal__body">
            <form id="ai-advisor-form" novalidate>
                <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-4);">Selecciona un usuario, los meses a analizar y su perfil de riesgo para recibir un anÃ¡lisis de su capacidad de ahorro y sugerencias de inversiÃ³n personalizadas.</p>
                <div class="form-group"><label for="ai-user-select" class="form-label">Usuario a analizar</label><select id="ai-user-select" class="form-select" required></select></div>
                <div class="form-group"><label for="ai-months-study" class="form-label">Meses a estudiar</label><input type="number" id="ai-months-study" class="form-input" required value="6" min="1" max="60"></div>
                <div class="form-group"><label for="ai-risk-level" class="form-label">Nivel de Riesgo Asumido</label><select id="ai-risk-level" class="form-select" required><option value="Bajo">Bajo (Conservador)</option><option value="Medio">Medio (Moderado)</option><option value="Alto">Alto (Agresivo)</option></select></div>
                <div class="modal__actions"><button type="submit" class="btn btn--primary">Analizar y Sugerir</button></div>
            </form>
            <div id="ai-results-container" class="hidden" style="margin-top: var(--sp-4);"></div>
        </div>
    </div>
</div>


<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // =================================================================================
    // 1. STATE & GLOBAL VARIABLES
    // =================================================================================
    const quotesData = [ { "cita": "Los inversores conservadores duermen bien.", "autor": "Benjamin Graham" }, { "cita": "Nunca asciendas a alguien que no ha cometido errores, porque si lo haces, estÃ¡s ascendiendo a alguien que nunca ha hecho nada.", "autor": "Benjamin Graham" }, { "cita": "Si se han hecho los deberes antes de comprar una acciÃ³n, el momento de venderla es: normalmente, nunca.", "autor": "Benjamin Graham" }, { "cita": "Mientras que el entusiasmo Ã© necessario para conseguir grandes logros en cualquier lugar, en Wall Street suele conducir al desastre.", "autor": "John Templeton" }, { "cita": "Sin tener fe en el futuro, nadie invertirÃ­a. Para ser inversor, debes creer en un maÃ±ana mejor.", "autor": "John Templeton" }, { "cita": "Las cuatro palabras mÃ¡s caras de nuestro lenguaje son: 'Esta vez es diferente'.", "autor": "John Templeton" }, { "cita": "CÃ©ntrate en el valor porque la mayorÃ­a de los inversores se fijan en perspectivas y tendencias.", "autor": "Peter Lynch" }, { "cita": "El Ã©xito es un proceso de bÃºsqueda continua de respuestas a nuevas preguntas.", "autor": "Peter Lynch" }, { "cita": "Conoce en lo que inviertes, y por quÃ©.", "autor": "Peter Lynch" }, { "cita": "Cuando vendes en momentos de desesperaciÃ³n, siempre vendes barato.", "autor": "Peter Lynch" }, { "cita": "Una persona que posee una propiedad y tiene una participaciÃ³n en la empresa probablemente trabajarÃ¡ mÃ¡s duro, se sentirÃ¡ mÃ¡s feliz y harÃ¡ un mejor trabajo que otra que no tiene nada.", "autor": "Peter Lynch" }, { "cita": "El riesgo viene de no saber lo que se estÃ¡ haciendo.", "autor": "Warren Buffett" }, { "cita": "Cuesta 20 aÃ±os construir una reputaciÃ³n y 5 minutos destruirla. Si piensas sobre ello, harÃ¡s las cosas de manera diferente.", "autor": "Warren Buffett" }, { "cita": "En el mundo de los negocios, el espejo retrovisor estÃ¡ siempre mÃ¡s claro que el parabrisas.", "autor": "Warren Buffett" }, { "cita": "La inversiÃ³n mÃ¡s importante que puedes hacer es en uno mismo.", "autor": "Warren Buffett" }, { "cita": "SÃ© temeroso cuando otros sean avariciosos, sÃ© avaricioso cuando otros sean temerosos.", "autor": "Warren Buffett" }, { "cita": "SÃ© consciente de lo que no sabes. SiÃ©ntete a gusto entendiendo tus errores y debilidades.", "autor": "Charlie Munger" }, { "cita": "Para hacer dinero en los mercados, tienes que pensar diferente y ser humilde.", "autor": "Charlie Munger" }, { "cita": "El principal problema del inversor, e incluso su peor enemigo, es probablemente Ã©l mismo", "autor": "Benjamin Graham" }, { "cita": "Las personas que no pueden controlar sus emociones no son aptas para obtener beneficios mediante la inversiÃ³n", "autor": "Benjamin Graham" }, { "cita": "Trato de comprar acciones en los negocios que son tan maravillosos que un tonto podrÃ­a manejarlos. Tarde o temprano uno lo harÃ¡", "autor": "Warren Buffett" }, { "cita": "Un inversor deberÃ­a actuar como si tuviera una tarjeta con sÃ³lo 20 decisiones (de compra) para tomar a lo largo de su vida", "autor": "Warren Buffett" }, { "cita": "Regla nÃºmero 1: nunca pierdas dinero. Regla nÃºmero 2: nunca olvides la regla nÃºmero 1", "autor": "Warren Buffett" }, { "cita": "Se gana dinero descontando lo obvio y apostando a lo inesperado", "autor": "George Soros" }, { "cita": "El problema no es lo que uno no sabe, sino lo que uno cree que sabe estando equivocado", "autor": "George Soros" }, { "cita": "Si invertir es entretenido, si te estÃ¡s divirtiendo, probablemente no estÃ©s ganando dinero. Las buenas inversiones son aburridas", "autor": "George Soros" }, { "cita": "Se puede perder dinero a corto plazo, pero necesitas del largo plazo para ganar dinero", "autor": "Peter Lynch" }, { "cita": "La mejor empresa para comprar puede ser alguna que ya tienes en cartera", "autor": "Peter Lynch" }, { "cita": "La clave para ganar dinero con las acciones es no tenerles miedo", "autor": "Peter Lynch" }, { "cita": "Los mercados alcistas nacen en el pesimismo, crecen en el escepticismo, maduran en el optimismo y mueren en la euforia", "autor": "John Templeton" }, { "cita": "El momento de mÃ¡ximo pesimismo es el mejor para comprar y el momento de mÃ¡ximo optimismo es el mejor para vender", "autor": "John Templeton" }, { "cita": "Un inversor que tiene todas las respuestas ni siquiera entiende las preguntas", "autor": "John Templeton" }, { "cita": "La inversiÃ³n es un negocio a largo plazo donde la paciencia marca la rentabilidad", "autor": "Francisco GarcÃ­a ParamÃ©s" }, { "cita": "Â¿CuÃ¡ndo vendemos un valor?, respondemos siempre: cuando haya una oportunidad mejor. Ese es nuestro objetivo permanente, mejorar la cartera cada dÃ­a", "autor": "Francisco GarcÃ­a ParamÃ©s" }, { "cita": "Lo que en la Bolsa saben todos, no me interesa", "autor": "AndrÃ© Kostolany" }, { "cita": "No sirve para nada proclamar la verdad en economÃ­a o recomendar cosas Ãºtiles. Es la mejor manera de hacerse enemigos", "autor": "AndrÃ© Kostolany" }, { "cita": "Un inversionista pierde la capacidad de raciocinio cuando gana los primeros diez mil dÃ³lares. A partir de entonces se convierte en un pelele fÃ¡cilmente manipulable", "autor": "AndrÃ© Kostolany" }, { "cita": "Comprar tÃ­tulos, acciones de empresas, tomarse unas pastillas para dormir durante 20/30 aÃ±os y cuando uno despierta, voilÃ ! es millonario", "autor": "AndrÃ© Kostolany" }, { "cita": "No sÃ© si los prÃ³ximos 1.000 puntos del Dow Jones serÃ¡n hacia arriba o hacia abajo, pero estoy seguro de que los prÃ³ximos 10.000 serÃ¡n hacia arriba", "autor": "Peter Lynch" }, { "cita": "El destino de un inversor lo marca su estÃ³mago , no su cerebro", "autor": "Peter Lynch" }, { "cita": "No siga mis pasos porque aÃºn en el caso de que acierte al comprar usted no sabrÃ¡ cuÃ¡ndo vendo", "autor": "Peter Lynch" }, { "cita": "Calcule las 'ganancias del dueÃ±o' para conseguir una reflexiÃ³n verdadera del valor", "autor": "Warren Buffett" }, { "cita": "Busque compaÃ±Ã­as con altos mÃ¡rgenes de beneficio", "autor": "Warren Buffett" }, { "cita": "Invierta siempre para el largo plazo", "autor": "Warren Buffett" }, { "cita": "El consejo de que 'usted nunca quiebra tomando un beneficio' es absurdo", "autor": "Warren Buffett" }, { "cita": "Â¿El negocio tiene una historia de funcionamiento constante?", "autor": "Warren Buffett" }, { "cita": "Recuerde que el mercado de valores es maniaco-depresivo", "autor": "Benjamin Graham" }, { "cita": "Compre un negocio, no alquile la acciÃ³n", "autor": "Warren Buffett" }, { "cita": "Mientras mÃ¡s absurdo sea el comportamiento del mercado mejor serÃ¡ la oportunidad para el inversor metÃ³dico", "autor": "Benjamin Graham" }, { "cita": "Se puede perder dinero a corto plazo, pero usted sigue siendo un idiota", "autor": "Joel Greenblatt" }, { "cita": "Los mercados alcistas no tienen resistencia y los bajistas no tienen soporte", "autor": "Ed Downs" }, { "cita": "El pÃ¡nico causa que vendas en el bajÃ³n, y la codicia causa que compres cerca a la cima", "autor": "Stan Weinstein" }, { "cita": "Las dos grandes fuerzas que mueven los mercados son la codicia y el miedo", "autor": "AnÃ³nimo" }, { "cita": "Todo lo que sube baja y todo lo que baja sube", "autor": "AnÃ³nimo" }, { "cita": "Si no sientes miedo en el momento de comprar es que estÃ¡s comprando mal", "autor": "AnÃ³nimo" }, { "cita": "Que el Ãºltimo duro lo gane otro", "autor": "AnÃ³nimo" }, { "cita": "La clave para hacer dinero en acciones es no asustarse de ellas", "autor": "Peter Lynch" }, { "cita": "El precio es lo que pagas, el valor es lo que recibes", "autor": "Warren Buffett" }, { "cita": "No es necesario hacer cosas extraordinarias para conseguir resultados extraordinarios", "autor": "Warren Buffett" }, { "cita": "Alguien estÃ¡ sentado en la sombra hoy porque alguien plantÃ³ un Ã¡rbol mucho tiempo atrÃ¡s", "autor": "Warren Buffett" }, { "cita": "Ãnicamente cuando la marea baja, descubres quiÃ©n ha estado nadando desnudo", "autor": "Warren Buffett" }, { "cita": "No tenemos que ser mÃ¡s inteligentes que el resto, tenemos que ser mÃ¡s disciplinados que el resto", "autor": "Warren Buffett" }, { "cita": "Si compras cosas que no necesitas, pronto tendrÃ¡s que vender cosas que necesitas", "autor": "Warren Buffett" }, { "cita": "Nunca inviertas en un negocio que no puedas entender", "autor": "Warren Buffett" }, { "cita": "El tiempo es amigo de las empresas maravillosas y enemigo de las mediocres", "autor": "Warren Buffett" }, { "cita": "Nuestro perÃ­odo de espera favorito es para siempre", "autor": "Warren Buffett" }, { "cita": "Wall Street es el Ãºnico lugar al que las personas van en un Rolls-Royce, para recibir asesorÃ­a de quienes toman el metro", "autor": "Warren Buffett" }, { "cita": "Llega un momento en el que debes empezar a hacer lo que realmente quieres. Busca un trabajo que te guste y saltarÃ¡s de la cama cada maÃ±ana con fuerza", "autor": "Warren Buffett" }, { "cita": "Es siempre mejor pasar el tiempo con gente mejor que tÃº. Escoge asociados cuyo comportamiento es mejor que el tuyo e irÃ¡s en esa direcciÃ³n", "autor": "Warren Buffett" }, { "cita": "Toma 20 aÃ±os en construir una reputaciÃ³n y 5 minutos en arruinarla. Si piensas sobre ello, harÃ¡s las cosas de forma diferente", "autor": "Warren Buffett" }, { "cita": "No importa el talento o los esfuerzos, hay cosas que llevan tiempo. No puedes producir un bebÃ© en un mes dejando embarazadas a 9 mujeres", "autor": "Warren Buffett" }, { "cita": "Las oportunidades aparecen pocas veces. Cuando llueva oro sal a la calle con un cesto grande y no con un dedal", "autor": "Warren Buffett" }, { "cita": "La gente siempre me pregunta dÃ³nde deberÃ­an trabajar y yo siempre les digo que vayan a trabajar con aquellos a los que mÃ¡s admiran", "autor": "Warren Buffett" }, { "cita": "Â¿Cuando hay que vender una acciÃ³n? Pues cuando tengamos una oportunidad mejor a la vista", "autor": "Francisco GarcÃ­a ParamÃ©s" }, { "cita": "Nunca acudo a las OPV, me gusta estar en las empresas que pueden ser opadas por competidores, no en las salidas a bolsa", "autor": "Francisco GarcÃ­a ParamÃ©s" }, { "cita": "Si en el mercado hay mÃ¡s tontos que papel, la bolsa va to subir, si hay mÃ¡s papel que tontos, la bolsa baja", "autor": "AndrÃ© Kostolany" }, { "cita": "No persiga nunca una acciÃ³n, tenga paciencia que la prÃ³xima oportunidad va a llegar con toda seguridad", "autor": "AndrÃ© Kostolany" }, { "cita": "Lo que todos saben en la bolsa, no nos interesa a los especuladores", "autor": "AndrÃ© Kostolany" }, { "cita": "Las inversiones exitosas consisten en saber gestionar el riesgo, no en evitarlo.", "autor": "Benjamin Graham" }, { "cita": "Una gran compaÃ±Ã­a no es una buena inversiÃ³n si pagas mucho por la acciÃ³n", "autor": "Benjamin Graham" }, { "cita": "A veces es mejor pensar una hora sobre el dinero que dedicar una semana a trabajar para obtenerlo.", "autor": "AndrÃ© Kostolany" }, { "cita": "En la Bolsa, con frecuencia, hay que cerrar los ojos para ver mejor.", "autor": "AndrÃ© Kostolany" }, { "cita": "Si la inversiÃ³n es entretenida, si te estÃ¡s divirtiendo, es probable que no estÃ©s ganando dinero. Una buena inversiÃ³n es aburrida.", "autor": "George Soros" }, { "cita": "Las burbujas del mercado de valores no crecen de la nada. Tienen una base sÃ³lida en la realidad, pero la realidad estÃ¡ distorsionada por un malentendido.", "autor": "George Soros" }, { "cita": "Nunca digas que no puedes permitirte algo. Esa es la aptitud de un hombre pobre. PregÃºntate cÃ³mo permitÃ­rtelo.", "autor": "Robert Kiyosaki" }, { "cita": "Una diferencia importante es que los ricos compran los lujos a final, mientras que los pobres y la clase media tienden a comprar los lujos primero.", "autor": "Robert Kiyosaki" }, { "cita": "MantÃ©n tus activos bajo mÃ­nimos, reduce los pasivos y, con mucha disciplina, ve construyendo una base de activos sÃ³lida.", "autor": "Robert Kiyosaki" }, { "cita": "No ahorres lo que queda despuÃ©s de gastar, sino gasta lo que queda despuÃ©s de ahorrar.", "autor": "Warren Buffett" }, { "cita": "El riesgo viene de no saber lo que estÃ¡s haciendo.", "autor": "Warren Buffett" }, { "cita": "Sea temeroso cuando otros son codiciosos, y sea codicioso cuando otros son temerosos.", "autor": "Warren Buffett" }, { "cita": "No compres cosas que no necesitas, con dinero que no tienes, para impresionar a gente que no te importa.", "autor": "Dave Ramsey" } ];
    const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };
    let currentUser = null, unsubscribeFromDb = null, saveTimeout = null, db = {}, deselectedAccountTypesFilter = new Set();
    const originalButtonTexts = new Map();
    let conceptosChart = null, fondosDaniChart = null, fondosNormaChart = null;

    const vList = {
        containerEl: null,
        sizerEl: null,
        contentEl: null,
        items: [],
        itemMap: [],
        heights: { header: 52, transaction: 76 },
        renderBuffer: 10,
        lastRenderedRange: { start: -1, end: -1 },
        isScrolling: null
    };
    
    // =================================================================================
    // 2. FIREBASE & DATA HANDLING
    // =================================================================================
    firebase.initializeApp(firebaseConfig);
    const fbAuth = firebase.auth(), fbDb = firebase.firestore();
    const getInitialDb = () => ({ 
        cuentas: [], 
        conceptos: [], 
        movimientos: [], 
        presupuestos: [], 
        config: { 
            beneficiarios: ["Dani", "Norma"], // Eliminado "ComÃºn"
            visibleOwners: ["Dani", "Norma"], 
            skipIntro: false 
        } 
    });
    const saveData = (buttonElement = null, successCallback = () => {}) => {
        if (!currentUser) { showToast("Error: No hay usuario autenticado.", "danger"); return; }
        clearTimeout(saveTimeout);
        if (buttonElement) setButtonLoading(buttonElement, true, 'Guardando...');
        saveTimeout = setTimeout(() => {
            fbDb.collection('users').doc(currentUser.uid).set({ db })
                .then(() => { if (buttonElement) setButtonLoading(buttonElement, false); successCallback(); })
                .catch(error => { console.error("Error al guardar datos:", error); showToast("Error al guardar.", "danger"); if (buttonElement) setButtonLoading(buttonElement, false); });
        }, 300);
    };
    const loadData = uid => {
        const userDocRef = fbDb.collection('users').doc(uid);
        if (unsubscribeFromDb) unsubscribeFromDb();
        unsubscribeFromDb = userDocRef.onSnapshot(doc => {
            let dataNeedsMigration = false;
            if (doc.exists && doc.data().db) {
                db = doc.data().db;
                if (!db.presupuestos) { db.presupuestos = []; dataNeedsMigration = true; }
                if (!db.config?.beneficiarios?.length || db.config.beneficiarios.includes('ComÃºn') || db.config.beneficiarios.includes('comÃºn')) { 
                    db.config.beneficiarios = ["Dani", "Norma"]; 
                    dataNeedsMigration = true; 
                }
                if (!db.config.visibleOwners) { db.config.visibleOwners = (db.config.beneficiarios || []).filter(b => b.toLowerCase() !== 'comÃºn' && b.toLowerCase() !== 'comun'); dataNeedsMigration = true; }
                if (db.config.skipIntro === undefined) { db.config.skipIntro = false; dataNeedsMigration = true; }
                if ((db.movimientos || []).some(m => !Number.isInteger(m.cantidad))) { (db.movimientos || []).forEach(m => m.cantidad = Math.round((parseFloat(m.cantidad) || 0) * 100)); dataNeedsMigration = true; showToast("Migrando datos de movimientos...", "info"); }
                if ((db.presupuestos || []).some(p => !Number.isInteger(p.cantidad))) { (db.presupuestos || []).forEach(p => p.cantidad = Math.round((parseFloat(p.cantidad) || 0) * 100)); dataNeedsMigration = true; showToast("Migrando datos de presupuestos...", "info"); }
                localStorage.setItem('skipIntro', db.config.skipIntro);
            } else { 
                db = getInitialDb(); 
                dataNeedsMigration = true; 
                localStorage.setItem('skipIntro', 'false');
            }
            if (dataNeedsMigration) saveData();
            startMainApp();
        }, error => { console.error("Error con Firestore:", error); showToast("Error de conexiÃ³n.", "danger"); });
    };

    // =================================================================================
    // 3. UI UTILITIES & HELPERS
    // =================================================================================
    const select = id => document.getElementById(id), selectAll = s => document.querySelectorAll(s);
    const vibrate = (d=10) => { if ('vibrate' in navigator) { try { navigator.vibrate(d); } catch (e) {} } };
    const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
    const formatCurrency = numInCents => ((numInCents || 0) / 100).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const showToast = (message, type = 'default', duration = 3000) => {
        const c = select('toast-container'); if (!c) return;
        const t = document.createElement('div'); t.className = `toast toast--${type}`; t.textContent = message; t.style.animation = `pop-in 0.3s, fade-in 0.3s ${duration / 1000 - 0.3}s reverse forwards`; c.appendChild(t); setTimeout(() => t.remove(), duration);
    };
    const setButtonLoading = (btn, isLoading, text = 'Cargando...') => {
        if (!btn) return;
        if (isLoading) { if (!originalButtonTexts.has(btn)) originalButtonTexts.set(btn, btn.innerHTML); btn.disabled = true; btn.classList.add('btn--loading'); btn.innerHTML = `<span class="spinner"></span> <span>${text}</span>`;
        } else { btn.disabled = false; btn.classList.remove('btn--loading'); if (originalButtonTexts.has(btn)) { btn.innerHTML = originalButtonTexts.get(btn); originalButtonTexts.delete(btn); } }
    };
    const displayError = (id, msg) => { const err = select(`${id}-error`); if (err) { err.textContent = msg; err.setAttribute('role', 'alert'); } const inp = select(id); if (inp) inp.classList.add('form-input--invalid'); };
    const clearError = id => { const err = select(`${id}-error`); if (err) { err.textContent = ''; err.removeAttribute('role'); } const inp = select(id); if (inp) inp.classList.remove('form-input--invalid'); };
    const clearAllErrors = formId => { const f = select(formId); if (!f) return; f.querySelectorAll('.form-error').forEach(e => e.textContent = ''); f.querySelectorAll('.form-input--invalid').forEach(e => e.classList.remove('form-input--invalid')); };
    const animateCountUp = (el, end, duration = 700) => {
        if (!el) return;
        const start = parseInt(el.dataset.currentValue || '0', 10);
        
        if (start === end || !el.offsetParent) {
            if (el.id === 'kpi-ingresos-value') el.textContent = `+${formatCurrency(end)} â¬`;
            else el.textContent = `${formatCurrency(end)} â¬`;
            el.dataset.currentValue = end;
            return;
        }

        el.dataset.currentValue = end;
        let startTime = null;

        const step = (timestamp) => {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            const currentValue = Math.floor(progress * (end - start) + start);

            if (el.id === 'kpi-ingresos-value') el.textContent = `+${formatCurrency(currentValue)} â¬`;
            else el.textContent = `${formatCurrency(currentValue)} â¬`;

            if (progress < 1) {
                requestAnimationFrame(step);
            } else {
                if (el.id === 'kpi-ingresos-value') el.textContent = `+${formatCurrency(end)} â¬`;
                else el.textContent = `${formatCurrency(end)} â¬`;
            }
        };
        requestAnimationFrame(step);
    };


    // =================================================================================
    // 4. APP INITIALIZATION & AUTH
    // =================================================================================
    const initApp = async () => {
        setupTheme();
        attachEventListeners();
        Chart.register(ChartDataLabels);

        const intro = select('introScreen');
        const quoteContainer = select('quoteContainer');

        if (localStorage.getItem('skipIntro') === 'true') {
            if (intro) intro.remove();
        } else if (intro && quoteContainer && quotesData.length) {
            const r = quotesData[Math.floor(Math.random() * quotesData.length)];
            select('quoteText').textContent = `"${r.cita}"`;
            select('quoteAuthor').textContent = `â ${r.autor}`;
            await wait(2500);
            quoteContainer.classList.add('visible');
            await wait(4000);
            intro.style.opacity = '0';
            await wait(750);
            intro.remove();
        } else if (intro) {
            intro.remove();
        }

        checkAuthState();
    };
    const checkAuthState = () => fbAuth.onAuthStateChanged(user => { if (user) { currentUser = user; loadData(user.uid); } else { currentUser = null; if (unsubscribeFromDb) unsubscribeFromDb(); db = getInitialDb(); showLoginScreen(); } });
    const startMainApp = () => { select('login-screen').classList.remove('login-view--visible'); select('app-root').classList.add('app-layout--visible'); renderAll(); navigateTo('panel-control-page', true); };
    const showLoginScreen = () => { select('app-root').classList.remove('app-layout--visible'); select('login-screen').classList.add('login-view--visible'); };
    const handleLogin = btn => {
        vibrate();
        const email = select('login-email').value.trim(), password = select('login-password').value, errEl = select('login-error'); clearAllErrors('login-form'); errEl.textContent = ''; let v = true;
        if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
        if (!password) { displayError('login-password', 'La contraseÃ±a es obligatoria.'); v = false; }
        if (!v) return; setButtonLoading(btn, true, 'Iniciando...');
        fbAuth.signInWithEmailAndPassword(email, password).then(() => showToast(`Â¡Bienvenido/a de nuevo!`)).catch(err => { setButtonLoading(btn, false); if (['auth/wrong-password', 'auth/user-not-found', 'auth/invalid-credential'].includes(err.code)) errEl.textContent = 'Error: Credenciales incorrectas.'; else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no vÃ¡lido.'); else errEl.textContent = 'Error al iniciar sesiÃ³n.'; });
    };
    const handleRegister = btn => {
        vibrate();
        const email = select('login-email').value.trim(), password = select('login-password').value, errEl = select('login-error'); clearAllErrors('login-form'); errEl.textContent = ''; let v = true;
        if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
        if (password.length < 6) { displayError('login-password', 'La contraseÃ±a debe tener al menos 6 caracteres.'); v = false; }
        if (!v) return; setButtonLoading(btn, true, 'Registrando...');
        fbAuth.createUserWithEmailAndPassword(email, password).then(() => showToast(`Â¡Registro completado!`)).catch(err => { setButtonLoading(btn, false); if (err.code == 'auth/weak-password') displayError('login-password', 'La contraseÃ±a debe tener al menos 6 caracteres.'); else if (err.code == 'auth/email-already-in-use') displayError('login-email', 'El correo ya estÃ¡ registrado.'); else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no vÃ¡lido.'); else errEl.textContent = 'Error en el registro.'; });
    };
    const handleExitApp = () => {
        vibrate();
        const appRoot = select('app-root');
        const exitScreen = select('exit-screen');
        if (appRoot) {
            appRoot.style.opacity = '0';
            appRoot.style.transition = 'opacity 0.5s ease';
        }
        if (exitScreen) {
            exitScreen.style.display = 'flex';
            setTimeout(() => exitScreen.style.opacity = '1', 50);
        }
    };
    
    // =================================================================================
    // 5. NAVIGATION & UI CONTROL
    // =================================================================================
    const navigateTo = (pageId, isInitial = false) => {
        if (!isInitial) vibrate();
        
        const titleEl = select('top-bar-title');
        const actionsEl = select('top-bar-actions');
        const standardActions = `
            <button data-action="ai-advisor" class="icon-btn" title="Asesor IA"><span class="material-icons">psychology_alt</span></button>
            <button data-action="theme-toggle" class="icon-btn" title="Cambiar Tema"><span class="material-icons">${document.documentElement.getAttribute('data-theme') === 'dark' ? 'light_mode' : 'dark_mode'}</span></button>
            <button data-action="exit" class="icon-btn" title="Salir"><span class="material-icons">exit_to_app</span></button>
        `;
        const searchAction = `<input type="search" id="search-movimientos" class="form-input" placeholder="Buscar..." style="width: 150px; height: 34px; font-size: var(--fs-sm);">`;

        switch(pageId) {
            case 'panel-control-page': titleEl.textContent = 'Panel'; actionsEl.innerHTML = standardActions; break;
            case 'movimientos-page': 
                titleEl.textContent = 'Movimientos'; 
                actionsEl.innerHTML = searchAction; 
                select('search-movimientos')?.addEventListener('input', e => { clearTimeout(window.debounceTimer); window.debounceTimer = setTimeout(() => renderMovimientos(), 250); }); 
                break;
            case 'cuentas-page': titleEl.textContent = 'Cuentas'; actionsEl.innerHTML = standardActions; break;
            case 'presupuestos-page': 
                titleEl.textContent = 'Presupuestos'; 
                actionsEl.innerHTML = standardActions; 
                setTimeout(() => renderBudgetTracking(), 0);
                break;
            case 'configuracion-page': titleEl.textContent = 'ConfiguraciÃ³n'; actionsEl.innerHTML = standardActions; break;
        }

        selectAll('.view').forEach(p => p.classList.remove('view--active'));
        select(pageId)?.classList.add('view--active');
        
        selectAll('.bottom-nav__item').forEach(b => {
            b.classList.toggle('bottom-nav__item--active', b.dataset.page === pageId);
            if (b.dataset.page === pageId) b.setAttribute('aria-current', 'page'); else b.removeAttribute('aria-current');
        });
        
        const fabVisiblePages = ['panel-control-page', 'movimientos-page', 'cuentas-page', 'presupuestos-page'];
        select('fab-add-movimiento').classList.toggle('fab--visible', fabVisiblePages.includes(pageId));
    };

    const setupTheme = () => { 
        const theme = localStorage.getItem('theme') || 'dark'; 
        document.documentElement.setAttribute('data-theme', theme); 
        selectAll('button[data-action="theme-toggle"] .material-icons').forEach(icon => icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode');
        const gridColor = theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = theme === 'dark' ? '#F9FAFB' : '#1F2937';
        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;
    };
    const toggleTheme = () => { 
        vibrate(); 
        const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; 
        document.documentElement.setAttribute('data-theme', newTheme); 
        localStorage.setItem('theme', newTheme); 
        setupTheme();
        renderCuentas();
        updateDashboard();
    };
    
    // =================================================================================
    // 6. CORE LOGIC & CALCULATIONS
    // =================================================================================
    const getVisibleOwners = () => db.config?.visibleOwners || (db.config?.beneficiarios || []).filter(b => b.toLowerCase() !== 'comÃºn' && b.toLowerCase() !== 'comun');
    const getLiquidAccounts = () => (db.cuentas || []).filter(c => !['PROPIEDAD', 'PRÃSTAMO'].includes((c.tipo || '').trim().toUpperCase()));
    
    const getSaldos = () => {
        const saldos = (db.cuentas || []).reduce((acc, c) => ({ ...acc, [c.id]: 0 }), {});
        (db.movimientos || []).forEach(m => {
            if (m.tipo === 'traspaso') { if (saldos[m.cuentaOrigenId] !== undefined) saldos[m.cuentaOrigenId] -= m.cantidad; if (saldos[m.cuentaDestinoId] !== undefined) saldos[m.cuentaDestinoId] += m.cantidad;
            } else { if (saldos[m.cuentaId] !== undefined) saldos[m.cuentaId] += m.cantidad; }
        }); return saldos;
    };

    const calculateRunningBalancesForAll = (movements) => {
        const movs = JSON.parse(JSON.stringify(movements || []));
        movs.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
        const runningBalances = (db.cuentas || []).reduce((acc, c) => ({ ...acc, [c.id]: 0 }), {});
        movs.forEach(mov => {
            if (mov.tipo === 'traspaso') {
                if (runningBalances.hasOwnProperty(mov.cuentaOrigenId)) runningBalances[mov.cuentaOrigenId] -= mov.cantidad;
                if (runningBalances.hasOwnProperty(mov.cuentaDestinoId)) runningBalances[mov.cuentaDestinoId] += mov.cantidad;
                mov.saldoPostMovimiento = runningBalances[mov.cuentaOrigenId];
                mov.saldoPostMovimientoDestino = runningBalances[mov.cuentaDestinoId];
            } else if (mov.tipo === 'movimiento') {
                if (runningBalances.hasOwnProperty(mov.cuentaId)) {
                    runningBalances[mov.cuentaId] += mov.cantidad;
                    mov.saldoPostMovimiento = runningBalances[mov.cuentaId];
                }
            }
        });
        return movs;
    };

    const getFilteredMovements = () => {
        const p = select('filter-periodo').value, b = select('filter-beneficiario').value, cId = select('filter-cuenta').value, coId = select('filter-concepto').value; let sDate, eDate, now = new Date();
        switch (p) { case 'mes-actual': sDate=new Date(now.getFullYear(),now.getMonth(),1); eDate=new Date(now.getFullYear(),now.getMonth()+1,0,23,59,59,999); break; case 'ano-actual': sDate=new Date(now.getFullYear(),0,1); eDate=new Date(now.getFullYear(),11,31,23,59,59,999); break; case 'custom': const sVal=select('filter-fecha-inicio').value, eVal=select('filter-fecha-fin').value; sDate=sVal?new Date(sVal):null; if(sDate)sDate.setHours(0,0,0,0); eDate=eVal?new Date(eVal):null; if(eDate)eDate.setHours(23,59,59,999); break; default: sDate=null; eDate=null; break; }
        
        const visibleOwners = getVisibleOwners();
        let f = (db.movimientos || []).filter(m => {
            const owner = m.beneficiario || '';
            return visibleOwners.includes(owner) || owner.toLowerCase() === 'comÃºn' || owner.toLowerCase() === 'comun';
        });

        if (sDate && eDate) f = f.filter(m => { const d = new Date(m.fecha); return d >= sDate && d <= eDate; });
        if (b) f = f.filter(m => m.beneficiario === b); if (coId) f = f.filter(m => m.conceptoId === coId);
        if (cId) f = f.filter(m => m.cuentaId === cId || m.cuentaOrigenId === cId || m.cuentaDestinoId === cId);
        
        return f.filter(m => ['movimiento', 'traspaso'].includes(m.tipo));
    };

    // =================================================================================
    // 7. RENDERING ENGINE & BUDGET FUNCTIONS
    // =================================================================================
    const renderAll = () => { if (!db || !currentUser) return; populateAllDropdowns(); renderMovimientos(); renderCuentas(); loadConfig(); updateDashboard(); };
    const populateAllDropdowns = () => {
        const populate = (id, data, nameKey, valKey='id', all=false, none=false) => {
            const el = select(id); if (!el) return; const currentVal = el.value;
            let opts = all ? '<option value="">Todos</option>' : ''; if (none) opts += '<option value="">Ninguno</option>';
            [...data].sort((a,b) => (a[nameKey]||"").localeCompare(b[nameKey]||"")).forEach(i => opts += `<option value="${i[valKey]}">${i[nameKey]}</option>`);
            el.innerHTML = opts; el.value = Array.from(el.options).some(o=>o.value===currentVal) ? currentVal : (el.options[0]?.value || "");
        };

        const allBeneficiarios = (db.config?.beneficiarios || []).map(b => ({id:b, nombre:b})).filter(b => b.nombre.toLowerCase() !== 'comÃºn' && b.nombre.toLowerCase() !== 'comun');
        
        populate('movimiento-beneficiario', allBeneficiarios, 'nombre', 'id');
        populate('filter-beneficiario', allBeneficiarios, 'nombre', 'id', true);
        populate('movimiento-cuenta', db.cuentas, 'nombre', 'id', false, true); 
        populate('movimiento-cuenta-origen', db.cuentas, 'nombre', 'id', false, true); 
        populate('movimiento-cuenta-destino', db.cuentas, 'nombre', 'id', false, true);
        populate('filter-cuenta', db.cuentas, 'nombre', 'id', true); 
        populate('movimiento-concepto', db.conceptos, 'nombre', 'id', false, true);
        populate('filter-concepto', db.conceptos, 'nombre', 'id', true);
        
        // Populate budget dropdowns
        const budgetOwnerSelect = select('budget-owner-selector');
        if(budgetOwnerSelect) {
            const currentVal = budgetOwnerSelect.value;
            budgetOwnerSelect.innerHTML = allBeneficiarios.map(b => `<option value="${b.id}">${b.nombre}</option>`).join('');
            if(currentVal && allBeneficiarios.some(b => b.id === currentVal)) budgetOwnerSelect.value = currentVal;
        }

        const budgetYearSelect = select('budget-year-selector');
        if(budgetYearSelect) {
            const currentVal = budgetYearSelect.value;
            const currentYear = new Date().getFullYear();
            let years = new Set([currentYear]);
            (db.presupuestos || []).forEach(p => years.add(p.ano));
            budgetYearSelect.innerHTML = [...years].sort((a,b) => b-a).map(y => `<option value="${y}">${y}</option>`).join('');
            if(currentVal && [...years].some(y => y == currentVal)) budgetYearSelect.value = currentVal; else budgetYearSelect.value = currentYear;
        }
    };

    const handleCreateBudgets = (owner, year, btn) => {
        vibrate();
        if (btn) setButtonLoading(btn, true, 'Creando...');

        const existingBudgets = new Set((db.presupuestos || [])
            .filter(p => p.ano === year && p.beneficiario === owner)
            .map(p => p.conceptoId)
        );

        const newBudgets = [];
        db.conceptos.forEach(concepto => {
            if (!existingBudgets.has(concepto.id)) {
                newBudgets.push({
                    id: generateId(),
                    ano: year,
                    beneficiario: owner,
                    conceptoId: concepto.id,
                    cantidad: 0 // Default limit 0.00 â¬
                });
            }
        });

        if (newBudgets.length > 0) {
            db.presupuestos.push(...newBudgets);
            saveData(null, () => {
                if (btn) setButtonLoading(btn, false);
                showToast(`Presupuestos para ${owner} ${year} creados.`);
                renderBudgetTracking();
            });
        } else {
            if (btn) setButtonLoading(btn, false);
            showToast(`Todos los presupuestos para ${owner} ${year} ya existÃ­an.`, 'info');
            renderBudgetTracking();
        }
    };

    const handleUpdateBudgets = () => {
        vibrate();
        const owner = select('budget-owner-selector').value;
        const year = parseInt(select('budget-year-selector').value);
        if(!owner || !year) {
            showToast('Selecciona un propietario y un aÃ±o.', 'warning');
            return;
        }

        const budgetsToUpdate = (db.presupuestos || []).filter(p => p.ano === year && p.beneficiario === owner);
        
        let formHtml = `<form id="update-budgets-form" novalidate><p class="form-label" style="margin-bottom: var(--sp-3)">Introduce el lÃ­mite anual para cada concepto. Usa valores positivos para lÃ­mites de gasto.</p>`;
        
        const conceptsWithBudget = new Set(budgetsToUpdate.map(b => b.conceptoId));

        // Display existing budgets first
        db.conceptos.filter(c => conceptsWithBudget.has(c.id)).sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(c => {
            const budget = budgetsToUpdate.find(b => b.conceptoId === c.id);
            const currentAmount = budget ? (budget.cantidad / 100).toFixed(2) : '0.00';
            formHtml += `
                <div class="form-group">
                    <label for="budget-input-${c.id}" class="form-label" style="font-weight: 600;">${c.nombre}</label>
                    <input type="text" id="budget-input-${c.id}" data-concept-id="${c.id}" class="form-input" inputmode="decimal" value="${currentAmount.replace('.', ',')}">
                </div>`;
        });
        
        // Option to add missing budgets
        const missingConcepts = db.conceptos.filter(c => !conceptsWithBudget.has(c.id));
        if(missingConcepts.length > 0) {
             formHtml += `<hr style="margin: var(--sp-4) 0; border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-bottom: var(--sp-2);">AÃ±adir nuevos conceptos al presupuesto</h4>`
             missingConcepts.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(c => {
                 formHtml += `
                <div class="form-group">
                    <label for="budget-input-${c.id}" class="form-label" style="font-weight: 600;">${c.nombre}</label>
                    <input type="text" id="budget-input-${c.id}" data-concept-id="${c.id}" class="form-input" inputmode="decimal" placeholder="0,00">
                </div>`;
             });
        }

        formHtml += `<div class="modal__actions"><button type="submit" class="btn btn--primary btn--full">Guardar Cambios</button></div></form>`;
        
        showGenericModal(`Gestionar Presupuestos de ${owner} ${year}`, formHtml);

        setTimeout(() => {
            const modalForm = select('update-budgets-form');
            if (modalForm) {
                modalForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const btn = modalForm.querySelector('button[type="submit"]');
                    setButtonLoading(btn, true, 'Guardando...');
                    const inputs = modalForm.querySelectorAll('input[data-concept-id]');
                    inputs.forEach(input => {
                        const conceptoId = input.dataset.conceptId;
                        const newAmountStr = input.value.trim().replace(/\./g, '').replace(',', '.');
                        
                        if (newAmountStr === '') return; // Skip empty inputs

                        const newAmountInCents = Math.round(parseFloat(newAmountStr) * 100);

                        if (!isNaN(newAmountInCents)) {
                            let budget = (db.presupuestos || []).find(b => b.ano === year && b.beneficiario === owner && b.conceptoId === conceptoId);
                            if (budget) {
                                budget.cantidad = newAmountInCents;
                            } else { // Create new budget if it didn't exist
                                 db.presupuestos.push({
                                    id: generateId(),
                                    ano: year,
                                    beneficiario: owner,
                                    conceptoId: conceptoId,
                                    cantidad: newAmountInCents
                                });
                            }
                        }
                    });
                    saveData(btn, () => {
                        hideModal('generic-modal');
                        showToast('Presupuestos actualizados.');
                        renderBudgetTracking();
                    });
                });
            }
        }, 0);
    };

    const renderBudgetTracking = () => {
        const listContainer = select('budget-tracking-list');
        const placeholder = select('budget-init-placeholder');
        const ownerSelector = select('budget-owner-selector');
        const yearSelector = select('budget-year-selector');

        if (!listContainer || !placeholder || !ownerSelector || !yearSelector) return;
        
        const owner = ownerSelector.value;
        const year = parseInt(yearSelector.value, 10);
        
        if (!owner || !year) {
             listContainer.classList.add('hidden');
             placeholder.classList.add('hidden');
             return;
        }

        const ownerBudgets = (db.presupuestos || []).filter(b => b.ano === year && b.beneficiario === owner);

        if (ownerBudgets.length === 0) {
            listContainer.classList.add('hidden');
            placeholder.classList.remove('hidden');
            select('budget-placeholder-title').textContent = `Crear Presupuestos ${year}`;
            select('budget-placeholder-text').textContent = `AÃºn no se han creado los presupuestos para ${owner} en ${year}.`;
            return;
        }

        listContainer.classList.remove('hidden');
        placeholder.classList.add('hidden');

        let html = '';
        ownerBudgets.sort((a,b) => {
            const nameA = db.conceptos.find(c => c.id === a.conceptoId)?.nombre || '';
            const nameB = db.conceptos.find(c => c.id === b.conceptoId)?.nombre || '';
            return nameA.localeCompare(nameB);
        }).forEach(budget => {
            const concepto = db.conceptos.find(c => c.id === budget.conceptoId);
            if (!concepto) return;

            const actualAmount = db.movimientos
                .filter(m =>
                    new Date(m.fecha).getFullYear() === year &&
                    m.conceptoId === budget.conceptoId &&
                    m.tipo === 'movimiento'
                )
                .reduce((sum, m) => {
                    const cuentaDeOrigen = db.cuentas.find(c => c.id === m.cuentaId);
                    if (cuentaDeOrigen && cuentaDeOrigen.propietario === owner) {
                        return sum + m.cantidad;
                    }
                    return sum;
                }, 0);
            
            const isExpenseBudget = budget.cantidad >= 0;
            const actualSpent = Math.abs(actualAmount);
            
            let difference, diffClass, progressValue, progressMax;
            
            if (isExpenseBudget) {
                difference = budget.cantidad - actualSpent;
                diffClass = difference >= 0 ? 'budget-track-item__diff--positive' : 'budget-track-item__diff--negative';
                progressValue = actualSpent;
                progressMax = budget.cantidad;
            } else { // Legacy income budget (not primary use case now)
                difference = actualSpent - Math.abs(budget.cantidad);
                diffClass = difference >= 0 ? 'budget-track-item__diff--positive' : 'budget-track-item__diff--negative';
                progressValue = actualSpent;
                progressMax = Math.abs(budget.cantidad);
            }

            const percentage = progressMax > 0 ? (progressValue / progressMax) * 100 : 0;
            let progressClass = '';
            if (isExpenseBudget) {
                 if (percentage > 100) progressClass = 'budget-item__progress--danger';
                 else if (percentage >= 85) progressClass = 'budget-item__progress--warning';
            }

            html += `
                <div class="budget-track-item">
                    <div class="budget-track-item__header">
                        <span class="budget-track-item__concept-name">${concepto.nombre}</span>
                        <span class="${diffClass}">${difference >= 0 ? 'Disp:' : 'Exceso:'} ${formatCurrency(difference)} â¬</span>
                    </div>
                    <div class="budget-track-item__details">
                        <span>Gastado: <strong>${formatCurrency(actualSpent)} â¬</strong></span>
                        <span>LÃ­mite: <strong>${formatCurrency(budget.cantidad)} â¬</strong></span>
                    </div>
                    <progress class="budget-item__progress ${progressClass}" value="${progressValue}" max="${progressMax > 0 ? progressMax : 1}"></progress>
                </div>`;
        });

        listContainer.innerHTML = html;
    };

    const renderMovementRow = (item) => {
        if (item.type === 'header') {
            return `<div class="movimiento-group-header">
                        <span>${item.formattedDate}</span>
                        <span>${formatCurrency(item.total)} â¬</span>
                    </div>`;
        }
        
        const m = item.movement;
        const oClass = m.beneficiario ? `transaction-card--owner-${m.beneficiario.toLowerCase().replace('Ãº','u')}` : '';
        const amountIcon = m.cantidad < 0 ? `<span class="material-icons" style="font-size: inherit; vertical-align: middle; margin-left: 2px; color: var(--c-danger);">north_east</span>` : '';
        
        const amount = m.tipo === 'traspaso' 
            ? `<span class="text-info">${formatCurrency(m.cantidad)} â¬</span>` 
            : (m.cantidad < 0 
                ? `<span class="text-negative">${formatCurrency(m.cantidad)} â¬ ${amountIcon}</span>` 
                : `<span class="text-positive">+${formatCurrency(m.cantidad)} â¬</span>`);
        
        let meta = '';
        let saldoHtml = '';

        if (m.tipo === 'traspaso') {
            const origen = db.cuentas.find(c=>c.id===m.cuentaOrigenId)?.nombre||'?';
            const destino = db.cuentas.find(c=>c.id===m.cuentaDestinoId)?.nombre||'?';
            meta = `Traspaso: ${origen} â ${destino}`;
        } else {
            const cuenta = db.cuentas.find(c => c.id === m.cuentaId);
            if (cuenta) {
                meta = `${cuenta.propietario} - ${cuenta.nombre}`;
                if (m.hasOwnProperty('saldoPostMovimiento')) {
                    saldoHtml = `<div style="font-size: 0.7rem; color: var(--c-on-surface-secondary); margin-top: 2px;">${formatCurrency(m.saldoPostMovimiento)} â¬</div>`;
                }
            }
        }
        
        const tagHtml = m.beneficiario ? `<div class="transaction-card__tags"><span class="transaction-card__tag">${m.beneficiario}</span></div>` : '';
        
        const mainTitle = m.descripcion;

        return `<div class="transaction-card ${oClass}" data-id="${m.id}">
                    <div class="transaction-card__actions transaction-card__actions--left"><button class="icon-btn" data-action="copy-movement-swipe" title="Copiar"><span class="material-icons">content_copy</span></button></div>
                    <div class="transaction-card__swipe-content" data-action="edit-movement" data-id="${m.id}">
                        <div class="transaction-card__details">
                            <div class="transaction-card__description">${mainTitle}</div>
                            <div class="transaction-card__meta">${meta}</div>
                             ${tagHtml}
                        </div>
                        <div class="transaction-card__amount">
                            ${amount}
                            ${saldoHtml}
                        </div>
                    </div>
                    <div class="transaction-card__actions transaction-card__actions--right"><button class="icon-btn" data-action="delete-movement-swipe" title="Eliminar"><span class="material-icons">delete</span></button></div>
                </div>`;
    };

    const renderVisibleItems = () => {
        if (!vList.containerEl) return;
        const scrollTop = vList.containerEl.scrollTop;
        const containerHeight = vList.containerEl.clientHeight;

        let startIndex = -1, endIndex = -1;
        for (let i = 0; i < vList.itemMap.length; i++) {
            const item = vList.itemMap[i];
            if (startIndex === -1 && item.offset + item.height > scrollTop) {
                startIndex = Math.max(0, i - vList.renderBuffer);
            }
            if (endIndex === -1 && item.offset + item.height > scrollTop + containerHeight) {
                endIndex = Math.min(vList.itemMap.length - 1, i + vList.renderBuffer);
                break;
            }
        }
        if (startIndex === -1) startIndex = 0;
        if (endIndex === -1) endIndex = vList.itemMap.length - 1;

        if (startIndex === vList.lastRenderedRange.start && endIndex === vList.lastRenderedRange.end) return;

        let visibleHtml = '';
        for (let i = startIndex; i <= endIndex; i++) {
            if (vList.items[i]) {
                visibleHtml += renderMovementRow(vList.items[i]);
            }
        }
        
        vList.contentEl.innerHTML = visibleHtml;
        const offsetY = vList.itemMap[startIndex]?.offset || 0;
        vList.contentEl.style.transform = `translateY(${offsetY}px)`;
        vList.lastRenderedRange = { start: startIndex, end: endIndex };
    };

    const renderMovimientos = () => {
        const emptyEl = select('empty-movimientos');
        if (!vList.containerEl) {
            vList.containerEl = select('movimientos-list-container');
            vList.sizerEl = select('virtual-list-sizer');
            vList.contentEl = select('virtual-list-content');
            if(vList.containerEl) {
                vList.containerEl.addEventListener('scroll', () => {
                    if (vList.isScrolling) cancelAnimationFrame(vList.isScrolling);
                    vList.isScrolling = requestAnimationFrame(renderVisibleItems);
                });
            }
        }
        if (!vList.containerEl || !emptyEl) return;

        const allMovementsWithBalances = calculateRunningBalancesForAll(db.movimientos);
        const visibleOwners = getVisibleOwners();
        const filterText = (select('search-movimientos')?.value || '').toLowerCase();
        
        const filtered = allMovementsWithBalances.filter(m => {
            const cuenta = db.cuentas.find(c => c.id === m.cuentaId || c.id === m.cuentaOrigenId);
            const owner = cuenta?.propietario || m.beneficiario || '';
            const isOwnerVisible = visibleOwners.includes(owner);
            if (!isOwnerVisible) return false;
            if (filterText) {
                const concept = db.conceptos.find(c => c.id === m.conceptoId)?.nombre || '';
                const acc = m.tipo === 'traspaso' 
                    ? `${db.cuentas.find(c => c.id === m.cuentaOrigenId)?.nombre || ''} ${db.cuentas.find(c => c.id === m.cuentaDestinoId)?.nombre || ''}` 
                    : (db.cuentas.find(c => c.id === m.cuentaId)?.nombre || '');
                return m.descripcion.toLowerCase().includes(filterText) || concept.toLowerCase().includes(filterText) || acc.toLowerCase().includes(filterText);
            }
            return true;
        }).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        if (filtered.length === 0) {
            vList.containerEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
            emptyEl.querySelector('p').textContent = filterText ? 'No hay movimientos que coincidan.' : 'AÃ±ade tu primer movimiento.';
            return;
        }
        
        vList.containerEl.classList.remove('hidden');
        emptyEl.classList.add('hidden');
        
        const groupedByDay = filtered.reduce((acc, mov) => {
            const dateStr = new Date(mov.fecha).toLocaleDateString('es-ES');
            if (!acc[dateStr]) acc[dateStr] = { movements: [], total: 0 };
            acc[dateStr].movements.push(mov);
            if (mov.cantidad < 0 && mov.tipo !== 'traspaso') acc[dateStr].total += mov.cantidad;
            return acc;
        }, {});
        
        vList.items = [];
        vList.itemMap = [];
        let totalHeight = 0;

        for (const dateStr in groupedByDay) {
            const group = groupedByDay[dateStr];
            const dateObj = new Date(group.movements[0].fecha);
            const formattedHeader = new Intl.DateTimeFormat('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }).format(dateObj);

            const headerItem = { type: 'header', formattedDate: formattedHeader.toUpperCase(), total: group.total };
            vList.items.push(headerItem);
            vList.itemMap.push({ height: vList.heights.header, offset: totalHeight });
            totalHeight += vList.heights.header;

            group.movements.forEach(mov => {
                const transactionItem = { type: 'transaction', movement: mov };
                vList.items.push(transactionItem);
                vList.itemMap.push({ height: vList.heights.transaction, offset: totalHeight });
                totalHeight += vList.heights.transaction;
            });
        }
        
        vList.sizerEl.style.height = `${totalHeight}px`;
        vList.lastRenderedRange = { start: -1, end: -1 };
        renderVisibleItems();
    };

    const renderCuentas = () => {
        const resCont = select('resumen-propietario-container'), pillsCont = select('filter-account-types-pills');
        if (!resCont || !pillsCont) return;

        if (fondosDaniChart) fondosDaniChart.destroy();
        if (fondosNormaChart) fondosNormaChart.destroy();

        const saldos = getSaldos();
        const allAccounts = db.cuentas || [];
        const allLiquidAccountTypes = [...new Set(getLiquidAccounts().map(c => (c.tipo || 'S/T').toUpperCase()))].sort();
        
        pillsCont.innerHTML = allLiquidAccountTypes.map(t => `<button class="filter-pill ${!deselectedAccountTypesFilter.has(t) ? 'filter-pill--active' : ''}" data-action="toggle-account-type-filter" data-type="${t}">${t}</button>`).join('') || `<p style="font-size:var(--fs-xs); color:var(--c-on-surface-secondary)">No hay cuentas lÃ­quidas.</p>`;
        
        const filteredAccountTypes = new Set(allLiquidAccountTypes.filter(t => !deselectedAccountTypesFilter.has(t)));
        const visibleOwners = getVisibleOwners();
        
        resCont.innerHTML = (db.config.beneficiarios || [])
            .filter(owner => visibleOwners.includes(owner))
            .map(owner => {
                const ownerAccounts = allAccounts.filter(c => c.propietario === owner);
                
                let totalOwnerLiquidFunds = 0;
                ownerAccounts.filter(c => filteredAccountTypes.has((c.tipo || 'S/T').toUpperCase())).forEach(c => totalOwnerLiquidFunds += (saldos[c.id] || 0));
                
                const accountsByType = ownerAccounts.reduce((acc, c) => {
                    const tipo = (c.tipo || 'S/T').toUpperCase();
                    if (!acc[tipo]) acc[tipo] = [];
                    acc[tipo].push(c);
                    return acc;
                }, {});

                const typesHtml = Object.keys(accountsByType).sort().map(tipo => {
                    const accountsInType = accountsByType[tipo];
                    let typeBalance = 0;
                    
                    const accountsHtml = accountsInType
                        .sort((a,b) => a.nombre.localeCompare(b.nombre))
                        .map(c => {
                            const balance = saldos[c.id] || 0;
                            typeBalance += balance;
                            
                            let amountHTML = `<strong>${formatCurrency(balance)} â¬</strong>`;
                            if (tipo === 'PRÃSTAMO') amountHTML = `<strong class="text-warning">${formatCurrency(Math.abs(balance))} â¬</strong>`;

                            return `<div class="modal__list-item" data-action="view-account-details" data-id="${c.id}" style="cursor: pointer;">
                                        <div>
                                            <span style="display: block; font-weight: 500;">${c.nombre}</span>
                                            <small style="color: var(--c-on-surface-secondary); font-size: var(--fs-xs);">${c.propietario}</small>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: var(--sp-2);">
                                            ${amountHTML}
                                            <span class="material-icons" style="font-size: 18px; color: var(--c-on-surface-secondary);">chevron_right</span>
                                        </div>
                                    </div>`;
                        }).join('');
                    
                    if (!accountsHtml) return '';
                    
                    const percentage = totalOwnerLiquidFunds > 0 && typeBalance > 0 ? (typeBalance / totalOwnerLiquidFunds) * 100 : 0;
                    const percentageHtml = percentage ? `<small style="font-weight: 500; color: var(--c-on-surface-secondary); font-size: 0.8rem; margin-left: 8px;">${percentage.toFixed(0)}%</small>` : '';

                    const icon = tipo==='EFECTIVO'?'payments':(tipo.includes('TARJETA')?'credit_card':(tipo==='AHORRO'?'savings':(tipo==='INVERSIÃN'?'trending_up':(tipo==='PROPIEDAD'?'domain':(tipo==='PRÃSTAMO'?'credit_score':'account_balance')))));

                    return `<details class="accordion">
                                <summary>
                                    <span>
                                        <span class="material-icons" style="vertical-align:bottom;font-size:18px;margin-right:8px">${icon}</span>
                                        <span class="cuentas-type-name">${tipo}</span>
                                    </span>
                                    <span style="display: flex; align-items: center;"><strong>${formatCurrency(typeBalance)} â¬</strong>${percentageHtml}<span class="material-icons accordion__icon">expand_more</span></span>
                                </summary>
                                <div class="accordion__content">${accountsHtml}</div>
                            </details>`;
                }).join('');

                const ownerLower = owner.toLowerCase();
                const chartContainer = select(`fondos-${ownerLower}-container`);
                const chartCtx = select(`fondos-${ownerLower}-chart`)?.getContext('2d');
                if (chartCtx && chartContainer) {
                    const saldosPorTipoChart = {};
                    ownerAccounts.filter(c => filteredAccountTypes.has((c.tipo || 'S/T').toUpperCase())).forEach(c => { const tipo = (c.tipo || 'S/T').toUpperCase(); saldosPorTipoChart[tipo] = (saldosPorTipoChart[tipo] || 0) + (saldos[c.id] || 0); });
                    const chartData = Object.entries(saldosPorTipoChart).filter(([,saldo]) => saldo > 0);
                    if (chartData.length > 0) {
                        chartContainer.classList.remove('hidden');
                        const chart = new Chart(chartCtx, { type: 'pie', data: { labels: chartData.map(([tipo]) => tipo), datasets: [{ data: chartData.map(([, saldo]) => saldo / 100), backgroundColor: ['#0A84FF', '#FF9500', '#34C759', '#5AC8FA', '#FF3B30', '#FF2D55'], borderColor: getComputedStyle(document.body).getPropertyValue('--c-surface'), borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { formatter: (v,c)=>{let s=c.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);return (v*100/s).toFixed(0)+"%";}, color: '#fff', textShadowColor: 'rgba(0,0,0,0.5)', textShadowBlur: 4, font: { weight: 'bold', size: 10 } } } } });
                        if (ownerLower === 'dani') fondosDaniChart = chart;
                        if (ownerLower === 'norma') fondosNormaChart = chart;
                    } else { chartContainer.classList.add('hidden'); }
                }

                const oClass = `owner-${ownerLower.replace('Ãº', 'u')}`;
                return `<details class="accordion" open>
                            <summary>
                                <span class="cuentas-owner-name" style="color:var(--c-${oClass})">${ownerLower === "dani" ? "ð¨âð¼" : "ð©âð¼"} ${owner}</span>
                                <span><strong style="color:var(--c-${oClass})">${formatCurrency(totalOwnerLiquidFunds)} â¬</strong><span class="material-icons accordion__icon">expand_more</span></span>
                            </summary>
                            <div class="accordion__content">${typesHtml || '<p style="text-align:center; padding: var(--sp-3) 0;">No hay cuentas para este filtro.</p>'}</div>
                        </details>`;
            }).join('');
    };

    const loadConfig = () => {
        select('config-beneficiarios').value = (db.config?.beneficiarios || []).join(', ');
        select('config-skip-intro').checked = !!db.config?.skipIntro;
        const ownersContainer = select('config-visible-owners-container'); if (!ownersContainer) return;
        const mainOwners = (db.config?.beneficiarios || []).filter(b => b.toLowerCase() !== 'comÃºn' && b.toLowerCase() !== 'comun');
        const visibleOwners = getVisibleOwners();
        ownersContainer.innerHTML = mainOwners.map(owner => `<div class="form-checkbox-group"><input type="checkbox" id="owner-vis-${owner}" value="${owner}" ${visibleOwners.includes(owner) ? 'checked' : ''}><label for="owner-vis-${owner}">${owner}</label></div>`).join('') || '<p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary);">No hay propietarios principales definidos.</p>';
    };

    const updateDashboard = () => {
        const kpiCont = select('kpi-container'), concCont = select('concepto-totals-list'), chartCtx = select('conceptos-chart')?.getContext('2d');
        if(!kpiCont || !concCont || !chartCtx) return;
        if (!kpiCont.innerHTML.trim()) { kpiCont.innerHTML = `<div class="kpi-item"><h4 class="kpi-item__label">Ingresos</h4><strong id="kpi-ingresos-value" class="kpi-item__value text-positive" data-current-value="0">+0,00 â¬</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Gastos</h4><strong id="kpi-gastos-value" class="kpi-item__value text-negative" data-current-value="0">0,00 â¬</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Saldo Neto</h4><strong id="kpi-saldo-value" class="kpi-item__value" data-current-value="0">0,00 â¬</strong></div>`; }
        concCont.innerHTML = Array(4).fill('<div class="skeleton" style="height: 48px; margin-bottom: 2px;"></div>').join('');
        setTimeout(() => {
            const movs = getFilteredMovements();
            const ing = movs.filter(m=>m.cantidad>0 && m.tipo!=='traspaso').reduce((s,m)=>s+m.cantidad,0), gas = movs.filter(m=>m.cantidad<0).reduce((s,m)=>s+m.cantidad,0), sal = ing+gas;
            const kpiSaldoValueEl = select('kpi-saldo-value'); if(kpiSaldoValueEl) { kpiSaldoValueEl.classList.remove('text-positive', 'text-negative'); kpiSaldoValueEl.classList.add(sal >= 0 ? 'text-positive' : 'text-negative'); }
            animateCountUp(select('kpi-ingresos-value'), ing); animateCountUp(select('kpi-gastos-value'), gas); animateCountUp(kpiSaldoValueEl, sal);
            const cTots = movs.reduce((a,m)=>{if(m.tipo==='movimiento'&&m.conceptoId){if(!a[m.conceptoId])a[m.conceptoId]={total:0,movements:[]};a[m.conceptoId].total+=m.cantidad;a[m.conceptoId].movements.push(m);}return a;},{});
            const sortedTotals = Object.entries(cTots).sort(([,a],[,b])=>a.total-b.total);
            if (conceptosChart) conceptosChart.destroy();
            const colorSuccess = getComputedStyle(document.body).getPropertyValue('--c-success').trim(), colorDanger = getComputedStyle(document.body).getPropertyValue('--c-danger').trim();
            conceptosChart = new Chart(chartCtx, { type: 'bar', data: { labels: sortedTotals.map(([id]) => db.conceptos.find(c=>c.id===id)?.nombre || '?'), datasets: [{ data: sortedTotals.map(([,data]) => data.total / 100), backgroundColor: sortedTotals.map(([,data]) => data.total >= 0 ? colorSuccess : colorDanger), borderRadius: 6, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { y: { ticks: { callback: value => `${value.toLocaleString('es-ES')}â¬` } } } } });
            concCont.innerHTML = sortedTotals.length===0?'<div class="empty-state" style="padding:16px 0; background:transparent;"><p>Sin datos para los filtros.</p></div>' : sortedTotals.map(([id, data]) => { const con = db.conceptos.find(c => c.id === id), t = data.total; return `<details class="accordion" style="background-color: var(--c-surface-variant);"><summary><span>${con?.nombre || '?'}</span><span><strong class="${t >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(t)} â¬</strong><span class="material-icons accordion__icon">expand_more</span></span></summary><div class="accordion__content">${data.movements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).map(mov => `<div class="transaction-card transaction-card--owner-${mov.beneficiario ? mov.beneficiario.toLowerCase().replace('Ãº', 'u') : ''}" data-action="edit-movement" data-id="${mov.id}"><div class="transaction-card__swipe-content" style="background:transparent;"><div class="transaction-card__amount ${mov.cantidad >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(mov.cantidad)} â¬</div><div class="transaction-card__details"><div class="transaction-card__description">${mov.descripcion}</div><div class="transaction-card__meta">${new Date(mov.fecha).toLocaleDateString('es-ES')}</div></div></div></div>`).join('')}</div></details>`; }).join('');
        }, 150); 
    };
    
    // =================================================================================
    // 8. MODAL HANDLING & MANAGEMENT
    // =================================================================================
    const showModal=id=>{const m=select(id);if(m){m.classList.add('modal-overlay--active');const f=m.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(f)f.focus();}};
    const hideModal=id=>{const m=select(id);if(m)m.classList.remove('modal-overlay--active');};
    const showGenericModal=(title,html)=>{select('generic-modal-title').textContent=title;select('generic-modal-body').innerHTML=html;showModal('generic-modal');};
    const showConfirmationModal=(msg,onConfirm,title="Confirmar AcciÃ³n")=>{ vibrate(20); const id='confirmation-modal';document.getElementById(id)?.remove(); const overlay=document.createElement('div');overlay.id=id;overlay.className='modal-overlay modal-overlay--active'; overlay.innerHTML=`<div class="modal" role="alertdialog" style="border-radius:var(--border-radius-lg)"><div class="modal__header"><h3 class="modal__title">${title}</h3></div><div class="modal__body"><p>${msg}</p><div style="display:flex;gap:var(--sp-3);margin-top:var(--sp-4);"><button class="btn btn--secondary btn--full" data-action="close-confirmation">Cancelar</button><button class="btn btn--danger btn--full" data-action="confirm-action">SÃ­, continuar</button></div></div></div>`; document.body.appendChild(overlay); overlay.querySelector('[data-action="confirm-action"]').onclick=()=>{vibrate();onConfirm();overlay.remove();}; overlay.querySelector('[data-action="close-confirmation"]').onclick=()=>overlay.remove(); };
    
    const showAccountMovementsModal = cId => {
        const cuenta = db.cuentas.find(c => c.id === cId);
        if (!cuenta) return;

        const allMovementsWithBalances = calculateRunningBalancesForAll(db.movimientos);
        const movs = allMovementsWithBalances
            .filter(m => m.cuentaId === cId || m.cuentaOrigenId === cId || m.cuentaDestinoId === cId)
            .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        const html = movs.length === 0 
            ? `<div class="empty-state"><span class="material-icons">receipt_long</span><h3>Sin Movimientos</h3><p>No hay movimientos en esta cuenta.</p></div>` 
            : `<div class="movements-modal-container">${movs.map(m => {
                const oClass = m.beneficiario ? `transaction-card--owner-${m.beneficiario.toLowerCase().replace('Ãº','u')}` : '';
                const amountIcon = m.cantidad < 0 ? `<span class="material-icons" style="font-size: inherit; vertical-align: middle; margin-left: 2px; color: var(--c-danger);">north_east</span>` : '';
                const amount = m.tipo === 'traspaso' 
                    ? `<span class="text-info">${formatCurrency(m.cantidad)} â¬</span>` 
                    : (m.cantidad < 0 ? `<span class="text-negative">${formatCurrency(m.cantidad)} â¬ ${amountIcon}</span>` : `<span class="text-positive">+${formatCurrency(m.cantidad)} â¬</span>`);

                let meta = '';
                let saldoHtml = '';

                if (m.tipo === 'traspaso') {
                    const origen = db.cuentas.find(c=>c.id===m.cuentaOrigenId)?.nombre||'?';
                    const destino = db.cuentas.find(c=>c.id===m.cuentaDestinoId)?.nombre||'?';
                    if (m.cuentaOrigenId === cId) meta = `Traspaso a: ${destino}`;
                    else meta = `Traspaso de: ${origen}`;
                } else {
                    meta = `${new Date(m.fecha).toLocaleDateString('es-ES')}`;
                    if (m.hasOwnProperty('saldoPostMovimiento')) {
                        saldoHtml = `<div style="font-size: 0.7rem; color: var(--c-on-surface-secondary); margin-top: 2px;">Saldo: ${formatCurrency(m.saldoPostMovimiento)} â¬</div>`;
                    }
                }
                
                const mainTitle = m.descripcion;
                const tagHtml = m.beneficiario ? `<div class="transaction-card__tags"><span class="transaction-card__tag">${m.beneficiario}</span></div>` : '';

                return `<div class="transaction-card ${oClass}" data-action="edit-movement" data-id="${m.id}" style="cursor: pointer;">
                            <div class="transaction-card__swipe-content">
                                <div class="transaction-card__details">
                                    <div class="transaction-card__description">${mainTitle}</div>
                                    <div class="transaction-card__meta">${meta}</div>
                                    ${tagHtml}
                                </div>
                                <div class="transaction-card__amount">
                                    ${amount}
                                    ${saldoHtml}
                                </div>
                            </div>
                        </div>`;
            }).join('')}</div>`;

        showGenericModal(`Movimientos de ${cuenta.nombre}`, html);
    };

    const startEditMovement=id=>{
        hideModal('generic-modal');
        const f=select('form-movimiento'); f.reset(); clearAllErrors('form-movimiento');
        const mov=id?db.movimientos.find(m=>m.id===id):null;
        select('form-movimiento-title').textContent = mov ? 'Editar Movimiento' : 'AÃ±adir Movimiento';
        select('movimiento-id').value=mov?.id||'';
        select('movimiento-tipo-selector').value=mov?.tipo||'movimiento';
        select('movimiento-tipo-selector').dispatchEvent(new Event('change'));
        select('movimiento-cantidad').value = mov ? formatCurrency(mov.cantidad) : '';
        const fecha=mov?new Date(mov.fecha):new Date();
        select('movimiento-fecha').value=new Date(fecha.getTime()-(fecha.getTimezoneOffset()*60000)).toISOString().slice(0,16);
        select('movimiento-descripcion').value=mov?.descripcion||'';
        if(mov?.tipo==='traspaso'){ select('movimiento-cuenta-origen').value=mov.cuentaOrigenId; select('movimiento-cuenta-destino').value=mov.cuentaDestinoId;
        } else { select('movimiento-cuenta').value=mov?.cuentaId||''; select('movimiento-concepto').value=mov?.conceptoId||''; select('movimiento-beneficiario').value=mov?.beneficiario||''; }
        select('delete-movimiento-btn').classList.toggle('hidden',!mov);
        showModal('movimiento-modal');
    };
    
    // =================================================================================
    // 9. FORM HANDLERS & MODAL CONTENT
    // =================================================================================
    const showHelpModal = () => {
        const helpHTML = `
            <h3>ð Â¡Bienvenido a Cuentas aiDANaI!</h3>
            <p>Esta es tu guÃ­a completa para dominar la gestiÃ³n de tus finanzas personales y compartidas. La aplicaciÃ³n estÃ¡ diseÃ±ada para ser intuitiva, potente y con un diseÃ±o inspirado en la elegancia de iOS.</p>

            <h3>ð§­ NavegaciÃ³n Principal</h3>
            <p>La barra de navegaciÃ³n inferior es tu centro de mando. Te permite moverte entre las cinco secciones principales de la app:</p>
            <ul>
                <li><strong><span class="material-icons" style="font-size:1em; vertical-align: sub;">dashboard</span> Panel:</strong> Tu vista general financiera.</li>
                <li><strong><span class="material-icons" style="font-size:1em; vertical-align: sub;">swap_horiz</span> Movim.:</strong> El historial detallado de todas tus transacciones.</li>
                <li><strong><span class="material-icons" style="font-size:1em; vertical-align: sub;">account_balance_wallet</span> Cuentas:</strong> Un resumen de tus activos y deudas.</li>
                <li><strong><span class="material-icons" style="font-size:1em; vertical-align: sub;">pie_chart</span> Presup.:</strong> Herramientas para crear y seguir tus presupuestos.</li>
                <li><strong><span class="material-icons" style="font-size:1em; vertical-align: sub;">settings</span> Config.:</strong> Para personalizar la app a tu gusto.</li>
            </ul>

            <h3>ð Panel de Control</h3>
            <p>Es la primera pantalla que ves. Te ofrece una visiÃ³n rÃ¡pida y potente de tu salud financiera para el periodo que elijas.</p>
            <ul>
                <li><strong>Filtros:</strong> Puedes filtrar los datos por periodo (mes actual, aÃ±o, etc.), propietario, cuenta y concepto. Â¡CombÃ­nalos para un anÃ¡lisis granular!</li>
                <li><strong>KPIs (Indicadores Clave):</strong> Tres tarjetas te muestran tus <strong>Ingresos</strong>, <strong>Gastos</strong> y el <strong>Saldo Neto</strong> del periodo filtrado.</li>
                <li><strong>Totales por Concepto:</strong> Un grÃ¡fico de barras te muestra visualmente en quÃ© conceptos has tenido mÃ¡s ingresos o gastos. Pulsa en cada barra para desplegar y ver los movimientos asociados.</li>
            </ul>

            <h3>ð¸ Movimientos</h3>
            <p>AquÃ­ encontrarÃ¡s un listado de todas tus transacciones, ordenadas por fecha. Es una lista virtualizada para un rendimiento Ã³ptimo, incluso con miles de movimientos.</p>
            <ul>
                <li><strong>BÃºsqueda:</strong> Usa la barra de bÃºsqueda en la parte superior para encontrar movimientos por descripciÃ³n, concepto o cuenta.</li>
                <li><strong>Gestos (Swipe):</strong> Desliza una tarjeta de movimiento hacia la <strong>izquierda</strong> para revelar el botÃ³n de <strong>eliminar</strong>. DeslÃ­zala hacia la <strong>derecha</strong> para <strong>copiar</strong> ese movimiento (muy Ãºtil para gastos recurrentes).</li>
                <li><strong>Editar:</strong> Toca en cualquier parte de una tarjeta para abrir el modo de ediciÃ³n.</li>
            </ul>
            <div class="pro-tip">
                <strong>Pro-Tip:</strong> El botÃ³n flotante azul <button class="fab fab--visible" style="position:relative;display:inline-flex;width:28px;height:28px;transform:none;opacity:1;bottom:0;right:0;vertical-align:middle;"><span class="material-icons" style="font-size:18px;">add</span></button> te permite aÃ±adir un nuevo movimiento desde casi cualquier pantalla.
            </div>

            <h3>ð¦ Cuentas</h3>
            <p>Esta secciÃ³n agrupa tu dinero por propietario y por tipo de cuenta, dÃ¡ndote una visiÃ³n clara de dÃ³nde estÃ¡n tus activos.</p>
            <ul>
                <li><strong>Filtro por Tipo:</strong> Toca las pÃ­ldoras en la parte superior para mostrar u ocultar ciertos tipos de cuentas de los totales (Ej: Ocultar "Efectivo").</li>
                <li><strong>Resumen por Propietario:</strong> Cada propietario tiene una secciÃ³n con el total de sus activos lÃ­quidos. DespliÃ©gala para ver el desglose por tipo de cuenta (Cuenta Corriente, Ahorro, InversiÃ³n, etc.).</li>
                <li><strong>GrÃ¡ficos de Activos:</strong> Un grÃ¡fico de tarta visualiza la distribuciÃ³n de los activos lÃ­quidos de cada persona.</li>
                <li><strong>Detalle de Cuenta:</strong> Toca en cualquier cuenta individual para ver un historial de todos sus movimientos en una ventana modal.</li>
            </ul>

            <h3>ð¯ Presupuestos</h3>
            <p>Una secciÃ³n completamente rediseÃ±ada para un control total sobre tus metas de gasto.</p>
            <ul>
                <li><strong>SelecciÃ³n de Periodo:</strong> Elige el <strong>AÃ±o</strong> y el <strong>Propietario</strong> que quieres consultar.</li>
                <li><strong>Seguimiento Detallado:</strong> Para cada concepto, verÃ¡s una lÃ­nea que incluye:
                    <ul>
                        <li>El lÃ­mite de gasto anual (<strong>LÃ­mite</strong>).</li>
                        <li>CuÃ¡nto has gastado hasta la fecha (<strong>Gastado</strong>).</li>
                        <li>El dinero que te queda disponible o te has excedido (<strong>Disp/Exceso</strong>).</li>
                        <li>Una <strong>barra de progreso</strong> que se vuelve amarilla al 85% y roja al 100% para alertarte.</li>
                    </ul>
                </li>
                <li><strong>GestiÃ³n Centralizada:</strong> Usa el botÃ³n <strong>"Gestionar Presupuestos"</strong> para abrir un panel donde puedes crear o actualizar todos los lÃ­mites de gasto para el aÃ±o y propietario seleccionados de una sola vez. Â¡Mucho mÃ¡s rÃ¡pido!</li>
            </ul>

            <h3>ð¤ Asesor de InversiÃ³n IA</h3>
            <p>Una herramienta experimental para darte ideas. La encontrarÃ¡s tocando el icono del cerebro <span class="material-icons" style="font-size:1em; vertical-align: sub;">psychology_alt</span> en la barra superior.</p>
            <ul>
                <li>Selecciona un usuario, un periodo de meses a analizar y tu perfil de riesgo (Bajo, Medio o Alto).</li>
                <li>La IA calcularÃ¡ tu capacidad de ahorro media mensual y te ofrecerÃ¡ sugerencias de inversiÃ³n acordes a tu perfil.</li>
                <li><small><strong>Aviso Importante:</strong> Esto no es asesoramiento financiero profesional. Son sugerencias generadas automÃ¡ticamente. Consulta siempre con un experto cualificado.</small></li>
            </ul>
            
            <h3>âï¸ ConfiguraciÃ³n</h3>
            <p>AquÃ­ puedes adaptar la aplicaciÃ³n a tus necesidades.</p>
            <ul>
                <li><strong>GestiÃ³n General:</strong> Define los nombres de los <strong>propietarios</strong> y elige cuÃ¡les quieres que estÃ©n <strong>visibles</strong> en la app.</li>
                <li><strong>GestiÃ³n de Cuentas/Conceptos:</strong> Desde aquÃ­ puedes aÃ±adir o eliminar las cuentas y los conceptos que usarÃ¡s en toda la aplicaciÃ³n.</li>
                <li><strong>GestiÃ³n de Datos:</strong>
                    <ul>
                        <li><strong>Exportar:</strong> Crea una copia de seguridad de todos tus datos en un archivo <code>.json</code>. Â¡Hazlo regularmente!</li>
                        <li><strong>Importar:</strong> Restaura tus datos desde un archivo <code>.json</code>. <strong>Â¡CUIDADO!</strong> Esto sobreescribe todos los datos actuales.</li>
                        <li><strong>Borrar Todos los Datos:</strong> Elimina permanentemente toda tu informaciÃ³n de la base de datos. Es una acciÃ³n irreversible.</li>
                    </ul>
                </li>
                <li><strong>Ayuda:</strong> Â¡El botÃ³n que te trajo aquÃ­!</li>
            </ul>
        `;
        showGenericModal("GuÃ­a de Usuario de Cuentas aiDANaI", helpHTML);
    };
    const showConceptosModal = () => {
        const html = `<form id="add-concepto-form" novalidate style="margin-bottom: var(--sp-4);"><div class="form-group-addon"><div class="form-group"><label for="new-concepto-nombre" class="form-label">Nuevo Concepto</label><input type="text" id="new-concepto-nombre" class="form-input" placeholder="Ej: NÃ³mina" required></div><button type="submit" class="btn btn--primary" style="align-self: flex-end; padding-top: var(--sp-2); padding-bottom: var(--sp-2);">AÃ±adir</button></div></form><hr style="border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-top: var(--sp-4); margin-bottom: var(--sp-2); font-size: var(--fs-base); color: var(--c-on-surface-secondary);">Conceptos Existentes</h4><div id="conceptos-modal-list"></div>`;
        showGenericModal('Gestionar Conceptos', html);
        renderConceptosModalList();
    };
    const renderConceptosModalList = () => {
        const list = select('conceptos-modal-list'); if (!list) return;
        list.innerHTML = (db.conceptos || []).length === 0 ? `<p style="font-size:var(--fs-sm); color:var(--c-on-surface-secondary); text-align:center; padding: var(--sp-4) 0;">No hay conceptos.</p>` : [...db.conceptos].sort((a,b) => a.nombre.localeCompare(b.nombre)).map(c => `<div class="modal__list-item"><span>${c.nombre}</span><button class="icon-btn" data-action="delete-concepto" data-id="${c.id}" title="Eliminar Concepto"><span class="material-icons">delete_outline</span></button></div>`).join('');
    };
    const showCuentasModal = () => {
        const ownersOptions = (db.config?.beneficiarios || []).map(o => `<option value="${o}">${o}</option>`).join('');
        const html = `<form id="add-cuenta-form" novalidate><div class="form-group"><label for="new-cuenta-nombre" class="form-label">Nombre de la Cuenta</label><input type="text" id="new-cuenta-nombre" class="form-input" placeholder="Ej: Cartera de Dani" required></div><div class="form-grid"><div class="form-group"><label for="new-cuenta-tipo" class="form-label">Tipo de Cuenta</label><input type="text" id="new-cuenta-tipo" class="form-input" list="tipos-cuenta-list" placeholder="Ej: Efectivo" required><datalist id="tipos-cuenta-list"><option value="Efectivo"></option><option value="Cuenta Corriente"></option><option value="Ahorro"></option><option value="InversiÃ³n"></option><option value="Tarjeta CrÃ©dito"></option><option value="PrÃ©stamo"></option><option value="Propiedad"></option></datalist></div><div class="form-group"><label for="new-cuenta-propietario" class="form-label">Propietario</label><select id="new-cuenta-propietario" class="form-select" required><option value="" disabled selected>Seleccionar...</option>${ownersOptions}</select></div></div><button type="submit" class="btn btn--primary btn--full" style="margin-top: var(--sp-3)">AÃ±adir Cuenta</button></form><hr style="margin: var(--sp-4) 0; border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-top: var(--sp-4); margin-bottom: var(--sp-2); font-size: var(--fs-base); color: var(--c-on-surface-secondary);">Cuentas Existentes</h4><div id="cuentas-modal-list"></div>`;
        showGenericModal('Gestionar Cuentas', html);
        renderCuentasModalList();
    };
    const renderCuentasModalList = () => {
        const list = select('cuentas-modal-list'); if (!list) return;
        list.innerHTML = (db.cuentas || []).length === 0 ? `<p style="font-size:var(--fs-sm); color:var(--c-on-surface-secondary); text-align:center; padding: var(--sp-4) 0;">No hay cuentas.</p>` : [...db.cuentas].sort((a,b) => a.nombre.localeCompare(b.nombre)).map(c => `<div class="modal__list-item"><div><span style="display: block; font-weight: 500;">${c.nombre}</span><small style="color: var(--c-on-surface-secondary); font-size: var(--fs-xs);">${c.tipo.toUpperCase()} &middot; ${c.propietario}</small></div><button class="icon-btn" data-action="delete-cuenta" data-id="${c.id}" title="Eliminar Cuenta"><span class="material-icons">delete_outline</span></button></div>`).join('');
    };
    
    // =================================================================================
    // 10. AI ADVISOR LOGIC
    // =================================================================================
    const showAiAdvisorModal = () => {
        const userSelect = select('ai-user-select'), resultsContainer = select('ai-results-container'); if (!userSelect || !resultsContainer) return;
        const owners = getVisibleOwners(); userSelect.innerHTML = owners.map(o => `<option value="${o}">${o}</option>`).join('');
        resultsContainer.classList.add('hidden'); resultsContainer.innerHTML = ''; select('ai-advisor-form').reset();
        showModal('ai-advisor-modal');
    };
    const handleAiAnalysis = () => {
        vibrate();
        const form = select('ai-advisor-form'), btn = form.querySelector('button[type="submit"]'); setButtonLoading(btn, true, 'Analizando...');
        const selectedUser = select('ai-user-select').value, monthsToStudy = parseInt(select('ai-months-study').value, 10), riskLevel = select('ai-risk-level').value, resultsContainer = select('ai-results-container');
        resultsContainer.innerHTML = '<div class="skeleton" style="height: 150px;"></div>'; resultsContainer.classList.remove('hidden');
        setTimeout(() => {
            if (!selectedUser || !monthsToStudy || monthsToStudy <= 0) { resultsContainer.innerHTML = `<p class="text-danger">Por favor, selecciona un usuario y un nÃºmero de meses vÃ¡lido.</p>`; setButtonLoading(btn, false); return; }
            const endDate = new Date(), startDate = new Date(); startDate.setMonth(endDate.getMonth() - monthsToStudy); startDate.setHours(0, 0, 0, 0);
            let totalNet = 0;
            (db.movimientos || []).forEach(m => { 
                const movDate = new Date(m.fecha); 
                if (movDate >= startDate && movDate <= endDate && m.tipo === 'movimiento') { 
                    const cuenta = db.cuentas.find(c => c.id === m.cuentaId);
                    if (cuenta && cuenta.propietario === selectedUser) {
                        totalNet += m.cantidad;
                    }
                } 
            });
            const averageMonthlySavings = totalNet / monthsToStudy, suggestions = getInvestmentSuggestions(riskLevel);
            let resultsHTML = `<h4>AnÃ¡lisis para ${selectedUser}</h4>`;
            resultsHTML += averageMonthlySavings > 0 ? `<p>En los Ãºltimos ${monthsToStudy} meses, tu <strong>capacidad de ahorro media mensual ha sido de <span class="text-positive">${formatCurrency(averageMonthlySavings)} â¬</span></strong>.</p><p>Basado en este ahorro y tu perfil de riesgo <strong>${riskLevel}</strong>, aquÃ­ tienes algunas sugerencias de inversiÃ³n:</p>` : `<p>En los Ãºltimos ${monthsToStudy} meses, tu <strong>balance medio mensual ha sido de <span class="text-negative">${formatCurrency(averageMonthlySavings)} â¬</span></strong>.</p><p>Tu prioridad deberÃ­a ser revisar tus gastos para generar un excedente de ahorro. Una vez consigas un ahorro mensual positivo, podrÃ¡s plantearte las siguientes estrategias segÃºn tu perfil de riesgo <strong>${riskLevel}</strong>:</p>`;
            resultsHTML += `<ul>${suggestions.map(s => `<li>${s}</li>`).join('')}</ul><small><strong>Aviso:</strong> Esto no es asesoramiento financiero. Son sugerencias generadas automÃ¡ticamente. Consulta siempre con un profesional.</small>`;
            resultsContainer.innerHTML = resultsHTML;
            setButtonLoading(btn, false);
        }, 500);
    };
    const getInvestmentSuggestions = (risk) => {
        switch (risk) {
            case 'Bajo': return ["<strong>Cuentas de Ahorro de Alta Rentabilidad:</strong> Seguridad y una pequeÃ±a rentabilidad, ideal para tu fondo de emergencia.", "<strong>DepÃ³sitos a Plazo Fijo:</strong> InterÃ©s fijo y garantizado.", "<strong>Fondos Monetarios:</strong> Deuda a muy corto plazo y de bajo riesgo."];
            case 'Medio': return ["<strong>Fondos Indexados (MSCI World, S&P 500):</strong> InversiÃ³n diversificada global con costes bajos. La estrategia mÃ¡s recomendada a largo plazo.", "<strong>InversiÃ³n Inmobiliaria (Crowdfunding):</strong> Participa en proyectos inmobiliarios con pequeÃ±as cantidades.", "<strong>Acciones de Empresas Consolidadas (Blue Chips):</strong> Empresas grandes y estables con historial de dividendos."];
            case 'Alto': return ["<strong>Acciones de Crecimiento (Growth Stocks):</strong> Empresas con alto potencial de crecimiento, aunque mÃ¡s volÃ¡tiles.", "<strong>Criptoactivos (Bitcoin, Ethereum):</strong> Muy alto riesgo. Destina solo un pequeÃ±o porcentaje de tu cartera (<1-5%).", "<strong>Venture Capital o Private Equity:</strong> Invertir en startups y empresas no cotizadas."];
            default: return ["No se pudo determinar un perfil de riesgo."];
        }
    };

    // =================================================================================
    // 11. EVENT LISTENERS & HANDLERS
    // =================================================================================
    const attachEventListeners = () => {
        let currentSwipedCard = null; window.debounceTimer = null; let touchStartX = 0, touchStartY = 0;
        document.body.addEventListener('click', e => {
            if (currentSwipedCard && !currentSwipedCard.contains(e.target)) { currentSwipedCard.classList.remove('transaction-card--swiped-left', 'transaction-card--swiped-right'); currentSwipedCard = null; }
            const target = e.target, actionTarget = target.closest('[data-action]');
            if (target.closest('.modal-overlay') && e.target === target.closest('.modal-overlay')) return hideModal(target.closest('.modal-overlay').id);
            if (!actionTarget) return; 
            const {action, id, page, type} = actionTarget.dataset, btn = actionTarget.closest('button'), cardElement = actionTarget.closest('.transaction-card');
            switch (action) {
                case 'login': handleLogin(btn); break; case 'register': handleRegister(btn); break; case 'exit': handleExitApp(); break; case 'navigate': navigateTo(page); break; case 'theme-toggle': toggleTheme(); break; case 'help': showHelpModal(); break; case 'ai-advisor': showAiAdvisorModal(); break; case 'apply-filters': vibrate(); updateDashboard(); renderCuentas(); break; case 'add-movement': vibrate(); startEditMovement(null); break; case 'edit-movement': vibrate(); startEditMovement(actionTarget.dataset.id); break;
                case 'delete-movement-swipe': showConfirmationModal('Â¿Seguro que quieres eliminar este movimiento?', ()=>{db.movimientos=db.movimientos.filter(m=>m.id!==cardElement.dataset.id);saveData(null,()=>{renderMovimientos();showToast('Movimiento eliminado.');});}); break;
                case 'copy-movement-swipe': handleCopyMovement(cardElement.dataset.id); break;
                case 'delete-movement-from-modal': showConfirmationModal('Â¿Seguro que quieres eliminar este movimiento?', ()=>{db.movimientos=db.movimientos.filter(m=>m.id!==select('movimiento-id').value);saveData(null,()=>{hideModal('movimiento-modal');renderAll();showToast('Movimiento eliminado.');});}); break;
                case 'delete-concepto': if(db.movimientos.some(m=>m.conceptoId===id)){showToast("Concepto en uso, no se puede borrar.","warning");return;} showConfirmationModal('Â¿Seguro que quieres eliminar este concepto?',()=>{db.conceptos=db.conceptos.filter(c=>c.id!==id);saveData(null,()=>{showToast("Concepto eliminado.");renderConceptosModalList();populateAllDropdowns();});}); break;
                case 'delete-cuenta': if(db.movimientos.some(m=>m.cuentaId===id||m.cuentaOrigenId===id||m.cuentaDestinoId===id)){showToast("Cuenta con movimientos, no se puede borrar.","warning",3500);return;} showConfirmationModal('Â¿Seguro que quieres eliminar esta cuenta?',()=>{db.cuentas=db.cuentas.filter(c=>c.id!==id);saveData(null,()=>{showToast("Cuenta eliminada.");renderCuentasModalList();populateAllDropdowns();renderCuentas();});}); break;
                case 'close-modal': hideModal(target.closest('.modal-overlay').id); break; case 'manage-conceptos': showConceptosModal(); break; case 'manage-cuentas': showCuentasModal(); break; case 'view-account-details': showAccountMovementsModal(id); break; case 'save-config': handleSaveConfig(btn); break; case 'export-data': handleExportData(btn); break; case 'import-data': select('import-file-input').click(); break;
                case 'clear-data': showConfirmationModal('Â¿Seguro que quieres borrar TODOS tus datos? Esta acciÃ³n es irreversible.',()=>{showConfirmationModal('Esta acciÃ³n no se puede deshacer. Â¿Continuar con el borrado?', () => {db=getInitialDb();saveData(null,()=>{renderAll();showToast('Datos borrados.','danger');});}, 'ConfirmaciÃ³n Final')}); break;
                case 'toggle-account-type-filter': vibrate(); if(deselectedAccountTypesFilter.has(type)) { deselectedAccountTypesFilter.delete(type); } else { deselectedAccountTypesFilter.add(type); } renderCuentas(); break;
                case 'create-budgets':
                    const ownerToCreate = select('budget-owner-selector').value;
                    const yearToCreate = parseInt(select('budget-year-selector').value, 10);
                    handleCreateBudgets(ownerToCreate, yearToCreate, actionTarget.closest('button'));
                    break;
                case 'update-budgets':
                    handleUpdateBudgets();
                    break;
            }
        });
        document.body.addEventListener('submit', e => { e.preventDefault(); switch(e.target.id) { case 'form-movimiento':handleSaveMovement(e.target);break; case 'add-concepto-form':handleAddConcept(e.target);break; case 'add-cuenta-form':handleAddAccount(e.target);break; case 'ai-advisor-form':handleAiAnalysis();break; } });
        document.body.addEventListener('input', e => { const id=e.target.id; if(id && select(`${id}-error`)) clearError(id); });
        select('filter-periodo').addEventListener('change', e => select('custom-date-filters').classList.toggle('hidden', e.target.value !== 'custom'));
        select('movimiento-tipo-selector').addEventListener('change', e => { const isT=e.target.value==='traspaso';select('movimiento-fields').classList.toggle('hidden',isT);select('traspaso-fields').classList.toggle('hidden',!isT);['movimiento-concepto','movimiento-cuenta','movimiento-beneficiario'].forEach(id=>select(id).required=!isT);['movimiento-cuenta-origen','movimiento-cuenta-destino'].forEach(id=>select(id).required=isT); });
        select('import-file-input').addEventListener('change', e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=re=>{try{let d=JSON.parse(re.target.result);if(d.db)d=d.db;showConfirmationModal('Importar reemplazarÃ¡ TODOS tus datos. Â¿EstÃ¡s seguro?',()=>{db=d;saveData(null,()=>{renderAll();showToast('Datos importados.');});});}catch(err){showToast('Error: Archivo JSON no vÃ¡lido.','danger');console.error("Import error:",err);}};r.readAsText(f);e.target.value='';});
        const listContainer = select('movimientos-page');
        listContainer.addEventListener('touchstart', e => { const card = e.target.closest('.transaction-card'); if (!card || !select('movimientos-list-container')?.contains(card)) return; if (currentSwipedCard && currentSwipedCard !== card) { currentSwipedCard.classList.remove('transaction-card--swiped-left', 'transaction-card--swiped-right'); } currentSwipedCard = card; touchStartX = e.targetTouches[0].clientX; touchStartY = e.targetTouches[0].clientY; }, { passive: true });
        listContainer.addEventListener('touchmove', e => { if (!currentSwipedCard || !e.targetTouches[0]) return; const diffX = e.targetTouches[0].clientX - touchStartX, diffY = e.targetTouches[0].clientY - touchStartY; if (Math.abs(diffY) > Math.abs(diffX) + 5) { if (currentSwipedCard) { currentSwipedCard.classList.remove('transaction-card--swiped-left', 'transaction-card--swiped-right'); } currentSwipedCard = null; return; } const SWIPE_THRESHOLD = 50; if (diffX > SWIPE_THRESHOLD) { currentSwipedCard.classList.add('transaction-card--swiped-right'); currentSwipedCard.classList.remove('transaction-card--swiped-left'); } else if (diffX < -SWIPE_THRESHOLD) { currentSwipedCard.classList.add('transaction-card--swiped-left'); currentSwipedCard.classList.remove('transaction-card--swiped-right'); } else { currentSwipedCard.classList.remove('transaction-card--swiped-left', 'transaction-card--swiped-right'); } }, { passive: true });
        
        select('budget-owner-selector')?.addEventListener('change', () => renderBudgetTracking());
        select('budget-year-selector')?.addEventListener('change', () => renderBudgetTracking());
    };

    const handleSaveConfig = btn => {
        vibrate();
        const bens = select('config-beneficiarios').value.split(',').map(s => s.trim()).filter(Boolean);
        if (bens.length === 0) { displayError('config-beneficiarios', 'Debe haber al menos un propietario.'); return; }
        setButtonLoading(btn, true, 'Guardando...');
        db.config.beneficiarios = bens;
        db.config.skipIntro = select('config-skip-intro').checked;
        localStorage.setItem('skipIntro', db.config.skipIntro);
        const visibleOwners = [];
        selectAll('#config-visible-owners-container input[type="checkbox"]:checked').forEach(checkbox => { visibleOwners.push(checkbox.value); });
        db.config.visibleOwners = visibleOwners;
        saveData(btn, () => { renderAll(); showToast('ConfiguraciÃ³n guardada.'); });
    };
    const handleExportData = (btn) => {
        vibrate(); setButtonLoading(btn, true, 'Exportando...');
        try { const dataStr = JSON.stringify({ db }, null, 2), dataBlob = new Blob([dataStr], {type: "application/json"}), url = URL.createObjectURL(dataBlob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; const dateStr = new Date().toISOString().slice(0, 10); a.download = `cuentas-aidanai-backup-${dateStr}.json`; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
        } catch (error) { console.error("Error al exportar datos:", error); showToast('Error al exportar los datos.', 'danger');
        } finally { setButtonLoading(btn, false); }
    };
    
    const handleCopyMovement = (idToCopy) => {
        vibrate();
        const originalMov = db.movimientos.find(m => m.id === idToCopy);
        if (!originalMov) { showToast('Error: No se encontrÃ³ el movimiento.', 'danger'); return; }
        const newMov = JSON.parse(JSON.stringify(originalMov)); newMov.id = generateId(); newMov.fecha = new Date().toISOString();
        db.movimientos.push(newMov);
        saveData(null, () => {
            showToast('Movimiento copiado.'); renderMovimientos();
            setTimeout(() => { const newCardContent = document.querySelector(`.transaction-card[data-id="${newMov.id}"] .transaction-card__swipe-content`); if (newCardContent) { newCardContent.classList.add('highlight-animation'); newCardContent.scrollIntoView({ behavior: 'smooth', block: 'center' }); setTimeout(() => newCardContent.classList.remove('highlight-animation'), 1500); } }, 250);
        });
    };
    const handleSaveMovement = form => {
        vibrate(); clearAllErrors(form.id);
        const id = select('movimiento-id').value, tipo = select('movimiento-tipo-selector').value, fecha = select('movimiento-fecha').value, desc = select('movimiento-descripcion').value.trim(), btn = select('save-movimiento-btn'), cantStr = select('movimiento-cantidad').value.trim().replace(/\./g, '').replace(',', '.'), cantCent = Math.round(parseFloat(cantStr) * 100);
        let v = true;
        if (isNaN(cantCent)) { displayError('movimiento-cantidad', 'Cantidad invÃ¡lida.'); v = false; }
        if (!fecha) { displayError('movimiento-fecha', 'Fecha obligatoria.'); v = false; }
        if (!desc) { displayError('movimiento-descripcion', 'DescripciÃ³n obligatoria.'); v = false; }
        const newMov = { id: id || generateId(), tipo, cantidad: cantCent, fecha: new Date(fecha).toISOString(), descripcion: desc };
        if (tipo === 'traspaso') {
            newMov.cuentaOrigenId = select('movimiento-cuenta-origen').value; newMov.cuentaDestinoId = select('movimiento-cuenta-destino').value; 
            newMov.beneficiario = db.cuentas.find(c => c.id === newMov.cuentaOrigenId)?.propietario || ''; // Asignar beneficiario del traspaso
            if (!newMov.cuentaOrigenId || !newMov.cuentaDestinoId || newMov.cuentaOrigenId === newMov.cuentaDestinoId) { displayError('movimiento-cuenta-destino', 'Cuentas de origen y destino deben ser vÃ¡lidas y diferentes.'); v = false; }
            if (cantCent <= 0) { displayError('movimiento-cantidad', 'En traspasos, la cantidad debe ser positiva.'); v = false; }
        } else {
            newMov.cuentaId = select('movimiento-cuenta').value; newMov.conceptoId = select('movimiento-concepto').value; newMov.beneficiario = select('movimiento-beneficiario').value;
            if (!newMov.cuentaId) { displayError('movimiento-cuenta', 'Cuenta obligatoria.'); v = false; }
            if (!newMov.conceptoId) { displayError('movimiento-concepto', 'Concepto obligatorio.'); v = false; }
            if (!newMov.beneficiario) { displayError('movimiento-beneficiario', 'Propietario obligatorio.'); v = false; }
        }
        if (!v) return;
        setButtonLoading(btn, true, 'Guardando...');
        const idx = id ? db.movimientos.findIndex(m => m.id === id) : -1;
        if (idx > -1) db.movimientos[idx] = newMov; else db.movimientos.push(newMov);
        saveData(btn, () => { hideModal('movimiento-modal'); showToast(id ? 'Movimiento actualizado' : 'Movimiento aÃ±adido'); renderAll(); });
    };
    const handleAddConcept = form => { vibrate(); const input=form.querySelector('input'),nombre=input.value.trim();if(nombre){db.conceptos.push({id:generateId(),nombre});saveData(null,()=>{input.value='';showToast('Concepto aÃ±adido.');renderConceptosModalList();populateAllDropdowns();});}};
    const handleAddAccount = form => { vibrate(); const nom=select('new-cuenta-nombre').value.trim(),tip=select('new-cuenta-tipo').value.trim().toUpperCase(),pro=select('new-cuenta-propietario').value;if(nom&&tip&&pro){db.cuentas.push({id:generateId(),nombre:nom,tipo:tip,propietario:pro});saveData(null,()=>{form.reset();showToast('Cuenta aÃ±adida.');renderCuentasModalList();populateAllDropdowns();renderCuentas();});}else{showToast("Rellena todos los campos.","warning");}};

    // =================================================================================
    // 12. APP ENTRY POINT
    // =================================================================================
    initApp();
});
</script>

<div id="exit-screen" style="display: none; opacity: 0; position: fixed; inset: 0; background-color: var(--c-background); color: var(--c-on-surface); flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-size: 1.5rem; text-align: center; transition: opacity 0.5s ease;">
    <span class="material-icons" style="font-size: 4rem; margin-bottom: 20px;">waving_hand</span>
    <p>Hasta la prÃ³xima...</p>
</div>

</body>
</html>