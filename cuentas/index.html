<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Cuentas Personales</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="manifest" href="data:application/manifest+json,{
        %22name%22:%22Gestor de Cuentas%22,
        %22short_name%22:%22Cuentas%22,
        %22start_url%22:%22.%22,
        %22display%22:%22standalone%22,
        %22background_color%22:%22#000000%22,
        %22theme_color%22:%22#007AFF%22,
        %22description%22:%22Gestor de finanzas personales, elegante y profesional.%22,
        %22icons%22:[
            {%22src%22:%22data:image/svg+xml,%3svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg%2bxml%2bxml%22},
            {%22src%22:%22data:image/svg+xml,%3svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3Csvg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg%2bxml%2bxml%22}
        ]
    }">
    <meta name="theme-color" content="#000000"/>
    <link rel="apple-touch-icon" href="aiDANaI.webp">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0"></script>
    
	    <style>
/* ================================================================= */
/* === ESTILOS BASE: TEMA POR DEFECTO "AMOLED CIRCUIT" (MEJORADO) === */
/* ================================================================= */
:root {
    /* PALETA AMOLED CIRCUIT (MEJORADA Y MÁS ACCESIBLE) */
    --c-primary: #40A9FF;       /* Azul más claro, ratio 7.2:1 sobre negro */
    --c-primary-hover: #66BFFF; /* Hover correspondiente */
    --c-danger: #FF453A;        /* Rojo más claro, ratio 5.1:1 sobre negro */
    --c-success: #32D74B;       /* Verde ligeramente ajustado */
    --c-warning: #FFD60A;
    --c-info: #BF5AF2; 

    /* FONDO: Negro puro AMOLED con trama de circuito sutil */
    --c-background: #000000;
    
    /* SUPERFICIES: Ligeramente translúcidas para un efecto de "vidrio ahumado" */
    --c-surface: rgba(18, 18, 22, 0.7);
    --c-surface-variant: rgba(28, 28, 34, 0.7);

    /* BORDES: Un gradiente de neón para un efecto de borde de energía */
    --c-outline: rgba(0, 162, 255, 0.2);
    --c-border-glow: linear-gradient(145deg, rgba(0,162,255,0.4), rgba(0,162,255,0.1));

    /* TEXTOS: Optimizados para legibilidad sobre negro */
    --c-on-surface: #FFFFFF;
    --c-on-surface-secondary: #EBEBF599; /* 60% white */
    --c-on-surface-tertiary: #EBEBF566; /* 40% white */
    --c-on-surface-disabled: #666666;
    
    --c-white: #FFFFFF;
    --c-black: #000000;
    
    --c-chart-positive: var(--c-success);
    --c-chart-negative: var(--c-danger);

    /* SOMBRAS: Un resplandor de neón más difuso y pronunciado (efecto "Bloom") */
    --shadow-sm: 0 0 10px rgba(0, 162, 255, 0.2), 0 0 20px rgba(0, 162, 255, 0.1);
    --shadow-md: 0 0 15px rgba(0, 162, 255, 0.35), 0 0 35px rgba(0, 162, 255, 0.2);
    --glow-red: 0 0 15px rgba(255, 59, 48, 0.4), 0 0 30px rgba(255, 59, 48, 0.2);

    --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    
    --fs-xs: 0.7rem; --fs-sm: 0.825rem; --fs-base: 0.95rem; --fs-lg: 1.05rem; --fs-xl: 1.2rem;
    --sp-1: 0.2rem; --sp-2: 0.4rem; --sp-3: 0.6rem; --sp-4: 0.8rem; --sp-5: 1rem; --sp-6: 1.25rem;
    --border-radius-md: 8px; --border-radius-lg: 14px;
}

/* FONDO DEL TEMA "AMOLED CIRCUIT" (MEJORADO) */
body {
    /* Malla de circuito sutil + Gradiente radial para profundidad */
    background-color: var(--c-background);
    background-image: 
        linear-gradient(rgba(0,162,255,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,162,255,0.05) 1px, transparent 1px),
        radial-gradient(ellipse at center, #101218 0%, #000000 70%);
    background-size: 40px 40px, 40px 40px, 100% 100%;
}

.card, .modal, .kpi-item, .login-view__card, .empty-state {
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--c-outline);
    background-color: var(--c-surface); /* Esto activa la translucidez */
}


        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; scroll-behavior: smooth; }
        body { font-family: var(--font-family); background-color: var(--c-background); color: var(--c-on-surface); line-height: 1.4; min-height: 100vh; min-height: -webkit-fill-available; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow: hidden; font-weight: 500; }
        *:focus-visible { outline: 2px solid var(--c-primary); outline-offset: 2px; border-radius: var(--sp-2); }
        
        @keyframes pop-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
                @keyframes view-fade-in { /* Renombramos y mejoramos la animación de entrada */
            from { 
                opacity: 0; 
                transform: translateY(5px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }

        @keyframes view-fade-out { /* Nueva animación de salida */
            from { 
                opacity: 1; 
            } 
            to { 
                opacity: 0;
            }
        }

        .view-entering { /* Clase que aplicaremos a la vista que entra */
            animation: view-fade-in 0.3s ease-out forwards;
        }

        .view-exiting { /* Clase que aplicaremos a la vista que sale */
            animation: view-fade-out 0.2s ease-in forwards; /* La salida es ligeramente más rápida */
        }
        @keyframes highlight-card { 0% { background-color: color-mix(in srgb, var(--c-primary) 15%, transparent); } 100% { background-color: transparent; } }
        .highlight-animation { animation: highlight-card 2s ease-out; }
        @keyframes highlight-field-success { 0% { background-color: color-mix(in srgb, var(--c-success) 20%, transparent); } 100% { background-color: transparent; } }
        .field-highlighted { animation: highlight-field-success 1s ease-out; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton { background-color: var(--c-surface-variant); background-image: linear-gradient(90deg, var(--c-surface-variant), color-mix(in srgb, var(--c-outline) 20%, var(--c-surface-variant)), var(--c-surface-variant)); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; border-radius: var(--sp-2); color: transparent !important; user-select: none; }
        .skeleton > * { visibility: hidden; }
        
        .intro-screen { position: fixed; inset: 0; z-index: 9999; display: flex; justify-content: center; align-items: center; background-color: #000000; transition: opacity 0.75s ease-in-out; }
        .starry-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(1px 1px at 10% 20%,#fff,transparent),radial-gradient(1px 1px at 80% 30%,#fff,transparent),radial-gradient(2px 2px at 50% 50%,#fff,transparent),radial-gradient(1px 1px at 30% 80%,#fff,transparent),radial-gradient(2px 2px at 90% 90%,#fff,transparent); background-size: 300px 300px; animation: twinkle 15s linear infinite; }
        @keyframes twinkle { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .intro-screen__logo { width: 250px; height: auto; border-radius: 24px; opacity: 0; position: absolute; animation: logoExplode 2.5s cubic-bezier(0.5, 0, 0.5, 1) forwards; }
        @keyframes logoExplode { 0% { transform: scale(0.2) rotate(-25deg); opacity: 0; } 30% { transform: scale(1.1) rotate(10deg); opacity: 1; } 50% { transform: scale(0.95) rotate(-8deg); opacity: 1; } 80% { transform: scale(1.5) rotate(5deg); opacity: 1; } 100% { transform: scale(12) rotate(20deg); opacity: 0; } }
        .intro-screen__quote-container { text-align: center; color: var(--c-white); padding: var(--sp-5); max-width: 800px; z-index: 1; opacity: 0; transition: opacity 1.5s ease-in-out; }
        .intro-screen__quote-container.visible { opacity: 1; }
        .intro-screen__quote-text { font-size: clamp(1.2rem, 4vw, 1.8rem); font-style: italic; font-weight: 400; line-height: 1.4; margin-bottom: 16px; text-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        .intro-screen__quote-author { display: block; font-size: clamp(0.8rem, 2.4vw, 1rem); color: var(--c-on-surface-secondary); font-weight: 500; }
        
        .app-layout { display: none; max-width: 500px; margin: 0 auto; height: 100vh; background-color: var(--c-background); flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; }
        .app-layout--visible { display: flex; opacity: 1; }

        .app-layout__main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 44px 0 48px 0; }
        .view { display: none; flex-direction: column; width: 100%; padding: 0 var(--sp-4); gap: var(--sp-4); }
        .view--active { display: flex; }
        
        .top-bar { display: flex; align-items: center; justify-content: space-between; padding: var(--sp-2) var(--sp-4); background-color: rgba(0,0,0,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--c-outline); z-index: 200; height: 44px; position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; transition: background-color 0.3s ease-in-out; }
        .top-bar__title {
			font-size: var(--fs-lg);
			font-weight: 800;
			padding-left: var(--sp-2);
			/* flex: 1;  <-- Eliminamos esta línea para que no ocupe espacio */
			text-align: center; 
		}
		
        /* === INICIO: NUEVOS ESTILOS PARA EL TÍTULO DE PÁGINA === */
        #page-title-display {
            font-size: var(--fs-base); /* Tamaño de fuente más pequeño */
            font-weight: 700;
            margin-left: var(--sp-3); /* Espacio respecto al botón A/B */
            color: inherit;
            white-space: nowrap; /* Evita que el título se parta en dos líneas */
        }
        /* === FIN: NUEVOS ESTILOS PARA EL TÍTULO DE PÁGINA === */
        .top-bar__actions { display: flex; align-items: center; gap: var(--sp-1); }
         .top-bar__left-button {
            min-width: 85px;
            display: flex;
            align-items: center;
        }
		 .top-bar__left-group {
			display: flex;
			align-items: center;
			gap: var(--sp-3); 
		}
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background-color: var(--c-surface); border-top: 1px solid var(--c-outline); display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 200; box-shadow: 0 -2px 15px rgba(0,0,0,0.2); height: 48px; }
        .bottom-nav__item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--sp-1) var(--sp-2); cursor: pointer; transition: color 0.2s; color: var(--c-on-surface-tertiary); border: none; background: none; }
        .bottom-nav__item--active { color: var(--c-primary); }
        .bottom-nav__item .material-icons { font-size: 22px; } 
        .bottom-nav__label { display: none; font-size: var(--fs-xs); margin-top: 2px; }

        .fab { position: fixed; bottom: calc(56px + env(safe-area-inset-bottom)); right: var(--sp-5); width: 56px; height: 56px; background-color: var(--c-primary); color: var(--c-white); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md); z-index: 50; transform: scale(0); opacity: 0; transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .fab--visible { transform: scale(1); opacity: 1; }
        .fab:hover { transform: scale(1.08) !important; box-shadow: 0 0 25px var(--c-primary-glow); } .fab .material-icons { font-size: 28px; }
        
                .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1050;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
        }

        .app-layout.app-layout--transformed-by-modal {
            transform: scale(0.95) translateY(-10px); 
            border-radius: var(--border-radius-lg); 
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .modal-overlay--active {
            opacity: 1;
            pointer-events: auto;
        }

        .app-layout {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-radius 0.4s;
        }
                .modal {
            background: var(--c-surface);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            padding: var(--sp-5);
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-overlay--active .modal {
            transform: translateY(0); 
        }
        
        .card__title { font-size: var(--fs-lg); font-weight: 700; margin-bottom: var(--sp-3); display: flex; align-items: center; gap: var(--sp-2); color: var(--c-primary); padding: var(--sp-4) var(--sp-4) 0 var(--sp-4); }
        .card__content { padding: 0 var(--sp-4) var(--sp-4) var(--sp-4); }
        .card__title .material-icons { font-size: var(--fs-lg); }
        .card--no-bg { background: none; border: none; box-shadow: none; padding: 0; border-radius: 0; }
        .card--no-bg::before { display: none; }
        .chart-container { position: relative; height: 220px; width: 100%; margin-bottom: var(--sp-4); }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--sp-3); }
        
        .kpi-item { border-radius: var(--border-radius-lg); padding: var(--sp-3); text-align: center; transition: background-color 0.3s, transform 0.2s; }
        .kpi-item:hover { background-color: var(--c-surface-variant); transform: translateY(-2px); }
        .kpi-item__label { font-size: var(--fs-xs); font-weight: 600; color: var(--c-on-surface-secondary); margin-bottom: var(--sp-1); text-transform: uppercase; }
        .kpi-item__value { font-size: var(--fs-base); font-weight: 800; }
        .kpi-item__comparison { font-size: var(--fs-xs); font-weight: 500; margin-top: var(--sp-1); height: 14px; }
        #movimientos-list-container { position: relative; padding: 0 var(--sp-4); }
        #virtual-list-sizer { position: relative; width: 100%; }
        #virtual-list-content { position: absolute; top: 0; left: 0; width: 100%; }

        .transaction-card {
    display: flex;
    align-items: flex-start;
    padding: var(--sp-2) 0;
    cursor: pointer;
    border-bottom: 1px solid var(--c-outline);
    line-height: 1.25;
    min-height: 64px; /* <--- AÑADE ESTA LÍNEA */
    transition: background-color 0.2s;
    user-select: none;
}
        .transaction-card:hover { background-color: var(--c-surface-variant); }
        .transaction-card:last-child { border-bottom: none; }
        .transaction-card__indicator { flex-shrink: 0; width: 3px; align-self: stretch; border-radius: 99px; margin-right: var(--sp-2); }
        .transaction-card__indicator--income { background-color: var(--c-success); }
        .transaction-card__indicator--expense { background-color: var(--c-danger); }
        .transaction-card__indicator--transfer { background-color: var(--c-info); }
        .transaction-card__indicator--recurrent { background-color: var(--c-warning); }
        .transaction-card__content { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; min-width: 0; }
        .transaction-card__details { flex-grow: 1; min-width: 0; padding-right: var(--sp-2); }
        .transaction-card__row-1, .transaction-card__concept { font-size: var(--fs-sm); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__row-2, .transaction-card__description { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-card__figures { flex-shrink: 0; text-align: right; }
        .transaction-card__amount { font-size: var(--fs-sm); font-weight: 700; display: block; }
        
        .transaction-card__balance { font-size: 0.7rem; color: var(--c-on-surface-secondary); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        
        .transaction-card__transfer-details { display: flex; flex-direction: column; gap: 0; margin: 2px 0 0 0; }
        .transaction-card__transfer-row { display: flex; justify-content: space-between; align-items: center; color: var(--c-on-surface-secondary); font-size: 0.75rem; }
        .transaction-card__transfer-row .material-icons { font-size: 11px; vertical-align: middle; margin-right: var(--sp-1); }
        .transaction-card__transfer-row > span:first-child { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #movimiento-modal .modal__actions { margin-top: var(--sp-4); display: flex; justify-content: space-between; align-items: center; gap: var(--sp-2); width: 100%; }
        #movimiento-modal .modal__actions .left-actions,
        #movimiento-modal .modal__actions .right-actions { display: flex; gap: var(--sp-2); align-items: center; }
        .swipe-container { position: relative; overflow: hidden; }
        .swipe-container .transaction-card { position: relative; z-index: 2; background-color: var(--c-background); transition: transform 0.3s ease-out; }
        .swipe-actions-container { position: absolute; top: 0; bottom: 0; display: flex; align-items: center; z-index: 1; }
        .swipe-actions-container.left { left: 0; }
        .swipe-actions-container.right { right: 0; }
        .swipe-action-btn { width: 75px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--c-white); border: none; cursor: pointer; font-size: var(--fs-xs); font-weight: 600; gap: 4px; }
        .swipe-action-btn .material-icons { font-size: 20px; }
        .swipe-action-btn.duplicate { background-color: var(--c-info); }
        .swipe-action-btn.delete { background-color: var(--c-danger); }

        .accordion { margin-bottom: 0; background-color: var(--c-surface); overflow: hidden; }
        .accordion-wrapper > .accordion:first-child { border-top-left-radius: var(--border-radius-lg); border-top-right-radius: var(--border-radius-lg); }
        .accordion-wrapper > .accordion:last-child { border-bottom-left-radius: var(--border-radius-lg); border-bottom-right-radius: var(--border-radius-lg); }
        .accordion-wrapper > .accordion:not(:last-child) { border-bottom: 1px solid var(--c-outline); border-radius: 0; }
        .accordion-wrapper > .accordion:not(:last-child) > summary { border-bottom: none; }
        .accordion[open] > summary { border-bottom: 1px solid var(--c-outline); }
        .accordion > summary { font-weight: 700; cursor: pointer; padding: var(--sp-3) var(--sp-4); display: flex; align-items: center; justify-content: space-between; list-style: none; font-size: var(--fs-base); }
        .accordion > summary::-webkit-details-marker { display: none; }
        .accordion > summary .accordion__icon { transition: transform 0.2s; color: var(--c-on-surface-secondary); }
        .accordion[open] > summary .accordion__icon { transform: rotate(180deg); }
        .accordion__content { padding: 0 var(--sp-4) var(--sp-4) var(--sp-4); }
        .card > .accordion { border-radius: 0; }
        .account-group { background: var(--c-surface); border-radius: var(--border-radius-lg); margin-bottom: var(--sp-3); overflow: hidden; }
        .account-group__header { display: flex; justify-content: space-between; align-items: center; padding: var(--sp-2) var(--sp-4); border-bottom: 1px solid var(--c-outline); }
        .account-group__name { font-size: var(--fs-base); font-weight: 700; }
        .account-group__balance { font-size: var(--fs-sm); font-weight: 600; }
        .account-group .modal__list-item { padding: var(--sp-2) var(--sp-4); }
        .form-group { margin-bottom: var(--sp-3); position: relative; }
        .form-label { display: block; font-size: var(--fs-sm); font-weight: 600; margin-bottom: var(--sp-2); color: var(--c-on-surface-secondary); }
        .form-input, .form-select { width: 100%; padding: var(--sp-3); border: 1px solid var(--c-outline); border-radius: var(--border-radius-md); background: var(--c-surface-variant); color: var(--c-on-surface); font-size: var(--fs-base); appearance: none; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--c-primary); background-color: var(--c-surface); box-shadow: 0 0 10px var(--c-primary-glow); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23FFFFFF' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 12px center; background-size: 14px; padding-right: 36px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr; gap: var(--sp-3); }
        
        .form-group-addon {
    display: flex;
    align-items: center;
    gap: var(--sp-2);
}
        .form-group-addon .form-group { flex-grow: 1; margin-bottom: 0; }
        .form-error { color: var(--c-danger); font-size: var(--fs-xs); margin-top: var(--sp-1); min-height: 14px; display: block; font-weight: 600; }
        .form-input--invalid { border-color: var(--c-danger) !important; box-shadow: var(--glow-red) !important; }
        .form-checkbox-group { display: flex; align-items: center; gap: var(--sp-2); margin-bottom: var(--sp-2); }
        .form-checkbox-group label { margin-bottom: 0; font-weight: normal; }
        .form-checkbox-group input[type="radio"], .form-checkbox-group input[type="checkbox"] { accent-color: var(--c-primary); }
        .form-switch-group { display: flex; align-items: center; justify-content: space-between; }
        .form-switch { position: relative; display: inline-block; width: 44px; height: 26px; }
        .form-switch input { opacity: 0; width: 0; height: 0; }
        .form-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--c-surface-variant); transition: .4s; border-radius: 34px; border: 1px solid var(--c-outline); }
        .form-switch .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        .form-switch input:checked + .slider { background-color: var(--c-success); border-color: var(--c-success); }
        .form-switch input:checked + .slider:before { transform: translateX(18px); }
        .btn { padding: var(--sp-3) var(--sp-4); border: 1px solid transparent; border-radius: var(--border-radius-md); font-size: var(--fs-sm); font-weight: 700; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: var(--sp-2); -webkit-user-select: none; user-select: none; }
        .btn:active { transform: scale(0.97); }
        .btn--primary { background-color: var(--c-primary); color: var(--c-white); border-color: var(--c-primary); } .btn--primary:hover { background-color: var(--c-primary-hover); border-color: var(--c-primary-hover); box-shadow: var(--shadow-md); }
        .btn--secondary { background-color: var(--c-surface-variant); color: var(--c-on-surface); border: 1px solid var(--c-outline); } .btn--secondary:hover { background-color: var(--c-outline); border-color: var(--c-on-surface-tertiary); }
        .btn--danger { background-color: var(--c-danger); color: var(--c-white); } .btn--danger:hover { box-shadow: var(--glow-red); }
        .btn--full { width: 100%; } .btn--loading { pointer-events: none; opacity: .8; }
        .icon-btn { background: none; border: none; color: var(--c-on-surface-secondary); cursor: pointer; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s, transform 0.2s; }
        .icon-btn .material-icons { font-size: 20px; }
        .icon-btn:hover { background-color: var(--c-surface-variant); color: var(--c-primary); }
        .icon-btn:active { transform: scale(0.9); }
        .modal__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--sp-3); flex-shrink: 0;}
        .modal__title { font-size: var(--fs-xl); font-weight: 800; }
        .modal__body { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; padding-right: var(--sp-2); margin-right: calc(-1 * var(--sp-2)); }
        .modal__list-item { display:flex; justify-content:space-between; align-items:center; padding: var(--sp-3) 0; border-bottom:1px solid var(--c-outline); gap: var(--sp-2); }
        .modal__list-item:last-child { border-bottom: none; }
        .modal__actions { margin-top: var(--sp-4); display: flex; justify-content: flex-end; gap: var(--sp-2); width: 100%;}
        #generic-modal-body h3, #generic-modal-body h4 { margin-top: 1.2em; margin-bottom: 0.6em; color: var(--c-primary); font-weight: 700; } 
        #generic-modal-body h4 { font-size: var(--fs-base); } 
        #generic-modal-body p, #generic-modal-body li, #generic-modal-body small { color: var(--c-on-surface-secondary); line-height: 1.5; } 
        #generic-modal-body ul, #generic-modal-body ol { list-style-position: inside; padding-left: var(--sp-2); } 
        #generic-modal-body ul li, #generic-modal-body ol li { margin-bottom: 6px; }
        #generic-modal-body ul ul { margin-top: 6px; }
        #generic-modal-body a { color: var(--c-primary); text-decoration: none; font-weight: 600; }
        #generic-modal-body a:hover { text-decoration: underline; }
        .login-view { position: fixed; inset: 0; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: var(--sp-4); opacity: 0; transition: opacity .5s; background-color: var(--c-background); }
        .login-view--visible { display: flex; opacity: 1; }
        .login-view__card { padding: var(--sp-5); border-radius: var(--border-radius-lg); box-shadow: 0 0 30px rgba(0,0,0,0.5); width: 100%; max-width: 340px; text-align: center; animation: pop-in 0.3s ease-out; }
        .login-view__title { margin-bottom: var(--sp-4); font-size: var(--fs-xl); font-weight: 800; }
        .empty-state { text-align: center; padding: var(--sp-5) 0; color: var(--c-on-surface-secondary); animation: fade-in 0.3s; border-radius: var(--border-radius-lg); }
        .empty-state .material-icons { font-size: 40px; margin-bottom: var(--sp-2); color: var(--c-primary); }
        .empty-state h3 { font-size: var(--fs-lg); font-weight: 700; color: var(--c-on-surface); margin-bottom: var(--sp-2); }
        .filter-pills { display: flex; flex-wrap: wrap; gap: var(--sp-2); margin-bottom: var(--sp-4); }
        .filter-pill { padding: var(--sp-1) var(--sp-3); border: 1px solid var(--c-outline); border-radius: 99px; font-size: var(--fs-xs); font-weight: 600; background-color: var(--c-surface-variant); color: var(--c-on-surface); cursor: pointer; transition: all 0.2s; }
        .filter-pill:hover { opacity: 0.8; border-color: var(--c-primary); }
        .filter-pill--active { background-color: var(--c-primary); color: var(--c-white); font-weight: 700; border-color: var(--c-primary); }
        
        .toast-container { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: var(--sp-2); pointer-events: none;}
        .toast { background-color: var(--c-surface); color: var(--c-white); padding: var(--sp-2) var(--sp-4); border-radius: var(--border-radius-md); box-shadow: 0 0 20px rgba(0,0,0,0.5); pointer-events: all; border: 1px solid var(--c-outline); }
        .toast--danger { background-color: var(--c-danger); border-color: var(--c-danger); }
        .toast--warning { background-color: var(--c-warning); border-color: var(--c-warning); color: var(--c-black); }
        .toast--info { background-color: var(--c-info); border-color: var(--c-info); }
        .text-positive { color: var(--c-success); } .text-negative { color: var(--c-danger); } .text-warning { color: var(--c-warning); } .text-info { color: var(--c-info); }
        .hidden { display: none !important; }
        .spinner { display: inline-block; width: 1em; height: 1em; border: .15em solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin .8s linear infinite; vertical-align: middle; }
        @keyframes spin { to { transform:rotate(360deg); } }
		@keyframes fade-out-and-collapse {
    from {
        opacity: 1;
        transform: scaleY(1);
        max-height: 76px; /* Altura máxima de un item */
        padding-top: var(--sp-2);
        padding-bottom: var(--sp-2);
    }
    to {
        opacity: 0;
        transform: scaleY(0.8);
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        margin: 0;
        border: 0;
    }
}
.item-deleting {
    animation: fade-out-and-collapse 0.4s ease-out forwards;
    overflow: hidden;
}
        #description-suggestions { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: var(--c-surface); border-radius: var(--border-radius-md); box-shadow: 0 10px 20px rgba(0,0,0,0.4); z-index: 1060; max-height: 150px; overflow-y: auto; border: 1px solid var(--c-outline); }
        .suggestion-item { padding: var(--sp-2) var(--sp-3); cursor: pointer; font-size: var(--fs-sm); }
        .suggestion-item:hover { background-color: var(--c-surface-variant); }
        .suggestion-item small { color: var(--c-on-surface-secondary); font-size: var(--fs-xs); }
        .budget-track-item { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: var(--sp-3); padding: var(--sp-2) 0; border-bottom: 1px solid var(--c-outline); }
        .budget-track-item:last-child { border-bottom: none; }
        .budget-track-item__main { display: flex; flex-direction: column; gap: var(--sp-1); min-width: 0; }
        .budget-track-item__concept-name { font-weight: 700; font-size: var(--fs-sm); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .budget-track-item__figures { display: flex; flex-direction: column; align-items: flex-end; text-align: right; font-size: var(--fs-xs); }
        .budget-track-item__amount { color: var(--c-on-surface-secondary); }
        .budget-track-item__amount strong { color: var(--c-on-surface); font-weight: 600;}
        .budget-track-item__difference { font-weight: 700; }
        .budget-item__progress { width: 100%; -webkit-appearance: none; appearance: none; height: 6px; border-radius: 99px; overflow: hidden; background-color: var(--c-surface-variant); }
        .budget-item__progress::-webkit-progress-bar { background-color: var(--c-surface-variant); }
        .budget-item__progress::-webkit-progress-value { background-color: var(--c-primary); transition: width 0.3s ease; }
        .budget-item__progress.budget-item__progress--danger::-webkit-progress-value { background-color: var(--c-danger); }
        .budget-item__progress.budget-item__progress--warning::-webkit-progress-value { background-color: var(--c-warning); }
        .investment-asset-card { background-color: var(--c-surface); border: 1px solid var(--c-outline); border-radius: var(--border-radius-lg); padding: var(--sp-3); margin-bottom: var(--sp-2); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; }
        .investment-asset-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--c-primary); }
        .investment-asset-card__header { display: grid; grid-template-columns: 1fr auto; align-items: flex-start; gap: var(--sp-2); }
        .investment-asset-card__name { font-size: var(--fs-base); font-weight: 700; }
        .investment-asset-card__value { font-size: var(--fs-lg); font-weight: 800; text-align: right; }
        .investment-asset-card__pnl { font-size: var(--fs-xs); font-weight: 600; text-align: right; }
        .investment-timeline-item { display: flex; align-items: center; gap: var(--sp-3); padding: var(--sp-2) 0; border-bottom: 1px solid var(--c-outline); }
        .investment-timeline-item:last-child { border-bottom: none; }
        .investment-timeline-item__icon { flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background-color: var(--c-surface-variant); border-radius: 50%; }
        .investment-timeline-item__icon .material-icons { font-size: 18px; }
        .investment-timeline-item__details { flex-grow: 1; }
        .investment-timeline-item__description { font-weight: 600; font-size: var(--fs-sm); }
        .investment-timeline-item__date { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); }
        .investment-timeline-item__amount { font-weight: 700; font-size: var(--fs-sm); }
        #exit-screen { display: none; opacity: 0; position: fixed; inset: 0; background-color: var(--c-background); color: var(--c-on-surface); flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-size: 1.5rem; text-align: center; transition: opacity 0.5s ease; }
/* ================================================================= */
/* === INICIO: NUEVOS ESTILOS PARA CALCULADORA FLOTANTE (SIN SCROLL) === */
/* ================================================================= */

/* Contenedor de la calculadora: ahora es un overlay flotante */
#movimiento-modal .calculator-ui {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10; /* Asegura que esté sobre el contenido del modal */
    
    background-color: var(--c-surface-variant);
    border-top: 1px solid var(--c-outline);
    padding: var(--sp-3);
    padding-bottom: calc(var(--sp-3) + env(safe-area-inset-bottom)); /* Respetar notch del iPhone */
    border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
    box-shadow: 0 -5px 20px rgba(0,0,0,0.3);

    /* Lógica de visibilidad con animación de deslizamiento */
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    visibility: hidden;
}

#movimiento-modal .calculator-ui--visible {
    transform: translateY(0);
    visibility: visible;
}

/* IMPORTANTE: Eliminamos la regla que causaba el scroll */
#movimiento-modal .modal__body.calculator-active {
   padding-bottom: 0; /* Ya no es necesario */
}

/* El resto de los estilos de la calculadora se mantienen, pero con selectores actualizados */
#movimiento-modal .calculator-display {
    font-size: 2.1rem;
    font-weight: 300;
    text-align: right;
    padding: var(--sp-1) var(--sp-3);
    margin-bottom: var(--sp-3);
    min-height: 48px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#movimiento-modal .calculator-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}

#movimiento-modal .calculator-btn {
    font-family: var(--font-family);
    font-size: 1.2rem;
    font-weight: 500;
    height: 48px;
    border-radius: var(--border-radius-md);
    border: none;
    background-color: var(--c-surface);
    color: var(--c-on-surface);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, transform 0.1s;
}

#movimiento-modal .calculator-btn:active {
    transform: scale(0.95);
}

#movimiento-modal .calculator-btn.btn-operator {
    background-color: var(--c-surface-variant);
    color: var(--c-primary);
}

#movimiento-modal .calculator-btn.btn-confirm {
    background-color: var(--c-primary);
    color: var(--c-white);
}

#movimiento-modal .calculator-btn.zero {
    grid-column: span 2;
}

#movimiento-modal .material-icons.backspace-icon {
    font-size: 1.2rem;
}
/* === FIN: NUEVOS ESTILOS PARA CALCULADORA FLOTANTE === */
        
		/* * === ESTILOS PARA EL BOTÓN DE CAMBIO DE CONTABILIDAD (A/B) === */
        body[data-ledger-mode="A"] #ledger-toggle-btn {
            background-color: var(--c-primary);
            border-color: var(--c-primary);
            color: var(--c-white);
            box-shadow: var(--shadow-sm); 
        }

        body[data-ledger-mode="A"] #ledger-toggle-btn:hover {
            background-color: var(--c-primary-hover);
            border-color: var(--c-primary-hover);
            box-shadow: var(--shadow-md);
        }

        body[data-ledger-mode="B"] #ledger-toggle-btn {
            background-color: var(--c-danger);
            border-color: var(--c-danger);
            color: var(--c-white);
            box-shadow: var(--shadow-sm); 
        }

        body[data-ledger-mode="B"] #ledger-toggle-btn:hover {
            background-color: color-mix(in srgb, var(--c-danger) 85%, black); 
            border-color: color-mix(in srgb, var(--c-danger) 85%, black);
            box-shadow: var(--glow-red); 
        }
        body[data-ledger-mode="A"] .top-bar { background-color: #002D5B; } /* Azul oscuro */
        body[data-ledger-mode="A"] .top-bar, body[data-ledger-mode="A"] .top-bar .btn { color: var(--c-white); }
        body[data-ledger-mode="B"] .top-bar { background-color: #5B0000; } /* Rojo oscuro */
        body[data-ledger-mode="B"] .top-bar, body[data-ledger-mode="B"] .top-bar .btn { color: var(--c-white); }
        body[data-ledger-mode="B"] .bottom-nav__item--active { color: var(--c-danger); }
        #ledger-toggle-btn { font-weight: 700; padding: 6px 10px; font-size: 0.8rem; min-width: 40px; text-align: center; }

        #global-search-modal .modal { max-width: 600px; height: 70vh; border-radius: var(--border-radius-lg); }
        #global-search-modal .modal__body { padding: 0; margin-right: 0; }
        #global-search-input-wrapper { padding: 0 var(--sp-4) var(--sp-3) var(--sp-4); border-bottom: 1px solid var(--c-outline); display: flex; align-items: center; gap: var(--sp-3); }
        #global-search-input { width: 100%; font-size: var(--fs-lg); border: none; background: transparent; color: var(--c-on-surface); padding: var(--sp-2) 0; }
        #global-search-input:focus { outline: none; }
        #global-search-results { padding: var(--sp-2) 0; }
        .search-result-group__title { font-size: var(--fs-xs); font-weight: 700; text-transform: uppercase; color: var(--c-on-surface-secondary); padding: var(--sp-2) var(--sp-4); background-color: var(--c-surface-variant); }
        .search-result-item { display: flex; align-items: center; gap: var(--sp-3); padding: var(--sp-2) var(--sp-4); cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .search-result-item:hover { background-color: var(--c-surface-variant); }
        .search-result-item__icon { color: var(--c-on-surface-secondary); }
        .search-result-item__details p { font-size: var(--fs-sm); font-weight: 600; color: var(--c-on-surface); }
        .search-result-item__details small { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); }
        .inline-edit-form { width: 100%; display: flex; flex-direction: column; gap: var(--sp-2); padding: var(--sp-2) 0; }
        .inline-edit-form .form-input { padding: var(--sp-2); }
        .inline-edit-form .form-label { font-size: var(--fs-xs); margin-bottom: 4px; }
        
        .widget-config-item { display: flex; align-items: center; gap: var(--sp-3); background-color: var(--c-surface-variant); padding: var(--sp-2) var(--sp-3); border-radius: var(--border-radius-md); margin-bottom: var(--sp-2); }
        .widget-config-item.dragging { opacity: 0.5; background: var(--c-primary); }
        .widget-config-item .drag-handle { cursor: grab; color: var(--c-on-surface-secondary); }
        .widget-config-item .drag-handle:active { cursor: grabbing; }
        .widget-config-item__details { flex-grow: 1; }
        .widget-config-item__title { font-weight: 700; font-size: var(--fs-sm); }
        .widget-config-item__desc { font-size: var(--fs-xs); color: var(--c-on-surface-secondary); }

                
        #list-loader { text-align: center; padding: var(--sp-4); color: var(--c-on-surface-secondary); }
        
        .json-wizard-step { display: flex; flex-direction: column; height: 100%; }
        #json-drop-zone {
            border: 2px dashed var(--c-outline);
            border-radius: var(--border-radius-lg);
            padding: var(--sp-6);
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #json-drop-zone.drag-over {
            border-color: var(--c-primary);
            background-color: color-mix(in srgb, var(--c-primary) 10%, transparent);
        }
        #json-preview-list { list-style: none; padding-left: 0; }
        #json-preview-list li {
            background-color: var(--c-surface-variant);
            padding: var(--sp-3);
            border-radius: var(--border-radius-md);
            margin-bottom: var(--sp-2);
            display: flex;
            align-items: center;
            gap: var(--sp-3);
        }
        #json-preview-list .material-icons { color: var(--c-success); }

        .movimiento-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background-color: var(--c-surface-variant);
            color: var(--c-on-surface);
            font-weight: 700;
            font-size: var(--fs-sm);
            border-radius: 99px; 
            margin-top: var(--sp-4);
            margin-bottom: var(--sp-2);
        }

#movimiento-modal .form-group {
    margin-bottom: var(--sp-2);
}

.modal__grabber {
    width: 40px;
    height: 5px;
    background-color: var(--c-outline);
    border-radius: 99px;
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
}

#movimiento-fecha-display {
    justify-content: space-between;
    font-weight: 500;
    padding-top: var(--sp-3);
    padding-bottom: var(--sp-3);
}

#movimiento-fecha-display .material-icons {
    color: var(--c-on-surface-tertiary);
    font-size: 18px;
}

.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}
        @media (min-width: 768px) {
            .app-layout { max-width: 95%; }
            .top-bar, .bottom-nav { max-width: 100%; }
            .modal-overlay { align-items: center; }
			.calculator-overlay {
				align-items: flex-end !important; }
            .modal { border-radius: var(--border-radius-lg); transform: translateY(0) scale(0.95); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s; }
            .modal-overlay--active .modal { transform: translateY(0) scale(1); }
            .view { padding: 0 var(--sp-5); }
            .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--sp-4); }
            .form-grid { grid-template-columns: 1fr 1fr; }
        }

        @media (min-width: 1024px) {
            body { overflow-y: auto; }
            .app-layout { flex-direction: row; max-width: 100%; height: 100vh; }
            .bottom-nav { position: fixed; flex-direction: column; width: 240px; height: 100vh; left: 0; top: 0; transform: none; border-top: none; border-right: 1px solid var(--c-outline); padding: var(--sp-5) var(--sp-3); justify-content: flex-start; gap: var(--sp-2); box-shadow: none; background-color: var(--c-background); }
            .bottom-nav__item { flex: 0 0 auto; flex-direction: row; justify-content: flex-start; width: 100%; height: auto; padding: var(--sp-2) var(--sp-3); border-radius: var(--border-radius-md); }
            .bottom-nav__item:hover { background-color: var(--c-surface-variant); }
            body[data-ledger-mode="A"] .bottom-nav__item--active { background-color: var(--c-primary); color: var(--c-white); }
            body[data-ledger-mode="B"] .bottom-nav__item--active { background-color: var(--c-danger); color: var(--c-white); }
            body[data-ledger-mode="A"] .bottom-nav__item--active:hover { background-color: var(--c-primary-hover); }
            body[data-ledger-mode="B"] .bottom-nav__item--active:hover { background-color: color-mix(in srgb, var(--c-danger) 80%, white); }
            .bottom-nav__item .material-icons { margin-right: var(--sp-3); font-size: 20px; }
            .bottom-nav__label { display: inline-block; font-size: var(--fs-sm); font-weight: 600; margin-top: 0; }
            .app-layout__main { margin-left: 240px; width: calc(100% - 240px); height: 100vh; padding: 60px var(--sp-6) var(--sp-6) var(--sp-6); }
            .view { max-width: 1100px; margin: 0 auto; padding: 0; }
            .top-bar { max-width: none; width: calc(100% - 240px); left: auto; right: 0; transform: none; padding-left: var(--sp-6); padding-right: var(--sp-6); }
            .toast-container { bottom: var(--sp-4); left: auto; right: calc(240px / 2); transform: translateX(50%); }
        }
		.movements-modal-container {
    max-height: 60vh;
    overflow-y: auto;
}

/* ================================================================= */
/* === INICIO: NUEVO TEMA "AURORA GLASS" (DISEÑO ESPECTACULAR) === */
/* ================================================================= */

/* --- Pseudo-elemento para el fondo animado --- */
body[data-theme="aurora"]::before {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background: 
        radial-gradient(ellipse 80% 80% at 20% -15%, rgba(45, 212, 191, 0.3), transparent),
        radial-gradient(ellipse 60% 60% at 80% 110%, rgba(167, 139, 250, 0.3), transparent),
        radial-gradient(ellipse 40% 40% at 50% 50%, rgba(0, 162, 255, 0.2), transparent),
        #0D1117; /* Fondo base muy oscuro, casi negro azulado */
    
    animation: aurora-flow 25s linear infinite;
    transition: background 0.5s ease;
}

@keyframes aurora-flow {
    0% { transform: rotate(0deg) scale(1.2); }
    50% { transform: rotate(180deg) scale(1.3); }
    100% { transform: rotate(360deg) scale(1.2); }
}


body[data-theme="aurora"] {
    /* === PALETA DE COLORES "AURORA" === */
    /* El primario es ahora un gradiente espectacular */
    --c-primary-gradient: linear-gradient(135deg, #2DD4BF 0%, #A78BFA 100%);
    --c-primary: #2DD4BF; /* Color estático para textos y elementos simples */
    --c-primary-hover: #5EEAD4;
    --c-secondary: #A78BFA; /* El otro extremo del gradiente */
    
    --c-danger: #F43F5E;  /* Rojo-rosa neón */
    --c-success: #34D399; /* Verde esmeralda vibrante */
    --c-warning: #FBBF24; /* Amarillo ámbar */
    --c-info: #60A5FA;    /* Azul suave */
    
    /* FONDO: Oscuridad profunda para máximo contraste */
    --c-background: #0D1117; 
    
    /* SUPERFICIES: El corazón del efecto "Glassmorphism" */
    --c-surface: rgba(20, 25, 40, 0.5); /* Tinte azulado semitransparente */
    --c-surface-variant: rgba(30, 35, 55, 0.6);
    --c-outline: rgba(255, 255, 255, 0.1); /* Borde de luz sutil */

    /* TEXTOS: Claridad y legibilidad */
    --c-on-surface: #F0F0F0;
    --c-on-surface-secondary: rgba(240, 240, 240, 0.65);
    --c-on-surface-tertiary: rgba(240, 240, 240, 0.4);
    
    /* SOMBRAS Y RESPLANDORES: Efecto Neón mejorado */
    --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.4);
    --glow-primary: 0 0 20px rgba(45, 212, 191, 0.2);
    --glow-red: 0 0 20px rgba(244, 63, 94, 0.3);
}

/* --- Ajustes Específicos para "Aurora Glass" --- */

body[data-theme="aurora"] {
    background-color: var(--c-background);
    background-image: none; /* Quitamos fondos estáticos anteriores */
}

/* Tarjetas, Modales, y superficies principales con el efecto "Glass" */
body[data-theme="aurora"] .card,
body[data-theme="aurora"] .modal,
body[data-theme="aurora"] .kpi-item,
body[data-theme="aurora"] .accordion,
body[data-theme="aurora"] .login-view__card,
body[data-theme="aurora"] .empty-state,
body[data-theme="aurora"] .top-bar,
body[data-theme="aurora"] .bottom-nav,
body[data-theme="aurora"] .calculator-ui {
    background-color: var(--c-surface);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--c-outline);
    box-shadow: var(--shadow-md);
    transition: background-color 0.3s, border-color 0.3s;
}

body[data-theme="aurora"] .card::before,
body[data-theme="aurora"] .modal::before,
body[data-theme="aurora"] .kpi-item::before,
body[data-theme="aurora"] .login-view__card::before,
body[data-theme="aurora"] .empty-state::before {
    display: none; /* Desactivamos el borde animado del tema por defecto */
}


body[data-theme="aurora"] .kpi-item:hover,
body[data-theme="aurora"] .investment-asset-card:hover {
    border-color: var(--c-primary);
    background-color: var(--c-surface-variant);
}

/* Botones Principales con Gradiente */
body[data-theme="aurora"] .btn--primary,
body[data-theme="aurora"] .fab,
body[data-theme="aurora"] .calculator-btn.btn-confirm {
    background-image: var(--c-primary-gradient);
    background-size: 200% auto;
    border: none;
    color: var(--c-white);
    transition: background-position 0.4s, box-shadow 0.3s;
    box-shadow: var(--glow-primary);
}
body[data-theme="aurora"] .btn--primary:hover,
body[data-theme="aurora"] .fab:hover,
body[data-theme="aurora"] .calculator-btn.btn-confirm:hover {
    background-position: right center; /* Mueve el gradiente al hacer hover */
    box-shadow: 0 0 25px rgba(45, 212, 191, 0.4);
}

/* Inputs y Selects */
body[data-theme="aurora"] .form-input,
body[data-theme="aurora"] .form-select {
    background-color: rgba(0,0,0,0.2);
    border: 1px solid var(--c-outline);
    box-shadow: none;
    color: var(--c-on-surface);
}
body[data-theme="aurora"] .form-input:focus,
body[data-theme="aurora"] .form-select:focus {
    border-color: var(--c-primary);
    background-color: rgba(0,0,0,0.3);
    box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.25);
}

/* Flecha del select con el color del texto */
body[data-theme="aurora"] .form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23F0F0F0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
}

/* Texto de la navegación activa con gradiente */
body[data-theme="aurora"] .bottom-nav__item--active {
    background: radial-gradient(circle, rgba(45, 212, 191, 0.15) 0%, transparent 70%);
    color: transparent; /* Hacemos el texto base transparente */
    -webkit-background-clip: text;
    background-clip: text;
    background-image: var(--c-primary-gradient); /* Aplicamos el gradiente al texto */
}

/* Calculadora con estética Aurora Glass */
body[data-theme="aurora"] .calculator-btn {
    background-color: rgba(255, 255, 255, 0.05);
}
body[data-theme="aurora"] .calculator-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
body[data-theme="aurora"] .calculator-btn.btn-operator {
    color: var(--c-secondary);
    background-color: rgba(167, 139, 250, 0.1);
}

/* Cabeceras de fecha en la lista de movimientos */
body[data-theme="aurora"] .movimiento-date-header {
    background-color: var(--c-surface-variant);
    border: 1px solid var(--c-outline);
    backdrop-filter: blur(10px);
}

/* Estrellas en la pantalla de intro más sutiles para no competir con la aurora */
body[data-theme="aurora"] .starry-background { 
    opacity: 0.3; 
    animation-duration: 40s;
}

/* ================================================================= */
/* === FIN: NUEVO TEMA "AURORA GLASS" === */
/* ================================================================= */

.csv-converter-modal .upload-area {
    border: 2px dashed var(--c-outline);
    border-radius: var(--border-radius-lg);
    padding: 2.5rem;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.3s, background-color 0.3s;
    margin-bottom: 1.5rem;
}
.csv-converter-modal .upload-area.drag-over {
    border-color: var(--c-primary);
    background-color: color-mix(in srgb, var(--c-primary) 10%, transparent);
}
.csv-converter-modal .upload-area p {
    margin: 0;
    color: var(--c-on-surface-tertiary);
}
.csv-converter-modal .upload-area strong {
    color: var(--c-primary);
}
.csv-converter-modal #file-name {
    font-weight: 600;
    color: var(--c-success);
    margin-top: 1rem;
    display: block;
    min-height: 24px;
}
.csv-converter-modal .results-log {
    margin-top: 2rem;
    background-color: var(--c-surface-variant);
    border: 1px solid var(--c-outline);
    border-radius: var(--border-radius-md);
    padding: 1.5rem;
    display: none;
}
.csv-converter-modal .results-log h2 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: var(--c-on-surface-secondary);
}
.csv-converter-modal .results-log ul {
    list-style: none;
    padding: 0;
}
.csv-converter-modal .results-log li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--c-outline);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.csv-converter-modal .results-log li:last-child {
    border-bottom: none;
}
.csv-converter-modal .results-log li .label {
    color: var(--c-on-surface-tertiary);
}
.csv-converter-modal .results-log li .value {
    font-weight: 700;
    color: var(--c-on-surface);
    padding: 0.1rem 0.5rem;
    border-radius: 6px;
}
.csv-converter-modal .results-log .value.success { background-color: color-mix(in srgb, var(--c-success) 20%, transparent); }
.csv-converter-modal .results-log .value.warning { background-color: color-mix(in srgb, var(--c-warning) 20%, transparent); }
.csv-converter-modal .results-log .value.danger { background-color: color-mix(in srgb, var(--c-danger) 20%, transparent); }
.csv-converter-modal #download-container {
    margin-top: 1.5rem;
    display: none;
}
#sync-status-icon {
    font-size: 20px;
    transition: color 0.3s ease-in-out, transform 0.3s ease;
}

.sync-status--synced {
    color: var(--c-success);
    transform: scale(1.1);
}

.sync-status--syncing .sync-icon-spinner {
    animation: spin 1.2s linear infinite;
}

.sync-status--error {
    color: var(--c-danger);
}

.login-view {
    background-color: transparent; 
}
.login-view .starry-background {
    opacity: 0.7; 
}

.login-view__card {
    padding: var(--sp-6) var(--sp-5); 
    max-width: 380px; 
    z-index: 10; 
    text-align: center;
}

.login-view__logo {
    max-width: 90px;
    height: auto;
    border-radius: 18px;
    margin-bottom: var(--sp-4);
    box-shadow: 0 0 25px rgba(255, 255, 255, 0.1);
}

.login-view__title {
    margin-bottom: var(--sp-1);
    font-size: var(--fs-xl);
    font-weight: 800;
}

.login-view__tagline {
    font-size: var(--fs-base);
    color: var(--c-on-surface-secondary);
    margin-bottom: var(--sp-5);
}

.form-group--with-icon {
    position: relative;
}

.form-group--with-icon .material-icons {
    position: absolute;
    left: var(--sp-3);
    top: 50%;
    transform: translateY(-50%);
    color: var(--c-on-surface-tertiary);
    pointer-events: none; 
    transition: color 0.2s;
}

.form-group--with-icon .form-input {
    padding-left: calc(var(--sp-3) * 2 + 24px); 
}

.form-group--with-icon .form-input:focus + .material-icons,
.form-group--with-icon .form-input:focus ~ .material-icons {
    color: var(--c-primary);
}

.login-view__actions {
    display: flex;
    justify-content: flex-end;
    margin-bottom: var(--sp-4);
}

.login-view__link {
    font-size: var(--fs-sm);
    color: var(--c-primary);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s;
}
.login-view__link:hover {
    color: var(--c-primary-hover);
    text-decoration: underline;
}

.login-view__footer {
    margin-top: var(--sp-4);
    width: 100%;
}

.login-view__secondary-action {
    margin-top: var(--sp-4);
    font-size: var(--fs-sm);
    color: var(--c-on-surface-secondary);
}

#login-form .form-grid {
    display: none;
}

.patrimonio-header-grid {
    display: flex;
    flex-direction: column; 
    gap: var(--sp-4);
    padding: var(--sp-4);
    margin-bottom: var(--sp-4);
}

.patrimonio-header-grid__filters .kpi-item__label {
    margin-bottom: var(--sp-3);
    font-weight: 600;
}

@media (min-width: 768px) {
    .patrimonio-header-grid {
        flex-direction: row; 
        align-items: flex-start; 
    }

    .patrimonio-header-grid__kpi {
        flex: 1; 
        min-width: 220px; 
    }

    .patrimonio-header-grid__filters {
        flex: 3; 
        padding-left: var(--sp-4);
        border-left: 1px solid var(--c-outline);
    }
}
 
#movimiento-modal .form-group {
    margin-bottom: var(--sp-2);
}

.modal__grabber {
    width: 40px;
    height: 5px;
    background-color: var(--c-outline);
    border-radius: 99px;
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
}

#movimiento-fecha-display {
    justify-content: space-between;
    font-weight: 500;
    padding-top: var(--sp-3);
    padding-bottom: var(--sp-3);
}

#movimiento-fecha-display .material-icons {
    color: var(--c-on-surface-tertiary);
    font-size: 18px;
}

.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.pin-inputs {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin: 2rem 0;
}

.pin-input {
    width: 50px;
    height: 60px;
    font-size: 2rem;
    text-align: center;
    border: 2px solid var(--c-outline);
    border-radius: var(--border-radius-md);
    background-color: var(--c-surface-variant);
    color: var(--c-on-surface);
    caret-color: var(--c-primary);
    transition: border-color 0.2s, box-shadow 0.2s;
}

.pin-input:focus {
    outline: none;
    border-color: var(--c-primary);
    box-shadow: var(--shadow-md);
}

.pin-input::-webkit-outer-spin-button,
.pin-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.pin-input[type=number] {
  -moz-appearance: textfield;
}
/* ================================================================= */
/* === INICIO: Iconos del encabezado Vistosos y con Colores Vivos === */
/* ================================================================= */

/* Base para todos los botones de icono en el encabezado */
.top-bar .top-bar__actions .icon-btn {
    width: 40px;
    height: 40px;
    position: relative;
    overflow: hidden; /* Necesario para el efecto de fondo */
    transition: transform 0.25s ease-out;
}

/* Estilo base para los iconos (preparación para el gradiente) */
.top-bar .top-bar__actions .icon-btn .material-icons {
    font-size: 24px;
    font-weight: 600; /* Hacemos el icono más grueso para que el color luzca más */
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent; /* El color se aplicará a través del fondo */
    transition: all 0.25s ease-out;
}

/* --- Colores y gradientes individuales para cada icono --- */

/* 1. Icono de Búsqueda (Azul/Violeta) */
.top-bar .top-bar__actions .icon-btn[data-action="global-search"] .material-icons {
    background-image: linear-gradient(45deg, var(--c-primary), var(--c-info));
    text-shadow: 0 0 8px color-mix(in srgb, var(--c-primary) 50%, transparent);
}

/* 2. Icono de Tema (Púrpura/Rosa) */
.top-bar .top-bar__actions .icon-btn[data-action="toggle-theme"] .material-icons {
    background-image: linear-gradient(45deg, var(--c-info), #F43F5E);
    text-shadow: 0 0 8px color-mix(in srgb, var(--c-info) 50%, transparent);
}

/* 3. Icono de Ayuda (Verde/Turquesa) */
.top-bar .top-bar__actions .icon-btn[data-action="help"] .material-icons {
    background-image: linear-gradient(45deg, var(--c-success), #2DD4BF);
    text-shadow: 0 0 8px color-mix(in srgb, var(--c-success) 50%, transparent);
}

/* 4. Icono de Salir (Rojo/Naranja) */
.top-bar .top-bar__actions .icon-btn[data-action="exit"] .material-icons {
    background-image: linear-gradient(45deg, var(--c-danger), var(--c-warning));
    text-shadow: 0 0 8px color-mix(in srgb, var(--c-danger) 50%, transparent);
}


/* --- Efecto de Interacción (Hover y Active) --- */

.top-bar .top-bar__actions .icon-btn:hover {
    transform: scale(1.15); /* El botón entero se agranda */
    background-color: color-mix(in srgb, var(--c-surface-variant) 80%, transparent);
}

/* El icono interior también reacciona */
.top-bar .top-bar__actions .icon-btn:hover .material-icons {
    transform: scale(1.1);
}

.top-bar .top-bar__actions .icon-btn:active {
    transform: scale(0.95);
    transition-duration: 0.1s;
}

/* ================================================================= */
/* === FIN: Iconos del encabezado Vistosos y con Colores Vivos    === */
/* ================================================================= */
 
/* ================================================================= */
/* === INICIO: AJUSTES DE RESPONSIVIDAD PARA ENCABEZADO PEQUEÑO   === */
/* ================================================================= */
@media (max-width: 380px) {
    /* Hacemos la fuente del título de la página un poco más pequeña */
    #page-title-display {
        font-size: var(--fs-sm); /* Usamos un tamaño de fuente predefinido más pequeño */
    }

    /* Reducimos ligeramente el espacio entre el botón A/B y el título */
    .top-bar__left-group {
        gap: var(--sp-2); 
    }

    /* Hacemos los botones de iconos de acción más pequeños */
    .top-bar .top-bar__actions .icon-btn {
        width: 36px;
        height: 36px;
    }

    /* Y también los propios iconos dentro de los botones */
    .top-bar .top-bar__actions .icon-btn .material-icons {
        font-size: 20px;
    }

    /* Reducimos el espacio entre los iconos de acción */
    .top-bar__actions {
        gap: 0;
    }
}
/* ================================================================= */
/* === FIN: AJUSTES DE RESPONSIVIDAD PARA ENCABEZADO PEQUEÑO      === */
/* ================================================================= */ 
 
    </style>
	
	
</head>
<body data-ledger-mode="A">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    
    <div id="introScreen" class="intro-screen">
        <div class="starry-background"></div>
        <img id="splashImage" class="intro-screen__logo" src="aiDANaI.webp" alt="Logo App" />
        <div id="quoteContainer" class="intro-screen__quote-container">
            <p id="quoteText" class="intro-screen__quote-text"></p>
            <span id="quoteAuthor" class="intro-screen__quote-author"></span>
        </div>
    </div>

<div id="login-screen" class="login-view">
    <div class="starry-background"></div>
    <div class="login-view__card">
        <img src="aiDANaI.webp" alt="Logo Cuentas aiDANaI" class="login-view__logo">
        
        <h2 id="login-title" class="login-view__title">Bienvenido de nuevo</h2>
        <p class="login-view__tagline">Inicia sesión para controlar tus finanzas.</p>

        <form id="login-form" noValidate>
            <div class="form-group form-group--with-icon">
                <span class="material-icons">alternate_email</span>
                <input type="email" id="login-email" class="form-input" placeholder="Correo electrónico" required autoComplete="email" autoCapitalize="none" />
                <span class="form-error" id="login-email-error"></span>
            </div>
            <div class="form-group form-group--with-icon">
                <span class="material-icons">lock</span>
                <input type="password" id="login-password" class="form-input" placeholder="Contraseña" required autoComplete="current-password" />
                <span class="form-error" id="login-password-error"></span>
            </div>

            <div class="login-view__actions">
                <a href="#" class="login-view__link" data-action="forgot-password">¿Olvidaste tu contraseña?</a>
            </div>

            <p id="login-error" class="form-error" style="min-height: 16px; margin-top: 8px;"></p>
            
            <div class="login-view__footer">
                <button type="submit" data-action="login" class="btn btn--primary btn--full">Iniciar Sesión</button>
                <p class="login-view__secondary-action">
                    <span>¿No tienes una cuenta?</span> <a href="#" class="login-view__link" data-action="show-register">Regístrate aquí</a>
                </p>
            </div>
        </form>
    </div>
</div>

<div id="pin-login-screen" class="login-view">
    <div class="starry-background"></div>
    <div class="login-view__card">
        <img src="aiDANaI.webp" alt="Logo" class="login-view__logo">
        <h2 class="login-view__title">Acceso Rápido</h2>
        <p class="login-view__tagline">Introduce tu PIN de 4 dígitos.</p>

        <form id="pin-form">
            <div class="pin-inputs" id="pin-inputs-container">
                <input type="password" class="pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="1" required>
                <input type="password" class="pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="1" required>
                <input type="password" class="pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="1" required>
                <input type="password" class="pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="1" required>
            </div>
            <p id="pin-error" class="form-error" style="min-height: 16px; margin-top: 8px;"></p>
        </form>
        
    <div class="login-view__footer">
    <p class="login-view__secondary-action">
        <a href="#" class="login-view__link" data-action="use-password-instead">
            Usar contraseña en su lugar
        </a>
    </p>
    <p class="login-view__secondary-action" style="margin-top: var(--sp-2);">
        <a href="#" class="login-view__link" data-action="logout">O iniciar sesión con otra cuenta</a>
    </p>
</div>
    </div>
</div>
    
    <div id="app-root" class="app-layout">
        <nav class="bottom-nav">
            <button data-action="navigate" data-page="inicio-page" class="bottom-nav__item">
                <span class="material-icons">dashboard</span>
                <span class="bottom-nav__label">Inicio</span>
            </button>
            <button data-action="navigate" data-page="movimientos-page" class="bottom-nav__item">
                <span class="material-icons">receipt_long</span>
                <span class="bottom-nav__label">Movimientos</span>
            </button>
            <button data-action="navigate" data-page="planificacion-page" class="bottom-nav__item">
                <span class="material-icons">edit_calendar</span>
                <span class="bottom-nav__label">Planificación</span>
            </button>
            <button data-action="navigate" data-page="patrimonio-page" class="bottom-nav__item">
                <span class="material-icons">account_balance</span>
                <span class="bottom-nav__label">Patrimonio</span>
            </button>
            <button data-action="navigate" data-page="configuracion-page" class="bottom-nav__item">
                <span class="material-icons">settings</span>
                <span class="bottom-nav__label">Ajustes</span>
            </button>
        </nav>

        <header id="app-top-bar" class="top-bar">
            <div class="top-bar__left-group">
                <span id="sync-status-icon" class="material-icons"></span>
                <div id="top-bar-left-button" class="top-bar__left-button">
                </div>
            </div>

            <h1 id="top-bar-title" class="top-bar__title"></h1>

            <div id="top-bar-actions" class="top-bar__actions"></div>
        </header>

        <main class="app-layout__main">
            
            <section id="inicio-page" class="view">
                <!-- El contenido se renderizará aquí vía JS (renderInicioPage) -->
            </section>

            <section id="movimientos-page" class="view" style="padding: 0; gap: 0;">
                <div id="movimientos-list-container">
                    <div id="virtual-list-sizer">
                        <div id="virtual-list-content"></div>
                    </div>
                    <div id="list-loader" class="hidden"><span class="spinner"></span></div>
                </div>
                <div id="empty-movimientos" class="empty-state hidden" style="margin: 0 var(--sp-4);">
                    <span class="material-icons">receipt_long</span>
                    <h3>Tu historial empieza aquí</h3>
                    <p>Pulsa el botón `+` para añadir tu primer ingreso o gasto.</p>
                </div>
            </section>

            <section id="planificacion-page" class="view">
                <!-- El contenido se renderizará aquí vía JS (renderPlanificacionPage) -->
            </section>
            
            <section id="patrimonio-page" class="view">
                <!-- El contenido se renderizará aquí vía JS (renderPatrimonioPage) -->
            </section>

            <section id="configuracion-page" class="view">
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">person_outline</span>
                                <span>Cuenta y Preferencias</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            
                            <h3 class="card__title" style="margin-top: 0; font-size: var(--fs-base); padding: 0;">
                                <span class="material-icons">account_circle</span>
                                <span>Cuenta de Usuario</span>
                            </h3>
                            <div class="modal__list-item" style="padding-left: 0; padding-right: 0; margin-top: var(--sp-2);">
                                <span>Sesión iniciada como:</span>
                                <strong id="config-user-email">cargando...</strong>
                            </div>
                            <button data-action="logout" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);">
                                <span class="material-icons" style="font-size: 16px;">logout</span>
                                <span>Cerrar Sesión</span>
                            </button>
                            <button data-action="set-pin" class="btn btn--secondary btn--full" style="margin-top: var(--sp-2);">
                                <span class="material-icons" style="font-size: 16px;">password</span>
                                <span>Configurar PIN de Acceso Rápido</span>
                            </button>
                            <button data-action="delete-account" class="btn btn--danger btn--full" style="margin-top: var(--sp-2); background-color: var(--c-black); border: 1px solid var(--c-danger);">
                                <span class="material-icons" style="font-size: 16px;">delete_forever</span>
                                <span>Eliminar Mi Cuenta Permanentemente</span>
                            </button>

                            <hr style="margin: var(--sp-5) 0; border-color: var(--c-outline); opacity: 0.5;">

                            <h3 class="card__title" style="margin-top: 0; font-size: var(--fs-base); padding: 0;">
                                <span class="material-icons">rocket_launch</span><span>Opciones de Arranque</span>
                            </h3>
                            <div class="form-checkbox-group" style="margin-top: var(--sp-2);">
                                <input type="checkbox" id="config-skip-intro" />
                                <label for="config-skip-intro">Omitir intro y cita al iniciar la app</label>
                            </div>
                            
                            <button data-action="save-config" class="btn btn--primary btn--full" style="margin-top: var(--sp-5);">Guardar Preferencias</button>

                        </div>
                    </details>
                </div>
                
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">edit_note</span><span>Gestión de Datos</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <button data-action="manage-cuentas" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">account_balance</span><span>Cuentas</span></button>
                                <button data-action="manage-conceptos" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">category</span><span>Conceptos</span></button>
                            </div>
                            <button data-action="recalculate-balances" class="btn btn--primary btn--full" style="margin-top: var(--sp-4);">
                                <span class="material-icons" style="font-size: 16px;">calculate</span>
                                <span>Recalcular Saldos de Cuentas</span>
                            </button>
                        </div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">backup</span><span>Copia de Seguridad</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-4);">La importación de JSON o CSV reemplazará todos los datos actuales. Se recomienda exportar primero para tener una copia de seguridad.</p>
                            <div class="form-grid">
                                <button data-action="export-data" class="btn btn--secondary" title="Exportar una copia de seguridad completa en formato JSON."><span class="material-icons" style="font-size: 16px;">save</span><span>Exportar JSON</span></button>
                                <button data-action="export-csv" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">grid_on</span>Exportar CSV</button>
                                <button data-action="import-data" class="btn btn--secondary" title="Importar desde un archivo de seguridad JSON."><span class="material-icons" style="font-size: 16px;">file_upload</span><span>Importar JSON</span></button>
                                <button data-action="import-csv" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">upload_file</span><span>Importar CSV</span></button>
                            </div>
                            <input type="file" id="import-file-input" class="hidden" accept=".json,application/json" />
                            <button data-action="clear-data" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);">Borrar Todos los Datos</button>
                        </div>
                    </details>
                </div>
            </section>

        </main>
        
        <button data-action="add-movement" id="fab-add-movimiento" class="fab" title="Añadir Movimiento" aria-label="Añadir Movimiento"><span class="material-icons">add</span></button>

    </div>

    <div id="toast-container" aria-live="assertive"></div>
    
    <div id="movimiento-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="form-movimiento-title">
        <div class="modal">
            <div class="modal__grabber"></div>
            <header class="modal__header" style="padding-top: var(--sp-2);">
                <h3 id="form-movimiento-title" class="modal__title">Añadir Movimiento</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="movimiento-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div class="modal__body">
                <form id="form-movimiento" novalidate>
            <input type="hidden" id="movimiento-id" />
            <input type="hidden" id="movimiento-mode" value="new" />
            
            <div class="filter-pills" style="justify-content: center; margin-bottom: var(--sp-3);">
                <button type="button" id="mov-type-btn-movimiento" class="filter-pill filter-pill--active" data-action="set-movimiento-type" data-type="movimiento">Ingreso/Gasto</button>
                <button type="button" id="mov-type-btn-traspaso" class="filter-pill" data-action="set-movimiento-type" data-type="traspaso">Traspaso</button>
            </div>

            <div class="form-grid" style="grid-template-columns: 40% 1fr; align-items: flex-start;">
                <div class="form-group">
                    <label for="movimiento-cantidad" class="form-label">Cantidad</label>
                    <input type="text" id="movimiento-cantidad" class="form-input input-amount-calculator" inputmode="none" required placeholder="Ej: -2,50" />
                    <span class="form-error" id="movimiento-cantidad-error"></span>
                </div>
                <div class="form-group">
                    <label for="movimiento-descripcion" class="form-label">Descripción</label>
                    <input type="text" id="movimiento-descripcion" class="form-input" required placeholder="Ej: Compra semanal" />
                    <span class="form-error" id="movimiento-descripcion-error"></span>
                    <div id="description-suggestions"></div>
                </div>
            </div>

            <div id="movimiento-fields">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group-addon">
                        <div class="form-group">
                            <label for="movimiento-concepto" class="form-label">Concepto</label>
                            <select id="movimiento-concepto" class="form-select" required></select>
                            <span class="form-error" id="movimiento-concepto-error"></span>
                        </div>
                        <button type="button" data-action="manage-conceptos" class="icon-btn" title="Gestionar Conceptos"><span class="material-icons">more_vert</span></button>
                    </div>
                    <div class="form-group-addon">
                        <div class="form-group">
                            <label for="movimiento-cuenta" class="form-label">Cuenta</label>
                            <select id="movimiento-cuenta" class="form-select" required></select>
                            <span class="form-error" id="movimiento-cuenta-error"></span>
                        </div>
                        <button type="button" data-action="manage-cuentas" class="icon-btn" title="Gestionar Cuentas"><span class="material-icons">more_vert</span></button>
                    </div>
                </div>
            </div>

            <div id="traspaso-fields" class="hidden">
                 <div class="form-group">
                    <label class="form-label" for="traspaso-show-all-accounts-toggle">Cuentas</label>
                    <div class="form-checkbox-group" style="margin-bottom: var(--sp-2);">
                        <input type="checkbox" id="traspaso-show-all-accounts-toggle" data-action="toggle-traspaso-accounts-filter" />
                        <label for="traspaso-show-all-accounts-toggle" style="font-size: var(--fs-xs);">Mostrar cuentas de ambas contabilidades (A y B)</label>
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label for="movimiento-cuenta-origen" class="form-label">Cuenta Origen</label>
                        <select id="movimiento-cuenta-origen" class="form-select"></select>
                        <span class="form-error" id="movimiento-cuenta-origen-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="movimiento-cuenta-destino" class="form-label">Cuenta Destino</label>
                        <select id="movimiento-cuenta-destino" class="form-select"></select>
                        <span class="form-error" id="movimiento-cuenta-destino-error"></span>
                    </div>
                </div>
            </div>
            
            <div style="border-top: 1px solid var(--c-outline); margin-top: var(--sp-3); padding-top: var(--sp-2);">
                <div class="form-switch-group modal__list-item" style="padding: var(--sp-2) 0;">
                    <label for="movimiento-recurrente" style="font-weight: 700;">¿Programar como recurrente?</label>
                    <label class="form-switch"><input type="checkbox" id="movimiento-recurrente"><span class="slider"></span></label>
                </div>
                <div id="recurrent-options" class="hidden" style="animation: fade-in 0.3s; margin-top: var(--sp-2);">
                    <div class="form-group">
                        <label for="recurrent-frequency" class="form-label">Frecuencia</label>
                        <select id="recurrent-frequency" class="form-select">
                            <option value="daily">Diaria</option>
                            <option value="weekly">Semanal</option>
                            <option value="monthly" selected>Mensual</option>
                            <option value="yearly">Anual</option>
                        </select>
                    </div>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="recurrent-next-date" class="form-label">Próxima ejecución</label>
                            <input type="date" id="recurrent-next-date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="recurrent-end-date" class="form-label">Finaliza el (opcional)</label>
                            <input type="date" id="recurrent-end-date" class="form-input">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: var(--sp-2);">
                <label for="movimiento-fecha-display" class="form-label">Fecha</label>
                <div class="form-group-addon">
                    <input type="date" id="movimiento-fecha" class="visually-hidden" required />
                    <button type="button" id="movimiento-fecha-display" class="btn btn--secondary" style="flex-grow: 1;">
                        <span id="movimiento-fecha-text"></span>
                        <span class="material-icons">edit_calendar</span>
                    </button>
                </div>
                <span class="form-error" id="movimiento-fecha-error"></span>
            </div>

            <div class="modal__actions">
                        <div class="left-actions">
                            <button type="button" id="delete-movimiento-btn" data-action="delete-movement-from-modal" class="icon-btn btn--danger hidden" title="Borrar"><span class="material-icons">delete</span></button>
                            <button type="button" id="duplicate-movimiento-btn" data-action="duplicate-movement" class="icon-btn btn--secondary hidden" title="Duplicar"><span class="material-icons">content_copy</span></button>
                        </div>
                        <div class="right-actions">
							<button id="save-and-new-movimiento-btn" type="button" data-action="save-and-new-movement" class="btn btn--secondary">Guardar y Nuevo</button>
							<button id="save-movimiento-btn" type="submit" class="btn btn--primary">Guardar</button>
						</div>
                    </div>
                </form>
			</div>
			<div id="calculator-ui" class="calculator-ui">
        <div id="calculator-display" class="calculator-display">0</div>
        <div id="calculator-grid" class="calculator-grid">
            <button class="calculator-btn btn-operator" data-key="clear">C</button>
            <button class="calculator-btn btn-operator" data-key="sign">+/-</button>
            <button class="calculator-btn btn-operator" data-key="backspace"><span class="material-icons backspace-icon">backspace</span></button>
            <button class="calculator-btn btn-confirm" id="calculator-btn-done" data-key="done">OK</button>
            
            <button class="calculator-btn" data-key="7">7</button>
            <button class="calculator-btn" data-key="8">8</button>
            <button class="calculator-btn" data-key="9">9</button>
            <button class="calculator-btn btn-operator" data-key="divide">/</button>

            <button class="calculator-btn" data-key="4">4</button>
            <button class="calculator-btn" data-key="5">5</button>
            <button class="calculator-btn" data-key="6">6</button>
            <button class="calculator-btn btn-operator" data-key="multiply">x</button>
            
            <button class="calculator-btn" data-key="1">1</button>
            <button class="calculator-btn" data-key="2">2</button>
            <button class="calculator-btn" data-key="3">3</button>
            <button class="calculator-btn btn-operator" data-key="subtract">-</button>

            <button class="calculator-btn zero" data-key="0">0</button>
            <button class="calculator-btn" data-key="comma">,</button>
            <button class="calculator-btn btn-operator" data-key="add">+</button>
        </div>
        </div>
    </div>
          
       
    
    </div>
	    <div id="generic-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="generic-modal-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="generic-modal-title" class="modal__title"></h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="generic-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="generic-modal-body" class="modal__body"></div>
        </div>
    </div>

<div id="global-search-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="global-search-title">
        <div class="modal">
            <header class="modal__header">
                <div id="global-search-input-wrapper">
                    <span class="material-icons" style="color: var(--c-on-surface-secondary);">search</span>
                    <input type="search" id="global-search-input" placeholder="Buscar en toda la app..." autocomplete="off">
                </div>
                <button class="icon-btn" data-action="close-modal" data-modal-id="global-search-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="global-search-results" class="modal__body">
                <div class="empty-state" style="background:transparent; border: none;">
                    <span class="material-icons">manage_search</span>
                    <h3>Encuéntralo todo</h3>
                    <p>Busca movimientos, cuentas o conceptos. <br>Atajo: <strong>Cmd/Ctrl + K</strong></p>
                </div>
            </div>
        </div>
    </div>
    
    
    <div id="json-import-wizard-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="json-wizard-title">
        <div class="modal" style="max-width: 500px; height: auto; max-height: 85vh;">
            <header class="modal__header">
                <h3 id="json-wizard-title" class="modal__title">Asistente de Importación JSON</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="json-import-wizard-modal" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="json-wizard-body" class="modal__body" style="display: flex; flex-direction: column;">

                <div id="json-wizard-step-1" class="json-wizard-step">
                    <h4>Paso 1: Selecciona tu copia de seguridad</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);">Arrastra y suelta el archivo <code>.json</code> o haz clic para seleccionarlo. La importación reemplazará <strong>todos</strong> tus datos actuales.</p>
                    <div id="json-drop-zone">
                        <span class="material-icons" style="font-size: 48px; color: var(--c-outline);">upload_file</span>
                        <p id="json-drop-zone-text">Arrastra tu archivo aquí o haz clic</p>
                    </div>
                    <div id="json-file-error" class="form-error" style="text-align: center; margin-top: var(--sp-3);"></div>
                </div>

                <div id="json-wizard-step-2" class="json-wizard-step" style="display: none;">
                    <h4>Paso 2: Revisa y confirma</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);">Hemos analizado tu archivo. Si los datos son correctos, pulsa "Importar" para reemplazar tus datos actuales.</p>
                    <div id="json-preview-container">
                        <ul id="json-preview-list"></ul>
                        <div class="form-error" style="margin-top: var(--sp-2); text-align: center;"><strong>Atención:</strong> <span>Esta acción es irreversible.</span></div>
                    </div>
                    <div class="modal__actions" style="justify-content: space-between;">
                        <button class="btn btn--secondary" data-action="json-wizard-back-2">Atrás</button>
                        <button class="btn btn--danger" data-action="json-wizard-import-final"><span class="material-icons">warning</span><span>Importar y Reemplazar</span></button>
                    </div>
                </div>

                <div id="json-wizard-step-3" class="json-wizard-step" style="display: none; justify-content: center; align-items: center; text-align: center; min-height: 200px;">
                    <div id="json-import-progress">
                        <span class="spinner" style="width: 48px; height: 48px; border-width: 4px;"></span>
                        <h4 style="margin-top: var(--sp-4);">Importando...</h4>
                        <p>Estamos guardando tus datos. Por favor, no cierres esta ventana.</p>
                    </div>
                     <div id="json-import-result" style="display: none;">
                        <span class="material-icons" style="font-size: 60px; color: var(--c-success);">task_alt</span>
                        <h4 id="json-result-title" style="margin-top: var(--sp-2);">¡Importación Completada!</h4>
                        <p id="json-result-message"></p>
                        <div class="modal__actions" style="justify-content: center;">
                            <button class="btn btn--primary" data-action="close-modal" data-modal-id="json-import-wizard-modal">Finalizar</button>
                        </div>
                     </div>
                </div>

            </div>
        </div>
    </div>


    <div id="exit-screen">
        <p>Finanzas al día ✅ Movimientos revisados 👀  <br>💰 aiDANaI simplifica tus cuentas 💰</p>
    </div>
<div id="help-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="help-modal-title">
    <div class="modal" style="max-width: 650px; max-height: 80vh;">
        <header class="modal__header">
            <h3 id="help-modal-title" class="modal__title"></h3>
            <button class="icon-btn" data-action="close-modal" data-modal-id="help-modal" title="Cerrar" aria-label="Cerrar">
                <span class="material-icons">close</span>
            </button>
        </header>
        <div id="help-modal-body" class="modal__body">
        </div>
    </div>
</div>


    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script type="module">

	import { addDays, addWeeks, addMonths, addYears } from 'https://cdn.jsdelivr.net/npm/date-fns@2.29.3/+esm'
        
        const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };
        const PAGE_IDS = {
            INICIO: 'inicio-page',
            MOVIMIENTOS: 'movimientos-page',
            PLANIFICACION: 'planificacion-page',
            PATRIMONIO: 'patrimonio-page',
            CONFIGURACION: 'configuracion-page',
        };
		
		const THEMES = {
    'default': { name: 'Amoled Circuit', icon: 'memory' },
    'aurora': { name: 'Aurora Glass', icon: 'auto_awesome' } // <--- CAMBIO AQUÍ
};
        const quotesData = [ { "cita": "Los inversores conservadores duermen bien.", "autor": "Benjamin Graham" }, { "cita": "Nunca asciendas a alguien que no ha cometido errores, porque si lo haces, estás ascendiendo a alguien que nunca ha hecho nada.", "autor": "Benjamin Graham" }, { "cita": "Si se han hecho los deberes antes de comprar una acción, el momento de venderla es: normalmente, nunca.", "autor": "Benjamin Graham" }, { "cita": "Mientras que el entusiasmo é necesario para conseguir grandes logros en cualquier lugar, en Wall Street suele conducir al desastre.", "autor": "John Templeton" }, { "cita": "Sin tener fe en el futuro, nadie invertiría. Para ser inversor, debes creer en un mañana mejor.", "autor": "John Templeton" }, { "cita": "Las cuatro palabras más caras de nuestro lenguaje son: 'Esta vez es diferente'.", "autor": "John Templeton" }, { "cita": "Céntrate en el valor porque la mayoría de los inversores se fijan en perspectivas y tendencias.", "autor": "Peter Lynch" }, { "cita": "El éxito es un proceso de búsqueda continua de respuestas a nuevas preguntas.", "autor": "Peter Lynch" }, { "cita": "Conoce en lo que inviertes, y por qué.", "autor": "Peter Lynch" }, { "cita": "Cuando vendes en momentos de desesperación, siempre vendes barato.", "autor": "Peter Lynch" }, { "cita": "Una persona que posee una propiedad y tiene una participación en la empresa probablemente trabajará más duro, se sentirá más feliz y hará un mejor trabajo que otra que no tiene nada.", "autor": "Peter Lynch" }, { "cita": "El riesgo viene de no saber lo que se está haciendo.", "autor": "Warren Buffett" }, { "cita": "Cuesta 20 años construir una reputación y 5 minutos destruirla. Si piensas sobre ello, harás las cosas de manera diferente.", "autor": "Warren Buffett" }, { "cita": "En el mundo de los negocios, el espejo retrovisor está siempre más claro que el parabrisas.", "autor": "Warren Buffett" }, { "cita": "La inversión más importante que puedes hacer es en uno mismo.", "autor": "Warren Buffett" }, { "cita": "Sé temeroso cuando otros sean avariciosos, sé avaricioso cuando otros sean temerosos.", "autor": "Warren Buffett" }, { "cita": "Sé consciente de lo que no sabes. Siéntete a gusto entendiendo tus errores y debilidades.", "autor": "Charlie Munger" }, { "cita": "Para hacer dinero en los mercados, tienes que pensar diferente y ser humilde.", "autor": "Charlie Munger" }, { "cita": "El principal problema del inversor, e incluso su peor enemigo, es probablemente él mismo", "autor": "Benjamin Graham" }, { "cita": "Las personas que no pueden controlar sus emociones no son aptas para obtener beneficios mediante la inversión", "autor": "Benjamin Graham" }, { "cita": "Trato de comprar acciones en los negocios que son tan maravillosos que un tonto podría manejarlos. Tarde o temprano uno lo hará", "autor": "Warren Buffett" }, { "cita": "Un inversor debería actuar como si tuviera una tarjeta con solo 20 decisiones (de compra) para tomar a lo largo de su vida", "autor": "Warren Buffett" }, { "cita": "Regla número 1: nunca pierdas dinero. Regla número 2: nunca olvides la regla número 1", "autor": "Warren Buffett" }, { "cita": "Se gana dinero descontando lo obvio y apostando a lo inesperado", "autor": "George Soros" }, { "cita": "El problema no es lo que uno no sabe, sino lo que uno cree que sabe estando equivocado", "autor": "George Soros" }, { "cita": "Si invertir es entretenido, si te estás divirtiendo, probablemente no estés ganando dinero. Las buenas inversiones son aburridas", "autor": "George Soros" }, { "cita": "Se puede perder dinero a corto plazo, pero necesitas del largo plazo para ganar dinero", "autor": "Peter Lynch" }, { "cita": "La mejor empresa para comprar puede ser alguna que ya tienes en cartera", "autor": "Peter Lynch" }, { "cita": "La clave para ganar dinero con las acciones es no tenerles miedo", "autor": "Peter Lynch" }, { "cita": "Los mercados alcistas nacen en el pesimismo, crecen en el escepticismo, maduran en el optimismo y mueren en la euforia", "autor": "John Templeton" }, { "cita": "El momento de máximo pesimismo es el mejor para comprar y el momento de máximo optimismo es el mejor para vender", "autor": "John Templeton" }, { "cita": "Un inversor que tiene todas las respuestas ni siquiera entiende las preguntas", "autor": "John Templeton" }, { "cita": "La inversión es un negocio a largo plazo donde la paciencia marca la rentabilidad", "autor": "Francisco García Paramés" }, { "cita": "¿Cuándo vendemos un valor? Respondemos siempre: cuando haya una oportunidad mejor. Ese es nuestro objetivo permanente, mejorar la cartera cada día", "autor": "Francisco García Paramés" }, { "cita": "Lo que en la Bolsa saben todos, no me interesa", "autor": "André Kostolany" }, { "cita": "No sirve para nada proclamar la verdad en economía o recomendar cosas útiles. Es la mejor manera de hacerse enemigos", "autor": "André Kostolany" }, { "cita": "Un inversor pierde la capacidad de raciocinio cuando gana los primeros diez mil dólares. A partir de entonces se convierte en un pelele fácilmente manipulable", "autor": "André Kostolany" }, { "cita": "Comprar títulos, acciones de empresas, tomarse unas pastillas para dormir durante 20/30 años y cuando uno despierta, ¡voilà! es millonario", "autor": "André Kostolany" }, { "cita": "No sé si los próximos 1.000 puntos del Dow Jones serán hacia arriba o hacia abajo, pero estoy seguro de que los próximos 10.000 serán hacia arriba", "autor": "Peter Lynch" }, { "cita": "El destino de un inversor lo marca su estómago , no su cerebro", "autor": "Peter Lynch" }, { "cita": "No siga mis pasos porque aun en el caso de que acierte al comprar usted no sabrá cuando vendo", "autor": "Peter Lynch" }, { "cita": "Calcule las 'ganancias del dueño' para conseguir una reflexión verdadera del valor", "autor": "Warren Buffett" }, { "cita": "Busque compañías con altos márgenes de beneficio", "autor": "Warren Buffett" }, { "cita": "Invierta siempre para el largo plazo", "autor": "Warren Buffett" }, { "cita": "El consejo de que 'usted nunca quiebra tomando un beneficio' es absurdo", "autor": "Warren Buffett" }, { "cita": "¿El negocio tiene una historia de funcionamiento constante?", "autor": "Warren Buffett" }, { "cita": "Recuerde que el mercado de valores es maníaco-depresivo", "autor": "Benjamin Graham" }, { "cita": "Compre un negocio, no alquile la acción", "autor": "Warren Buffett" }, { "cita": "Mientras más absurdo sea el comportamiento del mercado mejor será la oportunidad para el inversor metódico", "autor": "Benjamin Graham" }, { "cita": "Se puede perder dinero a corto plazo, pero usted sigue siendo un idiota", "autor": "Joel Greenblatt" }, { "cita": "Los mercados alcistas no tienen resistencia y los bajistas no tienen soporte", "autor": "Ed Downs" }, { "cita": "El pánico causa que vendas en el bajón, y la codicia causa que compres cerca a la cima", "autor": "Stan Weinstein" }, { "cita": "Las dos grandes fuerzas que mueven los mercados son la codicia y el miedo", "autor": "Anónimo" }, { "cita": "Todo lo que sube baja y todo lo que baja sube", "autor": "Anónimo" }, { "cita": "Si no sientes miedo en el momento de comprar es que estás comprando mal", "autor": "Anónimo" }, { "cita": "Que el último duro lo gane otro", "autor": "Anónimo" }, { "cita": "La clave para hacer dinero en acciones es no asustarse de ellas", "autor": "Peter Lynch" }, { "cita": "El precio es lo que pagas, el valor es lo que recibes", "autor": "Warren Buffett" }, { "cita": "No es necesario hacer cosas extraordinarias para conseguir resultados extraordinarios", "autor": "Warren Buffett" }, { "cita": "Alguien está sentado en la sombra hoy porque alguien plantó un árbol mucho tiempo atrás", "autor": "Warren Buffett" }, { "cita": "Únicamente cuando la marea baja, descubres quién ha estado nadando desnudo", "autor": "Warren Buffett" }, { "cita": "No tenemos que ser más inteligentes que el resto, tenemos que ser más disciplinados que el resto", "autor": "Warren Buffett" }, { "cita": "Si compras cosas que no necesitas, pronto tendrás que vender cosas que necesitas", "autor": "Warren Buffett" }, { "cita": "Nunca inviertas en un negocio que no puedas entender", "autor": "Warren Buffett" }, { "cita": "El tiempo es amigo de las empresas maravillosas y enemigo de las mediocres", "autor": "Warren Buffett" }, { "cita": "Nuestro periodo de espera favorito es para siempre", "autor": "Warren Buffett" }, { "cita": "Wall Street es el único lugar al que las personas van en un Rolls-Royce, para recibir asesoría de quienes toman el metro", "autor": "Warren Buffett" }, { "cita": "Llega un momento en el que debes empezar a hacer lo que realmente quieres. Busca un trabajo que te guste y saltarás de la cama cada mañana con fuerza", "autor": "Warren Buffett" }, { "cita": "Es siempre mejor pasar el tiempo con gente mejor que tú. Escoge asociados cuyo comportamiento es mejor que el tuyo e irás en esa dirección", "autor": "Warren Buffett" }, { "cita": "Toma 20 años en construir una reputación y 5 minutos en arruinarla. Si piensas sobre ello, harás las cosas de forma diferente", "autor": "Warren Buffett" }, { "cita": "No importa el talento o los esfuerzos, hay cosas que llevan tiempo. No puedes producir un bebé en un mes dejando embarazadas a 9 mujeres", "autor": "Warren Buffett" }, { "cita": "Las oportunidades aparecen pocas veces. Cuando llueva oro sal a la calle con un cesto grande y no con un dedal", "autor": "Warren Buffett" }, { "cita": "La gente siempre me pregunta dónde deberían trabajar y yo siempre les digo que vayan a trabajar con aquellos a los que más admiran", "autor": "Warren Buffett" }, { "cita": "¿Cuándo hay que vender una acción? Pues cuando tengamos una oportunidad mejor a la vista", "autor": "Francisco García Paramés" }, { "cita": "Nunca acudo a las OPV, me gusta estar en las empresas que pueden ser opadas por competidores, no en las salidas a bolsa", "autor": "Francisco García Paramés" }, { "cita": "Si en el mercado hay más tontos que papel, la bolsa va a subir, si hay más papel que tontos, la bolsa baja", "autor": "André Kostolany" }, { "cita": "No persiga nunca una acción, tenga paciencia que la próxima oportunidad va a llegar con toda seguridad", "autor": "André Kostolany" }, { "cita": "Lo que todos saben en la bolsa, no nos interesa a los especuladores", "autor": "André Kostolany" }, { "cita": "Las inversiones exitosas consisten en saber gestionar el riesgo, no en evitarlo.", "autor": "Benjamin Graham" }, { "cita": "Una gran compañía no es una buena inversión si pagas mucho por la acción", "autor": "Benjamin Graham" }, { "cita": "A veces es mejor pensar una hora sobre el dinero que dedicar una semana a trabajar para obtenerlo.", "autor": "André Kostolany" }, { "cita": "En la Bolsa, con frecuencia, hay que cerrar los ojos para ver mejor.", "autor": "André Kostolany" }, { "cita": "Si la inversión es entretenida, si te estás divirtiendo, es probable que no estés ganando dinero. Una buena inversión es aburrida.", "autor": "George Soros" }, { "cita": "Las burbujas del mercado de valores no crecen de la nada. Tienen una base sólida en la realidad, pero la realidad está distorsionada por un malentendido.", "autor": "George Soros" }, { "cita": "Nunca digas que no puedes permitirte algo. Esa es la aptitud de un hombre pobre. Pregúntate cómo permitírtelo.", "autor": "Robert Kiyosaki" }, { "cita": "Una diferencia importante es que los ricos compran los lujos al final, mientras que los pobres y la clase media tienden a comprar los lujos primero.", "autor": "Robert Kiyosaki" }, { "cita": "Mantén tus activos bajo mínimos, reduce los pasivos y, con mucha disciplina, ve construyendo una base de activos sólida.", "autor": "Robert Kiyosaki" }, { "cita": "No ahorres lo que queda después de gastar, sino gasta lo que queda después de ahorrar.", "autor": "Warren Buffett" }, { "cita": "El riesgo viene de no saber lo que estás haciendo.", "autor": "Warren Buffett" }, { "cita": "Sea temeroso cuando otros son codiciosos, y sea codicioso cuando otros son temerosos.", "autor": "Warren Buffett" }, { "cita": "No compres cosas que no necesitas, con dinero que no tienes, para impresionar a gente que no te importa.", "autor": "Dave Ramsey" } ];
    const AVAILABLE_WIDGETS = {
    'action-center': { title: 'Centro de Acciones', description: 'Alertas y tareas pendientes como facturas y presupuestos.', icon: 'notifications_active' },
    'kpi-summary-expanded': { title: 'Centro de Operaciones (Avanzado)', description: 'Visión completa con 5 KPIs: Saldo, Ahorro, Patrimonio, P&L y Presupuesto.', icon: 'query_stats' },
    'net-worth-trend': { title: 'Evolución del Patrimonio', description: 'Gráfico histórico de la variación de tu patrimonio neto total.', icon: 'show_chart' },
    'concept-totals': { title: 'Totales por Concepto', description: 'Gráfico y lista detallada de gastos/ingresos por concepto.', icon: 'bar_chart' },
    'informe-personalizado': { title: 'Mi Informe Personalizado', description: 'Un gráfico y tabla con las métricas y filtros que tú elijas.', icon: 'insights' },
    'kpi-summary': { title: 'Resumen de KPIs (Simple)', description: 'Ingresos, gastos y saldo neto del periodo.', icon: 'summarize' }
};

const DEFAULT_DASHBOARD_WIDGETS = ['action-center', 'kpi-summary-expanded', 'net-worth-trend', 'concept-totals'];
        const getInitialDb = () => ({
    cuentas: [], 
    conceptos: [], 
    movimientos: [], 
    presupuestos: [],
    recurrentes: [],
    inversiones_historial: [],
    inversion_cashflows: [],
    config: { 
        skipIntro: false,
        dashboardWidgets: DEFAULT_DASHBOARD_WIDGETS,
        savedReports: {} // <-- AÑADIDO: para guardar la configuración de los informes
    } 
});
        let currentUser = null, unsubscribeListeners = [], db = getInitialDb(), deselectedAccountTypesFilter = new Set();
		let deselectedInvestmentTypesFilter = new Set();
		let selectedInvestmentTypeFilter = null;
		let intelligentIndex = new Map();
		let syncState = 'synced'; 
		let isOffBalanceMode = false;
        let descriptionIndex = {};
		let globalSearchDebounceTimer = null;
		let newMovementIdToHighlight = null;
		let unsubscribeRecientesListener = null
        const originalButtonTexts = new Map();
        let conceptosChart = null, liquidAssetsChart = null, detailInvestmentChart = null, informesChart = null, assetAllocationChart = null, budgetTrendChart = null, netWorthChart = null;
        let lastScrollTop = null;
        
        let jsonWizardState = {
            file: null,
            data: null,
            preview: {
                counts: {},
                meta: {}
            }
        };
        let isInitialLoadComplete = false;
        let dataLoaded = {
            presupuestos: false,
            recurrentes: false,
            inversiones: false
        };
        
		const MOVEMENTS_PAGE_SIZE = 200;
        let lastVisibleMovementDoc = null; 
        let isLoadingMoreMovements = false; 
        let allMovementsLoaded = false; 
        
        let runningBalancesCache = null;
		let recentMovementsCache = []; // <-- AÑADIR: Caché para los movimientos recientes del dashboard
		        
        const vList = {
			scrollerEl: null, sizerEl: null, contentEl: null, items: [], itemMap: [], 
			heights: {}, 
			renderBuffer: 10, lastRenderedRange: { start: -1, end: -1 }, isScrolling: null
		};
        
        let calculatorState = {
            displayValue: '0',
            operand1: null,
            operator: null,
            waitingForNewValue: true,
            targetInput: null,
            isVisible: false, 
            isResultDisplayed: false,
        };
        let descriptionSuggestionDebounceTimer = null; 
        const DESCRIPTION_SUGGESTION_LIMIT = 5;
        
        const swipeState = {
            activeCard: null,
            startX: 0,
            currentX: 0,
            isSwiping: false,
            threshold: 60 
        };
            
		// =================================================================
// === INICIO: CÓDIGO AÑADIDO (Paso 1) ===
// =================================================================
const longPressState = {
    timer: null,
    isTriggered: false,
    startX: 0,
    startY: 0,
    TOLERANCE: 10, // Píxeles de movimiento permitidos antes de cancelar
    DURATION: 500   // 500ms para considerar una pulsación larga
};
// =================================================================
// === FIN: CÓDIGO AÑADIDO (Paso 1) ===
// =================================================================



		let lastActionForUndo = null;


async function hashPin(pin) {
    const encoder = new TextEncoder();
    const data = encoder.encode(pin);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function verifyPin(pin, storedHash) {
    const pinHash = await hashPin(pin);
    return pinHash === storedHash;
}

const updateSyncStatusIcon = () => {
    const iconEl = select('sync-status-icon');
    if (!iconEl) return;

    let iconName = '';
    let iconTitle = '';
    let iconClass = '';

    switch (syncState) {
        case 'syncing':
            iconName = `<span class="sync-icon-spinner">sync</span>`;
            iconTitle = 'Sincronizando datos con la nube...';
            iconClass = 'sync-status--syncing';
            break;
        case 'error':
            iconName = 'cloud_off';
            iconTitle = 'Error de conexión. Tus cambios se guardan localmente y se sincronizarán al recuperar la conexión.';
            iconClass = 'sync-status--error';
            break;
        case 'synced':
        default:
            iconName = 'cloud_done';
            iconTitle = 'Todos los datos están guardados y sincronizados en la nube.';
            iconClass = 'sync-status--synced';
            break;
    }
    
    iconEl.innerHTML = iconName;
    iconEl.title = iconTitle;
    iconEl.className = `material-icons ${iconClass}`;
};
                const buildDescriptionIndex = () => {
            descriptionIndex = {};
            if (!db.movimientos || db.movimientos.length === 0) return;

            const movementsToIndex = db.movimientos.slice(0, 500); 

            movementsToIndex.forEach(mov => {
                const desc = mov.descripcion.trim().toLowerCase();
                if (desc.length > 3) {
                    if (!descriptionIndex[desc]) {
                        descriptionIndex[desc] = {
                            conceptoId: mov.conceptoId,
                            count: 0
                        };
                    }
                    descriptionIndex[desc].count++;
                }
            });
        };
               
    
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        fbAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        const fbDb = firebase.firestore();
        
        fbDb.enablePersistence({synchronizeTabs: true}).catch(err => {
            if (err.code == 'failed-precondition') showToast('Modo offline no disponible (múltiples pestañas).', 'warning');
            else if (err.code == 'unimplemented') showToast('Navegador no soporta modo offline.', 'warning');
        });
        
async function saveDoc(collectionName, docId, data, btn = null) {
    if (!currentUser) { showToast("Error: No hay usuario.", "danger"); return; }
    if (btn) setButtonLoading(btn, true);

    syncState = 'syncing';
    updateSyncStatusIcon();

    try {
        const docRef = fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(docId);
        await docRef.set(data, { merge: true });
        
        await fbDb.waitForPendingWrites();

        syncState = 'synced';
        
    } catch (error) {
        console.error(`Error guardando en ${collectionName}:`, error);
        showToast("Error al guardar.", "danger");
        syncState = 'error';
    } finally {
        if (btn) setButtonLoading(btn, false);
        updateSyncStatusIcon();
    }
}


        async function updateAccountBalance(cuentaId, amountInCents) {
            if (!currentUser || !cuentaId || typeof amountInCents !== 'number') {
                console.error("Argumentos inválidos para updateAccountBalance");
                return;
            }

            try {
                const accountRef = fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(cuentaId);
                await accountRef.update({
                    saldo: firebase.firestore.FieldValue.increment(amountInCents)
                });
            } catch (error) {
                console.error(`Error al actualizar saldo de la cuenta ${cuentaId}:`, error);
                showToast("Error crítico: no se pudo actualizar el saldo.", "danger");
            }
        }
        
async function migrateBalancesToAccounts() {
    if (!currentUser) {
        console.error("Debes iniciar sesión para ejecutar la migración.");
        return;
    }
    console.log("🚀 Iniciando migración de saldos...");

    const userRef = fbDb.collection('users').doc(currentUser.uid);

    const cuentasSnapshot = await userRef.collection('cuentas').get();
    const cuentas = {};
    cuentasSnapshot.forEach(doc => {
        cuentas[doc.id] = { ref: doc.ref, saldo: 0 };
    });

            const movimientosSnapshot = await userRef.collection('movimientos').get();
            console.log(`Procesando ${movimientosSnapshot.size} movimientos...`);
            movimientosSnapshot.forEach(doc => {
                const mov = doc.data();
                if (mov.tipo === 'traspaso') {
                    if (cuentas[mov.cuentaOrigenId]) cuentas[mov.cuentaOrigenId].saldo -= mov.cantidad;
                    if (cuentas[mov.cuentaDestinoId]) cuentas[mov.cuentaDestinoId].saldo += mov.cantidad;
                } else {
                    if (cuentas[mov.cuentaId]) cuentas[mov.cuentaId].saldo += mov.cantidad;
                }
            });

            const batch = fbDb.batch(); 
            for (const cuentaId in cuentas) {
                const cuentaData = cuentas[cuentaId];
                batch.update(cuentaData.ref, { saldo: cuentaData.saldo });
            }

            await batch.commit();
            console.log(`🎉 ¡Migración completada! Se actualizaron los saldos de ${Object.keys(cuentas).length} cuentas.`);
            alert("¡Migración de saldos completada! La aplicación ahora usará los saldos en tiempo real. Por favor, recarga la página para ver los cambios.");
        }
                
        async function deleteDoc(collectionName, docId) {
    if (!currentUser) { showToast("Error: No hay usuario.", "danger"); return; }
    
    syncState = 'syncing';
    updateSyncStatusIcon();

    try {
        await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(docId).delete();
        await fbDb.waitForPendingWrites();
        syncState = 'synced';
    } catch (error) {
        console.error(`Error borrando de ${collectionName}:`, error);
        showToast("Error al borrar.", "danger");
        syncState = 'error';
    } finally {
        updateSyncStatusIcon();
    }
}
        
 // REEMPLAZA tu función loadCoreData por esta versión actualizada
async function loadCoreData(uid) {
    unsubscribeListeners.forEach(unsub => unsub());
    unsubscribeListeners = [];
    
    dataLoaded = { presupuestos: false, recurrentes: false, inversiones: false };

    const userRef = fbDb.collection('users').doc(uid);

    const collectionsToLoadInitially = ['cuentas', 'conceptos', 'recurrentes'];

    collectionsToLoadInitially.forEach(collectionName => {
        const unsubscribe = userRef.collection(collectionName).onSnapshot(snapshot => {
            db[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            if (collectionName === 'recurrentes') {
                dataLoaded.recurrentes = true;
                const activePage = document.querySelector('.view--active');
                if (activePage && (activePage.id === PAGE_IDS.MOVIMIENTOS)) loadInitialMovements();
                if (activePage && (activePage.id === PAGE_IDS.PLANIFICACION)) renderPlanificacionPage();
            }
            
            populateAllDropdowns();
            
            if (select(PAGE_IDS.INICIO)?.classList.contains('view--active')) updateDashboardData();
            if (select(PAGE_IDS.PATRIMONIO)?.classList.contains('view--active')) renderPatrimonioPage();

        }, error => console.error(`Error escuchando ${collectionName}: `, error));
        unsubscribeListeners.push(unsubscribe);
    });

    const unsubConfig = userRef.onSnapshot(doc => {
        db.config = doc.exists && doc.data().config ? doc.data().config : getInitialDb().config;
        localStorage.setItem('skipIntro', (db.config && db.config.skipIntro) || 'false');
        loadConfig();
    }, error => console.error("Error escuchando la configuración del usuario: ", error));
    unsubscribeListeners.push(unsubConfig);

    // =====================================================================
    // === INICIO: LÓGICA DE CARGA INTELIGENTE PARA EL DASHBOARD (EL MANANTIAL) ===
    // =====================================================================
    // Desconectamos cualquier listener anterior para evitar duplicados al iniciar sesión de nuevo.
    if (unsubscribeRecientesListener) unsubscribeRecientesListener();

    // Creamos una consulta para los últimos 3 meses de movimientos. Esto es suficiente
    // para los cálculos de "vs mes anterior" y "vs año anterior" del dashboard.
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    
    // Este listener mantendrá nuestra caché `recentMovementsCache` siempre actualizada en tiempo real.
    unsubscribeRecientesListener = userRef.collection('movimientos')
        .where('fecha', '>=', threeMonthsAgo.toISOString())
        .onSnapshot(snapshot => {
            console.log("Listener de recientes: Datos actualizados en la caché.");
            // Actualizamos la caché con los datos más frescos.
            recentMovementsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Si el usuario está en la página de Inicio, la actualizamos inmediatamente.
            const activePage = document.querySelector('.view--active');
            if (activePage && activePage.id === PAGE_IDS.INICIO) {
                updateDashboardData();
            }
        }, error => console.error("Error escuchando movimientos recientes: ", error));
    // ===================================================================
    // === FIN: LÓGICA DE CARGA INTELIGENTE ==============================
    // ===================================================================
                        
    buildDescriptionIndex();
    startMainApp();
};

        
        async function loadPresupuestos() {
            if (dataLoaded.presupuestos || !currentUser) return;
            console.log("Lazy loading: Cargando presupuestos...");
            const unsub = fbDb.collection('users').doc(currentUser.uid).collection('presupuestos').onSnapshot(snapshot => {
                db.presupuestos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const activePage = document.querySelector('.view--active');
                if (activePage && activePage.id === PAGE_IDS.PLANIFICACION) {
                    renderBudgetTracking();
                }
            }, err => console.error("Error al cargar presupuestos:", err));
            unsubscribeListeners.push(unsub);
            dataLoaded.presupuestos = true;
        }

        async function loadInversiones() {
            if (dataLoaded.inversiones || !currentUser) return;
            console.log("Lazy loading: Cargando datos de inversión...");

            const coleccionesInversion = ['inversiones_historial', 'inversion_cashflows'];
            
            coleccionesInversion.forEach(collectionName => {
                const unsub = fbDb.collection('users').doc(currentUser.uid).collection(collectionName).onSnapshot(snapshot => {
                    db[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    dataLoaded.inversiones = true;

                    const activePageEl = document.querySelector('.view--active');
                    const activePage = activePageEl ? activePageEl.id : null;
                                        
                    if (activePage === PAGE_IDS.PATRIMONIO) {
                        renderPatrimonioPage();
                    }
                    
                }, err => console.error(`Error al cargar ${collectionName}:`, err));
                
                unsubscribeListeners.push(unsub);
            });
        }

    const checkAuthState = () => {
            fbAuth.onAuthStateChanged((user) => {
                if (user) {
                    const storedPinHash = localStorage.getItem('pinUserHash');
                    const storedPinEmail = localStorage.getItem('pinUserEmail');

                    if (storedPinHash && storedPinEmail === user.email) {
                        showPinScreen(user);
                    } else {
                        currentUser = user;
                        loadCoreData(user.uid);
                    }
                } else {
                    currentUser = null;
                    unsubscribeListeners.forEach(unsub => unsub());
                    unsubscribeListeners = [];
                    db = getInitialDb();
                    showLoginScreen();
                }
            });
        };

        const calculateNextDueDate = (currentDueDate, frequency) => {
            const d = new Date(currentDueDate);
            d.setHours(12, 0, 0, 0); 
        
            switch (frequency) {
                case 'daily': return addDays(d, 1);
                case 'weekly': return addWeeks(d, 1);
                case 'monthly': return addMonths(d, 1);
                case 'yearly': return addYears(d, 1);
                default: return d;
            }
        };
        
		const select = (id) => document.getElementById(id);
		const selectAll = (s) => document.querySelectorAll(s);
		const selectOne = (s) => document.querySelector(s);
        
		const chunkArray = (array, size) => {
			const chunks = [];
			for (let i = 0; i < array.length; i += size) {
				chunks.push(array.slice(i, i + size));
			}
			return chunks;
		};
		const measureListItemHeights = () => {
    // Ya no medimos nada. Usamos valores fijos basados en el CSS.
    // Es un "contrato" entre nuestro estilo y nuestro código.
    vList.heights = {
        transaction: 64, // Coincide con el min-height que pusimos en el CSS
        transfer: 76,    // Valor estimado para traspasos, puedes ajustarlo
        header: 40,      // Valor estimado para cabeceras
        pendingHeader: 40, // Valor estimado
        pendingItem: 72    // Valor estimado
    };
    
    console.log('Alturas de elementos definidas (Robusto):', vList.heights);
};
        const hapticFeedback = (type = 'light') => {
            if ('vibrate' in navigator) {
                try {
                    let pattern;
                    switch (type) {
                        case 'light':   pattern = 10; break;
                        case 'medium':  pattern = 25; break;
                        case 'success': pattern = [15, 60, 15]; break;
                        case 'warning': pattern = [30, 40, 30]; break;
                        case 'error':   pattern = [50, 50, 50]; break;
                        default:        pattern = 10;
                    }
                    navigator.vibrate(pattern);
                } catch (e) {}
            }
        };

        const parseDateStringAsUTC = (dateString) => {
            if (!dateString) return null;
            return new Date(dateString + 'T12:00:00Z');
        };

        const generateId = () => fbDb.collection('users').doc().id;
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const formatCurrency = (numInCents) => {
            const number = (numInCents || 0) / 100;
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(number);
        };
        const toSentenceCase = (str) => {
			if (!str || typeof str !== 'string') return '';
			return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
		};
// =========================================================
// === REEMPLAZO COMPLETO DE LA FUNCIÓN showToast ===
// =========================================================
const showToast = (message, type = 'default', duration = 4000, options = {}) => {
    const container = select('toast-container');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast toast--${type}`;
    
    const messageSpan = document.createElement('span');
    messageSpan.textContent = message;
    toast.appendChild(messageSpan);

    // === ESTA ES LA LÓGICA CORREGIDA QUE AÑADE EL BOTÓN ===
    if (options.actionText && typeof options.onActionClick === 'function') {
        const actionButton = document.createElement('button');
        actionButton.className = 'btn btn--primary'; 
        actionButton.textContent = options.actionText;
        actionButton.style.marginLeft = '1rem';
        actionButton.style.padding = '0.25rem 0.5rem';
        actionButton.style.fontSize = '0.8rem';
        
        actionButton.onclick = (e) => {
            e.stopPropagation();
            options.onActionClick();
            toast.animate([{ opacity: 1 }, { opacity: 0 }], { duration: 200, easing: 'ease-in' })
                 .onfinish = () => toast.remove();
        };
        toast.appendChild(actionButton);
        toast.style.display = 'flex';
        toast.style.alignItems = 'center';
        toast.style.justifyContent = 'space-between';
    }
    // =======================================================================
    
    container.appendChild(toast);

    const fadeIn = toast.animate([
        { transform: 'translateY(20px) scale(0.95)', opacity: 0 },
        { transform: 'translateY(0) scale(1)', opacity: 1 }
    ], { duration: 300, easing: 'ease-out' });
    
    fadeIn.onfinish = () => {
        if (type === 'danger' || type === 'error') hapticFeedback('error');
        else if (type === 'warning') hapticFeedback('warning');
        
        setTimeout(() => {
            if (document.body.contains(toast)) {
               toast.animate([{ opacity: 1 }, { opacity: 0 }], { duration: 300, easing: 'ease-in' })
                    .onfinish = () => toast.remove();
            }
        }, duration);
    };
};
        const setButtonLoading = (btn, isLoading, text = 'Cargando...') => {
            if (!btn) return;
            if (isLoading) { if (!originalButtonTexts.has(btn)) originalButtonTexts.set(btn, btn.innerHTML); btn.setAttribute('disabled', 'true'); btn.classList.add('btn--loading'); btn.innerHTML = `<span class="spinner"></span> <span>${text}</span>`;
            } else { btn.removeAttribute('disabled'); btn.classList.remove('btn--loading'); if (originalButtonTexts.has(btn)) { btn.innerHTML = originalButtonTexts.get(btn); originalButtonTexts.delete(btn); } }
        };
        const displayError = (id, msg) => { const err = select(`${id}-error`); if (err) { err.textContent = msg; err.setAttribute('role', 'alert'); } const inp = select(id); if (inp) inp.classList.add('form-input--invalid'); };
        const clearError = (id) => { const err = select(`${id}-error`); if (err) { err.textContent = ''; err.removeAttribute('role'); } const inp = select(id); if (inp) inp.classList.remove('form-input--invalid'); };
        const clearAllErrors = (formId) => { const f = select(formId); if (!f) return; f.querySelectorAll('.form-error').forEach((e) => e.textContent = ''); f.querySelectorAll('.form-input--invalid').forEach(e => e.classList.remove('form-input--invalid')); };
        const animateCountUp = (el, end, duration = 700, formatAsCurrency = true, prefix = '', suffix = '') => {
            if (!el) return;
            const start = parseFloat(el.dataset.currentValue || '0');
            const endValue = end / 100;
            if (start === endValue || !el.offsetParent) { el.textContent = formatAsCurrency ? formatCurrency(end) : `${prefix}${end}${suffix}`; el.dataset.currentValue = String(endValue); return; }
            el.dataset.currentValue = String(endValue); let startTime = null;
            const step = (timestamp) => { if (!startTime) startTime = timestamp; const p = Math.min((timestamp - startTime) / duration, 1); const current = p * (end - start*100) + start*100; el.textContent = formatAsCurrency ? formatCurrency(current) : `${prefix}${current.toFixed(2)}${suffix}`; if (p < 1) requestAnimationFrame(step); else el.textContent = formatAsCurrency ? formatCurrency(end) : `${prefix}${end/100}${suffix}`; };
            requestAnimationFrame(step);
        };
        const escapeHTML = str => (str || '').replace(/[&<>"']/g, match => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[match]);
        
        const parseCurrencyString = (str) => {
            if (typeof str !== 'string' || !str.trim()) return NaN;
            
            let cleanStr = str.replace(/[€$£\s]/g, '');

            const hasComma = cleanStr.includes(',');
            const hasPeriod = cleanStr.includes('.');

            if (hasComma && hasPeriod) {
                if (cleanStr.lastIndexOf(',') > cleanStr.lastIndexOf('.')) {
                    cleanStr = cleanStr.replace(/\./g, '').replace(',', '.');
                } else {
                    cleanStr = cleanStr.replace(/,/g, '');
                }
            } else if (hasComma) {
                cleanStr = cleanStr.replace(',', '.');
            }
            
            return parseFloat(cleanStr);
        };
		const showPinScreen = (user) => {
            currentUser = user;
            const pinScreen = select('pin-login-screen');
            const loginScreen = select('login-screen');
            const appRoot = select('app-root');

            if (appRoot) appRoot.classList.remove('app-layout--visible');
            if (loginScreen) loginScreen.classList.remove('login-view--visible');
            if (pinScreen) pinScreen.classList.add('login-view--visible');
            
            const pinInputs = selectAll('#pin-inputs-container .pin-input');
            pinInputs.forEach(input => input.value = '');
            (select('pin-error')).textContent = '';
            if (pinInputs.length > 0) pinInputs[0].focus();
        };

        const handlePinSubmit = async () => {
            const pinInputs = selectAll('#pin-inputs-container .pin-input');
            const pin = Array.from(pinInputs).map(input => input.value).join('');
            const errorEl = select('pin-error');
            
            if (pin.length !== 4) {
                errorEl.textContent = 'El PIN debe tener 4 dígitos.';
                return;
            }

            const storedHash = localStorage.getItem('pinUserHash');
            const isValid = await verifyPin(pin, storedHash);

            if (isValid) {
                hapticFeedback('success');
                loadCoreData(currentUser.uid);
            } else {
                hapticFeedback('error');
                errorEl.textContent = 'PIN incorrecto. Inténtalo de nuevo.';
                pinInputs.forEach(input => input.value = '');
                pinInputs[0].focus();
            }
        };
        
        const handlePinInputInteraction = () => {
            const inputs = Array.from(selectAll('#pin-inputs-container .pin-input'));
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key >= 0 && e.key <= 9) {
                        inputs[index].value = '';
                        setTimeout(() => {
                           if (index < inputs.length - 1) {
                                inputs[index + 1].focus();
                           } else {
                               handlePinSubmit();
                           }
                        }, 10);
                    } else if (e.key === 'Backspace') {
                        if (index > 0) {
                            setTimeout(() => inputs[index - 1].focus(), 10);
                        }
                    }
                });
            });
        };
        const initApp = async () => {
            document.documentElement.lang = 'es';
            setupTheme();
			const savedTheme = localStorage.getItem('appTheme') || 'default';
			document.body.dataset.theme = savedTheme;
            attachEventListeners();
            
            const intro = select('introScreen'), quoteContainer = select('quoteContainer');
            if (localStorage.getItem('skipIntro') === 'true') { if (intro) intro.remove(); } 
            else if (intro && quoteContainer && quotesData.length) {
                const r = quotesData[Math.floor(Math.random() * quotesData.length)];
                const quoteTextEl = select('quoteText');
                const quoteAuthorEl = select('quoteAuthor');
                if(quoteTextEl) quoteTextEl.textContent = `"${r.cita}"`;
                if(quoteAuthorEl) quoteAuthorEl.textContent = `— ${r.autor}`;
                await wait(2500); quoteContainer.classList.add('visible');
                await wait(4000); (intro).style.opacity = '0';
                await wait(750); intro.remove();
            } else if (intro) { intro.remove(); }
            
            checkAuthState();
        };
		window.addEventListener('online', () => {
    console.log("Conexión recuperada. Sincronizando...");
    syncState = 'syncing';
    updateSyncStatusIcon();
    setTimeout(() => {
        syncState = 'synced';
        updateSyncStatusIcon();
    }, 2500);
});

window.addEventListener('offline', () => {
    console.log("Se ha perdido la conexión.");
    syncState = 'error';
    updateSyncStatusIcon();
});
    const startMainApp = async () => {
            const loginScreen = select('login-screen');
            const pinLoginScreen = select('pin-login-screen');
            const appRoot = select('app-root');

            if (loginScreen) loginScreen.classList.remove('login-view--visible');
            if (pinLoginScreen) pinLoginScreen.classList.remove('login-view--visible');
            if (appRoot) appRoot.classList.add('app-layout--visible');
            
            populateAllDropdowns();
            loadConfig();
            
            measureListItemHeights();
            
            updateSyncStatusIcon();
            buildIntelligentIndex();
            navigateTo(PAGE_IDS.INICIO, true);
            updateThemeIcon(localStorage.getItem('appTheme') || 'default');
            isInitialLoadComplete = true;
        };

        
    const showLoginScreen = () => {
        const loginScreen = select('login-screen');
        const pinLoginScreen = select('pin-login-screen');
        const appRoot = select('app-root');
        if (appRoot) appRoot.classList.remove('app-layout--visible');
        if (pinLoginScreen) pinLoginScreen.classList.remove('login-view--visible');
        if (loginScreen) loginScreen.classList.add('login-view--visible');
    };
	
    const showPasswordFallback = () => {
    hapticFeedback('light');
    const pinScreen = select('pin-login-screen');
    if (!pinScreen) return;

    pinScreen.querySelector('.pin-inputs').classList.add('hidden');
    pinScreen.querySelector('[data-action="use-password-instead"]').parentElement.classList.add('hidden');
    
    pinScreen.querySelector('.login-view__tagline').textContent = 'Introduce tu contraseña para continuar.';
    
    const form = pinScreen.querySelector('form');
    const passwordContainer = document.createElement('div');
    passwordContainer.innerHTML = `
        <div class="form-group form-group--with-icon" style="margin-top: 1.5rem;">
            <span class="material-icons">lock</span>
            <input type="password" id="pin-fallback-password" class="form-input" placeholder="Contraseña" required>
        </div>
        <button type="submit" class="btn btn--primary btn--full" style="margin-top: 1rem;">Verificar</button>
    `;
    form.appendChild(passwordContainer);
    select('pin-fallback-password').focus();

    form.onsubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        setButtonLoading(btn, true);

        const password = select('pin-fallback-password').value;
        const errorEl = select('pin-error');
        errorEl.textContent = '';

        try {
            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
            await currentUser.reauthenticateWithCredential(credential);
            
            startMainApp(); 

        } catch (error) {
            errorEl.textContent = 'Contraseña incorrecta.';
            hapticFeedback('error');
        } finally {
            setButtonLoading(btn, false);
        }
    };
};
         
        const handleLogin = (btn) => {
            const email = (select('login-email')).value.trim(), password = (select('login-password')).value, errEl = select('login-error'); clearAllErrors('login-form'); if(errEl) errEl.textContent = ''; let v = true;
            if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
            if (!password) { displayError('login-password', 'La contraseña es obligatoria.'); v = false; }
            if (!v) return; setButtonLoading(btn, true, 'Iniciando...');
            fbAuth.signInWithEmailAndPassword(email, password).then(() => showToast(`¡Bienvenido/a de nuevo!`)).catch((err) => { setButtonLoading(btn, false); if (['auth/wrong-password', 'auth/user-not-found', 'auth/invalid-credential'].includes(err.code)) (errEl).textContent = 'Error: Credenciales incorrectas.'; else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no válido.'); else (errEl).textContent = 'Error al iniciar sesión.'; });
        };
        const handleRegister = (btn) => {
            const email = (select('login-email')).value.trim(), password = (select('login-password')).value, errEl = select('login-error'); clearAllErrors('login-form'); if(errEl) errEl.textContent = ''; let v = true;
            if (!email) { displayError('login-email', 'El correo es obligatorio.'); v = false; }
            if (password.length < 6) { displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); v = false; }
            if (!v) return; setButtonLoading(btn, true, 'Registrando...');
            fbAuth.createUserWithEmailAndPassword(email, password).then(() => showToast(`¡Registro completado!`)).catch((err) => { setButtonLoading(btn, false); if (err.code == 'auth/weak-password') displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); else if (err.code == 'auth/email-already-in-use') displayError('login-email', 'El correo ya está registrado.'); else if (err.code === 'auth/invalid-email') displayError('login-email', 'Formato de correo no válido.'); else (errEl).textContent = 'Error en el registro.'; });
        };
        const handleExitApp = () => {
            const exitScreen = select('exit-screen');
            const appRoot = select('app-root');

            if (exitScreen) {
                exitScreen.style.display = 'flex';
                setTimeout(() => exitScreen.style.opacity = '1', 50);

                if (isInitialLoadComplete && appRoot) {
                    appRoot.classList.add('app-layout--transformed-by-modal');
                }
            }
        };
        
// MODIFICA tu función navigateTo para añadir la gestión del listener
const navigateTo = async (pageId, isInitial = false) => {
    if (!isInitial) hapticFeedback('light');
    
    const oldActiveView = document.querySelector('.view--active');
    const oldViewId = oldActiveView ? oldActiveView.id : null;

    // --- Lógica de limpieza de gráficos (la que ya tienes) ---
    // ... tu código de destrucción de gráficos va aquí ...

    // ============================================================
    // === INICIO: GESTIÓN INTELIGENTE DEL LISTENER DE RECIENTES ===
    // ============================================================
    // Si estamos SALIENDO de la página de Inicio y el listener existe, lo apagamos.
    if (oldViewId === PAGE_IDS.INICIO && unsubscribeRecientesListener) {
        console.log("Saliendo de Inicio, desconectando el listener de recientes.");
        unsubscribeRecientesListener();
        unsubscribeRecientesListener = null;
    }
    
    // Si estamos ENTRANDO en la página de Inicio y el listener NO existe, lo creamos.
    if (pageId === PAGE_IDS.INICIO && !unsubscribeRecientesListener) {
        console.log("Entrando en Inicio, reconectando el listener de recientes.");
        const userRef = fbDb.collection('users').doc(currentUser.uid);
        const threeMonthsAgo = new Date();
        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
        
        unsubscribeRecientesListener = userRef.collection('movimientos')
            .where('fecha', '>=', threeMonthsAgo.toISOString())
            .onSnapshot(snapshot => {
                recentMovementsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const activePage = document.querySelector('.view--active');
                if (activePage && activePage.id === PAGE_IDS.INICIO) {
                    updateDashboardData();
                }
            }, error => console.error("Error al reconectar listener de recientes:", error));
    }
    
    
    if (pageId === PAGE_IDS.PATRIMONIO) {
        selectedInvestmentTypeFilter = null;
        deselectedInvestmentTypesFilter.clear();
    }

    const titleEl = select('top-bar-title'), actionsEl = select('top-bar-actions'), leftEl = select('top-bar-left-button'), fab = select('fab-add-movimiento');
    
    const standardActions = `
        <button data-action="global-search" class="icon-btn" title="Búsqueda Global (Cmd/Ctrl+K)" aria-label="Búsqueda Global"><span class="material-icons">search</span></button>
        <button id="theme-toggle-btn" data-action="toggle-theme" class="icon-btn" title="Cambiar Tema" aria-label="Cambiar Tema"><span class="material-icons">palette</span></button>
        <button data-action="help" class="icon-btn" title="Ayuda" aria-label="Ayuda"><span class="material-icons">help_outline</span></button> 
        <button data-action="exit" class="icon-btn" title="Salir" aria-label="Salir de la aplicación"><span class="material-icons">exit_to_app</span></button>`;
    
    if (pageId === PAGE_IDS.PLANIFICACION && !dataLoaded.presupuestos) await loadPresupuestos();
    if (pageId === PAGE_IDS.PATRIMONIO && !dataLoaded.inversiones) await loadInversiones();

    const pageRenderers = {
        [PAGE_IDS.INICIO]: { title: 'Inicio', render: renderInicioPage, actions: standardActions },
        [PAGE_IDS.MOVIMIENTOS]: { title: 'Movimientos', render: loadInitialMovements, actions: standardActions },
        [PAGE_IDS.PLANIFICACION]: { title: 'Planificación', render: renderPlanificacionPage, actions: standardActions },
        [PAGE_IDS.PATRIMONIO]: { title: 'Patrimonio', render: renderPatrimonioPage, actions: standardActions },
        [PAGE_IDS.CONFIGURACION]: { title: 'Ajustes', render: loadConfig, actions: standardActions },
    };
    
    if (pageRenderers[pageId]) {
        if (titleEl) titleEl.textContent = '';
        if (leftEl) {
            leftEl.innerHTML = `<button id="ledger-toggle-btn" class="btn btn--secondary" data-action="toggle-ledger" title="Cambiar Contabilidad">${isOffBalanceMode ? 'B' : 'A'}</button>
                                <span id="page-title-display">${pageRenderers[pageId].title}</span>`;
        }
        if (actionsEl) actionsEl.innerHTML = pageRenderers[pageId].actions;
        pageRenderers[pageId].render();
    }
    
    const mainScroller = selectOne('.app-layout__main'); if (mainScroller) mainScroller.scrollTop = 0;
    selectAll('.view').forEach(p => p.classList.remove('view--active'));
    const newActivePage = select(pageId); if (newActivePage) newActivePage.classList.add('view--active');
    selectAll('.bottom-nav__item').forEach(b => b.classList.toggle('bottom-nav__item--active', b.dataset.page === pageId));
    
    if (fab) fab.classList.toggle('fab--visible', true);
    updateThemeIcon();
};
        
        const setupTheme = () => { 
    const gridColor = 'rgba(255, 255, 255, 0.1)';
    const textColor = '#FFFFFF';
    Chart.defaults.color = textColor; 
    Chart.defaults.borderColor = gridColor;
    Chart.register(ChartDataLabels);
};
        
        const buildIntelligentIndex = (movementsSource = db.movimientos) => {
            intelligentIndex.clear(); 
            if (!movementsSource || movementsSource.length === 0) return;

            const sortedMovements = [...movementsSource].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            for (const mov of sortedMovements) {
                if (mov.tipo === 'movimiento' && mov.descripcion) {
                    const key = mov.descripcion.trim().toLowerCase();
                    if (!intelligentIndex.has(key)) {
                        intelligentIndex.set(key, {
                            conceptoId: mov.conceptoId,
                            cuentaId: mov.cuentaId
                        });
                    }
                }
            }
            console.log(`Índice inteligente actualizado con ${intelligentIndex.size} entradas.`);
        };
		
		
		const getVisibleAccounts = () => (db.cuentas || []).filter(c => !!c.offBalance === isOffBalanceMode);
        const getLiquidAccounts = () => getVisibleAccounts().filter((c) => !['PROPIEDAD', 'PRÉSTAMO'].includes((c.tipo || '').trim().toUpperCase()));
        const getAllSaldos = () => {
            const saldos = {};
            (db.cuentas || []).forEach(cuenta => {
                saldos[cuenta.id] = cuenta.saldo || 0;
            });
            return saldos;
        };
        async function fetchAllMovementsForBalances() {
            if (!currentUser) return [];
            const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        const fetchAllMovementsForSearch = async () => {
            if (!currentUser) return [];
            try {
                const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error al obtener todos los movimientos para la búsqueda:", error);
                showToast("Error al realizar la búsqueda en la base de datos.", "danger");
                return [];
            }
        };
        const getSaldos = async () => {
            const visibleAccounts = getVisibleAccounts();
            const saldos = {};
            visibleAccounts.forEach(cuenta => {
                saldos[cuenta.id] = cuenta.saldo || 0;
            });
            return saldos;
        };
		
	const fetchAllMovementsForHistory = async () => {
    if (!currentUser) return [];
    try {
        const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
        console.error("Error al obtener el historial completo de movimientos:", error);
        showToast("Error al cargar el historial para el gráfico de patrimonio.", "danger");
        return [];
    }
};
		
        
// REEMPLAZA tu función getFilteredMovements completa por esta:
const getFilteredMovements = async (forComparison = false) => {
    // YA NO CONSULTAMOS FIRESTORE. Usamos la caché en memoria que siempre está actualizada.
    const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));

    // Filtra los movimientos de la caché para que solo incluyan los de las cuentas visibles
    const allVisibleMovements = recentMovementsCache.filter(mov => {
        if (mov.tipo === 'traspaso') {
            return visibleAccountIds.has(mov.cuentaOrigenId) || visibleAccountIds.has(mov.cuentaDestinoId);
        }
        return visibleAccountIds.has(mov.cuentaId);
    });

    const filterPeriodo = select('filter-periodo');
    const p = filterPeriodo ? filterPeriodo.value : 'mes-actual';
    let sDate, eDate, prevSDate, prevEDate;
    const now = new Date();
    now.setHours(0, 0, 0, 0);

    // El resto de la lógica de filtrado por fechas no cambia, ya que opera sobre el array.
    switch (p) {
        case 'mes-actual':
            sDate = new Date(now.getFullYear(), now.getMonth(), 1);
            eDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            prevSDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            prevEDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
            break;
        case 'año-actual':
            sDate = new Date(now.getFullYear(), 0, 1);
            eDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
            prevSDate = new Date(now.getFullYear() - 1, 0, 1);
            prevEDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999);
            break;
        case 'custom':
            const filterFechaInicio = select('filter-fecha-inicio');
            const filterFechaFin = select('filter-fecha-fin');
            sDate = filterFechaInicio?.value ? parseDateStringAsUTC(filterFechaInicio.value) : null;
            eDate = filterFechaFin?.value ? parseDateStringAsUTC(filterFechaFin.value) : null;
            if(eDate) eDate.setUTCHours(23, 59, 59, 999);
            prevSDate = null; prevEDate = null;
            break;
        default:
            return { current: [], previous: [], label: '' };
    }

    const filterByDate = (movs, start, end) => {
        if (!start || !end) return [];
        return movs.filter(m => {
            const movDate = new Date(m.fecha);
            return movDate >= start && movDate <= end;
        });
    };

    const currentMovs = filterByDate(allVisibleMovements, sDate, eDate);
    if (!forComparison) return { current: currentMovs, previous: [], label: '' };
    
    const prevMovs = filterByDate(allVisibleMovements, prevSDate, prevEDate);
    const comparisonLabel = p === 'mes-actual' ? 'vs mes ant.' : (p === 'año-actual' ? 'vs año ant.' : '');
    
    return { current: currentMovs, previous: prevMovs, label: comparisonLabel };
};
        
        const calculateIRR = (cashflows) => {
            if (cashflows.length < 2) return 0;
            const sortedCashflows = [...cashflows].sort((a, b) => a.date.getTime() - b.date.getTime());
            const firstDate = sortedCashflows[0].date;
            const npv = (rate) => { let total = 0; for (const flow of sortedCashflows) { const years = (flow.date.getTime() - firstDate.getTime()) / (365.25 * 24 * 60 * 60 * 1000); total += flow.amount / Math.pow(1 + rate, years); } return total; };
            const derivative = (rate) => { let total = 0; for (const flow of sortedCashflows) { const years = (flow.date.getTime() - firstDate.getTime()) / (365.25 * 24 * 60 * 60 * 1000); if (years > 0) { total -= years * flow.amount / Math.pow(1 + rate, years + 1); } } return total; };
            let guess = 0.1; const maxIterations = 100; const tolerance = 1e-7;
            for (let i = 0; i < maxIterations; i++) {
                const npvValue = npv(guess); const derivativeValue = derivative(guess); if (Math.abs(derivativeValue) < tolerance) break; const newGuess = guess - npvValue / derivativeValue; if (Math.abs(newGuess - guess) <= tolerance) { return newGuess; } guess = newGuess; }
            return 0;
        };
        
        const calculatePortfolioPerformance = async (cuentaId = null) => {
            if (!dataLoaded.inversiones) await loadInversiones();

            const investmentAccounts = getVisibleAccounts().filter(c => c.esInversion && (cuentaId ? c.id === cuentaId : true));
            if (investmentAccounts.length === 0) {
                return { valorActual: 0, capitalInvertido: 0, pnlAbsoluto: 0, pnlPorcentual: 0, irr: 0 };
            }

            let totalValor = 0;
            let totalCapitalInvertido = 0;
            let allIrrCashflows = [];

            const todosLosSaldos = getAllSaldos();

            for (const cuenta of investmentAccounts) {
                const cashflows = (db.inversion_cashflows || []).filter(cf => cf.cuentaId === cuenta.id);
                const capitalInvertido = cashflows.reduce((sum, cf) => sum + cf.cantidad, 0);

                const valoraciones = (db.inversiones_historial || []).filter(v => v.cuentaId === cuenta.id).sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime());
                
                let valorActual;
                if (valoraciones.length > 0) {
                    valorActual = valoraciones[0].valor;
                } else {
                    valorActual = todosLosSaldos[cuenta.id] || 0;
                }

                totalValor += valorActual;
                totalCapitalInvertido += capitalInvertido;

                const irrCashflows = [];
                cashflows.forEach(cf => {
                    irrCashflows.push({ amount: -cf.cantidad, date: new Date(cf.fecha) });
                });
                
                if (valorActual !== 0) {
                    irrCashflows.push({ amount: valorActual, date: new Date() });
                }
                allIrrCashflows.push(...irrCashflows);
            }

            const pnlAbsoluto = totalValor - totalCapitalInvertido;
            const pnlPorcentual = totalCapitalInvertido !== 0 ? (pnlAbsoluto / totalCapitalInvertido) * 100 : 0;

            if (cuentaId) {
                const irrUnico = calculateIRR(allIrrCashflows);
				return { valorActual: totalValor, capitalInvertido: totalCapitalInvertido, pnlAbsoluto: pnlAbsoluto, pnlPorcentual: pnlPorcentual, irr: irrUnico };
            }

            const irrGlobal = calculateIRR(allIrrCashflows);
            return { valorActual: totalValor, capitalInvertido: totalCapitalInvertido, pnlAbsoluto, pnlPorcentual, irr: irrGlobal };
        };
        const recalculateAndApplyRunningBalances = (movements) => {
            if (!movements || movements.length === 0) return 0;

            const cuentaId = movements[0].tipo === 'traspaso' 
                ? (movements[0].cuentaOrigenId || movements[0].cuentaDestinoId)
                : movements[0].cuentaId;

            let saldoFinalReal = 0;
            for (const mov of movements) {
                if (mov.tipo === 'traspaso') {
                    if (mov.cuentaOrigenId === cuentaId) saldoFinalReal -= mov.cantidad;
                    if (mov.cuentaDestinoId === cuentaId) saldoFinalReal += mov.cantidad;
                } else {
                    saldoFinalReal += mov.cantidad;
                }
            }

            const sortedMovements = [...movements].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            let runningBalance = saldoFinalReal;
            for (const mov of sortedMovements) {
                mov.runningBalance = runningBalance; 

                if (mov.tipo === 'traspaso') {
                    if (mov.cuentaOrigenId === cuentaId) runningBalance += mov.cantidad;
                    if (mov.cuentaDestinoId === cuentaId) runningBalance -= mov.cantidad;
                } else {
                    runningBalance -= mov.cantidad;
                }
            }
            return saldoFinalReal;
        };
             const processMovementsForRunningBalance = async (movements, forceRecalculate = false) => {
            if (!runningBalancesCache || forceRecalculate) {
                runningBalancesCache = getAllSaldos();
            }

            const sortedMovements = [...movements].sort((a, b) => {
        const dateComparison = new Date(b.fecha).getTime() - new Date(a.fecha).getTime();
        if (dateComparison !== 0) return dateComparison;
        // El ID del documento como desempate final garantiza el orden.
        return b.id.localeCompare(a.id); 
    });

            for (const mov of sortedMovements) {
                if (mov.tipo === 'traspaso') {
                    if (!runningBalancesCache.hasOwnProperty(mov.cuentaOrigenId)) {
                        runningBalancesCache[mov.cuentaOrigenId] = 0;
                    }
                    if (!runningBalancesCache.hasOwnProperty(mov.cuentaDestinoId)) {
                        runningBalancesCache[mov.cuentaDestinoId] = 0;
                    }

                    mov.runningBalanceOrigen = runningBalancesCache[mov.cuentaOrigenId];
                    mov.runningBalanceDestino = runningBalancesCache[mov.cuentaDestinoId];

                    runningBalancesCache[mov.cuentaOrigenId] += mov.cantidad;
                    runningBalancesCache[mov.cuentaDestinoId] -= mov.cantidad;

                } else {
                    if (!runningBalancesCache.hasOwnProperty(mov.cuentaId)) {
                        runningBalancesCache[mov.cuentaId] = 0;
                    }

                    mov.runningBalance = runningBalancesCache[mov.cuentaId];
                    runningBalancesCache[mov.cuentaId] -= mov.cantidad;
                }
            }
        };
        
        const populateAllDropdowns = () => {
            const visibleAccounts = getVisibleAccounts();
            const populate = (id, data, nameKey, valKey='id', all=false, none=false) => {
                const el = select(id); if (!el) return; const currentVal = el.value;
                let opts = all ? '<option value="">Todos</option>' : ''; if (none) opts += '<option value="">Ninguno</option>';
                [...data].sort((a,b) => (a[nameKey]||"").localeCompare(b[nameKey]||"")).forEach(i => opts += `<option value="${i[valKey]}">${i[nameKey]}</option>`);
                el.innerHTML = opts; 
                const optionsArray = Array.from(el.options);
                el.value = optionsArray.some(o=>o.value===currentVal) ? currentVal : (optionsArray.length > 0 ? optionsArray[0].value : "");
            };
            populate('movimiento-cuenta', visibleAccounts, 'nombre', 'id', false, true);
            
            populateTraspasoDropdowns();
            
            populate('filter-cuenta', visibleAccounts, 'nombre', 'id', true); 
            populate('movimiento-concepto', db.conceptos, 'nombre', 'id', false, true); 
            populate('filter-concepto', db.conceptos, 'nombre', 'id', true);
            const budgetYearSelect = select('budget-year-selector'); if(budgetYearSelect) { const currentVal = budgetYearSelect.value; const currentYear = new Date().getFullYear(); let years = new Set([currentYear]); (db.presupuestos || []).forEach((p) => years.add(p.ano)); budgetYearSelect.innerHTML = [...years].sort((a,b) => b-a).map(y => `<option value="${y}">${y}</option>`).join(''); if(currentVal && [...years].some(y => y == parseInt(currentVal))) budgetYearSelect.value = currentVal; else budgetYearSelect.value = String(currentYear); }
        };

        const populateTraspasoDropdowns = () => {
            const traspasoToggle = select('traspaso-show-all-accounts-toggle');
            const showAll = traspasoToggle ? traspasoToggle.checked : false;
            const accountsToList = showAll ? (db.cuentas || []) : getVisibleAccounts();
            
            const populate = (id, data, none = false) => {
                const el = select(id); if (!el) return;
                const currentVal = el.value;
                let opts = none ? '<option value="">Ninguno</option>' : '';
                data.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(i => opts += `<option value="${i.id}">${i.nombre}</option>`);
                el.innerHTML = opts;
                const optionsArray = Array.from(el.options);
                if (optionsArray.some(o => o.value === currentVal)) {
                    el.value = currentVal;
                } else {
                    el.value = optionsArray.length > 0 ? optionsArray[0].value : "";
                }
            };

            populate('movimiento-cuenta-origen', accountsToList, true);
            populate('movimiento-cuenta-destino', accountsToList, true);
        };
        
               
        const handleUpdateBudgets = () => {
    hapticFeedback('light');

    const initialHtml = `
        <div class="form-group" style="margin-bottom: var(--sp-4);">
            <label for="budget-year-selector-modal" class="form-label">Selecciona el año para gestionar:</label>
            <select id="budget-year-selector-modal" class="form-select"></select>
        </div>
        <div id="budgets-form-container">
            <div class="empty-state" style="background:transparent; border:none; padding-top:0;">
                <p>Selecciona un año para empezar.</p>
            </div>
        </div>`;
    showGenericModal('Gestionar Presupuestos Anuales', initialHtml);

    const renderYearForm = (year) => {
        const container = select('budgets-form-container');
        if (!container) return;

        const budgetsForYear = (db.presupuestos || []).filter(p => p.ano === year);
        const conceptsWithBudget = new Set(budgetsForYear.map(b => b.conceptoId));

        let formHtml = `<form id="update-budgets-form" novalidate>
            <p class="form-label" style="margin-bottom: var(--sp-3)">
                Introduce el límite anual. Usa <b>valores positivos para metas de ingreso</b> y <b>valores negativos para límites de gasto</b>. Deja en blanco o en 0 si no quieres presupuestar un concepto.
            </p>
            <div style="max-height: 45vh; overflow-y: auto; padding-right: var(--sp-2);">`;

        db.conceptos
            .sort((a, b) => a.nombre.localeCompare(b.nombre))
            .forEach(c => {
                const budget = budgetsForYear.find(b => b.ano === year && b.conceptoId === c.id);
                const currentAmount = budget ? (budget.cantidad / 100).toFixed(2).replace('.', ',') : '';
                const placeholder = conceptsWithBudget.has(c.id) ? '' : '0,00';
                formHtml += `
                    <div class="form-group">
                        <label for="budget-input-${c.id}" class="form-label" style="font-weight: 600;">${c.nombre}</label>
                        <input type="text" id="budget-input-${c.id}" data-concept-id="${c.id}" class="form-input" inputmode="decimal" value="${currentAmount}" placeholder="${placeholder}">
                    </div>`;
            });
        
        formHtml += `</div><div class="modal__actions"><button type="submit" class="btn btn--primary btn--full">Guardar Cambios para ${year}</button></div></form>`;
        container.innerHTML = formHtml;
        
        const updateBudgetsForm = select('update-budgets-form');
        if (updateBudgetsForm) {
            updateBudgetsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                setButtonLoading(btn, true, 'Guardando...');

                const inputs = e.target.querySelectorAll('input[data-concept-id]');
                const batch = fbDb.batch();

                for (const input of inputs) {
                    const conceptoId = input.dataset.conceptId;
                    const amountValue = parseCurrencyString(input.value);
                    
                    if (isNaN(amountValue)) continue;

                    const newAmountInCents = Math.round(amountValue * 100);
                    let budget = (db.presupuestos || []).find(b => b.ano === year && b.conceptoId === conceptoId);
                    
                    if (budget) {
                        const ref = fbDb.collection('users').doc(currentUser.uid).collection('presupuestos').doc(budget.id);
                        if (newAmountInCents !== 0) {
                            batch.update(ref, { cantidad: newAmountInCents });
                        } else {
                            batch.delete(ref);
                        }
                    } else if (newAmountInCents !== 0) {
                        const newId = generateId();
                        const ref = fbDb.collection('users').doc(currentUser.uid).collection('presupuestos').doc(newId);
                        batch.set(ref, { id: newId, ano: year, conceptoId: conceptoId, cantidad: newAmountInCents });
                    }
                }

                await batch.commit();
                setButtonLoading(btn, false);
                hideModal('generic-modal');
                hapticFeedback('success');
                showToast(`Presupuestos de ${year} actualizados.`);
                
                renderBudgetTracking(); 
            });
        }
    };

    setTimeout(() => {
        const yearSelect = select('budget-year-selector-modal');
        if (!yearSelect) return;
        
        const currentYear = new Date().getFullYear();
        let years = new Set([currentYear, currentYear + 1]);
        (db.presupuestos || []).forEach(p => years.add(p.ano));
        
        yearSelect.innerHTML = `<option value="">Seleccionar...</option>` + 
            [...years].sort((a, b) => b - a).map(y => `<option value="${y}">${y}</option>`).join('');
        
        yearSelect.addEventListener('change', (e) => {
            const selectedYear = parseInt(e.target.value, 10);
            if (selectedYear) {
                renderYearForm(selectedYear);
            } else {
                const container = select('budgets-form-container');
                if (container) container.innerHTML = `<div class="empty-state" style="background:transparent; border:none; padding-top:0;"><p>Selecciona un año para empezar.</p></div>`;
            }
        });
    }, 0);
};
        
	   const renderBudgetTracking = async () => {
    const dashboardContainer = select('annual-budget-dashboard');
    const placeholder = select('budget-init-placeholder');
    const yearSelector = select('budget-year-selector');
    if (!dashboardContainer || !placeholder || !yearSelector) return;
    
    const year = parseInt(yearSelector.value, 10);
    
    const allYearBudgets = (db.presupuestos || [])
        .filter(b => b.ano === year && db.conceptos.find(c => c.id === b.conceptoId));

    if (allYearBudgets.length === 0) {
        dashboardContainer.classList.add('hidden');
        placeholder.classList.remove('hidden');
        const titleEl = select('budget-placeholder-title');
        const textEl = select('budget-placeholder-text');
        if (titleEl) titleEl.textContent = `Configurar Presupuestos ${year}`;
        if (textEl) textEl.textContent = `Aún no has definido metas de ingreso o límites de gasto para el año ${year}.`;
        return;
    }
    
    dashboardContainer.classList.remove('hidden');
    placeholder.classList.add('hidden');

    const { percentage: yearProgress, daysPassed, daysRemaining, totalDaysInYear } = getYearProgress();
    
    const startDate = new Date(year, 0, 1);
    const endDate = new Date(year, 11, 31, 23, 59, 59, 999);
    let baseQuery = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
        .where('fecha', '>=', startDate.toISOString())
        .where('fecha', '<=', endDate.toISOString())
        .where('tipo', '==', 'movimiento');
    
    const visibleAccountIds = getVisibleAccounts().map(c => c.id);
    const movements = await fetchMovementsInChunks(baseQuery, 'cuentaId', visibleAccountIds);
    
    const monthlyIncomeData = {};
    const monthlyExpenseData = {};
    movements.forEach(mov => {
        const month = new Date(mov.fecha).getMonth();
        if (mov.cantidad > 0) {
            monthlyIncomeData[month] = (monthlyIncomeData[month] || 0) + mov.cantidad;
        } else {
            monthlyExpenseData[month] = (monthlyExpenseData[month] || 0) + Math.abs(mov.cantidad);
        }
    });

    const expenseBudgets = allYearBudgets.filter(b => b.cantidad < 0);
    let totalBudgetedExpense = 0;
    const expenseDetails = expenseBudgets.map(budget => {
        const actualSpent = Math.abs(movements.filter(m => m.conceptoId === budget.conceptoId && m.cantidad < 0).reduce((sum, m) => sum + m.cantidad, 0));
        const budgetLimit = Math.abs(budget.cantidad);
        totalBudgetedExpense += budgetLimit;

        const rawPacePercentage = (budgetLimit > 0 && yearProgress > 0) ? ((actualSpent / budgetLimit) / (yearProgress / 100)) * 100 : (actualSpent > 0 ? 200 : 100);
        const pacePercentage = Math.min(rawPacePercentage, 200);

        let status;
        if (rawPacePercentage > 120) {
            status = { text: 'Excedido', icon: 'cancel', color: 'text-danger' };
        } else if (rawPacePercentage >= 80) {
            status = { text: 'Vas bien', icon: 'check_circle', color: 'text-info' };
        } else {
            status = { text: 'Ahorrando', icon: 'verified', color: 'text-positive' };
        }

        const projectedAnnualSpent = (daysPassed > 0) ? (actualSpent / daysPassed) * totalDaysInYear : 0;
        return { ...budget, actual: actualSpent, limit: budgetLimit, projected: projectedAnnualSpent, pacePercentage, status };
    });
    const totalProjectedExpense = expenseDetails.reduce((sum, b) => sum + b.projected, 0);

    const incomeBudgets = allYearBudgets.filter(b => b.cantidad >= 0);
    let totalBudgetedIncome = 0;
    const incomeDetails = incomeBudgets.map(budget => {
        const actualIncome = movements.filter(m => m.conceptoId === budget.conceptoId && m.cantidad > 0).reduce((sum, m) => sum + m.cantidad, 0);
        const budgetGoal = budget.cantidad;
        totalBudgetedIncome += budgetGoal;

        const rawPacePercentage = (budgetGoal > 0 && yearProgress > 0) ? ((actualIncome / budgetGoal) / (yearProgress / 100)) * 100 : (actualIncome > 0 ? 200 : 0);
        const pacePercentage = Math.min(rawPacePercentage, 200);

        let status;
        if (rawPacePercentage > 120) {
            status = { text: 'Superado', icon: 'rocket_launch', color: 'text-positive' };
        } else if (rawPacePercentage >= 80) {
            status = { text: 'Vas bien', icon: 'check_circle', color: 'text-info' };
        } else {
            status = { text: 'Por debajo del objetivo', icon: 'trending_down', color: 'text-warning' };
        }

        const projectedAnnualIncome = (daysPassed > 0) ? (actualIncome / daysPassed) * totalDaysInYear : 0;
        return { ...budget, actual: actualIncome, limit: budgetGoal, projected: projectedAnnualIncome, pacePercentage, status };
    });
    const totalProjectedIncome = incomeDetails.reduce((sum, b) => sum + b.projected, 0);

    const projectedNet = totalProjectedIncome - totalProjectedExpense;
    const kpiContainer = select('budget-kpi-container');
    if (kpiContainer) kpiContainer.innerHTML = `
        <div class="kpi-item"><h4 class="kpi-item__label">Proyección Ingresos</h4><strong class="kpi-item__value text-positive">${formatCurrency(totalProjectedIncome)}</strong></div>
        <div class="kpi-item"><h4 class="kpi-item__label">Proyección Gastos</h4><strong class="kpi-item__value text-negative">${formatCurrency(totalProjectedExpense)}</strong></div>
        <div class="kpi-item"><h4 class="kpi-item__label">Proyección Neta Anual</h4><strong class="kpi-item__value ${projectedNet >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(projectedNet)}</strong></div>
    `;
    renderBudgetTrendChart(monthlyIncomeData, monthlyExpenseData, totalBudgetedExpense / 12);

    const listContainer = select('budget-details-list');
    let listHtml = '';

    if (incomeDetails.length > 0) {
        listHtml += `<h4 style="margin-top: var(--sp-5);">Metas de Ingresos</h4>`;
        listHtml += incomeDetails.sort((a, b) => (a.projected / (a.limit || 1)) - (b.projected / (b.limit || 1))).map(b => {
            const concepto = db.conceptos.find(c => c.id === b.conceptoId);
            const conceptoNombre = (concepto && concepto.nombre) || 'Concepto no encontrado';
            return `
            <div class="card" style="margin-bottom: var(--sp-3);"><div class="card__content" style="padding: var(--sp-3);">
                <div style="display: grid; grid-template-columns: 80px 1fr; gap: var(--sp-4); align-items: center;">
                    <div style="position: relative; width: 80px; height: 55px;"><canvas id="gauge-chart-${b.id}"></canvas><div style="position: absolute; top: 65%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-weight: 800; font-size: var(--fs-lg);">${b.pacePercentage.toFixed(0)}<span style="font-size: 0.7em;">%</span></div></div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--sp-2);"><h4 style="font-size: var(--fs-base); font-weight: 700;">${conceptoNombre}</h4><span class="${b.status.color}" style="font-weight: 600; font-size: var(--fs-xs); display:flex; align-items:center; gap: 4px;">
    <span class="material-icons" style="font-size: 14px;">${b.status.icon}</span>
    <span>${b.status.text}</span>
    <button class="icon-btn" data-action="show-help-topic" data-topic="pace" style="width: 18px; height: 18px; margin-left: 2px;">
        <span class="material-icons" style="font-size: 14px;">help_outline</span>
    </button>
</span>
                        <div style="font-size: var(--fs-sm);"><strong>Ingresado:</strong> ${formatCurrency(b.actual)} de ${formatCurrency(b.limit)}</div>
                        <div style="font-size: var(--fs-sm); font-weight: 600;"><strong>Proyección:</strong> <span class="${b.projected >= b.limit ? 'text-positive' : 'text-danger'}">${formatCurrency(b.projected)}</span></div>
                    </div>
                </div>
            </div></div>`;
        }).join('');
    }
    
    if (expenseDetails.length > 0) {
        listHtml += `<h4 style="margin-top: var(--sp-5);">Límites de Gasto</h4>`;
        listHtml += expenseDetails.sort((a, b) => (b.projected / (b.limit || 1)) - (a.projected / (a.limit || 1))).map(b => {
            const concepto = db.conceptos.find(c => c.id === b.conceptoId);
            const conceptoNombre = (concepto && concepto.nombre) || 'Concepto no encontrado';
            return `
            <div class="card" style="margin-bottom: var(--sp-3);"><div class="card__content" style="padding: var(--sp-3);">
                <div style="display: grid; grid-template-columns: 80px 1fr; gap: var(--sp-4); align-items: center;">
                    <div style="position: relative; width: 80px; height: 55px;"><canvas id="gauge-chart-${b.id}"></canvas><div style="position: absolute; top: 65%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-weight: 800; font-size: var(--fs-lg);">${b.pacePercentage.toFixed(0)}<span style="font-size: 0.7em;">%</span></div></div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--sp-2);"><h4 style="font-size: var(--fs-base); font-weight: 700;">${conceptoNombre}</h4><span class="${b.status.color}" style="font-weight: 600; font-size: var(--fs-xs); display:flex; align-items:center; gap: 4px;"><span class="material-icons" style="font-size: 14px;">${b.status.icon}</span> ${b.status.text}</span></div>
                        <div style="font-size: var(--fs-sm);"><strong>Gastado:</strong> ${formatCurrency(b.actual)} de ${formatCurrency(b.limit)}</div>
                        <div style="font-size: var(--fs-sm); font-weight: 600;"><strong>Proyección:</strong> <span class="${b.projected > b.limit ? 'text-danger' : 'text-positive'}">${formatCurrency(b.projected)}</span></div>
                    </div>
                </div>
            </div></div>`;
        }).join('');
    }
    
    if (listContainer) listContainer.innerHTML = listHtml;

    setTimeout(() => {
        [...incomeDetails, ...expenseDetails].forEach(b => {
            renderGaugeChart(`gauge-chart-${b.id}`, b.pacePercentage, 100);
        });
    }, 50);
};
	     const handleToggleInvestmentTypeFilter = (type) => {
            hapticFeedback('light');
            if (deselectedInvestmentTypesFilter.has(type)) {
                deselectedInvestmentTypesFilter.delete(type);
            } else {
                deselectedInvestmentTypesFilter.add(type);
            }

            renderInversionesPage('analisis-inversiones-container');
        };
const renderInversionesPage = async (targetContainerId) => {
    const container = select(targetContainerId);
    if (!container) return;

    const CHART_COLORS = ['#007AFF', '#30D158', '#FFD60A', '#FF3B30', '#C084FC', '#4ECDC4', '#EF626C', '#A8D58A'];

    if (!db.cuentas || !dataLoaded.inversiones) {
        container.innerHTML = `<div class="skeleton" style="height: 250px; border-radius: var(--border-radius-lg);"></div>`;
        return;
    }

    const allInvestmentAccounts = getVisibleAccounts().filter((c) => c.esInversion);
    if (allInvestmentAccounts.length === 0) {
        container.innerHTML = `<div id="empty-investments" class="empty-state" style="margin-top: 0; border: none; background: transparent;">
                <span class="material-icons">rocket_launch</span>
                <h3>¿Listo para despegar?</h3>
                <p>Para empezar, ve a 'Ajustes' > 'Gestión de Datos' > 'Cuentas' y marca tus cuentas de inversión.</p>
            </div>`;
        return;
    }

    const allAssetsData = await Promise.all(allInvestmentAccounts.map(async (cuenta) => {
        const performance = await calculatePortfolioPerformance(cuenta.id);
        return { cuenta, performance };
    }));

    const allInvestmentTypes = [...new Set(allAssetsData.map(asset => toSentenceCase(asset.cuenta.tipo || 'S/T')))].sort();
    
    const displayAssetsData = allAssetsData.filter(asset => 
        !deselectedInvestmentTypesFilter.has(toSentenceCase(asset.cuenta.tipo || 'S/T'))
    );

    const chartLabels = Object.keys(displayAssetsData.reduce((acc, { cuenta }) => {
        const tipo = toSentenceCase(cuenta.tipo || 'Sin Categoría');
        acc[tipo] = true;
        return acc;
    }, {})).sort();
    
    const colorMap = {};
    chartLabels.forEach((label, index) => {
        colorMap[label] = CHART_COLORS[index % CHART_COLORS.length];
    });

    const pillsHTML = allInvestmentTypes.map(t => {
        const isActive = !deselectedInvestmentTypesFilter.has(t);
        const color = colorMap[t];
        let style = '';
        if (isActive && color) {
            style = `style="background-color: ${color}; border-color: ${color}; color: #FFFFFF; box-shadow: 0 0 8px ${color}70;"`;
        }
        return `<button class="filter-pill ${isActive ? 'filter-pill--active' : ''}" data-action="toggle-investment-type-filter" data-type="${t}" ${style}>${t}</button>`;
    }).join('');

    const displayPerformance = displayAssetsData.reduce((acc, asset) => {
        acc.valorActual += asset.performance.valorActual;
        acc.capitalInvertido += asset.performance.capitalInvertido;
        return acc;
    }, { valorActual: 0, capitalInvertido: 0 });
    
    displayPerformance.pnlAbsoluto = displayPerformance.valorActual - displayPerformance.capitalInvertido;
    displayPerformance.pnlPorcentual = displayPerformance.capitalInvertido !== 0 ? (displayPerformance.pnlAbsoluto / displayPerformance.capitalInvertido) * 100 : 0;
    
    let irrCashflowsForDisplayGroup = [];
    displayAssetsData.forEach(asset => {
        irrCashflowsForDisplayGroup.push({ amount: asset.performance.valorActual, date: new Date() });
        (db.inversion_cashflows || []).filter(cf => cf.cuentaId === asset.cuenta.id).forEach(cf => {
            irrCashflowsForDisplayGroup.push({ amount: -cf.cantidad, date: new Date(cf.fecha) });
        });
    });
    displayPerformance.irr = calculateIRR(irrCashflowsForDisplayGroup);
    
    const pnlClassDisplay = displayPerformance.pnlAbsoluto >= 0 ? 'text-positive' : 'text-negative';
    const irrClassDisplay = displayPerformance.irr >= 0 ? 'text-positive' : 'text-negative';

    const assetCardsHTML = displayAssetsData.map(({ cuenta, performance }) => {
        const pnlClass = performance.pnlAbsoluto >= 0 ? 'text-positive' : 'text-negative';
        return `<div class="investment-asset-card" data-id="${cuenta.id}"><div class="investment-asset-card__header"><div style="cursor: pointer;" data-action="view-investment-detail" data-id="${cuenta.id}"><h3 class="investment-asset-card__name">${escapeHTML(cuenta.nombre)}</h3><small style="color: var(--c-on-surface-secondary);">${escapeHTML(cuenta.tipo)}</small></div><div><div class="investment-asset-card__value">${formatCurrency(performance.valorActual)}</div><div class="investment-asset-card__pnl ${pnlClass}">${performance.pnlAbsoluto >= 0 ? '+' : ''}${formatCurrency(performance.pnlAbsoluto)} (${performance.pnlPorcentual.toFixed(2)}%)</div></div></div></div>`;
    }).join('');

    container.innerHTML = `
        <div class="card card--no-bg accordion-wrapper">
             <details class="accordion" open>
                <summary>
                    <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">pie_chart</span>Asignación y Filtros</h3>
                    <span class="material-icons accordion__icon">expand_more</span>
                </summary>
                <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                    <div class="filter-pills" style="margin-bottom: var(--sp-5);">${pillsHTML}</div>
                    <div class="chart-container" style="height: 220px; margin-bottom: 0;"><canvas id="asset-allocation-chart"></canvas></div>
                </div>
            </details>
        </div>

        <div id="investment-global-kpis" style="margin-top: var(--sp-4);">
            <div style="display: flex; align-items: center; margin-bottom: var(--sp-2);"><h3 class="card__title" style="padding:0; margin:0; font-size: var(--fs-base);">Métricas del Portafolio (Filtrado)</h3></div>
            <div class="kpi-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: var(--sp-3);"><div class="kpi-item"><h4 class="kpi-item__label">Valor Total</h4><strong class="kpi-item__value">${formatCurrency(displayPerformance.valorActual)}</strong></div><div class="kpi-item"><h4 class="kpi-item__label">Capital Total</h4><strong class="kpi-item__value">${formatCurrency(displayPerformance.capitalInvertido)}</strong></div></div>
            <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr;"><div class="kpi-item"><h4 class="kpi-item__label">P&L (€)</h4><strong class="kpi-item__value ${pnlClassDisplay}">${displayPerformance.pnlAbsoluto >= 0 ? '+' : ''}${formatCurrency(displayPerformance.pnlAbsoluto)}</strong></div><div class="kpi-item"><h4 class="kpi-item__label">P&L (%)</h4><strong class="kpi-item__value ${pnlClassDisplay}">${displayPerformance.pnlPorcentual.toFixed(2)}%</strong></div><div class="kpi-item"><h4 class="kpi-item__label" style="display: flex; align-items: center; gap: 4px;">
    <span>TIR Anualizada</span>
    <button class="icon-btn" data-action="show-help-topic" data-topic="tir" style="width: 20px; height: 20px;">
        <span class="material-icons" style="font-size: 16px;">help_outline</span>
    </button>
</h4>><strong class="kpi-item__value ${irrClassDisplay}">${(displayPerformance.irr * 100).toFixed(2)}%</strong></div></div>
        </div>
        
        <div id="investment-assets-list" style="margin-top: var(--sp-4);">${assetCardsHTML}</div>
        
        <div class="card card--no-bg" style="padding:0; margin-top: var(--sp-4);"><div class="form-grid"><button class="btn btn--secondary" data-action="manage-investment-accounts"><span class="material-icons" style="font-size:16px;">checklist</span>Gestionar Activos</button><button class="btn btn--secondary" data-action="add-aportacion"><span class="material-icons" style="font-size:16px;">add_card</span>Aportar/Retirar</button></div></div>
    `;
    
    setTimeout(() => {
        const allocationCtx = select('asset-allocation-chart');
        if (allocationCtx) {
            if (assetAllocationChart) assetAllocationChart.destroy();
            
            const allocationData = displayAssetsData.reduce((acc, { cuenta, performance }) => {
                const tipo = toSentenceCase(cuenta.tipo || 'Sin Categoría');
                if (!acc[tipo]) acc[tipo] = 0;
                acc[tipo] += performance.valorActual;
                return acc;
            }, {});

            const chartValues = chartLabels.map(label => allocationData[label] || 0);
            
            if (chartLabels.length > 0) {
                assetAllocationChart = new Chart(allocationCtx, {
                    type: 'doughnut',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartValues.map(v => v / 100),
                            backgroundColor: chartLabels.map(label => colorMap[label]),
                            borderColor: getComputedStyle(document.body).getPropertyValue('--c-surface'),
                            borderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (evt, elements) => {
                            if (elements.length > 0) {
                                const clickedLabel = assetAllocationChart.data.labels[elements[0].index];
                                deselectedInvestmentTypesFilter.clear();
                                allInvestmentTypes.forEach(type => {
                                    if (type !== clickedLabel) {
                                        deselectedInvestmentTypesFilter.add(type);
                                    }
                                });
                                renderInversionesPage('analisis-inversiones-container');
                            }
                        },
                        onHover: (event, chartElement) => {
                            event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed !== null) { label += formatCurrency(context.parsed * 100); }
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                formatter: (value, context) => {
                                    const sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = sum > 0 ? (value * 100 / sum).toFixed(0) + "%" : "0%";
                                    return percentage;
                                },
                                color: getComputedStyle(document.body).getPropertyValue('--c-on-surface'),
                                font: { weight: 'bold', size: 11 }
                            }
                        }
                    }
                });
            }
        }
    }, 50);
};

        const renderInformesPage = async () => {
            const resultsContainer = select('informe-results-container');
            const emptyState = select('empty-informes');
            const kpiContainer = select('informe-kpi-container');
            const chartCanvas = select('informes-chart');
            const chartCtx = chartCanvas ? chartCanvas.getContext('2d') : null;
        
            if (!resultsContainer || !emptyState || !chartCtx || !kpiContainer) return;
            if (informesChart) { informesChart.destroy(); }
            
            const fechaInicioEl = select('informe-fecha-inicio');
            const fechaFinEl = select('informe-fecha-fin');
            const fechaInicioVal = fechaInicioEl ? fechaInicioEl.value : null;
            const fechaFinVal = fechaFinEl ? fechaFinEl.value : null;
            
            const cuentaIdEl = select('filter-cuenta-informe');
            const conceptoIdEl = select('filter-concepto-informe');
            const cuentaId = cuentaIdEl ? cuentaIdEl.value : null;
            const conceptoId = conceptoIdEl ? conceptoIdEl.value : null;
        
            if (!fechaInicioVal || !fechaFinVal) {
                resultsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
        
            const fechaInicio = parseDateStringAsUTC(fechaInicioVal);
            const fechaFin = parseDateStringAsUTC(fechaFinVal);
            
            const visibleAccountIds = getVisibleAccounts().map(c => c.id);
            if (visibleAccountIds.length === 0) {
                showToast('No hay cuentas seleccionadas en esta contabilidad.', 'info');
                resultsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                const p = emptyState.querySelector('p');
                if (p) p.textContent = "No hay cuentas visibles para generar el informe.";
                return;
            }
        
            let baseQuery = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
                .where('fecha', '>=', fechaInicio.toISOString())
                .where('fecha', '<=', fechaFin.toISOString())
                .where('tipo', '==', 'movimiento');

            if (conceptoId) {
                baseQuery = baseQuery.where('conceptoId', '==', conceptoId);
            }
            
            const accountIdsToQuery = cuentaId ? [cuentaId] : visibleAccountIds;
            const movimientos = await fetchMovementsInChunks(baseQuery, 'cuentaId', accountIdsToQuery);
            
            if (movimientos.length === 0) {
                showToast('No se encontraron movimientos para los filtros seleccionados.', 'info');
                resultsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                const p = emptyState.querySelector('p');
                if (p) p.textContent = "No hay datos para este informe. Prueba a cambiar los filtros.";
                return;
            }
            
        
            resultsContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            const datosAgrupados = movimientos.reduce((acc, mov) => {
                const fecha = new Date(mov.fecha);
                const clave = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                if (!acc[clave]) {
                    acc[clave] = { ingresos: 0, gastos: 0 };
                }

                if (mov.tipo === 'movimiento') {
                    if (mov.cantidad > 0) {
                        acc[clave].ingresos += mov.cantidad;
                    } else {
                        acc[clave].gastos += mov.cantidad;
                    }
                } else if (mov.tipo === 'traspaso') {
                    if (cuentaId) { 
                        if (mov.cuentaDestinoId === cuentaId) {
                            acc[clave].ingresos += mov.cantidad;
                        }
                        if (mov.cuentaOrigenId === cuentaId) {
                            acc[clave].gastos -= mov.cantidad;
                        }
                    }
                }
                return acc;
            }, {});
        
            const etiquetas = Object.keys(datosAgrupados).sort();
            const datosIngresos = etiquetas.map(clave => datosAgrupados[clave].ingresos / 100);
            const datosGastos = etiquetas.map(clave => Math.abs(datosAgrupados[clave].gastos / 100));
        
            const etiquetasFormateadas = etiquetas.map(clave => {
                const [year, month] = clave.split('-');
                return new Date(parseInt(year), parseInt(month) - 1).toLocaleDateString('es-ES', { month: 'short', year: '2-digit' });
            });
            
            const totalIngresos = datosIngresos.reduce((sum, val) => sum + (val * 100), 0);
            const totalGastos = datosGastos.reduce((sum, val) => sum + (val * 100), 0);
            const neto = totalIngresos - totalGastos;
            
            kpiContainer.innerHTML = `
                <div class="kpi-item"><h4 class="kpi-item__label">Total Ingresos</h4><strong class="kpi-item__value text-positive">${formatCurrency(totalIngresos)}</strong></div>
                <div class="kpi-item"><h4 class="kpi-item__label">Total Gastos</h4><strong class="kpi-item__value text-negative">${formatCurrency(-totalGastos)}</strong></div>
                <div class="kpi-item"><h4 class="kpi-item__label">Resultado Neto</h4><strong class="kpi-item__value ${neto >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(neto)}</strong></div>
            `;
        
            informesChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: etiquetasFormateadas,
                    datasets: [
                        { label: 'Ingresos', data: datosIngresos, borderColor: getComputedStyle(document.body).getPropertyValue('--c-success'), backgroundColor: 'rgba(48, 209, 88, 0.2)', fill: true, tension: 0.3, pointBackgroundColor: getComputedStyle(document.body).getPropertyValue('--c-success') },
                        { label: 'Gastos', data: datosGastos, borderColor: getComputedStyle(document.body).getPropertyValue('--c-danger'), backgroundColor: 'rgba(255, 59, 48, 0.2)', fill: true, tension: 0.3, pointBackgroundColor: getComputedStyle(document.body).getPropertyValue('--c-danger') }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: (value) => formatCurrency(value * 100).replace(/\s/g, '') } } },
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${formatCurrency(c.parsed.y * 100)}` } }, datalabels: { display: false } }
                }
            });
        };
        
        const renderVirtualListItem = (item) => {
			/* === INICIO: CÓDIGO AÑADIDO === */
            // Caso para renderizar la cabecera de la sección de pendientes
            if (item.type === 'pending-header') {
                return `
                    <div class="movimiento-date-header" style="background-color: var(--c-warning); color: var(--c-black); font-weight: 800; letter-spacing: 0.5px;">
                        <span>
                            <span class="material-icons" style="font-size: 16px; vertical-align: bottom; margin-right: 4px;">update</span>
                            RECURRENTES PENDIENTES (${item.count})
                        </span>
                    </div>`;
            }

            // Caso para renderizar cada item de movimiento recurrente pendiente
            if (item.type === 'pending-item') {
                const r = item.recurrent;
                const nextDate = new Date(r.nextDate + 'T12:00:00Z');
                const formattedDate = nextDate.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
                const amountClass = r.cantidad >= 0 ? 'text-positive' : 'text-negative';

                return `
                <div class="transaction-card" id="pending-recurrente-${r.id}" style="background-color: color-mix(in srgb, var(--c-warning) 10%, transparent);">
                    <div class="transaction-card__indicator transaction-card__indicator--recurrent"></div>
                    <div class="transaction-card__content">
                        <div class="transaction-card__details">
                            <div class="transaction-card__row-1">${escapeHTML(r.descripcion)}</div>
                            <div class="transaction-card__row-2" style="font-weight: 600; color: var(--c-warning);">Pendiente desde: ${formattedDate}</div>
                        </div>
                        <div class="transaction-card__figures" style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                            <strong class="transaction-card__amount ${amountClass}">${formatCurrency(r.cantidad)}</strong>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button class="btn btn--secondary" data-action="skip-recurrent" data-id="${r.id}" title="Omitir esta vez" style="padding: 4px 8px; font-size: 0.7rem;">
                                    <span class="material-icons" style="font-size: 14px;">skip_next</span>No añadir
                                </button>
                                <button class="btn btn--primary" data-action="confirm-recurrent" data-id="${r.id}" title="Crear el movimiento ahora" style="padding: 4px 8px; font-size: 0.7rem;">
                                    <span class="material-icons" style="font-size: 14px;">check</span>Añadir Ahora
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            /* === FIN: CÓDIGO AÑADIDO === */
            if (item.type === 'date-header') {
                const dateObj = new Date(item.date + 'T12:00:00Z');
                const day = dateObj.toLocaleDateString('es-ES', { weekday: 'short' }).toUpperCase().replace('.', '');
                const dateStr = dateObj.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });

                return `
                    <div class="movimiento-date-header">
                        <span>${day} ${dateStr}</span>
                        <span>${formatCurrency(item.total)}</span>
                    </div>
                `;
            }

            const m = item.movement;
            let highlightClass = '';
            if (m.id === newMovementIdToHighlight) {
                highlightClass = 'highlight-animation';
                newMovementIdToHighlight = null;
            }

            const formattedDate = new Date(m.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            let indicatorClass = '';
            
            if (m.tipo === 'traspaso') indicatorClass = 'transaction-card__indicator--transfer';
            else if (m.cantidad >= 0) indicatorClass = 'transaction-card__indicator--income';
            else indicatorClass = 'transaction-card__indicator--expense';

            if (m.tipo === 'traspaso') {
                const origen = db.cuentas.find(c => c.id === m.cuentaOrigenId);
                const destino = db.cuentas.find(c => c.id === m.cuentaDestinoId);
                return `
                <div class="swipe-container">
                    <div class="swipe-actions-container left">
                        <button class="swipe-action-btn duplicate" data-action="swipe-duplicate-movement" data-id="${m.id}">
                            <span class="material-icons">content_copy</span>
                            <span>Duplicar</span>
                        </button>
                    </div>
                    <div class="swipe-actions-container right">
                        <button class="swipe-action-btn delete" data-action="swipe-delete-movement" data-id="${m.id}" data-is-recurrent="false">
                            <span class="material-icons">delete</span>
                            <span>Borrar</span>
                        </button>
                    </div>
                    <div class="transaction-card ${highlightClass}" data-id="${m.id}" data-action="edit-movement-from-list">
                        <div class="transaction-card__indicator ${indicatorClass}"></div>
                        <div class="transaction-card__content">
                            <div class="transaction-card__details">
                                <div class="transaction-card__concept">${escapeHTML(m.descripcion) || 'Traspaso'}</div>
                                <div class="transaction-card__description">${formattedDate}</div>
                                <div class="transaction-card__transfer-details">
                                    <div class="transaction-card__transfer-row">
                                        <span><span class="material-icons">arrow_upward</span> ${(origen && origen.nombre) || '?'}</span>
                                        <span class="transaction-card__balance">${formatCurrency(m.runningBalanceOrigen)}</span>
                                    </div>
                                    <div class="transaction-card__transfer-row">
                                        <span><span class="material-icons">arrow_downward</span> ${(destino && destino.nombre) || '?'}</span>
                                        <span class="transaction-card__balance">${formatCurrency(m.runningBalanceDestino)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="transaction-card__figures">
                                <div class="transaction-card__amount text-info">${formatCurrency(m.cantidad)}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            } else {
                const cuenta = db.cuentas.find(c => c.id === m.cuentaId);
                const concept = db.conceptos.find(c => c.id === m.conceptoId);
                const amountClass = m.cantidad >= 0 ? 'text-positive' : 'text-negative';
                return `
                <div class="swipe-container">
                    <div class="swipe-actions-container left">
                        <button class="swipe-action-btn duplicate" data-action="swipe-duplicate-movement" data-id="${m.id}">
                            <span class="material-icons">content_copy</span>
                            <span>Duplicar</span>
                        </button>
                    </div>
                    <div class="swipe-actions-container right">
                         <button class="swipe-action-btn delete" data-action="swipe-delete-movement" data-id="${m.id}" data-is-recurrent="false">
                            <span class="material-icons">delete</span>
                            <span>Borrar</span>
                        </button>
                    </div>
                    <div class="transaction-card ${highlightClass}" data-id="${m.id}" data-action="edit-movement-from-list">
                        <div class="transaction-card__indicator ${indicatorClass}"></div>
                        <div class="transaction-card__content">
                            <div class="transaction-card__details">
                                <div class="transaction-card__row-1">${toSentenceCase((concept && concept.nombre) || 'S/C')}</div>
                                <div class="transaction-card__row-2">${formattedDate} • ${escapeHTML(m.descripcion)}</div>
                            </div>
                            <div class="transaction-card__figures">
                                <div class="transaction-card__amount ${amountClass}">${formatCurrency(m.cantidad)}</div>
                                <div class="transaction-card__balance">${formatCurrency(m.runningBalance)}</div>
                                <div class="transaction-card__row-2" style="text-align: right;">${escapeHTML((cuenta && cuenta.nombre) || 'S/C')}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
        };
        
        const renderVisibleItems = () => {
            if (!vList.scrollerEl || !vList.contentEl) return; 
            const scrollTop = vList.scrollerEl.scrollTop;
            const containerHeight = vList.scrollerEl.clientHeight;
            let startIndex = -1, endIndex = -1;
            
            for (let i = 0; i < vList.itemMap.length; i++) {
                const item = vList.itemMap[i];
                if (startIndex === -1 && item.offset + item.height > scrollTop) {
                    startIndex = Math.max(0, i - vList.renderBuffer);
                }
                if (endIndex === -1 && item.offset + item.height > scrollTop + containerHeight) {
                    endIndex = Math.min(vList.itemMap.length - 1, i + vList.renderBuffer);
                    break;
                }
            }
            if (startIndex === -1 && vList.items.length > 0) startIndex = 0;
            if (endIndex === -1) endIndex = vList.itemMap.length - 1;
            
            if (startIndex === vList.lastRenderedRange.start && endIndex === vList.lastRenderedRange.end) return;
            
            let visibleHtml = ''; 
            for (let i = startIndex; i <= endIndex; i++) {
                if (vList.items[i]) visibleHtml += renderVirtualListItem(vList.items[i]);
            }
            vList.contentEl.innerHTML = visibleHtml; 
            const offsetY = vList.itemMap[startIndex] ? vList.itemMap[startIndex].offset : 0; 
            vList.contentEl.style.transform = `translateY(${offsetY}px)`; 
            vList.lastRenderedRange = { start: startIndex, end: endIndex };
        };
        
        // REEMPLAZAR la función loadInitialMovements existente por esta:

        const loadInitialMovements = async () => {
            const emptyEl = select('empty-movimientos'), listContainer = select('movimientos-list-container');
            if (!vList.scrollerEl) {
                vList.scrollerEl = selectOne('.app-layout__main');
                vList.sizerEl = select('virtual-list-sizer');
                vList.contentEl = select('virtual-list-content');
            }
            if (!listContainer || !emptyEl || !vList.sizerEl || !vList.contentEl) return;
            
            // Preparamos la vista para la carga
            listContainer.classList.remove('hidden');
            emptyEl.classList.add('hidden');
            
            // Reseteo completo del estado de la lista y la paginación
            lastVisibleMovementDoc = null;
            allMovementsLoaded = false;
            isLoadingMoreMovements = false;
            runningBalancesCache = null; // Importantísimo para recalcular saldos correctamente
			db.movimientos = [];
            vList.items = [];
            vList.itemMap = [];
            vList.sizerEl.style.height = '0px';
            vList.contentEl.innerHTML = '<div class="skeleton" style="height: 300px; width: 100%;"></div>'; // Mostramos un esqueleto mientras carga

            // Iniciamos la carga del primer bloque de datos
            await loadMoreMovements(true);
        };

        const filterMovementsByLedger = (movements) => {
            const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
            if (visibleAccountIds.size === 0) return [];
            
            return movements.filter(m => {
                if (m.tipo === 'traspaso') {
                    return visibleAccountIds.has(m.cuentaOrigenId) || visibleAccountIds.has(m.cuentaDestinoId);
                } else {
                    return visibleAccountIds.has(m.cuentaId);
                }
            });
        };

        	async function fetchMovementsPage(startAfterDoc = null) {
            if (!currentUser) return [];
            try {
                let query = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
                    .orderBy('fecha', 'desc').orderBy(firebase.firestore.FieldPath.documentId(), 'desc');

                if (startAfterDoc) {
                    query = query.startAfter(startAfterDoc);
                }

                query = query.limit(MOVEMENTS_PAGE_SIZE);
                const snapshot = await query.get();

                if (snapshot.empty) {
                    allMovementsLoaded = true;
                    return [];
                }

                lastVisibleMovementDoc = snapshot.docs[snapshot.docs.length - 1];

                if (snapshot.docs.length < MOVEMENTS_PAGE_SIZE) {
                    allMovementsLoaded = true;
                }
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            } catch (error) {
                console.error("Error al obtener los movimientos:", error);
                showToast("Error al cargar los movimientos.", "danger");
                return [];
            }
        }
const loadMoreMovements = async (isInitial = false) => {
    if (isLoadingMoreMovements || allMovementsLoaded) return;

    isLoadingMoreMovements = true;
    const loader = select('list-loader');
    if (loader) loader.classList.remove('hidden');

    try {
        // Obtenemos las cuentas visibles para filtrar
        const visibleAccountIds = getVisibleAccounts().map(c => c.id);
        if (visibleAccountIds.length === 0 && isInitial) {
            allMovementsLoaded = true;
            updateVirtualList([]); // Llama a la actualización con una lista vacía
            return;
        }

        let newMovementsChunk = [];
        
        // Si es la carga inicial, primero buscamos los recurrentes pendientes
        if (isInitial) {
            const now = new Date();
            const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            const pendingRecurrents = (db.recurrentes || [])
                .filter(r => {
                    const nextDate = parseDateStringAsUTC(r.nextDate);
                    return nextDate && new Date(Date.UTC(nextDate.getUTCFullYear(), nextDate.getUTCMonth(), nextDate.getUTCDate())) <= today;
                })
                .sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));
            
            // Si hay pendientes, los añadimos como los primeros items a mostrar
            if (pendingRecurrents.length > 0) {
                newMovementsChunk.push({ type: 'pending-header', count: pendingRecurrents.length });
                pendingRecurrents.forEach(recurrent => {
                    newMovementsChunk.push({ type: 'pending-item', recurrent: recurrent });
                });
            }
        }

        // Ahora, procedemos a buscar el historial de movimientos en Firestore
        let fetchedFilteredCount = 0;
        let processedHistoricalMovements = [];

        // Hacemos bucles de búsqueda hasta tener suficientes movimientos del historial o hasta que no haya más
        while (fetchedFilteredCount < MOVEMENTS_PAGE_SIZE && !allMovementsLoaded) {
            const rawMovsFromDB = await fetchMovementsPage(lastVisibleMovementDoc);
            if (rawMovsFromDB.length === 0) break;

            const filteredBatch = filterMovementsByLedger(rawMovsFromDB);
            processedHistoricalMovements.push(...filteredBatch);
            fetchedFilteredCount += filteredBatch.length;
        }

        // Si hemos obtenido movimientos del historial, los añadimos a nuestro caché global
        if (processedHistoricalMovements.length > 0) {
            await processMovementsForRunningBalance(processedHistoricalMovements, isInitial);
            db.movimientos = [...db.movimientos, ...processedHistoricalMovements];
        }
        
        // Finalmente, llamamos a updateVirtualList una sola vez para que renderice todo en el orden correcto
        updateVirtualList(db.movimientos);

    } catch (error) {
        console.error("Error al cargar más movimientos:", error);
        showToast("No se pudieron cargar más movimientos.", "danger");
    } finally {
        isLoadingMoreMovements = false;
        if (loader) loader.classList.add('hidden');
    }
};
           
        const updateVirtualList = (historicalMovements) => {
            if (!vList.sizerEl) return;
            
            vList.items = [];
            vList.itemMap = [];
            let currentHeight = 0;

            // --- Lógica Centralizada de Construcción de Lista ---

            // 1. Añadir los recurrentes pendientes (si existen)
            const now = new Date();
            const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            const pendingRecurrents = (db.recurrentes || []).filter(r => {
                const nextDate = parseDateStringAsUTC(r.nextDate);
                return nextDate && new Date(Date.UTC(nextDate.getUTCFullYear(), nextDate.getUTCMonth(), nextDate.getUTCDate())) <= today;
            }).sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));

            if (pendingRecurrents.length > 0) {
                vList.items.push({ type: 'pending-header', count: pendingRecurrents.length });
                vList.itemMap.push({ height: vList.heights.pendingHeader, offset: currentHeight });
                currentHeight += vList.heights.pendingHeader;
                pendingRecurrents.forEach(recurrent => {
                    vList.items.push({ type: 'pending-item', recurrent: recurrent });
                    vList.itemMap.push({ height: vList.heights.pendingItem, offset: currentHeight });
                    currentHeight += vList.heights.pendingItem;
                });
            }

            // 2. Agrupar y añadir el historial de movimientos
            const grouped = {};
            (historicalMovements || []).forEach(mov => {
                // ... (la lógica de agrupación no cambia, puedes copiarla de tu versión anterior)
                const dateKey = mov.fecha.slice(0, 10);
                if (!grouped[dateKey]) grouped[dateKey] = { movements: [], total: 0 };
                grouped[dateKey].movements.push(mov);
                const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
                if (mov.tipo === 'traspaso') {
                    if (visibleAccountIds.has(mov.cuentaOrigenId) && !visibleAccountIds.has(mov.cuentaDestinoId)) grouped[dateKey].total -= mov.cantidad;
                    else if (!visibleAccountIds.has(mov.cuentaOrigenId) && visibleAccountIds.has(mov.cuentaDestinoId)) grouped[dateKey].total += mov.cantidad;
                } else {
                    grouped[dateKey].total += mov.cantidad;
                }
            });

            const sortedDates = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
            for (const dateKey of sortedDates) {
                const group = grouped[dateKey];
                vList.items.push({ type: 'date-header', date: dateKey, total: group.total });
                vList.itemMap.push({ height: vList.heights.header, offset: currentHeight });
                currentHeight += vList.heights.header;
                for (const mov of group.movements) {
                    const itemHeight = mov.tipo === 'traspaso' ? vList.heights.transfer : vList.heights.transaction;
                    vList.items.push({ type: 'transaction', movement: mov });
                    vList.itemMap.push({ height: itemHeight, offset: currentHeight });
                    currentHeight += itemHeight;
                }
            }
            
            // 3. Renderizar y actualizar
            vList.sizerEl.style.height = `${currentHeight}px`;
            vList.lastRenderedRange = { start: -1, end: -1 };
            renderVisibleItems();

            // Si al final de todo no hay NADA que mostrar, enseñamos el estado vacío
            if (vList.items.length === 0) {
                select('movimientos-list-container')?.classList.add('hidden');
                select('empty-movimientos')?.classList.remove('hidden');
            } else {
                select('movimientos-list-container')?.classList.remove('hidden');
                select('empty-movimientos')?.classList.add('hidden');
            }
            
            buildIntelligentIndex(historicalMovements);
        };
		const getYearProgress = () => {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 0);
    const diff = now - start;
    const oneDay = 1000 * 60 * 60 * 24;
    const dayOfYear = Math.floor(diff / oneDay);
    const year = now.getFullYear();
    const isLeap = (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
    const totalDaysInYear = isLeap ? 366 : 365;

    return {
        percentage: (dayOfYear / totalDaysInYear) * 100,
        daysPassed: dayOfYear,
        daysRemaining: totalDaysInYear - dayOfYear,
        totalDaysInYear: totalDaysInYear
    };
};

const renderGaugeChart = (canvasId, percentageConsumed, yearProgressPercentage) => {
    const canvas = select(canvasId);
    const ctx = canvas ? canvas.getContext('2d') : null;
    if (!ctx) return;

    if (Chart.getChart(canvasId)) {
        Chart.getChart(canvasId).destroy();
    }

    const isAheadOfPace = percentageConsumed > yearProgressPercentage;
    
    const spentColor = isAheadOfPace ? 'var(--c-danger)' : 'var(--c-primary)';
    const remainingColor = 'var(--c-surface-variant)';

    const data = {
        datasets: [{
            data: [
                Math.min(percentageConsumed, 100),
                Math.max(0, 100 - Math.min(percentageConsumed, 100))
            ],
            backgroundColor: [spentColor, remainingColor],
            borderColor: 'var(--c-surface)',
            borderWidth: 2,
        }]
    };
    
    const paceLinePlugin = {
        id: 'paceLine',
        afterDraw: chart => {
            const { ctx, chartArea } = chart;
            const angle = Math.PI + (Math.PI * yearProgressPercentage / 100);
            const cx = (chartArea.left + chartArea.right) / 2;
            const cy = (chartArea.top + chartArea.bottom) / 2 + 15;
            const radius = chart.outerRadius;

            ctx.save();
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + radius * Math.sin(angle), cy + radius * Math.cos(angle));
            ctx.strokeStyle = 'var(--c-success)';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.restore();
        }
    };

    new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            rotation: -90,
            circumference: 180,
            cutout: '70%',
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
                datalabels: { display: false }
            }
        },
        plugins: [paceLinePlugin]
    });
};

const renderBudgetTrendChart = (monthlyIncomeData, monthlyExpenseData, averageBudgetedExpense) => {
    const canvasId = 'budget-trend-chart';
    const canvas = select(canvasId);
    const ctx = canvas ? canvas.getContext('2d') : null;
    if (!ctx) return;

    if (budgetTrendChart) {
        budgetTrendChart.destroy();
    }

    const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const incomeData = labels.map((_, i) => (monthlyIncomeData[i] || 0) / 100);
    const expenseData = labels.map((_, i) => (monthlyExpenseData[i] || 0) / 100);
    
    const colorSuccess = getComputedStyle(document.body).getPropertyValue('--c-success').trim();
    const colorDanger = getComputedStyle(document.body).getPropertyValue('--c-danger').trim();
    const colorWarning = getComputedStyle(document.body).getPropertyValue('--c-warning').trim();

    budgetTrendChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Ingresos Mensuales',
                    data: incomeData,
                    backgroundColor: colorSuccess, 
                    borderRadius: 4,
                    order: 2
                },
                {
                    label: 'Gastos Mensuales',
                    data: expenseData,
                    backgroundColor: colorDanger, 
                    borderRadius: 4,
                    order: 3
                },
                {
                    type: 'line',
                    label: 'Promedio Gasto Presupuestado',
                    data: Array(12).fill(averageBudgetedExpense / 100),
                    borderColor: colorWarning,
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    order: 1,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
        y: { beginAtZero: true, ticks: { callback: value => `€${value}` } },
        x: { grid: { display: false } }
    },
    plugins: {
        legend: { position: 'top' },
        tooltip: { mode: 'index', intersect: false },
        datalabels: { display: false }
    },
    // === ¡APLICAMOS EL MISMO PATRÓN DE DRILL-DOWN! ===
    onClick: async (event, elements) => {
        if (elements.length === 0) return;
        
        const monthIndex = elements[0].index;
        const monthName = labels[monthIndex];
        const year = parseInt(select('budget-year-selector').value, 10);
        
        // Obtener todos los movimientos del año seleccionado para poder filtrarlos
        const startDate = new Date(year, 0, 1);
        const endDate = new Date(year, 11, 31, 23, 59, 59, 999);
        const visibleAccountIds = getVisibleAccounts().map(c => c.id);
        const baseQuery = fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
                                .where('fecha', '>=', startDate.toISOString())
                                .where('fecha', '<=', endDate.toISOString())
                                .where('tipo', '==', 'movimiento');
        const movementsOfYear = await fetchMovementsInChunks(baseQuery, 'cuentaId', visibleAccountIds);

        // Filtrar los movimientos solo para el mes que se ha clicado
        const movementsOfMonth = movementsOfYear.filter(m => new Date(m.fecha).getMonth() === monthIndex);
        
        hapticFeedback('light');
        
        showDrillDownModal(`Movimientos de ${monthName} ${year}`, movementsOfMonth);
    },
    onHover: (event, chartElement) => {
        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
    }
    // ====================================================
}
    });
};

		const renderCuentas = async (targetContainerId, accountsToRender, totalPatrimonio = 0) => {
    const container = select(targetContainerId);
    if (!container) return;

    const saldos = getAllSaldos();
    const allAccounts = accountsToRender;
    const allAccountTypes = [...new Set(allAccounts.map((c) => toSentenceCase(c.tipo || 'S/T')))];

    const filteredAccountTypes = new Set(allAccountTypes.filter(t => !deselectedAccountTypesFilter.has(t)));

    const accountsByType = allAccounts.reduce((acc, c) => {
        const tipo = toSentenceCase(c.tipo || 'S/T');
        if (!acc[tipo]) acc[tipo] = [];
        acc[tipo].push(c);
        return acc;
    }, {});
    
    const resumenHTML = Object.keys(accountsByType).sort().map(tipo => {
        if (!filteredAccountTypes.has(tipo)) return '';
        
        const accountsInType = accountsByType[tipo];
        const typeBalance = accountsInType.reduce((sum, account) => sum + (saldos[account.id] || 0), 0);
        
        const porcentajeGlobal = totalPatrimonio > 0 ? (typeBalance / totalPatrimonio) * 100 : 0;

        const accountsHtml = accountsInType.sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => {
            const balance = saldos[c.id] || 0;
            const porcentajeGrupo = typeBalance !== 0 ? (balance / typeBalance) * 100 : 0;
            const investmentIcon = c.esInversion ? `<span class="material-icons text-info" style="font-size: 14px; margin-left: var(--sp-2);" title="Cuenta de Portafolio">trending_up</span>` : '';
            
            return `
                <div class="modal__list-item" data-action="view-account-details" data-id="${c.id}" style="cursor: pointer; padding-left: 0; padding-right: 0;">
                    <div>
                        <span style="display: block; font-weight: 500;">${c.nombre}</span>
                       <small style="color: var(--c-on-surface-secondary); font-weight: 500;">${porcentajeGrupo.toFixed(1)}% del total de ${tipo}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--sp-2);">${formatCurrency(balance)}${investmentIcon}<span class="material-icons" style="font-size: 18px; color: var(--c-on-surface-secondary);">chevron_right</span></div>
                </div>`;
        }).join('');
        
        if (!accountsHtml) return '';
        
        const icon = tipo==='EFECTIVO'?'payments':(tipo.includes('TARJETA')?'credit_card':(tipo==='AHORRO'?'savings':(tipo==='INVERSIÓN'?'trending_up':(tipo==='PROPIEDAD'?'domain':(tipo==='PRÉSTAMO'?'credit_score':'account_balance')))));
        
        return `
            <details class="accordion">
                <summary>
                    <span class="account-group__name"><span class="material-icons" style="vertical-align:bottom;font-size:16px;margin-right:8px">${icon}</span>${tipo}</span>
                    <div style="display:flex; align-items:center; gap:var(--sp-2);">
                        <small style="color: var(--c-on-surface-tertiary); font-weight: 600; margin-right: var(--sp-2);">${porcentajeGlobal.toFixed(1)}%</small>
                        <span class="account-group__balance">${formatCurrency(typeBalance)}</span>
                        <span class="material-icons accordion__icon">expand_more</span>
                    </div>
                </summary>
                <div class="accordion__content">${accountsHtml}</div>
            </details>`;
    }).join('');

    container.innerHTML = `<div class="accordion-wrapper">${resumenHTML}</div>`;
};
                
        
        const loadConfig = () => { 
            (select('config-skip-intro')).checked = !!(db.config && db.config.skipIntro);
            const userEmailEl = select('config-user-email'); 
            if (userEmailEl && currentUser) userEmailEl.textContent = currentUser.email;
            
            			
        };
    const renderInicioPage = () => {
    const container = select(PAGE_IDS.INICIO);
    if (!container) return;

    if (conceptosChart) {
        conceptosChart.destroy();
        conceptosChart = null;
    }

    container.innerHTML = `
        <div class="card card--no-bg" id="dashboard-filters-widget">
            <div class="accordion-wrapper">
                <details class="accordion" open> <!-- <<<<<<<<<<<<<<< CAMBIO AQUÍ -->
                    <summary>
                        <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">filter_list</span>Filtros del Panel</h3>
                        <span class="material-icons accordion__icon">expand_more</span>
                    </summary>
                    <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                        <div class="form-group">
                            <label for="filter-periodo" class="form-label">Periodo</label>
                            <select id="filter-periodo" class="form-select">
                                <option value="mes-actual" selected>Este Mes</option>
                                <option value="año-actual">Este Año</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div id="custom-date-filters" class="form-grid hidden" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="filter-fecha-inicio" class="form-label">Desde</label>
                                <input type="date" id="filter-fecha-inicio" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="filter-fecha-fin" class="form-label">Hasta</label>
                                <input type="date" id="filter-fecha-fin" class="form-input">
                            </div>
                        </div>
                        <button data-action="apply-filters" class="btn btn--primary btn--full">Aplicar Filtros</button>
                    </div>
                </details>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin: var(--sp-4) 0 var(--sp-2) 0;">
            <h3 style="color: var(--c-on-surface-secondary); font-size: var(--fs-base); font-weight: 700;">Resumen del Panel</h3>
            <button data-action="configure-dashboard" class="icon-btn" title="Personalizar Panel">
                <span class="material-icons">dashboard_customize</span>
            </button>
        </div>

        <div id="resumen-content-container">
            <!-- El contenido se renderizará aquí vía JS -->
        </div>
    `;
    
    populateAllDropdowns();
    
    const filterPeriodo = select('filter-periodo');
    if (filterPeriodo) filterPeriodo.dispatchEvent(new Event('change')); 
    renderInicioResumenView();
};
   // PEGA este bloque de código junto a tus otras funciones de renderizado (ej. renderDashboardKpiSummary)

/**
 * Renderiza el esqueleto del nuevo widget "Centro de Acciones".
 */
const renderDashboardActionCenter = () => {
    return `
    <div class="card" id="action-center-widget">
        <h3 class="card__title">
            <span class="material-icons text-warning">notifications_active</span>
            <span>Centro de Acciones</span>
        </h3>
        <div class="card__content" id="action-center-content" style="padding-top: 0; padding-bottom: var(--sp-2);">
            <div class="skeleton" style="height: 70px; border-radius: var(--border-radius-md);"></div>
        </div>
    </div>`;
};

/**
 * Renderiza el esqueleto del nuevo widget "Evolución del Patrimonio".
 */
const renderDashboardNetWorthTrend = () => {
    return `
    <div class="card" id="net-worth-trend-widget">
        <h3 class="card__title"><span class="material-icons">show_chart</span>Evolución del Patrimonio Neto</h3>
        <div class="card__content">
            <div class="chart-container skeleton" style="height: 220px; border-radius: var(--border-radius-lg);">
                <canvas id="net-worth-chart"></canvas>
            </div>
        </div>
    </div>`;
};


/**
 * Dibuja un gráfico de tipo "gauge" (velocímetro) para la Tasa de Ahorro.
 * @param {string} canvasId - El ID del elemento canvas.
 * @param {number} percentage - El porcentaje de ahorro a mostrar.
 */
const renderSavingsRateGauge = (canvasId, percentage) => {
    const canvas = select(canvasId);
    const ctx = canvas ? canvas.getContext('2d') : null;
    if (!ctx) return;

    if (Chart.getChart(canvasId)) {
        Chart.getChart(canvasId).destroy();
    }

    let color;
    if (percentage < 0) color = 'var(--c-danger)';
    else if (percentage < 10) color = 'var(--c-warning)';
    else color = 'var(--c-success)';
    
    const value = Math.max(0, Math.min(100, percentage)); // Aseguramos que el valor esté entre 0 y 100 para el gráfico

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [value, 100 - value],
                backgroundColor: [getComputedStyle(document.body).getPropertyValue(color).trim(), getComputedStyle(document.body).getPropertyValue('--c-surface-variant').trim()],
                borderColor: 'transparent',
                borderWidth: 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            rotation: -90,
            circumference: 180,
            cutout: '65%',
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
                datalabels: { display: false }
            }
        }
    });
};

const renderDashboardKpiSummary = () => {
    // 1. Cambiamos el grid para que tenga 3 columnas
   return `<div class="kpi-grid" id="kpi-container" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="kpi-item">
                <h4 class="kpi-item__label">Ingresos</h4>
                <strong id="kpi-ingresos-value" class="kpi-item__value text-positive skeleton" data-current-value="0">+0,00 €</strong> 
                <div id="kpi-ingresos-comparison" class="kpi-item__comparison"></div>
            </div>
            <div class="kpi-item">
                <h4 class="kpi-item__label">Gastos</h4>
                <strong id="kpi-gastos-value" class="kpi-item__value text-negative skeleton" data-current-value="0">0,00 €</strong>
                <div id="kpi-gastos-comparison" class="kpi-item__comparison"></div>
            </div>
            <!-- 2. El Saldo Neto ahora es un item normal, sin estilos extra que lo hagan ocupar toda la fila -->
            <div class="kpi-item">
                <h4 class="kpi-item__label">Saldo Neto Periodo</h4>
                <strong id="kpi-saldo-neto-value" class="kpi-item__value skeleton" data-current-value="0">0,00 €</strong>
                <div id="kpi-saldo-neto-comparison" class="kpi-item__comparison"></div>
            </div>
        </div>`;
};
const renderDashboardExpandedKpiSummary = () => {
    return `
    <div class="card" id="kpi-ampliado-widget">
        <h3 class="card__title"><span class="material-icons">query_stats</span>Centro de Operaciones</h3>
        <div class="card__content">
            <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                
                <!-- === ELEMENTO ELIMINADO: Saldo Neto Periodo ya no está aquí === -->

                <div class="kpi-item">
                    <h4 class="kpi-item__label">Tasa de Ahorro</h4>
                    <div style="position: relative; height: 60px; margin: auto;">
                         <canvas id="kpi-savings-rate-chart"></canvas>
                         <div id="kpi-tasa-ahorro-value" class="kpi-item__value skeleton" style="position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);">0%</div>
                    </div>
                    <div id="kpi-tasa-ahorro-comparison" class="kpi-item__comparison"></div>
                </div>

                <div class="kpi-item">
                    <h4 class="kpi-item__label">Patrimonio Neto Total</h4>
                    <strong id="kpi-patrimonio-neto-value" class="kpi-item__value skeleton" data-current-value="0">0,00 €</strong>
                    <div class="kpi-item__comparison">Vista global actual</div>
                </div>
                
                <div class="kpi-item">
                    <h4 class="kpi-item__label">P&L Inversión Periodo</h4>
                    <strong id="kpi-pnl-inversion-value" class="kpi-item__value skeleton" data-current-value="0">0,00 €</strong>
                    <div id="kpi-pnl-inversion-comparison" class="kpi-item__comparison">Flujo de caja neto</div>
                </div>

                <div class="kpi-item" style="grid-column: 1 / -1;">
                    <h4 class="kpi-item__label">Progreso Presupuesto (Gastos del Periodo)</h4>
                    <div class="budget-item__progress" style="margin: 8px 0;">
                        <progress id="kpi-presupuesto-progress" max="100" value="0" style="width: 100%; height: 8px;" class="budget-item__progress"></progress>
                    </div>
                    <div id="kpi-presupuesto-text" class="kpi-item__comparison skeleton" style="height: auto; min-height: 14px;">Calculando...</div>
                </div>

            </div>
        </div>
    </div>`;
};
		
                const renderDashboardConceptTotals = () => {
            // Generamos 3 filas de esqueleto para la lista
            const skeletonRows = Array(3).fill('<div class="skeleton" style="height: 48px; margin-bottom: var(--sp-2); border-radius: 8px;"></div>').join('');
            
            return `
                <div class="card card--no-bg" id="concept-totals-widget">
                    <div class="accordion-wrapper">
                        <details class="accordion" open>
                            <summary>
                                <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">category</span>Totales por Concepto</h3>
                                <span class="material-icons accordion__icon">expand_more</span>
                            </summary>
                            <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                                <div class="chart-container skeleton" style="height: 240px; margin-bottom: var(--sp-2); border-radius: var(--border-radius-lg);">
                                    <canvas id="conceptos-chart"></canvas>
                                </div>
                                <div id="concepto-totals-list">${skeletonRows}</div>
                            </div>
                        </details>
                    </div>
                </div>`;
        };
    const renderInicioResumenView = () => {
    const resumenContentContainer = select('resumen-content-container');
    if (!resumenContentContainer) return;

    const widgetOrder = (db.config && db.config.dashboardWidgets) || DEFAULT_DASHBOARD_WIDGETS;

    resumenContentContainer.innerHTML = widgetOrder.map(widgetId => {
        switch(widgetId) {
            case 'action-center': // <-- NUEVO
                return renderDashboardActionCenter();
            case 'kpi-summary-expanded':
                return renderDashboardExpandedKpiSummary();
            case 'net-worth-trend': // <-- NUEVO
                return renderDashboardNetWorthTrend();
            case 'kpi-summary':
                return renderDashboardKpiSummary(); 
            case 'concept-totals':
                return renderDashboardConceptTotals();
            case 'informe-personalizado':
                return renderDashboardInformeWidget();
            default:
                return '';
        }
    }).join('<div style="height: var(--sp-4);"></div>');
    
    updateDashboardData();
};
		
        const _renderRecientesFromCache = async () => {
            const recientesContainer = select('inicio-view-recientes');
            if (!recientesContainer) return;
            
            const movsToDisplay = recentMovementsCache;
            
            if (movsToDisplay.length === 0) {
                recientesContainer.innerHTML = `<div class="empty-state" style="border: none; background: transparent;"><p>No hay movimientos recientes en esta contabilidad.</p></div>`;
                return;
            }

            await processMovementsForRunningBalance(movsToDisplay, true); 

            const grouped = {};
            const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
            movsToDisplay.forEach(mov => {
                const dateKey = mov.fecha.slice(0, 10);
                if (!grouped[dateKey]) {
                    grouped[dateKey] = { movements: [], total: 0 };
                }
                grouped[dateKey].movements.push(mov);
                if (mov.tipo === 'traspaso') {
                    const origenVisible = visibleAccountIds.has(mov.cuentaOrigenId);
                    const destinoVisible = visibleAccountIds.has(mov.cuentaDestinoId);
                    if (origenVisible && !destinoVisible) { grouped[dateKey].total -= mov.cantidad; }
                    else if (!origenVisible && destinoVisible) { grouped[dateKey].total += mov.cantidad; }
                } else {
                    grouped[dateKey].total += mov.cantidad;
                }
            });

            let html = '';
            const sortedDates = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
            for (const dateKey of sortedDates) {
                const group = grouped[dateKey];
                html += renderVirtualListItem({ type: 'date-header', date: dateKey, total: group.total });
                
                group.movements.sort((a, b) => b.id.localeCompare(a.id));

                for (const mov of group.movements) {
                    html += renderVirtualListItem({ type: 'transaction', movement: mov });
                }
            }
            html += `<div style="text-align: center; margin-top: var(--sp-4);"><button class="btn btn--secondary" data-action="navigate" data-page="${PAGE_IDS.MOVIMIENTOS}">Ver todos los movimientos</button></div>`;
            recientesContainer.innerHTML = html;
        };
		 const renderPendingRecurrents = () => {
            const container = select('pending-recurrents-container');
            if (!container || !db.recurrentes) return;

            const now = new Date();
            const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            
            const pending = db.recurrentes
            .filter(r => {
                const nextDate = parseDateStringAsUTC(r.nextDate);
                const normalizedNextDate = new Date(Date.UTC(nextDate.getUTCFullYear(), nextDate.getUTCMonth(), nextDate.getUTCDate()));
                return normalizedNextDate <= today;
            })
            .sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));

            if (pending.length === 0) {
                container.innerHTML = '';
                return;
            }

            const itemsHTML = pending.map(r => {
                const nextDate = new Date(r.nextDate + 'T12:00:00Z');
                const formattedDate = nextDate.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                const amountClass = r.cantidad >= 0 ? 'text-positive' : 'text-negative';
                const dateText = `Pendiente desde: ${formattedDate}`;

                return `
                <div class="transaction-card" id="pending-recurrente-${r.id}" style="background-color: color-mix(in srgb, var(--c-warning) 10%, transparent);">
                    <div class="transaction-card__indicator transaction-card__indicator--recurrent"></div>
                    <div class="transaction-card__content">
                        <div class="transaction-card__details">
                            <div class="transaction-card__row-1">${escapeHTML(r.descripcion)}</div>
                            <div class="transaction-card__row-2" style="font-weight: 600; color: var(--c-warning);">${dateText}</div>
                        </div>
                        <div class="transaction-card__figures" style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
							<strong class="transaction-card__amount ${amountClass}">${formatCurrency(r.cantidad)}</strong>
						<div style="display: flex; align-items: center; gap: 8px;">
							<button class="btn btn--secondary" data-action="skip-recurrent" data-id="${r.id}" title="Omitir esta vez" style="padding: 4px 8px; font-size: 0.7rem;">
							<span class="material-icons" style="font-size: 14px;">skip_next</span>No añadir
							</button>
							<button class="btn btn--primary" data-action="confirm-recurrent" data-id="${r.id}" title="Crear el movimiento ahora" style="padding: 4px 8px; font-size: 0.7rem;">
							<span class="material-icons" style="font-size: 14px;">check</span>Añadir Ahora
							</button>
						</div>
                    </div>
                </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="card card--no-bg accordion-wrapper" style="margin-top: var(--sp-4);">
                    <details class="accordion" open>
                        <summary>
                            <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">event_repeat</span>
                                Operaciones Recurrentes Pendientes
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: 0 var(--sp-2) var(--sp-2) var(--sp-2);">${itemsHTML}</div>
                    </details>
                </div>
            `;
        };
const renderPatrimonioPage = async () => {
    const container = select(PAGE_IDS.PATRIMONIO);
    if (!container) return;

    const BASE_COLORS = ['#007AFF', '#30D158', '#FFD60A', '#FF3B30', '#C084FC', '#4ECDC4', '#EF626C', '#A8D58A'];
    const visibleAccounts = getVisibleAccounts();
    const saldos = await getSaldos();
    
    const allAccountTypes = [...new Set(visibleAccounts.map((c) => toSentenceCase(c.tipo || 'S/T')))].sort();
    const filteredAccountTypes = new Set(allAccountTypes.filter(t => !deselectedAccountTypesFilter.has(t)));

    const colorMap = {};
    allAccountTypes.forEach((tipo, index) => {
        colorMap[tipo] = BASE_COLORS[index % BASE_COLORS.length];
    });

    const filteredAccountsForChart = visibleAccounts.filter(c => {
        const tipo = toSentenceCase(c.tipo || 'S/T');
        return filteredAccountTypes.has(tipo);
    });

    const treeData = [];
    filteredAccountsForChart.forEach(c => {
        const saldo = saldos[c.id] || 0;
        if (saldo > 0) {
            treeData.push({
                tipo: toSentenceCase(c.tipo || 'S/T'),
                nombre: c.nombre,
                saldo: saldo / 100
            });
        }
    });
    
    const pillsHTML = allAccountTypes.map(t => {
        const isActive = !deselectedAccountTypesFilter.has(t);
        const color = colorMap[t];
        let style = '';
        if (isActive && color) {
            style = `style="background-color: ${color}; border-color: ${color}; color: #FFFFFF; box-shadow: 0 0 8px ${color}70;"`;
        }
        return `<button class="filter-pill ${isActive ? 'filter-pill--active' : ''}" data-action="toggle-account-type-filter" data-type="${t}" ${style}>${t}</button>`;
    }).join('') || `<p style="font-size:var(--fs-xs); color:var(--c-on-surface-secondary)">No hay cuentas en esta vista.</p>`;
    
    const totalFiltrado = filteredAccountsForChart.reduce((sum, c) => sum + (saldos[c.id] || 0), 0);
    const portfolioPerformance = await calculatePortfolioPerformance();

    container.innerHTML = `
        <div class="patrimonio-header-grid">
            <div class="patrimonio-header-grid__kpi">
                <h4 class="kpi-item__label">Patrimonio Neto (Seleccionado)</h4>
                <strong id="patrimonio-total-balance" class="kpi-item__value" style="font-size: 2rem; line-height: 1.1;"></strong>
            </div>
            <div class="patrimonio-header-grid__filters">
                 <h4 class="kpi-item__label">Filtros por tipo de cuenta</h4>
                 <div id="filter-account-types-pills" class="filter-pills" style="margin-bottom: 0;">${pillsHTML}</div>
            </div>
        </div>
        <div class="card card--no-bg accordion-wrapper">
            <div id="liquid-assets-chart-container" class="hidden" style="margin-bottom: 0;">
                 <details class="accordion" open>
                    <summary>
                        <h3 class="card__title" style="margin: 0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">data_usage</span>Estructura del Patrimonio</h3>
                        <span class="material-icons accordion__icon">expand_more</span>
                    </summary>
                    <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                        <div class="chart-container" style="height: 250px; margin-bottom: 0;">
                            <canvas id="liquid-assets-chart"></canvas>
                        </div>
                    </div>
                </details>
            </div>
        </div>
        <div class="accordion-wrapper">
            <details class="accordion" open>
                <summary><h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">account_balance_wallet</span>Cuentas</h3><span class="material-icons accordion__icon">expand_more</span></summary>
                <div class="accordion__content" style="padding: 0;" id="patrimonio-cuentas-container"></div>
            </details>
        </div>
        <div class="accordion-wrapper" style="margin-top: var(--sp-4);">
             <details class="accordion">
                <summary>
                    <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">show_chart</span>Portafolio de Inversión</h3>
                    <span class="material-icons accordion__icon">expand_more</span>
                </summary>
                <div class="accordion__content" id="patrimonio-inversiones-container" style="padding: var(--sp-3) var(--sp-4);"></div>
            </details>
        </div>
        `;
    
    animateCountUp(select('patrimonio-total-balance'), totalFiltrado);
    renderCuentas('patrimonio-cuentas-container', filteredAccountsForChart, totalFiltrado);
    renderInversionesPage('patrimonio-inversiones-container');
    
    const chartContainer = select(`liquid-assets-chart-container`);
    const chartCanvas = select(`liquid-assets-chart`);
    const chartCtx = chartCanvas ? chartCanvas.getContext('2d') : null;

    if (chartCtx && chartContainer) {
        if (liquidAssetsChart) liquidAssetsChart.destroy();
        
        if (treeData.length > 0) {
            chartContainer.classList.remove('hidden');
            liquidAssetsChart = new Chart(chartCtx, {
                type: 'treemap',
                data: {
                    datasets: [{
                        tree: treeData,
                        key: 'saldo',
                        groups: ['tipo', 'nombre'],
                        spacing: 0.5,
                        borderWidth: 1.5,
                        borderColor: getComputedStyle(document.body).getPropertyValue('--c-background'),
                        backgroundColor: (ctx) => {
                            if (ctx.type === 'data') {
                                const node = ctx.raw._data;
                                const baseColor = colorMap[node.tipo];
                                return baseColor ? `${baseColor}B3` : 'grey';
                            }
                            return 'transparent';
                        },
                        labels: {
                            display: true,
                            color: '#FFFFFF',
                            font: { size: 10, weight: '600' },
                            align: 'center',
                            position: 'middle'
                        }
                    }]
                },
                options: {
                    sunburst: true,
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const node = context.raw._data;
                                    const value = formatCurrency(context.raw.v * 100);
                                    if (node && node.nombre) {
                                        return `${node.nombre}: ${value}`;
                                    }
                                    return `${context.raw.g}: ${value}`;
                                }
                            }
                        },
                        datalabels: { display: false }
                    }
                }
            });
        } else {
            chartContainer.classList.add('hidden');
        }
    }
};

const renderPlanificacionPage = () => {
    const container = select(PAGE_IDS.PLANIFICACION);
    if(!container) return;

    container.innerHTML = `
        <div class="card card--no-bg accordion-wrapper">
            <details class="accordion">
                <summary>
                    <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">request_quote</span>Presupuestos Anuales</h3>
                    <span class="material-icons accordion__icon">expand_more</span>
                </summary>
                <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--sp-4);">
                        <div class="form-group" style="flex-grow: 1; margin: 0;">
                            <label for="budget-year-selector" class="form-label">Año del Presupuesto</label>
                            <select id="budget-year-selector" class="form-select"></select>
                        </div>
                        <button data-action="update-budgets" class="btn btn--secondary" style="margin-left: var(--sp-3);"><span class="material-icons" style="font-size: 16px;">edit_calendar</span><span>Gestionar</span></button>
                    </div>
                    <div id="annual-budget-dashboard"><div id="budget-kpi-container" class="kpi-grid"></div><div class="card" style="margin-top: var(--sp-4);"><h3 class="card__title"><span class="material-icons">trending_up</span>Tendencia Ingresos y Gastos</h3><div class="card__content"><div class="chart-container" style="height: 220px;"><canvas id="budget-trend-chart"></canvas></div></div></div><div id="budget-details-list" style="margin-top: var(--sp-4);"></div></div>
                    <div id="budget-init-placeholder" class="empty-state hidden"><span class="material-icons">edit_calendar</span><h3 id="budget-placeholder-title">Define tu Plan Financiero</h3><p id="budget-placeholder-text">Establece límites de gasto y metas de ingreso para tomar el control de tu año. ¡Empieza ahora!</p><button data-action="update-budgets" class="btn btn--primary" style="margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 16px;">add_circle_outline</span><span>Crear Presupuestos</span></button></div>
                </div>
            </details>
        </div>

        <div class="card card--no-bg accordion-wrapper">
            <details class="accordion">
                <summary>
                    <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);"><span class="material-icons">event_repeat</span>Movimientos Recurrentes</h3>
                    <span class="material-icons accordion__icon">expand_more</span>
                </summary>
                <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                    <div id="pending-recurrents-container"></div>
                    
                    <!-- === AQUÍ ESTÁ EL CAMBIO === -->
                    <!-- Eliminamos el div con el botón "Gestionar" y dejamos un texto más útil -->
                    <p class="form-label" style="margin-bottom: var(--sp-3);">
                        Pulsa en una operación para editarla. Estas son las que se ejecutarán en el futuro.
                    </p>
                    
                    <div id="recurrentes-list-container"></div>
                </div>
            </details>
        </div>
    `;
    
    const budgetYearSelect = select('budget-year-selector');
    if (budgetYearSelect) {
        const currentYear = new Date().getFullYear();
        let years = new Set([currentYear]);
        (db.presupuestos || []).forEach(p => years.add(p.ano));
        
        const currentVal = budgetYearSelect.value;
        budgetYearSelect.innerHTML = [...years].sort((a, b) => b - a).map(y => `<option value="${y}">${y}</option>`).join('');
        
        if (currentVal && [...years].some(y => y == parseInt(currentVal))) {
            budgetYearSelect.value = currentVal;
        } else {
            budgetYearSelect.value = String(currentYear);
        }
        
        budgetYearSelect.addEventListener('change', renderBudgetTracking);
    }
    
    populateAllDropdowns();
    renderBudgetTracking();
    renderPendingRecurrents();
    renderRecurrentsListOnPage();
};

// =============================================================
// === PASO 1: REEMPLAZO DE renderRecurrentsListOnPage       ===
// =============================================================
const renderRecurrentsListOnPage = () => {
    const container = select('recurrentes-list-container');
    if (!container) return;

    const now = new Date();
    const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));

    const upcomingRecurrents = (db.recurrentes || [])
        .filter(r => {
            const nextDate = parseDateStringAsUTC(r.nextDate);
            const normalizedNextDate = new Date(Date.UTC(nextDate.getUTCFullYear(), nextDate.getUTCMonth(), nextDate.getUTCDate()));
            return normalizedNextDate > today;
        })
        .sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));

    if (upcomingRecurrents.length === 0) {
        container.innerHTML = `<div class="empty-state" style="background: transparent; border: none; padding-top: var(--sp-2);"><p>No tienes operaciones programadas a futuro.</p></div>`;
        return;
    }

    container.innerHTML = upcomingRecurrents.map(r => {
        const nextDate = new Date(r.nextDate).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
        const frequencyMap = { daily: 'Diaria', weekly: 'Semanal', monthly: 'Mensual', yearly: 'Anual' };
        const amountClass = r.cantidad >= 0 ? 'text-positive' : 'text-negative';
        const icon = r.cantidad >= 0 ? 'south_west' : 'north_east';
        
        // === LA MAGIA ESTÁ AQUÍ ===
        // Añadimos data-action, data-id y cursor: pointer al div principal del item.
        return `
        <div class="modal__list-item" id="page-recurrente-item-${r.id}" data-action="edit-recurrente" data-id="${r.id}" style="cursor: pointer;">
            <div style="display: flex; align-items: center; gap: 12px; flex-grow: 1; min-width: 0;">
                <span class="material-icons ${amountClass}" style="font-size: 20px;">${icon}</span>
                <div style="display: flex; flex-direction: column; min-width: 0;">
                    <span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(r.descripcion)}</span>
                    <small style="color: var(--c-on-surface-secondary); font-size: var(--fs-xs);">Próximo: ${nextDate} (${frequencyMap[r.frequency]})</small>
                </div>
            </div>
            <strong class="${amountClass}" style="margin-right: var(--sp-2);">${formatCurrency(r.cantidad)}</strong>
        </div>`;
    }).join('');
};

// Define los colores para cada componente del patrimonio
const NET_WORTH_COMPONENT_COLORS = {
    'Líquido': 'rgba(0, 122, 255, 0.7)',      // Azul (var(--c-primary))
    'Inversión': 'rgba(48, 209, 88, 0.7)',   // Verde (var(--c-success))
    'Propiedades': 'rgba(191, 90, 242, 0.7)', // Púrpura (var(--c-info))
    'Deuda': 'rgba(255, 69, 58, 0.7)'         // Rojo (var(--c-danger))
};

/**
 * Clasifica un tipo de cuenta en una de las categorías principales del patrimonio.
 * @param {string} accountType - El tipo de cuenta (ej. "Banco", "Broker").
 * @returns {string} La categoría del componente ('Líquido', 'Inversión', 'Propiedades', 'Deuda').
 */
const getNetWorthComponent = (accountType) => {
    const type = (accountType || '').toUpperCase();
    if (['PRÉSTAMO', 'TARJETA DE CRÉDITO'].includes(type)) return 'Deuda';
    if (['PROPIEDAD', 'INMOBILIARIO'].includes(type)) return 'Propiedades';
    if (['BROKER', 'FONDOS', 'RENTA FIJA', 'PENSIÓN', 'CRIPTO', 'FINTECH'].includes(type) || type.includes('INVERSIÓN')) return 'Inversión';
    return 'Líquido'; // Por defecto, todo lo demás es líquido (Banco, Ahorro, Efectivo, etc.)
};

/**
 * Suaviza los datos diarios a puntos semanales para un gráfico más limpio y rápido.
 * @param {object} dailyData - Objeto con datos diarios.
 * @returns {object} Objeto con datos semanales.
 */
const resampleDataWeekly = (dailyData) => {
    const weeklyData = {};
    const sortedDates = Object.keys(dailyData).sort();

    if (sortedDates.length === 0) return {};

    let lastDate = null;
    sortedDates.forEach(dateStr => {
        const date = new Date(dateStr);
        // Usamos el domingo (día 0) como fin de la semana
        const weekEnd = new Date(date);
        weekEnd.setDate(date.getDate() - date.getDay() + 7);
        const weekKey = weekEnd.toISOString().slice(0, 10);
        
        // Guardamos el último valor registrado de la semana
        weeklyData[weekKey] = dailyData[dateStr];
        lastDate = dateStr;
    });

    // Aseguramos que el último punto de datos siempre esté presente
    const lastWeekKey = new Date(new Date(lastDate).setDate(new Date(lastDate).getDate() - new Date(lastDate).getDay() + 7)).toISOString().slice(0,10);
    weeklyData[lastWeekKey] = dailyData[lastDate];
    
    return weeklyData;
};

const updateNetWorthChart = async (saldos) => {
    const netWorthCanvas = select('net-worth-chart');
    if (!netWorthCanvas) return;

    const chartContainer = netWorthCanvas.closest('.chart-container');
    if (netWorthChart) netWorthChart.destroy();

    const allMovements = await fetchAllMovementsForHistory();
    const visibleAccountIds = new Set(Object.keys(saldos));
    const cuentas = db.cuentas.filter(c => visibleAccountIds.has(c.id));

    if (allMovements.length === 0 && cuentas.length === 0) {
        if(chartContainer) {
            chartContainer.classList.remove('skeleton');
            chartContainer.innerHTML = `<div class="empty-state" style="padding:16px 0; background:transparent; border:none;"><p>Aún no hay datos para mostrar la evolución.</p></div>`;
        }
        return;
    }

    // 1. Calcular los totales actuales por componente
    const currentComponentTotals = { 'Líquido': 0, 'Inversión': 0, 'Propiedades': 0, 'Deuda': 0 };
    cuentas.forEach(c => {
        const component = getNetWorthComponent(c.tipo);
        const balance = c.saldo || 0;
        if (component === 'Deuda') {
            currentComponentTotals.Deuda += Math.abs(balance); // La deuda se suma como un valor positivo para el apilado
        } else {
            currentComponentTotals[component] += balance;
        }
    });

    // 2. Calcular hacia atrás
    let runningComponentTotals = { ...currentComponentTotals };
    const dailyData = {};
    const todayKey = new Date().toISOString().slice(0, 10);
    dailyData[todayKey] = { ...runningComponentTotals };

    const sortedMovements = allMovements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    for (const mov of sortedMovements) {
        let componentChange = null;
        let changeAmount = 0;

        if (mov.tipo === 'movimiento') {
            const cuenta = cuentas.find(c => c.id === mov.cuentaId);
            if (cuenta) {
                componentChange = getNetWorthComponent(cuenta.tipo);
                changeAmount = mov.cantidad;
            }
        } else if (mov.tipo === 'traspaso') {
            const origen = cuentas.find(c => c.id === mov.cuentaOrigenId);
            const destino = cuentas.find(c => c.id === mov.cuentaDestinoId);
            const origenComp = origen ? getNetWorthComponent(origen.tipo) : null;
            const destinoComp = destino ? getNetWorthComponent(destino.tipo) : null;

            if (origen && !destino) { // Dinero que sale del ecosistema
                componentChange = origenComp;
                changeAmount = -mov.cantidad;
            } else if (!origen && destino) { // Dinero que entra al ecosistema
                componentChange = destinoComp;
                changeAmount = mov.cantidad;
            } else if (origen && destino && origenComp !== destinoComp) {
                // Traspaso entre componentes (ej. de Líquido a Inversión)
                // Revertimos la operación:
                runningComponentTotals[origenComp] += origenComp === 'Deuda' ? -mov.cantidad : mov.cantidad;
                runningComponentTotals[destinoComp] += destinoComp === 'Deuda' ? mov.cantidad : -mov.cantidad;
            }
        }
        
        if (componentChange) {
            runningComponentTotals[componentChange] -= (componentChange === 'Deuda' ? -changeAmount : changeAmount);
        }
        
        const dateKey = mov.fecha.slice(0, 10);
        dailyData[dateKey] = { ...runningComponentTotals };
    }
    
    // 3. Suavizar los datos a puntos semanales
    const weeklyData = resampleDataWeekly(dailyData);
    const sortedDates = Object.keys(weeklyData).sort();

    if(chartContainer) chartContainer.classList.remove('skeleton');

    // 4. Preparar los datasets para Chart.js
    const datasets = Object.keys(NET_WORTH_COMPONENT_COLORS).map(component => ({
        label: component,
        data: sortedDates.map(date => (weeklyData[date][component] || 0) / 100),
        fill: true,
        backgroundColor: NET_WORTH_COMPONENT_COLORS[component],
        borderColor: NET_WORTH_COMPONENT_COLORS[component].replace('0.7', '1'), // Color más opaco para el borde
        pointRadius: 0,
        borderWidth: 1.5,
    }));
    
    const ctx = netWorthCanvas.getContext('2d');
    netWorthChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedDates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    stacked: true, // ¡La magia del apilado!
                    ticks: { callback: v => formatCurrency(v * 100).replace(/\s/g,'') }
                },
                x: {
                    type: 'time',
                    time: { unit: 'month', tooltipFormat: 'DD MMM YYYY', displayFormats: { month: 'MMM yy' } },
                    ticks: { autoSkip: true, maxTicksLimit: 6 },
                    grid: { display: false }
                }
            },
            plugins: {
                datalabels: { display: false },
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 15, padding: 20 }
                },
                tooltip: {
                    intersect: false,
                    mode: 'index',
                    callbacks: {
                        label: (context) => {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y;
                            return ` ${label}: ${formatCurrency(value * 100)}`;
                        },
                        // Footer para mostrar el total
                        footer: (tooltipItems) => {
                            let sum = 0;
                            tooltipItems.forEach(function(tooltipItem) {
                                sum += tooltipItem.parsed.y;
                            });
                            return `Total: ${formatCurrency(sum * 100)}`;
                        },
                    }
                }
            },
            interaction: {
                mode: 'index',
                intersect: false,
            },
        }
    });
}; // <-- HASTA AQUÍ

// =============================================================
// === REEMPLAZA TU FUNCIÓN updateDashboardData ENTERA POR ESTA ===
// =============================================================
const updateDashboardData = async () => {
    // Fase 1: Obtener todos los datos necesarios
    const { current, previous, label } = await getFilteredMovements(true);
    const saldos = await getSaldos();
    if (!dataLoaded.presupuestos) await loadPresupuestos();
    if (!dataLoaded.inversiones) await loadInversiones();

    updateNetWorthChart(saldos);

    const visibleAccountIds = new Set(Object.keys(saldos));
    const investmentAccountIds = new Set(getVisibleAccounts().filter(c => c.esInversion).map(c => c.id));

    // Fase 2: Lógica de cálculo (sin cambios aquí)
    const calculateTotals = (movs) => {
        let ingresos = 0, gastos = 0, saldoNeto = 0;
        movs.forEach(m => {
            if (m.tipo === 'movimiento') {
                saldoNeto += m.cantidad;
                if (m.cantidad > 0) ingresos += m.cantidad;
                else gastos += m.cantidad;
            } else if (m.tipo === 'traspaso') {
                const origenVisible = visibleAccountIds.has(m.cuentaOrigenId);
                const destinoVisible = visibleAccountIds.has(m.cuentaDestinoId);
                if (origenVisible && !destinoVisible) {
                    saldoNeto -= m.cantidad;
                    gastos -= m.cantidad;
                } else if (!origenVisible && destinoVisible) {
                    saldoNeto += m.cantidad;
                    ingresos += m.cantidad;
                }
            }
        });
        return { ingresos, gastos, saldoNeto };
    };
    const currentTotals = calculateTotals(current);
    const previousTotals = calculateTotals(previous);
    const saldoNetoActual = currentTotals.saldoNeto;
    const saldoNetoAnterior = previousTotals.saldoNeto;
    const tasaAhorroActual = currentTotals.ingresos > 0 ? (saldoNetoActual / currentTotals.ingresos) * 100 : (saldoNetoActual < 0 ? -100 : 0);
    const tasaAhorroAnterior = previousTotals.ingresos > 0 ? (previousTotals.saldoNeto / previousTotals.ingresos) * 100 : 0;
    const patrimonioNeto = Object.values(saldos).reduce((sum, s) => sum + s, 0);
    const pnlInversionActual = current.reduce((sum, mov) => (mov.tipo === 'movimiento' && investmentAccountIds.has(mov.cuentaId) ? sum + mov.cantidad : sum), 0);
    const now = new Date();
    const expenseBudgets = (db.presupuestos || []).filter(b => b.ano === now.getFullYear() && b.cantidad < 0);
    let totalBudgetedExpense = 0;
    let actualExpenseForBudget = Math.abs(currentTotals.gastos);
    if (expenseBudgets.length > 0) {
        const periodFilter = select('filter-periodo').value;
        const totalAnnualBudget = expenseBudgets.reduce((sum, b) => sum + Math.abs(b.cantidad), 0);
        if (periodFilter === 'mes-actual') totalBudgetedExpense = totalAnnualBudget / 12;
        else if (periodFilter === 'año-actual') totalBudgetedExpense = totalAnnualBudget;
        else {
            const sDateEl = select('filter-fecha-inicio'), eDateEl = select('filter-fecha-fin');
            if (sDateEl?.value && eDateEl?.value) {
                const diffDays = (new Date(eDateEl.value) - new Date(sDateEl.value)) / 86400000 + 1;
                totalBudgetedExpense = (totalAnnualBudget / (now.getFullYear() % 4 === 0 ? 366 : 365)) * diffDays;
            }
        }
    }

    // Fase 3: Rellenar los widgets (sin cambios aquí)
    const getComparisonHTML = (currentVal, prevVal, comparisonLabel, lowerIsBetter = false) => {
        if (!comparisonLabel || prevVal === 0 || Math.abs(prevVal) < 1) return '';
        const isImprovement = lowerIsBetter ? (currentVal < prevVal) : (currentVal > prevVal);
        const diff = (currentVal - prevVal) / Math.abs(prevVal) * 100;
        const diffClass = isImprovement ? 'text-positive' : 'text-negative';
        const icon = isImprovement ? 'arrow_upward' : 'arrow_downward';
        return `<span class="${diffClass}"><span class="material-icons" style="font-size: 12px; vertical-align: middle;">${icon}</span> ${Math.abs(diff).toFixed(0)}%</span> <span style="color:var(--c-on-surface-secondary)">${comparisonLabel}</span>`;
    };
    if (select('kpi-ingresos-value')) {
        selectAll('#kpi-container .skeleton').forEach(el => el.classList.remove('skeleton'));
        animateCountUp(select('kpi-ingresos-value'), currentTotals.ingresos);
        select('kpi-ingresos-comparison').innerHTML = getComparisonHTML(currentTotals.ingresos, previousTotals.ingresos, label);
        animateCountUp(select('kpi-gastos-value'), currentTotals.gastos);
        select('kpi-gastos-comparison').innerHTML = getComparisonHTML(Math.abs(currentTotals.gastos), Math.abs(previousTotals.gastos), label, true);
    }
    const saldoNetoEl = select('kpi-saldo-neto-value');
    if (saldoNetoEl) {
        saldoNetoEl.className = `kpi-item__value ${saldoNetoActual >= 0 ? 'text-positive' : 'text-negative'}`;
        animateCountUp(saldoNetoEl, saldoNetoActual);
        select('kpi-saldo-neto-comparison').innerHTML = getComparisonHTML(saldoNetoActual, saldoNetoAnterior, label);
    }
    if (select('kpi-ampliado-widget')) {
        selectAll('#kpi-ampliado-widget .skeleton').forEach(el => el.classList.remove('skeleton'));
        const kpiTasaAhorroValueEl = select('kpi-tasa-ahorro-value');
        kpiTasaAhorroValueEl.textContent = `${tasaAhorroActual.toFixed(1)}%`;
        kpiTasaAhorroValueEl.className = `kpi-item__value ${tasaAhorroActual >= 0 ? 'text-positive' : 'text-negative'}`;
        renderSavingsRateGauge('kpi-savings-rate-chart', tasaAhorroActual);
        select('kpi-tasa-ahorro-comparison').innerHTML = getComparisonHTML(tasaAhorroActual, tasaAhorroAnterior, label.replace('vs', ''));
        animateCountUp(select('kpi-patrimonio-neto-value'), patrimonioNeto);
        const kpiPnlEl = select('kpi-pnl-inversion-value');
        kpiPnlEl.className = `kpi-item__value ${pnlInversionActual >= 0 ? 'text-positive' : 'text-negative'}`;
        if (investmentAccountIds.size > 0) animateCountUp(kpiPnlEl, pnlInversionActual); else kpiPnlEl.textContent = 'N/A';
        const progressEl = select('kpi-presupuesto-progress'), progressTextEl = select('kpi-presupuesto-text');
        progressTextEl.classList.remove('skeleton');
        if (totalBudgetedExpense > 0) {
            const percentage = (actualExpenseForBudget / totalBudgetedExpense) * 100;
            progressEl.value = Math.min(percentage, 100);
            progressTextEl.innerHTML = `Gastado <strong>${formatCurrency(actualExpenseForBudget)}</strong> de un límite de <strong>${formatCurrency(totalBudgetedExpense)}</strong> (${percentage.toFixed(0)}%)`;
            progressEl.className = 'budget-item__progress';
            if (percentage > 100) progressEl.classList.add('budget-item__progress--danger');
            else if (percentage > 85) progressEl.classList.add('budget-item__progress--warning');
        } else {
            progressEl.value = 0;
            progressTextEl.textContent = 'No hay presupuestos de gasto definidos para este año.';
        }
    }
    const actionCenterContainer = select('action-center-content');
    if (actionCenterContainer) {
        let actionItems = [];
        const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
        const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
        const pendingRecurrents = (db.recurrentes || []).filter(r => new Date(r.nextDate) <= today);
        pendingRecurrents.forEach(r => actionItems.push({ urgency: 3, type: 'pending', data: r, subtitle: `Vencido desde el ${new Date(r.nextDate).toLocaleDateString()}` }));
        (db.recurrentes || []).filter(r => { const nextDate = new Date(r.nextDate); return nextDate > today && nextDate <= nextWeek; }).slice(0, 3).forEach(r => actionItems.push({ urgency: 2, type: 'upcoming', data: r, subtitle: `Vence el ${new Date(r.nextDate).toLocaleDateString()}` }));
        actionItems.sort((a, b) => b.urgency - a.urgency || new Date(a.data.nextDate) - new Date(b.data.nextDate));
        if (actionItems.length === 0) {
            actionCenterContainer.innerHTML = `<div class="empty-state" style="padding: var(--sp-2) 0; background: transparent; border: none;"><span class="material-icons text-positive">task_alt</span><p style="color: var(--c-on-surface-secondary);">¡Todo en orden!</p></div>`;
        } else {
            actionCenterContainer.innerHTML = actionItems.map(item => { const r = item.data; const amountClass = r.cantidad >= 0 ? 'text-positive' : 'text-negative'; const actionButtons = item.type === 'pending' ? `<div style="display: flex; gap: var(--sp-2);"><button class="btn btn--secondary" data-action="skip-recurrent" data-id="${r.id}" style="padding: 4px 8px; font-size: 0.7rem;">Omitir</button><button class="btn btn--primary" data-action="confirm-recurrent" data-id="${r.id}" style="padding: 4px 8px; font-size: 0.7rem;">Añadir</button></div>` : ''; return `<div class="modal__list-item" style="padding: var(--sp-2) 0;"><div><strong style="font-size: var(--fs-sm);">${r.descripcion}</strong><small style="display: block; color: var(--c-on-surface-secondary);">${item.subtitle}</small></div><div style="text-align: right;"><strong class="${amountClass}" style="font-size: var(--fs-base);">${formatCurrency(r.cantidad)}</strong>${actionButtons}</div></div>`; }).join('');
        }
    }
    
    // --- INICIO DE LA SECCIÓN CORREGIDA ---
    const conceptListContainer = select('concepto-totals-list');
    const chartCanvas = select('conceptos-chart');
    
    // La corrección está aquí: TODA la lógica del gráfico y la lista va DENTRO del `if`.
    if (conceptListContainer && chartCanvas) {
        const chartCtx = chartCanvas.getContext('2d');
        const chartContainer = chartCanvas.closest('.chart-container');
        if(chartContainer) chartContainer.classList.remove('skeleton');
        if (conceptosChart) conceptosChart.destroy();
        
        const cTots = current.reduce((a, m) => { if (m.tipo === 'movimiento' && m.conceptoId) { if (!a[m.conceptoId]) { const con = db.conceptos.find((c) => c.id === m.conceptoId); a[m.conceptoId] = { total: 0, movements: [], icon: (con && con.icon) || 'label' }; } a[m.conceptoId].total += m.cantidad; a[m.conceptoId].movements.push(m); } return a; }, {});
        const sortedTotals = Object.entries(cTots).sort(([, a], [, b]) => a.total - b.total);
        const colorSuccess = getComputedStyle(document.body).getPropertyValue('--c-chart-positive').trim();
        const colorDanger = getComputedStyle(document.body).getPropertyValue('--c-danger').trim();
        
        conceptosChart = new Chart(chartCtx, {
            type: 'bar',
            data: {
                labels: sortedTotals.map(([id]) => { const con = db.conceptos.find((c) => c.id === id); return toSentenceCase((con && con.nombre) || '?') }),
                datasets: [{
                    data: sortedTotals.map(([, data]) => data.total / 100),
                    backgroundColor: sortedTotals.map(([, data]) => data.total >= 0 ? colorSuccess : colorDanger),
                    borderRadius: 6,
                }]
            },
            options: { // Las opciones ahora incluyen el onClick para el drill-down
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, datalabels: { display: false }, tooltip: { callbacks: { label: (context) => `Total: ${formatCurrency(context.parsed.y * 100)}` } } },
                scales: { y: { ticks: { callback: (value) => `${value.toLocaleString('es-ES')}` } } },
                onClick: (event, elements) => {
                    if (elements.length === 0) return;
                    const index = elements[0].index;
                    const [conceptoId, data] = sortedTotals[index];
                    const concepto = db.conceptos.find(c => c.id === conceptoId);
                    const conceptoNombre = concepto ? toSentenceCase(concepto.nombre) : 'Desconocido';
                    hapticFeedback('light');
                    showDrillDownModal(`Movimientos de: ${conceptoNombre}`, data.movements);
                },
                onHover: (event, chartElement) => {
                    event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                }
            }
        });

        // Y ahora, la lógica para rellenar la lista de conceptos
        conceptListContainer.innerHTML = (sortedTotals.length === 0)
        ? `<div class="empty-state" style="padding:16px 0; background:transparent; border:none;"><p>Sin datos para los filtros.</p></div>`
        : sortedTotals.map(([id, data]) => {
            const con = db.conceptos.find((c) => c.id === id);
            const t = data.total;
            return `<details class="accordion" style="background-color: var(--c-surface-variant);">
                <summary>
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons" style="font-size: 18px;">${data.icon}</span>${toSentenceCase((con && con.nombre) || '?')}
                    </span>
                    <span>
                        <strong class="${t >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(t)}</strong>
                        <span class="material-icons accordion__icon">expand_more</span>
                    </span>
                </summary>
                <div class="accordion__content" style="padding: 0 var(--sp-2) var(--sp-2) var(--sp-2);">
                    ${data.movements.sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime())
                    .map(mov => {
                        const cuenta = db.cuentas.find(c => c.id === mov.cuentaId);
                        const concepto = db.conceptos.find(c => c.id === mov.conceptoId);
                        const amountClass = mov.cantidad >= 0 ? 'text-positive' : 'text-negative';
                        const indicatorClass = mov.cantidad >= 0 ? 'transaction-card__indicator--income' : 'transaction-card__indicator--expense';

                        return `
                        <div class="transaction-card" data-action="edit-movement-from-list" data-id="${mov.id}" style="cursor: pointer;">
                            <div class="transaction-card__indicator ${indicatorClass}"></div>
                            <div class="transaction-card__content">
                                <div class="transaction-card__details">
                                    <div class="transaction-card__row-1">${toSentenceCase((concepto && concepto.nombre) || 'S/C')}</div>
                                    <div class="transaction-card__row-2">${new Date(mov.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' })} • ${escapeHTML(mov.descripcion)}</div>
                                </div>
                                <div class="transaction-card__figures">
                                    <div class="transaction-card__amount ${amountClass}">${formatCurrency(mov.cantidad)}</div>
                                    <div class="transaction-card__row-2" style="text-align: right;">${(cuenta && escapeHTML(cuenta.nombre)) || 'S/C'}</div>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </details>`;
        }).join('');
    }
    // --- FIN DE LA SECCIÓN CORREGIDA ---

    if (select('informe-personalizado-widget')) {
        await renderInformeWidgetContent();
    }
};

/**
 * Calcula y renderiza el gráfico de evolución del patrimonio neto.
 * @param {object} saldos - El objeto con los saldos actuales de las cuentas.
 */




let informeChart = null; // Variable global para el gráfico del informe
let informeBuilderDebounceTimer = null;

// Renderiza el HTML estático del widget en el panel de Inicio
const renderDashboardInformeWidget = () => {
    const reportConfig = db.config?.savedReports?.main;
    const title = reportConfig?.title || "Mi Informe Personalizado";
    return `
    <div class="card" id="informe-personalizado-widget">
        <div class="card__title" style="justify-content: space-between; padding-bottom: 0;">
            <div style="display: flex; align-items: center; gap: var(--sp-2);">
                <span class="material-icons">insights</span>
                <span id="informe-widget-title">${escapeHTML(title)}</span>
            </div>
            <button data-action="show-informe-builder" class="btn btn--secondary">
                <span class="material-icons" style="font-size: 16px;">edit</span>
                <span>Configurar</span>
            </button>
        </div>
        <div class="card__content" id="informe-widget-content">
            <div class="empty-state skeleton" style="background:transparent; border:none; padding: var(--sp-4) 0;">
                <p>Cargando informe...</p>
            </div>
        </div>
    </div>`;
};

// Rellena el widget con el gráfico y datos según la configuración guardada
const renderInformeWidgetContent = async () => {
    const container = select('informe-widget-content');
    if (!container) return;

    const reportConfig = db.config?.savedReports?.main;

    if (!reportConfig) {
        container.innerHTML = `
        <div class="empty-state" style="background:transparent; border:none; padding: var(--sp-4) 0;">
            <p>Aún no has configurado tu informe. Haz clic en "Configurar" para empezar.</p>
        </div>`;
        return;
    }
    
    container.innerHTML = `<div class="chart-container" style="height: 240px;"><canvas id="informe-main-chart"></canvas></div>`;

    const data = await generateInformeData(reportConfig);
    const chartCanvas = select('informe-main-chart');
    const chartCtx = chartCanvas ? chartCanvas.getContext('2d') : null;

    if (informeChart) informeChart.destroy();
    if (!chartCtx) return;

    if (data.labels.length === 0) {
        container.innerHTML = `<div class="empty-state" style="background:transparent; border:none; padding: var(--sp-2) 0;"><p>No se encontraron datos para los criterios de tu informe.</p></div>`;
        return;
    }

    informeChart = new Chart(chartCtx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: data.datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: reportConfig.desglose === 'concepto' },
                y: { stacked: reportConfig.desglose === 'concepto', ticks: { callback: (value) => `€${value.toLocaleString('es-ES')}` } }
            },
            plugins: {
                legend: { display: data.datasets.length > 1, position: 'top' },
                tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${formatCurrency(c.raw * 100)}` } },
                datalabels: { display: false }
            }
        }
    });
};

// Muestra el modal para construir/editar el informe
const showInformeBuilderModal = () => {
    const reportConfig = db.config?.savedReports?.main || {};
    const today = new Date().toISOString().slice(0, 10);
    const lastYear = new Date(new Date().setFullYear(new Date().getFullYear() - 1)).toISOString().slice(0, 10);
    
    const accountsOptions = getVisibleAccounts()
        .sort((a, b) => a.nombre.localeCompare(b.nombre))
        .map(c => `<option value="${c.id}" ${reportConfig.cuentas?.includes(c.id) ? 'selected' : ''}>${escapeHTML(c.nombre)}</option>`)
        .join('');

    const conceptosOptions = db.conceptos
        .sort((a, b) => a.nombre.localeCompare(b.nombre))
        .map(c => `<option value="${c.id}" ${reportConfig.conceptos?.includes(c.id) ? 'selected' : ''}>${escapeHTML(c.nombre)}</option>`)
        .join('');

    const html = `
        <form id="informe-builder-form" novalidate>
            <div class="form-group">
                <label for="informe-title" class="form-label">Nombre del Informe</label>
                <input type="text" id="informe-title" class="form-input" value="${escapeHTML(reportConfig.title || 'Mi Informe Personalizado')}">
            </div>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                 <div class="form-group">
                    <label for="informe-metrica" class="form-label">Métrica Principal</label>
                    <select id="informe-metrica" class="form-select">
                        <option value="saldo_neto" ${reportConfig.metrica === 'saldo_neto' ? 'selected' : ''}>Saldo Neto</option>
                        <option value="gastos" ${reportConfig.metrica === 'gastos' ? 'selected' : ''}>Gastos</option>
                        <option value="ingresos" ${reportConfig.metrica === 'ingresos' ? 'selected' : ''}>Ingresos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="informe-agrupacion" class="form-label">Agrupar por</label>
                    <select id="informe-agrupacion" class="form-select">
                        <option value="mes" ${reportConfig.agrupacion === 'mes' ? 'selected' : ''}>Mes</option>
                        <option value="trimestre" ${reportConfig.agrupacion === 'trimestre' ? 'selected' : ''}>Trimestre</option>
                    </select>
                </div>
            </div>
             <div class="form-group">
                <label for="informe-desglose" class="form-label">Desglosar por</label>
                <select id="informe-desglose" class="form-select">
                    <option value="total" ${reportConfig.desglose === 'total' ? 'selected' : ''}>Total General</option>
                    <option value="concepto" ${reportConfig.desglose === 'concepto' ? 'selected' : ''}>Top 5 Conceptos</option>
                </select>
            </div>
            <hr style="border-color: var(--c-outline); opacity: 0.5; margin: var(--sp-4) 0;">
            <h4 style="margin-bottom: var(--sp-3);">Filtros de Datos</h4>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="form-group">
                    <label for="informe-fecha-inicio" class="form-label">Desde</label>
                    <input type="date" id="informe-fecha-inicio" class="form-input" value="${reportConfig.fechaInicio || lastYear}">
                </div>
                <div class="form-group">
                    <label for="informe-fecha-fin" class="form-label">Hasta</label>
                    <input type="date" id="informe-fecha-fin" class="form-input" value="${reportConfig.fechaFin || today}">
                </div>
            </div>
            <div class="form-group">
                <label for="informe-cuentas" class="form-label">Cuentas (deja en blanco para todas)</label>
                <select id="informe-cuentas" class="form-select" multiple style="height: 120px;">${accountsOptions}</select>
            </div>
            <div class="form-group">
                <label for="informe-conceptos" class="form-label">Conceptos (deja en blanco para todos)</label>
                <select id="informe-conceptos" class="form-select" multiple style="height: 120px;">${conceptosOptions}</select>
            </div>
             <div id="informe-preview-container" style="margin-top: var(--sp-4);">
                <h4 style="margin-bottom: var(--sp-2);">Previsualización</h4>
                <div class="chart-container skeleton" style="height: 220px;"><canvas id="informe-preview-chart"></canvas></div>
            </div>
            <div class="modal__actions">
                <button type="button" data-action="save-informe" class="btn btn--primary btn--full">Guardar y Actualizar Panel</button>
            </div>
        </form>`;
    
    showGenericModal('Creador de Informes', html);
    
    setTimeout(() => {
        const form = select('informe-builder-form');
        form.addEventListener('input', () => handleInformeBuilderChange());
        handleInformeBuilderChange(); // Carga la preview inicial
    }, 100);
};

// Se ejecuta al cambiar cualquier filtro en el modal para actualizar la preview
const handleInformeBuilderChange = () => {
    clearTimeout(informeBuilderDebounceTimer);
    informeBuilderDebounceTimer = setTimeout(async () => {
        const previewContainer = select('informe-preview-container');
        if (!previewContainer) return;

        const config = {
            title: select('informe-title').value,
            metrica: select('informe-metrica').value,
            agrupacion: select('informe-agrupacion').value,
            desglose: select('informe-desglose').value,
            fechaInicio: select('informe-fecha-inicio').value,
            fechaFin: select('informe-fecha-fin').value,
            cuentas: Array.from(select('informe-cuentas').selectedOptions).map(opt => opt.value),
            conceptos: Array.from(select('informe-conceptos').selectedOptions).map(opt => opt.value),
        };

        const chartContainer = previewContainer.querySelector('.chart-container');
        chartContainer.classList.add('skeleton');
        
        const data = await generateInformeData(config);
        
        chartContainer.classList.remove('skeleton');
        const chartCanvas = select('informe-preview-chart');
        const chartCtx = chartCanvas ? chartCanvas.getContext('2d') : null;
        if (informeChart) informeChart.destroy();
        if (!chartCtx) return;

        if(data.labels.length === 0) {
            chartContainer.innerHTML = `<div class="empty-state" style="padding: var(--sp-3) 0; border: none; background: transparent;"><p>No hay datos para esta selección.</p></div><canvas id="informe-preview-chart" style="display: none;"></canvas>`;
            return;
        } else {
             chartContainer.innerHTML = `<canvas id="informe-preview-chart"></canvas>`;
        }
        
        informeChart = new Chart(select('informe-preview-chart').getContext('2d'), {
            type: config.desglose === 'concepto' ? 'bar' : 'line',
            data: { labels: data.labels, datasets: data.datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    x: { stacked: config.desglose === 'concepto' },
                    y: { stacked: config.desglose === 'concepto', ticks: { callback: (v) => `€${v.toLocaleString()}` } }
                },
                plugins: { legend: { display: data.datasets.length > 1 }, tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${formatCurrency(c.raw * 100)}` }}, datalabels: { display: false } }
            }
        });
    }, 400);
};

// Guarda la configuración del informe en la base de datos
const handleSaveInforme = async (btn) => {
    setButtonLoading(btn, true);
    const config = {
        title: select('informe-title').value.trim(),
        metrica: select('informe-metrica').value,
        agrupacion: select('informe-agrupacion').value,
        desglose: select('informe-desglose').value,
        fechaInicio: select('informe-fecha-inicio').value,
        fechaFin: select('informe-fecha-fin').value,
        cuentas: Array.from(select('informe-cuentas').selectedOptions).map(opt => opt.value),
        conceptos: Array.from(select('informe-conceptos').selectedOptions).map(opt => opt.value),
    };
    if (!db.config.savedReports) db.config.savedReports = {};
    db.config.savedReports.main = config;

    await fbDb.collection('users').doc(currentUser.uid).set({ config: db.config }, { merge: true });

    setButtonLoading(btn, false);
    hideModal('generic-modal');
    hapticFeedback('success');
    showToast('Informe guardado y actualizado en el panel.');
    select('informe-widget-title').textContent = escapeHTML(config.title);
    await renderInformeWidgetContent();
};

// La función MÁGICA: toma una configuración y devuelve los datos para el gráfico
const generateInformeData = async (config) => {
    const sDate = parseDateStringAsUTC(config.fechaInicio);
    const eDate = parseDateStringAsUTC(config.fechaFin);
    if (eDate) eDate.setUTCHours(23, 59, 59, 999);
    if (!sDate || !eDate) return { labels: [], datasets: [] };
    
    const querySnapshot = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos')
        .where('fecha', '>=', sDate.toISOString()).where('fecha', '<=', eDate.toISOString()).get();
    
    let movements = querySnapshot.docs.map(doc => doc.data());
    const visibleAccountIds = new Set(getVisibleAccounts().map(c => c.id));
    
    // Filtrado por cuentas
    const filterCuentas = config.cuentas && config.cuentas.length > 0;
    const selectedCuentas = new Set(config.cuentas);
    movements = movements.filter(m => {
        const cuentaSet = filterCuentas ? selectedCuentas : visibleAccountIds;
        if (m.tipo === 'traspaso') return cuentaSet.has(m.cuentaOrigenId) || cuentaSet.has(m.cuentaDestinoId);
        return cuentaSet.has(m.cuentaId);
    });

    // Filtrado por conceptos
    const filterConceptos = config.conceptos && config.conceptos.length > 0;
    if (filterConceptos) {
        const selectedConceptos = new Set(config.conceptos);
        movements = movements.filter(m => selectedConceptos.has(m.conceptoId));
    }
    
    // Agrupación y procesamiento de datos
    const groupedData = {};
    const getGroupKey = (date) => {
        if (config.agrupacion === 'trimestre') return `${date.getUTCFullYear()}-Q${Math.floor(date.getUTCMonth() / 3) + 1}`;
        return `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}`;
    };

    movements.forEach(m => {
        const groupKey = getGroupKey(new Date(m.fecha));
        if (!groupedData[groupKey]) groupedData[groupKey] = {};
        
        let Categoria = 'Total';
        if(config.desglose === 'concepto' && m.conceptoId) {
            Categoria = m.conceptoId;
        }
        if(!groupedData[groupKey][Categoria]) groupedData[groupKey][Categoria] = { ingresos: 0, gastos: 0 };
        
        const cuentaSet = filterCuentas ? selectedCuentas : visibleAccountIds;
        if(m.tipo === 'traspaso') {
            if(cuentaSet.has(m.cuentaDestinoId)) groupedData[groupKey][Categoria].ingresos += m.cantidad;
            if(cuentaSet.has(m.cuentaOrigenId)) groupedData[groupKey][Categoria].gastos -= m.cantidad;
        } else {
            if(m.cantidad > 0) groupedData[groupKey][Categoria].ingresos += m.cantidad;
            else groupedData[groupKey][Categoria].gastos += m.cantidad;
        }
    });

    const labels = Object.keys(groupedData).sort();
    let datasets = [];
    const colorPalette = ['#007AFF', '#30D158', '#FFD60A', '#FF3B30', '#BF5AF2', '#5E5CE6'];

    if (config.desglose === 'total') {
        const data = labels.map(label => {
            const periodData = groupedData[label]['Total'] || {ingresos: 0, gastos: 0};
            if(config.metrica === 'ingresos') return periodData.ingresos / 100;
            if(config.metrica === 'gastos') return Math.abs(periodData.gastos / 100);
            return (periodData.ingresos + periodData.gastos) / 100;
        });
        datasets.push({ label: 'Total', data, backgroundColor: colorPalette[0], borderColor: colorPalette[0] });
    } else { // Desglose por concepto
        const conceptTotals = {};
        Object.values(groupedData).forEach(period => {
            Object.entries(period).forEach(([conceptId, data]) => {
                if(conceptId !== 'Total') {
                    if(!conceptTotals[conceptId]) conceptTotals[conceptId] = 0;
                    conceptTotals[conceptId] += Math.abs(data.ingresos) + Math.abs(data.gastos);
                }
            });
        });

        const topConcepts = Object.entries(conceptTotals).sort((a,b) => b[1] - a[1]).slice(0, 5).map(entry => entry[0]);
        const conceptMap = new Map(db.conceptos.map(c => [c.id, c.nombre]));
        
        const finalConcepts = [...topConcepts, 'Otros'];
        datasets = finalConcepts.map((conceptId, index) => {
            const data = labels.map(label => {
                let periodTotal = 0;
                const periodData = groupedData[label];
                if(conceptId === 'Otros') {
                    Object.entries(periodData).forEach(([cId, data]) => {
                        if(!topConcepts.includes(cId)) {
                             if(config.metrica === 'ingresos') periodTotal += data.ingresos;
                             else if(config.metrica === 'gastos') periodTotal += data.gastos;
                             else periodTotal += data.ingresos + data.gastos;
                        }
                    });
                } else if(periodData[conceptId]) {
                    const data = periodData[conceptId];
                    if(config.metrica === 'ingresos') periodTotal = data.ingresos;
                    else if(config.metrica === 'gastos') periodTotal = data.gastos;
                    else periodTotal = data.ingresos + data.gastos;
                }
                return config.metrica === 'gastos' ? Math.abs(periodTotal / 100) : periodTotal / 100;
            });
            return {
                label: conceptMap.get(conceptId) || 'Otros',
                data,
                backgroundColor: colorPalette[index % colorPalette.length]
            };
        });
    }

    return { labels, datasets };
};
        
		/** Muestra el modal para configurar los widgets del dashboard. */
const showDashboardConfigModal = () => {
    const widgetOrder = (db.config && db.config.dashboardWidgets) || DEFAULT_DASHBOARD_WIDGETS;
    
    let listHtml = widgetOrder.map(widgetId => 
        renderWidgetConfigItem(widgetId, AVAILABLE_WIDGETS[widgetId], true)
    ).join('');

    listHtml += Object.keys(AVAILABLE_WIDGETS)
        .filter(id => !widgetOrder.includes(id))
        .map(widgetId => renderWidgetConfigItem(widgetId, AVAILABLE_WIDGETS[widgetId], false))
        .join('');

    const modalHtml = `
        <p class="form-label">Activa, desactiva y reordena los elementos que quieres ver en tu panel de control.</p>
        <div id="widget-config-list" style="margin-top: var(--sp-4);">${listHtml}</div>
        <div class="modal__actions">
            <button class="btn btn--primary btn--full" data-action="save-dashboard-config">Guardar Cambios</button>
        </div>`;
    showGenericModal('Personalizar Panel', modalHtml);

    const list = select('widget-config-list');
    let draggedItem = null;

    list.addEventListener('dragstart', e => {
        draggedItem = e.target.closest('.widget-config-item');
        setTimeout(() => {
            if (draggedItem) draggedItem.classList.add('dragging');
        }, 0);
    });

    list.addEventListener('dragend', () => {
        if (draggedItem) draggedItem.classList.remove('dragging');
        draggedItem = null;
    });
    
    list.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        const currentDraggable = document.querySelector('.dragging');
        if (!currentDraggable) return;

        if (afterElement == null) {
            list.appendChild(currentDraggable);
        } else {
            list.insertBefore(currentDraggable, afterElement);
        }
    });
};

/** Función auxiliar para renderizar un solo item de la lista de configuración. */
const renderWidgetConfigItem = (id, details, isEnabled) => `
    <div class="widget-config-item" draggable="true" data-id="${id}">
        <span class="material-icons drag-handle">drag_indicator</span>
        <div class="widget-config-item__details">
            <p class="widget-config-item__title">${details.title}</p>
            <p class="widget-config-item__desc">${details.description}</p>
        </div>
        <label class="form-switch"><input type="checkbox" ${isEnabled ? 'checked' : ''}><span class="slider"></span></label>
    </div>`;

/** Función auxiliar que calcula dónde se debe insertar el elemento que se arrastra. */
const getDragAfterElement = (container, y) => {
    const draggableElements = [...container.querySelectorAll('.widget-config-item:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
};

/** Guarda la nueva configuración del dashboard en Firebase. */
const handleSaveDashboardConfig = async (btn) => {
    setButtonLoading(btn, true);
    const list = select('widget-config-list');
    if (!list) return;

    const newOrder = Array.from(list.querySelectorAll('.widget-config-item'))
        .filter(item => item.querySelector('input[type="checkbox"]').checked)
        .map(item => item.dataset.id);

    db.config.dashboardWidgets = newOrder;
    await fbDb.collection('users').doc(currentUser.uid).set({ config: db.config }, { merge: true });
    
    setButtonLoading(btn, false);
    hideModal('generic-modal');
    hapticFeedback('success');
    showToast('Panel actualizado.');
    renderInicioResumenView();
};
		let suggestionDebounceTimer = null;
        const applyDescriptionSuggestion = (description, conceptoId, cuentaId) => {
            const descriptionInput = select('movimiento-descripcion');
            const conceptoSelect = select('movimiento-concepto');
            const cuentaSelect = select('movimiento-cuenta');

            if (descriptionInput) descriptionInput.value = description;
            if (conceptoSelect && conceptoId) {
                conceptoSelect.value = conceptoId;
                const parentEl = conceptoSelect.parentElement;
                if (parentEl) {
                    parentEl.classList.add('field-highlighted');
                    setTimeout(() => parentEl.classList.remove('field-highlighted'), 1000);
                }
            }
            if (cuentaSelect && cuentaId) {
                cuentaSelect.value = cuentaId;
                const parentEl = cuentaSelect.parentElement;
                if (parentEl) {
                    parentEl.classList.add('field-highlighted');
                    setTimeout(() => parentEl.classList.remove('field-highlighted'), 1000);
                }
            }
            const suggestionsBox = select('description-suggestions');
            if (suggestionsBox) suggestionsBox.style.display = 'none';
        };

                    const showModal = (id) => {
            const m = select(id);
            if (m) {
                const mainScroller = selectOne('.app-layout__main');
                if (mainScroller) { 
                    lastScrollTop = mainScroller.scrollTop;
                }
                m.classList.add('modal-overlay--active');
                
                if (isInitialLoadComplete) {
                    const appRoot = select('app-root');
                    if (appRoot) {
                        appRoot.classList.add('app-layout--transformed-by-modal');
                    }
                }

                if (!id.includes('calculator')) {
                    const f = m.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (f) (f).focus();
                }
            }
        };

        const hideModal = (id) => {
            const m = select(id);
            if (m) {
                m.classList.remove('modal-overlay--active');
                
                const appRoot = select('app-root');
                if (appRoot) {
                    appRoot.classList.remove('app-layout--transformed-by-modal');
                }

                if (id === 'movimiento-modal' && calculatorState.isVisible) {
                    hideCalculator();
                }
            }

            const mainScroller = selectOne('.app-layout__main');
            if (mainScroller && lastScrollTop !== null) {
                requestAnimationFrame(() => {
                    mainScroller.scrollTop = lastScrollTop;
                    lastScrollTop = null;
                });
            }
        };
											   
        let calculatorKeyboardHandler = null;

        const showCalculator = (targetInput) => {
    const modalBody = select('movimiento-modal').querySelector('.modal__body');
    const calculatorEl = select('calculator-ui');
    if (!calculatorEl || !modalBody) return;

    calculatorState.isVisible = true;
    calculatorState.targetInput = targetInput;
    const currentValue = targetInput.value.trim();
    const parsedValue = parseCurrencyString(currentValue);

    if (!isNaN(parsedValue) && currentValue !== '') {
        calculatorState.displayValue = String(parsedValue).replace('.', ',');
    } else {
        calculatorState.displayValue = '0';
    }
    
    calculatorState.waitingForNewValue = true;
    calculatorState.operand1 = null;
    calculatorState.operator = null;
    calculatorState.isResultDisplayed = false;
    updateCalculatorDisplay();
    
    // Nueva lógica de visibilidad
    calculatorEl.classList.add('calculator-ui--visible');

    // ===== MEJORA DE UX: SCROLL AUTOMÁTICO =====
    // Esperamos a que la animación de la calculadora termine para hacer los cálculos
    setTimeout(() => {
        const inputRect = targetInput.getBoundingClientRect();
        const calculatorRect = calculatorEl.getBoundingClientRect();
        
        // Si la parte de abajo del input está tapada por la calculadora...
        if (inputRect.bottom > calculatorRect.top) {
            // Calculamos cuánto hay que subir el scroll
            const scrollAmount = inputRect.bottom - calculatorRect.top + 20; // 20px de margen
            modalBody.scrollBy({
                top: scrollAmount,
                behavior: 'smooth'
            });
        }
    }, 350); // 350ms, igual que la transición CSS

    // Gestión del teclado y clics fuera
    if (calculatorKeyboardHandler) {
        document.removeEventListener('keydown', calculatorKeyboardHandler);
    }

calculatorKeyboardHandler = (e) => {
    if ("0123456789,.+-*/".includes(e.key) || ['Enter', 'Backspace', 'Escape', 'Delete'].includes(e.key)) {
        e.preventDefault();
    }

    if (e.key >= '0' && e.key <= '9') {
        handleCalculatorInput(e.key);
    } else if (e.key === ',' || e.key === '.') {
        handleCalculatorInput('comma');
    } else if (e.key === 'Enter') {
        handleCalculatorInput('done');
    } else if (e.key === 'Backspace') {
        handleCalculatorInput('backspace');
    } else if (e.key === 'Delete') {
        handleCalculatorInput('clear');
    } else if (e.key === 'Escape') {
        hideCalculator();
    } else if (e.key === '+') {
        handleCalculatorInput('add');
    } else if (e.key === '-') {
        handleCalculatorInput('subtract');
    } else if (e.key === '*' || e.key === 'x') {
        handleCalculatorInput('multiply');
    } else if (e.key === '/') {
        handleCalculatorInput('divide');
    }
};

document.addEventListener('keydown', calculatorKeyboardHandler);
 };
const hideCalculator = () => {
            const modalBody = select('movimiento-modal').querySelector('.modal__body');
            const calculatorEl = select('calculator-ui');
            if (!calculatorEl || !modalBody) return;

            // Lógica de visibilidad actualizada
            calculatorEl.classList.remove('calculator-ui--visible');
            modalBody.classList.remove('calculator-active');
            
            calculatorState.targetInput = null;
            calculatorState.isVisible = false;
    calculatorState.isResultDisplayed = false;
    updateDoneButtonText();
    
    if (calculatorKeyboardHandler) {
        document.removeEventListener('keydown', calculatorKeyboardHandler);
        calculatorKeyboardHandler = null;
    }
    document.removeEventListener('click', closeCalculatorOnClickOutside);
};
        const closeCalculatorOnClickOutside = (e) => {
            const calculatorEl = select('calculator-ui');
            if (!calculatorState.isVisible || (calculatorEl && calculatorEl.contains(e.target))) {
                 setTimeout(() => {
                     document.addEventListener('click', closeCalculatorOnClickOutside, { once: true });
                 }, 0);
                return;
            }
            hideCalculator();
        };       
	      
	const handleCalculatorInput = (key) => {
    hapticFeedback('light');
    // Se elimina la variable 'isResultDisplayed' de la desestructuración
    let { displayValue, waitingForNewValue, operand1, operator } = calculatorState;
    
    const isOperator = ['add', 'subtract', 'multiply', 'divide'].includes(key);

    if (isOperator) {
        if (operand1 !== null && operator !== null && !waitingForNewValue) {
            calculate();
            displayValue = calculatorState.displayValue;
        }
        operand1 = parseFloat(displayValue);
        operator = key;
        waitingForNewValue = true;
    } else {
        switch(key) {
            // =================================================================
            // === SOLUCIÓN 1: INICIO DE LA LÓGICA DE CALCULADORA MEJORADA ===
            // =================================================================
            case 'done': 
                hapticFeedback('medium'); 
                
                // Si hay una operación pendiente, la calculamos primero.
                if (operand1 !== null && operator !== null && !waitingForNewValue) {
                    calculate();
                    displayValue = calculatorState.displayValue; 
                }
                
                // Asignamos el valor y cerramos inmediatamente.
                if (calculatorState.targetInput) {
                    const finalValue = parseFloat(displayValue) || 0;
                    // Se formatea a 2 decimales, sin agrupación, para que sea un valor numérico estándar.
                    calculatorState.targetInput.value = finalValue.toLocaleString('es-ES', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    // Disparamos un evento 'input' para que cualquier validador reaccione.
                    calculatorState.targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                hideCalculator(); 
                return; // Salimos de la función aquí.
            // =================================================================
            // === SOLUCIÓN 1: FIN DE LA LÓGICA DE CALCULADORA MEJORADA      ===
            // =================================================================
            case 'comma': 
                if (waitingForNewValue) {
                    displayValue = '0.';
                    waitingForNewValue = false;
                } else if (!displayValue.includes('.')) { 
                    displayValue += '.'; 
                } 
                break;
            case 'clear': 
                displayValue = '0'; 
                waitingForNewValue = true; 
                operand1 = null;
                operator = null;
                break;
            case 'backspace': 
                displayValue = displayValue.slice(0, -1);
                if (displayValue === '' || displayValue === '-') {
                    displayValue = '0';
                    waitingForNewValue = true;
                }
                break;
            case 'sign': 
                if (displayValue !== '0') { 
                    displayValue = displayValue.startsWith('-') ? displayValue.slice(1) : `-${displayValue}`; 
                } 
                break;
            default: // Dígitos
                if (waitingForNewValue || (displayValue === '0' && key !== '0' && !displayValue.includes('.'))) {
                    displayValue = key; 
                    waitingForNewValue = false; 
                } else if (displayValue === '0' && key === '0' && !displayValue.includes('.')) {
                    // Evita múltiples ceros al principio
                    displayValue = '0';
                }
                else { 
                    displayValue += key; 
                } 
                break;
        }
    }
    
    // Ya no necesitamos gestionar 'isResultDisplayed'
    calculatorState.displayValue = displayValue;
    calculatorState.waitingForNewValue = waitingForNewValue;
    calculatorState.operand1 = operand1;
    calculatorState.operator = operator;
    updateCalculatorDisplay();
};

// También eliminamos la función 'updateDoneButtonText' que ya no es necesaria.
// El estado 'isResultDisplayed' en 'calculatorState' también puede ser eliminado.
            const calculate = () => {
            const val1 = parseFloat(calculatorState.operand1);
            const val2 = parseFloat(calculatorState.displayValue);
            if (isNaN(val1) || isNaN(val2) || !calculatorState.operator) {
                return;
            }

            let result = 0;
            switch (calculatorState.operator) {
                case 'add': result = val1 + val2; break;
                case 'subtract': result = val1 - val2; break;
                case 'multiply': result = val1 * val2; break;
                case 'divide':
                    if (val2 === 0) {
                        showToast("No se puede dividir por cero.", "danger");
                        calculatorState.displayValue = '0';
                        calculatorState.waitingForNewValue = true;
                        calculatorState.operand1 = null;
                        calculatorState.operator = null;
                        return;
                    }
                    result = val1 / val2;
                    break;
            }
            calculatorState.displayValue = String(result);
            calculatorState.operand1 = null;
            calculatorState.operator = null;
            calculatorState.waitingForNewValue = true;
            calculatorState.isResultDisplayed = true;
        };
		 const updateDoneButtonText = () => {
            const doneButton = select('calculator-btn-done');
            if (doneButton) {
                doneButton.textContent = calculatorState.isResultDisplayed ? 'Cerrar' : 'OK';
            }
        };
        

                const updateCalculatorDisplay = () => {
            const display = select('calculator-display');
            if (display) { 
                let formattedDisplayValue = calculatorState.displayValue;
                if (formattedDisplayValue === '0.') {
                    formattedDisplayValue = '0,';
                } else if (formattedDisplayValue.endsWith('.')) {
                    formattedDisplayValue = formattedDisplayValue.replace('.', ',');
                } else {
                    const numValue = parseFloat(formattedDisplayValue);
                    if (!isNaN(numValue)) {
                        if (calculatorState.isResultDisplayed) {
                            formattedDisplayValue = numValue.toLocaleString('es-ES', { 
                                useGrouping: false,
                                minimumFractionDigits: 2, 
                                maximumFractionDigits: 2 
                            });
                        } else {
                            const parts = formattedDisplayValue.split('.');
                            const integerPart = parts[0];
                            const decimalPart = parts[1] || '';

                            formattedDisplayValue = numValue.toLocaleString('es-ES', { 
                                useGrouping: false,
                                minimumFractionDigits: decimalPart.length,
                                maximumFractionDigits: decimalPart.length
                            });
                            
                            if (formattedDisplayValue.includes(',') && !formattedDisplayValue.endsWith(',') && formattedDisplayValue.split(',')[1].length < decimalPart.length) {
                                formattedDisplayValue += '0'.repeat(decimalPart.length - formattedDisplayValue.split(',')[1].length);
                            } else if (!formattedDisplayValue.includes(',') && decimalPart.length > 0) {
                                formattedDisplayValue += ',' + '0'.repeat(decimalPart.length);
                            }
                        }
                    }
                }
                display.textContent = formattedDisplayValue;
            }
            if (calculatorState.targetInput) {
                const numValue = parseFloat(calculatorState.displayValue) || 0;
                calculatorState.targetInput.value = numValue.toLocaleString('es-ES', { 
                    useGrouping: false,
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            }
        };
        const showGenericModal=(title,html)=>{const titleEl = select('generic-modal-title'); if (titleEl) titleEl.textContent=title; const bodyEl = select('generic-modal-body'); if(bodyEl) bodyEl.innerHTML=html;showModal('generic-modal');};
		const showDrillDownModal = (title, movements) => {
    // Ordenamos los movimientos por fecha para que se muestren cronológicamente
    movements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

    // Construimos el contenido del modal
    const modalContentHTML = movements.length === 0
        ? `<div class="empty-state" style="background:transparent; border:none; padding-top: var(--sp-4);">
               <span class="material-icons">search_off</span>
               <h3>Sin movimientos</h3>
               <p>No se han encontrado movimientos para esta selección.</p>
           </div>`
        // Reutilizamos tu renderizador de items para mantener la consistencia visual
        : `<div class="movements-modal-container" style="max-height: 60vh; overflow-y: auto; padding: 0 var(--sp-2);">
               ${movements.map((m) => renderVirtualListItem({ type: 'transaction', movement: m })).join('')}
           </div>`;

    // Llamamos a la función existente para mostrar el modal
    showGenericModal(title, modalContentHTML);
};
        const showConfirmationModal=(msg, onConfirm, title="Confirmar Acción")=>{ hapticFeedback('medium'); const id='confirmation-modal';const existingModal = document.getElementById(id); if(existingModal) existingModal.remove(); const overlay=document.createElement('div');overlay.id=id;overlay.className='modal-overlay modal-overlay--active'; overlay.innerHTML=`<div class="modal" role="alertdialog" style="border-radius:var(--border-radius-lg)"><div class="modal__header"><h3 class="modal__title">${title}</h3></div><div class="modal__body"><p>${msg}</p><div style="display:flex;gap:var(--sp-3);margin-top:var(--sp-4);"><button class="btn btn--secondary btn--full" data-action="close-modal" data-modal-id="confirmation-modal">Cancelar</button><button class="btn btn--danger btn--full" data-action="confirm-action">Sí, continuar</button></div></div></div>`; document.body.appendChild(overlay); (overlay.querySelector('[data-action="confirm-action"]')).onclick=()=>{hapticFeedback('medium');onConfirm();overlay.remove();}; (overlay.querySelector('[data-action="close-modal"]')).onclick=()=>overlay.remove(); };
        
                const showAccountMovementsModal = async (cId) => {
            const cuenta = getVisibleAccounts().find((c) => c.id === cId);
            if (!cuenta) return;

            showGenericModal(`Movimientos de ${cuenta.nombre}`, `<div style="text-align:center; padding: var(--sp-5);"><span class="spinner"></span><p style="margin-top: var(--sp-3);">Cargando historial...</p></div>`);

            try {
                const movsSnapshot = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').get();
                const allMovements = movsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const accountMovements = allMovements.filter(m => 
                    m.cuentaId === cId || 
                    m.cuentaOrigenId === cId || 
                    m.cuentaDestinoId === cId
                );

                if (accountMovements.length > 0) {
                    recalculateAndApplyRunningBalances(accountMovements);
                    accountMovements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                }
                
                const html = accountMovements.length === 0 
                    ? `<div class="empty-state" style="background:transparent; border:none; padding-top: var(--sp-4);">
                           <span class="material-icons">search_off</span>
                           <h3>Sin movimientos</h3>
                           <p>No se han encontrado movimientos para esta cuenta.</p>
                       </div>` 
                    : `<div class="movements-modal-container">
                           ${accountMovements.map((m) => renderVirtualListItem({type: 'transaction', movement: m})).join('')}
                       </div>`;

                const modalBody = select('generic-modal-body');
                if (modalBody) {
                    modalBody.innerHTML = html;
                }

            } catch (error) {
                console.error("Error al obtener los movimientos de la cuenta:", error);
                showToast("No se pudo cargar el historial de la cuenta.", "danger");
                const modalBody = select('generic-modal-body');
                if (modalBody) {
                    modalBody.innerHTML = `<p class="text-danger" style="text-align:center;">Ha ocurrido un error al cargar los datos.</p>`;
                }
            }
        };
        
const setMovimientoFormType = (type) => {
    hapticFeedback('light');
    const isTraspaso = type === 'traspaso';

    select('movimiento-fields').classList.toggle('hidden', isTraspaso);
    select('traspaso-fields').classList.toggle('hidden', !isTraspaso);

    const titleEl = select('form-movimiento-title');
    if (titleEl) titleEl.textContent = isTraspaso ? 'Traspaso' : 'Ingreso/Gasto';
    
    select('mov-type-btn-movimiento').classList.toggle('filter-pill--active', !isTraspaso);
    select('mov-type-btn-traspaso').classList.toggle('filter-pill--active', isTraspaso);

    if (isTraspaso) {
        const descripcionInput = select('movimiento-descripcion');
        if (descripcionInput && descripcionInput.value.trim() === '') {
            descripcionInput.value = 'Traspaso';
        }
    }
};

                const updateDateDisplay = (dateInput) => {
            const dateTextEl = select('movimiento-fecha-text');
            if (!dateTextEl || !dateInput.value) return;

            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            today.setHours(0, 0, 0, 0);
            yesterday.setHours(0, 0, 0, 0);

            const selectedDate = new Date(dateInput.value);
            selectedDate.setMinutes(selectedDate.getMinutes() + selectedDate.getTimezoneOffset());
            selectedDate.setHours(0, 0, 0, 0);

            if (selectedDate.getTime() === today.getTime()) {
                dateTextEl.textContent = "Hoy";
            } else if (selectedDate.getTime() === yesterday.getTime()) {
                dateTextEl.textContent = "Ayer";
            } else {
                dateTextEl.textContent = selectedDate.toLocaleDateString('es-ES', {
                    day: '2-digit', month: '2-digit', year: 'numeric'
                });
            }
        };

                const startMovementForm = (id = null, isRecurrent = false) => {
            hapticFeedback('medium');
            const form = select('form-movimiento');
            form.reset();
            clearAllErrors(form.id);
            populateAllDropdowns();

            setMovimientoFormType('movimiento'); 
            
            let data = null;
            let mode = 'new';
            const collectionName = isRecurrent ? 'recurrentes' : 'movimientos';
			if (id) {
                const dataSource = isRecurrent ? db.recurrentes : db.movimientos;
                data = dataSource.find(item => item.id === id);

                if (!data && !isRecurrent) {
                    data = recentMovementsCache.find(item => item.id === id);
                }
                
                if (data) {
                   mode = isRecurrent ? 'edit-recurrent' : 'edit-single';
                }
            }
        
			select('movimiento-mode').value = mode;
            select('movimiento-id').value = id || '';
        
            if (data && data.tipo === 'traspaso') {
                setMovimientoFormType('traspaso');
            }
        
            select('form-movimiento-title').textContent = id && data ? (data.tipo === 'traspaso' ? 'Editar Traspaso' : 'Editar Movimiento') : 'Añadir Movimiento';
            select('movimiento-cantidad').value = data ? `${(data.cantidad / 100).toLocaleString('es-ES', { minimumFractionDigits: 2, useGrouping: false })}` : '';
            
            const fechaInput = select('movimiento-fecha');
            const fecha = data && data.fecha ? new Date(data.fecha) : new Date();
            fechaInput.value = new Date(fecha.getTime() - (fecha.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
            updateDateDisplay(fechaInput);

            select('movimiento-descripcion').value = (data && data.descripcion) || '';
        
            if (data && data.tipo === 'traspaso') {
                select('movimiento-cuenta-origen').value = (data && data.cuentaOrigenId) || '';
                select('movimiento-cuenta-destino').value = (data && data.cuentaDestinoId) || '';
            } else {
                select('movimiento-cuenta').value = (data && data.cuentaId) || '';
                select('movimiento-concepto').value = (data && data.conceptoId) || '';
            }
        
            const recurrenteCheckbox = select('movimiento-recurrente');
            const recurrentOptions = select('recurrent-options');
            if (mode === 'edit-recurrent' && data) {
                recurrenteCheckbox.checked = true;
                select('recurrent-frequency').value = data.frequency;
                select('recurrent-next-date').value = data.nextDate;
                select('recurrent-end-date').value = data.endDate || '';
                recurrentOptions.classList.remove('hidden');
            } else {
                recurrenteCheckbox.checked = false;
                recurrentOptions.classList.add('hidden');
            }
            
            select('delete-movimiento-btn').classList.toggle('hidden', !id || !data);
            select('delete-movimiento-btn').dataset.isRecurrent = isRecurrent;
            select('duplicate-movimiento-btn').classList.toggle('hidden', !(mode === 'edit-single' && data));
            
            showModal('movimiento-modal');
        };
        
        
        const showGlobalSearchModal = () => {
            hapticFeedback('medium');
            showModal('global-search-modal');
            setTimeout(() => {
                const input = select('global-search-input');
				if (id === 'concepto-search-input') renderConceptosModalList();
				if (id === 'cuenta-search-input') renderCuentasModalList();
				
                if (input) {
                    input.focus();
                    input.value = '';
                    input.dispatchEvent(new Event('input'));
                }
            }, 100);
        };
        
        const performGlobalSearch = async (query) => {
            const resultsContainer = select('global-search-results');
            if (!resultsContainer) return;

            if (!query || query.trim().length < 2) {
                resultsContainer.innerHTML = `<div class="empty-state" style="background:transparent; border: none;"><span class="material-icons">manage_search</span><h3>Encuéntralo todo</h3><p>Busca movimientos, cuentas o conceptos. <br>Atajo: <strong>Cmd/Ctrl + K</strong></p></div>`;
                return;
            }

            resultsContainer.innerHTML = `<div style="text-align: center; padding: var(--sp-5);"><span class="spinner"></span><p style="margin-top: var(--sp-2);">Buscando en toda tu base de datos...</p></div>`;
            
            const queryLower = query.toLowerCase();
            let resultsHtml = '';
            const MAX_RESULTS_PER_GROUP = 10;

            const allMovements = await fetchAllMovementsForSearch();

            const movs = allMovements
                .map(m => {
                    const concepto = db.conceptos.find(c => c.id === m.conceptoId);
                    const conceptoNombre = (concepto && concepto.nombre) || '';
                    let cuentaInfo = '';
                    if (m.tipo === 'traspaso') {
                        const origen = db.cuentas.find(c => c.id === m.cuentaOrigenId);
                        const destino = db.cuentas.find(c => c.id === m.cuentaDestinoId);
                        cuentaInfo = `${(origen && origen.nombre) || ''} ${(destino && destino.nombre) || ''}`;
                    } else {
                        const cuenta = db.cuentas.find(c => c.id === m.cuentaId);
                        cuentaInfo = (cuenta && cuenta.nombre) || '';
                    }
                    const fecha = new Date(m.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                    const importe = (m.cantidad / 100).toLocaleString('es-ES');
                    const searchableText = `${m.descripcion} ${conceptoNombre} ${cuentaInfo} ${fecha} ${importe}`.toLowerCase();
                    return { movement: m, text: searchableText };
                })
                .filter(item => item.text.includes(queryLower))
                .sort((a, b) => new Date(b.movement.fecha) - new Date(a.movement.fecha))
                .slice(0, MAX_RESULTS_PER_GROUP)
                .map(item => item.movement);

            if (movs.length > 0) {
                resultsHtml += `<div class="search-result-group__title">Movimientos Encontrados</div>`;
                movs.forEach(m => {
                    const concepto = db.conceptos.find(c => c.id === m.conceptoId);
                    const conceptoNombre = (concepto && concepto.nombre) || '';
                    const amountClass = m.cantidad >= 0 ? 'text-positive' : 'text-negative';
                    resultsHtml += `
                        <button class="search-result-item" data-action="search-result-movimiento" data-id="${m.id}">
                            <span class="material-icons search-result-item__icon">receipt_long</span>
                            <div class="search-result-item__details" style="flex-grow: 1;">
                                <p>${escapeHTML(m.descripcion)}</p>
                                <small>${new Date(m.fecha).toLocaleDateString('es-ES')} • ${escapeHTML(conceptoNombre)}</small>
                            </div>
                            <strong class="${amountClass}">${formatCurrency(m.cantidad)}</strong>
                        </button>`;
                });
            }
        
            const cuentas = (db.cuentas || []).filter(c => c.nombre.toLowerCase().includes(queryLower) || c.tipo.toLowerCase().includes(queryLower)).slice(0, MAX_RESULTS_PER_GROUP);
            if (cuentas.length > 0) {
                resultsHtml += `<div class="search-result-group__title">Cuentas</div>`;
                cuentas.forEach(c => { resultsHtml += `<button class="search-result-item" data-action="search-result-cuenta" data-id="${c.id}"><span class="material-icons search-result-item__icon">account_balance_wallet</span><div class="search-result-item__details"><p>${escapeHTML(c.nombre)}</p><small>${escapeHTML(c.tipo)}</small></div></button>`; });
            }
        
            const conceptos = (db.conceptos || []).filter(c => c.nombre.toLowerCase().includes(queryLower)).slice(0, MAX_RESULTS_PER_GROUP);
            if (conceptos.length > 0) {
                resultsHtml += `<div class="search-result-group__title">Conceptos</div>`;
                conceptos.forEach(c => { resultsHtml += `<button class="search-result-item" data-action="search-result-concepto" data-id="${c.id}"><span class="material-icons search-result-item__icon">label</span><div class="search-result-item__details"><p>${escapeHTML(c.nombre)}</p></div></button>`; });
            }
        
            if (!resultsHtml) {
                resultsHtml = `<div class="empty-state" style="background:transparent; border: none;"><span class="material-icons">search_off</span><h3>Sin resultados</h3><p>No se encontró nada para "${escapeHTML(query)}".</p></div>`;
            }
            resultsContainer.innerHTML = resultsHtml;
        };

		const showValoracionModal = (cuentaId) => {
            const cuenta = db.cuentas.find(c => c.id === cuentaId);
            if (!cuenta) return;

            const fechaISO = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
            const ultimaValoracion = (db.inversiones_historial || [])
                .filter(v => v.cuentaId === cuentaId)
                .sort((a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime())[0];

            const valorActualInput = ultimaValoracion ? (ultimaValoracion.valor / 100).toLocaleString('es-ES', { useGrouping: false, minimumFractionDigits: 2 }) : '';

            const formHtml = `
            <form id="form-valoracion" data-id="${cuentaId}" novalidate>
                <p class="form-label" style="margin-bottom: var(--sp-3);">
                    Introduce el valor de mercado actual para <strong>${escapeHTML(cuenta.nombre)}</strong>. Esto actualizará el P&L y la TIR.
                </p>
                <div class="form-group">
                    <label for="valoracion-valor" class="form-label">Nuevo Valor Total del Activo</label>
                    <input type="text" id="valoracion-valor" class="form-input input-amount-calculator" inputmode="decimal" required value="${valorActualInput}" placeholder="Ej: 15250,75">
                </div>
                <div class="form-group">
                    <label for="valoracion-fecha" class="form-label">Fecha de la Valoración</label>
                    <input type="date" id="valoracion-fecha" class="form-input" value="${fechaISO}" required>
                </div>
                <div class="modal__actions">
                    <button type="submit" class="btn btn--primary">Guardar Valoración</button>
                </div>
            </form>`;

            showGenericModal(`Actualizar Valor de ${cuenta.nombre}`, formHtml);
        };

        const handleSaveValoracion = async (form, btn) => {
            setButtonLoading(btn, true);
            const cuentaId = form.dataset.id;
            const valor = parseCurrencyString(select('valoracion-valor').value);
            const fecha = select('valoracion-fecha').value;

            if (!cuentaId || isNaN(valor) || !fecha || valor < 0) {
                showToast('El valor debe ser un número positivo y la fecha es obligatoria.', 'warning');
                setButtonLoading(btn, false);
                return;
            }

            const newId = generateId();
            const newValoracion = {
                id: newId,
                cuentaId: cuentaId,
                valor: Math.round(valor * 100),
                fecha: parseDateStringAsUTC(fecha).toISOString()
            };

            await saveDoc('inversiones_historial', newId, newValoracion);
            setButtonLoading(btn, false);
            hideModal('generic-modal');
            hapticFeedback('success');
            showToast('Valor del activo actualizado.');
            
            const activePageEl = document.querySelector('.view--active');
            const activePage = activePageEl ? activePageEl.id : null;
            if (activePage === PAGE_IDS.PATRIMONIO) {
                renderPatrimonioPage();
            }
        };
		const showHelpModal = () => {
            const titleEl = select('help-modal-title');
            const bodyEl = select('help-modal-body');
            
            if (titleEl) {
                titleEl.textContent = 'Guía de Usuario aiDANaI';
            }
            if (bodyEl) {
                bodyEl.innerHTML = `
                    <div style="text-align: center; margin-bottom: var(--sp-4);">
    <img src="aiDANaI.webp" alt="Logo Cuentas aiDANaI" class="login-view__logo" style="margin-bottom: var(--sp-2);">
    <h3 style="font-size: 1.4rem;">Tu Centro de Mando Financiero</h3>
    <p style="color: var(--c-primary); font-weight: 600;">Donde la claridad financiera se convierte en poder.</p>
</div>
<p>¡Hola! Prepárate para tomar el control de tu dinero como nunca antes. Esta no es solo una app, es tu copiloto financiero personal. Esta guía te convertirá en un experto de tus propias finanzas, explicando cada rincón de la aplicación de una forma clara y directa. ¡Vamos allá!</p>

<h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">explore</span>El Gran Tour: Un Paseo por tu Universo Financiero</h3>
<p>Hemos diseñado la navegación para que responda a las preguntas clave sobre tu dinero. Cada pestaña es una pieza del puzle:</p>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary><span class="material-icons" style="margin-right:8px">dashboard</span><strong>1. Inicio: ¿Cómo voy hoy?</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>Esta es tu <strong>torre de control</strong>. De un solo vistazo, tienes el pulso de tu situación financiera para el periodo que elijas (¡este mes por defecto!). Es tu panel personalizable con:</p>
        <ul>
            <li><strong>Centro de Operaciones:</strong> Tus constantes vitales. No solo ingresos y gastos, sino métricas clave como tu <strong>Tasa de Ahorro</strong> y el valor de tu <strong>Patrimonio Neto</strong>.</li>
            <li><strong>Centro de Acciones:</strong> La app piensa por ti. Te avisará de facturas recurrentes pendientes para que nunca se te pase nada.</li>
            <li><strong>Gráficos Inteligentes:</strong> Desgloses visuales para entender al instante a dónde se va tu dinero y de dónde viene.</li>
        </ul>
        <p><strong>Ejemplo práctico:</strong> A mitad de mes, entras y ves en el gráfico que "Ocio y Restaurantes" ocupa un trozo más grande de lo esperado. ¡Te permite ajustar tus planes para las próximas semanas al momento!</p>
    </div>
</details>
                
<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary><span class="material-icons" style="margin-right:8px">receipt_long</span><strong>2. Movimientos: ¿Qué ha pasado exactamente?</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>Tu <strong>diario financiero</strong> detallado. Aquí puedes bucear en tu historial completo, sin filtros. Es la verdad absoluta de tus finanzas.</p>
        <ul>
            <li><strong>Listado Infinito:</strong> Todos tus gastos, ingresos y traspasos, ordenados por fecha, con el más reciente primero. ¡Desliza hacia abajo para cargar más!</li>
            <li><strong>Saldo de Auditoría:</strong> Cada movimiento muestra el saldo de la cuenta <strong>justo después</strong> de esa transacción. Es perfecto para cuadrar tus cuentas con el extracto del banco con una precisión milimétrica.</li>
        </ul>
        <p><strong>Truco PRO:</strong> Desliza un movimiento hacia la izquierda para <strong>borrarlo</strong> o hacia la derecha para <strong>duplicarlo</strong> al instante. ¡Ahorra tiempo como un campeón!</p>
    </div>
</details>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary><span class="material-icons" style="margin-right:8px">edit_calendar</span><strong>3. Planificación: ¿Cuál es mi plan de futuro?</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>Aquí te pones el sombrero de estratega. Es donde le dices a tu dinero qué hacer, en lugar de preguntarte a dónde se ha ido. Es tu sección proactiva.</p>
        <ul>
            <li><strong>Presupuestos Anuales:</strong> ¡Tu plan de batalla! Define cuánto quieres gastar o ingresar por categoría. La app te mostrará con gráficos y barras de progreso si te estás ciñendo al plan o si necesitas apretarte el cinturón.</li>
            <li><strong>Movimientos Recurrentes:</strong> Automatiza tu vida. Gestiona tus pagos y cobros fijos (nómina, alquiler, Netflix...). La app te avisará cuando llegue la fecha para que los confirmes con un solo clic.</li>
        </ul>
        <p><strong>Ejemplo práctico:</strong> Creas un presupuesto de 200€ al mes para "Ocio". En esta sección, verás una barra de progreso que te indica en tiempo real cuánto te queda y si vas a buen ritmo para no pasarte a final de año.</p>
    </div>
</details>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary><span class="material-icons" style="margin-right:8px">account_balance</span><strong>4. Patrimonio: ¿Cuánto valgo realmente?</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>La fotografía completa de tu riqueza. Esta pestaña consolida <strong>todo lo que tienes y todo lo que debes</strong>, ofreciendo una visión 360° de tu salud financiera.</p>
         <ul>
            <li><strong>Patrimonio Neto:</strong> El número más importante. Tu valor financiero total, calculado en tiempo real.</li>
            <li><strong>Estructura Visual:</strong> Un gráfico interactivo te muestra cómo se distribuye tu patrimonio (cuánto en líquido, cuánto en inversiones, propiedades, etc.).</li>
            <li><strong>Portafolio de Inversión:</strong> Un apartado profesional para tus activos. No solo te dice cuánto valen, sino cómo están rindiendo con métricas avanzadas.</li>
        </ul>
        <p><strong>Ejemplo práctico:</strong> Quieres saber qué porcentaje de tu riqueza total representan tus acciones. Vas a Patrimonio, y el gráfico de estructura te lo mostrará de un solo vistazo. ¡Toma decisiones de inversión basadas en datos, no en intuiciones!</p>
    </div>
</details>

<h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">stars</span>Funciones Estrella: Tus Superpoderes Secretos</h3>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary>🚀 <strong>Contabilidad Dual (A/B): Tu Arma Secreta</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);"><p>El botón <strong>[A]/[B]</strong> en la esquina superior izquierda es mágico. Te permite llevar dos contabilidades <strong>totalmente separadas e independientes</strong>. Es como tener dos aplicaciones en una.</p>
    <p><strong>Ideas de uso geniales:</strong></p>
    <ul>
        <li><strong>Contabilidad A (Personal):</strong> Gestionas tu nómina, tus gastos diarios, tus ahorros... tu vida.</li>
        <li><strong>Contabilidad B (Proyecto):</strong> Gestionas un pequeño negocio, las cuentas de la comunidad de vecinos, un viaje en grupo, o incluso las finanzas de tus padres. ¡Todo separado y ordenado, sin mezclar!</li>
    </ul>
    </div>
</details>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary>🔍 <strong>Búsqueda Global (Atajo: Ctrl/Cmd + K)</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);"><p>¿No recuerdas cuánto te costó la cena del sábado? Pulsa el icono de la lupa (o el atajo de teclado) y escribe "cena". La búsqueda te mostrará al instante ese movimiento, la cuenta relacionada y el concepto. ¡Es la forma más rápida de encontrar cualquier cosa en toda la app!</p></div>
</details>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary>📈 <strong>Seguimiento de Inversiones Nivel PRO</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>Esto lleva tus finanzas al siguiente nivel. En <strong>Ajustes > Gestión de Datos > Cuentas</strong>, puedes marcar una cuenta como "de inversión". Al hacerlo, la app desbloquea métricas profesionales en la pestaña de <strong>Patrimonio</strong>:</p>
        <ul>
            <li><strong>P&L (Ganancias y Pérdidas):</strong> Te dice, sin rodeos, cuánto dinero has ganado o perdido, tanto en euros como en porcentaje.</li>
            <li><strong>TIR (Tasa Interna de Retorno):</strong> El indicador definitivo para saber si tu inversión es un cohete 🚀 o una tortuga 🐢. Te dice la rentabilidad <strong>anualizada</strong> real, teniendo en cuenta no solo el valor final, sino <strong>cuándo y cuánto dinero</strong> has ido metiendo o sacando. ¡Es lo que usan los profesionales!</li>
        </ul>
    </div>
</details>

<details class="accordion" style="margin-bottom: var(--sp-2);">
    <summary>🔄 <strong>Importación Mágica desde CSV</strong></summary>
    <div class="accordion__content" style="padding-top: var(--sp-2);">
        <p>¿Vienes de otra app o de una hoja de cálculo? ¡Pan comido! Ve a <strong>Ajustes > Copia de Seguridad > Importar CSV</strong>. Solo necesitas un archivo con 5 columnas:</p>
        <code>FECHA;CUENTA;CONCEPTO;IMPORTE;DESCRIPCIÓN</code>
        <p>La app es muy lista y hará el trabajo sucio por ti:</p>
        <ul>
            <li>Si una cuenta o concepto no existe, ¡lo crea automáticamente!</li>
            <li><strong>Truco PRO 1 (Traspasos):</strong> Si en la columna CONCEPTO pones <code>TRASPASO</code>, la app buscará un movimiento de la misma fecha e importe contrario en otra cuenta y los unirá mágicamente.</li>
            <li><strong>Truco PRO 2 (Saldo Inicial):</strong> Usa el CONCEPTO <code>INICIAL</code> para establecer el saldo de partida de una cuenta. Ejemplo: "01/01/2025;Mi Banco;INICIAL;1500;Saldo de partida".</li>
        </ul>
    </div>
</details>

<p style="text-align: center; margin-top: var(--sp-5); font-style: italic; color: var(--c-on-surface-secondary);">¡Explora, registra y toma el control definitivo de tu futuro financiero! Estás al mando.</p>
                `;
            }
            
            showModal('help-modal');
        };
     
		const updateThemeIcon = () => {
            const themeBtn = select('theme-toggle-btn');
            if (themeBtn) {
                const iconEl = themeBtn.querySelector('.material-icons');
                if (iconEl) {
                    iconEl.textContent = 'palette';
                }
            }
        };

 const handleToggleTheme = () => {
    const currentTheme = document.body.dataset.theme || 'default';
    const newTheme = currentTheme === 'default' ? 'aurora' : 'default'; // <--- CAMBIO AQUÍ
    
    document.body.dataset.theme = newTheme;
    localStorage.setItem('appTheme', newTheme);
    hapticFeedback('light');
    updateThemeIcon(newTheme);

    if (conceptosChart) conceptosChart.destroy();
    if (liquidAssetsChart) liquidAssetsChart.destroy();
    
    const activePageEl = document.querySelector('.view--active');
    const activePageId = activePageEl ? activePageEl.id : null;
    if (activePageId) {
        navigateTo(activePageId, true);
    }
};
        const showConceptosModal = () => { 
            const html = `
    <div class="form-group" style="margin-bottom: var(--sp-3);">
        <input type="search" id="concepto-search-input" class="form-input" placeholder="Buscar conceptos..." autocomplete="off">
    </div>
                <form id="add-concepto-form" novalidate style="margin-bottom: var(--sp-4);">
                    <div class="form-grid"><div class="form-group" style="grid-column: 1 / -1;"><label for="new-concepto-nombre" class="form-label">Nombre del Concepto</label><input type="text" id="new-concepto-nombre" class="form-input" placeholder="Ej: Nómina" required></div></div>
                    <button type="submit" class="btn btn--primary btn--full">Añadir Concepto</button>
                </form>
                <hr style="border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-top: var(--sp-4); margin-bottom: var(--sp-2); font-size: var(--fs-base); color: var(--c-on-surface-secondary);">Conceptos Existentes</h4><div id="conceptos-modal-list"></div>`; 
            showGenericModal('Gestionar Conceptos', html); 
            renderConceptosModalList(); 
        };
        
        const renderConceptosModalList = () => { 
            const list = select('conceptos-modal-list'); 
            if (!list) return;
			 const searchQuery = select('concepto-search-input')?.value.toLowerCase() || '';
    const conceptosFiltrados = (db.conceptos || []).filter(c => 
        c.nombre.toLowerCase().includes(searchQuery)
    );
            list.innerHTML = conceptosFiltrados.length === 0 
                ? `<p style="font-size:var(--fs-sm); color:var(--c-on-surface-secondary); text-align:center; padding: var(--sp-4) 0;">No hay conceptos.</p>` 
                : [...conceptosFiltrados].sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => {
                    const icon = (c && c.icon) || 'label';
                    const nombre = (c && c.nombre) || '';
                    return `<div id="concepto-item-${c.id}" class="modal__list-item"><div style="display: flex; align-items: center; gap: 12px; flex-grow: 1; min-width: 0;"><span class="material-icons" style="color: var(--c-primary);">${icon}</span><span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(nombre)}</span></div><div style="display: flex; align-items: center; gap: var(--sp-1); flex-shrink: 0;"><button class="icon-btn" data-action="edit-concepto" data-id="${c.id}" title="Editar Concepto"><span class="material-icons">edit_note</span></button><button class="icon-btn" data-action="delete-concepto" data-id="${c.id}" title="Eliminar Concepto"><span class="material-icons">delete_outline</span></button></div></div>`;
                }).join(''); 
        };
        
        const showConceptoEditForm = (id) => {
            const itemContainer = select(`concepto-item-${id}`);
            const concepto = db.conceptos.find(c => c.id === id);
            if (!itemContainer || !concepto) return;
            itemContainer.innerHTML = `
                <form class="inline-edit-form" data-id="${id}" novalidate>
                    <div class="form-group" style="margin-bottom: 0;"><label class="form-label" for="edit-concepto-nombre-${id}">Nombre</label><input type="text" id="edit-concepto-nombre-${id}" class="form-input" value="${escapeHTML(concepto.nombre)}" required></div>
                    <div style="display:flex; justify-content: flex-end; gap: var(--sp-2); align-items: center; margin-top: var(--sp-2);"><button type="button" class="btn btn--secondary" data-action="cancel-edit-concepto">Cancelar</button><button type="button" class="btn btn--primary" data-action="save-edited-concepto" data-id="${id}">Guardar</button></div>
                </form>`;
            select(`edit-concepto-nombre-${id}`).focus();
        };
        const handleSaveEditedConcept = async (id, btn) => {
            const nombreInput = select(`edit-concepto-nombre-${id}`);
            const nombre = nombreInput.value.trim();
            if (!nombre) { showToast('El nombre es obligatorio.', 'warning'); nombreInput.classList.add('form-input--invalid'); return; }
            
            await saveDoc('conceptos', id, { nombre }, btn);
			hapticFeedback('success');
			showToast('Concepto actualizado.');
			renderConceptosModalList();
        };

        const showCuentasModal = () => { 
            const existingAccountTypes = [...new Set((db.cuentas || []).map(c => c.tipo))].sort();
            const datalistOptions = existingAccountTypes.map(type => `<option value="${type}"></option>`).join('');
            const html = `
			<div class="form-group" style="margin-bottom: var(--sp-3);">
        <input type="search" id="cuenta-search-input" class="form-input" placeholder="Buscar cuentas..." autocomplete="off">
    </div>
                   <form id="add-cuenta-form" novalidate>
                <div class="form-group"><label for="new-cuenta-nombre" class="form-label">Nombre de la Cuenta</label><input type="text" id="new-cuenta-nombre" class="form-input" placeholder="Ej: Cartera personal" required></div>
                <div class="form-group"><label for="new-cuenta-tipo" class="form-label">Tipo de Cuenta</label><input type="text" id="new-cuenta-tipo" class="form-input" list="tipos-cuenta-list" placeholder="Ej: Banco, Cripto, Fintech..." required><datalist id="tipos-cuenta-list">${datalistOptions}</datalist></div>
                <button type="submit" class="btn btn--primary btn--full" style="margin-top: var(--sp-3)">Añadir Cuenta</button>
            </form>
            <hr style="margin: var(--sp-4) 0; border-color: var(--c-outline); opacity: 0.5;"><h4 style="margin-top: var(--sp-4); margin-bottom: var(--sp-2); font-size: var(--fs-base); color: var(--c-on-surface-secondary);">Cuentas Existentes</h4><div id="cuentas-modal-list"></div>`; 
            showGenericModal('Gestionar Cuentas', html); 
            renderCuentasModalList(); 
        };
    
        const renderCuentasModalList = () => {
            const list = select('cuentas-modal-list');
            if (!list) return;
            const searchQuery = select('cuenta-search-input')?.value.toLowerCase() || '';
            const cuentasFiltradas = (db.cuentas || []).filter(c => 
                c.nombre.toLowerCase().includes(searchQuery) || 
                c.tipo.toLowerCase().includes(searchQuery)
            );
            list.innerHTML = cuentasFiltradas.length === 0 
                ? `<p style="font-size:var(--fs-sm); color:var(--c-on-surface-secondary); text-align:center; padding: var(--sp-4) 0;">No hay cuentas.</p>` 
                : [...cuentasFiltradas].sort((a,b) => a.nombre.localeCompare(b.nombre)).map((c) => `
                    <div class="modal__list-item" id="cuenta-item-${c.id}">
                    <div style="display: flex; flex-direction: column; flex-grow: 1; min-width: 0;"><span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(c.nombre)}</span><small style="color: var(--c-on-surface-secondary); font-size: var(--fs-xs);">${toSentenceCase(escapeHTML(c.tipo))}</small></div>
                    <div style="display: flex; align-items: center; gap: var(--sp-1); flex-shrink: 0;"><div class="form-switch-group" style="gap: var(--sp-2);"><label for="offbalance-toggle-${c.id}" style="font-size: var(--fs-xs); color: var(--c-on-surface-secondary);" title="Marcar como 'Contabilidad B'">B</label><label class="form-switch"><input type="checkbox" id="offbalance-toggle-${c.id}" data-action="toggle-off-balance" data-id="${c.id}" ${c.offBalance ? 'checked' : ''}><span class="slider"></span></label></div><button class="icon-btn" data-action="edit-cuenta" data-id="${c.id}" title="Editar Cuenta"><span class="material-icons">edit_note</span></button><button class="icon-btn" data-action="delete-cuenta" data-id="${c.id}" title="Eliminar Cuenta"><span class="material-icons">delete_outline</span></button></div>
                    </div>`).join('');
        };
    
        const showAccountEditForm = (id) => {
            const itemContainer = select(`cuenta-item-${id}`);
            const cuenta = db.cuentas.find(c => c.id === id);
            if (!itemContainer || !cuenta) return;
            itemContainer.innerHTML = `
                <form class="inline-edit-form" data-id="${id}" novalidate>
                    <div class="form-grid">
                                                <div class="form-group" style="margin-bottom: 0;"><label class="form-label" for="edit-cuenta-nombre-${id}">Nombre</label><input type="text" id="edit-cuenta-nombre-${id}" class="form-input" value="${escapeHTML(cuenta.nombre)}" required></div>
                        <div class="form-group" style="margin-bottom: 0;"><label class="form-label" for="edit-cuenta-tipo-${id}">Tipo</label><input type="text" id="edit-cuenta-tipo-${id}" class="form-input" list="tipos-cuenta-list" value="${escapeHTML(cuenta.tipo)}" required></div>
                    </div>
                    <div style="display:flex; justify-content: flex-end; gap: var(--sp-2); align-items: center; margin-top: var(--sp-2);"><button type="button" class="btn btn--secondary" data-action="cancel-edit-cuenta">Cancelar</button><button type="button" class="btn btn--primary" data-action="save-edited-cuenta" data-id="${id}">Guardar</button></div>
                </form>`;
            select(`edit-cuenta-nombre-${id}`).focus();
        };
    
        const handleSaveEditedAccount = async (id, btn) => {
            const nombreInput = select(`edit-cuenta-nombre-${id}`);
            const tipoInput = select(`edit-cuenta-tipo-${id}`);
            const nombre = nombreInput.value.trim();
            const tipo = toSentenceCase(tipoInput.value.trim());
        
            if (!nombre || !tipo) { showToast('El nombre y el tipo no pueden estar vacíos.', 'warning'); if (!nombre) nombreInput.classList.add('form-input--invalid'); if (!tipo) tipoInput.classList.add('form-input--invalid'); return; }
            
            await saveDoc('cuentas', id, { nombre, tipo }, btn);
            hapticFeedback('success');
            showToast('Cuenta actualizada.');
            renderCuentasModalList();
        };

        const showRecurrentesModal = () => {
            let html = `<p class="form-label" style="margin-bottom: var(--sp-3);">Aquí puedes ver y gestionar tus operaciones programadas. Se crearán automáticamente en su fecha de ejecución.</p><div id="recurrentes-modal-list"></div>`;
            showGenericModal('Gestionar Movimientos Recurrentes', html);
            renderRecurrentesModalList();
        };
				
        const renderRecurrentesModalList = () => {
            const list = select('recurrentes-modal-list');
            if (!list) return;
            const recurrentes = [...(db.recurrentes || [])].sort((a,b) => new Date(a.nextDate) - new Date(b.nextDate));
            list.innerHTML = recurrentes.length === 0 
                ? `<div class="empty-state" style="background:transparent; padding:var(--sp-4) 0; border: none;"><span class="material-icons">event_repeat</span><h3>Sin operaciones programadas</h3><p>Puedes crear una al añadir un nuevo movimiento.</p></div>`
                : recurrentes.map(r => {
                    const nextDate = new Date(r.nextDate).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                    const frequencyMap = { daily: 'Diaria', weekly: 'Semanal', monthly: 'Mensual', yearly: 'Anual' };
                    const amountClass = r.cantidad >= 0 ? 'text-positive' : 'text-negative';
                    const icon = r.cantidad >= 0 ? 'south_west' : 'north_east';
                    return `
                    <div class="modal__list-item" id="recurrente-item-${r.id}">
                        <div style="display: flex; align-items: center; gap: 12px; flex-grow: 1; min-width: 0;">
                            <span class="material-icons ${amountClass}" style="font-size: 20px;">${icon}</span>
                        <div style="display: flex; flex-direction: column; min-width: 0;">
                                <span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(r.descripcion)}</span>
                                <small style="color: var(--c-on-surface-secondary); font-size: var(--fs-xs);">Próximo: ${nextDate} (${frequencyMap[r.frequency]})</small>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--sp-1); flex-shrink: 0;">
                            <strong class="${amountClass}" style="margin-right: var(--sp-2);">${formatCurrency(r.cantidad)}</strong>
                            <button class="icon-btn" data-action="edit-recurrente" data-id="${r.id}" title="Editar Recurrente"><span class="material-icons">edit</span></button>
                        </div>
                    </div>`
                }).join('');
        };

        const showManageInvestmentAccountsModal = () => {
            const visibleAccounts = getVisibleAccounts().sort((a, b) => a.nombre.localeCompare(b.nombre));
            let formHtml = `
            <form id="manage-investment-accounts-form" novalidate>
                <p class="form-label" style="margin-bottom: var(--sp-3);">
                    Selecciona las cuentas que quieres que formen parte de tu portafolio de inversión. Estas aparecerán en la sección "Portafolio" para un seguimiento detallado de su rentabilidad.
                </p>
                <div style="max-height: 40vh; overflow-y: auto; padding: var(--sp-2); background: var(--c-surface-variant); border-radius: var(--border-radius-md);">`;

            if (visibleAccounts.length > 0) {
                formHtml += visibleAccounts.map(c => `
                    <div class="form-checkbox-group modal__list-item" style="padding: var(--sp-2);">
                        <input type="checkbox" id="investment-toggle-${c.id}" value="${c.id}" ${c.esInversion ? 'checked' : ''}>
                        <label for="investment-toggle-${c.id}" style="flex-grow: 1;">${escapeHTML(c.nombre)} <small>(${toSentenceCase(c.tipo)})</small></label>
                    </div>
                `).join('');
            } else {
                formHtml += `<p class="empty-state" style="background: transparent; border: none;">No hay cuentas en la contabilidad actual para configurar.</p>`;
            }

            formHtml += `
                </div>
                <div class="modal__actions">
                    <button type="submit" class="btn btn--primary btn--full">Guardar Selección</button>
                </div>
            </form>`;

            showGenericModal('Gestionar Activos de Inversión', formHtml);
        };

        const showAportacionModal = (cuentaId = null) => {
            const investmentAccounts = getVisibleAccounts().filter(c => c.esInversion);
            if (investmentAccounts.length === 0) {
                showToast('Primero debes marcar al menos una cuenta como activo de inversión.', 'warning', 4000);
                return;
            }
            
            const fechaISO = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
            
            const accountsOptions = investmentAccounts
                .sort((a, b) => a.nombre.localeCompare(b.nombre))
                .map(c => `<option value="${c.id}" ${cuentaId === c.id ? 'selected' : ''}>${escapeHTML(c.nombre)}</option>`)
                .join('');

            let formHtml = `
            <form id="form-aportacion" novalidate>
                <p class="form-label" style="margin-bottom: var(--sp-3);">
                    Registra una entrada (aportación, positivo) o salida (retiro, negativo) de capital en uno de tus activos. Esto es crucial para calcular correctamente la rentabilidad (TIR).
                </p>
                <div class="form-group">
                    <label for="aportacion-cuenta" class="form-label">Activo de Inversión</label>
                    <select id="aportacion-cuenta" class="form-select">${accountsOptions}</select>
                </div>
                <div class="form-group">
                    <label for="aportacion-cantidad" class="form-label">Cantidad (retiro en negativo)</label>
                    <input type="text" id="aportacion-cantidad" class="form-input input-amount-calculator" inputmode="decimal" required placeholder="Ej: -250,50 para un retiro">
                </div>
                <div class="form-group">
                    <label for="aportacion-fecha" class="form-label">Fecha</label>
                    <input type="date" id="aportacion-fecha" class="form-input" value="${fechaISO}" required>
                </div>
                <div class="form-group">
                    <label for="aportacion-notas" class="form-label">Notas (Opcional)</label>
                    <input type="text" id="aportacion-notas" class="form-input" placeholder="Ej: Aportación periódica">
                </div>
                <div class="modal__actions">
                    <button type="submit" class="btn btn--primary">Guardar</button>
                </div>
            </form>`;

            showGenericModal('Registrar Aportación/Retiro', formHtml);
        };
        // =================================================================
// === INICIO: CÓDIGO FINAL PARA REEMPLAZAR attachEventListeners   ===
// =================================================================
        const attachEventListeners = () => {
            document.body.addEventListener('click', async (e) => {
                const target = e.target;

                if (target.matches('.input-amount-calculator')) {
                    e.preventDefault();
                    showCalculator(target);
                    return;
                }

                const actionTarget = target.closest('[data-action]');
                
                if (!actionTarget) {
                    if (!target.closest('.transaction-card')) {
                         resetActiveSwipe();
                    }
                    return;
                }

                const { action, id, page, type, modalId, view, filter } = actionTarget.dataset;
                const btn = actionTarget.closest('button');

                const actions = {
					 'show-informe-builder': showInformeBuilderModal,
                    'save-informe': () => handleSaveInforme(btn),
                    'show-help-topic': () => {
                        const topic = actionTarget.dataset.topic;
                        if (topic) {
                            let title, content;
                            if(topic === 'tir') {
                                title = 'TIR (Tasa Interna de Retorno)';
                                content = "<p>La TIR es la métrica de rentabilidad más precisa.</p><p>Te dice el <strong>beneficio anualizado real</strong> de tu inversión, como si fuera el tipo de interés que te daría un banco. Es inteligente porque tiene en cuenta no solo cuánto ha crecido tu dinero, sino también <strong>cuándo y cuánto capital</strong> has ido aportando o retirando a lo largo del tiempo.</p>";
                            } else if (topic === 'pace') {
                                title = 'Ritmo del Presupuesto (Pace)';
                                content = "<p>El 'Pace' o ritmo te ayuda a saber si vas por el buen camino para cumplir tu presupuesto anual.</p><p>Compara el porcentaje de tu presupuesto que has consumido hasta hoy con el porcentaje del año que ya ha transcurrido. Por ejemplo, si a mitad de año (50% del tiempo) has gastado el 75% de tu presupuesto anual para 'Ocio', tu ritmo indicará que vas 'Excedido'.</p>";
                            }

                            const titleEl = select('help-modal-title');
                            const bodyEl = select('help-modal-body');
                            
                            if (titleEl) titleEl.textContent = title;
                            if (bodyEl) bodyEl.innerHTML = `<div style="padding: 0 var(--sp-2);">${content}</div>`;
                            
                            showModal('help-modal');
                        }
                    },
                    'configure-dashboard': showDashboardConfigModal,
                    'save-dashboard-config': () => handleSaveDashboardConfig(btn),
                    'use-password-instead': () => showPasswordFallback(),
                    'toggle-theme': handleToggleTheme,
                    'toggle-investment-type-filter': () => handleToggleInvestmentTypeFilter(type),
                    'filter-investments': () => handleFilterInvestments(filter),
                    'confirm-recurrent': async (event) => {
                        const actionTarget = event.target.closest('[data-action]');
                        if (!actionTarget) return;
                        const { id } = actionTarget.dataset;
                        const btn = actionTarget.closest('button');
                        if (!id || !btn) return;
                        try {
                            setButtonLoading(btn, true);
                            const recurrente = db.recurrentes.find(r => r.id === id);
                            if (!recurrente) {
                                showToast('Error: No se encontró la operación recurrente.', 'danger');
                                return;
                            }
                            const fechaDeEjecucion = parseDateStringAsUTC(recurrente.nextDate);
                            const newMovement = {
                                id: generateId(),
                                fecha: new Date().toISOString(), // Usar timestamp actual para ordenación
                                cantidad: recurrente.cantidad,
                                descripcion: recurrente.descripcion,
                                tipo: recurrente.tipo,
                                cuentaId: recurrente.cuentaId,
                                conceptoId: recurrente.conceptoId,
                                cuentaOrigenId: recurrente.cuentaOrigenId,
                                cuentaDestinoId: recurrente.cuentaDestinoId,
                                sourceRecurrenceId: recurrente.id
                            };
                            const newNextDate = calculateNextDueDate(fechaDeEjecucion, recurrente.frequency);
                            const newNextDateString = newNextDate.toISOString().slice(0, 10);
                            
                            // Usar un batch para asegurar atomicidad
                            const batch = fbDb.batch();
                            const movRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(newMovement.id);
                            const recRef = fbDb.collection('users').doc(currentUser.uid).collection('recurrentes').doc(id);
                            
                            batch.set(movRef, newMovement);
                            batch.update(recRef, { nextDate: newNextDateString });
                            
                            await batch.commit();

                            // Actualizar saldos después de confirmar el batch
                            if (newMovement.tipo === 'traspaso') {
                                await updateAccountBalance(newMovement.cuentaOrigenId, -newMovement.cantidad);
                                await updateAccountBalance(newMovement.cuentaDestinoId, newMovement.cantidad);
                            } else {
                                await updateAccountBalance(newMovement.cuentaId, newMovement.cantidad);
                            }
                            
                            hapticFeedback('success');
                            showToast('Movimiento programado añadido.');

                            // Actualizar la UI
                            const activeView = document.querySelector('.view--active');
                            if (activeView && activeView.id === PAGE_IDS.MOVIMIENTOS) await loadInitialMovements();


                        } catch (error) {
                            console.error("Error al confirmar el movimiento recurrente:", error);
                            showToast("No se pudo añadir el movimiento. Revisa tu conexión.", "danger");
                        } finally {
                            setButtonLoading(btn, false);
                        }
                    },
                    'skip-recurrent': async (event) => {
                        const actionTarget = event.target.closest('[data-action]');
                        if (!actionTarget) return;
                        const { id } = actionTarget.dataset;
                        const recurrente = db.recurrentes.find(r => r.id === id);
                        if (!recurrente) {
                            showToast('Error: No se encontró la operación recurrente.', 'danger');
                            return;
                        }
                        try {
                            const fechaDeEjecucion = parseDateStringAsUTC(recurrente.nextDate);
                            const newNextDate = calculateNextDueDate(fechaDeEjecucion, recurrente.frequency);
                            const newNextDateString = newNextDate.toISOString().slice(0, 10);
                            await saveDoc('recurrentes', id, { nextDate: newNextDateString });
                            hapticFeedback('success');
                            showToast('Operación omitida. Programada para la siguiente fecha.');
                        } catch (error) {
                            console.error("Error al omitir el movimiento recurrente:", error);
                            showToast("No se pudo omitir la operación. Revisa tu conexión.", "danger");
                        }
                    },
                    'navigate': () => navigateTo(page),
                    'help': showHelpModal,
                    'exit': handleExitApp,
                    'forgot-password': (e) => { e.preventDefault(); const email = prompt("Por favor, introduce el correo electrónico de tu cuenta para restablecer la contraseña:"); if (email) { firebase.auth().sendPasswordResetEmail(email).then(() => { showToast('Se ha enviado un correo para restablecer tu contraseña.', 'info', 5000); }).catch((error) => { console.error("Error al enviar correo de recuperación:", error); if (error.code === 'auth/user-not-found') { showToast('No se encontró ninguna cuenta con ese correo.', 'danger'); } else { showToast('Error al intentar restablecer la contraseña.', 'danger'); } }); } },
                    'show-register': (e) => { e.preventDefault(); const title = select('login-title'); const mainButton = document.querySelector('#login-form button[data-action="login"]'); const secondaryAction = document.querySelector('.login-view__secondary-action'); if (mainButton.dataset.action === 'login') { title.textContent = 'Crear una Cuenta Nueva'; mainButton.dataset.action = 'register'; mainButton.textContent = 'Registrarse'; secondaryAction.innerHTML = `<span>¿Ya tienes una cuenta?</span> <a href="#" class="login-view__link" data-action="show-login">Inicia sesión</a>`; } else { handleRegister(mainButton); } },
                    'show-login': (e) => { e.preventDefault(); const title = select('login-title'); const mainButton = document.querySelector('#login-form button[data-action="register"]'); const secondaryAction = document.querySelector('.login-view__secondary-action'); if (mainButton.dataset.action === 'register') { title.textContent = 'Bienvenido de nuevo'; mainButton.dataset.action = 'login'; mainButton.textContent = 'Iniciar Sesión'; secondaryAction.innerHTML = `<span>¿No tienes una cuenta?</span> <a href="#" class="login-view__link" data-action="show-register">Regístrate aquí</a>`; } },
                    'import-csv': showCsvImportWizard,
                    'toggle-ledger': async () => { hapticFeedback('medium'); isOffBalanceMode = !isOffBalanceMode; document.body.dataset.ledgerMode = isOffBalanceMode ? 'B' : 'A'; const activePageEl = selectOne('.view--active'); const activePage = activePageEl ? activePageEl.id : PAGE_IDS.INICIO; navigateTo(activePage, false); showToast(`Mostrando Contabilidad ${isOffBalanceMode ? 'B' : 'A'}.`, 'info'); },
                    'toggle-off-balance': async () => { const checkbox = target.closest('input[type="checkbox"]'); if (!checkbox) return; hapticFeedback('light'); await saveDoc('cuentas', checkbox.dataset.id, { offBalance: checkbox.checked }); },
                    'apply-filters': () => { hapticFeedback('light'); updateDashboardData(); },
                    'apply-informe-filters': () => { hapticFeedback('light'); renderInformesPage(); },
                    'add-movement': () => startMovementForm(),
                    'edit-movement': async () => { if (select('generic-modal')?.classList.contains('modal-overlay--active')) { hideModal('generic-modal'); } let movementData = db.movimientos.find(m => m.id === id); if (!movementData) { movementData = recentMovementsCache.find(item => item.id === id); } if (!movementData && id) { try { const movRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(id); const doc = await movRef.get(); if (doc.exists) { movementData = { id: doc.id, ...doc.data() }; if (!db.movimientos.some(m => m.id === id)) { db.movimientos.push(movementData); } } else { showToast('Error: No se encontró el movimiento.', 'danger'); return; } } catch (error) { console.error("Error al obtener el movimiento:", error); showToast('No se pudo cargar el movimiento para editar.', 'danger'); return; } } startMovementForm(id, false); },
					 'edit-movement-from-list': () => {
						const card = actionTarget.closest('.transaction-card');
						if (card && card.dataset.id) {
						startMovementForm(card.dataset.id, false);
						}
					},
                    'edit-recurrente': () => { hideModal('generic-modal'); startMovementForm(id, true); },
                    'delete-movement-from-modal': () => {
                        const isRecurrent = (actionTarget.dataset.isRecurrent === 'true');
                        const idToDelete = select('movimiento-id').value;
                        const message = isRecurrent ? '¿Seguro que quieres eliminar esta operación recurrente?' : '¿Seguro que quieres eliminar este movimiento?';
                        showConfirmationModal(message, async () => {
                            hideModal('movimiento-modal');
                            await deleteMovementAndAdjustBalance(idToDelete, isRecurrent);
                        });
                    },
                    'swipe-delete-movement': () => {
                        const isRecurrent = actionTarget.dataset.isRecurrent === 'true';
                        const message = '¿Seguro que quieres eliminar este movimiento?';
                        showConfirmationModal(message, async () => {
                            await deleteMovementAndAdjustBalance(id, isRecurrent);
                        });
                    },
                    'swipe-duplicate-movement': () => {
                        const idToDuplicate = actionTarget.dataset.id;
                        const movementToDuplicate = db.movimientos.find(m => m.id === idToDuplicate) || recentMovementsCache.find(m => m.id === idToDuplicate);
                        if (movementToDuplicate) {
                            startMovementForm();
                            setTimeout(() => {
                                select('movimiento-mode').value = 'new';
                                select('movimiento-id').value = '';
                                
                                if (movementToDuplicate.tipo === 'traspaso') {
                                    setMovimientoFormType('traspaso');
                                    select('movimiento-cuenta-origen').value = movementToDuplicate.cuentaOrigenId;
                                    select('movimiento-cuenta-destino').value = movementToDuplicate.cuentaDestinoId;
                                } else {
                                    setMovimientoFormType('movimiento');
                                    select('movimiento-cuenta').value = movementToDuplicate.cuentaId;
                                    select('movimiento-concepto').value = movementToDuplicate.conceptoId;
                                }
                                
                                select('movimiento-cantidad').value = (movementToDuplicate.cantidad / 100).toLocaleString('es-ES', { minimumFractionDigits: 2, useGrouping: false });
                                select('movimiento-descripcion').value = movementToDuplicate.descripcion;
                                
                                const today = new Date();
                                select('movimiento-fecha').value = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
                                updateDateDisplay(select('movimiento-fecha'));
                                
                                select('form-movimiento-title').textContent = 'Duplicar Movimiento';
                                select('delete-movimiento-btn').classList.add('hidden');
                                select('duplicate-movimiento-btn').classList.add('hidden');
                                
                                hapticFeedback('success');
                                showToast('Datos duplicados. Ajusta y guarda.', 'info');
                            }, 50);
                        }
                        resetActiveSwipe();
                    },
                    'delete-concepto': async () => { const movsCheck = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').where('conceptoId', '==', id).limit(1).get(); if(!movsCheck.empty) { showToast("Concepto en uso, no se puede borrar.","warning"); return; } showConfirmationModal('¿Seguro que quieres eliminar este concepto?', async () => { await deleteDoc('conceptos', id); hapticFeedback('success'); showToast("Concepto eliminado."); }); },
                    'delete-cuenta': async () => { const movsCheck = await fbDb.collection('users').doc(currentUser.uid).collection('movimientos').where('cuentaId', '==', id).limit(1).get(); if(!movsCheck.empty) { showToast("Cuenta con movimientos, no se puede borrar.","warning",3500); return; } showConfirmationModal('¿Seguro que quieres eliminar esta cuenta?', async () => { await deleteDoc('cuentas', id); hapticFeedback('success'); showToast("Cuenta eliminada."); }); },
                    'close-modal': () => { const closestOverlay = target.closest('.modal-overlay'); const effectiveModalId = modalId || (closestOverlay ? closestOverlay.id : null); if ((effectiveModalId === 'generic-modal') && detailInvestmentChart) { detailInvestmentChart.destroy(); detailInvestmentChart = null; } if (effectiveModalId) hideModal(effectiveModalId); },
                    'manage-conceptos': showConceptosModal,
                    'manage-cuentas': showCuentasModal,
                    'manage-recurrentes': showRecurrentesModal,
                    'view-account-details': () => showAccountMovementsModal(id),
                    'save-config': () => handleSaveConfig(btn),
                    'export-data': () => handleExportData(btn),
                    'export-csv': () => handleExportCsv(btn),
                    'import-data': () => showImportJSONWizard(),
                    'clear-data': () => { showConfirmationModal('¿Seguro que quieres borrar TODOS tus datos financieros? Esta acción es irreversible.', () => { showConfirmationModal('Esta es tu última oportunidad. ¿Estás absolutamente seguro?', () => { const button = actionTarget.closest('button'); handleDeleteAllData(button); }, 'Confirmación Final'); }); },
                    'toggle-account-type-filter': () => { hapticFeedback('light'); if(deselectedAccountTypesFilter.has(type)) { deselectedAccountTypesFilter.delete(type); } else { deselectedAccountTypesFilter.add(type); } renderPatrimonioPage(); },
                    'update-budgets': handleUpdateBudgets,
                    'logout': () => showConfirmationModal('¿Seguro que quieres cerrar la sesión?', () => { localStorage.removeItem('pinUserHash'); localStorage.removeItem('pinUserEmail'); fbAuth.signOut().then(() => { showToast('Sesión cerrada correctamente.'); }).catch(() => { showToast('Error al cerrar sesión.', 'danger'); }); }, 'Cerrar Sesión'),
                    'delete-account': () => { const button = actionTarget.closest('button'); handleDeleteAccount(button) },
                    'view-investment-detail': () => renderInvestmentAccountDetail(id),
                    'manage-investment-accounts': showManageInvestmentAccountsModal,
                    'add-aportacion': () => showAportacionModal(),
                    'update-asset-value': () => showValoracionModal(id),
                    'global-search': showGlobalSearchModal,
                    'search-result-movimiento': () => { hideModal('global-search-modal'); startMovementForm(id, false); },
                    'search-result-cuenta': () => { hideModal('global-search-modal'); showCuentasModal(); setTimeout(() => { const el = select(`cuenta-item-${id}`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 200); },
                    'search-result-concepto': () => { hideModal('global-search-modal'); showConceptosModal(); setTimeout(() => { const el = select(`concepto-item-${id}`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 200); },
                    'edit-concepto': () => showConceptoEditForm(id),
                    'cancel-edit-concepto': renderConceptosModalList,
                    'save-edited-concepto': () => handleSaveEditedConcept(id, btn),
                    'edit-cuenta': () => showAccountEditForm(id),
                    'cancel-edit-cuenta': renderCuentasModalList,
                    'save-edited-cuenta': () => handleSaveEditedAccount(id, btn),
                    'duplicate-movement': () => handleDuplicateMovement(),
                    'save-and-new-movement': () => handleSaveAndNewMovement(document.getElementById('form-movimiento'), btn),
                    'set-movimiento-type': () => setMovimientoFormType(type),
                    'recalculate-balances': () => { showConfirmationModal( 'Esta acción leerá todo tu historial de transacciones para recalcular y corregir el saldo de cada una de tus cuentas. Es útil si sospechas que hay errores en los saldos. ¿Quieres continuar?', () => { const button = actionTarget.closest('button'); recalculateAllAccountBalances(button)}, 'Confirmar Recálculo de Saldos' ); },
                    'json-wizard-back-2': () => goToJSONStep(1),
                    'json-wizard-import-final': () => handleFinalJsonImport(btn),
                    'toggle-traspaso-accounts-filter': () => populateTraspasoDropdowns(),
                    'set-pin': async () => {
                        const pin = prompt("Introduce tu nuevo PIN de 4 dígitos. Déjalo en blanco para eliminarlo.");
                        if (pin === null) return;
                
                        if (pin === "") {
                            localStorage.removeItem('pinUserHash');
                            localStorage.removeItem('pinUserEmail');
                            showToast('PIN de acceso rápido eliminado.', 'info');
                            return;
                        }
                
                        if (!/^\d{4}$/.test(pin)) {
                            showToast('El PIN debe contener exactamente 4 dígitos numéricos.', 'danger');
                            return;
                        }
                
                        const pinConfirm = prompt("Confirma tu nuevo PIN de 4 dígitos.");
                        if (pin !== pinConfirm) {
                            showToast('Los PINs no coinciden. Inténtalo de nuevo.', 'danger');
                            return;
                        }
                        
                        const pinHash = await hashPin(pin);
                        localStorage.setItem('pinUserHash', pinHash);
                        localStorage.setItem('pinUserEmail', currentUser.email);
                        hapticFeedback('success');
                        showToast('¡PIN de acceso rápido configurado con éxito!', 'info');
                    },
                };
                
                if (actions[action]) {
                    actions[action](e);
                }
            });
			
            document.body.addEventListener('submit', (e) => {
                e.preventDefault();
                const target = e.target;
                const submitter = e.submitter;
                const handlers = {
                    'login-form': () => { const action = submitter ? submitter.dataset.action : 'login'; if (action === 'login') { handleLogin(submitter); } else if (action === 'register') { handleRegister(submitter); } },
                    'pin-form': handlePinSubmit,
                    'form-movimiento': () => handleSaveMovement(target, submitter),
                    'add-concepto-form': () => handleAddConcept(submitter),
                    'add-cuenta-form': () => handleAddAccount(submitter),
                    'manage-investment-accounts-form': () => handleSaveInvestmentAccounts(target, submitter),
                    'form-aportacion': () => handleSaveAportacion(target, submitter),
                    'form-valoracion': () => handleSaveValoracion(target, submitter),
                };
                if (handlers[target.id]) {
                    handlers[target.id]();
                }
            });

            document.body.addEventListener('input', (e) => {
                const id = e.target.id;
                if (id) {
                    clearError(id);
                    if (id === 'movimiento-cantidad') validateField('movimiento-cantidad', true);
                    if (id === 'movimiento-descripcion') handleDescriptionInput();
                    if (id === 'movimiento-concepto' || id === 'movimiento-cuenta') validateField(id, true);
                    if (id === 'movimiento-cuenta-origen' || id === 'movimiento-cuenta-destino') {
                         validateField('movimiento-cuenta-origen', true);
                         validateField('movimiento-cuenta-destino', true);
                    }
                    if (id === 'concepto-search-input') { clearTimeout(globalSearchDebounceTimer); globalSearchDebounceTimer = setTimeout(() => renderConceptosModalList(), 200); }
                    if (id === 'cuenta-search-input') { clearTimeout(globalSearchDebounceTimer); globalSearchDebounceTimer = setTimeout(() => renderCuentasModalList(), 200); }
                }
            });

            document.body.addEventListener('blur', (e) => {
                const id = e.target.id;
                if (id) {
                    if (id === 'movimiento-cantidad') validateField('movimiento-cantidad');
                    if (id === 'movimiento-descripcion') {
                        handleDescriptionAutocomplete();
                        if (!e.relatedTarget || !e.relatedTarget.closest('#description-suggestions')) {
                            const suggestionsBox = select('description-suggestions');
                            if (suggestionsBox) suggestionsBox.style.display = 'none';
                        }
                    }
                    if (id === 'movimiento-concepto' || id === 'movimiento-cuenta') validateField(id);
                    if (id === 'movimiento-cuenta-origen' || id === 'movimiento-cuenta-destino') {
                         validateField('movimiento-cuenta-origen');
                         validateField('movimiento-cuenta-destino');
                    }
                }
            }, true);

            document.body.addEventListener('focusin', (e) => {
                if (e.target.matches('.pin-input')) {
                    handlePinInputInteraction();
                }
                if (e.target.id === 'movimiento-descripcion') {
                    handleDescriptionInput();
                }
            });

            document.addEventListener('change', e => {
                const target = e.target;
                if (target.id === 'filter-periodo') { const el = select('custom-date-filters'); if (el) el.classList.toggle('hidden', target.value !== 'custom'); }
                if (target.id === 'movimiento-recurrente') { select('recurrent-options').classList.toggle('hidden', !target.checked); if(target.checked && !select('recurrent-next-date').value) { select('recurrent-next-date').value = select('movimiento-fecha').value; } }
            });

            const importFileInput = select('import-file-input');
            if (importFileInput) importFileInput.addEventListener('change', (e) => { if(e.target.files) handleJSONFileSelect(e.target.files[0]); });
            
            const calculatorGrid = select('calculator-grid');
            if (calculatorGrid) calculatorGrid.addEventListener('click', (e) => { const btn = e.target.closest('button'); if(btn && btn.dataset.key) handleCalculatorInput(btn.dataset.key); });
            
            const searchInput = select('global-search-input');
            if (searchInput) searchInput.addEventListener('input', () => { clearTimeout(globalSearchDebounceTimer); globalSearchDebounceTimer = setTimeout(() => { performGlobalSearch(searchInput.value); }, 250); });
            
            document.body.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); e.stopPropagation(); showGlobalSearchModal(); }
            });

            const mainScroller = selectOne('.app-layout__main');
            if (mainScroller) mainScroller.addEventListener('scroll', () => {
                const activePage = select('.view--active');
                if (!activePage || activePage.id !== PAGE_IDS.MOVIMIENTOS) return;
                const { scrollTop, scrollHeight, clientHeight } = mainScroller;
                if (scrollHeight - scrollTop - clientHeight < 400) {
                    loadMoreMovements();
                }
            });
            
            const dropZone = select('json-drop-zone');
            if (dropZone) {
                dropZone.addEventListener('click', () => { const el = select('import-file-input'); if (el) el.click() });
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
                dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); const files = e.dataTransfer.files; if (files && files.length > 0) handleJSONFileSelect(files[0]); });
            }

            const suggestionsBox = select('description-suggestions');
            if (suggestionsBox) {
                suggestionsBox.addEventListener('click', (e) => {
                    const suggestionItem = e.target.closest('.suggestion-item');
                    if (suggestionItem) {
                        const description = suggestionItem.dataset.description;
                        const conceptoId = suggestionItem.dataset.conceptoId;
                        const cuentaId = suggestionItem.dataset.cuentaId;
                        applyDescriptionSuggestion(description, conceptoId, cuentaId);
                    }
                });
            }

            const fechaDisplayButton = select('movimiento-fecha-display');
            const fechaRealInput = select('movimiento-fecha');
            if (fechaDisplayButton && fechaRealInput) {
                fechaDisplayButton.addEventListener('click', () => fechaRealInput.showPicker());
                fechaRealInput.addEventListener('input', () => updateDateDisplay(fechaRealInput));
            }

            const listContainer = select('virtual-list-content');
            if (listContainer) {
                listContainer.addEventListener('pointerdown', handleSwipeStart, { passive: true });
                listContainer.addEventListener('pointermove', handleSwipeMove, { passive: true });
                listContainer.addEventListener('pointerup', handleSwipeEnd);
                listContainer.addEventListener('pointercancel', handleSwipeEnd);
            }
        };
// =================================================================
// === FIN: CÓDIGO FINAL PARA REEMPLAZAR attachEventListeners      ===
// =================================================================
    const handleSwipeStart = (e) => {
    const card = e.target.closest('.transaction-card');
    // Solo activamos para movimientos reales, no para los recurrentes pendientes
    if (!card || !card.dataset.id) return;

    if (swipeState.activeCard && swipeState.activeCard !== card) {
        resetActiveSwipe();
    }

    swipeState.activeCard = card;
    swipeState.startX = e.clientX;
    swipeState.currentX = e.clientX;
    swipeState.isSwiping = true;
    card.style.transition = 'none';

    // === INICIO: Lógica de Pulsación Larga ===
    longPressState.isTriggered = false;
    longPressState.startX = e.clientX;
    longPressState.startY = e.clientY;
    
    longPressState.timer = setTimeout(() => {
        longPressState.isTriggered = true;
        swipeState.isSwiping = false; // Detenemos cualquier posible swipe
        hapticFeedback('medium');
        const movementId = swipeState.activeCard.dataset.id;
        startMovementForm(movementId, false);
    }, longPressState.DURATION);
    // === FIN: Lógica de Pulsación Larga ===
};

const handleSwipeMove = (e) => {
    // === INICIO: Cancelar Pulsación Larga si hay movimiento ===
    if (longPressState.timer) {
        const diffX = Math.abs(e.clientX - longPressState.startX);
        const diffY = Math.abs(e.clientY - longPressState.startY);
        if (diffX > longPressState.TOLERANCE || diffY > longPressState.TOLERANCE) {
            clearTimeout(longPressState.timer);
            longPressState.timer = null;
        }
    }
    // === FIN: Cancelar Pulsación Larga si hay movimiento ===

    if (!swipeState.isSwiping || !swipeState.activeCard) return;

    swipeState.currentX = e.clientX;
    const diff = swipeState.currentX - swipeState.startX;
    
    const limitedDiff = Math.max(-75, Math.min(75, diff));

    swipeState.activeCard.style.transform = `translateX(${limitedDiff}px)`;
};

const handleSwipeEnd = (e) => {
    // === INICIO: Limpieza y gestión de Pulsación Larga ===
    if (longPressState.timer) {
        clearTimeout(longPressState.timer);
        longPressState.timer = null;
    }

    if (longPressState.isTriggered) {
        longPressState.isTriggered = false;
        swipeState.isSwiping = false;
        // La acción ya fue ejecutada por el temporizador, así que no hacemos nada más.
        return;
    }
    // === FIN: Limpieza y gestión de Pulsación Larga ===

    if (!swipeState.isSwiping || !swipeState.activeCard) return;

    const diff = swipeState.currentX - swipeState.startX;
    swipeState.activeCard.style.transition = 'transform 0.3s ease-out';

    if (Math.abs(diff) > swipeState.threshold) {
        const direction = diff > 0 ? 'right' : 'left';
        swipeState.activeCard.style.transform = `translateX(${direction === 'right' ? '75px' : '-75px'})`;
        hapticFeedback('light');
    } else {
        // Si no fue un swipe ni una pulsación larga, simplemente reseteamos.
        swipeState.activeCard.style.transform = 'translateX(0px)';
        swipeState.activeCard = null;
    }
    swipeState.isSwiping = false;
};

const resetActiveSwipe = () => {
    if (swipeState.activeCard) {
        swipeState.activeCard.style.transition = 'transform 0.3s ease-out';
        swipeState.activeCard.style.transform = 'translateX(0px)';
        swipeState.activeCard = null;
    }
};

        
        const showImportJSONWizard = () => {
            jsonWizardState = { file: null, data: null, preview: { counts: {}, meta: {} } };
            goToJSONStep(1);
            const errorEl = select('json-file-error');
            const textEl = select('json-drop-zone-text');
            if(errorEl) errorEl.textContent = '';
            if(textEl) textEl.textContent = 'Arrastra tu archivo aquí o haz clic';
            showModal('json-import-wizard-modal');
        };

        const goToJSONStep = (stepNumber) => {
            selectAll('.json-wizard-step').forEach(step => step.style.display = 'none');
            const targetStep = select(`json-wizard-step-${stepNumber}`);
            if (targetStep) targetStep.style.display = 'flex';
        };

        const handleJSONFileSelect = (file) => {
            const errorEl = select('json-file-error');
            if(!errorEl) return;
            errorEl.textContent = '';

            if (!file.type.includes('json')) {
                errorEl.textContent = 'Error: El archivo debe ser de tipo .json.';
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    let data = JSON.parse(event.target.result);
                    let dataToAnalyze = data;

                    if (data.meta && data.data) {
                        jsonWizardState.preview.meta = data.meta;
                        dataToAnalyze = data.data;
                    } else {
                        jsonWizardState.preview.meta = { appName: 'Cuentas (Formato Antiguo)', exportDate: 'N/A' };
                    }

                    if (!dataToAnalyze.cuentas || !dataToAnalyze.conceptos || !dataToAnalyze.movimientos) {
                        throw new Error("El archivo no tiene la estructura de una copia de seguridad válida.");
                    }

                    jsonWizardState.data = dataToAnalyze;
                    
                    const counts = {};
                    for (const key in dataToAnalyze) {
                        if (Array.isArray(dataToAnalyze[key])) {
                            counts[key] = dataToAnalyze[key].length;
                        }
                    }
                    jsonWizardState.preview.counts = counts;
                    
                    renderJSONPreview();
                    goToJSONStep(2);

                } catch (error) {
                    console.error("Error al procesar el archivo JSON:", error);
                    errorEl.textContent = `Error: ${error.message}`;
                }
            };
            reader.readAsText(file);
        };

        const renderJSONPreview = () => {
            const previewList = select('json-preview-list');
            if(!previewList) return;
            const { counts } = jsonWizardState.preview;
            
            const friendlyNames = {
                cuentas: 'Cuentas', conceptos: 'Conceptos', movimientos: 'Movimientos',
                presupuestos: 'Presupuestos', recurrentes: 'Recurrentes',
                inversiones_historial: 'Historial de Inversión', inversion_cashflows: 'Flujos de Capital'
            };
            
            let html = '';
            for(const key in counts) {
                if(counts[key] > 0) {
                    html += `<li><span class="material-icons">check_circle</span> <strong>${counts[key]}</strong> ${friendlyNames[key] || key}</li>`;
                }
            }
            
            previewList.innerHTML = html || `<li><span class="material-icons">info</span>El archivo parece estar vacío.</li>`;
        };

        const handleFinalJsonImport = async (btn) => {
            goToJSONStep(3);
            setButtonLoading(btn, true, 'Importando...');
            select('json-import-progress').style.display = 'block';
            select('json-import-result').style.display = 'none';

            try {
                const dataToImport = jsonWizardState.data;
                const collectionsToClear = ['cuentas', 'conceptos', 'movimientos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];

                for (const collectionName of collectionsToClear) {
                    const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).get();
                    if (snapshot.empty) continue;
                    let batch = fbDb.batch();
                    let count = 0;
                    for (const doc of snapshot.docs) {
                        batch.delete(doc.ref);
                        count++;
                        if (count >= 450) { await batch.commit(); batch = fbDb.batch(); count = 0; }
                    }
                    if(count > 0) await batch.commit();
                }
                
                for (const collectionName of Object.keys(dataToImport)) {
                    const items = dataToImport[collectionName];
                    if (Array.isArray(items) && items.length > 0) {
                        let batch = fbDb.batch();
                        let count = 0;
                        for (const item of items) {
                            if (item.id) {
                                const docRef = fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(item.id);
                                batch.set(docRef, item);
                                count++;
                                if (count >= 450) { await batch.commit(); batch = fbDb.batch(); count = 0; }
                            }
                        }
                        if(count > 0) await batch.commit();
                    } else if (collectionName === 'config') {
                        await fbDb.collection('users').doc(currentUser.uid).set({ config: items }, { merge: true });
                    }
                }
                
                select('json-import-progress').style.display = 'none';
                select('json-import-result').style.display = 'block';
                select('json-result-message').textContent = `Se han importado los datos correctamente. La aplicación se recargará.`;
                hapticFeedback('success');
                
                setTimeout(() => location.reload(), 4000);

            } catch (error) {
                console.error("Error durante la importación final:", error);
                showToast("Error crítico durante la importación.", "danger", 5000);
                select('json-result-title').textContent = '¡Error en la Importación!';
                select('json-result-message').textContent = `Ocurrió un error. Por favor, revisa la consola e inténtalo de nuevo.`;
                select('json-import-result .material-icons').style.color = 'var(--c-danger)';
                setButtonLoading(btn, false);
            }
        };

        const handleDuplicateMovement = () => {
            hapticFeedback('medium');
            select('movimiento-mode').value = 'new';
            select('movimiento-id').value = '';
            select('form-movimiento-title').textContent = 'Duplicar Movimiento';
            select('delete-movimiento-btn').classList.add('hidden');
            select('duplicate-movimiento-btn').classList.add('hidden');
            const today = new Date();
            select('movimiento-fecha').value = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
            showToast('Datos duplicados. Ajusta y guarda.', 'info');
        };

const handleDescriptionAutocomplete = () => {
    const descriptionInput = select('movimiento-descripcion');
    const conceptoSelect = select('movimiento-concepto');
    const cuentaSelect = select('movimiento-cuenta');

    if (!descriptionInput || !conceptoSelect || !cuentaSelect) return;
    
    if (conceptoSelect.value || cuentaSelect.value) {
        return;
    }

    const key = descriptionInput.value.trim().toLowerCase();
    
    if (intelligentIndex.has(key)) {
        const suggestion = intelligentIndex.get(key);
        
        conceptoSelect.value = suggestion.conceptoId;
        cuentaSelect.value = suggestion.cuentaId;
        
        hapticFeedback('light');
        const conceptoParent = conceptoSelect.closest('.form-group-addon');
        const cuentaParent = cuentaSelect.closest('.form-group-addon');
        
        if (conceptoParent) {
            conceptoParent.classList.add('field-highlighted');
            setTimeout(() => conceptoParent.classList.remove('field-highlighted'), 1500);
        }
        if (cuentaParent) {
            cuentaParent.classList.add('field-highlighted');
            setTimeout(() => cuentaParent.classList.remove('field-highlighted'), 1500);
        }

        showToast('Concepto y cuenta autocompletados.', 'info', 2000);
    }
};

const handleSaveAndNewMovement = async (form, btn) => {
    const fechaActual = select('movimiento-fecha').value;
    const tipoActual = select('mov-type-btn-traspaso').classList.contains('filter-pill--active') ? 'traspaso' : 'movimiento';

    const guardadoExitoso = await handleSaveMovement(form, btn, true);

    if (guardadoExitoso) {
        showToast('Guardado. Listo para el siguiente.', 'info');
        
        startMovementForm(null); 
        
        select('movimiento-fecha').value = fechaActual;
        updateDateDisplay(select('movimiento-fecha'));
        setMovimientoFormType(tipoActual);
    }
};

   // ==============================================================
// === INICIO: FUNCIÓN CORREGIDA Y ROBUSTA PARA GUARDAR CAMBIOS ===
// ==============================================================
const handleSaveMovement = async (form, btn, isSaveAndNew = false) => {
    clearAllErrors(form.id);
    if (!validateMovementForm()) {
        hapticFeedback('error');
        showToast('Por favor, revisa los campos marcados en rojo.', 'warning');
        return false; // Indica que el guardado falló
    }

    setButtonLoading(btn, true);

    const type = select('mov-type-btn-traspaso').classList.contains('filter-pill--active') ? 'traspaso' : 'movimiento';
    const cantidadValue = parseCurrencyString(select('movimiento-cantidad').value);

    const mode = select('movimiento-mode').value;
    const movementId = select('movimiento-id').value; // En "new", estará vacío

    // Preparamos los datos del nuevo movimiento a partir del formulario
    const dataFromForm = {
        id: movementId || generateId(),
        cantidad: Math.round(cantidadValue * 100),
        descripcion: (type === 'traspaso' && select('movimiento-descripcion').value.trim() === '') ? 'Traspaso' : select('movimiento-descripcion').value.trim(),
        tipo: type,
        fecha: parseDateStringAsUTC(select('movimiento-fecha').value).toISOString(),
        cuentaId: select('movimiento-cuenta').value,
        conceptoId: select('movimiento-concepto').value,
        cuentaOrigenId: select('movimiento-cuenta-origen').value,
        cuentaDestinoId: select('movimiento-cuenta-destino').value,
    };
    if (dataFromForm.tipo === 'traspaso') {
        dataFromForm.cantidad = Math.abs(dataFromForm.cantidad);
    }
    
    try {
        // Este es el "cerebro" de la operación, una transacción que asegura que todo se haga bien o no se haga nada.
        await fbDb.runTransaction(async (transaction) => {
            let oldMovementData = null;
            // Si estamos en modo edición, primero necesitamos los datos antiguos.
            if (mode.startsWith('edit')) {
                const oldDocRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(movementId);
                const oldDoc = await transaction.get(oldDocRef);
                if (oldDoc.exists) {
                    oldMovementData = oldDoc.data();
                }
            }

            // Paso 1: Revertir el saldo del movimiento antiguo (si existía).
            if (oldMovementData) {
                if (oldMovementData.tipo === 'traspaso') {
                    transaction.update(fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(oldMovementData.cuentaOrigenId), { saldo: firebase.firestore.FieldValue.increment(oldMovementData.cantidad) });
                    transaction.update(fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(oldMovementData.cuentaDestinoId), { saldo: firebase.firestore.FieldValue.increment(-oldMovementData.cantidad) });
                } else {
                    transaction.update(fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(oldMovementData.cuentaId), { saldo: firebase.firestore.FieldValue.increment(-oldMovementData.cantidad) });
                }
            }

            // Paso 2: Aplicar el saldo del nuevo movimiento.
            if (dataFromForm.tipo === 'traspaso') {
                transaction.update(fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(dataFromForm.cuentaOrigenId), { saldo: firebase.firestore.FieldValue.increment(-dataFromForm.cantidad) });
                transaction.update(fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(dataFromForm.cuentaDestinoId), { saldo: firebase.firestore.FieldValue.increment(dataFromForm.cantidad) });
            } else {
                transaction.update(fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(dataFromForm.cuentaId), { saldo: firebase.firestore.FieldValue.increment(dataFromForm.cantidad) });
            }

            // Paso 3: Guardar el documento del movimiento (sea nuevo o una sobreescritura del antiguo).
            const movRef = fbDb.collection('users').doc(currentUser.uid).collection('movimientos').doc(dataFromForm.id);
            transaction.set(movRef, dataFromForm);
        });

        // Si llegamos aquí, la transacción fue un éxito.
        if (mode === 'new') {
            newMovementIdToHighlight = dataFromForm.id;
        }

        setButtonLoading(btn, false);
        
        if (!isSaveAndNew) { // Solo cerramos el modal si NO es "Guardar y Nuevo"
            hideModal('movimiento-modal');
        }
        
        hapticFeedback('success');
        // No mostramos toast si es "Guardar y Nuevo" para no saturar.
        if (!isSaveAndNew) {
            showToast(mode === 'new' ? 'Movimiento guardado.' : 'Movimiento actualizado.');
        }
        
        buildIntelligentIndex();
        
        // Forzamos el refresco de la lista de movimientos para ver los cambios al instante.
        const movimientosPage = select(PAGE_IDS.MOVIMIENTOS);
        if (movimientosPage && movimientosPage.classList.contains('view--active')) {
            await loadInitialMovements();
        }

        return true; // Devolvemos 'true' para indicar que el guardado fue exitoso

    } catch (error) {
        console.error("Error al guardar el movimiento:", error);
        showToast("Error crítico al guardar. La operación fue cancelada.", "danger");
        setButtonLoading(btn, false);
        return false; // Indica que el guardado falló
    }
};
// ============================================================
// === FIN: FUNCIÓN CORREGIDA Y ROBUSTA PARA GUARDAR CAMBIOS ===
// ============================================================

        const handleAddConcept = async (btn) => { 
            const nombre = toSentenceCase((select('new-concepto-nombre')).value.trim());
            if (!nombre) { showToast('El nombre es obligatorio.', 'warning'); return; } 
            const newId = generateId();
            await saveDoc('conceptos', newId, { id: newId, nombre, icon: 'label' }, btn);
            hapticFeedback('success'); 
            showToast('Concepto añadido.');
            (select('add-concepto-form')).reset(); 
        };
        const handleAddAccount = async (btn) => { 
            const nombre = (select('new-cuenta-nombre')).value.trim(); 
            const tipo = toSentenceCase((select('new-cuenta-tipo')).value.trim()); 
            if (!nombre || !tipo) { showToast('El nombre y el tipo son obligatorios.', 'warning'); return; } 
            const newId = generateId();
            await saveDoc('cuentas', newId, { id: newId, nombre, tipo, saldo: 0, esInversion: false, offBalance: isOffBalanceMode, fechaCreacion: new Date().toISOString() }, btn);
            hapticFeedback('success'); 
            showToast('Cuenta añadida.');
            (select('add-cuenta-form')).reset();
        };
        const handleSaveConfig = async (btn) => { 
            setButtonLoading(btn, true);
            const newConfig = { skipIntro: select('config-skip-intro').checked, dashboardWidgets: (db.config && db.config.dashboardWidgets) || DEFAULT_DASHBOARD_WIDGETS };
            await fbDb.collection('users').doc(currentUser.uid).set({ config: newConfig }, { merge: true });
            localStorage.setItem('skipIntro', String(newConfig.skipIntro));
            setButtonLoading(btn, false);
            hapticFeedback('success'); showToast('Configuración guardada.'); 
        };

                 const handleExportData = async (btn) => {
            if (!currentUser) { showToast("No hay usuario autenticado.", "danger"); return; }
            setButtonLoading(btn, true, 'Exportando...');
            try {
                const dataPayload = {};
                const collections = ['cuentas', 'conceptos', 'movimientos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];
                
                for (const collectionName of collections) {
                    const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).get();
                    dataPayload[collectionName] = snapshot.docs.map(doc => doc.data());
                }
                dataPayload.config = db.config;

                const exportObject = {
                    meta: {
                        appName: "Cuentas aiDANaI",
                        version: "2.0.0",
                        exportDate: new Date().toISOString()
                    },
                    data: dataPayload
                };
                
                const jsonString = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cuentas_aidanai_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("Exportación JSON completada.", "info");
            } catch (error) {
                console.error("Error al exportar datos:", error);
                showToast("Error durante la exportación.", "danger");
            } finally {
                setButtonLoading(btn, false);
            }
        };
		const formatDateForCsv = (isoDateString) => {
            if (!isoDateString) return '';
            const date = new Date(isoDateString);
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        };

        const handleExportCsv = async (btn) => {
            if (!currentUser) { showToast("No hay usuario autenticado.", "danger"); return; }
            setButtonLoading(btn, true, 'Exportando...');
            
            try {
                const allMovements = await fetchAllMovementsForSearch();
                const allCuentas = db.cuentas;
                const allConceptos = db.conceptos;

                const cuentasMap = new Map(allCuentas.map(c => [c.id, c]));
                const conceptosMap = new Map(allConceptos.map(c => [c.id, c]));

                let csvRows = [];
                const csvHeader = ['FECHA', 'CUENTA', 'CONCEPTO', 'IMPORTE', 'DESCRIPCIÓN'];
                csvRows.push(csvHeader.join(';'));
                
                for (const cuenta of allCuentas) {
                    const movementsOfAccount = allMovements.filter(m => {
                        return (m.tipo === 'movimiento' && m.cuentaId === cuenta.id) ||
                               (m.tipo === 'traspaso' && m.cuentaOrigenId === cuenta.id) ||
                               (m.tipo === 'traspaso' && m.cuentaDestinoId === cuenta.id);
                    });

                    const balanceChange = movementsOfAccount.reduce((sum, m) => {
                        if (m.tipo === 'movimiento') return sum + m.cantidad;
                        if (m.tipo === 'traspaso' && m.cuentaOrigenId === cuenta.id) return sum - m.cantidad;
                        if (m.tipo === 'traspaso' && m.cuentaDestinoId === cuenta.id) return sum + m.cantidad;
                        return sum;
                    }, 0);
                    
                    const initialBalance = (cuenta.saldo || 0) - balanceChange;
                    
                    if (initialBalance !== 0) {
                        const cuentaNombre = `${cuenta.offBalance ? 'N-' : ''}${cuenta.nombre}`;
                        const importeStr = (initialBalance / 100).toLocaleString('es-ES', { useGrouping: false, minimumFractionDigits: 2 });
                        const fechaCreacion = cuenta.fechaCreacion ? formatDateForCsv(cuenta.fechaCreacion) : '01/01/2025';

                        csvRows.push([fechaCreacion, `"${cuentaNombre}"`, 'INICIAL', importeStr, '"Saldo Inicial"'].join(';'));
                    }
                }
                
                const sortedMovements = allMovements.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

                for (const mov of sortedMovements) {
                    const fecha = formatDateForCsv(mov.fecha);
                    const descripcion = `"${mov.descripcion.replace(/"/g, '""')}"`;
                    const importeStr = (mov.cantidad / 100).toLocaleString('es-ES', { useGrouping: false, minimumFractionDigits: 2 });

                    if (mov.tipo === 'traspaso') {
                        const cuentaOrigen = cuentasMap.get(mov.cuentaOrigenId);
                        const cuentaDestino = cuentasMap.get(mov.cuentaDestinoId);
                        
                        if (cuentaOrigen && cuentaDestino) {
                            const nombreOrigen = `${cuentaOrigen.offBalance ? 'N-' : ''}${cuentaOrigen.nombre}`;
                            const nombreDestino = `${cuentaDestino.offBalance ? 'N-' : ''}${cuentaDestino.nombre}`;
                            const importeNegativo = (-mov.cantidad / 100).toLocaleString('es-ES', { useGrouping: false, minimumFractionDigits: 2 });
                            
                            csvRows.push([fecha, `"${nombreOrigen}"`, 'TRASPASO', importeNegativo, descripcion].join(';'));
                            csvRows.push([fecha, `"${nombreDestino}"`, 'TRASPASO', importeStr, descripcion].join(';'));
                        }
                    } else {
                        const cuenta = cuentasMap.get(mov.cuentaId);
                        const concepto = conceptosMap.get(mov.conceptoId);

                        if (cuenta && concepto && concepto.nombre !== 'Saldo Inicial') {
                            const nombreCuenta = `${cuenta.offBalance ? 'N-' : ''}${cuenta.nombre}`;
                            csvRows.push([fecha, `"${nombreCuenta}"`, `"${concepto.nombre}"`, importeStr, descripcion].join(';'));
                        }
                    }
                }

                const csvString = csvRows.join('\r\n');
                const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cuentas_aidanai_export_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("Exportación CSV completada.", "info");
                
            } catch (error) {
                console.error("Error al exportar datos a CSV:", error);
                showToast("Error durante la exportación a CSV.", "danger");
            } finally {
                setButtonLoading(btn, false);
            }
        };
        const csv_parseDate = (dateString) => {
            if (!dateString) return null;
            const parts = dateString.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            if (isNaN(day) || isNaN(month) || isNaN(year) || year < 1970) return null;
            return new Date(Date.UTC(year, month, day, 12, 0, 0));
        };

        const csv_parseCurrency = (currencyString) => {
            if (typeof currencyString !== 'string' || !currencyString) return 0;
            const number = parseFloat(
                currencyString
                .replace('€', '')
                .trim()
                .replace(/\./g, '')
                .replace(',', '.')
            );
            return isNaN(number) ? 0 : Math.round(number * 100);
        };

        const csv_inferType = (name) => {
            const upperName = name.toUpperCase();
            if (upperName.includes('TARJETA')) return { tipo: 'Tarjeta', esInversion: false };
            if (upperName.includes('EFECTIVO')) return { tipo: 'Efectivo', esInversion: false };
            if (upperName.includes('PENSIÓN')) return { tipo: 'Pensión', esInversion: true };
            if (upperName.includes('LETRAS')) return { tipo: 'Renta Fija', esInversion: true };
            if (['FONDO', 'FONDOS'].some(t => upperName.includes(t))) return { tipo: 'Fondos', esInversion: true };
            if (['TRADEREPUBLIC', 'MYINVESTOR', 'DEGIRO', 'INTERACTIVEBROKERS', 'INDEXACAPITAL', 'COINBASE', 'CRIPTAN', 'KRAKEN', 'BIT2ME', 'N26', 'FREEDOM24', 'DEBLOCK', 'BBVA', 'CIVISLEND', 'HOUSERS', 'URBANITAE', 'MINTOS', 'HAUSERA'].some(b => upperName.includes(b))) return { tipo: 'Broker', esInversion: true };
            if (upperName.includes('NARANJA') || upperName.includes('AHORRO')) return { tipo: 'Ahorro', esInversion: false };
            return { tipo: 'Banco', esInversion: false };
        };

        const csv_processFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csvData = event.target.result.replace(/^\uFEFF/, '');
                        const lines = csvData.split(/\r?\n/).filter(line => line.trim() !== '' && line.includes(';'));
                        if (lines.length <= 1) {
                            showToast("El archivo CSV está vacío o solo contiene la cabecera.", "warning");
                            return resolve(null);
                        }
                        
                        lines.shift();

                        let rowCount = 0, initialCount = 0;
                        const cuentasMap = new Map();
                        const conceptosMap = new Map();
                        const movimientos = [];
                        const potentialTransfers = [];
                        
                        for (const line of lines) {
                            rowCount++;
                            const columns = line.split(';').map(c => c.trim().replace(/"/g, ''));
                            const [fechaStr, cuentaStr, conceptoStr, importeStr, descripcion = ''] = columns;

                            if (!fechaStr || !cuentaStr || !conceptoStr || !importeStr) {
                                console.warn(`Línea inválida o incompleta #${rowCount + 1}. Saltando...`, line);
                                continue;
                            }
                            
                            const fecha = csv_parseDate(fechaStr);
                            if (!fecha) {
                                 console.warn(`Fecha inválida en la fila ${rowCount + 1}: ${fechaStr}`);
                                 continue;
                            }

                            const conceptoLimpio = conceptoStr.trim().toUpperCase().replace(/\s*;-$/, '');
                            const offBalance = cuentaStr.startsWith('N-');
                            const nombreCuentaLimpio = cuentaStr.replace(/^(D-|N-)/, '');
                            const cantidad = csv_parseCurrency(importeStr);

                            if (!cuentasMap.has(nombreCuentaLimpio)) {
                                const { tipo, esInversion } = csv_inferType(nombreCuentaLimpio);
                                cuentasMap.set(nombreCuentaLimpio, { id: generateId(), nombre: nombreCuentaLimpio, tipo, saldo: 0, esInversion, offBalance, fechaCreacion: new Date(Date.UTC(2025, 0, 1)).toISOString() });
                            }

                            if (conceptoLimpio === 'INICIAL') {
                                initialCount++;
                                if (!conceptosMap.has('SALDO INICIAL')) conceptosMap.set('SALDO INICIAL', { id: generateId(), nombre: 'Saldo Inicial', icon: 'account_balance' });
                                const conceptoInicial = conceptosMap.get('SALDO INICIAL');
                                movimientos.push({ id: generateId(), fecha: fecha.toISOString(), cantidad, descripcion: descripcion || 'Existencia Inicial', tipo: 'movimiento', cuentaId: cuentasMap.get(nombreCuentaLimpio).id, conceptoId: conceptoInicial ? conceptoInicial.id : null });
                                continue;
                            }

                            if (conceptoLimpio && conceptoLimpio !== 'TRASPASO' && !conceptosMap.has(conceptoLimpio)) {
                                conceptosMap.set(conceptoLimpio, { id: generateId(), nombre: toSentenceCase(conceptoLimpio), icon: 'label' });
                            }
                            
                            if (conceptoLimpio === 'TRASPASO') {
                                potentialTransfers.push({ fecha, nombreCuenta: nombreCuentaLimpio, cantidad, descripcion, originalRow: rowCount });
                            } else {
                                const conceptoActual = conceptosMap.get(conceptoLimpio);
                                movimientos.push({ id: generateId(), fecha: fecha.toISOString(), cantidad, descripcion, tipo: 'movimiento', cuentaId: cuentasMap.get(nombreCuentaLimpio).id, conceptoId: conceptoActual ? conceptoActual.id : null });
                            }
                        }

                        let matchedTransfersCount = 0;
                        let unmatchedTransfers = [];
                        const transferGroups = new Map();
                        potentialTransfers.forEach(t => {
                            const key = `${t.fecha.getTime()}_${Math.abs(t.cantidad)}`;
                            if (!transferGroups.has(key)) transferGroups.set(key, []);
                            transferGroups.get(key).push(t);
                        });

                        transferGroups.forEach((group) => {
                            const gastos = group.filter(t => t.cantidad < 0);
                            const ingresos = group.filter(t => t.cantidad > 0);
                            while (gastos.length > 0 && ingresos.length > 0) {
                                const Gasto = gastos.pop();
                                const Ingreso = ingresos.pop();
                                movimientos.push({ id: generateId(), fecha: Gasto.fecha.toISOString(), cantidad: Math.abs(Gasto.cantidad), descripcion: Gasto.descripcion || Ingreso.descripcion || 'Traspaso', tipo: 'traspaso', cuentaOrigenId: cuentasMap.get(Gasto.nombreCuenta).id, cuentaDestinoId: cuentasMap.get(Ingreso.nombreCuenta).id });
                                matchedTransfersCount++;
                            }
                            unmatchedTransfers.push(...gastos, ...ingresos);
                        });
                        
                        const conceptoInicialId = conceptosMap.has('SALDO INICIAL') ? conceptosMap.get('SALDO INICIAL').id : null;
                        const finalData = { cuentas: Array.from(cuentasMap.values()), conceptos: Array.from(conceptosMap.values()), movimientos, presupuestos: [], recurrentes: [], inversiones_historial: [], inversion_cashflows: [], config: getInitialDb().config };
                        const totalMovements = movimientos.filter(m => m.tipo === 'movimiento' && m.conceptoId !== conceptoInicialId).length;

                        resolve({
                            jsonData: finalData,
                            stats: { rowCount, accounts: cuentasMap.size, concepts: conceptosMap.size, movements: totalMovements, transfers: matchedTransfersCount, initials: initialCount, unmatched: unmatchedTransfers.length }
                        });

                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error("No se pudo leer el archivo."));
                reader.readAsText(file, 'UTF-8');
            });
        };

        const showCsvImportWizard = () => {
            const wizardHTML = `
            <div id="csv-wizard-content">
                <div id="csv-wizard-step-1" class="json-wizard-step">
                    <h4>Paso 1: Selecciona tu archivo CSV</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);">
                        Columnas requeridas: <code>FECHA;CUENTA;CONCEPTO;IMPORTE;DESCRIPCIÓN</code>.
                        <br><strong>Atención:</strong> La importación reemplazará <strong>todos</strong> tus datos actuales.
                    </p>
                    <div id="csv-drop-zone" class="upload-area">
                        <p>Arrastra tu archivo <code>.csv</code> aquí o <strong>haz clic para seleccionarlo</strong>.</p>
                        <span id="csv-file-name" class="file-name" style="color: var(--c-success); font-weight: 600; margin-top: 1rem; display: block;"></span>
                    </div>
                    <div id="csv-file-error" class="form-error" style="text-align: center; margin-top: var(--sp-3);"></div>
                    <div class="modal__actions">
                        <button id="csv-process-btn" class="btn btn--primary btn--full" disabled>Analizar Archivo</button>
                    </div>
                </div>

                <div id="csv-wizard-step-2" class="json-wizard-step" style="display: none;">
                    <h4>Paso 2: Revisa y confirma</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);">Hemos analizado tu archivo. Si los datos son correctos, pulsa "Importar" para reemplazar tus datos actuales.</p>
                    <div class="results-log" style="display: block; margin-top: 0;">
                        <h2>Resultados del Análisis</h2>
                        <ul id="csv-preview-list"></ul>
                    </div>
                    <div class="form-error" style="margin-top: var(--sp-2); text-align: center;"><strong>Atención:</strong> Esta acción es irreversible.</div>
                    <div class="modal__actions" style="justify-content: space-between;">
                        <button id="csv-wizard-back-btn" class="btn btn--secondary">Atrás</button>
                        <button id="csv-wizard-import-final" class="btn btn--danger"><span class="material-icons">warning</span>Importar y Reemplazar</button>
                    </div>
                </div>

                <div id="csv-wizard-step-3" class="json-wizard-step" style="display: none; justify-content: center; align-items: center; text-align: center; min-height: 250px;">
                    <div id="csv-import-progress">
                        <span class="spinner" style="width: 48px; height: 48px; border-width: 4px;"></span>
                        <h4 style="margin-top: var(--sp-4);">Importando...</h4>
                        <p>Borrando datos antiguos e importando los nuevos. Por favor, no cierres esta ventana.</p>
                    </div>
                     <div id="csv-import-result" style="display: none;">
                        <span class="material-icons" style="font-size: 60px; color: var(--c-success);">task_alt</span>
                        <h4 id="csv-result-title" style="margin-top: var(--sp-2);"></h4>
                        <p id="csv-result-message"></p>
                        <div class="modal__actions" style="justify: center;">
                            <button class="btn btn--primary" data-action="close-modal" data-modal-id="generic-modal">Finalizar</button>
                        </div>
                     </div>
                </div>
            </div>`;

            showGenericModal('Asistente de Importación CSV', wizardHTML);

            setTimeout(() => {
                let csvFile = null;
                let processedData = null;
                const wizardContent = select('csv-wizard-content');
                if (!wizardContent) return;

                const goToStep = (step) => {
                    wizardContent.querySelectorAll('.json-wizard-step').forEach(s => s.style.display = 'none');
                    wizardContent.querySelector(`#csv-wizard-step-${step}`).style.display = 'flex';
                };

                const fileInput = document.createElement('input');
                fileInput.type = 'file'; fileInput.accept = '.csv, text/csv'; fileInput.className = 'hidden';
                wizardContent.appendChild(fileInput);

                const handleFileSelection = (files) => {
                    const file = files[0];
                    const nameEl = select('csv-file-name'), processBtn = select('csv-process-btn'), errorEl = select('csv-file-error');
                    if (file && (file.type === 'text/csv' || file.name.endsWith('.csv'))) {
                        csvFile = file;
                        nameEl.textContent = `Archivo: ${file.name}`;
                        processBtn.disabled = false;
                        errorEl.textContent = '';
                    } else {
                        csvFile = null;
                        nameEl.textContent = 'Por favor, selecciona un archivo .csv válido.';
                        processBtn.disabled = true;
                    }
                };
                
                const dropZone = select('csv-drop-zone');
                dropZone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', () => handleFileSelection(fileInput.files));
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
                dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFileSelection(e.dataTransfer.files); });

                select('csv-process-btn').addEventListener('click', async (e) => {
                    if (!csvFile) return;
                    const btn = e.target;
                    setButtonLoading(btn, true, 'Analizando...');
                    try {
                        const result = await csv_processFile(csvFile);
                        if (result) {
                            processedData = result.jsonData;
                            const { stats } = result;
                            const previewList = select('csv-preview-list');
                            let html = `
                                <li><span class="label">Filas Válidas Leídas</span><span class="value">${stats.rowCount}</span></li>
                                <li><span class="label">Cuentas a Crear</span><span class="value success">${stats.accounts}</span></li>
                                <li><span class="label">Conceptos a Crear</span><span class="value success">${stats.concepts}</span></li>
                                <li><span class="label">Saldos Iniciales</span><span class="value">${stats.initials}</span></li>
                                <li><span class="label">Movimientos (Ingreso/Gasto)</span><span class="value">${stats.movements}</span></li>
                                <li><span class="label">Transferencias Emparejadas</span><span class="value">${stats.transfers}</span></li>
                                <li><span class="label">Transferencias sin Pareja</span><span class="value ${stats.unmatched > 0 ? 'danger' : 'success'}">${stats.unmatched}</span></li>
                            `;
                            previewList.innerHTML = html;
                            goToStep(2);
                        }
                    } catch (error) {
                        console.error("Error al procesar CSV:", error);
                        select('csv-file-error').textContent = `Error: ${error.message}`;
                    } finally {
                        setButtonLoading(btn, false);
                    }
                });

                select('csv-wizard-back-btn').addEventListener('click', () => goToStep(1));
                select('csv-wizard-import-final').addEventListener('click', (e) => {
                    if (processedData) handleFinalCsvImport(e.target, processedData, goToStep);
                });
            }, 0);
        };

        const handleFinalCsvImport = async (btn, dataToImport, goToStep) => {
            goToStep(3);
            setButtonLoading(btn, true, 'Importando...');

            try {
                const collectionsToClear = ['cuentas', 'conceptos', 'movimientos', 'presupuestos', 'recurrentes', 'inversiones_historial', 'inversion_cashflows'];

                for (const collectionName of collectionsToClear) {
                    const snapshot = await fbDb.collection('users').doc(currentUser.uid).collection(collectionName).get();
                    if (snapshot.empty) continue;
                    let batch = fbDb.batch();
                    let count = 0;
                    for (const doc of snapshot.docs) {
                        batch.delete(doc.ref);
                        count++;
                        if (count >= 450) { await batch.commit(); batch = fbDb.batch(); count = 0; }
                    }
                    if (count > 0) await batch.commit();
                }
                
                for (const collectionName of Object.keys(dataToImport)) {
                    const items = dataToImport[collectionName];
                    if (Array.isArray(items) && items.length > 0) {
                        let batch = fbDb.batch();
                        let count = 0;
                        for (const item of items) {
                            if (item.id) {
                                const docRef = fbDb.collection('users').doc(currentUser.uid).collection(collectionName).doc(item.id);
                                batch.set(docRef, item);
                                count++;
                                if (count >= 450) { await batch.commit(); batch = fbDb.batch(); count = 0; }
                            }
                        }
                        if (count > 0) await batch.commit();
                    } else if (collectionName === 'config') {
                        await fbDb.collection('users').doc(currentUser.uid).set({ config: items }, { merge: true });
                    }
                }
                
                const resultEl = select('csv-import-result');
                select('csv-import-progress').style.display = 'none';
                if(resultEl) {
                    resultEl.style.display = 'block';
                    resultEl.querySelector('#csv-result-title').textContent = '¡Importación Completada!';
                    resultEl.querySelector('#csv-result-message').textContent = 'Los datos se han importado correctamente. La aplicación se recargará.';
                }
                
                hapticFeedback('success');
                showToast('¡Importación completada!', 'info', 4000);
                setTimeout(() => location.reload(), 4500);

            } catch (error) {
                console.error("Error en importación final desde CSV:", error);
                showToast("Error crítico durante la importación.", "danger", 5000);
                const resultEl = select('csv-import-result');
                select('csv-import-progress').style.display = 'none';
                if(resultEl) {
                    resultEl.style.display = 'block';
                    resultEl.querySelector('#csv-result-title').textContent = '¡Error en la Importación!';
                    resultEl.querySelector('#csv-result-message').textContent = 'Ocurrió un error. Revisa la consola e inténtalo de nuevo.';
                    const iconEl = resultEl.querySelector('.material-icons');
                    if (iconEl) iconEl.style.color = 'var(--c-danger)';
                }
                setButtonLoading(btn, false);
            }
        };
		
// =============================================================
// === PASO 2: REEMPLAZO DE LA LÓGICA DE BORRADO Y DESHACER ===
// =============================================================
const deleteMovementAndAdjustBalance = async (id, isRecurrent = false) => {
    const collection = isRecurrent ? 'recurrentes' : 'movimientos';
    const docRef = fbDb.collection('users').doc(currentUser.uid).collection(collection).doc(id);
    const doc = await docRef.get();

    if (!doc.exists) { return; }

    const dataToDelete = doc.data();
    lastActionForUndo = { actionType: 'delete', collection, data: { id: doc.id, ...dataToDelete } };
    
    // --- Orden correcto de ejecución ---
    // 1. Mostrar el toast con la opción de Deshacer INMEDIATAMENTE.
    showToast('Elemento eliminado.', 'info', 6000, {
        actionText: 'Deshacer',
        onActionClick: handleUndoAction
    });

    // 2. Realizar la lógica de borrado real.
    if (!isRecurrent) {
        if (dataToDelete.tipo === 'traspaso') {
            await updateAccountBalance(dataToDelete.cuentaOrigenId, dataToDelete.cantidad);
            await updateAccountBalance(dataToDelete.cuentaDestinoId, -dataToDelete.cantidad);
        } else {
            await updateAccountBalance(dataToDelete.cuentaId, -dataToDelete.cantidad);
        }
    }
    await docRef.delete();
    
    // 3. Forzar el refresco de la vista para que el elemento desaparezca visualmente.
    const activeView = document.querySelector('.view--active');
    if (activeView) {
        switch(activeView.id) {
            case PAGE_IDS.MOVIMIENTOS: await loadInitialMovements(); break;
            case PAGE_IDS.INICIO: await updateDashboardData(); break;
            case PAGE_IDS.PLANIFICACION: renderPlanificacionPage(); break;
        }
    }
};

// (Asegúrate de tener esta función de Deshacer también actualizada)
const handleUndoAction = async () => {
    if (!lastActionForUndo) return;
    const { actionType, collection, data } = lastActionForUndo;
    if (actionType === 'delete') {
        await saveDoc(collection, data.id, data);
        if (collection === 'movimientos') {
            if (data.tipo === 'traspaso') {
                await updateAccountBalance(data.cuentaOrigenId, -data.cantidad);
                await updateAccountBalance(data.cuentaDestinoId, data.cantidad);
            } else {
                await updateAccountBalance(data.cuentaId, data.cantidad);
            }
        }
        showToast('Eliminación deshecha.', 'info');
    }
    lastActionForUndo = null;
    
    const activeView = document.querySelector('.view--active');
    if (activeView) {
        switch(activeView.id) {
            case PAGE_IDS.MOVIMIENTOS: await loadInitialMovements(); break;
            case PAGE_IDS.INICIO: await updateDashboardData(); break;
            case PAGE_IDS.PLANIFICACION: renderPlanificacionPage(); break;
        }
    }
};
		
        const recalculateAllAccountBalances = async (btn) => {
            if (!currentUser) {
                showToast("Debes iniciar sesión para realizar esta acción.", "danger");
                return;
            }

            setButtonLoading(btn, true, 'Auditando...');
            showToast("Iniciando recálculo de saldos... Esto puede tardar un momento.", 'info', 4000);

            try {
                const userRef = fbDb.collection('users').doc(currentUser.uid);
                const cuentasRef = userRef.collection('cuentas');
                const movimientosRef = userRef.collection('movimientos');

                const cuentasSnapshot = await cuentasRef.get();
                const newBalances = {};
                cuentasSnapshot.forEach(doc => {
                    newBalances[doc.id] = 0;
                });

                const movimientosSnapshot = await movimientosRef.get();
                console.log(`Procesando ${movimientosSnapshot.size} movimientos para el recálculo.`);

                movimientosSnapshot.forEach(doc => {
                    const mov = doc.data();
                    if (mov.tipo === 'traspaso') {
                        if (newBalances.hasOwnProperty(mov.cuentaOrigenId)) {
                            newBalances[mov.cuentaOrigenId] -= mov.cantidad;
                        }
                        if (newBalances.hasOwnProperty(mov.cuentaDestinoId)) {
                            newBalances[mov.cuentaDestinoId] += mov.cantidad;
                        }
                    } else {
                        if (newBalances.hasOwnProperty(mov.cuentaId)) {
                            newBalances[mov.cuentaId] += mov.cantidad;
                        }
                    }
                });

                const batch = fbDb.batch();
                for (const cuentaId in newBalances) {
                    const cuentaRef = cuentasRef.doc(cuentaId);
                    batch.update(cuentaRef, { saldo: newBalances[cuentaId] });
                }
                
                await batch.commit();

                hapticFeedback('success');
                showToast("¡Auditoría completada! Todos los saldos han sido recalculados y actualizados.", "info", 5000);
                
                loadCoreData(currentUser.uid);

            } catch (error) {
                console.error("Error crítico durante el recálculo de saldos:", error);
                showToast("Ocurrió un error grave durante el recálculo. Revisa la consola.", "danger");
            } finally {
                setButtonLoading(btn, false);
            }
        };    

        const handleSaveInvestmentAccounts = async (form, btn) => {
            setButtonLoading(btn, true);
            const selectedIds = new Set(Array.from(form.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value));
            const batch = fbDb.batch();
            db.cuentas.forEach(c => {
                const ref = fbDb.collection('users').doc(currentUser.uid).collection('cuentas').doc(c.id);
                batch.update(ref, { esInversion: selectedIds.has(c.id) });
            });
            await batch.commit();
            setButtonLoading(btn, false);
            hideModal('generic-modal');
            hapticFeedback('success');
            showToast('Portafolio actualizado.');
        };
		const handleSaveAportacion = async (form, btn) => {
             setButtonLoading(btn, true);
            const cuentaId = select('aportacion-cuenta').value;
            const cantidad = parseCurrencyString(select('aportacion-cantidad').value);
            const fecha = select('aportacion-fecha').value;
            const notas = select('aportacion-notas').value.trim();

            if (!cuentaId || isNaN(cantidad) || !fecha) {
                showToast('Completa todos los campos requeridos.', 'warning');
                setButtonLoading(btn, false);
                return;
            }
            
            const newId = generateId();
            const newCashflow = {
                id: newId,
                cuentaId,
                cantidad: Math.round(cantidad * 100),
                fecha: parseDateStringAsUTC(fecha).toISOString(),
                notas
            };
            
            await saveDoc('inversion_cashflows', newId, newCashflow);
            setButtonLoading(btn, false);
            hideModal('generic-modal');
            hapticFeedback('success');
            showToast('Operación de capital registrada.');
            const activePageEl = document.querySelector('.view--active');
            const activePage = activePageEl ? activePageEl.id : null;
            if (activePage === PAGE_IDS.PATRIMONIO) {
                renderPatrimonioPage();
            }
        };

        document.addEventListener('DOMContentLoaded', initApp);
		
        const fetchMovementsInChunks = async (baseQuery, field, ids) => {
            if (ids.length === 0) {
                return [];
            }
            const idChunks = chunkArray(ids, 10);
            
            const queryPromises = idChunks.map(chunk => {
                return baseQuery.where(field, 'in', chunk).get();
            });

            const querySnapshots = await Promise.all(queryPromises);

            let movements = [];
            querySnapshots.forEach(snapshot => {
                snapshot.forEach(doc => {
                    movements.push({ id: doc.id, ...doc.data() });
                });
            });

            return movements;
        };

        const validateField = (id, silent = false) => {
            const input = select(id);
            if (!input) return true;

            clearError(id);
            let isValid = true;
            const value = input.value.trim();
            const traspasoPill = select('mov-type-btn-traspaso');
            const type = traspasoPill && traspasoPill.classList.contains('filter-pill--active') ? 'traspaso' : 'movimiento';

            switch (id) {
                case 'movimiento-cantidad':
                    const amount = parseCurrencyString(value);
                    if (isNaN(amount) || value === '') {
                        displayError(id, 'Cantidad no válida.'); isValid = false;
                    }
                    break;
                case 'movimiento-descripcion':
                    if (type !== 'traspaso' && value === '') {
                        displayError(id, 'La descripción es obligatoria.'); isValid = false;
                    }
                    break;
                case 'movimiento-concepto':
                    if (type === 'movimiento' && value === '') {
                        displayError(id, 'El concepto es obligatorio.'); isValid = false;
                    }
                    break;
                case 'movimiento-cuenta':
                    if (type === 'movimiento' && value === '') {
                        displayError(id, 'La cuenta es obligatoria.'); isValid = false;
                    }
                    break;
                case 'movimiento-cuenta-origen':
                case 'movimiento-cuenta-destino':
                    if (type === 'traspaso') {
                        const origen = select('movimiento-cuenta-origen').value;
                        const destino = select('movimiento-cuenta-destino').value;
                        if (value === '') {
                            displayError(id, 'La cuenta es obligatoria.');
                            isValid = false;
                        } else if (origen && destino && origen === destino) {
                            if (input.id === 'movimiento-cuenta-origen') {
                                displayError(id, 'No puede ser la misma cuenta destino.');
                            } else {
                                displayError(id, 'No puede ser la misma cuenta origen.');
                            }
                            isValid = false;
                        }
                    }
                    break;
                case 'movimiento-fecha':
                    if (value === '') {
                        displayError(id, 'La fecha es obligatoria.'); isValid = false;
                    }
                    break;
                case 'new-cuenta-nombre':
                case 'new-cuenta-tipo':
                case 'edit-cuenta-nombre':
                case 'edit-cuenta-tipo':
                    if (value === '') {
                        displayError(id, 'Este campo es obligatorio.'); isValid = false;
                    }
                    break;
                case 'new-concepto-nombre':
                case 'edit-concepto-nombre':
                    if (value === '') {
                        displayError(id, 'Este campo es obligatorio.'); isValid = false;
                    }
                    break;
                 case 'valoracion-valor':
                    const valor = parseCurrencyString(value);
                    if (isNaN(valor) || valor < 0) {
                        displayError(id, 'Valor no válido. Debe ser un número positivo.'); isValid = false;
                    }
                    break;
                case 'valoracion-fecha':
                    if (value === '') {
                        displayError(id, 'La fecha es obligatoria.'); isValid = false;
                    }
                    break;
                case 'aportacion-cantidad':
                    const aportacion = parseCurrencyString(value);
                    if (isNaN(aportacion) || value === '') {
                        displayError(id, 'Cantidad no válida.'); isValid = false;
                    }
                    break;
                case 'aportacion-fecha':
                    if (value === '') {
                        displayError(id, 'La fecha es obligatoria.'); isValid = false;
                    }
                    break;
            }

            if (!isValid && !silent) hapticFeedback('light');

            return isValid;
        };

        const validateMovementForm = () => {
            let isValid = true;
            if (!validateField('movimiento-cantidad')) isValid = false;
            if (!validateField('movimiento-fecha')) isValid = false;

           const traspasoPill = select('mov-type-btn-traspaso');
            const type = traspasoPill && traspasoPill.classList.contains('filter-pill--active') ? 'traspaso' : 'movimiento';

            if (type === 'movimiento') {
                if (!validateField('movimiento-descripcion')) isValid = false;
                if (!validateField('movimiento-concepto')) isValid = false;
                if (!validateField('movimiento-cuenta')) isValid = false;
            } else {
                const origenValid = validateField('movimiento-cuenta-origen');
                const destinoValid = validateField('movimiento-cuenta-destino');
                if (!origenValid || !destinoValid) isValid = false;
            }
            return isValid;
        };

                const handleDescriptionInput = () => {
            clearTimeout(descriptionSuggestionDebounceTimer);
            descriptionSuggestionDebounceTimer = setTimeout(() => {
                const descriptionInput = select('movimiento-descripcion');
                const suggestionsBox = select('description-suggestions');
                if (!descriptionInput || !suggestionsBox) return;

                const query = descriptionInput.value.trim().toLowerCase();
                suggestionsBox.innerHTML = '';

                if (query.length < 3) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                const suggestions = [];
                for (const [desc, data] of intelligentIndex.entries()) {
                    if (desc.includes(query)) {
                        suggestions.push({
                            description: desc,
                            conceptoId: data.conceptoId,
                            cuentaId: data.cuentaId
                        });
                    }
                }

                if (suggestions.length > 0) {
                    suggestions.sort((a, b) => a.description.localeCompare(b.description));
                    let html = '';
                    suggestions.slice(0, DESCRIPTION_SUGGESTION_LIMIT).forEach(s => {
                        const concepto = db.conceptos.find(c => c.id === s.conceptoId);
                        const cuenta = db.cuentas.find(c => c.id === s.cuentaId);
                        html += `
                            <div class="suggestion-item" 
                                data-description="${escapeHTML(s.description)}" 
                                data-concepto-id="${s.conceptoId}" 
                                data-cuenta-id="${s.cuentaId}"
                                tabindex="0"
                            >
                                <p>${escapeHTML(s.description)}</p>
                                <small>${escapeHTML((concepto && concepto.nombre) || 'S/C')} • ${escapeHTML((cuenta && cuenta.nombre) || 'S/C')}</small>
                            </div>
                        `;
                    });
                    suggestionsBox.innerHTML = html;
                    suggestionsBox.style.display = 'block';
                } else {
                    suggestionsBox.style.display = 'none';
                }
            }, 300);
        };
	 
    </script>
</body>
</html>
