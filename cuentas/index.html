<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Cuentas aiDANaI</title>
    
    <!-- DEPENDENCIAS DE ESTILO (Importadas de index.html) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- PWA MANIFEST (Adaptado) -->
    <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Cuentas aiDANaI&quot;,&quot;short_name&quot;:&quot;aiDANaI&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#1C1B1F&quot;,&quot;theme_color&quot;:&quot;#D0BCFF&quot;,&quot;description&quot;:&quot;Gestor de finanzas personales y compartidas.&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3Eüí∞%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;},{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3Eüí∞%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    <meta name="theme-color" content="#1C1B1F"/>
    <link rel="apple-touch-icon" href="aiDANaI-Cuentas.jpg">

    <!-- ESTILOS UNIFICADOS (Basados en index.html) -->
    <style>
        :root {
            --primary-color: #6750A4; --primary-variant: #4F378B; --secondary-color: #625B71; --background: #FFFBFE; --surface: #FFFFFF; --surface-variant: #F3F0F4; --on-primary: #FFFFFF; --on-secondary: #FFFFFF; --on-background: #1C1B1F; --on-surface: #1C1B1F; --outline: #C0BFC4; --shadow: rgba(0,0,0,0.1);
            --dani-color:#4A90E2; --norma-color:#D0021B; --comun-color:#50E3C2;
            --success-color:#388E3C; --danger-color:#D32F2F; --warning-color:#FBC02D; --info-color: #1976D2;
            --font-roboto: 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        [data-theme="dark"] {
            --primary-color: #D0BCFF; --secondary-color: #CCC2DC; --background: #1C1B1F; --surface: #2B2930; --surface-variant: #49454F; --on-primary: #371E73; --on-background: #E6E1E5; --on-surface: #E6E1E5; --outline: #5F5C63;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; }
        body { font-family: var(--font-roboto); background-color: var(--background); color: var(--on-background); line-height: 1.5; overflow: hidden; min-height: 100vh; min-height: -webkit-fill-available; height: 100vh; transition: background-color 0.3s, color 0.3s; }
        *:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; border-radius: 4px; }
        
        /* --- ESTRUCTURA PRINCIPAL --- */
        #app-root { display: none; max-width: 500px; margin: 0 auto; height: 100vh; background: var(--background); position: relative; flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; padding-bottom: calc(65px + env(safe-area-inset-bottom)); }
        #app-root.visible { display: flex; opacity: 1; }
        .main-content { flex: 1; display: flex; position: relative; overflow: hidden; }
        .view { display: none; width: 100%; flex-direction: column; animation: fadeIn 0.3s ease-in-out; height: 100%; overflow-y: auto; padding: 16px; padding-top: 70px; padding-bottom: 80px; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Barra Superior --- */
        .top-bar { position: absolute; top: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background-color: var(--surface); border-bottom: 1px solid var(--outline); z-index: 10; height: 60px;}
        .top-bar-title { font-size: 20px; font-weight: 500; }
        .top-bar-actions { display: flex; align-items: center; gap: 4px; }
        
        /* --- Componentes de UI Gen√©ricos --- */
        .settings-section { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 4px var(--shadow); }
        .section-title { font-size: 18px; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--primary-color); }
        .empty-state { text-align: center; padding: 32px 24px; color: var(--secondary-color); }
        .empty-state .material-icons { font-size: 48px; margin-bottom: 8px; }
        .kpi-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
        .kpi-item { background: var(--surface); border-radius: 12px; padding: 12px; text-align: center; box-shadow: 0 1px 4px var(--shadow); }
        .kpi-item h4 { font-size: 13px; font-weight: 500; color: var(--secondary-color); margin-bottom: 4px; }
        .kpi-item strong { font-size: 18px; font-weight: 700; }

        /* --- Listas --- */
        .list-item-card { display: flex; align-items: center; background: var(--surface); border-radius: 12px; margin-bottom: 8px; box-shadow: 0 1px 4px var(--shadow); transition: all 0.2s; user-select: none; position: relative; padding: 10px 12px; border-left: 5px solid transparent; }
        .list-item-card .item-content { flex: 1; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .item-details { display: flex; flex-direction: column; flex-grow: 1; padding-right: 8px; }
        .item-title { font-weight: 500; }
        .item-meta { font-size: 12px; color: var(--secondary-color); }
        .item-amount { font-weight: 600; font-size: 16px; text-align: right; flex-shrink: 0; }
        .item-actions { display: flex; align-items: center; flex-shrink: 0; }
        
        /* Colores por Propietario */
        .owner-dani-border { border-left-color: var(--dani-color); }
        .owner-norma-border { border-left-color: var(--norma-color); }
        .owner-comun-border { border-left-color: var(--comun-color); }
        .owner-dani-text { color: var(--dani-color); }
        .owner-norma-text { color: var(--norma-color); }
        .owner-comun-text { color: var(--comun-color); }

        /* --- Acordeones (para Cuentas) --- */
        details.accordion-item { margin-bottom: 8px; background-color: var(--surface); border-radius: 12px; box-shadow: 0 1px 4px var(--shadow); overflow: hidden;}
        details.accordion-item summary { font-weight: 500; cursor: pointer; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; list-style: none; }
        details.accordion-item summary::-webkit-details-marker { display: none; }
        details.accordion-item summary .expand-icon { transition: transform 0.2s; color: var(--secondary-color); }
        details.accordion-item[open] summary .expand-icon { transform: rotate(180deg); }
        .accordion-content { padding: 0 16px 16px; border-top: 1px solid var(--outline); }
        .accordion-content .list-item-card { box-shadow: none; border-radius: 8px; background-color: var(--surface-variant); padding: 8px; }

        /* --- Presupuestos --- */
        .budget-item { padding: 12px; } /* Usar√° .list-item-card como base */
        .budget-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .budget-info-text strong { display: block; font-size: 16px; font-weight: 500; margin-bottom: 2px; }
        .budget-info-text span { color: var(--secondary-color); font-size: 12px; }
        .budget-progress { width: 100%; height: 8px; border-radius: 4px; -webkit-appearance: none; appearance: none; overflow: hidden; background-color: rgba(120,120,128,.2); }
        .budget-progress::-webkit-progress-bar { background-color: transparent; }
        .budget-progress.progress-ok::-webkit-progress-value { background-color:var(--success-color); }
        .budget-progress.progress-warning::-webkit-progress-value { background-color:var(--warning-color); }
        .budget-progress.progress-danger::-webkit-progress-value { background-color:var(--danger-color); }

        /* --- Formularios --- */
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--secondary-color); }
        .form-input, .form-select { width: 100%; padding: 10px; border: 2px solid var(--outline); border-radius: 8px; background: var(--surface); color: var(--on-surface); font-size: 14px; -webkit-appearance: none; appearance: none; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-color); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 12px; padding-right: 30px; }
        [data-theme=dark] .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23FFF' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-group-with-action { display: flex; align-items: flex-end; gap: 8px; }
        .form-group-with-action .form-group { flex-grow: 1; margin-bottom: 0; }
        .error-message{ color:var(--danger-color); font-size: 12px; margin-top:4px; min-height:16px; display:block; }
        .is-invalid { border-color:var(--danger-color) !important; }

        /* --- Botones --- */
        .btn { padding: 10px 20px; border: none; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background: var(--primary-color); color: var(--on-primary); }
        .btn-secondary { background: var(--surface-variant); color: var(--on-surface); }
        .btn-full { width: 100%; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: black; }
        .icon-button { background: none; border: none; color: var(--secondary-color); cursor: pointer; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s; }
        .icon-button:hover { background-color: var(--surface-variant); color: var(--on-surface); }
        .fab { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); right: 24px; width: 56px; height: 56px; background: var(--primary-color); color: var(--on-primary); border: none; border-radius: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px var(--shadow); transition: all 0.2s; z-index: 50; }
        .fab:hover { transform: scale(1.1); }
        .fab.hidden { display: none; }
        
        /* --- Navegaci√≥n --- */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background: var(--surface); border-top: 1px solid var(--outline); display: flex; padding: 4px 0 calc(8px + env(safe-area-inset-bottom)) 0; z-index: 100; box-shadow: 0 -2px 8px var(--shadow); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 4px 8px; cursor: pointer; transition: color 0.2s; color: var(--secondary-color); border: none; background: none; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item .material-icons { font-size: 24px; margin-bottom: 2px; }
        .nav-label { font-size: 12px; font-weight: 500; }

        /* --- Modales --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 200; padding: 16px; animation: modalFadeIn 0.3s; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--surface); border-radius: 24px; padding: 20px; width: 100%; max-width: 420px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px var(--shadow); }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 500; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
        .modal-list-item { display:flex; justify-content:space-between; align-items:center; padding:8px 4px; border-bottom:1px solid var(--surface-variant); }
        .modal-list-item:last-child { border-bottom: none; }

        /* --- Estados y Clases de ayuda --- */
        .text-positive{color:var(--success-color)} .text-negative{color:var(--danger-color)} .text-warning{color:var(--warning-color)} .text-info{color:var(--info-color)}
        .hidden{display:none!important}
        .btn-loading { pointer-events:none; opacity:.8; }
        .btn-text { margin-right: 8px; }
        .spinner { display: inline-block; width: 1em; height: 1em; border: .15em solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin .8s linear infinite; vertical-align: middle; }
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .filter-pill { background-color: var(--surface-variant); border: 1px solid var(--outline); color: var(--on-surface); padding: 6px 14px; font-size: 13px; border-radius: 20px; cursor: pointer; transition: all .2s; }
        .filter-pill.active { background-color: var(--primary-color); color: var(--on-primary); border-color: var(--primary-color); font-weight: 500; }

        /* --- Pantallas de carga y login --- */
        .intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; background: #000; transition: opacity 0.5s ease-out; }
        #splashScreen #splashImage { width: 250px; height: auto; opacity: 0; animation: growAndFade 2.5s ease-in-out forwards; border-radius: 24px;}
        @keyframes growAndFade { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
        #quoteScreen { text-align: center; color: #FFF; padding: 20px; opacity: 0; transition: opacity 1.5s; }
        #quoteScreen.visible { opacity: 1; }
        #quoteText { font-size: 22px; font-style: italic; font-weight: 300; max-width: 600px; }
        #quoteAuthor { display: block; font-size: 16px; margin-top: 12px; font-weight: 500; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 16px; opacity: 0; transition: opacity .5s; background-color: var(--background); }
        #login-screen.visible { display: flex; opacity: 1; }
        .login-card { background-color: var(--surface); padding: 24px; border-radius: 24px; box-shadow: 0 8px 32px var(--shadow); width: 100%; max-width: 360px; text-align: center; }
        .login-card h2 { font-size: 22px; margin-bottom: 20px; }

        /* --- Toast --- */
        #toast-container { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 2000; width: max-content; max-width: 90%; pointer-events: none; }
        .toast { background-color: rgba(40, 40, 40, 0.95); backdrop-filter: blur(5px); color: white; padding: 10px 16px; border-radius: 8px; margin-bottom: 6px; box-shadow: 0 2px 6px var(--shadow); display: flex; align-items: center; animation: toastFadeIn 0.3s, toastFadeOut 0.3s 2.7s; font-size: 14px; }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; translateY(10px); } }
    </style>
    
    <!-- Scripts de Firebase (SIN CAMBIOS, son cruciales) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- PANTALLAS DE CARGA (Redise√±adas) -->
<div id="splashScreen" class="intro-screen"><img id="splashImage" src="aiDANaI-Cuentas.jpg" alt="Logo aiDANaI"></div>
<div id="quoteScreen" class="intro-screen" style="display:none;"><p id="quoteText"></p><span id="quoteAuthor"></span></div>

<!-- PANTALLA DE LOGIN (Redise√±ada) -->
<div id="login-screen">
    <div class="login-card">
        <h2 id="login-title">üí∞ Cuentas aiDANaI</h2>
        <form id="login-form" novalidate>
            <div class="form-group"><input type="email" id="login-email" class="form-input" placeholder="Correo electr√≥nico" required autocomplete="email" autocapitalize="none"><span class="error-message" id="login-email-error"></span></div>
            <div class="form-group"><input type="password" id="login-password" class="form-input" placeholder="Contrase√±a" required autocomplete="current-password"><span class="error-message" id="login-password-error"></span></div>
            <div class="form-grid" style="margin-top: 20px;"><button type="button" id="login-btn" class="btn btn-primary">Iniciar Sesi√≥n</button><button type="button" id="register-btn" class="btn btn-secondary">Registrarse</button></div>
            <p id="login-error" class="error-message" style="min-height: 20px; margin-top: 10px;"></p>
        </form>
    </div>
</div>

<!-- CONTENEDOR PRINCIPAL DE LA APP (Redise√±ado) -->
<div id="app-root">
    <main class="main-content">
        <!-- VISTA: Panel de Control -->
        <div id="panel-control-page" class="view">
            <div class="top-bar">
                <h1 class="top-bar-title">Panel de Control</h1>
                <div class="top-bar-actions">
                    <button id="ai-advice-btn" class="icon-button" title="Asesor IA"><span class="material-icons">psychology_alt</span></button>
                    <button id="help-btn" class="icon-button" title="Ayuda"><span class="material-icons">lightbulb</span></button>
                    <button id="theme-toggle-panel" class="icon-button" title="Cambiar Tema"><span class="material-icons">light_mode</span></button>
                    <button id="logout-btn-panel" class="icon-button" title="Cerrar Sesi√≥n"><span class="material-icons">logout</span></button>
                </div>
            </div>
            
            <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">filter_list</span>Filtros</h3>
                <div class="form-group"><label for="filter-periodo" class="form-label">Periodo</label><select id="filter-periodo" class="form-select"><option value="mes-actual">Mes Actual</option><option value="ano-actual">A√±o Actual</option><option value="siempre">Siempre</option><option value="custom">Personalizado</option></select></div>
                <div id="custom-date-filters" class="hidden form-grid"><div class="form-group"><label for="filter-fecha-inicio" class="form-label">Desde</label><input type="date" id="filter-fecha-inicio" class="form-input"></div><div class="form-group"><label for="filter-fecha-fin" class="form-label">Hasta</label><input type="date" id="filter-fecha-fin" class="form-input"></div></div>
                <div class="form-grid"><div class="form-group"><label for="filter-beneficiario" class="form-label">Propietario</label><select id="filter-beneficiario" class="form-select"></select></div><div class="form-group"><label for="filter-cuenta" class="form-label">Cuenta</label><select id="filter-cuenta" class="form-select"></select></div></div>
                <div class="form-group"><label for="filter-concepto" class="form-label">Concepto</label><select id="filter-concepto" class="form-select"></select></div>
                <button id="apply-filters-btn" class="btn btn-primary btn-full">Aplicar Filtros</button>
            </section>

            <section id="kpi-container" aria-label="Indicadores clave de rendimiento"></section>
            
            <section class="settings-section" aria-labelledby="concepto-totals-title">
                <h3 id="concepto-totals-title" class="section-title"><span class="material-icons">category</span>Totales por Concepto</h3>
                <div id="concepto-totals-list"></div>
            </section>

            <section class="settings-section" aria-labelledby="filtered-movements-title">
                <h3 id="filtered-movements-title" class="section-title"><span class="material-icons">list_alt</span>Detalle de Movimientos</h3>
                <div id="filtered-movements-list"></div>
                <div id="filtered-movements-summary" style="text-align: right; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--outline);"></div>
            </section>
        </div>

        <!-- VISTA: Movimientos -->
        <div id="movimientos-page" class="view">
            <div class="top-bar">
                <h1 class="top-bar-title">Movimientos</h1>
                <div class="top-bar-actions">
                     <input type="search" id="search-movimientos" class="form-input" placeholder="Buscar..." style="width: 150px; height: 38px;">
                </div>
            </div>
            <div id="movimientos-list"></div>
            <div id="empty-movimientos" class="empty-state" style="display: none;">
                <span class="material-icons">receipt_long</span>
                <h3>Sin Movimientos</h3>
                <p>A√±ade tu primer movimiento con el bot√≥n de abajo.</p>
            </div>
        </div>

        <!-- VISTA: Cuentas -->
        <div id="cuentas-page" class="view">
             <div class="top-bar"><h1 class="top-bar-title">Cuentas</h1></div>
             <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">person</span>Saldos por Propietario</h3>
                <div class="form-group">
                    <label class="form-label">Filtrar por Tipo de Cuenta:</label>
                    <div id="filter-account-types-pills" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;"></div>
                </div>
                <div id="resumen-propietario-container"></div>
             </section>
             <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">account_balance</span>Saldos por Tipo</h3>
                <div id="cuentas-accordion-container"></div>
             </section>
        </div>

        <!-- VISTA: Presupuestos -->
        <div id="presupuestos-page" class="view">
            <div class="top-bar"><h1 class="top-bar-title">Presupuestos</h1></div>
            <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">add_circle_outline</span>Nuevo Presupuesto</h3>
                <form id="form-presupuesto" novalidate>
                    <div class="form-grid">
                        <div class="form-group"><label for="presupuesto-ano" class="form-label">A√±o</label><input type="number" id="presupuesto-ano" required placeholder="2024" min="2000" max="2100" class="form-input"><span class="error-message" id="presupuesto-ano-error"></span></div>
                        <div class="form-group"><label for="presupuesto-beneficiario-p" class="form-label">Propietario</label><select id="presupuesto-beneficiario-p" required class="form-select"></select><span class="error-message" id="presupuesto-beneficiario-p-error"></span></div>
                    </div>
                    <div class="form-group"><label for="presupuesto-concepto" class="form-label">Concepto</label><select id="presupuesto-concepto" required class="form-select"></select><span class="error-message" id="presupuesto-concepto-error"></span></div>
                    <div class="form-group"><label for="presupuesto-cantidad" class="form-label">L√≠mite Gasto Anual</label><input type="text" id="presupuesto-cantidad" inputmode="decimal" required placeholder="1200,00" class="form-input"><span class="error-message" id="presupuesto-cantidad-error"></span></div>
                    <button type="submit" class="btn btn-primary btn-full" id="save-presupuesto-btn">Guardar Presupuesto</button>
                </form>
            </section>
            <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">track_changes</span>Seguimiento Anual</h3>
                <div id="presupuestos-list"></div>
                 <div id="empty-presupuestos" class="empty-state" style="display: none;">
                    <span class="material-icons">pie_chart_outline</span>
                    <h3>Sin Presupuestos</h3>
                    <p>Crea tu primer presupuesto para empezar a hacer seguimiento de tus gastos.</p>
                </div>
            </section>
        </div>

        <!-- VISTA: Configuraci√≥n -->
        <div id="configuracion-page" class="view">
            <div class="top-bar"><h1 class="top-bar-title">Configuraci√≥n</h1></div>
            <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">badge</span>Configuraci√≥n General</h3>
                <div class="form-group"><label for="config-beneficiarios" class="form-label">Propietarios (separados por coma)</label><input type="text" id="config-beneficiarios" placeholder="Dani, Norma, Com√∫n" class="form-input"><span class="error-message" id="config-beneficiarios-error"></span></div>
                <button id="save-config-btn" class="btn btn-primary btn-full">Guardar Configuraci√≥n</button>
            </section>
            <section class="settings-section">
                <h3 class="section-title"><span class="material-icons">backup</span>Gesti√≥n de Datos</h3>
                <p style="font-size: 13px; color: var(--secondary-color); margin-top: -8px; margin-bottom: 12px;">Importar reemplazar√° todos los datos actuales.</p>
                <div class="form-grid">
                    <button id="export-data-btn" class="btn btn-secondary"><span class="material-icons" style="margin-right: 8px; font-size: 18px;">file_download</span>Exportar</button>
                    <button id="import-data-btn" class="btn btn-warning"><span class="material-icons" style="margin-right: 8px; font-size: 18px;">file_upload</span>Importar</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
                <button id="clear-all-data-btn" class="btn btn-danger btn-full" style="margin-top: 12px;">Borrar Todos los Datos</button>
            </section>
        </div>
    </main>

    <!-- Bot√≥n Flotante para a√±adir Movimiento -->
    <button id="fab-add-movimiento" class="fab hidden" title="A√±adir Movimiento"><span class="material-icons">add</span></button>

    <!-- Navegaci√≥n Inferior -->
    <nav class="bottom-nav">
        <button id="nav-panel-control" class="nav-item active" data-page="panel-control-page" data-title="Panel" aria-current="page"><span class="material-icons">dashboard</span><span class="nav-label">Panel</span></button>
        <button id="nav-movimientos" class="nav-item" data-page="movimientos-page" data-title="Movimientos"><span class="material-icons">swap_horiz</span><span class="nav-label">Movim.</span></button>
        <button id="nav-cuentas" class="nav-item" data-page="cuentas-page" data-title="Cuentas"><span class="material-icons">account_balance_wallet</span><span class="nav-label">Cuentas</span></button>
        <button id="nav-presupuestos" class="nav-item" data-page="presupuestos-page" data-title="Presupuestos"><span class="material-icons">pie_chart</span><span class="nav-label">Presup.</span></button>
        <button id="nav-configuracion" class="nav-item" data-page="configuracion-page" data-title="Config."><span class="material-icons">settings</span><span class="nav-label">Config.</span></button>
    </nav>
</div>

<!-- Contenedor de Toasts -->
<div id="toast-container" aria-live="assertive"></div>

<!-- MODAL PARA A√ëADIR/EDITAR MOVIMIENTO -->
<div id="movimiento-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="form-movimiento-title" class="modal-title">A√±adir Movimiento</h3>
            <button class="icon-button close-btn" title="Cerrar"><span class="material-icons">close</span></button>
        </div>
        <div class="modal-body">
             <form id="form-movimiento" novalidate>
                 <input type="hidden" id="movimiento-id">
                 <div class="form-group"><label for="movimiento-tipo-selector" class="form-label">Tipo</label><select id="movimiento-tipo-selector" class="form-select"><option value="movimiento">Movimiento</option><option value="traspaso">Traspaso</option></select></div>
                 <div class="form-grid">
                     <div class="form-group"><label for="movimiento-cantidad" class="form-label">Cantidad (neg=gasto)</label><input type="text" id="movimiento-cantidad" class="form-input" inputmode="decimal" required placeholder="Ej: 50,25"><span class="error-message" id="movimiento-cantidad-error"></span></div>
                     <div class="form-group"><label for="movimiento-fecha" class="form-label">Fecha y Hora</label><input type="datetime-local" id="movimiento-fecha" class="form-input" required><span class="error-message" id="movimiento-fecha-error"></span></div>
                 </div>
                 <div class="form-group"><label for="movimiento-descripcion" class="form-label">Descripci√≥n</label><input type="text" id="movimiento-descripcion" class="form-input" required placeholder="Ej: Compra semanal"><span class="error-message" id="movimiento-descripcion-error"></span></div>
                 
                 <div id="movimiento-fields">
                     <div class="form-group-with-action">
                         <div class="form-group"><label for="movimiento-concepto" class="form-label">Concepto</label><select id="movimiento-concepto" class="form-select" required></select><span class="error-message" id="movimiento-concepto-error"></span></div>
                         <button type="button" class="icon-button" id="manage-conceptos-btn" title="Gestionar Conceptos"><span class="material-icons">more_vert</span></button>
                     </div>
                     <div class="form-group-with-action">
                         <div class="form-group"><label for="movimiento-cuenta" class="form-label">Cuenta</label><select id="movimiento-cuenta" class="form-select" required></select><span class="error-message" id="movimiento-cuenta-error"></span></div>
                         <button type="button" class="icon-button" id="manage-cuentas-btn" title="Gestionar Cuentas"><span class="material-icons">more_vert</span></button>
                     </div>
                     <div class="form-group"><label for="movimiento-beneficiario" class="form-label">Propietario</label><select id="movimiento-beneficiario" class="form-select" required></select><span class="error-message" id="movimiento-beneficiario-error"></span></div>
                 </div>
                 
                 <div id="traspaso-fields" class="hidden form-grid">
                     <div class="form-group"><label for="movimiento-cuenta-origen" class="form-label">Origen</label><select id="movimiento-cuenta-origen" class="form-select" required></select><span class="error-message" id="movimiento-cuenta-origen-error"></span></div>
                     <div class="form-group"><label for="movimiento-cuenta-destino" class="form-label">Destino</label><select id="movimiento-cuenta-destino" class="form-select" required></select><span class="error-message" id="movimiento-cuenta-destino-error"></span></div>
                 </div>
                 
                 <div class="modal-actions">
                    <button type="button" id="delete-movimiento-btn" class="btn btn-danger hidden" style="margin-right: auto;" title="Eliminar"><span class="material-icons">delete</span></button>
                    <button type="submit" class="btn btn-primary" id="save-movimiento-btn">Guardar</button>
                 </div>
             </form>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // NOTA IMPORTANTE DEL DESARROLLADOR: No olvides configurar las REGLAS DE SEGURIDAD en la consola de Firebase.
    // La aplicaci√≥n cliente NO ES SEGURA sin ellas. Ve a Firestore -> Reglas y establece:
    // match /users/{userId}/{documents=**} { allow read, write: if request.auth.uid == userId; }

    const quotesData = [ { "cita": "Los inversores conservadores duermen bien.", "autor": "Benjamin Graham" }, { "cita": "Nunca asciendas a alguien que no ha cometido errores, porque si lo haces, est√°s ascendiendo a alguien que nunca ha hecho nada.", "autor": "Benjamin Graham" }, { "cita": "Si se han hecho los deberes antes de comprar una acci√≥n, el momento de venderla es: normalmente, nunca.", "autor": "Benjamin Graham" }, { "cita": "Mientras que el entusiasmo es necesario para conseguir grandes logros en cualquier lugar, en Wall Street suele conducir al desastre.", "autor": "John Templeton" }, { "cita": "Sin tener fe en el futuro, nadie invertir√≠a. Para ser inversor, debes creer en un ma√±ana mejor.", "autor": "John Templeton" }, { "cita": "Las cuatro palabras m√°s caras de nuestro lenguaje son: 'Esta vez es diferente'.", "autor": "John Templeton" }, { "cita": "C√©ntrate en el valor porque la mayor√≠a de los inversores se fijan en perspectivas y tendencias.", "autor": "Peter Lynch" }, { "cita": "El √©xito es un proceso de b√∫squeda continua de respuestas a nuevas preguntas.", "autor": "Peter Lynch" }, { "cita": "Conoce en lo que inviertes, y por qu√©.", "autor": "Peter Lynch" }, { "cita": "Cuando vendes en momentos de desesperaci√≥n, siempre vendes barato.", "autor": "Peter Lynch" }, { "cita": "Una persona que posee una propiedad y tiene una participaci√≥n en la empresa probablemente trabajar√° m√°s duro, se sentir√° m√°s feliz y har√° un mejor trabajo que otra que no tiene nada.", "autor": "Peter Lynch" }, { "cita": "El riesgo viene de no saber lo que se est√° haciendo.", "autor": "Warren Buffett" }, { "cita": "Cuesta 20 a√±os construir una reputaci√≥n y 5 minutos destruirla. Si piensas sobre ello, har√°s las cosas de manera diferente.", "autor": "Warren Buffett" }, { "cita": "En el mundo de los negocios, el espejo retrovisor est√° siempre m√°s claro que el parabrisas.", "autor": "Warren Buffett" }, { "cita": "La inversi√≥n m√°s importante que puedes hacer es en uno mismo.", "autor": "Warren Buffett" }, { "cita": "S√© temeroso cuando otros sean avariciosos, s√© avaricioso cuando otros sean temerosos.", "autor": "Warren Buffett" }, { "cita": "S√© consciente de lo que no sabes. Si√©ntete a gusto entendiendo tus errores y debilidades.", "autor": "Charlie Munger" }, { "cita": "Para hacer dinero en los mercados, tienes que pensar diferente y ser humilde.", "autor": "Charlie Munger" }, { "cita": "El mayor error que los inversores hacen es creer que lo que ha pasado en el pasado reciente probablemente persistir√°.", "autor": "Charlie Munger" }, { "cita": "El principal problema del inversor, e incluso su peor enemigo, es probablemente √©l mismo", "autor": "Benjamin Graham" }, { "cita": "Las personas que no pueden controlar sus emociones no son aptas para obtener beneficios mediante la inversi√≥n", "autor": "Benjamin Graham" }, { "cita": "Trato de comprar acciones en los negocios que son tan maravillosos que un tonto podr√≠a manejarlos. Tarde o temprano uno lo har√°", "autor": "Warren Buffett" }, { "cita": "Un inversor deber√≠a actuar como si tuviera una tarjeta con s√≥lo 20 decisiones (de compra) para tomar a lo largo de su vida", "autor": "Warren Buffett" }, { "cita": "Regla n√∫mero 1: nunca pierdas dinero. Regla n√∫mero 2: nunca olvides la regla n√∫mero 1", "autor": "Warren Buffett" }, { "cita": "Se gana dinero descontando lo obvio y apostando a lo inesperado", "autor": "George Soros" }, { "cita": "El problema no es lo que uno no sabe, sino lo que uno cree que sabe estando equivocado", "autor": "George Soros" }, { "cita": "Si invertir es entretenido, si te est√°s divirtiendo, probablemente no est√©s ganando dinero. Las buenas inversiones son aburridas", "autor": "George Soros" }, { "cita": "Se puede perder dinero a corto plazo, pero necesitas del largo plazo para ganar dinero", "autor": "Peter Lynch" }, { "cita": "La mejor empresa para comprar puede ser alguna que ya tienes en cartera", "autor": "Peter Lynch" }, { "cita": "La clave para ganar dinero con las acciones es no tenerles miedo", "autor": "Peter Lynch" }, { "cita": "Los mercados alcistas nacen en el pesimismo, crecen en el escepticismo, maduran en el optimismo y mueren en la euforia", "autor": "John Templeton" }, { "cita": "El momento de m√°ximo pesimismo es el mejor para comprar y el momento de m√°ximo optimismo es el mejor para vender", "autor": "John Templeton" }, { "cita": "Un inversor que tiene todas las respuestas ni siquiera entiende las preguntas", "autor": "John Templeton" }, { "cita": "La inversi√≥n es un negocio a largo plazo donde la paciencia marca la rentabilidad", "autor": "Francisco Garc√≠a Param√©s" }, { "cita": "¬øCu√°ndo vendemos un valor?, respondemos siempre: cuando haya una oportunidad mejor. Ese es nuestro objetivo permanente, mejorar la cartera cada d√≠a", "autor": "Francisco Garc√≠a Param√©s" }, { "cita": "Lo que en la Bolsa saben todos, no me interesa", "autor": "Andr√© Kostolany" }, { "cita": "No sirve para nada proclamar la verdad en econom√≠a o recomendar cosas √∫tiles. Es la mejor manera de hacerse enemigos", "autor": "Andr√© Kostolany" }, { "cita": "Un inversionista pierde la capacidad de raciocinio cuando gana los primeros diez mil d√≥lares. A partir de entonces se convierte en un pelele f√°cilmente manipulable", "autor": "Andr√© Kostolany" }, { "cita": "Comprar t√≠tulos, acciones de empresas, tomarse unas pastillas para dormir durante 20/30 a√±os y cuando uno despierta, voil√†! es millonario", "autor": "Andr√© Kostolany" }, { "cita": "No s√© si los pr√≥ximos 1.000 puntos del Dow Jones ser√°n hacia arriba o hacia abajo, pero estoy seguro de que los pr√≥ximos 10.000 ser√°n hacia arriba", "autor": "Peter Lynch" }, { "cita": "El destino de un inversor lo marca su est√≥mago , no su cerebro", "autor": "Peter Lynch" }, { "cita": "No siga mis pasos porque a√∫n en el caso de que acierte al comprar usted no sabr√° cu√°ndo vendo", "autor": "Peter Lynch" }, { "cita": "Calcule las 'ganancias del due√±o' para conseguir una reflexi√≥n verdadera del valor", "autor": "Warren Buffett" }, { "cita": "Busque compa√±√≠as con altos m√°rgenes de beneficio", "autor": "Warren Buffett" }, { "cita": "Invierta siempre para el largo plazo", "autor": "Warren Buffett" }, { "cita": "El consejo de que 'usted nunca quiebra tomando un beneficio' es absurdo", "autor": "Warren Buffett" }, { "cita": "¬øEl negocio tiene una historia de funcionamiento constante?", "autor": "Warren Buffett" }, { "cita": "Recuerde que el mercado de valores es maniaco-depresivo", "autor": "Benjamin Graham" }, { "cita": "Compre un negocio, no alquile la acci√≥n", "autor": "Warren Buffett" }, { "cita": "Mientras m√°s absurdo sea el comportamiento del mercado mejor ser√° la oportunidad para el inversor met√≥dico", "autor": "Benjamin Graham" }, { "cita": "Puedes sobrevivir, pero sigues siendo un idiota", "autor": "Joel Greenblatt" }, { "cita": "Los mercados alcistas no tienen resistencia y los bajistas no tienen soporte", "autor": "Ed Downs" }, { "cita": "El p√°nico causa que vendas en el baj√≥n, y la codicia causa que compres cerca a la cima", "autor": "Stan Weinstein" }, { "cita": "Las dos grandes fuerzas que mueven los mercados son la codicia y el miedo", "autor": "An√≥nimo" }, { "cita": "Todo lo que sube baja y todo lo que baja sube", "autor": "An√≥nimo" }, { "cita": "Si no sientes miedo en el momento de comprar es que est√°s comprando mal", "autor": "An√≥nimo" }, { "cita": "Que el √∫ltimo duro lo gane otro", "autor": "An√≥nimo" }, { "cita": "La clave para hacer dinero en acciones es no asustarse de ellas", "autor": "Peter Lynch" }, { "cita": "El precio es lo que pagas, el valor es lo que recibes", "autor": "Warren Buffett" }, { "cita": "No es necesario hacer cosas extraordinarias para conseguir resultados extraordinarios", "autor": "Warren Buffett" }, { "cita": "Alguien est√° sentado en la sombra hoy porque alguien plant√≥ un √°rbol mucho tiempo atr√°s", "autor": "Warren Buffett" }, { "cita": "√önicamente cuando la marea baja, descubres qui√©n ha estado nadando desnudo", "autor": "Warren Buffett" }, { "cita": "No tenemos que ser m√°s inteligentes que el resto, tenemos que ser m√°s disciplinados que el resto", "autor": "Warren Buffett" }, { "cita": "Si compras cosas que no necesitas, pronto tendr√°s que vender cosas que necesitas", "autor": "Warren Buffett" }, { "cita": "Nunca inviertas en un negocio que no puedas entender", "autor": "Warren Buffett" }, { "cita": "El tiempo es amigo de las empresas maravillosas y enemigo de las mediocres", "autor": "Warren Buffett" }, { "cita": "Nuestro per√≠odo de espera favorito es para siempre", "autor": "Warren Buffett" }, { "cita": "Wall Street es el √∫nico lugar al que las personas van en un Rolls-Royce, para recibir asesor√≠a de quienes toman el metro", "autor": "Warren Buffett" }, { "cita": "Llega un momento en el que debes empezar a hacer lo que realmente quieres. Busca un trabajo que te guste y saltar√°s de la cama cada ma√±ana con fuerza", "autor": "Warren Buffett" }, { "cita": "Es siempre mejor pasar el tiempo con gente mejor que t√∫. Escoge asociados cuyo comportamiento es mejor que el tuyo e ir√°s en esa direcci√≥n", "autor": "Warren Buffett" }, { "cita": "Toma 20 a√±os en construir una reputaci√≥n y 5 minutos en arruinarla. Si piensas sobre ello, har√°s las cosas de forma diferente", "autor": "Warren Buffett" }, { "cita": "No importa el talento o los esfuerzos, hay cosas que llevan tiempo. No puedes producir un beb√© en un mes dejando embarazadas a 9 mujeres", "autor": "Warren Buffett" }, { "cita": "Las oportunidades aparecen pocas veces. Cuando llueva oro sal a la calle con un cesto grande y no con un dedal", "autor": "Warren Buffett" }, { "cita": "La gente siempre me pregunta d√≥nde deber√≠an trabajar y yo siempre les digo que vayan a trabajar con aquellos a los que m√°s admiran", "autor": "Warren Buffett" }, { "cita": "¬øCuando hay que vender una acci√≥n? Pues cuando tengamos una oportunidad mejor a la vista", "autor": "Francisco Garc√≠a Param√©s" }, { "cita": "Nunca acudo a las OPV, me gusta estar en las empresas que pueden ser opadas por competidores, no en las salidas a bolsa", "autor": "Francisco Garc√≠a Param√©s" }, { "cita": "Si en el mercado hay m√°s tontos que papel, la bolsa va to subir, si hay m√°s papel que tontos, la bolsa baja", "autor": "Andr√© Kostolany" }, { "cita": "No persiga nunca una acci√≥n, tenga paciencia que la pr√≥xima oportunidad va a llegar con toda seguridad", "autor": "Andr√© Kostolany" }, { "cita": "Lo que todos saben en la bolsa, no nos interesa a los especuladores", "autor": "Andr√© Kostolany" }, { "cita": "Los mercados financieros est√°n dise√±ados para transferir dinero del impaciente al paciente.", "autor": "Warren Buffett" }, { "cita": "Invertir es como hacer dieta.", "autor": "Warren Buffett" }, { "cita": "Lo que aprendemos de la historia es que las personas no aprenden de la historia.", "autor": "Warren Buffett" }, { "cita": "Invierte en negocios que hasta un tonto podr√≠a dirigir. Porque m√°s pronto que tarde uno acabar√° haci√©ndolo.", "autor": "Warren Buffett" }, { "cita": "Las empresas sin deuda no puede quebrar", "autor": "Warren Buffett" }, { "cita": "Invierte en empresas sencillas, sin brillo, mundanas, al margen de las modas y que no hayan llamado la atenci√≥n de Wall Street.", "autor": "Warren Buffett" }, { "cita": "Invierte s√≥lo en empresas en las que estar√≠as tranquilo si no puedes conocer la cotizaci√≥n diaria.", "autor": "Warren Buffett" }, { "cita": "Las inversiones exitosas consisten en saber gestionar el riesgo, no en evitarlo.", "autor": "Benjamin Graham" }, { "cita": "Una gran compa√±√≠a no es una buena inversi√≥n si pagas mucho por la acci√≥n", "autor": "Benjamin Graham" }, { "cita": "A veces es mejor pensar una hora sobre el dinero que dedicar una semana a trabajar para obtenerlo.", "autor": "Andr√© Kostolany" }, { "cita": "En la Bolsa, con frecuencia, hay que cerrar los ojos para ver mejor.", "autor": "Andr√© Kostolany" }, { "cita": "Si la inversi√≥n es entretenida, si te est√°s divirtiendo, es probable que no est√©s ganando dinero. Una buena inversi√≥n es aburrida.", "autor": "George Soros" }, { "cita": "Las burbujas del mercado de valores no crecen de la nada. Tienen una base s√≥lida en la realidad, pero la realidad est√° distorsionada por un malentendido.", "autor": "George Soros" }, { "cita": "Nunca digas que no puedes permitirte algo. Esa es la aptitud de un hombre pobre. Preg√∫ntate c√≥mo permit√≠rtelo.", "autor": "Robert Kiyosaki" }, { "cita": "Una diferencia importante es que los ricos compran los lujos a final, mientras que los pobres y la clase media tienden a comprar los lujos primero.", "autor": "Robert Kiyosaki" }, { "cita": "Mant√©n tus activos bajo m√≠nimos, reduce los pasivos y, con mucha disciplina, ve construyendo una base de activos s√≥lida.", "autor": "Robert Kiyosaki" }, { "cita": "No ahorres lo que queda despu√©s de gastar, sino gasta lo que queda despu√©s de ahorrar.", "autor": "Warren Buffett" }, { "cita": "El riesgo viene de no saber lo que est√°s haciendo.", "autor": "Warren Buffett" }, { "cita": "Sea temeroso cuando otros son codiciosos, y sea codicioso cuando otros son temerosos.", "autor": "Warren Buffett" }, { "cita": "No compres cosas que no necesitas, con dinero que no tienes, para impresionar a gente que no te importa.", "autor": "Dave Ramsey" } ];
    
    const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };
    firebase.initializeApp(firebaseConfig);
    const fbAuth = firebase.auth();
    const fbDb = firebase.firestore();
    let currentUser = null;
    let unsubscribeFromDb = null;
    let saveTimeout = null;
    const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    let db = {};
    const getInitialDb = () => ({ cuentas: [], conceptos: [], movimientos: [], presupuestos: [], config: { beneficiarios: ["Dani", "Norma", "Com√∫n"] } });
    const saveData = (buttonElement = null, successCallback = () => {}) => {
        if (!currentUser) { showToast("No hay usuario autenticado para guardar datos."); return; }
        clearTimeout(saveTimeout);
        if (buttonElement) setButtonLoading(buttonElement, true, 'Guardando...');
        saveTimeout = setTimeout(() => {
            fbDb.collection('users').doc(currentUser.uid).set({ db })
                .then(() => { if (buttonElement) setButtonLoading(buttonElement, false); successCallback(); })
                .catch(error => { console.error("Error al guardar: ", error); showToast("Error al guardar en la nube."); if (buttonElement) setButtonLoading(buttonElement, false); });
        }, 800);
    };
    const loadData = (uid) => {
        const userDocRef = fbDb.collection('users').doc(uid);
        if (unsubscribeFromDb) unsubscribeFromDb();
        unsubscribeFromDb = userDocRef.onSnapshot(doc => {
            if (doc.exists) {
                db = doc.data().db || getInitialDb();
                if (!db.presupuestos) db.presupuestos = [];
                if (!db.config || !db.config.beneficiarios || db.config.beneficiarios.length === 0) { db.config = { beneficiarios: ["Dani", "Norma", "Com√∫n"] }; }
            } else { db = getInitialDb(); saveData(); }
            startMainApp();
        }, error => { console.error("Error de conexi√≥n:", error); showToast("Error de conexi√≥n a la base de datos."); });
    };
    
    const select = id => document.getElementById(id);
    const selectAll = s => document.querySelectorAll(s);
    const vibrate = (duration = 10) => { if ('vibrate' in navigator) { try { navigator.vibrate(duration); } catch (e) {} } };
    
    const showToast = (message) => {
        const tc = select('toast-container'); if (!tc) return;
        const t = document.createElement('div');
        t.className = 'toast'; t.textContent = message;
        tc.appendChild(t);
        setTimeout(() => t.remove(), 3300);
    };

    const formatNumber = (num) => (num || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    const originalButtonTexts = new Map();
    const setButtonLoading = (buttonEl, isLoading, loadingText = 'Cargando...') => {
        if (!buttonEl) return;
        if (isLoading) {
            if (!originalButtonTexts.has(buttonEl)) originalButtonTexts.set(buttonEl, buttonEl.innerHTML);
            buttonEl.disabled = true;
            buttonEl.classList.add('btn-loading');
            buttonEl.innerHTML = `<span class="btn-text">${loadingText}</span> <span class="spinner"></span>`;
        } else {
            buttonEl.disabled = false;
            buttonEl.classList.remove('btn-loading');
            if (originalButtonTexts.has(buttonEl)) {
                buttonEl.innerHTML = originalButtonTexts.get(buttonEl);
                originalButtonTexts.delete(buttonEl);
            }
        }
    };
    
    const displayError = (elementId, message) => { const errorEl = select(`${elementId}-error`); if (errorEl) { errorEl.textContent = message; errorEl.setAttribute('role', 'alert'); const inputEl = select(elementId); if (inputEl) inputEl.classList.add('is-invalid'); } };
    const clearError = (elementId) => { const errorEl = select(`${elementId}-error`); if (errorEl) { errorEl.textContent = ''; errorEl.removeAttribute('role'); const inputEl = select(elementId); if (inputEl) inputEl.classList.remove('is-invalid'); } };
    const clearAllErrors = (formId) => { const form = select(formId); if (!form) return; form.querySelectorAll('.error-message').forEach(el => { el.textContent = ''; }); form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid')); };
    function getRandomQuote() { return quotesData[Math.floor(Math.random() * quotesData.length)]; }

    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    const initApp = async () => {
        setupTheme();
        attachEventListeners();
        const splashScreen = select('splashScreen');
        const quoteScreen = select('quoteScreen');

        await wait(2500);
        if (splashScreen) {
            splashScreen.style.opacity = '0';
            await wait(500);
            splashScreen.remove();
        }

        if (quoteScreen && quotesData.length > 0) {
            const quoteTextEl = select('quoteText');
            const quoteAuthorEl = select('quoteAuthor');
            const randomQuote = getRandomQuote();
            quoteTextEl.textContent = `"${randomQuote.cita}"`;
            quoteAuthorEl.textContent = `- ${randomQuote.autor}`;
            
            quoteScreen.style.display = 'flex';
            await wait(50);
            quoteScreen.style.opacity = '1';

            await wait(3000);
            quoteScreen.style.opacity = '0';
            await wait(500);
            quoteScreen.remove();
        }

        checkAuthState();
    };

    const startMainApp = () => { select('login-screen').classList.remove('visible'); select('app-root').classList.add('visible'); document.body.style.overflow = ''; renderAll(); navigateTo(select('.nav-item.active')?.dataset.page || 'panel-control-page'); };
    const showLoginScreen = () => { select('app-root').classList.remove('visible'); select('login-screen').classList.add('visible'); document.body.style.overflow = 'hidden'; };
    const renderAll = () => { populateAllDropdowns(); renderMovimientos(); renderCuentas(); renderPresupuestos(); loadConfig(); updateDashboard(); };
    const checkAuthState = () => { fbAuth.onAuthStateChanged(user => { if (user) { currentUser = user; loadData(user.uid); } else { currentUser = null; if (unsubscribeFromDb) unsubscribeFromDb(); db = getInitialDb(); showLoginScreen(); } }); };
    const handleLogin = () => { const email = select('login-email').value.trim(), password = select('login-password').value, errorEl = select('login-error'), loginBtn = select('login-btn'); clearAllErrors('login-form'); errorEl.textContent = ''; let valid = true; if (!email) { displayError('login-email', 'El correo es obligatorio.'); valid = false; } if (!password) { displayError('login-password', 'La contrase√±a es obligatoria.'); valid = false; } if (!valid) return; setButtonLoading(loginBtn, true, 'Iniciando...'); fbAuth.signInWithEmailAndPassword(email, password).then(() => { showToast(`Bienvenido/a de nuevo!`); setButtonLoading(loginBtn, false); }).catch(error => { setButtonLoading(loginBtn, false); if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') { errorEl.textContent = 'Error: Credenciales incorrectas.'; } else if (error.code === 'auth/invalid-email') { displayError('login-email', 'Formato de correo no v√°lido.'); } else { errorEl.textContent = 'Error al iniciar sesi√≥n.'; } }); };
    const handleRegister = () => { const email = select('login-email').value.trim(), password = select('login-password').value, errorEl = select('login-error'), registerBtn = select('register-btn'); clearAllErrors('login-form'); errorEl.textContent = ''; let valid = true; if (!email) { displayError('login-email', 'El correo es obligatorio.'); valid = false; } if (!password) { displayError('login-password', 'La contrase√±a es obligatoria.'); valid = false; } if (!valid) return; setButtonLoading(registerBtn, true, 'Registrando...'); fbAuth.createUserWithEmailAndPassword(email, password).then(() => { showToast(`Registro completado. ¬°Bienvenido/a!`); setButtonLoading(registerBtn, false); }).catch(error => { setButtonLoading(registerBtn, false); if (error.code == 'auth/weak-password') { displayError('login-password', 'La contrase√±a debe tener al menos 6 caracteres.'); } else if (error.code == 'auth/email-already-in-use') { displayError('login-email', 'El correo ya est√° registrado.'); } else if (error.code === 'auth/invalid-email') { displayError('login-email', 'Formato de correo no v√°lido.'); } else { errorEl.textContent = 'Error en el registro.'; } }); };
    const handleLogout = () => { fbAuth.signOut().then(() => {showToast("Sesi√≥n cerrada."); location.reload()}).catch(() => showToast("Error al cerrar sesi√≥n.")); };
    
    const navigateTo = (pageId) => { 
        if(!pageId) return; 
        vibrate(); 
        selectAll('.view').forEach(p => p.classList.remove('active')); 
        select(pageId)?.classList.add('active'); 
        selectAll('.nav-item').forEach(b => { 
            b.classList.remove('active'); 
            b.removeAttribute('aria-current'); 
        }); 
        const activeBtn = document.querySelector(`.nav-item[data-page="${pageId}"]`); 
        if (activeBtn) { 
            activeBtn.classList.add('active'); 
            activeBtn.setAttribute('aria-current', 'page');
        }
        
        select('fab-add-movimiento').classList.toggle('hidden', pageId !== 'movimientos-page');
        
        if (pageId === 'panel-control-page') updateDashboard(); 
        if (pageId === 'cuentas-page') renderCuentas(); 
        if (pageId === 'presupuestos-page') renderPresupuestos();
        if (pageId === 'movimientos-page') renderMovimientos();
    };
    
    const setupTheme = () => { const theme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', theme); selectAll('.icon-button[title="Cambiar Tema"] .material-icons').forEach(icon => icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode'); };
    let selectedAccountTypesFilter = new Set();
    const getLiquidAccounts = () => { const NON_LIQUID_TYPES = ['PROPIEDAD', 'PR√âSTAMO']; return (db.cuentas || []).filter(c => !NON_LIQUID_TYPES.includes((c.tipo || '').trim().toUpperCase())); };
    
    const getSaldos = () => {
        const saldos = (db.cuentas || []).reduce((acc, c) => ({ ...acc, [c.id]: 0 }), {});
        (db.movimientos || []).forEach(m => {
            if (m.tipo === 'traspaso') {
                if (saldos[m.cuentaOrigenId] !== undefined) saldos[m.cuentaOrigenId] -= m.cantidad;
                if (saldos[m.cuentaDestinoId] !== undefined) saldos[m.cuentaDestinoId] += m.cantidad;
            } else {
                if (saldos[m.cuentaId] !== undefined) saldos[m.cuentaId] += m.cantidad;
            }
        });
        return saldos;
    };

    const populateAllDropdowns = () => { const populate = (el, data, nameKey, valKey = 'id', allOption = false) => { if (!el) return; const currentVal = el.value; el.innerHTML = allOption ? '<option value="">Todos</option>' : ''; [...data].sort((a, b) => (a.nombre || "").localeCompare(b.nombre || "")).forEach(i => { const option = document.createElement('option'); option.value = i[valKey]; option.textContent = i[nameKey]; el.appendChild(option); }); if (Array.from(el.options).some(opt => opt.value === currentVal)) { el.value = currentVal; } else if (!allOption && el.options.length > 0) { el.value = el.options[0].value; } }; const owners = (db.config.beneficiarios || []).map(b => ({ id: b, nombre: b })); populate(select('movimiento-beneficiario'), owners, 'nombre', 'id'); populate(select('presupuesto-beneficiario-p'), owners, 'nombre', 'id'); populate(select('filter-beneficiario'), owners, 'nombre', 'id', true); populate(select('movimiento-cuenta'), db.cuentas, 'nombre', 'id'); populate(select('movimiento-cuenta-origen'), db.cuentas, 'nombre', 'id'); populate(select('movimiento-cuenta-destino'), db.cuentas, 'nombre', 'id'); populate(select('filter-cuenta'), db.cuentas, 'nombre', 'id', true); populate(select('movimiento-concepto'), db.conceptos, 'nombre', 'id'); populate(select('presupuesto-concepto'), db.conceptos, 'nombre', 'id'); populate(select('filter-concepto'), db.conceptos, 'nombre', 'id', true); };
    
    const renderCuentas = () => {
        const accordionContainer = select('cuentas-accordion-container'), resumenContainer = select('resumen-propietario-container'), filterPillsContainer = select('filter-account-types-pills');
        if (!accordionContainer || !resumenContainer || !filterPillsContainer) return;
        const saldos = getSaldos();
        const allLiquidAccounts = getLiquidAccounts();

        const distinctLiquidTypes = [...new Set(allLiquidAccounts.map(c => (c.tipo || '').trim().toUpperCase()))].sort();
        filterPillsContainer.innerHTML = '';
        distinctLiquidTypes.forEach(type => {
            const pill = document.createElement('button');
            pill.className = 'filter-pill'; pill.dataset.type = type; pill.textContent = type;
            if (selectedAccountTypesFilter.has(type)) pill.classList.add('active');
            pill.onclick = () => { vibrate(); pill.classList.toggle('active'); pill.classList.contains('active') ? selectedAccountTypesFilter.add(type) : selectedAccountTypesFilter.delete(type); renderCuentasByOwner(); };
            filterPillsContainer.appendChild(pill);
        });

        const renderCuentasByOwner = () => {
            resumenContainer.innerHTML = '';
            const filteredAccounts = selectedAccountTypesFilter.size === 0 ? allLiquidAccounts : allLiquidAccounts.filter(c => selectedAccountTypesFilter.has((c.tipo || 'SIN TIPO').trim().toUpperCase()));
            (db.config.beneficiarios || []).filter(b => b !== 'Com√∫n').forEach(owner => {
                const ownerAccounts = filteredAccounts.filter(c => c.propietario === owner || c.propietario === 'Com√∫n');
                const saldoNetoEnCentimos = ownerAccounts.reduce((sum, c) => sum + (saldos[c.id] || 0), 0);
                
                const details = document.createElement('details');
                details.className = 'accordion-item';
                const ownerClass = owner.toLowerCase().replace(/\s/g, '');
                details.innerHTML = `
                    <summary>
                        <span class="owner-${ownerClass}-text" style="font-weight: bold;">${owner === "Dani" ? "üë®‚Äçüíº" : "üë©‚Äçüíº"} ${owner}</span>
                        <span>
                            <strong class="owner-${ownerClass}-text">${formatNumber(saldoNetoEnCentimos / 100)} ‚Ç¨</strong>
                            <span class="material-icons expand-icon">expand_more</span>
                        </span>
                    </summary>
                    <div class="accordion-content">
                        ${ownerAccounts.length > 0 ? ownerAccounts.sort((a, b) => a.nombre.localeCompare(b.nombre)).map(c => `
                            <div class="list-item-card owner-${c.propietario.toLowerCase().replace(/\s/g, '')}-border">
                                <div class="item-content">
                                    <div class="item-details">
                                        <div class="item-title">${c.nombre}</div>
                                        <div class="item-meta">${c.propietario}</div>
                                    </div>
                                    <div class="item-amount"><strong>${formatNumber((saldos[c.id] || 0) / 100)} ‚Ç¨</strong></div>
                                </div>
                            </div>`).join('') : '<div class="empty-state" style="padding: 16px 0;"><p>No hay cuentas para el filtro.</p></div>'
                        }
                    </div>`;
                resumenContainer.appendChild(details);
            });
        };

        const renderCuentasByType = () => {
            accordionContainer.innerHTML = '';
            const totalLiquidoEnCentimos = allLiquidAccounts.reduce((sum, c) => sum + (saldos[c.id] || 0), 0);
            const cuentasPorTipo = allLiquidAccounts.reduce((acc, c) => {
                const tipo = (c.tipo || 'SIN TIPO').trim().toUpperCase();
                (acc[tipo] = acc[tipo] || []).push(c);
                return acc;
            }, {});

            Object.keys(cuentasPorTipo).sort().forEach(tipo => {
                const details = document.createElement('details');
                details.className = 'accordion-item';
                const saldoGrupoEnCentimos = cuentasPorTipo[tipo].reduce((s, c) => s + (saldos[c.id] || 0), 0);
                const porcText = totalLiquidoEnCentimos !== 0 ? `<span style="font-size:12px;color:var(--secondary-color);margin-left:8px;font-weight:400;">(${(saldoGrupoEnCentimos / totalLiquidoEnCentimos * 100).toFixed(1)}%)</span>` : '';
                const icon = tipo === 'EFECTIVO' ? 'payments' : (tipo.includes('TARJETA') ? 'credit_card' : 'account_balance');
                
                details.innerHTML = `
                    <summary>
                        <span><span class="material-icons" style="vertical-align: bottom; font-size: 20px; margin-right: 8px;">${icon}</span>${tipo}</span>
                        <span>
                            <strong>${formatNumber(saldoGrupoEnCentimos / 100)} ‚Ç¨</strong>${porcText}
                            <span class="material-icons expand-icon">expand_more</span>
                        </span>
                    </summary>
                    <div class="accordion-content">
                        ${cuentasPorTipo[tipo].sort((a,b) => a.nombre.localeCompare(b.nombre)).map(c => `
                            <div class="list-item-card owner-${c.propietario.toLowerCase().replace(/\s/g, '')}-border">
                                <div class="item-content">
                                    <div class="item-details">
                                        <div class="item-title">${c.nombre}</div>
                                        <div class="item-meta">${c.propietario}</div>
                                    </div>
                                    <div class="item-amount"><strong>${formatNumber((saldos[c.id] || 0) / 100)} ‚Ç¨</strong></div>
                                </div>
                            </div>`).join('')
                        }
                    </div>`;
                accordionContainer.appendChild(details);
            });
        };
        renderCuentasByOwner();
        renderCuentasByType();
    };
    
    const renderMovimientos = (filterText = '') => {
        const listContainer = select('movimientos-list');
        const emptyState = select('empty-movimientos');
        if (!listContainer || !emptyState) return;

        const lowerFilter = filterText.toLowerCase();
        const filtered = (db.movimientos || []).filter(m => {
            const concept = db.conceptos.find(c => c.id === m.conceptoId)?.nombre || '';
            const account = m.tipo === 'traspaso' ? `${db.cuentas.find(c => c.id === m.cuentaOrigenId)?.nombre || ''} ${db.cuentas.find(c => c.id === m.cuentaDestinoId)?.nombre || ''}` : (db.cuentas.find(c => c.id === m.cuentaId)?.nombre || '');
            return m.descripcion.toLowerCase().includes(lowerFilter) || concept.toLowerCase().includes(lowerFilter) || account.toLowerCase().includes(lowerFilter);
        });

        listContainer.innerHTML = '';
        if (filtered.length === 0) {
            emptyState.style.display = 'block';
            emptyState.querySelector('p').textContent = filterText ? 'No hay movimientos que coincidan.' : 'A√±ade tu primer movimiento con el bot√≥n (+).';
            return;
        }
        
        emptyState.style.display = 'none';
        filtered.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(m => {
            const item = document.createElement('div');
            const ownerClass = m.beneficiario ? `owner-${m.beneficiario.toLowerCase().replace(/\s/g, '')}-border` : '';
            const cantidadEnEuros = m.cantidad / 100;
            const amountHtml = m.tipo === 'traspaso' ? `<span class="text-info">${formatNumber(cantidadEnEuros)} ‚Ç¨</span>` : (cantidadEnEuros < 0 ? `<span class="text-negative">${formatNumber(cantidadEnEuros)} ‚Ç¨</span>` : `<span class="text-positive">+${formatNumber(cantidadEnEuros)} ‚Ç¨</span>`);
            const metaInfo = m.tipo === 'traspaso' ? `Traspaso: ${(db.cuentas.find(c => c.id === m.cuentaOrigenId)?.nombre || '?')} ‚Üí ${(db.cuentas.find(c => c.id === m.cuentaDestinoId)?.nombre || '?')}` : `${(db.conceptos.find(c => c.id === m.conceptoId)?.nombre || 'Sin Concepto')} en ${(db.cuentas.find(c => c.id === m.cuentaId)?.nombre || 'Sin Cuenta')}`;
            
            item.className = `list-item-card ${ownerClass}`;
            item.dataset.id = m.id;
            item.innerHTML = `
                <div class="item-content" data-action="edit">
                    <div class="item-details">
                        <div class="item-title">${m.descripcion}</div>
                        <div class="item-meta">${new Date(m.fecha).toLocaleString('es-ES', {day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</div>
                        <div class="item-meta">${metaInfo}</div>
                    </div>
                    <div class="item-amount">${amountHtml}</div>
                </div>
                <div class="item-actions">
                    <button class="icon-button" data-action="delete" title="Eliminar"><span class="material-icons">delete_outline</span></button>
                </div>`;

            item.querySelector('[data-action="edit"]').onclick = () => startEditMovement(m.id);
            item.querySelector('[data-action="delete"]').onclick = () => confirmDeleteMovement(m.id);
            listContainer.appendChild(item);
        });
    };
    
    const renderPresupuestos = () => {
        const listContainer = select('presupuestos-list');
        const emptyState = select('empty-presupuestos');
        if (!listContainer || !emptyState) return;

        const sortedPresupuestos = (db.presupuestos || []).sort((a,b) => a.ano - b.ano);
        listContainer.innerHTML = '';

        if (sortedPresupuestos.length === 0) {
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        sortedPresupuestos.forEach(budget => {
            const gastoReal = (db.movimientos || []).filter(m => new Date(m.fecha).getFullYear() === budget.ano && m.beneficiario === budget.beneficiario && m.conceptoId === budget.conceptoId && m.cantidad < 0).reduce((sum, m) => sum + Math.abs(m.cantidad), 0);
            const limite = budget.cantidad;
            const percentage = limite > 0 ? (gastoReal / limite) * 100 : 0;
            let progressClass = 'progress-ok';
            if (percentage >= 100) progressClass = 'progress-danger';
            else if (percentage >= 75) progressClass = 'progress-warning';
            
            const conceptoNombre = db.conceptos.find(c => c.id === budget.conceptoId)?.nombre || 'Desconocido';
            const ownerClass = `owner-${budget.beneficiario.toLowerCase().replace(/\s/g, '')}-border`;
            
            const budgetElement = document.createElement('div');
            budgetElement.className = `list-item-card budget-item ${ownerClass}`;
            budgetElement.innerHTML = `
                <div style="width: 100%;">
                    <div class="budget-info">
                        <div class="budget-info-text">
                            <strong>${conceptoNombre} (${budget.beneficiario} ${budget.ano})</strong>
                            <span class="text-negative">Gasto: ${formatNumber(gastoReal / 100)}‚Ç¨</span>
                            <span class="text-positive">L√≠mite: ${formatNumber(limite / 100)}‚Ç¨</span>
                        </div>
                        <button class="icon-button delete-presupuesto" data-id="${budget.id}" title="Borrar Presupuesto"><span class="material-icons">delete_outline</span></button>
                    </div>
                    <progress class="budget-progress ${progressClass}" value="${gastoReal}" max="${limite}"></progress>
                </div>`;
            listContainer.appendChild(budgetElement);
        });
    };
    
    const loadConfig = () => { const configBeneficiarios = select('config-beneficiarios'); if(configBeneficiarios) configBeneficiarios.value = (db.config.beneficiarios || []).join(', '); };
    const getFilteredMovements = () => { const periodo = select('filter-periodo').value, beneficiario = select('filter-beneficiario').value, cuentaId = select('filter-cuenta').value, conceptoId = select('filter-concepto').value; let startDate, endDate, now = new Date(); switch (periodo) { case 'mes-actual': startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59); break; case 'ano-actual': startDate = new Date(now.getFullYear(), 0, 1); endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59); break; case 'custom': const startVal = select('filter-fecha-inicio').value, endVal = select('filter-fecha-fin').value; startDate = startVal ? new Date(startVal) : null; if(startDate) startDate.setHours(0,0,0,0); endDate = endVal ? new Date(endVal) : null; if(endDate) endDate.setHours(23,59,59,999); break; default: startDate = null; endDate = null; break; } let filtered = db.movimientos || []; if (startDate && endDate) { filtered = filtered.filter(m => new Date(m.fecha) >= startDate && new Date(m.fecha) <= endDate); } if (beneficiario) filtered = filtered.filter(m => m.beneficiario === beneficiario); if (conceptoId) filtered = filtered.filter(m => m.conceptoId === conceptoId); if (cuentaId) { filtered = filtered.filter(m => m.cuentaId === cuentaId || m.cuentaOrigenId === cuentaId || m.cuentaDestinoId === cuentaId); } return filtered.filter(m => m.tipo === 'movimiento' || m.tipo === 'traspaso'); };

    const updateDashboard = () => {
        const movements = getFilteredMovements();
        const kpiContainer = select('kpi-container'), conceptTotalsContainer = select('concepto-totals-list'), listContainer = select('filtered-movements-list'), summaryContainer = select('filtered-movements-summary');
        if (!kpiContainer || !conceptTotalsContainer || !listContainer || !summaryContainer) return;
        
        const ingresos = movements.filter(m => m.cantidad > 0 && m.tipo !== 'traspaso').reduce((sum, m) => sum + m.cantidad, 0);
        const gastos = movements.filter(m => m.cantidad < 0).reduce((sum, m) => sum + m.cantidad, 0);
        const saldo = ingresos + gastos;
        
        kpiContainer.innerHTML = `<div class="kpi-item"><h4 class="text-positive">Ingresos</h4><strong class="text-positive">+${formatNumber(ingresos / 100)} ‚Ç¨</strong></div><div class="kpi-item"><h4 class="text-negative">Gastos</h4><strong class="text-negative">${formatNumber(gastos / 100)} ‚Ç¨</strong></div><div class="kpi-item"><h4>Saldo Neto</h4><strong class="${saldo >= 0 ? 'text-positive' : 'text-negative'}">${formatNumber(saldo / 100)} ‚Ç¨</strong></div>`;
        
        const conceptTotals = movements.reduce((acc, m) => { if (m.tipo === 'movimiento' && m.conceptoId) { acc[m.conceptoId] = (acc[m.conceptoId] || 0) + m.cantidad; } return acc; }, {});
        conceptTotalsContainer.innerHTML = Object.keys(conceptTotals).length === 0 ? '<div class="empty-state" style="padding: 16px 0;"><p>Sin datos para los filtros.</p></div>' : Object.entries(conceptTotals).sort(([,a],[,b]) => a - b).map(([id, total]) => `
            <div class="list-item-card">
                <div class="item-content">
                    <span class="item-title">${db.conceptos.find(c => c.id === id)?.nombre || 'Desconocido'}</span>
                    <strong class="item-amount ${total >= 0 ? 'text-positive' : 'text-negative'}">${formatNumber(total / 100)} ‚Ç¨</strong>
                </div>
            </div>`).join('');
        
        listContainer.innerHTML = ''; summaryContainer.innerHTML = '';
        if (movements.length > 0) {
            movements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(m => {
                const ownerClass = m.beneficiario ? `owner-${m.beneficiario.toLowerCase().replace(/\s/g, '-')}-border` : '';
                const cantidadEnEuros = m.cantidad / 100;
                const amountHtml = m.tipo === 'traspaso' ? `<span class="text-info">${formatNumber(cantidadEnEuros)} ‚Ç¨</span>` : (cantidadEnEuros < 0 ? `<span class="text-negative">${formatNumber(cantidadEnEuros)} ‚Ç¨</span>` : `<span class="text-positive">+${formatNumber(cantidadEnEuros)} ‚Ç¨</span>`);
                const metaInfo = m.tipo === 'traspaso' ? `Traspaso` : `${(db.conceptos.find(c => c.id === m.conceptoId)?.nombre || 'Sin Concepto')}`;
                const listItem = document.createElement('div');
                listItem.className = `list-item-card ${ownerClass}`;
                listItem.innerHTML = `
                    <div class="item-content">
                        <div class="item-details">
                            <div class="item-title">${m.descripcion}</div>
                            <div class="item-meta">${new Date(m.fecha).toLocaleDateString('es-ES')} - ${metaInfo}</div>
                        </div>
                        <div class="item-amount">${amountHtml}</div>
                    </div>`;
                listContainer.appendChild(listItem);
            });
            const totalSum = movements.reduce((sum, m) => sum + (m.tipo === 'traspaso' ? 0 : m.cantidad), 0);
            summaryContainer.innerHTML = `<span style="color: var(--secondary-color);">Total Filtrado (sin traspasos):</span><br><strong style="font-size: 18px;" class="${totalSum >= 0 ? 'text-positive' : 'text-negative'}">${formatNumber(totalSum / 100)} ‚Ç¨</strong>`;
        } else {
            listContainer.innerHTML = '<div class="empty-state" style="padding: 16px 0;"><p>No se encontraron movimientos.</p></div>';
        }
    };
    
    const analyzeFinancials = (beneficiario, riskLevel) => {
        const sixMonthsAgo = new Date(); sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        const recentMovements = (db.movimientos || []).filter(m => new Date(m.fecha) > sixMonthsAgo && m.tipo === 'movimiento' && !m.descripcion.toLowerCase().includes('saldo inicial'));
        let totalIncome = 0, totalExpenses = 0, expenseByCategory = {};
        recentMovements.forEach(m => { let amount = m.cantidad; const share = (m.beneficiario === 'Com√∫n' && beneficiario !== 'Com√∫n') ? 0.5 : 1; const belongsToUser = m.beneficiario === beneficiario || (m.beneficiario === 'Com√∫n'); if (belongsToUser) { if (amount > 0) totalIncome += amount * share; else totalExpenses += Math.abs(amount) * share; } if (m.cantidad < 0 && belongsToUser) { const categoryName = (db.conceptos.find(c => c.id === m.conceptoId)?.nombre) || 'Sin Categor√≠a'; expenseByCategory[categoryName] = (expenseByCategory[categoryName] || 0) + (Math.abs(amount) * share); } });
        const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpenses) / totalIncome) * 100 : (totalExpenses > 0 ? -100 : 0);
        const avgMonthlyExpenses = totalExpenses / 6; const saldos = getSaldos(); const EMERGENCY_ACCOUNT_TYPES = ['EFECTIVO', 'CUENTA BANCARIA', 'AHORRO']; let emergencyFundTotal = 0, liquidNetWorth = 0, totalDebt = 0;
        (db.cuentas || []).forEach(c => { const share = (c.propietario === 'Com√∫n' && beneficiario !== 'Com√∫n') ? 0.5 : 1; const belongsToUser = c.propietario === beneficiario || c.propietario === 'Com√∫n'; if(!belongsToUser) return; const saldo = saldos[c.id] || 0; const tipo = (c.tipo || '').toUpperCase(); if (!['PROPIEDAD'].includes(tipo)) { if(tipo === 'PR√âSTAMO' || tipo === 'TARJETA DE CR√âDITO') { if(saldo < 0) totalDebt += Math.abs(saldo * share); liquidNetWorth += saldo * share; } else { liquidNetWorth += saldo * share; } } if (EMERGENCY_ACCOUNT_TYPES.includes(tipo)) { emergencyFundTotal += saldo * share; } });
        const emergencyMonths = avgMonthlyExpenses > 0 ? emergencyFundTotal / avgMonthlyExpenses : 99; const topExpenses = Object.entries(expenseByCategory).sort((a, b) => b[1] - a[1]).slice(0, 3); let strengths = [], improvements = [], investmentSuggestions = []; let profile = "Estableciendo Perfil...";
        if (emergencyMonths < 3) { profile = "Fase 1: Construcci√≥n de Cimientos"; improvements.push(`üî• **Prioridad Absoluta: Fondo de Emergencia.** Tu colch√≥n de seguridad es de solo ${emergencyMonths.toFixed(1)} meses. El objetivo m√≠nimo son 3 meses de gastos. Antes de invertir, es crucial que te centres en aumentar tu ahorro l√≠quido para cubrir imprevistos.`); investmentSuggestions.push("‚ùå **No inviertas todav√≠a.** Cualquier dinero extra debe ir directamente a construir tu fondo de emergencia en cuentas seguras y l√≠quidas (ahorro, cuenta corriente). Invertir sin este colch√≥n es extremadamente arriesgado."); } else if (liquidNetWorth < 0 && beneficiario !== 'Com√∫n' && totalDebt > 0) { profile = "Fase 2: Reducci√≥n de Deuda"; strengths.push(`üëç ¬°Bien hecho! Tienes un fondo de emergencia adecuado (${emergencyMonths.toFixed(1)} meses). Esta es tu mayor fortaleza y te da seguridad para afrontar el siguiente paso.`); improvements.push(`üìâ **Prioridad: Eliminar Deuda de alto inter√©s.** Tu patrimonio l√≠quido es negativo. Conc√©ntrate en pagar las deudas con el inter√©s m√°s alto (tarjetas de cr√©dito, pr√©stamos personales). Cada euro destinado a esto es un retorno garantizado y libre de riesgo.`); investmentSuggestions.push("‚ö†Ô∏è **La mejor 'inversi√≥n' ahora es pagar deuda.** Considera pausar o reducir las inversiones para acelerar la eliminaci√≥n de deudas. El rendimiento que obtienes al no pagar intereses altos suele superar al del mercado."); } else { profile = "Fase 3: Crecimiento y Consolidaci√≥n"; if (savingsRate >= 15) strengths.push(`‚úÖ ¬°Excelente tasa de ahorro (${savingsRate.toFixed(1)}%)! Este es el motor principal para tu crecimiento financiero y te permitir√° alcanzar tus metas mucho m√°s r√°pido.`); else if (savingsRate > 5) strengths.push(`üëç Buena tasa de ahorro (${savingsRate.toFixed(1)}%). Vas por buen camino. Intenta optimizarla un poco m√°s para acelerar tus objetivos.`); else strengths.push(`ü§î Tu tasa de ahorro (${savingsRate.toFixed(1)}%) es mejorable. Revisa tus gastos para ver d√≥nde puedes optimizar y aumentar tu capacidad de inversi√≥n.`); if (emergencyMonths >= 6) strengths.push(`‚úÖ Fondo de emergencia s√≥lido (${emergencyMonths.toFixed(1)} meses). Te proporciona una gran tranquilidad y la libertad de asumir m√°s riesgos en tus inversiones a largo plazo.`); else strengths.push(`üëç Fondo de emergencia funcional (${emergencyMonths.toFixed(1)} meses). Est√°s cubierto para lo b√°sico. Considera aumentarlo hasta 6 meses para una seguridad total.`); switch(riskLevel) { case 'bajo': investmentSuggestions.push("üõ°Ô∏è **Enfoque Conservador:** Prioriza la preservaci√≥n del capital. Una cartera podr√≠a consistir en: <strong>Fondos de Renta Fija a corto plazo</strong> (bonos de gobiernos solventes), <strong>dep√≥sitos a plazo</strong>, y una peque√±a parte (10-20%) en un <strong>fondo indexado global diversificado</strong> (ej. MSCI World) para un crecimiento modesto."); investmentSuggestions.push("<strong>Cuentas de ahorro remuneradas</strong> tambi√©n son una excelente opci√≥n sin riesgo para la parte de tu dinero que quieres que crezca lentamente pero segura."); break; case 'medio': investmentSuggestions.push("‚öñÔ∏è **Enfoque Equilibrado:** Busca un balance entre crecimiento y seguridad. Una cartera diversificada podr√≠a ser: <strong>60-70% en fondos indexados de renta variable global</strong> (MSCI World, S&P 500) para el crecimiento a largo plazo."); investmentSuggestions.push("<strong>30-40% en fondos de renta fija</strong> (bonos globales) para reducir la volatilidad de la cartera. Puedes considerar a√±adir una peque√±a parte a <strong>REITs (fondos inmobiliarios)</strong> para mayor diversificaci√≥n."); break; case 'alto': investmentSuggestions.push("üöÄ **Enfoque de Crecimiento:** Prioriza la rentabilidad asumiendo una mayor volatilidad. Una cartera agresiva podr√≠a incluir: <strong>80-95% en Renta Variable</strong>, combinando un n√∫cleo de <strong>fondos indexados globales</strong> con fondos sectoriales (tecnolog√≠a, salud) o de <strong>mercados emergentes</strong>."); investmentSuggestions.push("Puedes destinar una peque√±a parte (1-5%) a <strong>activos de alto riesgo</strong> como criptomonedas (Bitcoin, Ethereum), entendiendo que es capital especulativo que podr√≠as perder. Se requiere una fuerte disciplina y un horizonte temporal muy largo."); break; } }
        return { metrics: { savingsRate, emergencyMonths, liquidNetWorth, avgMonthlyExpenses, topExpenses }, advice: { strengths, improvements, investmentSuggestions, profile } };
    };

    const showAIAdviceModal = () => {
        const modalId = 'ai-advice-modal'; document.getElementById(modalId)?.remove();
        const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay active';
        let ownerOptions = (db.config.beneficiarios || []).filter(o => o !== 'Com√∫n').map(o => `<option value="${o}">${o}</option>`).join('');
        modalOverlay.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title"><span class="material-icons" style="margin-right: 8px;">psychology_alt</span>Asesor Financiero IA</h3>
                    <button class="icon-button close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-grid" style="align-items: flex-end;">
                        <div class="form-group"><label for="ai-analyze-beneficiario" class="form-label">Analizar a:</label><select id="ai-analyze-beneficiario" class="form-select">${ownerOptions}</select></div>
                        <div class="form-group"><label for="ai-risk-level" class="form-label">Grado de Riesgo:</label><select id="ai-risk-level" class="form-select"><option value="bajo">Bajo</option><option value="medio" selected>Medio</option><option value="alto">Alto</option></select></div>
                    </div>
                    <button id="generate-ai-report-btn" class="btn btn-primary btn-full" style="margin-top:8px;">Generar An√°lisis</button>
                    <div id="ai-advice-content" style="margin-top:16px;"></div>
                </div>
            </div>`;
        document.body.appendChild(modalOverlay);
        modalOverlay.querySelector('.close-btn').onclick = () => modalOverlay.remove();
        modalOverlay.querySelector('#generate-ai-report-btn').onclick = (e) => {
            const btn = e.currentTarget; setButtonLoading(btn, true, 'Analizando...');
            const beneficiario = select('ai-analyze-beneficiario').value;
            const riskLevel = select('ai-risk-level').value;
            const contentDiv = select('ai-advice-content');
            setTimeout(() => {
                const analysis = analyzeFinancials(beneficiario, riskLevel); const { metrics, advice } = analysis;
                let reportHTML = `<div style="background-color: var(--surface-variant); border-left: 4px solid var(--warning-color); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;"><strong>AVISO:</strong> Este es un an√°lisis autom√°tico y <strong>NO es un consejo financiero profesional.</strong> Consulta siempre con un asesor cualificado.</div>`;
                reportHTML += `<h4 class="section-title">Informe para ${beneficiario}</h4><p>Perfil detectado: <strong>${advice.profile}</strong></p><div class="kpi-container" style="grid-template-columns: 1fr 1fr; margin-top: 12px;"><div class="kpi-item"><h4>Patrimonio L√≠quido</h4><strong class="${metrics.liquidNetWorth >= 0 ? 'text-positive' : 'text-negative'}">${formatNumber(metrics.liquidNetWorth / 100)} ‚Ç¨</strong></div><div class="kpi-item"><h4>Tasa Ahorro</h4><strong class="${metrics.savingsRate >= 10 ? 'text-positive' : 'text-warning'}">${metrics.savingsRate.toFixed(1)}%</strong></div><div class="kpi-item"><h4>Fondo Emergencia</h4><strong class="${metrics.emergencyMonths >= 3 ? 'text-positive' : 'text-warning'}">${metrics.emergencyMonths.toFixed(1)} m.</strong></div><div class="kpi-item"><h4>Gasto Mensual</h4><strong>${formatNumber(metrics.avgMonthlyExpenses / 100)} ‚Ç¨</strong></div></div>`;
                if (advice.strengths.length > 0) { reportHTML += '<h5 style="margin-top: 1em;">‚úÖ Puntos Fuertes</h5><ul style="padding-left: 20px; font-size: 14px; list-style-type: none;">'; advice.strengths.forEach(item => { reportHTML += `<li>${item}</li>`; }); reportHTML += '</ul>'; }
                if (advice.improvements.length > 0) { reportHTML += '<h5 style="margin-top: 1em;">üéØ √Åreas de Mejora</h5><ul style="padding-left: 20px; font-size: 14px; list-style-type: none;">'; advice.improvements.forEach(item => { reportHTML += `<li>${item}</li>`; }); reportHTML += '</ul>'; }
                if (advice.investmentSuggestions.length > 0) { reportHTML += '<h5 style="margin-top: 1em;">üí° Posibilidades de Inversi√≥n</h5><ul style="padding-left: 20px; font-size: 14px; list-style-type: none;">'; advice.investmentSuggestions.forEach(item => { reportHTML += `<li>${item}</li>`; }); reportHTML += '</ul>'; }
                if(metrics.topExpenses.length > 0){ reportHTML += `<h5 style="margin-top: 1em;">Top 3 Gastos (6 meses)</h5><ul style="padding-left: 20px; font-size: 14px; list-style-type: none;">`; metrics.topExpenses.forEach(([name, amount]) => { reportHTML += `<li><strong>${name}:</strong> ${formatNumber(amount / 100)} ‚Ç¨</li>`; }); reportHTML += '</ul>'; }
                contentDiv.innerHTML = reportHTML; setButtonLoading(btn, false);
            }, 500);
        };
    };

    const showHelpModal = () => {
        const modalId = 'help-modal'; document.getElementById(modalId)?.remove();
        const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay active';
        modalOverlay.innerHTML = `<div class="modal"><div class="modal-header"><h3 class="modal-title"><span class="material-icons" style="margin-right: 8px;">lightbulb</span>Gu√≠a de Cuentas aiDANaI</h3><button class="icon-button close-btn">&times;</button></div><div class="modal-body" style="font-size: 14px; line-height: 1.6;"><p>¬°Bienvenido a <strong>Cuentas aiDANaI</strong>! Tu app para el control total de tus finanzas.</p><h4 class="section-title" style="margin-top:16px;">üìä Panel de Control</h4><p>Tu centro de mando. Filtra por periodo, propietario, cuenta y concepto para una vista detallada de tu salud financiera.</p><h4 class="section-title" style="margin-top:16px;">‚ÜîÔ∏è Movimientos</h4><p>El coraz√≥n de la app. Pulsa el bot√≥n flotante (+) para a√±adir <strong>movimientos</strong> o <strong>traspasos</strong>. Edita o elimina cualquier movimiento pulsando sobre √©l en la lista.</p><h4 class="section-title" style="margin-top:16px;">üè¶ Cuentas</h4><p>Visualiza tus saldos agrupados por <strong>Propietario</strong> o por <strong>Tipo</strong>. Usa los filtros para acotar la vista. Para gestionar cuentas (crear, ajustar a cero), ve al modal de a√±adir movimiento y pulsa el bot√≥n (<span class="material-icons" style="font-size:1rem; vertical-align: -2px;">more_vert</span>) junto al selector de Cuentas.</p><h4 class="section-title" style="margin-top:16px;">üéØ Presupuestos</h4><p>Define l√≠mites de gasto anuales por propietario y concepto, y sigue tu progreso con barras visuales para no desviarte de tus metas.</p><h4 class="section-title" style="margin-top:16px;">‚ú® Funciones Especiales</h4><p>Usa el <strong>Asesor IA üß†</strong> para un an√°lisis profundo de tu situaci√≥n y recomendaciones personalizadas. No olvides <strong>exportar tus datos</strong> regularmente desde la pesta√±a de Configuraci√≥n como copia de seguridad.</p></div></div>`;
        document.body.appendChild(modalOverlay);
        modalOverlay.querySelector('.close-btn').onclick = () => modalOverlay.remove();
        modalOverlay.onclick = e => { if(e.target === modalOverlay) modalOverlay.remove(); };
    };

    const showConceptosModal = () => {
        const modalId = 'conceptos-modal'; document.getElementById(modalId)?.remove();
        const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay active';
        modalOverlay.innerHTML = `<div class="modal"><div class="modal-header"><h3 class="modal-title">Gestionar Conceptos</h3><button class="icon-button close-btn">&times;</button></div><div class="modal-body"><form id="form-concepto-modal" style="margin-bottom: 20px;"><h4>Nuevo Concepto</h4><div class="form-group"><label for="concepto-nombre-modal" class="form-label">Nombre del Concepto</label><input type="text" id="concepto-nombre-modal" class="form-input" required placeholder="Ej: Supermercado, Ocio..."><span class="error-message" id="concepto-nombre-modal-error"></span></div><button type="submit" class="btn btn-primary btn-full" id="add-concepto-modal-btn">A√±adir Concepto</button></form><h4>Conceptos Existentes</h4><div id="conceptos-list-modal"></div></div></div>`;
        document.body.appendChild(modalOverlay);
        const listContainer = modalOverlay.querySelector('#conceptos-list-modal');
        const renderList = () => { listContainer.innerHTML = ''; (db.conceptos || []).sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(c => { listContainer.innerHTML += `<div class="modal-list-item"><span>${c.nombre}</span><button class="icon-button delete-concepto-modal" data-id="${c.id}" title="Borrar"><span class="material-icons" style="color:var(--danger-color)">delete</span></button></div>`; }); };
        renderList();
        modalOverlay.querySelector('.close-btn').onclick = () => modalOverlay.remove();
        modalOverlay.querySelector('#form-concepto-modal').onsubmit = e => { e.preventDefault(); clearAllErrors('form-concepto-modal'); const nombre = select('concepto-nombre-modal').value.trim(); let valid = true; if (!nombre) { displayError('concepto-nombre-modal', 'El nombre es obligatorio.'); valid = false; } if (db.conceptos.some(c => c.nombre.toLowerCase() === nombre.toLowerCase())) { displayError('concepto-nombre-modal', 'Ya existe un concepto con ese nombre.'); valid = false; } if (!valid) return; const addBtn = select('add-concepto-modal-btn'); setButtonLoading(addBtn, true, 'A√±adiendo...'); db.conceptos.push({ id: generateId(), nombre }); saveData(addBtn, () => { renderAll(); showConceptosModal(); showToast(`Concepto '${nombre}' creado.`); }); };
        listContainer.addEventListener('click', e => { if (e.target.closest('.delete-concepto-modal')) { const btn = e.target.closest('.delete-concepto-modal'); const id = btn.dataset.id; const isInUse = db.movimientos.some(m => m.conceptoId === id) || db.presupuestos.some(p => p.conceptoId === id); if (isInUse) { showToast('Error: Concepto en uso.'); return; } showConfirmationModal('¬øEliminar este concepto?', () => { setButtonLoading(btn, true, 'Borrando...'); db.conceptos = db.conceptos.filter(c => c.id !== id); saveData(btn, () => { renderAll(); showConceptosModal(); showToast('Concepto eliminado.'); }); }); } });
    };
    
    const showCuentasModal = () => {
        const ACCOUNT_TYPES = ['EFECTIVO', 'CUENTA BANCARIA', 'TARJETA DE CR√âDITO', 'AHORRO', 'INVERSI√ìN', 'CRIPTOMONEDAS', 'PROPIEDAD', 'PR√âSTAMO', 'OTROS'];
        const modalId = 'cuentas-modal'; document.getElementById(modalId)?.remove();
        const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay active';
        let ownerOptions = (db.config.beneficiarios || []).map(o => `<option value="${o}">${o}</option>`).join('');
        let accountTypeOptions = ACCOUNT_TYPES.map(t => `<option value="${t}">${t.charAt(0) + t.slice(1).toLowerCase()}</option>`).join('');
        
        modalOverlay.innerHTML = `<div class="modal"><div class="modal-header"><h3 class="modal-title">Gestionar Cuentas</h3><button class="icon-button close-btn">&times;</button></div><div class="modal-body"><form id="form-cuenta-modal" style="margin-bottom:20px;"><h4>Nueva Cuenta</h4><div class="form-group"><label for="cuenta-nombre-modal" class="form-label">Nombre</label><input type="text" id="cuenta-nombre-modal" class="form-input" required placeholder="Ej: Cartera Dani"><span class="error-message" id="cuenta-nombre-modal-error"></span></div><div class="form-grid"><div class="form-group"><label for="cuenta-tipo-modal" class="form-label">Tipo</label><select id="cuenta-tipo-modal" class="form-select" required>${accountTypeOptions}</select></div><div class="form-group"><label for="cuenta-propietario-modal" class="form-label">Propietario</label><select id="cuenta-propietario-modal" class="form-select">${ownerOptions}</select></div></div><div class="form-group"><label for="cuenta-saldo-inicial-modal" class="form-label">Saldo Inicial (opcional)</label><input type="text" id="cuenta-saldo-inicial-modal" class="form-input" inputmode="decimal" placeholder="Ej: 100,00"></div><button type="submit" class="btn btn-primary btn-full" id="add-cuenta-modal-btn">A√±adir Cuenta</button></form><h4>Cuentas Existentes</h4><div id="cuentas-list-modal"></div></div></div>`;
        document.body.appendChild(modalOverlay);
        const listContainer = modalOverlay.querySelector('#cuentas-list-modal');
        const renderList = () => {
            const saldos = getSaldos();
            listContainer.innerHTML = '';
            (db.cuentas || []).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(c => {
                const saldoActual = (saldos[c.id] || 0) / 100;
                listContainer.innerHTML += `<div class="modal-list-item">
                    <div>
                        <span>${c.nombre} <em style="font-size:12px; color:var(--secondary-color)">(${c.tipo})</em></span>
                        <strong style="display:block; font-size:13px;">${formatNumber(saldoActual)}‚Ç¨</strong>
                    </div>
                    <div style="display:flex; gap: 4px;">
                        <button class="btn btn-secondary adjust-cuenta-cero" data-id="${c.id}" style="padding: 4px 10px; font-size: 12px; border-radius: 8px;">Ajustar a 0</button>
                        <button class="icon-button delete-cuenta-modal" data-id="${c.id}" title="Borrar"><span class="material-icons" style="color:var(--danger-color)">delete</span></button>
                    </div>
                </div>`;
            });
        };
        renderList();
        modalOverlay.querySelector('.close-btn').onclick = () => modalOverlay.remove();
        modalOverlay.querySelector('#form-cuenta-modal').onsubmit = (e) => {
            e.preventDefault(); clearAllErrors('form-cuenta-modal');
            const nombre = select('cuenta-nombre-modal').value.trim(), tipo = select('cuenta-tipo-modal').value, propietario = select('cuenta-propietario-modal').value;
            const saldoInicialStr = select('cuenta-saldo-inicial-modal').value.trim().replace(',', '.');
            const saldoInicialEnCentimos = Math.round((parseFloat(saldoInicialStr) || 0) * 100);
            let valid = true;
            if (!nombre) { displayError('cuenta-nombre-modal', 'El nombre es obligatorio.'); valid = false; }
            if (db.cuentas.some(c => c.nombre.toLowerCase() === nombre.toLowerCase())) { displayError('cuenta-nombre-modal', 'Ya existe una cuenta con ese nombre.'); valid = false; }
            if (!valid) return;
            const addBtn = select('add-cuenta-modal-btn'); setButtonLoading(addBtn, true, 'A√±adiendo...');
            const newCuenta = { id: generateId(), nombre, tipo, propietario }; db.cuentas.push(newCuenta);
            if (saldoInicialEnCentimos !== 0) { db.movimientos.push({ id: generateId(), tipo: 'movimiento', descripcion: `Saldo inicial de ${nombre}`, cantidad: saldoInicialEnCentimos, fecha: new Date().toISOString(), cuentaId: newCuenta.id, beneficiario: newCuenta.propietario, conceptoId: null }); }
            saveData(addBtn, () => { renderAll(); showCuentasModal(); showToast(`Cuenta '${nombre}' creada.`); });
        };
        listContainer.addEventListener('click', e => {
            const target = e.target.closest('button');
            if(!target) return;
            const id = target.dataset.id;
            if (target.classList.contains('delete-cuenta-modal')) {
                if (db.movimientos.some(m => m.cuentaId === id || m.cuentaOrigenId === id || m.cuentaDestinoId === id)) { showToast('Error: Cuenta en uso.'); return; }
                showConfirmationModal('¬øEliminar esta cuenta? Solo es posible si no tiene movimientos.', () => { setButtonLoading(target, true, 'Borrando...'); db.cuentas = db.cuentas.filter(c => c.id !== id); saveData(target, () => { renderAll(); showCuentasModal(); showToast('Cuenta eliminada.'); }); });
            } else if (target.classList.contains('adjust-cuenta-cero')) {
                const cuenta = db.cuentas.find(c => c.id === id); if (!cuenta) return;
                const saldoActualEnCentimos = (getSaldos()[id] || 0); if (saldoActualEnCentimos === 0) { showToast('La cuenta ya tiene saldo cero.'); return; }
                const ajuste = -saldoActualEnCentimos;
                showConfirmationModal(`¬øCrear un movimiento de ajuste de ${formatNumber(ajuste / 100)}‚Ç¨ para poner la cuenta "${cuenta.nombre}" a cero?`, () => {
                    db.movimientos.push({ id: generateId(), tipo: 'movimiento', descripcion: `Ajuste a cero de ${cuenta.nombre}`, cantidad: ajuste, fecha: new Date().toISOString(), cuentaId: cuenta.id, beneficiario: cuenta.propietario, conceptoId: null });
                    saveData(null, () => { showToast('Cuenta ajustada a cero.'); renderAll(); showCuentasModal(); });
                });
            }
        });
    };
    
    const showConfirmationModal = (message, onConfirm, title = "Confirmar Acci√≥n") => { const modalId = 'confirmation-modal'; document.getElementById(modalId)?.remove(); const modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay active'; modalOverlay.innerHTML = `<div class="modal" role="alertdialog"><div class="modal-header"><h3 class="modal-title">${title}</h3></div><div class="modal-body"><p>${message}</p><div class="modal-actions"><button id="confirm-no-btn" class="btn btn-secondary">No</button><button id="confirm-yes-btn" class="btn btn-danger">S√≠</button></div></div></div>`; document.body.appendChild(modalOverlay); const confirmYesBtn = select('confirm-yes-btn'), confirmNoBtn = select('confirm-no-btn'); confirmYesBtn.onclick = () => { onConfirm(); modalOverlay.remove(); }; confirmNoBtn.onclick = () => modalOverlay.remove(); };
    
    function attachEventListeners() {
        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if(!target) return;
            if (target.id === 'login-btn') return handleLogin();
            if (target.id === 'register-btn') return handleRegister();
            if (target.id.startsWith('logout-btn')) return handleLogout();
            if (target.closest('.nav-item')) return navigateTo(target.closest('.nav-item').dataset.page);
            if (target.id === 'ai-advice-btn') return showAIAdviceModal();
            if (target.id === 'help-btn') return showHelpModal();
            if (target.id.startsWith('theme-toggle')) { vibrate(); const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); selectAll('.icon-button[title="Cambiar Tema"] .material-icons').forEach(icon => icon.textContent = newTheme === 'light' ? 'dark_mode' : 'light_mode'); return; }
            if (target.id === 'apply-filters-btn') { vibrate(20); setButtonLoading(target, true, 'Aplicando...'); updateDashboard(); setTimeout(() => setButtonLoading(target, false), 400); return; }
            if (target.id === 'manage-conceptos-btn') { vibrate(); showConceptosModal(); return; }
            if (target.id === 'manage-cuentas-btn') { vibrate(); showCuentasModal(); return; }
            if (target.id === 'fab-add-movimiento') { startEditMovement(null); return; }
            if (target.closest('.modal-overlay .close-btn')) { target.closest('.modal-overlay').remove(); return; }
            if (target.id === 'save-config-btn') { const beneficiarios = select('config-beneficiarios').value.split(',').map(s => s.trim()).filter(Boolean); if (beneficiarios.length === 0) { displayError('config-beneficiarios', 'Debe haber al menos un propietario.'); return; } setButtonLoading(target, true, 'Guardando...'); db.config.beneficiarios = beneficiarios; saveData(target, () => { renderAll(); showToast('Configuraci√≥n guardada.'); }); return; }
            if (target.id === 'clear-all-data-btn') { showConfirmationModal('¬øSeguro que quieres borrar TODOS tus datos? Esta acci√≥n es irreversible.', () => { db = getInitialDb(); saveData(null, () => { renderAll(); showToast('Todos los datos han sido borrados.'); }); }); return; }
            if (target.id === 'export-data-btn') { setButtonLoading(target, true, 'Exportando...'); const dataStr = JSON.stringify({db}, null, 2); const blob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `cuentas_aiDANaI_export_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Copia de seguridad exportada.'); setButtonLoading(target, false); return; }
            if (target.id === 'import-data-btn') { select('import-file-input').click(); return; }
            if (target.classList.contains('delete-presupuesto')) { const budgetId = target.dataset.id; showConfirmationModal('¬øSeguro que quieres eliminar este presupuesto?', () => { db.presupuestos = db.presupuestos.filter(p => p.id !== budgetId); saveData(null, () => { renderPresupuestos(); showToast('Presupuesto eliminado.'); }); }); }
        });
        
        document.body.addEventListener('input', (e) => { const targetId = e.target.id; if (['login-email', 'login-password', 'config-beneficiarios', 'movimiento-cantidad', 'movimiento-fecha', 'movimiento-descripcion', 'movimiento-concepto', 'movimiento-cuenta', 'movimiento-beneficiario', 'movimiento-cuenta-origen', 'movimiento-cuenta-destino', 'presupuesto-ano', 'presupuesto-beneficiario-p', 'presupuesto-concepto', 'presupuesto-cantidad'].includes(targetId)) clearError(targetId); if(targetId === 'search-movimientos') renderMovimientos(e.target.value); });
        
        document.body.addEventListener('change', (e) => {
            if(e.target.id === 'filter-periodo') select('custom-date-filters')?.classList.toggle('hidden', e.target.value !== 'custom');
            if(e.target.id === 'movimiento-tipo-selector') {
                const isTraspaso = e.target.value === 'traspaso';
                select('movimiento-fields').style.display = isTraspaso ? 'none' : 'block';
                select('traspaso-fields').classList.toggle('hidden', !isTraspaso);
                select('movimiento-concepto').required = !isTraspaso;
                select('movimiento-cuenta').required = !isTraspaso;
                select('movimiento-beneficiario').required = !isTraspaso;
                select('movimiento-cuenta-origen').required = isTraspaso;
                select('movimiento-cuenta-destino').required = isTraspaso;
                clearAllErrors('form-movimiento');
            }
            if(e.target.id === 'import-file-input') {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    try {
                        let importedData = JSON.parse(re.target.result); if (importedData.db) importedData = importedData.db; 
                        const needsMigration = (importedData.movimientos || []).some(m => !Number.isInteger(m.cantidad)) || (importedData.presupuestos || []).some(p => !Number.isInteger(p.cantidad));
                        if (needsMigration) { showToast("Detectado formato antiguo. Migrando datos..."); if(importedData.movimientos) importedData.movimientos.forEach(m => m.cantidad = Math.round(m.cantidad * 100)); if(importedData.presupuestos) importedData.presupuestos.forEach(p => p.cantidad = Math.round(p.cantidad * 100)); }
                        if (importedData.recurringMovements) delete importedData.recurringMovements;
                        showConfirmationModal('Importar reemplazar√° TODOS tus datos en la nube. ¬øEst√°s seguro?', () => { db = importedData; saveData(null, () => { renderAll(); showToast('Datos importados y sincronizados.'); }); }, 'Confirmar Importaci√≥n');
                    } catch (error) { showToast('Error: Archivo JSON no v√°lido.'); console.error("Import error:", error); }
                };
                reader.readAsText(file); e.target.value = '';
            }
        });

        document.body.addEventListener('submit', (e) => {
            if (e.target.id === 'form-movimiento') {
                e.preventDefault(); vibrate(20); clearAllErrors('form-movimiento');
                const id = select('movimiento-id').value, tipo = select('movimiento-tipo-selector').value, fecha = select('movimiento-fecha').value, descripcion = select('movimiento-descripcion').value.trim(), saveMovBtn = select('save-movimiento-btn');
                const cantidadStr = select('movimiento-cantidad').value.trim().replace(',', '.'); const cantidadFloat = parseFloat(cantidadStr); const cantidadEnCentimos = Math.round(cantidadFloat * 100);
                let valid = true;
                if (isNaN(cantidadFloat) || cantidadFloat === 0) { displayError('movimiento-cantidad', 'Cantidad inv√°lida o cero.'); valid = false; }
                if (!fecha) { displayError('movimiento-fecha', 'Fecha y hora son obligatorias.'); valid = false; }
                if (!descripcion) { displayError('movimiento-descripcion', 'La descripci√≥n es obligatoria.'); valid = false; }
                let newMov = { id: id || generateId(), tipo, cantidad: cantidadEnCentimos, fecha: fecha ? new Date(fecha).toISOString() : new Date().toISOString(), descripcion };
                if(tipo === 'traspaso') {
                    newMov.cuentaOrigenId = select('movimiento-cuenta-origen').value; newMov.cuentaDestinoId = select('movimiento-cuenta-destino').value; newMov.beneficiario = 'Com√∫n';
                    if (!newMov.cuentaOrigenId) { displayError('movimiento-cuenta-origen', 'Cuenta origen es obligatoria.'); valid = false; }
                    if (!newMov.cuentaDestinoId) { displayError('movimiento-cuenta-destino', 'Cuenta destino es obligatoria.'); valid = false; }
                    if (newMov.cuentaOrigenId === newMov.cuentaDestinoId) { displayError('movimiento-cuenta-destino', 'Origen y destino no pueden ser iguales.'); valid = false; }
                    if (cantidadEnCentimos <= 0) { displayError('movimiento-cantidad', 'Para traspasos, la cantidad debe ser positiva.'); valid = false; }
                } else {
                    newMov.cuentaId = select('movimiento-cuenta').value; newMov.conceptoId = select('movimiento-concepto').value; newMov.beneficiario = select('movimiento-beneficiario').value;
                    if (!newMov.cuentaId) { displayError('movimiento-cuenta', 'Cuenta es obligatoria.'); valid = false; }
                    if (!newMov.conceptoId) { displayError('movimiento-concepto', 'Concepto es obligatorio.'); valid = false; }
                    if (!newMov.beneficiario) { displayError('movimiento-beneficiario', 'Propietario es obligatorio.'); valid = false; }
                }
                if (!valid) return;
                setButtonLoading(saveMovBtn, true, 'Guardando...');
                if (id) { const index = db.movimientos.findIndex(m => m.id === id); if (index > -1) db.movimientos[index] = newMov; } 
                else { db.movimientos.push(newMov); }
                saveData(saveMovBtn, () => { e.target.reset(); select('movimiento-modal').classList.remove('active'); showToast(id ? 'Movimiento actualizado' : 'Movimiento a√±adido'); renderAll(); });
            }
            if (e.target.id === 'form-presupuesto') {
                e.preventDefault(); clearAllErrors('form-presupuesto');
                const ano = parseInt(select('presupuesto-ano').value), beneficiario = select('presupuesto-beneficiario-p').value, conceptoId = select('presupuesto-concepto').value, savePresupuestoBtn = select('save-presupuesto-btn');
                const cantidadStr = select('presupuesto-cantidad').value.trim().replace(',', '.'); const cantidadFloat = parseFloat(cantidadStr); const cantidadEnCentimos = Math.round(cantidadFloat * 100);
                let valid = true;
                if (isNaN(ano) || ano < 2000 || ano > 2100) { displayError('presupuesto-ano', 'A√±o inv√°lido.'); valid = false; }
                if (!beneficiario) { displayError('presupuesto-beneficiario-p', 'Propietario es obligatorio.'); valid = false; }
                if (!conceptoId) { displayError('presupuesto-concepto', 'Concepto es obligatorio.'); valid = false; }
                if (isNaN(cantidadFloat) || cantidadFloat <= 0) { displayError('presupuesto-cantidad', 'Cantidad debe ser un n√∫mero positivo.'); valid = false; }
                if (db.presupuestos.some(p => p.ano === ano && p.beneficiario === beneficiario && p.conceptoId === conceptoId)) { displayError('presupuesto-concepto', 'Ya existe un presupuesto con estos par√°metros.'); valid = false; }
                if (!valid) return;
                setButtonLoading(savePresupuestoBtn, true, 'Guardando...');
                const newPresupuesto = { id: generateId(), ano, beneficiario, conceptoId, cantidad: cantidadEnCentimos };
                db.presupuestos.push(newPresupuesto);
                saveData(savePresupuestoBtn, () => { e.target.reset(); showToast('Presupuesto guardado.'); renderAll(); });
            }
        });
    }

    const startEditMovement = (id) => {
        const modal = select('movimiento-modal');
        const form = select('form-movimiento');
        form.reset();
        clearAllErrors('form-movimiento');
        
        const mov = id ? db.movimientos.find(m => m.id === id) : null;
        
        select('form-movimiento-title').textContent = mov ? 'Editar Movimiento' : 'A√±adir Movimiento';
        select('movimiento-id').value = mov?.id || '';
        select('movimiento-tipo-selector').value = mov?.tipo || 'movimiento';
        select('movimiento-tipo-selector').dispatchEvent(new Event('change'));
        
        const cantidadParaEditar = mov ? mov.cantidad / 100 : '';
        select('movimiento-cantidad').value = mov ? cantidadParaEditar.toFixed(2).replace('.', ',') : '';
        
        select('movimiento-fecha').value = mov ? new Date(mov.fecha).toISOString().slice(0, 16) : new Date().toISOString().slice(0, 16);
        select('movimiento-descripcion').value = mov?.descripcion || '';
        
        if (mov?.tipo === 'traspaso') {
            select('movimiento-cuenta-origen').value = mov.cuentaOrigenId;
            select('movimiento-cuenta-destino').value = mov.cuentaDestinoId;
        } else {
            select('movimiento-cuenta').value = mov?.cuentaId || '';
            select('movimiento-concepto').value = mov?.conceptoId || '';
            select('movimiento-beneficiario').value = mov?.beneficiario || '';
        }
        
        select('delete-movimiento-btn').classList.toggle('hidden', !mov);
        if (mov) {
            select('delete-movimiento-btn').onclick = () => confirmDeleteMovement(mov.id);
        }
        
        modal.classList.add('active');
    };
    
    const confirmDeleteMovement = (id) => {
        showConfirmationModal('¬øSeguro que quieres eliminar este movimiento?', () => {
            db.movimientos = db.movimientos.filter(m => m.id !== id);
            saveData(null, () => {
                renderAll(); showToast('Movimiento eliminado.');
                select('movimiento-modal').classList.remove('active');
            });
        });
    };

    initApp();
});
</script>
</body>
</html>