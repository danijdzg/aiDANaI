<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restaurantes cercanos aiDANaI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
        "react/": "https://aistudiocdn.com/react@^19.2.0/",
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.27.0",
        "react-markdown": "https://aistudiocdn.com/react-markdown@^10.1.0"
      }
    }
    </script>
    <style>
      body {
        transition: background-color 0.3s ease, color 0.3s ease;
      }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>
    <script type="module">
        import React, { useState, useEffect, useCallback, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI, Modality } from '@google/genai';
        import Markdown from 'react-markdown';

        // --- START OF ICONS ---
        const MapPinIcon = (props) => (
          React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement("path", { d: "M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" }), React.createElement("circle", { cx: "12", cy: "10", r: "3" })
          )
        );
        const MicIcon = (props) => (
          React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement("path", { d: "M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" }), React.createElement("path", { d: "M19 10v2a7 7 0 0 1-14 0v-2" }), React.createElement("line", { x1: "12", x2: "12", y1: "19", y2: "22" })
          )
        );
        const LoadingSpinner = (props) => (
            React.createElement("svg", {
                ...props,
                xmlns: "http://www.w3.org/2000/svg",
                width: "24",
                height: "24",
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round",
                className: `animate-spin ${props.className || ''}`.trim()
            }, React.createElement("path", { d: "M21 12a9 9 0 1 1-6.219-8.56" }))
        );
        const SearchIcon = (props) => (
          React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement("circle", { cx: "11", cy: "11", r: "8" }), React.createElement("path", { d: "m21 21-4.3-4.3" })
          )
        );
        const AlertTriangleIcon = (props) => (
            React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
                React.createElement("path", { d: "m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" }), React.createElement("path", { d: "M12 9v4" }), React.createElement("path", { d: "M12 17h.01" })
            )
        );
        const LinkIcon = (props) => (
            React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
                React.createElement("path", { d: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72" }), React.createElement("path", { d: "M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72" })
            )
        );
        const StopCircleIcon = (props) => (
            React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
                React.createElement("circle", { cx: "12", cy: "12", r: "10" }), React.createElement("rect", { width: "6", height: "6", x: "9", y: "9" })
            )
        );
        const SunIcon = (props) => (
          React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement("circle", { cx: "12", cy: "12", r: "4" }), React.createElement("path", { d: "M12 2v2" }), React.createElement("path", { d: "M12 20v2" }), React.createElement("path", { d: "m4.93 4.93 1.41 1.41" }), React.createElement("path", { d: "m17.66 17.66 1.41 1.41" }), React.createElement("path", { d: "M2 12h2" }), React.createElement("path", { d: "M20 12h2" }), React.createElement("path", { d: "m4.93 19.07 1.41-1.41" }), React.createElement("path", { d: "m17.66 6.34 1.41-1.41" })
          )
        );
        const MoonIcon = (props) => (
          React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement("path", { d: "M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" })
          )
        );
        const HistoryIcon = (props) => (
          React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement("path", { d: "M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" }), React.createElement("path", { d: "M3 3v5h5" }), React.createElement("path", { d: "M12 7v5l4 2" })
          )
        );
        const MapIcon = (props) => (
            React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
                React.createElement("polygon", { points: "3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21" }),
                React.createElement("line", { x1: "9", y1: "3", x2: "9", y2: "18" }),
                React.createElement("line", { x1: "15", y1: "6", x2: "15", y2: "21" })
            )
        );
        const ListIcon = (props) => (
          React.createElement("svg", { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement("line", { x1: "8", x2: "21", y1: "6", y2: "6" }), React.createElement("line", { x1: "8", x2: "21", y1: "12", y2: "12" }), React.createElement("line", { x1: "8", x2: "21", y1: "18", y2: "18" }),
            React.createElement("line", { x1: "3", x2: "3.01", y1: "6", y2: "6" }), React.createElement("line", { x1: "3", x2: "3.01", y1: "12", y2: "12" }), React.createElement("line", { x1: "3", x2: "3.01", y1: "18", y2: "18" })
          )
        );
        // --- END OF ICONS ---

        // --- START OF AUDIO UTILS ---
        function encode(bytes) {
          let binary = '';
          const len = bytes.byteLength;
          for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
          }
          return btoa(binary);
        }
        function decode(base64) {
          const binaryString = atob(base64);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes;
        }
        async function decodeAudioData(data, ctx, sampleRate, numChannels) {
          const dataInt16 = new Int16Array(data.buffer);
          const frameCount = dataInt16.length / numChannels;
          const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);
          for (let channel = 0; channel < numChannels; channel++) {
            const channelData = buffer.getChannelData(channel);
            for (let i = 0; i < frameCount; i++) {
              channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
            }
          }
          return buffer;
        }
        // --- END OF AUDIO UTILS ---

        // --- START OF MAP VIEW COMPONENT ---
        const MapView = ({ userLocation, restaurants, hoveredId, onHover }) => {
            if (!userLocation) return null;

            const allPoints = [
                { ...userLocation, id: 'user' },
                ...restaurants.map(r => ({ latitude: r.latitude, longitude: r.longitude, id: r.name }))
            ];

            const bounds = allPoints.reduce((acc, point) => ({
                minLat: Math.min(acc.minLat, point.latitude),
                maxLat: Math.max(acc.maxLat, point.latitude),
                minLon: Math.min(acc.minLon, point.longitude),
                maxLon: Math.max(acc.maxLon, point.longitude),
            }), {
                minLat: Infinity, maxLat: -Infinity,
                minLon: Infinity, maxLon: -Infinity,
            });
            
            const latRange = bounds.maxLat - bounds.minLat;
            const lonRange = bounds.maxLon - bounds.minLon;

            // Add padding
            const padding = 0.1;
            bounds.minLat -= latRange * padding;
            bounds.maxLat += latRange * padding;
            bounds.minLon -= lonRange * padding;
            bounds.maxLon += lonRange * padding;

            const newLatRange = bounds.maxLat - bounds.minLat;
            const newLonRange = bounds.maxLon - bounds.minLon;

            const project = (lat, lon) => {
                if (newLonRange === 0 || newLatRange === 0) return { x: 50, y: 50 };
                const x = ((lon - bounds.minLon) / newLonRange) * 100;
                const y = ((bounds.maxLat - lat) / newLatRange) * 100;
                return { x, y };
            };

            const userPos = project(userLocation.latitude, userLocation.longitude);

            return (
                React.createElement("div", { className: "w-full h-full bg-slate-200 dark:bg-slate-800 rounded-lg overflow-hidden" },
                    React.createElement("svg", { width: "100%", height: "100%", viewBox: "0 0 100 100" },
                        React.createElement("rect", { width: "100", height: "100", fill: "currentColor", className: "text-slate-200 dark:text-slate-700/50" }),
                        restaurants.map((resto, index) => {
                            const pos = project(resto.latitude, resto.longitude);
                            const isHovered = hoveredId === resto.name;
                            return React.createElement("g", { 
                                key: index,
                                onMouseEnter: () => onHover(resto.name),
                                onMouseLeave: () => onHover(null),
                                className:"cursor-pointer"
                            },
                                React.createElement("circle", {
                                    cx: pos.x, cy: pos.y, r: isHovered ? 2 : 1.2,
                                    className: `transition-all ${isHovered ? 'fill-amber-400 stroke-slate-900 dark:stroke-white' : 'fill-indigo-600 stroke-white dark:stroke-slate-900'}`,
                                    strokeWidth: "0.5"
                                }),
                                React.createElement("text", {
                                    x: pos.x, y: pos.y - 2,
                                    className: `transition-opacity text-[4px] font-bold fill-slate-800 dark:fill-slate-200 text-anchor-middle ${isHovered ? 'opacity-100' : 'opacity-0'}`,
                                    textAnchor: "middle"
                                }, resto.name)
                            );
                        }),
                        React.createElement("g", null,
                          React.createElement("circle", { cx: userPos.x, cy: userPos.y, r: "1.5", className: "fill-blue-500 stroke-white", strokeWidth: "0.5" }),
                          React.createElement("circle", { cx: userPos.x, cy: userPos.y, r: "3", className: "fill-blue-500/30 animate-pulse" })
                        )
                    )
                )
            );
        };
        // --- END OF MAP VIEW COMPONENT ---

        // --- START OF RESTAURANT FINDER COMPONENT ---
        const RestaurantFinder = () => {
          const [isBusy, setIsBusy] = useState(true);
          const [loadingText, setLoadingText] = useState('Obteniendo tu ubicación...');
          const [error, setError] = useState(null);
          const [location, setLocation] = useState(null);
          const [results, setResults] = useState(null);
          const [distance, setDistance] = useState(1.5);
          const [price, setPrice] = useState('any');
          const [cuisine, setCuisine] = useState('');
          const [ambiance, setAmbiance] = useState('any');
          const [searchHistory, setSearchHistory] = useState([]);
          const [mobileView, setMobileView] = useState('list');
          const [hoveredId, setHoveredId] = useState(null);

          const priceOptions = [
            { value: 'cheap', label: '< 20€' },
            { value: 'moderate', label: '20-50€' },
            { value: 'expensive', label: '> 50€' },
            { value: 'any', label: 'Cualquiera' },
          ];
          
          const ambianceOptions = [
            { value: 'any', label: 'Cualquiera' },
            { value: 'romantic', label: 'Romántico' },
            { value: 'family', label: 'Familiar' },
            { value: 'casual', label: 'Informal' },
          ];

          useEffect(() => {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                setLocation({
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude,
                });
                setIsBusy(false);
              },
              () => {
                setError('No se pudo obtener tu ubicación. Por favor, activa los servicios de localización.');
                setIsBusy(false);
              }
            );
          }, []);

          const extractJsonFromMarkdown = (markdown) => {
              const match = /```json\s*([\s\S]*?)\s*```/.exec(markdown);
              if (match && match[1]) {
                  try {
                      return JSON.parse(match[1]);
                  } catch (e) {
                      console.error("Fallo al analizar JSON del markdown", e);
                      return null;
                  }
              }
              return null;
          };

          const runSearch = useCallback(async (searchPayload) => {
            if (!location) {
                setError('Tu ubicación no está disponible.');
                return;
            }
            
            const { distance, price, cuisine, ambiance } = searchPayload;
            
            setSearchHistory(prev => {
                const isDuplicate = prev.length > 0 && JSON.stringify(prev[0]) === JSON.stringify(searchPayload);
                if (isDuplicate) return prev;
                return [searchPayload, ...prev].slice(0, 5);
            });
            
            setLoadingText('Buscando los mejores lugares...');
            setIsBusy(true);
            setError(null);
            setResults(null);

            try {
              let priceDescription = 'de cualquier rango de precios';
              if(price === 'cheap') priceDescription = 'con precios por debajo de 20 euros';
              if(price === 'moderate') priceDescription = 'con precios entre 20 y 50 euros';
              if(price === 'expensive') priceDescription = 'con precios por encima de 50 euros';
              
              let cuisineFilter = cuisine ? `de cocina ${cuisine}` : '';
              let ambianceFilter = ambiance !== 'any' ? `con un ambiente ${ambianceOptions.find(o => o.value === ambiance).label.toLowerCase()}` : '';
              
              const prompt = `Busca los mejores restaurantes cerca de mi ubicación actual que cumplan con los siguientes criterios: en un radio de ${distance} kilómetros, ${priceDescription}, ${cuisineFilter}, ${ambianceFilter}.
                Quiero que tu respuesta sea únicamente un bloque de código markdown con un array JSON. No añadas texto introductorio ni explicaciones.
                Cada objeto del array debe representar un restaurante y tener las siguientes propiedades: "name" (string), "description" (string, breve y atractiva), "latitude" (number), "longitude" (number), y "googleMapsUri" (string).`;

              const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
              const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: prompt,
                config: {
                  tools: [{ googleMaps: {} }],
                  toolConfig: {
                    retrievalConfig: { latLng: location },
                  },
                },
              });

              const parsedResults = extractJsonFromMarkdown(response.text);
              if (parsedResults && Array.isArray(parsedResults)) {
                  setResults(parsedResults);
              } else {
                  setError("No se pudieron encontrar resultados con el formato esperado. Inténtalo de nuevo.");
              }

            } catch (err) {
              setError(err instanceof Error ? err.message : 'Ocurrió un error desconocido.');
            } finally {
              setIsBusy(false);
            }
          }, [location]);
          
          const handleSearchClick = () => {
            runSearch({ distance, price, cuisine, ambiance });
          };
          
          const handleHistorySearch = (item) => {
            setDistance(item.distance);
            setPrice(item.price);
            setCuisine(item.cuisine);
            setAmbiance(item.ambiance);
            runSearch(item);
          };
          
          const initialContent = (
            React.createElement("div", { className: "text-center" },
                React.createElement("button", {
                  onClick: handleSearchClick,
                  disabled: isBusy || !location,
                  className: "inline-flex items-center justify-center px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 disabled:bg-slate-500 disabled:cursor-not-allowed"
                },
                  React.createElement(SearchIcon, { className: "w-6 h-6 mr-3" }),
                  "Buscar Restaurantes"
                )
            )
          );

          return (
            React.createElement("div", { className: "w-full mx-auto flex flex-col md:flex-row gap-6 h-full" },
              React.createElement("div", { className: "w-full md:w-1/3 lg:w-1/4 flex-shrink-0" },
                React.createElement("div", { className: "bg-white dark:bg-slate-800 rounded-xl p-4 shadow-lg border border-slate-200 dark:border-slate-700 space-y-4" },
                    React.createElement("h2", { className: "text-xl font-bold text-indigo-600 dark:text-indigo-400" }, "Filtros de Búsqueda"),
                     React.createElement("div", { className:"space-y-4"},
                        // Distance
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "distance-slider", className: "block text-sm font-medium mb-1 text-slate-700 dark:text-slate-300" }, "Distancia Máxima"),
                            React.createElement("div", { className: "flex items-center gap-2" },
                                React.createElement("input", { id: "distance-slider", type: "range", min: "0.5", max: "10", step: "0.5", value: distance, onChange: (e) => setDistance(Number(e.target.value)), disabled: isBusy, className: "w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700 accent-indigo-600 disabled:opacity-50" }),
                                React.createElement("span", { className: "font-semibold text-center text-indigo-600 dark:text-indigo-400 bg-slate-100 dark:bg-slate-700/50 rounded-md px-2 py-0.5 text-sm w-16" }, `${distance.toFixed(1)} km`)
                            )
                        ),
                        // Price
                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300" }, "Límite de Precio"),
                             React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                                priceOptions.map((option) => React.createElement("button", { key: option.value, onClick: () => setPrice(option.value), disabled: isBusy, className: `w-full text-center px-2 py-1.5 text-sm rounded-lg font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-indigo-500 disabled:opacity-50 ${price === option.value ? 'bg-indigo-600 text-white shadow' : 'bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600'}` }, option.label))
                            )
                        ),
                        // Cuisine
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "cuisine-input", className: "block text-sm font-medium mb-1 text-slate-700 dark:text-slate-300" }, "Tipo de Cocina"),
                            React.createElement("input", { id: "cuisine-input", type: "text", value: cuisine, onChange: e => setCuisine(e.target.value), placeholder: "Ej: italiana, tapas...", disabled: isBusy, className: "w-full px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700/50 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50" })
                        ),
                        // Ambiance
                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300" }, "Ambiente"),
                            React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                                ambianceOptions.map((option) => React.createElement("button", { key: option.value, onClick: () => setAmbiance(option.value), disabled: isBusy, className: `w-full text-center px-2 py-1.5 text-sm rounded-lg font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-indigo-500 disabled:opacity-50 ${ambiance === option.value ? 'bg-indigo-600 text-white shadow' : 'bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600'}` }, option.label))
                            )
                        )
                    ),
                    React.createElement("div", { className: "mt-4" },
                        React.createElement("button", { onClick: handleSearchClick, disabled: isBusy || !location, className: "w-full inline-flex items-center justify-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 disabled:bg-slate-500 disabled:cursor-not-allowed" }, isBusy ? React.createElement(LoadingSpinner, { className: "w-5 h-5 mr-2" }) : React.createElement(SearchIcon, { className: "w-5 h-5 mr-2" }), isBusy ? "Buscando..." : "Buscar")
                    ),
                    searchHistory.length > 0 && (
                        React.createElement("div", { className: "pt-4 border-t border-slate-200 dark:border-slate-700" },
                            React.createElement("h3", { className: "text-sm font-semibold mb-2 flex items-center text-slate-700 dark:text-slate-300" }, React.createElement(HistoryIcon, { className: "w-4 h-4 mr-2" }), "Búsquedas Recientes"),
                            React.createElement("div", { className: "flex flex-wrap gap-1" },
                                searchHistory.map((item, index) => (
                                    React.createElement("button", { key: index, onClick: () => handleHistorySearch(item), disabled: isBusy, className: "text-xs px-2 py-1 rounded-md bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors disabled:opacity-50" }, `${item.distance}km, ${priceOptions.find(p => p.value === item.price)?.label}, ${item.cuisine || 'cualquier cocina'}`)
                                ))
                            )
                        )
                    )
                )
              ),
              React.createElement("div", { className: "w-full md:w-2/3 lg:w-3/4 flex-grow flex flex-col" },
                React.createElement("div", { className: "bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-4 flex-grow flex flex-col min-h-[60vh] md:min-h-0" },
                  isBusy ? React.createElement("div", { className: "flex flex-col items-center justify-center text-center h-full" }, React.createElement(LoadingSpinner, { className: "w-12 h-12 text-indigo-500 dark:text-indigo-400" }), React.createElement("p", { className: "mt-4 text-lg text-slate-600 dark:text-slate-300" }, loadingText))
                  : error ? React.createElement("div", { className: "flex items-center justify-center h-full" }, React.createElement("div", { className: "bg-red-100 dark:bg-red-900/40 border border-red-300 dark:border-red-700/50 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg flex items-center", role: "alert" }, React.createElement(AlertTriangleIcon, { className: "w-6 h-6 mr-3" }), React.createElement("span", { className: "block sm:inline" }, error)))
                  : !results ? React.createElement("div", { className: "flex items-center justify-center h-full text-slate-500 dark:text-slate-400" }, React.createElement("p", null, "Ajusta los filtros y busca para ver resultados"))
                  : React.createElement(React.Fragment, null,
                      React.createElement("div", { className: "md:hidden flex justify-center mb-2" },
                        React.createElement("div", { className: "flex items-center space-x-1 bg-slate-200 dark:bg-slate-700 p-1 rounded-full" },
                          React.createElement("button", { onClick: () => setMobileView('list'), className: `px-3 py-1 text-sm rounded-full flex items-center ${mobileView === 'list' ? 'bg-white dark:bg-slate-800 shadow' : ''}` }, React.createElement(ListIcon, {className: "w-4 h-4 mr-1"}), "Lista"),
                          React.createElement("button", { onClick: () => setMobileView('map'), className: `px-3 py-1 text-sm rounded-full flex items-center ${mobileView === 'map' ? 'bg-white dark:bg-slate-800 shadow' : ''}` }, React.createElement(MapIcon, {className: "w-4 h-4 mr-1"}), "Mapa")
                        )
                      ),
                      React.createElement("div", { className: "flex-grow flex md:flex-row flex-col-reverse gap-4" },
                        React.createElement("div", { className: `w-full md:w-1/2 overflow-y-auto pr-2 ${mobileView !== 'list' && 'hidden'} md:block` },
                          results.length === 0 
                          ? React.createElement("div", { className: "text-center py-10 text-slate-500" }, "No se encontraron resultados para tu búsqueda.")
                          : React.createElement("div", { className: "space-y-3" },
                              results.map(resto => React.createElement("div", {
                                key: resto.name,
                                onMouseEnter: () => setHoveredId(resto.name),
                                onMouseLeave: () => setHoveredId(null),
                                className: `p-3 rounded-lg border transition-all duration-200 ${hoveredId === resto.name ? 'bg-indigo-50 dark:bg-slate-700/50 border-indigo-400 shadow-md' : 'bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700'}`
                              },
                                React.createElement("h4", { className: "font-bold text-md text-indigo-700 dark:text-indigo-400" }, resto.name),
                                React.createElement("p", { className: "text-sm text-slate-600 dark:text-slate-300 mt-1" }, resto.description),
                                React.createElement("a", { href: resto.googleMapsUri, target: "_blank", rel: "noopener noreferrer", className: "text-xs inline-flex items-center mt-2 text-indigo-600 dark:text-indigo-400 hover:underline" }, "Ver en Google Maps", React.createElement(LinkIcon, {className: "w-3 h-3 ml-1"}))
                              ))
                            )
                        ),
                        React.createElement("div", { className: `w-full md:w-1/2 ${mobileView !== 'map' && 'hidden'} md:block` },
                          React.createElement(MapView, { userLocation: location, restaurants: results, hoveredId: hoveredId, onHover: setHoveredId })
                        )
                      )
                  )
                )
              )
            )
          );
        };
        // --- END OF RESTAURANT FINDER COMPONENT ---

        // --- START OF LIVE ASSISTANT COMPONENT ---
        const LiveAssistant = () => {
          const [status, setStatus] = useState('idle');
          const [transcript, setTranscript] = useState([]);

          const sessionPromiseRef = useRef(null);
          const inputAudioContextRef = useRef(null);
          const outputAudioContextRef = useRef(null);
          const mediaStreamRef = useRef(null);
          const scriptProcessorRef = useRef(null);

          const currentInputTranscriptionRef = useRef('');
          const currentOutputTranscriptionRef = useRef('');
          const nextStartTimeRef = useRef(0);
          const audioSourcesRef = useRef(new Set());

          const stopConversation = useCallback(() => {
            if (sessionPromiseRef.current) {
                sessionPromiseRef.current.then((session) => session.close());
                sessionPromiseRef.current = null;
            }
            mediaStreamRef.current?.getTracks().forEach((track) => track.stop());
            mediaStreamRef.current = null;
            if (scriptProcessorRef.current) {
                scriptProcessorRef.current.disconnect();
                scriptProcessorRef.current = null;
            }
            inputAudioContextRef.current?.close();
            outputAudioContextRef.current?.close();
            inputAudioContextRef.current = null;
            outputAudioContextRef.current = null;
            audioSourcesRef.current.forEach(source => source.stop());
            audioSourcesRef.current.clear();
            nextStartTimeRef.current = 0;
            setStatus('idle');
          }, []);

          const startConversation = useCallback(async () => {
            setStatus('connecting');
            setTranscript([]);
            currentInputTranscriptionRef.current = '';
            currentOutputTranscriptionRef.current = '';

            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              mediaStreamRef.current = stream;

              inputAudioContextRef.current = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
              outputAudioContextRef.current = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
              nextStartTimeRef.current = outputAudioContextRef.current.currentTime;
              
              const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
              sessionPromiseRef.current = ai.live.connect({
                model: 'gemini-2.5-flash-native-audio-preview-09-2025',
                config: {
                  responseModalities: [Modality.AUDIO],
                  speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: 'Zephyr' } } },
                  inputAudioTranscription: {},
                  outputAudioTranscription: {},
                  systemInstruction: 'Eres un asistente de IA amigable y servicial. Mantén tus respuestas concisas y conversacionales.',
                },
                callbacks: {
                  onopen: () => {
                    if (!inputAudioContextRef.current || !mediaStreamRef.current) return;
                    setStatus('active');
                    const source = inputAudioContextRef.current.createMediaStreamSource(mediaStreamRef.current);
                    const scriptProcessor = inputAudioContextRef.current.createScriptProcessor(4096, 1, 1);
                    scriptProcessorRef.current = scriptProcessor;

                    scriptProcessor.onaudioprocess = (audioProcessingEvent) => {
                      const inputData = audioProcessingEvent.inputBuffer.getChannelData(0);
                      const pcmBlob = {
                        data: encode(new Uint8Array(new Int16Array(inputData.map(v => v * 32768)).buffer)),
                        mimeType: 'audio/pcm;rate=16000',
                      };
                      if (sessionPromiseRef.current) {
                        sessionPromiseRef.current.then((session) => {
                          session.sendRealtimeInput({ media: pcmBlob });
                        });
                      }
                    };
                    source.connect(scriptProcessor);
                    scriptProcessor.connect(inputAudioContextRef.current.destination);
                  },
                  onmessage: async (message) => {
                    if (message.serverContent?.outputTranscription) {
                      currentOutputTranscriptionRef.current += message.serverContent.outputTranscription.text;
                    }
                    if (message.serverContent?.inputTranscription) {
                      currentInputTranscriptionRef.current += message.serverContent.inputTranscription.text;
                    }

                    if (message.serverContent?.turnComplete) {
                        const fullInput = currentInputTranscriptionRef.current.trim();
                        const fullOutput = currentOutputTranscriptionRef.current.trim();
                        setTranscript(prev => {
                            const newTranscript = [...prev];
                            if (fullInput) newTranscript.push({ speaker: 'user', text: fullInput });
                            if (fullOutput) newTranscript.push({ speaker: 'model', text: fullOutput });
                            return newTranscript;
                        });
                        currentInputTranscriptionRef.current = '';
                        currentOutputTranscriptionRef.current = '';
                    }

                    const base64Audio = message.serverContent?.modelTurn?.parts[0]?.inlineData?.data;
                    if (base64Audio && outputAudioContextRef.current) {
                      const outputCtx = outputAudioContextRef.current;
                      nextStartTimeRef.current = Math.max(nextStartTimeRef.current, outputCtx.currentTime);
                      const audioBuffer = await decodeAudioData(decode(base64Audio), outputCtx, 24000, 1);
                      const source = outputCtx.createBufferSource();
                      source.buffer = audioBuffer;
                      source.connect(outputCtx.destination);
                      source.addEventListener('ended', () => { audioSourcesRef.current.delete(source); });
                      source.start(nextStartTimeRef.current);
                      nextStartTimeRef.current += audioBuffer.duration;
                      audioSourcesRef.current.add(source);
                    }
                  },
                  onerror: (e) => {
                    console.error('Error de la API Live:', e);
                    setStatus('error');
                    stopConversation();
                  },
                  onclose: () => {
                     if (status === 'active') { setStatus('idle'); }
                  },
                },
              });
            } catch (err) {
              console.error('Error al iniciar conversación:', err);
              setStatus('error');
            }
          }, [stopConversation, status]);

          const getStatusIndicator = () => {
            switch(status) {
                case 'idle': return React.createElement("div", { className: "w-3 h-3 rounded-full bg-slate-500" });
                case 'connecting': return React.createElement("div", { className: "w-3 h-3 rounded-full bg-yellow-500 animate-pulse" });
                case 'active': return React.createElement("div", { className: "w-3 h-3 rounded-full bg-green-500 animate-pulse" });
                case 'error': return React.createElement("div", { className: "w-3 h-3 rounded-full bg-red-500" });
            }
          }
          const getStatusText = () => {
            switch(status) {
                case 'idle': return 'Listo';
                case 'connecting': return 'Conectando';
                case 'active': return 'Escuchando';
                case 'error': return 'Error';
            }
          }

          return (
            React.createElement("div", { className: "w-full max-w-2xl mx-auto flex flex-col flex-grow" },
                React.createElement("div", { className: "bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-6 flex-grow flex flex-col" },
                    React.createElement("div", { className: "flex justify-between items-center mb-4" },
                        React.createElement("h2", { className: "text-2xl font-bold text-indigo-600 dark:text-indigo-400" }, "Asistente en Vivo"),
                        React.createElement("div", { className: "flex items-center space-x-2 bg-slate-200 dark:bg-slate-700 px-3 py-1.5 rounded-full" },
                            getStatusIndicator(),
                            React.createElement("span", { className: "text-sm font-medium text-slate-800 dark:text-slate-300" }, getStatusText())
                        )
                    ),

                    React.createElement("div", { className: "flex-grow bg-slate-100 dark:bg-slate-900/50 rounded-lg p-4 overflow-y-auto mb-4 border border-slate-200 dark:border-slate-700/50" },
                        transcript.length === 0 ? (
                            React.createElement("div", { className: "flex items-center justify-center h-full text-slate-500 dark:text-slate-500" },
                                React.createElement("p", null, "La transcripción de tu conversación aparecerá aquí.")
                            )
                        ) : (
                            React.createElement("div", { className: "space-y-4" },
                                transcript.map((entry, index) => (
                                    React.createElement("div", { key: index, className: `flex ${entry.speaker === 'user' ? 'justify-end' : 'justify-start'}` },
                                        React.createElement("div", { className: `max-w-[80%] p-3 rounded-xl ${entry.speaker === 'user' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-800 dark:bg-slate-700 dark:text-slate-200'}` },
                                            React.createElement("p", { className: "text-sm" }, entry.text)
                                        )
                                    )
                                ))
                            )
                        )
                    ),

                    React.createElement("div", { className: "flex justify-center" },
                        status === 'idle' || status === 'error' ? (
                            React.createElement("button", { onClick: startConversation, className: "inline-flex items-center justify-center px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-500/50" },
                                React.createElement(MicIcon, { className: "w-6 h-6 mr-3" }), "Iniciar Conversación"
                            )
                        ) : (
                            React.createElement("button", { onClick: stopConversation, className: "inline-flex items-center justify-center px-8 py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-full shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-500/50" },
                                React.createElement(StopCircleIcon, { className: "w-6 h-6 mr-3" }), "Detener Conversación"
                            )
                        )
                    )
                )
            )
          );
        };
        // --- END OF LIVE ASSISTANT COMPONENT ---

        // --- START OF APP COMPONENT ---
        const App = () => {
          const [mode, setMode] = useState('finder');
          const [theme, setTheme] = useState('dark');

          useEffect(() => {
            if (theme === 'dark') {
              document.documentElement.classList.add('dark');
              document.body.classList.add('dark:bg-slate-900', 'dark:text-slate-200');
              document.body.classList.remove('bg-slate-50', 'text-slate-800');
            } else {
              document.documentElement.classList.remove('dark');
              document.body.classList.add('bg-slate-50', 'text-slate-800');
              document.body.classList.remove('dark:bg-slate-900', 'dark:text-slate-200');
            }
          }, [theme]);

          const toggleTheme = () => {
            setTheme(prev => prev === 'dark' ? 'light' : 'dark');
          };

          return (
            React.createElement("div", { className: "min-h-screen flex flex-col font-sans" },
              React.createElement("header", { className: "bg-white/90 dark:bg-slate-900/80 backdrop-blur-sm shadow-md p-4 sticky top-0 z-10 border-b border-slate-200 dark:border-slate-800" },
                React.createElement("div", { className: "container mx-auto flex flex-col md:flex-row justify-between items-center gap-4 md:gap-0" },
                  React.createElement("h1", { className: "text-2xl md:text-3xl font-bold tracking-tight text-indigo-600 dark:text-indigo-400" }, "Restaurantes cercanos aiDANaI"),
                  React.createElement("div", {className: "flex items-center space-x-2 md:space-x-4"},
                    React.createElement("nav", { className: "flex items-center space-x-1 bg-slate-200 dark:bg-slate-800 p-1 rounded-full" },
                      React.createElement("button", {
                        onClick: () => setMode('finder'),
                        className: `px-3 py-1.5 text-sm font-medium rounded-full flex items-center transition-colors duration-300 ${mode === 'finder' ? 'bg-indigo-500 text-white shadow-sm' : 'text-slate-700 dark:text-slate-300 hover:bg-slate-300/60 dark:hover:bg-slate-700/60'}`
                      }, React.createElement(MapPinIcon, { className: "w-5 h-5 mr-2" }), "Restaurantes"),
                      React.createElement("button", {
                        onClick: () => setMode('live'),
                        className: `px-3 py-1.5 text-sm font-medium rounded-full flex items-center transition-colors duration-300 ${mode === 'live' ? 'bg-indigo-500 text-white shadow-sm' : 'text-slate-700 dark:text-slate-300 hover:bg-slate-300/60 dark:hover:bg-slate-700/60'}`
                      }, React.createElement(MicIcon, { className: "w-5 h-5 mr-2" }), "Asistente")
                    ),
                     React.createElement("button", { onClick: toggleTheme, className: "p-2 rounded-full bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-300/60 dark:hover:bg-slate-700/60 transition-colors" },
                        theme === 'dark' ? React.createElement(SunIcon, { className: "w-5 h-5" }) : React.createElement(MoonIcon, { className: "w-5 h-5" })
                     )
                  )
                )
              ),
              React.createElement("main", { className: "flex-grow container mx-auto p-4 md:p-8 flex" },
                mode === 'finder' && React.createElement(RestaurantFinder, null),
                mode === 'live' && React.createElement(LiveAssistant, null)
              ),
              React.createElement("footer", { className: "text-center p-4 text-xs text-slate-500 dark:text-slate-500 border-t border-slate-200 dark:border-slate-800" }, "Desarrollado con la API de Gemini")
            )
          );
        };
        // --- END OF APP COMPONENT ---

        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("No se pudo encontrar el elemento raíz para montar la aplicación");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          React.createElement(React.StrictMode, null, React.createElement(App, null))
        );
    </script>
</body>
</html>