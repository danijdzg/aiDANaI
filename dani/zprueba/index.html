<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>aiDANaI-CTAS</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            /* Colores Base */
            --c-bg: #000000;       /* Negro AMOLED */
            --c-surface: #000000;  /* Negro AMOLED */
            --c-surface-2: #121212; /* Gris muy oscuro */
            
            /* Indicadores */
            --c-primary: #0a84ff;
            --c-success: #30d158; /* Verde */
            --c-danger: #ff453a;  /* Rojo */
            --c-transfer: #0a84ff; /* Azul */
            --c-warning: #FFFF00; /* Amarillo */
            
            /* Textos */
            --c-text: #ffffff;
            --c-text-sec: #8e8e93;
            --c-border: #333333;
            
            --font-main: 'Inter', sans-serif;
        }

        body {
            background-color: var(--c-bg);
            color: var(--c-text);
            font-family: var(--font-main);
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
        }
        
        *::-webkit-scrollbar { display: none; }
        
        .app-layout { display: flex; flex-direction: column; height: 100%; }
        
        /* CABECERA */
        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--c-border); background-color: #000; }
        
        /* T√çTULO CORPORATIVO */
        h1 { 
            margin: 0; 
            font-size: 24px; 
            color: #FFFF00; /* AMARILLO */
            font-weight: 800; /* NEGRITA EXTRA */
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-badge {
            font-size: 12px; padding: 6px 12px; border-radius: 20px; font-weight: 600;
            display: flex; align-items: center; gap: 6px;
        }
        .status-loading { background: #eab308; color: black; }
        .status-success { background: var(--c-success); color: black; }
        .status-error { background: var(--c-danger); color: white; }

        /* AREA PRINCIPAL */
        .app-main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; background-color: #000; }

        /* === DASHBOARD === */
        .dashboard-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .summary-card { background: #111; border: 1px solid var(--c-border); border-radius: 12px; padding: 15px; text-align: center; }
        .summary-label { display: block; font-size: 12px; color: var(--c-warning); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .summary-value { font-size: 18px; font-weight: 700; }
        
        /* === PANEL DE FILTROS AVANZADO === */
        .filters-section { margin-bottom: 15px; }
        .filters-toggle {
            background: #222; border: 1px solid var(--c-border); color: var(--c-text);
            padding: 10px 20px; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-weight: 600;
            width: 100%; box-sizing: border-box; justify-content: center;
            transition: background 0.2s;
        }
        .filters-toggle:hover { background: #333; }
        
        .filters-panel {
            display: none; /* Oculto por defecto */
            background: #111; border: 1px solid var(--c-border);
            border-radius: 12px; padding: 15px; margin-top: 10px;
            animation: fadeIn 0.2s ease;
        }
        .filters-panel.active { display: block; }
        
        /* Grids para filtros */
        .filters-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .filters-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        .filter-input {
            width: 100%; background: #000; color: #fff;
            border: 1px solid var(--c-border); padding: 10px;
            border-radius: 8px; font-size: 13px; box-sizing: border-box;
        }
        .filter-input::placeholder { color: #555; }
        
        .filters-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-filter-apply { background: var(--c-primary); color: white; border: none; padding: 10px; border-radius: 8px; flex: 2; cursor: pointer; font-weight: 600; }
        .btn-filter-clear { background: #333; color: white; border: none; padding: 10px; border-radius: 8px; flex: 1; cursor: pointer; }

        /* === TABLA === */
        .table-container { 
            width: 100%; 
            overflow-x: auto; 
            background: #000000; 
            border-radius: 12px; 
            border: 1px solid var(--c-border); 
        }
        table { width: 100%; border-collapse: collapse; min-width: 900px; background-color: #000; }
        
        th { 
            background: #000000; 
            color: var(--c-warning); /* T√çTULOS AMARILLOS */
            font-size: 13px; 
            font-weight: 700;
            text-transform: uppercase; 
            padding: 12px; 
            text-align: left; 
            position: sticky; top: 0; 
            border-bottom: 1px solid var(--c-border); 
            white-space: nowrap; 
            cursor: pointer; user-select: none; 
        }
        
        th:hover { background: #111; }
        
        .sort-icon { font-size: 10px; margin-left: 5px; vertical-align: middle; opacity: 0.8; color: var(--c-warning); }
        
        td { 
            padding: 12px; 
            border-bottom: 1px solid #222; 
            font-size: 14px; 
            vertical-align: middle; 
            background-color: #000000; 
        }
        
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #111; }

        /* Columnas Espec√≠ficas */
        .td-date { color: #ffffff; font-variant-numeric: tabular-nums; width: 100px; text-align: center;}
        .td-amount { font-weight: 700; text-align: right; font-family: monospace; font-size: 15px; width: 120px; }
        .td-cuenta { font-weight: 600; } 
        .td-concepto { color: #ffffff; font-weight: 500; }
        .td-desc { color: #ffffff; font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .td-beneficiario { color: #ffffff; font-weight: 600; text-align: center; }

        /* Helpers */
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal & Form */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 4000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-body { background: #111; width: 90%; max-width: 450px; border-radius: 24px; padding: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid #333; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--c-text-sec); font-size: 13px; }
        .form-input { width: 100%; background: #000; border: 1px solid var(--c-border); color: var(--c-text); padding: 12px; border-radius: 12px; font-size: 16px; outline: none; box-sizing: border-box; }
        select.form-input { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 20px; }
        .filter-pills { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .filter-pill { background: #222; border: 1px solid var(--c-border); color: var(--c-text-sec); padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .filter-pill--active[data-type="gasto"] { background: var(--c-danger); color: white; border-color: var(--c-danger); }
        .filter-pill--active[data-type="ingreso"] { background: var(--c-success); color: white; border-color: var(--c-success); }
        .filter-pill--active[data-type="traspaso"] { background: var(--c-transfer); color: white; border-color: var(--c-transfer); }
        .btn-primary { width: 100%; background: var(--c-primary); color: white; border: none; padding: 14px; border-radius: 14px; font-size: 16px; font-weight: 600; margin-top: 10px; cursor: pointer; }

        /* Calculator & FAB */
        .calculator-ui { position: fixed; top: 50%; left: 50%; transform: translate(-50%, 150vh); width: 90%; max-width: 380px; background: #111; border: 1px solid #333; border-radius: 24px; padding: 20px; z-index: 5000; box-shadow: 0 40px 80px rgba(0,0,0,0.7); display: none; animation: slideUpToCenter 0.5s forwards; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .calc-btn { background: #222; border: none; color: var(--c-text); height: 60px; border-radius: 15px; font-size: 20px; cursor: pointer; }
        .calc-btn.confirm { background: var(--c-primary); color: white; grid-column: span 2; }
        .calc-display { background: #000; color: var(--c-text); font-size: 32px; text-align: right; padding: 20px; border-radius: 16px; margin-bottom: 10px; border: 1px solid #333; }
        
        .fab-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 0; display: flex; justify-content: center; z-index: 9000; }
        .fab-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: -1; }
        .fab-container.active .fab-overlay { opacity: 0.8; pointer-events: all; height: 100vh; }
        #fab-main-btn { position: absolute; bottom: 30px; width: 50px; height: 50px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); background: linear-gradient(135deg, #ffffac, #ffd700, #fbbf24); display: flex; justify-content: center; align-items: center; color: #5c4d00; transition: all 0.4s; z-index: 9002; box-shadow: 0 0 15px rgba(255,215,0,0.6); }
        .fab-container.active #fab-main-btn { transform: rotate(135deg) scale(0.9); background: linear-gradient(145deg, #333, #000); border-color: rgba(255,255,255,0.3); color: white; }
        .fab-action-btn { position: absolute; bottom: 35px; left: 50%; width: 50px; height: 50px; border-radius: 50%; border: none; color: white; display: flex; justify-content: center; align-items: center; transform: translateX(-50%) scale(0); opacity: 0; z-index: 9001; transition: all 0.3s; }
        .fab-container.active .btn-gasto { transform: translate(calc(-50% - 80px), -60px) scale(1); opacity: 1; background: linear-gradient(135deg, #ef4444, #dc2626); }
        .fab-container.active .btn-traspaso { transform: translate(-50%, -100px) scale(1); opacity: 1; background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .fab-container.active .btn-ingreso { transform: translate(calc(-50% + 80px), -60px) scale(1); opacity: 1; background: linear-gradient(135deg, #10b981, #059669); }
        .fab-label { position: absolute; top: 115%; left: 50%; transform: translateX(-50%); background: #000; color: #fff; font-size: 11px; font-weight: 800; padding: 4px 8px; border-radius: 6px; opacity: 0; transition: opacity 0.3s ease 0.1s; }
        .fab-container.active .fab-label { opacity: 1; }

        @keyframes slideUpToCenter { 0% { transform: translate(-50%, 150vh); opacity: 0; } 100% { transform: translate(-50%, -50%); opacity: 1; } }
        @keyframes fadeInCenter { from { opacity: 0; transform: translate(0, -20px); } to { opacity: 1; transform: translate(0, 0); } }
        #file-backup { display: none; }
    </style>
</head>
<body>

    <div class="app-layout">
        <header>
            <h1>aiDANaI-CTAS</h1>
            <div id="status-indicator" class="status-badge status-loading">
                <span class="material-icons" style="font-size: 14px;">sync</span>
                Buscando aidanai.xlsx...
            </div>
            <button onclick="document.getElementById('file-backup').click()" style="background:none; border:none; color: var(--c-text-sec); cursor:pointer; font-size: 12px; margin-left: 10px;">(Manual)</button>
        </header>

        <div class="app-main">
            <div class="dashboard-summary">
                <div class="summary-card">
                    <span class="summary-label">Ingresos</span>
                    <span class="summary-value" id="sum-ingreso">0,00 ‚Ç¨</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">Gastos</span>
                    <span class="summary-value" id="sum-gasto">0,00 ‚Ç¨</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">Saldo Neto</span>
                    <span class="summary-value" id="sum-neto">0,00 ‚Ç¨</span>
                </div>
            </div>

            <div class="filters-section">
                <button class="filters-toggle" onclick="toggleFilters()">
                    <span class="material-icons">tune</span> Filtros Avanzados
                </button>
                <div class="filters-panel" id="filters-panel">
                    
                    <div class="filters-row-3">
                        <select id="filtro-cuenta" class="filter-input"><option value="">Todas Cuentas</option></select>
                        <select id="filtro-concepto" class="filter-input"><option value="">Todos Conceptos</option></select>
                        <select id="filtro-beneficiario" class="filter-input"><option value="">Todos Beneficiarios</option></select>
                    </div>

                    <div class="filters-row-2">
                        <input type="date" id="filtro-fecha-desde" class="filter-input" placeholder="Desde">
                        <input type="date" id="filtro-fecha-hasta" class="filter-input" placeholder="Hasta">
                    </div>

                    <div class="filters-row-2">
                        <input type="number" id="filtro-importe-min" class="filter-input" placeholder="Importe M√≠n (‚Ç¨)" step="0.01">
                        <input type="number" id="filtro-importe-max" class="filter-input" placeholder="Importe M√°x (‚Ç¨)" step="0.01">
                    </div>

                    <div style="margin-bottom: 10px;">
                        <input type="text" id="filtro-texto" class="filter-input" placeholder="Buscar en descripci√≥n...">
                    </div>

                    <div class="filters-actions">
                        <button class="btn-filter-apply" onclick="aplicarFiltros()">Aplicar Filtros</button>
                        <button class="btn-filter-clear" onclick="limpiarFiltros()">Limpiar</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th onclick="ordenarPor('fecha')">Fecha <span class="sort-icon" id="sort-fecha">‚ñº</span></th>
                            <th onclick="ordenarPor('importe')" style="text-align: right;">Cantidad <span class="sort-icon" id="sort-importe"></span></th>
                            <th onclick="ordenarPor('cuenta')">Cuenta <span class="sort-icon" id="sort-cuenta"></span></th>
                            <th onclick="ordenarPor('concepto')">Concepto <span class="sort-icon" id="sort-concepto"></span></th>
                            <th onclick="ordenarPor('detalle')">Descripci√≥n <span class="sort-icon" id="sort-detalle"></span></th>
                            <th onclick="ordenarPor('beneficiario')" style="text-align: center;">Beneficiario <span class="sort-icon" id="sort-beneficiario"></span></th>
                        </tr>
                    </thead>
                    <tbody id="tabla-movimientos-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--c-text-sec);">
                                <span style="font-size: 40px; display: block; margin-bottom: 10px;">üìÇ</span>
                                Cargando datos locales...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <input type="file" id="file-backup" accept=".xlsx, .xls">
    </div>

    <div class="fab-container" id="fab-menu">
        <div class="fab-overlay" onclick="toggleFab()"></div>
        <div class="fab-actions">
            <button class="fab-action-btn btn-gasto" onclick="abrirModalGasto()"><span class="material-icons">remove</span><span class="fab-label">Gasto</span></button>
            <button class="fab-action-btn btn-traspaso" onclick="abrirModalTraspaso()"><span class="material-icons">swap_horiz</span><span class="fab-label">Traspaso</span></button>
            <button class="fab-action-btn btn-ingreso" onclick="abrirModalIngreso()"><span class="material-icons">add</span><span class="fab-label">Ingreso</span></button>
        </div>
        <button id="fab-main-btn" onclick="toggleFab()"><span class="material-icons">add</span></button>
    </div>

    <div class="calculator-ui" id="calculator">
        <div class="calc-display" id="calc-display">0</div>
        <div class="calc-grid">
            <button class="calc-btn" onclick="calcInput('7')">7</button><button class="calc-btn" onclick="calcInput('8')">8</button><button class="calc-btn" onclick="calcInput('9')">9</button><button class="calc-btn" onclick="calcInput('/')">√∑</button>
            <button class="calc-btn" onclick="calcInput('4')">4</button><button class="calc-btn" onclick="calcInput('5')">5</button><button class="calc-btn" onclick="calcInput('6')">6</button><button class="calc-btn" onclick="calcInput('*')">√ó</button>
            <button class="calc-btn" onclick="calcInput('1')">1</button><button class="calc-btn" onclick="calcInput('2')">2</button><button class="calc-btn" onclick="calcInput('3')">3</button><button class="calc-btn" onclick="calcInput('-')">-</button>
            <button class="calc-btn" onclick="calcInput('0')">0</button><button class="calc-btn" onclick="calcInput('.')">.</button><button class="calc-btn confirm" onclick="calcConfirm()">OK</button>
        </div>
    </div>

    <div class="modal-overlay" id="form-modal">
        <div class="modal-body">
            <h3 style="margin-top: 0; text-align: center; color: white;">Nuevo Movimiento</h3>
            <div class="filter-pills">
                <button type="button" class="filter-pill" data-type="gasto" onclick="setType('gasto')">Gasto</button>
                <button type="button" class="filter-pill" data-type="ingreso" onclick="setType('ingreso')">Ingreso</button>
                <button type="button" class="filter-pill" data-type="traspaso" onclick="setType('traspaso')">Traspaso</button>
            </div>
            <form id="form-movimiento" onsubmit="guardarMovimiento(event)">
                <div class="form-group"><label class="form-label">Cantidad</label><input type="text" id="input-cantidad" class="form-input" placeholder="0.00" readonly onclick="abrirCalculadora()"></div>
                <div class="form-group"><label class="form-label">Descripci√≥n</label><input type="text" id="input-descripcion" class="form-input" placeholder="Ej: Compra mensual"></div>
                <div class="form-group">
                    <label class="form-label">Beneficiario</label>
                    <select id="input-beneficiario" class="form-input">
                        <option value="">-- Seleccionar --</option>
                        <option value="Dani">Dani</option>
                        <option value="Norma">Norma</option>
                        <option value="Com√∫n">Com√∫n</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Fecha</label><input type="date" id="input-fecha" class="form-input"></div>
                <button type="submit" class="btn-primary">Guardar</button>
                <button type="button" onclick="cerrarModal()" style="width:100%; padding: 12px; margin-top: 10px; background: none; border: none; color: var(--c-text-sec); cursor: pointer;">Cancelar</button>
            </form>
        </div>
    </div>

<script>
    // =========================================================
    // 1. L√ìGICA DE NEGOCIO
    // =========================================================
    
    let movimientos = [];
    let calcValue = '';
    let ordenActual = { columna: 'fecha', direccion: 'desc' };
    
    // Estado de filtros
    let filtrosActivos = {
        cuenta: '',
        concepto: '',
        beneficiario: '',
        texto: '',
        fechaDesde: '',
        fechaHasta: '',
        importeMin: '',
        importeMax: ''
    };

    document.addEventListener('DOMContentLoaded', () => {
        cargarExcelLocal();
        const fileInput = document.getElementById('file-backup');
        if(fileInput) {
            fileInput.addEventListener('change', (e) => {
                if(e.target.files[0]) procesarArchivoManual(e.target.files[0]);
            });
        }
    });

    function actualizarEstado(estado, mensaje) {
        const badge = document.getElementById('status-indicator');
        badge.className = `status-badge status-${estado}`;
        let icon = 'sync';
        if(estado === 'success') icon = 'check_circle';
        if(estado === 'error') icon = 'error';
        badge.innerHTML = `<span class="material-icons" style="font-size: 14px;">${icon}</span> ${mensaje}`;
    }

    async function cargarExcelLocal() {
        try {
            const response = await fetch('./aidanai.xlsx');
            if (!response.ok) {
                if(response.status === 404) throw new Error("Archivo 'aidanai.xlsx' no encontrado.");
                throw new Error("Error de red o CORS.");
            }
            const arrayBuffer = await response.arrayBuffer();
            procesarExcelArrayBuffer(arrayBuffer);
            actualizarEstado('success', 'Datos actualizados');
        } catch (error) {
            console.error(error);
            actualizarEstado('error', 'Error (Usa Manual)');
            document.querySelector('#tabla-movimientos-body td').innerHTML = `
                <span style="color: var(--c-danger);">‚ö†Ô∏è No se pudo cargar autom√°ticamente.</span><br>
                Usa un servidor local o pulsa <strong>(Manual)</strong>.
            `;
        }
    }

    function procesarArchivoManual(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            procesarExcelArrayBuffer(e.target.result);
            actualizarEstado('success', 'Carga manual OK');
        };
        reader.readAsArrayBuffer(file);
    }

    function procesarExcelArrayBuffer(buffer) {
        try {
            const data = new Uint8Array(buffer);
            // raw: true CRUCIAL para obtener los n√∫meros reales
            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
            const sheetName = workbook.SheetNames.find(n => n.toLowerCase() === 'movimientos') || workbook.SheetNames[0];
            
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { 
                header: 1, raw: true, dateNF: 'yyyy-mm-dd', range: 65 
            });

            if (!rows || rows.length < 2) { 
                alert('Excel vac√≠o o estructura incorrecta.'); 
                return; 
            }
            parseRows(rows);
        } catch (err) { 
            console.error(err);
            alert('Error procesando el Excel.'); 
        }
    }

    // === PARSEO MONEDA ROBUSTO ===
    function parsearMoneda(val) {
        if (typeof val === 'number') return val;
        let str = String(val || '0').trim().replace(/[‚Ç¨$¬£\s]/g, '');
        if (str.includes(',')) {
            str = str.replace(/\./g, '').replace(',', '.');
        } else {
            str = str.replace(/\./g, '');
        }
        return parseFloat(str) || 0;
    }

    // === NUEVA FUNCI√ìN: CALCULAR SALDOS PROGRESIVOS ===
    function recalcularSaldos() {
        // 1. Crear una copia ordenada cronol√≥gicamente (antiguo a nuevo) para calcular
        let cronologico = [...movimientos].sort((a, b) => {
            // Si timestamps son iguales, usamos ID (orden de fila) para estabilidad
            if (a.timestamp === b.timestamp) return a.id - b.id;
            return a.timestamp - b.timestamp;
        });

        // 2. Acumuladores por cuenta
        const saldosTemp = {};

        // 3. Recorrer y asignar saldo al movimiento
        cronologico.forEach(m => {
            if (!saldosTemp[m.cuenta]) saldosTemp[m.cuenta] = 0;
            saldosTemp[m.cuenta] += m.importe;
            
            // Guardamos el saldo resultante EN ESE MOMENTO
            m.saldoCalculado = saldosTemp[m.cuenta];
        });
    }

    const parseRows = (rows) => {
        const nuevos = [];
        const cuentasSet = new Set();
        const conceptosSet = new Set();
        const beneficiariosSet = new Set();

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || !row[1] || !row[3]) continue;
            
            // FECHA
            let timestamp = 0;
            if (row[0] instanceof Date) {
                timestamp = row[0].getTime();
            } else {
                let fechaStr = String(row[0] || '').trim();
                if (fechaStr.includes('-')) {
                    timestamp = new Date(fechaStr).getTime();
                } else if (fechaStr.includes('/')) {
                    const parts = fechaStr.split('/');
                    if (parts.length === 3) {
                        let d = parseInt(parts[0]);
                        let m = parseInt(parts[1]) - 1;
                        let y = parseInt(parts[2]);
                        if (y < 100) y += 2000;
                        timestamp = new Date(y, m, d).getTime();
                    }
                }
            }
            if (isNaN(timestamp) || timestamp === 0) timestamp = Date.now();

            // IMPORTE
            let importe = parsearMoneda(row[3]);

            // CAMPOS
            const cuentaOrigen = String(row[1] || '').replace(/"/g,'').trim(); 
            const conceptoStr = String(row[2] || 'General').trim();           
            const detalleStr = String(row[4] || '').trim();
            const beneficiarioStr = String(row[5] || '').trim();
            
            // Recopilar para filtros
            if(cuentaOrigen) cuentasSet.add(cuentaOrigen);
            if(conceptoStr) conceptosSet.add(conceptoStr);
            if(beneficiarioStr) beneficiariosSet.add(beneficiarioStr);

            // TIPO
            let tipo = 'gasto';
            const textoAnalisis = (conceptoStr + " " + detalleStr).toUpperCase();
            
            if (textoAnalisis.includes('TRASPASO')) {
                tipo = 'traspaso'; 
            } else {
                if (importe >= 0) tipo = 'ingreso';
            }

            nuevos.push({
                id: Date.now() + i, // ID √∫nico para orden estable
                timestamp: timestamp,
                importe: importe,
                cuenta: cuentaOrigen,
                concepto: conceptoStr,
                detalle: detalleStr,
                beneficiario: beneficiarioStr,
                tipo: tipo,
                saldoCalculado: 0 // Se rellenar√° luego
            });
        }
        movimientos = nuevos; 
        
        // CALCULAR SALDOS REALES
        recalcularSaldos();

        // Actualizar UI Filtros
        actualizarSelectsFiltros(cuentasSet, conceptosSet, beneficiariosSet);
        
        renderMovimientos();
    };

    // ... Resto de funciones de filtros ...
    function toggleFilters() {
        document.getElementById('filters-panel').classList.toggle('active');
    }

    function actualizarSelectsFiltros(cuentas, conceptos, beneficiarios) {
        const fill = (id, set, label) => {
            const el = document.getElementById(id);
            const current = el.value;
            el.innerHTML = `<option value="">${label}</option>`;
            Array.from(set).sort().forEach(item => {
                const opt = document.createElement('option');
                opt.value = item; opt.textContent = item;
                el.appendChild(opt);
            });
            el.value = current;
        };

        fill('filtro-cuenta', cuentas, 'Todas las Cuentas');
        fill('filtro-concepto', conceptos, 'Todos los Conceptos');
        fill('filtro-beneficiario', beneficiarios, 'Todos los Beneficiarios');
    }

    function aplicarFiltros() {
        filtrosActivos.cuenta = document.getElementById('filtro-cuenta').value;
        filtrosActivos.concepto = document.getElementById('filtro-concepto').value;
        filtrosActivos.beneficiario = document.getElementById('filtro-beneficiario').value;
        filtrosActivos.texto = document.getElementById('filtro-texto').value.toLowerCase();
        filtrosActivos.fechaDesde = document.getElementById('filtro-fecha-desde').value;
        filtrosActivos.fechaHasta = document.getElementById('filtro-fecha-hasta').value;
        filtrosActivos.importeMin = document.getElementById('filtro-importe-min').value;
        filtrosActivos.importeMax = document.getElementById('filtro-importe-max').value;
        renderMovimientos();
    }

    function limpiarFiltros() {
        document.getElementById('filtro-cuenta').value = '';
        document.getElementById('filtro-concepto').value = '';
        document.getElementById('filtro-beneficiario').value = '';
        document.getElementById('filtro-texto').value = '';
        document.getElementById('filtro-fecha-desde').value = '';
        document.getElementById('filtro-fecha-hasta').value = '';
        document.getElementById('filtro-importe-min').value = '';
        document.getElementById('filtro-importe-max').value = '';
        aplicarFiltros();
    }

    // ========================================================
    // 3. RENDERIZADO Y ORDENACI√ìN
    // ========================================================
    function ordenarPor(columna) {
        if (ordenActual.columna === columna) {
            ordenActual.direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
        } else {
            ordenActual.columna = columna;
            ordenActual.direccion = 'asc';
        }
        renderMovimientos();
    }

    function renderMovimientos() {
        const tbody = document.getElementById('tabla-movimientos-body');
        
        // El saldo YA est√° calculado en m.saldoCalculado por recalcularSaldos()

        // 2. Filtrado
        let lista = movimientos.filter(m => {
            if (filtrosActivos.cuenta && m.cuenta !== filtrosActivos.cuenta) return false;
            if (filtrosActivos.concepto && m.concepto !== filtrosActivos.concepto) return false;
            if (filtrosActivos.beneficiario && m.beneficiario !== filtrosActivos.beneficiario) return false;
            
            if (filtrosActivos.texto) {
                const contenido = (m.descripcion + ' ' + m.detalle).toLowerCase();
                if (!contenido.includes(filtrosActivos.texto)) return false;
            }

            if (filtrosActivos.fechaDesde) {
                const dDesde = new Date(filtrosActivos.fechaDesde);
                dDesde.setHours(0,0,0,0);
                if (m.timestamp < dDesde.getTime()) return false;
            }
            if (filtrosActivos.fechaHasta) {
                const dHasta = new Date(filtrosActivos.fechaHasta);
                dHasta.setHours(23,59,59,999);
                if (m.timestamp > dHasta.getTime()) return false;
            }

            if (filtrosActivos.importeMin !== '' && m.importe < parseFloat(filtrosActivos.importeMin)) return false;
            if (filtrosActivos.importeMax !== '' && m.importe > parseFloat(filtrosActivos.importeMax)) return false;

            return true;
        });

        // 3. Ordenar
        lista.sort((a, b) => {
            let valA, valB;
            // SI ORDENAMOS POR FECHA (L√ìGICA MEJORADA)
            if (ordenActual.columna === 'fecha') {
                if (a.timestamp === b.timestamp) {
                    // DESEMPATE: Por Saldo Calculado
                    // Si es DESC (lo m√°s nuevo arriba), mostramos primero el saldo MAYOR (o final)
                    // Asumimos que el saldo final es el "√∫ltimo" estado del d√≠a.
                    return ordenActual.direccion === 'asc' 
                        ? a.saldoCalculado - b.saldoCalculado 
                        : b.saldoCalculado - a.saldoCalculado;
                }
                valA = a.timestamp;
                valB = b.timestamp;
            } else {
                valA = a[ordenActual.columna];
                valB = b[ordenActual.columna];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
            }
            
            if (valA < valB) return ordenActual.direccion === 'asc' ? -1 : 1;
            if (valA > valB) return ordenActual.direccion === 'asc' ? 1 : -1;
            return 0;
        });

        // 4. Totales de la VISTA FILTRADA
        let tIng = 0, tGas = 0, tNeto = 0;

        if (lista.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">No se encontraron movimientos.</td></tr>';
            actualizarTotales(0,0,0);
            return;
        }

        const html = lista.map(m => {
            if(m.tipo === 'ingreso') tIng += m.importe;
            else if(m.tipo === 'gasto') tGas += m.importe;
            tNeto += m.importe;

            const dateObj = new Date(m.timestamp);
            const d = String(dateObj.getDate()).padStart(2, '0');
            const mo = String(dateObj.getMonth() + 1).padStart(2, '0');
            const y = dateObj.getFullYear();
            const fechaFmt = `${d}/${mo}/${y}`;

            const fmtMoney = (val) => new Intl.NumberFormat('es-ES', { 
                style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2
            }).format(Math.abs(val));

            let color = '', signo = '';
            if (m.importe < 0) { signo = '-'; } else { signo = '+'; }

            if(m.tipo === 'gasto') { color = 'var(--c-danger)'; }
            else if(m.tipo === 'ingreso') { color = 'var(--c-success)'; }
            else { color = 'var(--c-transfer)'; } 

            const saldoFmt = new Intl.NumberFormat('es-ES', { 
                style: 'currency', currency: 'EUR', minimumFractionDigits: 2 
            }).format(m.saldoCalculado);

            return `
                <tr>
                    <td class="td-date">${fechaFmt}</td>
                    <td class="td-amount" style="color: ${color}">${signo}${fmtMoney(m.importe)}</td>
                    <td class="td-cuenta" style="color: ${color}">
                        ${m.cuenta} <span style="font-weight:400; font-size:12px; opacity:0.8;">(${saldoFmt})</span>
                    </td>
                    <td class="td-concepto">${m.concepto}</td>
                    <td class="td-desc" title="${m.detalle}">${m.detalle}</td>
                    <td class="td-beneficiario">${m.beneficiario}</td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
        actualizarTotales(tIng, tGas, tNeto);
    }

    function actualizarTotales(ing, gas, neto) {
        const fmt = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
        const setVal = (id, val) => {
            const el = document.getElementById(id);
            el.textContent = fmt(val);
            if (val >= 0) el.style.color = 'var(--c-success)';
            else el.style.color = 'var(--c-danger)';
        };
        setVal('sum-ingreso', ing);
        setVal('sum-gasto', gas);
        setVal('sum-neto', neto);
    }

    // Funciones UI (toggleFab, abrirModal, etc. igual que antes)
    function toggleFab() { document.getElementById('fab-menu').classList.toggle('active'); }
    function abrirModalGasto() { toggleFab(); openModal('gasto'); }
    function abrirModalIngreso() { toggleFab(); openModal('ingreso'); }
    function abrirModalTraspaso() { toggleFab(); openModal('traspaso'); }
    
    function openModal(t) { 
        document.getElementById('form-modal').classList.add('active'); 
        document.getElementById('form-movimiento').reset();
        document.getElementById('input-fecha').valueAsDate = new Date();
        setType(t); 
    }
    function cerrarModal() { document.getElementById('form-modal').classList.remove('active'); }
    function setType(t) {
        document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('filter-pill--active'));
        document.querySelector(`.filter-pill[data-type="${t}"]`).classList.add('filter-pill--active');
        document.getElementById('form-movimiento').dataset.currentType = t;
    }
    
    function guardarMovimiento(e) {
        e.preventDefault();
        const t = document.getElementById('form-movimiento').dataset.currentType || 'gasto';
        let imp = parseFloat(document.getElementById('input-cantidad').value) || 0;
        if (t === 'gasto') imp = -Math.abs(imp); else imp = Math.abs(imp);

        movimientos.unshift({
            id: Date.now(),
            timestamp: new Date(document.getElementById('input-fecha').value).getTime(),
            importe: imp,
            cuenta: 'Manual', concepto: 'General', 
            detalle: document.getElementById('input-descripcion').value,
            beneficiario: document.getElementById('input-beneficiario').value,
            tipo: t,
            saldoCalculado: 0
        });
        
        recalcularSaldos();
        actualizarSelectsFiltros(new Set(movimientos.map(m=>m.cuenta)), new Set(movimientos.map(m=>m.concepto)), new Set(movimientos.map(m=>m.beneficiario)));
        renderMovimientos();
        cerrarModal();
    }

    function abrirCalculadora() { 
        document.getElementById('calculator').style.display = 'block'; 
        calcValue = ''; updateCalcDisplay(); 
    }
    function calcInput(k) { if(calcValue==='0') calcValue=''; calcValue += k; updateCalcDisplay(); }
    function updateCalcDisplay() { document.getElementById('calc-display').innerText = calcValue || '0'; }
    function calcConfirm() { 
        try { 
            document.getElementById('input-cantidad').value = parseFloat(eval(calcValue)).toFixed(2);
            document.getElementById('calculator').style.display = 'none'; 
        } catch(e) { setTimeout(() => { calcValue=''; updateCalcDisplay(); }, 500); } 
    }
</script>
</body>
</html>