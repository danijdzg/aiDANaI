<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta name="description" content="aiDANaI - Gestión Financiera Personal de Alto Rendimiento">
    <title>aiDANaI | Finanzas Personales</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://alcdn.msauth.net">

    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Inter:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* PALETA DE COLORES: "Midnight Ledger" */
            --bg-body: #09090b;       /* Negro casi absoluto */
            --bg-card: #18181b;       /* Gris carbón para tarjetas */
            --bg-input: #27272a;      /* Gris intermedio para inputs */
            
            /* ACENTOS NEÓN */
            --c-primary: #3b82f6;     /* Azul eléctrico (Acciones principales) */
            --c-accent: #8b5cf6;      /* Violeta (Inversiones/Cripto) */
            --c-success: #10b981;     /* Verde Semáforo (Ingresos/Positivo) */
            --c-danger: #ef4444;      /* Rojo Semáforo (Gastos/Negativo) */
            --c-warning: #f59e0b;     /* Ámbar (Alertas) */
            
            /* TEXTOS */
            --t-main: #f4f4f5;        /* Blanco humo */
            --t-muted: #a1a1aa;       /* Gris claro */
            --t-placeholder: #52525b; /* Gris oscuro */

            /* EFECTOS */
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --glow-primary: 0 0 15px rgba(59, 130, 246, 0.3);
            --radius: 12px;
            --font-ui: 'Inter', system-ui, sans-serif;
            --font-num: 'Fira Code', monospace; /* Clave para alinear cifras */
        }

        /* RESET & BASE */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg-body);
            color: var(--t-main);
            font-family: var(--font-ui);
            margin: 0;
            padding: 0;
            font-size: 16px;
            overflow-x: hidden; /* Evita scroll lateral */
        }

        /* LAYOUT PRINCIPAL */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px; /* Espacio para el menú flotante si lo hubiera */
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 10px 0;
        }
        .brand {
            font-weight: 800;
            font-size: 1.5rem;
            letter-spacing: -1px;
            background: linear-gradient(to right, var(--c-primary), var(--c-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* TARJETAS (Glassmorphism sutil) */
        .card {
            background-color: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-card);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            border-color: rgba(255,255,255,0.1);
        }

        /* RESUMEN FINANCIERO (Dashboard) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .metric-label { font-size: 0.85rem; color: var(--t-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { 
            font-family: var(--font-num); 
            font-size: 1.8rem; 
            font-weight: 600; 
            margin-top: 5px; 
        }
        .text-success { color: var(--c-success); }
        .text-danger { color: var(--c-danger); }

        /* BOTONES MODERNOS */
        .btn {
            background-color: var(--bg-input);
            color: var(--t-main);
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-ui);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--c-primary), #2563eb);
            box-shadow: var(--glow-primary);
        }
        .btn-primary:active { transform: scale(0.96); }

        /* INPUTS FLUIDOS */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: var(--t-muted); font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            background-color: var(--bg-input);
            border: 1px solid transparent;
            color: var(--t-main);
            padding: 12px 15px;
            border-radius: var(--radius);
            font-family: var(--font-ui);
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            border-color: var(--c-primary);
            background-color: #3f3f46; /* Ligeramente más claro al foco */
        }

        /* MODALES */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* UTILIDADES */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="login-screen" class="flex-center" style="height: 100vh; flex-direction: column; gap: 20px;">
        <h1 class="brand" style="font-size: 3rem;">aiDANaI</h1>
        <p style="color: var(--t-muted);">Sistema de Control Financiero Seguro</p>
        <button id="btn-login" class="btn btn-primary">
            <span class="material-icons">login</span> Conectar con Microsoft
        </button>
        <p id="login-status" style="font-size: 0.8rem; color: var(--t-muted); margin-top: 10px;"></p>
    </div>

    <div id="app-content" class="app-container hidden">
        <header>
            <div class="brand">aiDANaI</div>
            <div class="user-info" style="display: flex; gap: 10px; align-items: center;">
                <span id="user-name" style="font-size: 0.9rem;">Usuario</span>
                <button onclick="logout()" class="btn" style="padding: 5px 10px; font-size: 0.8rem;">
                    <span class="material-icons">logout</span>
                </button>
            </div>
        </header>

        <div class="dashboard-grid">
            <div class="card">
                <div class="metric-label">Patrimonio Total</div>
                <div class="metric-value text-success" id="total-balance">-- €</div>
            </div>
            <div class="card">
                <div class="metric-label">Gastos del Mes</div>
                <div class="metric-value text-danger" id="month-expenses">-- €</div>
            </div>
            <div class="card">
                <div class="metric-label">Inversiones</div>
                <div class="metric-value" style="color: var(--c-accent);" id="investment-total">-- €</div>
            </div>
        </div>

        <div class="card" style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px;">
            <button class="btn btn-primary" onclick="abrirModal('ingreso')">
                <span class="material-icons">add</span> Ingreso
            </button>
            <button class="btn" style="background: rgba(239, 68, 68, 0.2); color: var(--c-danger);" onclick="abrirModal('gasto')">
                <span class="material-icons">remove</span> Gasto
            </button>
            <button class="btn" style="background: rgba(59, 130, 246, 0.2); color: var(--c-primary);" onclick="abrirModal('traspaso')">
                <span class="material-icons">swap_horiz</span> Traspaso
            </button>
             <button class="btn" onclick="recargarDatos()">
                <span class="material-icons">refresh</span> Actualizar
            </button>
        </div>

        <h3 style="color: var(--t-muted); margin-left: 5px;">Últimos Movimientos</h3>
        <div id="lista-movimientos" style="display: flex; flex-direction: column; gap: 10px;">
            <div class="card flex-center" style="padding: 40px; color: var(--t-muted);">
                Cargando datos seguros...
            </div>
        </div>
    </div>

    <div id="modal-transaccion" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-titulo" style="margin-top: 0;">Nueva Transacción</h2>
            
            <form id="form-transaccion">
                <div class="form-group">
                    <label>Importe</label>
                    <input type="number" id="input-importe" step="0.01" placeholder="0.00" style="font-size: 1.5rem; font-family: var(--font-num);" required>
                </div>

                <div class="form-group">
                    <label>Concepto / Descripción</label>
                    <input type="text" id="input-concepto" placeholder="Ej: Mercadona, Nómina..." required>
                </div>

                <div class="form-group">
                    <label>Cuenta</label>
                    <select id="select-cuenta">
                        <option>Cargando cuentas...</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn" style="width: 100%" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="width: 100%">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
		
        // ==========================================
        // 1. CONFIGURACIÓN Y ESTADO (SINGLE SOURCE OF TRUTH)
        // ==========================================
        const CONFIG = {
            archivo: 'aidanai.xlsx',
            hojas: { config: 'Config', movimientos: 'Movimientos' },
            auth: {
                clientId: "2a1e29f1-6b47-4ba2-a48e-adc4339e4514", // <--- IMPORTANTE: Pega aquí tu ID de Azure
                scopes: ["User.Read", "Files.ReadWrite.All"]
            },
            colores: {
                ingreso: getComputedStyle(document.documentElement).getPropertyValue('--c-success').trim(),
                gasto: getComputedStyle(document.documentElement).getPropertyValue('--c-danger').trim(),
                traspaso: '#00B8FF' // El azul eléctrico original de tu código
            }
        };

        // Estado Reactivo (Cuando esto cambia, la UI se actualiza)
        let AppState = {
            usuario: null,
            cuentas: [],       // Datos de la hoja 'Config'
            movimientos: [],   // Datos de la hoja 'Movimientos'
            balanceTotal: 0,
            ultimoWorkbook: null // Guardamos el binario para poder editarlo
        };

        // Instancias de Librerías
        let msalInstance;

        // ==========================================
        // 2. INICIO Y AUTENTICACIÓN (MSAL)
        // ==========================================
        async function initApp() {
            try {
                const msalConfig = {
                    auth: {
                        clientId: CONFIG.auth.clientId,
                        authority: "https://login.microsoftonline.com/common",
                        redirectUri: window.location.origin
                    },
                    cache: { cacheLocation: "localStorage" }
                };
                
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();

                // Verificar si ya hay sesión activa
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    manejarLoginExitoso(accounts[0]);
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                }

                // Event Listeners para botones globales
                document.getElementById('btn-login').addEventListener('click', login);
                
                // Cargar sonidos/vibración si existen
                configurarEfectos();

            } catch (error) {
                console.error("Error crítico al iniciar:", error);
                alert("Error de inicio: Verifica tu configuración de Azure.");
            }
        }

        async function login() {
            try {
                const response = await msalInstance.loginPopup({ scopes: CONFIG.auth.scopes });
                manejarLoginExitoso(response.account);
            } catch (error) {
                console.error(error);
                document.getElementById('login-status').innerText = "Error de conexión. Intenta de nuevo.";
            }
        }

        function manejarLoginExitoso(account) {
            AppState.usuario = account;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('user-name').innerText = account.name.split(' ')[0]; // Solo primer nombre
            
            // Cargar datos financieros inmediatamente
            cargarExcelDesdeNube();
        }

        function logout() {
            msalInstance.logoutPopup();
            window.location.reload();
        }

        // ==========================================
        // 3. MOTOR DE DATOS (EXCEL / GRAPH API)
        // ==========================================
        async function cargarExcelDesdeNube() {
            mostrarCargando(true);
            try {
                // 1. Obtener Token
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    account: AppState.usuario,
                    scopes: CONFIG.auth.scopes
                });

                // 2. Descargar Archivo desde OneDrive (Graph API)
                // Nota: Busca en la raíz de OneDrive. Si está en carpeta, ajustar ruta.
                const graphUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${CONFIG.archivo}:/content`;
                
                const response = await fetch(graphUrl, {
                    headers: { 'Authorization': `Bearer ${tokenResponse.accessToken}` }
                });

                if (!response.ok) throw new Error("No se encontró el archivo aidanai.xlsx en tu OneDrive");

                const arrayBuffer = await response.arrayBuffer();
                
                // 3. Parsear con SheetJS
                procesarExcel(arrayBuffer);

            } catch (error) {
                console.error(error);
                alert("Error cargando datos: " + error.message);
                // MODO DEMO (Si falla la nube, para que veas la UI)
                // generarDatosDemo(); 
            } finally {
                mostrarCargando(false);
            }
        }

        function procesarExcel(buffer) {
            const workbook = XLSX.read(buffer, { type: 'array', cellDates: true });
            AppState.ultimoWorkbook = workbook; // Guardamos referencia para guardar después

            // LEER HOJA CONFIG (Cuentas)
            const hojaConfig = workbook.Sheets[CONFIG.hojas.config];
            const datosConfig = XLSX.utils.sheet_to_json(hojaConfig);
            AppState.cuentas = datosConfig.map(c => ({
                id: c.Cuenta,
                tipo: c.Tipo,
                esInversion: c.EsInversion === 'Si', // Normalización booleana
                saldo: 0 // Se calculará sumando movimientos
            }));

            // LEER HOJA MOVIMIENTOS
            const hojaMovs = workbook.Sheets[CONFIG.hojas.movimientos];
            // sheet_to_json a veces da problemas con fechas, usamos raw: false para fechas formateadas o true para objetos Date
            const datosMovs = XLSX.utils.sheet_to_json(hojaMovs); 
            
            AppState.movimientos = datosMovs.map(m => ({
                fecha: new Date(m.FECHA),
                cuenta: m.CUENTA,
                concepto: m.CONCEPTO,
                importe: parseFloat(m.IMPORTE) || 0, // Seguridad numérica
                descripcion: m.DESCRIPCIÓN || '',
                beneficiario: m.BENEFICIARIO || ''
            })).sort((a, b) => b.fecha - a.fecha); // Ordenar por fecha descendente

            calcularSaldos();
            actualizarUI();
        }

        function calcularSaldos() {
            // Reiniciar saldos
            AppState.cuentas.forEach(c => c.saldo = 0);
            let patrimonioTotal = 0;
            let gastosMes = 0;
            let inversiones = 0;
            
            const mesActual = new Date().getMonth();
            const anioActual = new Date().getFullYear();

            // Sumar movimientos
            AppState.movimientos.forEach(mov => {
                const cuenta = AppState.cuentas.find(c => c.id === mov.cuenta);
                if (cuenta) {
                    cuenta.saldo += mov.importe;
                }

                // Cálculo de métricas del Dashboard
                // Gastos del mes (Importe negativo y no es traspaso interno)
                if (mov.fecha.getMonth() === mesActual && mov.fecha.getFullYear() === anioActual) {
                    if (mov.importe < 0 && mov.concepto !== 'Traspaso' && mov.concepto !== 'Inicial') {
                        gastosMes += Math.abs(mov.importe);
                    }
                }
            });

            // Sumar totales por tipo
            AppState.cuentas.forEach(c => {
                patrimonioTotal += c.saldo;
                if (c.esInversion) inversiones += c.saldo;
            });

            // Actualizar Estado Global
            AppState.balanceTotal = patrimonioTotal;
            AppState.gastosMes = gastosMes;
            AppState.inversiones = inversiones;
        }

        // ==========================================
        // 4. INTERFAZ DE USUARIO (RENDERIZADO)
        // ==========================================
        function actualizarUI() {
            // 1. Dashboard
            animarNumero('total-balance', AppState.balanceTotal, '€');
            animarNumero('month-expenses', AppState.gastosMes, '€');
            animarNumero('investment-total', AppState.inversiones, '€');

            // 2. Lista de Movimientos
            const lista = document.getElementById('lista-movimientos');
            lista.innerHTML = '';
            
            // Renderizamos solo los últimos 20 para rendimiento
            AppState.movimientos.slice(0, 20).forEach(mov => {
                const esGasto = mov.importe < 0;
                const color = esGasto ? 'var(--c-danger)' : 'var(--c-success)';
                const icono = obtenerIcono(mov.concepto);

                const html = `
                    <div class="card" style="padding: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="background: ${esGasto ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)'}; 
                                        color: ${color}; padding: 10px; border-radius: 50%;">
                                <span class="material-icons">${icono}</span>
                            </div>
                            <div>
                                <div style="font-weight: 600;">${mov.descripcion || mov.concepto}</div>
                                <div style="font-size: 0.8rem; color: var(--t-muted);">${mov.cuenta} • ${mov.fecha.toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div style="font-family: var(--font-num); font-weight: 600; color: ${color};">
                            ${mov.importe.toFixed(2)} €
                        </div>
                    </div>
                `;
                lista.insertAdjacentHTML('beforeend', html);
            });

            // 3. Rellenar Selectores de Cuentas (Para el Modal)
            const selectores = ['select-cuenta', 'select-cuenta-destino']; // Asumiendo que crearemos el destino dinámicamente o existe
            // Limpiamos y rellenamos el select principal
            const selectCuenta = document.getElementById('select-cuenta');
            selectCuenta.innerHTML = AppState.cuentas.map(c => 
                `<option value="${c.id}">${c.id} (${c.saldo.toFixed(2)}€)</option>`
            ).join('');
        }

        // ==========================================
        // 5. LÓGICA DE TRANSACCIONES (MODALES)
        // ==========================================
        let modoTransaccion = 'gasto'; // 'ingreso', 'gasto', 'traspaso'

        function abrirModal(tipo) {
            modoTransaccion = tipo;
            const modal = document.getElementById('modal-transaccion');
            const titulo = document.getElementById('modal-titulo');
            const form = document.getElementById('form-transaccion');
            const btnSubmit = form.querySelector('button[type="submit"]');

            // Resetear formulario
            form.reset();
            
            // Lógica visual específica (Tus colores y vibración)
            vibrar(); 

            // Gestión de campos para TRASPASO
            let campoDestino = document.getElementById('grupo-destino');
            // Si no existe el campo destino, lo creamos dinámicamente (mejor que tenerlo oculto siempre)
            if (!campoDestino) {
                const div = document.createElement('div');
                div.id = 'grupo-destino';
                div.className = 'form-group hidden';
                div.innerHTML = `
                    <label>Cuenta Destino (Para recibir)</label>
                    <select id="select-cuenta-destino"></select>
                `;
                // Insertar después del select de cuenta
                document.getElementById('select-cuenta').parentElement.after(div);
                
                // Rellenar opciones
                document.getElementById('select-cuenta-destino').innerHTML = 
                    AppState.cuentas.map(c => `<option value="${c.id}">${c.id}</option>`).join('');
                campoDestino = div;
            }

            const inputConcepto = document.getElementById('input-concepto');
            const labelCuenta = document.querySelector('label[for="select-cuenta"]') || document.getElementById('select-cuenta').previousElementSibling;

            if (tipo === 'traspaso') {
                titulo.innerText = "NUEVO TRASPASO";
                titulo.style.color = CONFIG.colores.traspaso;
                btnSubmit.style.background = CONFIG.colores.traspaso;
                
                // Mostrar destino, ocultar concepto
                campoDestino.classList.remove('hidden');
                inputConcepto.parentElement.classList.add('hidden');
                inputConcepto.value = "Traspaso"; // Valor por defecto
                
                labelCuenta.innerText = "Desde Cuenta (Origen)";

            } else {
                campoDestino.classList.add('hidden');
                inputConcepto.parentElement.classList.remove('hidden');
                labelCuenta.innerText = "Cuenta";
                
                if (tipo === 'ingreso') {
                    titulo.innerText = "NUEVO INGRESO";
                    titulo.style.color = CONFIG.colores.ingreso;
                    btnSubmit.style.background = CONFIG.colores.ingreso;
                } else {
                    titulo.innerText = "NUEVO GASTO";
                    titulo.style.color = CONFIG.colores.gasto;
                    btnSubmit.style.background = CONFIG.colores.gasto; // Rojo
                }
            }

            modal.style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modal-transaccion').style.display = 'none';
        }

        // Manejador del Formulario
        document.getElementById('form-transaccion').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const importeRaw = parseFloat(document.getElementById('input-importe').value);
            const cuentaOrigen = document.getElementById('select-cuenta').value;
            const concepto = document.getElementById('input-concepto').value;
            
            if (!importeRaw || isNaN(importeRaw)) {
                alert("Por favor, introduce un importe válido.");
                return;
            }

            // Preparar filas para Excel
            const nuevasFilas = [];
            const fechaStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            
            if (modoTransaccion === 'traspaso') {
                const cuentaDestino = document.getElementById('select-cuenta-destino').value;
                if (cuentaOrigen === cuentaDestino) {
                    alert("La cuenta origen y destino no pueden ser la misma.");
                    return;
                }
                
                // 1. Salida de dinero
                nuevasFilas.push({
                    FECHA: fechaStr,
                    CUENTA: cuentaOrigen,
                    CONCEPTO: 'Traspaso',
                    IMPORTE: -Math.abs(importeRaw),
                    DESCRIPCIÓN: 'Traspaso a ' + cuentaDestino,
                    BENEFICIARIO: AppState.usuario.name
                });
                
                // 2. Entrada de dinero
                nuevasFilas.push({
                    FECHA: fechaStr,
                    CUENTA: cuentaDestino,
                    CONCEPTO: 'Traspaso',
                    IMPORTE: Math.abs(importeRaw),
                    DESCRIPCIÓN: 'Traspaso desde ' + cuentaOrigen,
                    BENEFICIARIO: AppState.usuario.name
                });

            } else {
                // Ingreso o Gasto
                const importeFinal = modoTransaccion === 'gasto' ? -Math.abs(importeRaw) : Math.abs(importeRaw);
                nuevasFilas.push({
                    FECHA: fechaStr,
                    CUENTA: cuentaOrigen,
                    CONCEPTO: 'Varios', // Genérico, se podría mejorar
                    IMPORTE: importeFinal,
                    DESCRIPCIÓN: concepto,
                    BENEFICIARIO: AppState.usuario.name
                });
            }

            // GUARDAR
            await guardarEnExcel(nuevasFilas);
            cerrarModal();
        });

        // ==========================================
        // 6. GUARDADO SEGURO (MÉTODO EXPERTO)
        // ==========================================
        async function guardarEnExcel(nuevasFilas) {
            // Optimismo UI: Añadir localmente primero para sensación de velocidad
            nuevasFilas.forEach(f => {
                AppState.movimientos.unshift({
                    fecha: new Date(f.FECHA),
                    cuenta: f.CUENTA,
                    concepto: f.CONCEPTO,
                    importe: f.IMPORTE,
                    descripcion: f.DESCRIPCIÓN
                });
            });
            calcularSaldos();
            actualizarUI();

            // Proceso Real de Guardado (Append al Excel)
            // 1. Convertir AppState.movimientos (con los nuevos) a hoja de Excel
            // Nota: Para máxima seguridad, convertimos TODO el array de movimientos de vuelta,
            // así aseguramos que el historial se preserva.
            
            // Mapeo inverso para coincidir con columnas exactas del CSV
            const datosParaGuardar = AppState.movimientos.map(m => ({
                FECHA: m.fecha.toISOString().split('T')[0],
                CUENTA: m.cuenta,
                CONCEPTO: m.concepto,
                IMPORTE: m.importe,
                DESCRIPCIÓN: m.descripcion,
                BENEFICIARIO: m.beneficiario
            }));

            const nuevaHoja = XLSX.utils.json_to_sheet(datosParaGuardar);
            const workbook = AppState.ultimoWorkbook;
            workbook.Sheets[CONFIG.hojas.movimientos] = nuevaHoja;

            // 2. Generar binario
            const excelBinary = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });

            // 3. Subir a OneDrive
            try {
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    account: AppState.usuario,
                    scopes: CONFIG.auth.scopes
                });

                const graphUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${CONFIG.archivo}:/content`;
                
                await fetch(graphUrl, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${tokenResponse.accessToken}`,
                        'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    },
                    body: excelBinary
                });
                
                console.log("Guardado exitoso en la nube.");
                alert("Movimiento guardado y sincronizado correctamente.");

            } catch (error) {
                console.error("Error al guardar en la nube:", error);
                alert("Error crítico: No se pudo guardar en OneDrive. Descarga una copia local por seguridad.");
                XLSX.writeFile(workbook, "copia_seguridad_aidanai.xlsx");
            }
        }

        // ==========================================
        // UTILIDADES Y EFECTOS
        // ==========================================
        function mostrarCargando(estado) {
            // Implementar spinner si se desea
        }

        function vibrar() {
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function animarNumero(id, valorFinal, sufijo) {
            const el = document.getElementById(id);
            // Animación simple
            el.innerText = valorFinal.toLocaleString('es-ES', { minimumFractionDigits: 2 }) + ' ' + sufijo;
        }

        function obtenerIcono(concepto) {
            const c = concepto.toLowerCase();
            if (c.includes('comida') || c.includes('mercadona')) return 'restaurant';
            if (c.includes('combustible') || c.includes('gasolina')) return 'local_gas_station';
            if (c.includes('traspaso')) return 'sync_alt';
            if (c.includes('inicial')) return 'flag';
            return 'payments'; // Icono por defecto
        }

        // Inicializar
        window.addEventListener('load', initApp);
    	
    </script>
</body>
</html>