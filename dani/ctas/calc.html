<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/android-chrome-192x192.png">
    
    <meta name="theme-color" content="#000000">
    <meta name="description" content="aiDANaI Fusion Edition">
    <title>aiDANaI Calc</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
   <style>
    /* === CONFIGURACIÓN MAESTRA (ONEPLUS NORD 4) === */
    :root { 
        /* Áreas seguras para que no se corte nada por la cámara o barra de gestos */
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
        --header-height: 60px; 
        
        /* PALETA DE COLORES NEÓN (Igual que tu app principal) */
        --neon-red: #ff0033; 
        --neon-cyan: #00f2ff;
        --neon-lime: #ccff00;
        --neon-yellow: #ffff00;
        
        --crypto-up: #00ff9d;   /* Verde para subidas */
        --crypto-down: #ff0033; /* Rojo para bajadas */

        /* FONDOS AMOLED (Negro Puro para batería y contraste) */
        --bg-body: #000000;
        --chassis-bg: #000000; 
        --chassis-border: 1px solid #1a1a1a;
        
        /* PANTALLA DE LA CALCULADORA */
        --screen-bg: #000000;
        --screen-border: 1px solid rgba(255, 255, 255, 0.1);
        --screen-glow: none; /* Quitamos glow excesivo para limpieza visual */
        
        --primary-text: #ffffff;
        --secondary-text: #888;
        --clock-text: var(--neon-cyan); /* Reloj en azul cian */
        
        /* COLORES DE BOTONES (Estilo Vidrio Oscuro) */
        --btn-bg: #111111; 
        --btn-border: 1px solid #333;
        --btn-text: #ffffff;
        
        --accent-blue-text: var(--neon-cyan);
        --accent-red-text: var(--neon-red);
        /* Botón ENTER Verde Radiante */
        --accent-green-bg: linear-gradient(135deg, #00FF9D 0%, #00cc7a 100%);
        
        /* TARJETAS CRYPTO */
        --card-bg: #111111;
        --card-border: 1px solid #333;
    }

    /* === BASE DEL CUERPO === */
    body { 
        overscroll-behavior: none; 
        touch-action: none; 
        background: var(--bg-body);
        /* 100dvh es la altura REAL de la pantalla móvil descartando barras del navegador */
        height: 100dvh; 
        width: 100vw; 
        font-family: 'Lexend', sans-serif; 
        overflow: hidden; 
        margin: 0; padding: 0;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    } 
    
    /* Scroll suave en listas */
    #history-list, .crypto-content { 
        overscroll-behavior: contain; 
        touch-action: pan-y; 
    }

    * { box-sizing: border-box; }
    
    /* Quitar borde azul al pulsar */
    :focus:not(:focus-visible) { outline: none; }

    /* Números Tabulares (Para que no bailen al cambiar cifras) */
    .tabular-nums { font-variant-numeric: tabular-nums; letter-spacing: -0.5px; }
    
    .small-decimal { font-size: 0.6em; vertical-align: top; margin-top: 0.3em; opacity: 0.7; font-weight: 500; }

    /* === ANIMACIONES (Efectos visuales suaves) === */
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes superFlash { 
        0% { background-color: rgba(255, 255, 255, 0); } 
        10% { background-color: rgba(255, 255, 255, 0.1); } 
        100% { background-color: rgba(255, 255, 255, 0); } 
    }
    .super-flash-active { animation: superFlash 0.3s ease-out; }
    
    @keyframes particleExplosion { 
        0% { opacity: 1; transform: translate(0,0) scale(1); } 
        100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); } 
    }

    /* === ESTRUCTURA DE VISTAS (Calculadora vs Crypto) === */
    .view-container { 
        width: 100%; height: 100%; 
        position: relative; overflow: hidden; 
        display: flex; flex-direction: column; 
    }
    
    .view { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        display: flex; flex-direction: column; 
        opacity: 0; pointer-events: none; transform: scale(0.95); 
        transition: opacity 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.3s; 
    }
    .view.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 10; }
    
    /* Fondo sutil de puntos para dar textura técnica */
    .optimized-bg {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
        background-color: #000000;
        background-image: radial-gradient(#222 1px, transparent 1px);
        background-size: 20px 20px;
        opacity: 0.5;
    }

    /* Capa de partículas para efectos especiales */
    .particles-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; overflow: hidden; }
    .particle { position: absolute; pointer-events: none; z-index: 1000; border-radius: 50%; }

    /* === CABECERA (HEADER) === */
    .app-header { 
        flex: 0 0 auto; /* No se estira */
        display: flex; align-items: center; justify-content: space-between; 
        /* Padding inteligente: respeta el 'notch' de la cámara */
        padding: max(var(--safe-top), 15px) 20px 10px; 
        z-index: 20; gap: 10px; width: 100%; 
    }
    
    /* Botones e indicadores de la cabecera */
    .embedded-ui { 
        background: #111; 
        border-radius: 12px; 
        display: flex; align-items: center; justify-content: center; 
        border: 1px solid #333; 
        transition: all 0.2s; flex-shrink: 0; position: relative; 
    }

    .icon-btn { 
        width: 44px; height: 44px; cursor: pointer; color: #888; 
    }
    .icon-btn:active { transform: scale(0.92); background: #222; }
    
    /* Icono de intercambio de sonido */
    .icon-swap svg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: opacity 0.2s, transform 0.2s; }
    .icon-swap .hidden { opacity: 0; transform: translate(-50%, -40%); }
    .icon-swap .shown { opacity: 1; transform: translate(-50%, -50%); }

    /* Colores específicos de botones header */
    #btn-mute { color: var(--neon-cyan) !important; }
    #btn-go-crypto { color: var(--crypto-up) !important; border-color: rgba(0, 255, 157, 0.3); }
    #btn-go-calc { color: #ff00ff !important; border-color: rgba(255, 0, 255, 0.3); }

    .app-title { 
        font-weight: 800; font-size: 1.1rem; color: #fff; 
        flex-grow: 1; text-align: center; height: 44px; letter-spacing: 1px;
        background: transparent; border: none; /* Título limpio */
    }
    
    #clock, #clock-crypto { 
        font-weight: 600; font-size: 0.85rem; color: var(--clock-text); 
        padding: 0 12px; min-width: 80px; text-align: center; height: 44px; 
    }

    /* === SECCIÓN SUPERIOR: PANTALLA (DISPLAY) === */
    .upper-section { 
        flex: 1; /* CAMBIO: Ocupa todo el espacio libre disponible */
        min-height: 0; /* CAMBIO CLAVE: Permite que el contenedor se encoja para activar el scroll */
        display: flex; flex-direction: column; 
        padding: 10px 20px; 
        justify-content: flex-end; 
    }
    
    .display-lens { 
        width: 100%; flex: 1; 
        background: transparent; /* Sin fondo para integrarse */
        display: flex; flex-direction: column; padding: 10px 0; 
        position: relative; overflow: hidden; 
    }    
    
    /* Lista de historial */
    #history-list { 
        flex: 1; overflow-y: auto; padding: 5px; 
        display: flex; flex-direction: column-reverse; /* Lo nuevo abajo */
        list-style: none; gap: 4px; 
        mask-image: linear-gradient(to top, black 80%, transparent 100%); /* Desvanecido suave */
        scrollbar-width: none; 
    }
    #history-list li { 
        display: flex; justify-content: flex-end; align-items: center; gap: 8px;
        text-align: right; cursor: pointer; 
        opacity: 0.5; 
        font-size: 1.2rem; 
        color: var(--neon-cyan); 
        padding: 4px 0;
        transition: opacity 0.2s; 
    }
    #history-list li:hover { opacity: 1; }
    #history-list b { color: var(--crypto-up); font-weight: 600; margin-left: 8px; }

    /* Área principal de números */
    .display-area { 
        flex-shrink: 0; text-align: right; 
        padding-top: 10px; display: flex; flex-direction: column; 
        justify-content: flex-end; z-index: 2; width: 100%; 
    }
    
    #secondary-display { 
        color: #888; font-size: 1.2rem; 
        min-height: 1.5rem; margin-bottom: 5px; opacity: 0; transition: opacity 0.2s; 
    }
    #secondary-display.visible { opacity: 1; }
    
    #main-display { 
        color: var(--primary-text); 
        font-size: 4rem; /* Números GRANDES */
        font-weight: 500;
        line-height: 1.1; 
        width: 100%; text-align: right; 
        word-break: break-all;       
        text-shadow: 0 0 20px rgba(255,255,255,0.1); 
    }
    /* Animación pop al calcular */
    @keyframes popScale { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    .pop-active { animation: popScale 0.15s ease-out; }

    /* === SECCIÓN INFERIOR: TECLADO (BODY) === */
    .calculator-body { 
        flex: 0 0 50%; /* EL CAMBIO: Teclado fijo como una roca al 60% de la altura */
        width: 100%; 
        background: var(--chassis-bg); 
        border-top: 1px solid #222; 
        border-radius: 30px 30px 0 0; 
        z-index: 10; 
        padding: 20px; 
        padding-bottom: max(20px, var(--safe-bottom)); 
        box-shadow: 0 -10px 30px rgba(0,0,0,0.5); 
        display: flex; flex-direction: column; 
    }
    
    .keypad { 
        flex: 1; width: 100%; 
        display: grid; 
        grid-template-columns: repeat(4, 1fr); 
        grid-template-rows: repeat(5, 1fr); 
        gap: 12px; /* Espacio entre botones */
    }

    /* ESTILO DE LOS BOTONES: DISEÑO "3D TITANIUM FÍSICO" */
    .btn { 
        /* 1. EL CUERPO DE LA TECLA (Degradado metálico) */
        background: linear-gradient(to bottom, #3d3d3d 0%, #252525 100%);
        color: #f0f0f0;
        border: none;
        border-radius: 18px; /* Bordes redondeados pero robustos */

        /* 2. LA MAGIA 3D (Sombra sólida abajo = Grosor) */
        box-shadow: 
            0 6px 0 #000000,              /* El "culo" de la tecla (grosor físico) */
            0 12px 10px rgba(0,0,0,0.5),  /* Sombra en el suelo */
            inset 0 1px 0 rgba(255,255,255,0.3); /* Brillo en el borde superior (filo de luz) */

        font-family: 'Lexend', sans-serif; 
        cursor: pointer; 
        display: flex; align-items: center; justify-content: center; 
        width: 100%; height: 90%; /* Un poco menos de altura para dejar sitio a la sombra */
        
        font-size: 2rem; 
        font-weight: 600; 
        text-shadow: 0 -1px 1px rgba(0,0,0,0.8); /* Texto grabado/hundido */
        
        position: relative; 
        transition: all 0.1s cubic-bezier(0.4, 0, 1, 1); /* Movimiento mecánico seco */
    }
    
    /* 3. EFECTO DE PULSACIÓN (Hundir la tecla) */
    .btn:active, .btn.btn-active { 
        transform: translateY(6px); /* Bajamos la tecla 6 píxeles */
        box-shadow: 
            0 0 0 #000000,            /* El grosor desaparece */
            inset 0 4px 8px rgba(0,0,0,0.6); /* Sombra interna (hundido) */
        background: linear-gradient(to bottom, #252525 0%, #1a1a1a 100%);
    }

    /* --- COLORES PERSONALIZADOS (Materiales diferentes) --- */

    /* 1. Botones de Borrado (Plástico ROJO mate) */
    .btn[data-key="AC"], .btn[data-key="Backspace"] { 
        background: linear-gradient(to bottom, #ff3333 0%, #cc0000 100%);
        box-shadow: 0 6px 0 #800000, 0 12px 10px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.3);
        color: white;
    }
    .btn[data-key="AC"]:active, .btn[data-key="Backspace"]:active {
        box-shadow: 0 0 0 #800000, inset 0 4px 8px rgba(0,0,0,0.4);
    }

    /* 2. Operaciones (Metal AZULADO CIAN) */
    .token-op, .btn[data-color="blue"] { 
        color: #00f2ff;
        background: linear-gradient(to bottom, #2a3a40 0%, #152025 100%);
        font-size: 2.2rem;
    }

    /* 3. Botón IGUAL (Cristal VERDE LUMINOSO) */
    .btn.btn-large { 
        grid-column: span 2; 
        /* Degradado verde intenso */
        background: linear-gradient(to bottom, #00ff9d 0%, #00b36b 100%);
        color: #004d2e; /* Texto verde oscuro para contraste */
        
        /* Sombra verde oscura */
        box-shadow: 
            0 6px 0 #00663d, 
            0 15px 20px rgba(0, 255, 157, 0.2), 
            inset 0 1px 0 rgba(255,255,255,0.4);
            
        font-weight: 800; 
        font-size: 2.5rem;
        text-shadow: none;
    }
    .btn.btn-large:active { 
        transform: translateY(6px);
        box-shadow: 0 0 0 #00663d, inset 0 4px 10px rgba(0,0,0,0.3);
    }

    /* === VISTA CRYPTO === */
    .crypto-content { 
        flex: 1; padding: 20px; 
        padding-bottom: max(20px, var(--safe-bottom)); 
        display: flex; flex-direction: column; overflow-y: auto; 
    }
    
    #timestamp { 
        text-align: center; color: #666; font-size: 0.8rem; margin-bottom: 15px; 
        display: flex; justify-content: center; align-items: center; gap: 6px; 
    }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background-color: #444; }
    .status-dot.online { background-color: var(--neon-cyan); box-shadow: 0 0 6px var(--neon-cyan); }

   /* --- LISTA COMPACTA --- */
    .crypto-list { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        min-height: 0; 
        
        /* CAMBIO: De 15px a 6px para que estén juntitas */
        gap: 6px; 
        
        overflow-y: auto; 
        scrollbar-width: none; 
    }

   /* --- TARJETA SLIM (Compacta) --- */
    .card { 
        background: var(--card-bg); 
        border: var(--card-border); 
        border-radius: 16px; /* Un poco menos redonda para ahorrar espacio */
        
        /* CAMBIO: Menos relleno (arriba/abajo 8px, lados 14px) */
        padding: 8px 14px; 
        
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        cursor: pointer; 
        position: relative; 
        overflow: hidden; 
        backdrop-filter: blur(10px); 
        -webkit-backdrop-filter: blur(10px); 
        transition: transform 0.2s; 
        
        /* CAMBIO: Altura mínima reducida drásticamente (de 70px a 50px) */
        min-height: 50px; 
        
        flex: 1; /* Esto hace que se estiren para llenar el hueco equitativamente */
        will-change: transform;
    }
    .card:active { transform: scale(0.98); background: #222; }
    
    .coin-details { display: flex; align-items: center; gap: 12px; }
    .coin-logo { width: 36px; height: 36px; border-radius: 50%; }
    
    .coin-info h2 { font-size: 1rem; margin: 0; color: #fff; font-weight: 600; }
    
    .change-percentage { font-size: 0.8rem; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
    .change-positive { color: var(--crypto-up); background: rgba(0, 255, 157, 0.1); }
    .change-negative { color: var(--crypto-down); background: rgba(255, 0, 51, 0.1); }
    
    .price-eur { font-size: 1.1rem; font-weight: 600; color: #fff; text-align: right; }
    .price-usd { font-size: 0.8rem; color: #666; text-align: right; }

    /* === MODAL DE GRÁFICO === */
    #chart-modal { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); 
        z-index: 100; display: flex; align-items: center; justify-content: center; 
        opacity: 0; pointer-events: none; transition: 0.2s; padding: 20px; 
    }
    #chart-modal.visible { opacity: 1; pointer-events: auto; }
    
    .modal-content { 
        width: 100%; max-width: 400px; 
        background: #111; border: 1px solid #333; 
        border-radius: 30px; padding: 25px; 
        transform: scale(0.95); transition: 0.2s; 
    }
    #chart-modal.visible .modal-content { transform: scale(1); }
    
    .chart-controls { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; background: #222; padding: 4px; border-radius: 12px; }
    .time-btn { background: transparent; border: none; color: #888; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; flex: 1; }
    .time-btn.active { background: #444; color: white; }
    
    .close-chart { 
        position: absolute; top: 15px; right: 15px; 
        background: none; border: none; font-size: 1.5rem; color: #888; padding: 10px; 
    }

    /* TOAST (Notificaciones) */
    .toast { 
        position: fixed; top: 90px; left: 50%; transform: translate(-50%, -20px); 
        background: #222; border: 1px solid var(--neon-cyan); 
        color: var(--neon-cyan); padding: 10px 24px; border-radius: 30px; 
        opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200; font-weight: 600;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
    .toast.show { opacity: 1; transform: translate(-50%, 0); }
	/* --- MODO PC: SIMULADOR ONEPLUS NORD 4 --- */
    @media(min-width: 600px) {
        body { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background-color: #050505;
            background-image: 
                radial-gradient(#1a1a1a 1px, transparent 1px),
                radial-gradient(#1a1a1a 1px, transparent 1px);
            background-position: 0 0, 25px 25px;
            background-size: 50px 50px;
        }
        
        .view-container { 
            /* Medidas exactas del Nord 4 */
            width: 100%;
            max-width: 412px;  
            height: 915px;     
            max-height: 95vh;  
            
            /* Diseño del marco del móvil */
            border-radius: 32px; 
            border: 8px solid #111; 
            box-shadow: 
                0 0 0 2px #333,
                0 30px 60px rgba(0,0,0,0.8), 
                0 0 50px rgba(0, 242, 255, 0.1);
            
            overflow: hidden; 
            position: relative;
        }
        
        .optimized-bg { 
            border-radius: 32px; 
        }
    }
</style>
</head>
<body data-theme="dark">

    <div class="optimized-bg"></div>
    <div id="particles-layer" class="particles-layer"></div>
        
    <div class="view-container">
        <div id="view-calculator" class="view active">
            <header class="app-header">
                <button class="embedded-ui icon-btn icon-swap" id="btn-mute" aria-label="Silenciar">
                    <svg class="shown" id="icon-sound-on" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    <svg class="hidden" id="icon-sound-off" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
                </button>
                               
                <div class="app-title embedded-ui" style="color: var(--neon-red) !important; text-shadow: 0 0 15px rgba(255, 0, 51, 0.6); font-size: 1.3rem;">aiDANaI ctas</div>
                
                <div id="clock" class="embedded-ui tabular-nums">0:00:00</div>
                
                <button id="btn-go-crypto" class="embedded-ui icon-btn" aria-label="Ir a Crypto">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                </button>
            </header>
        
            <div class="upper-section">
                <div class="display-lens" id="display-container">
                    <ul id="history-list"></ul>
                    <div class="display-area">
                        <div id="secondary-display" class="tabular-nums"></div>
                        <div style="display:flex; flex-direction:column; justify-content:flex-end;">
                            <div id="main-display" class="tabular-nums">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="calculator-body">
                <div class="keypad">
                    <button class="btn" data-key="AC">AC</button>
                    <button class="btn" data-key="Backspace">⌫</button>
                    <button class="btn" data-key="%" data-color="blue">%</button>
                    <button class="btn" data-key="/" data-color="blue">÷</button>
             
                    <button class="btn" data-key="7">7</button>
                    <button class="btn" data-key="8">8</button>
                    <button class="btn" data-key="9">9</button>
                    <button class="btn" data-key="*" data-color="blue">×</button>
             
                    <button class="btn" data-key="4">4</button>
                    <button class="btn" data-key="5">5</button>
                    <button class="btn" data-key="6">6</button>
                    <button class="btn" data-key="-" data-color="blue">−</button>
  
                    <button class="btn" data-key="1">1</button>
                    <button class="btn" data-key="2">2</button>
                    <button class="btn" data-key="3">3</button>
                    <button class="btn" data-key="+" data-color="blue">+</button>

                    <button class="btn" data-key="0">0</button>
                    <button class="btn" data-key=",">,</button>
                    <button class="btn btn-large" data-key="Enter" data-color="green">=</button>
                </div>
            </div>
        </div>

        <div id="view-crypto" class="view">
            <header class="app-header">
                <a href="https://danijdzg.github.io/dani/" target="_blank" class="embedded-ui icon-btn" aria-label="Web">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                </a>
                
                <div class="app-title embedded-ui" style="color:#ff0033 !important;">Crypto</div>
                
                <div id="clock-crypto" class="embedded-ui tabular-nums">0:00:00</div>
                <button id="btn-go-calc" class="embedded-ui icon-btn" aria-label="Volver">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2" stroke-width="2"></rect><line x1="8" y1="6" x2="16" y2="6" stroke-width="2"></line><line x1="16" y1="14" x2="16" y2="14" stroke-width="3"></line><line x1="12" y1="14" x2="12" y2="14" stroke-width="3"></line><line x1="8" y1="14" x2="8" y2="14" stroke-width="3"></line><line x1="16" y1="18" x2="16" y2="18" stroke-width="3"></line><line x1="12" y1="18" x2="12" y2="18" stroke-width="3"></line><line x1="8" y1="18" x2="8" y2="18" stroke-width="3"></line></svg>
                </button>
            </header>
            
            <div class="crypto-content">
                <p id="timestamp"><span class="status-dot"></span> <span id="time-text">Conectando...</span></p>
                <div class="crypto-list">
                    <div class="card glow-border" data-id="bitcoin" data-name="Bitcoin">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/1/large/bitcoin.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>Bitcoin</h2><p class="change-percentage tabular-nums" id="bitcoin-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="bitcoin-price-eur">--</p><p class="price-usd tabular-nums" id="bitcoin-price-usd">--</p></div>
                    </div>
                    <div class="card glow-border" data-id="ethereum" data-name="Ethereum">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/279/large/ethereum.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>Ethereum</h2><p class="change-percentage tabular-nums" id="ethereum-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="ethereum-price-eur">--</p><p class="price-usd tabular-nums" id="ethereum-price-usd">--</p></div>
                    </div>
					<div class="card glow-border" data-id="binancecoin" data-name="BNB">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>BNB</h2><p class="change-percentage tabular-nums" id="binancecoin-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="binancecoin-price-eur">--</p><p class="price-usd tabular-nums" id="binancecoin-price-usd">--</p></div>
                    </div>
                     <div class="card glow-border" data-id="solana" data-name="Solana">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/4128/large/solana.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>Solana</h2><p class="change-percentage tabular-nums" id="solana-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="solana-price-eur">--</p><p class="price-usd tabular-nums" id="solana-price-usd">--</p></div>
                    </div>
                     <div class="card glow-border" data-id="ripple" data-name="XRP">
                        <div class="coin-details">
                             <img src="https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>XRP</h2><p class="change-percentage tabular-nums" id="ripple-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="ripple-price-eur">--</p><p class="price-usd tabular-nums" id="ripple-price-usd">--</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chart-modal">
        <div class="modal-content">
            <button class="close-chart">&times;</button>
            <h2 id="chart-title" style="margin-bottom:15px; color:white; text-align: center;">Moneda</h2>
            
            <div class="chart-controls">
                <button class="time-btn" data-days="1">24h</button>
                <button class="time-btn" data-days="7">7D</button>
                <button class="time-btn active" data-days="30">30D</button>
                <button class="time-btn" data-days="365">1A</button>
            </div>

            <div style="min-height: 250px;"><div id="chart-container"></div></div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
    const App = {
        expr: '',
        fresh: true,
        chart: null,
        currentCoinId: null,
        
        audioCtx: null,
        audioEnabled: false,
        
        state: { 
            muted: false, 
            history: [], 
            cryptoCache: null, 
            lastFetchTime: 0 
        },
        
        init() {
            this.loadState();
            this.updateMuteIcon();
            this.fixHeight();
            this.bindEvents();
            this.startClocks();
            this.renderHistory(); 
            this.initAudio();
            this.unlockAudio();
            
            if ('serviceWorker' in navigator && !window.location.href.startsWith('blob:')) {
    navigator.serviceWorker.register('./service-worker.js').catch(() => {});
}

            if(this.state.cryptoCache) {
                const now = Date.now();
                if(now - this.state.lastFetchTime < 300000) this.renderCryptoData(this.state.cryptoCache);
                else this.fetchPrices();
            }
        },

        fixHeight() {
            const setH = () => document.documentElement.style.setProperty('--doc-height', `${window.innerHeight}px`);
            setH(); window.addEventListener('resize', setH);
        },

        initAudio() {
            try {
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                this.audioEnabled = true;
            } catch(e) { this.audioEnabled = false; }
        },

        unlockAudio() {
            const unlockHandler = () => {
                if (this.audioCtx && this.audioCtx.state === 'suspended') {
                    this.audioCtx.resume();
                }
            };
            document.addEventListener('click', unlockHandler, { once: true });
            document.addEventListener('touchstart', unlockHandler, { once: true });
            document.addEventListener('keydown', unlockHandler, { once: true });
        },

        playKeySound(key) {
            if(this.state.muted || !this.audioEnabled || !this.audioCtx) return;
            
            let freq = 600; 
            let duration = 0.1;
            
            if (key === 'Enter') {
                freq = 800; duration = 0.15;
            } else if (key === 'AC' || key === 'Backspace') {
                freq = 400; duration = 0.08;
            } else if (['+', '-', '*', '/', '%'].includes(key)) {
                freq = 700;
            } else if (key === ',') {
                freq = 550;
            }
            
            this.playTone(freq, duration);
        },

        playTone(freq, duration = 0.1) {
            if(this.state.muted || !this.audioEnabled || !this.audioCtx) return;
            if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
            
            try {
                const o = this.audioCtx.createOscillator();
                const g = this.audioCtx.createGain();
                o.connect(g);
                g.connect(this.audioCtx.destination);
                o.type = 'triangle'; 
                o.frequency.value = freq;
                
                g.gain.setValueAtTime(0.05, this.audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + duration);
                
                o.start();
                o.stop(this.audioCtx.currentTime + duration);
            } catch(e) {}
        },

        bindEvents() {
            document.getElementById('btn-go-crypto').onclick = () => { 
                document.getElementById('view-calculator').classList.remove('active');
                document.getElementById('view-crypto').classList.add('active');
                if(Date.now() - this.state.lastFetchTime > 60000) this.fetchPrices();
            };
            document.getElementById('btn-go-calc').onclick = () => { 
                document.getElementById('view-crypto').classList.remove('active');
                document.getElementById('view-calculator').classList.add('active');
            };
            document.getElementById('btn-mute').onclick = () => this.toggleMute();

            document.querySelectorAll('.btn[data-key]').forEach(b => {
                const key = b.dataset.key;
                const handlePress = (e) => {
                    if(e.cancelable) e.preventDefault();
                    b.classList.add('btn-active');
                    setTimeout(() => b.classList.remove('btn-active'), 80);
                    
                    this.playKeySound(key); 
                    this.processKey(key);
                };
                b.addEventListener('pointerdown', handlePress);
            });

            document.addEventListener('keydown', (e) => {
                const keyMap = { 'Enter': 'Enter', 'Backspace': 'Backspace', 'Delete': 'AC', 'Escape': 'AC', '+': '+', '-': '-', '*': '*', '/': '/', '.': ',', ',': ',', '%': '%' };
                if (e.key >= '0' && e.key <= '9') { 
                    this.triggerKeyVisual(e.key); 
                    this.playKeySound(e.key); 
                    this.processKey(e.key); 
                    return; 
                }
                const mapped = keyMap[e.key];
                if (mapped) { 
                    e.preventDefault(); 
                    this.triggerKeyVisual(mapped === ',' ? ',' : mapped); 
                    this.playKeySound(mapped); 
                    this.processKey(mapped); 
                } 
                else if (e.key === '=') { 
                    e.preventDefault(); 
                    this.triggerKeyVisual('Enter'); 
                    this.playKeySound('Enter'); 
                    this.processKey('Enter'); 
                }
            });

            document.querySelectorAll('.card').forEach(c => {
                c.onclick = () => this.openChart(c.dataset.id, c.dataset.name);
            });
            document.querySelector('.close-chart').onclick = () => document.getElementById('chart-modal').classList.remove('visible');
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.onclick = (e) => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.updateChartData(e.target.dataset.days);
                }
            });
        },

        triggerKeyVisual(key) {
            const btn = document.querySelector(`.btn[data-key="${key}"]`);
            if (btn) { btn.classList.add('btn-active'); setTimeout(() => btn.classList.remove('btn-active'), 80); }
        },

      processKey(key) {
            if(navigator.vibrate) navigator.vibrate(key === 'Enter' ? 15 : 5);
            
            if (key === 'AC') this.clearAll();
            else if (key === 'Backspace') { this.expr = this.expr.toString().slice(0, -1); this.render(); }
            else if (key === 'Enter') { 
                // --- INICIO: LÓGICA DOBLE CLIC PARA ENVIAR ---
                const now = Date.now();
                // Si pulsas igual 2 veces en menos de 400ms (rápido)
                if (this.lastEnterTime && (now - this.lastEnterTime < 400)) {
                    this.calculate(); // Aseguramos que el cálculo esté hecho
                    
                    // ENVIAR MENSAJE A LA APP PRINCIPAL
                    // Enviamos el valor actual (this.expr) limpio
                    window.parent.postMessage({ 
                        type: 'CALCULATOR_RESULT', 
                        value: this.expr 
                    }, '*');
                    
                    this.lastEnterTime = 0; // Reseteamos
                    return;
                }
                this.lastEnterTime = now;
                // --- FIN LÓGICA DOBLE CLIC ---

                this.calculate(); 
            } 
            else if (key === '%') { 
				if(this.expr) { 
					try {
						let clean = this.expr.replace(/[^0-9+\-*/().]/g, '');
						let res = new Function('return ' + clean)() / 100;
						this.expr = String(parseFloat(res.toPrecision(12))); 
					this.render(); 
				} catch(e) {}
			} 
}
            else { this.handleInput(key); }
        },

        handleInput(k) {
            if(this.fresh) {
                if(!"+-*/%".includes(k)) { this.expr=''; document.getElementById('secondary-display').classList.remove('visible'); }
                this.fresh = false;
            }
            
            const last = this.expr.slice(-1);
            if (k === ',') k = '.';
            
            const isOp = "+-*/".includes(k);
            const lastIsOp = "+-*/".includes(last);

            if (isOp && lastIsOp) {
                this.expr = this.expr.slice(0, -1) + k;
            } 
            else if (k === '.') {
                const parts = this.expr.split(/[\+\-\*\/]/); 
                if (!parts[parts.length-1].includes('.')) this.expr += k;
            } 
            else {
                this.expr += k; 
            }
            this.render();
        },

        // MEJORA 2: Redondeo inteligente y limpieza de decimales excesivos
        calculate() {
            if(!this.expr) return;
            try {
                // 1. Sanitización
                let clean = this.expr.replace(/[^0-9+\-*/().]/g, '');
                // 2. Ejecución segura
                let res = new Function('return ' + clean)();
                
                // 3. Validación
                if(!isFinite(res) || isNaN(res)) throw new Error("Err");
                
                // toPrecision(12) es el estándar que elimina errores como 0.1 + 0.2 = 0.30000000000000004
				res = parseFloat(res.toPrecision(12));
                
                this.addToHistory(this.expr, res);
                const prettyExpr = this.expr.replace(/\./g, ',').replace(/\*/g, '×').replace(/\//g, '÷');
                document.getElementById('secondary-display').innerText = prettyExpr + ' =';
                document.getElementById('secondary-display').classList.add('visible');
                
                this.expr = String(res); 
                this.fresh = true;
                this.render(true); 
                this.triggerSuperNova(); 
                
            } catch(e) { this.showToast("Error"); }
        },

        render(isResult = false) {
            const d = document.getElementById('main-display');
            if(!this.expr) { d.innerHTML = '0'; d.style.fontSize = '3.5rem'; return; }
            
            let html = '';
            const parts = this.expr.split(/([+\-*/])/);
            
            parts.forEach(part => {
                if ("+-*/".includes(part)) {
                    html += `<span style="color:var(--neon-cyan)">${part.replace('*','×').replace('/','÷')}</span>`;
                } else if (!isNaN(parseFloat(part))) {
                    let [int, dec] = part.split('.');
                    let formattedInt = int.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    
                    if (dec !== undefined) {
                        html += `${formattedInt}<span class="small-decimal">,${dec}</span>`;
                    } else {
                        html += formattedInt;
                    }
                } else {
                    html += part;
                }
            });

            d.innerHTML = html;
            this.adjustFontSize(d);
        },

        // Ajuste de fuente (Binario - Optimizado)
        adjustFontSize(el) {
            if (el.textContent.length < 6) { 
                el.style.fontSize = '3.5rem'; 
                return; 
            }

            let min = 1.4;
            let max = 3.5;
            let optimal = min;
            const maxHeight = 140; 

            while (max - min > 0.1) {
                const mid = (min + max) / 2;
                el.style.fontSize = `${mid}rem`;
                
                if (el.scrollHeight > maxHeight) {
                    max = mid; 
                } else {
                    optimal = mid; 
                    min = mid;
                }
            }
            el.style.fontSize = `${optimal}rem`;
        },

        triggerSuperNova() {
            const lens = document.getElementById('display-container');
            lens.classList.remove('super-flash-active');
            void lens.offsetWidth;
            lens.classList.add('super-flash-active');
            
            const mainD = document.getElementById('main-display');
            mainD.classList.remove('pop-active');
            void mainD.offsetWidth;
            mainD.classList.add('pop-active');
            
            this.createExplosionParticles();
        },

        createExplosionParticles() {
            const container = document.getElementById('particles-layer');
            const rect = document.querySelector('.btn[data-key="Enter"]').getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const frag = document.createDocumentFragment();

            for(let i=0; i<15; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const size = Math.random() * 6 + 3;
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 150 + 50;
                p.style.cssText = `width: ${size}px; height: ${size}px; background: ${Math.random()>0.5 ? '#ccff00' : '#fff'}; left: ${centerX}px; top: ${centerY}px; box-shadow: 0 0 10px #ccff00; --tx: ${Math.cos(angle) * dist}px; --ty: ${Math.sin(angle) * dist}px; animation: particleExplosion 0.5s ease-out forwards;`;
                frag.appendChild(p);
                setTimeout(() => p.remove(), 550);
            }
            container.appendChild(frag);
        },

        addToHistory(ex, r) {
            this.state.history.unshift({ expr: ex, res: r }); 
            if (this.state.history.length > 20) this.state.history.pop(); 
            this.saveState();
            this.renderHistory(); 
        },

        renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = this.state.history.map((item, index) => {
                const resF = item.res.toLocaleString('es-ES', { maximumFractionDigits: 10 });
                const safeExpr = item.expr.replace(/"/g, '&quot;');
                const prettyExpr = item.expr.replace(/\./g, ',').replace(/\*/g,'×').replace(/\//g,'÷');
                
                return `
                    <li>
                        <span class="hist-expr" onclick="App.handleHistoryClick(${index}, 'expr')" title="Recuperar operación">${prettyExpr}</span> 
                        <span>=</span> 
                        <span class="hist-res" onclick="App.handleHistoryClick(${index}, 'res')" title="Usar resultado">${resF}</span>
                    </li>`;
            }).join('');
        },

        handleHistoryClick(index, type) {
            const item = this.state.history[index];
            if (!item) return;

            if (type === 'expr') {
                this.expr = String(item.expr);
                this.showToast("Operación recuperada");
            } else {
                this.expr = String(item.res);
                this.showToast("Resultado recuperado");
            }
            
            this.fresh = true; 
            this.render(true);
            
            if(this.audioEnabled && !this.state.muted) this.playTone(600, 0.05);
        },
        
        clearAll() { 
            this.expr = ''; 
            this.fresh = true;
            this.state.history = []; 
            const sec = document.getElementById('secondary-display');
            sec.classList.remove('visible'); 
            sec.innerText = '';              
            this.saveState(); 
            this.renderHistory(); 
            this.render(); 
        },

        async fetchPrices() {
            const timeText = document.getElementById('time-text');
            const statusDot = document.querySelector('.status-dot');
            
            const now = Date.now();
            const CACHE_DURATION = 60000; 
            
            if (this.state.cryptoCache && (now - this.state.lastFetchTime < CACHE_DURATION)) {
                this.renderCryptoData(this.state.cryptoCache);
                this.updateStatusUI('cached');
                return;
            }

            try {
                timeText.innerText = 'Actualizando...';
                statusDot.className = 'status-dot'; 
                
                const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,ripple,binancecoin&vs_currencies=eur,usd&include_24hr_change=true');
                
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const d = await res.json();
                
                this.state.cryptoCache = d;
                this.state.lastFetchTime = Date.now();
                this.saveState();
                
                this.renderCryptoData(d);
                this.updateStatusUI('online');
                
            } catch(e) {
                console.warn("API Error:", e);
                if (this.state.cryptoCache) {
                    this.renderCryptoData(this.state.cryptoCache);
                    this.updateStatusUI('offline-cached');
                    this.showToast("Sin conexión: Usando caché");
                } else {
                    document.getElementById('timestamp').innerHTML = '<span class="status-dot error"></span> Error Conexión';
                }
            }
        },

        updateStatusUI(status) {
            const ts = document.getElementById('timestamp');
            const time = new Date(this.state.lastFetchTime || Date.now()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            if (status === 'online') {
                ts.innerHTML = `<span class="status-dot online"></span> Act. ${time}`;
            } else if (status === 'cached' || status === 'offline-cached') {
                ts.innerHTML = `<span class="status-dot warning"></span> Memoria (${time})`;
            }
        },

        renderCryptoData(d) {
            const fmt = (v, c) => new Intl.NumberFormat('es-ES', {style:'currency', currency:c}).format(v);
            ['bitcoin','ethereum','binancecoin','solana','ripple'].forEach(id => {
                if(d[id]) {
                    document.getElementById(`${id}-price-eur`).innerText = fmt(d[id].eur, 'EUR');
                    document.getElementById(`${id}-price-usd`).innerText = fmt(d[id].usd, 'USD');
                    const chg = d[id].eur_24h_change;
                    const el = document.getElementById(`${id}-change`);
                    el.innerText = (chg>0?'+':'') + chg.toFixed(2)+'%';
                    el.className = `change-percentage tabular-nums ${chg>=0?'change-positive':'change-negative'}`;
                }
            });
        },
        
        async openChart(id, name) {
            this.currentCoinId = id;
            document.getElementById('chart-title').innerText = name;
            document.getElementById('chart-modal').classList.add('visible');
            if(this.chart) { this.chart.destroy(); }
            
            this.chart = new ApexCharts(document.querySelector("#chart-container"), {
                series: [],
                chart: { type: 'area', height: 250, toolbar:{show:false}, background:'transparent', animations:{enabled:false} },
                theme: { mode: 'dark' },
                stroke: { curve: 'smooth', width: 2, colors:['#00f2ff'] },
                fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1 } },
                dataLabels: { enabled: false },
                xaxis: { type: 'datetime', labels: { show: false }, axisBorder:{show:false} },
                yaxis: { show: true, labels: { style:{ colors:'#888' }, formatter: (v) => v.toLocaleString('es-ES') + '€' } },
                grid: { borderColor: '#333', strokeDashArray: 5 },
                tooltip: { theme: 'dark' }
            });
            this.chart.render();
            this.updateChartData(30);
        },
        
        async updateChartData(days) {
            try {
                const res = await fetch(`https://api.coingecko.com/api/v3/coins/${this.currentCoinId}/market_chart?vs_currency=eur&days=${days}`);
                const data = await res.json();
                this.chart.updateSeries([{ name: 'Precio', data: data.prices }]);
            } catch(e) {}
        },

        toggleMute() { 
            this.state.muted = !this.state.muted; 
            this.updateMuteIcon(); 
            this.saveState(); 
            if(!this.state.muted) this.playTone(700, 0.1);
        },
        updateMuteIcon() { 
            const on = document.getElementById('icon-sound-on');
            const off = document.getElementById('icon-sound-off');
            if(this.state.muted) { on.classList.replace('shown', 'hidden'); off.classList.replace('hidden', 'shown'); } 
            else { off.classList.replace('shown', 'hidden'); on.classList.replace('hidden', 'shown'); }
        },
        showToast(msg) { const t = document.getElementById('toast'); t.innerText=msg; t.className='toast show'; setTimeout(()=>t.className='toast',2000); },
        saveState() { localStorage.setItem('aidanaiUltimateFusion', JSON.stringify(this.state)); },
        loadState() { try { const s = JSON.parse(localStorage.getItem('aidanaiUltimateFusion')); if(s) this.state = {...this.state, ...s}; } catch(e) {} },
        startClocks() { setInterval(() => { const s = new Date().toLocaleTimeString(); document.querySelectorAll('#clock, #clock-crypto').forEach(e => e.innerText = s); }, 1000); }
    };
    
    window.addEventListener('load', () => App.init());
    </script>
</body>
</html>