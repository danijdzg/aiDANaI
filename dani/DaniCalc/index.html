<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#050a14">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="aiDANaI Finanzas">
    <title>aiDANaI</title>
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Lexend:wght@300;400;500;700&family=Poppins:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <style>
        :root { 
            --neon-red: #FF1744;
            --neon-blue: #0088FF;
            --neon-green: #00E676;
            --neon-purple: #bb86fc;
            --bitcoin-orange: #F7931A;
            --crypto-green: #03dac6;
            --crypto-red: #ff6b6b;
            --status-offline: #cf6679;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        /* === ANIMACIONES ORIGINALES === */
        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes screenFlash {
            0% { box-shadow: inset 0 0 0 rgba(0,0,0,0); }
            50% { box-shadow: inset 0 0 40px var(--flash-color, rgba(255,255,255,0.2)); }
            100% { box-shadow: inset 0 0 0 rgba(0,0,0,0); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        html, body { 
            height: 100dvh; width: 100vw; 
            font-family: 'Poppins', sans-serif; overflow: hidden; 
            background-color: var(--bg-color);
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
            transition: background-color 0.5s ease;
        }

        /* === TEMAS (Mantenidos) === */
        body[data-theme="dark"] { 
            --bg-color: #050a14;
            background-image: linear-gradient(-45deg, #050a14, #0a101a, #110a1c, #050a14);
            --keypad-bg: #151b26; 
            --card-bg: linear-gradient(145deg, #12161f, #0b0e14);
            --inset-shadow: inset 3px 3px 6px #06080d, inset -3px -3px 6px #161d2b;
            --border-ui: rgba(255,255,255,0.05);
            --primary-text: #e0e6ed;
            --secondary-text: #8b9bb4;
            --display-lens-bg: #030508;
            --display-lens-border: rgba(255,255,255,0.08);
            --btn-shadow-idle: 0 8px 15px rgba(0,0,0,0.5), 0 4px 0 #090c12, inset 0 2px 5px rgba(255,255,255,0.08);
            --btn-shadow-active: 0 2px 5px rgba(0,0,0,0.4), 0 0 0 #090c12, inset 0 2px 10px rgba(0,0,0,0.6);
            --btn-face-normal: radial-gradient(120% 120% at 30% 30%, #2b323f 0%, #151921 60%, #080a0f 100%);
            --btn-text: #fff;
            --bg-red: radial-gradient(120% 120% at 30% 30%, #ff5252 0%, #d50000 60%, #800000 100%);
            --bg-blue: radial-gradient(120% 120% at 30% 30%, #448aff 0%, #2962ff 60%, #002171 100%);
            --enter-bg: radial-gradient(120% 120% at 30% 30%, #69f0ae 0%, #00c853 50%, #003300 100%);
            --enter-text: #000;
            --edit-highlight: rgba(0, 136, 255, 0.25);
            --flash-color: rgba(0, 230, 118, 0.3);
            --tooltip-bg: rgba(20, 25, 35, 0.95);
            --tooltip-text: #fff;
            --modal-bg: #151b26;
        }
        
        body[data-theme="light"] { 
            --bg-color: #dce0e6;
            background-image: linear-gradient(-45deg, #dce0e6, #e8ecf1, #e3dce6, #dce0e6);
            --keypad-bg: #f8f9fa; 
            --card-bg: linear-gradient(145deg, #ffffff, #e6e6e6);
            --inset-shadow: inset 4px 4px 8px #b8bec9, inset -4px -4px 8px #ffffff;
            --border-ui: rgba(255,255,255,0.6);
            --primary-text: #2d3436; 
            --secondary-text: #5e6c7e;
            --display-lens-bg: #cfd6df;
            --display-lens-border: rgba(255,255,255,0.8);
            --btn-shadow-idle: 5px 10px 15px rgba(160,170,180, 0.3), 0 4px 0 #b0b6c2, inset 0 2px 4px rgba(255,255,255,0.9);
            --btn-shadow-active: 2px 5px 10px rgba(160,170,180, 0.3), 0 0 0 #b0b6c2, inset 0 2px 8px rgba(160,170,180, 0.5);
            --btn-face-normal: radial-gradient(120% 120% at 30% 30%, #ffffff 0%, #f0f2f5 50%, #cbd2db 100%);
            --btn-text: #333;
            --bg-red: radial-gradient(circle at 30% 30%, #ff8a80 0%, #d32f2f 60%, #b71c1c 100%);
            --bg-blue: radial-gradient(circle at 30% 30%, #82b1ff 0%, #1976d2 60%, #0d47a1 100%);
            --enter-bg: radial-gradient(circle at 30% 30%, #b9f6ca 0%, #00e676 50%, #00a000 100%);
            --enter-text: #004d2a;
            --edit-highlight: rgba(25, 118, 210, 0.15);
            --flash-color: rgba(0, 200, 83, 0.3);
            --tooltip-bg: rgba(255, 255, 255, 0.95);
            --tooltip-text: #333;
            --modal-bg: #f0f2f5;
        }

        .view-container { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            background-color: transparent;
        }
        .view.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 10; }

        /* HEADER */
        .app-header {
            flex: 0 0 auto; display: flex; align-items: center; justify-content: space-between;
            padding: max(var(--safe-top), 10px) 8px 5px; z-index: 20; gap: 8px;
            height: calc(var(--header-height) + var(--safe-top)); width: 100%;
        }
        .embedded-ui {
            background: rgba(255,255,255,0.05); backdrop-filter: blur(5px);
            box-shadow: var(--inset-shadow); border-radius: 14px; display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border-ui); transition: 0.2s; flex-shrink: 0;
        }
        .icon-btn { width: 44px; height: 44px; cursor: pointer; color: var(--secondary-text); padding: 10px; }
        .icon-btn:active { transform: scale(0.95); color: var(--primary-text); }
        
        .app-title { 
            font-family: 'Lexend', sans-serif; font-weight: 700; 
            font-size: clamp(0.9rem, 4vw, 1.3rem); color: var(--neon-red); padding: 0 5px; height: 44px; 
            flex-grow: 1; text-align: center; display: flex; justify-content: center; align-items: center;
            text-shadow: 0 0 10px rgba(255, 23, 68, 0.4); min-width: 0; overflow: hidden;
        }
        #clock, #clock-crypto {
            font-family: 'Fira Code', monospace; font-weight: 600; 
            font-size: clamp(0.7rem, 2.5vw, 0.8rem); color: var(--neon-green); 
            padding: 0 8px; min-width: 75px; text-align: center; height: 44px;
        }

        /* CALCULATOR UI */
        .upper-section { flex: 1 1 50%; height: 50%; display: flex; flex-direction: column; padding: 5px 20px 15px; min-height: 0; }
        .display-lens {
            width: 100%; height: 100%; background: var(--display-lens-bg); border: 1px solid var(--display-lens-border);
            border-radius: 20px; box-shadow: inset 0 10px 30px rgba(0,0,0,0.5); 
            display: flex; flex-direction: column; padding: 15px; position: relative; overflow: hidden;
            transition: border-color 0.2s; 
        }
        .display-lens.pulse-active { animation: screenFlash 0.3s ease-out; }

        #history-list { 
            flex: 1; overflow-y: auto; padding: 5px; 
            display: flex; flex-direction: column-reverse; list-style: none; gap: 12px;
            mask-image: linear-gradient(to top, black 85%, transparent 100%); scrollbar-width: none;
        }
        #history-list li {
            text-align: right; cursor: pointer; opacity: 0.7; font-family: 'Inter', sans-serif; font-size: 1rem; color: var(--secondary-text);
            animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); padding: 6px 0;
        }
        #history-list li:hover { opacity: 1; transform: translateX(-5px); }
        #history-list b { color: var(--primary-text); }

        .display-area { flex-shrink: 0; text-align: right; padding-top: 10px; display: flex; flex-direction: column; justify-content: flex-end; min-height: 80px; }
        #secondary-display { font-family: 'Fira Code', monospace; color: var(--secondary-text); height: 1.2rem; font-size: 0.9rem; opacity: 0; transition: opacity 0.2s; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        #secondary-display.visible { opacity: 1; }
        #main-display { 
            font-family: 'Lexend', sans-serif; color: var(--primary-text); font-size: 2.5rem; font-weight: 500; line-height: 1.1;
            text-shadow: 0 2px 15px rgba(0,0,0,0.2); word-wrap: break-word; word-break: break-all; transition: font-size 0.2s ease-out; 
        }
        
        .calculator-body {
            flex: 1 1 50%; height: 50%; width: 100%; background: var(--keypad-bg); border-radius: 30px 30px 0 0;
            z-index: 10; padding: 15px 20px; padding-bottom: max(15px, var(--safe-bottom));
            box-shadow: 0 -10px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column;
        }
        .keypad { flex: 1; width: 100%; display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); gap: 10px; }
        
        /* Botones Originales con efectos */
        .btn {
            background: var(--btn-face-normal); color: var(--btn-text);
            box-shadow: var(--btn-shadow-idle); transition: transform 0.05s, box-shadow 0.05s; 
            border: none; font-family: 'Lexend', sans-serif; cursor: pointer; border-radius: 16px; height: 100%; width: 100%; 
            font-size: clamp(1rem, 2vh, 1.3rem); font-weight: 500; position: relative; overflow: hidden;
        }
        .btn::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0; transform: scale(0.5); pointer-events: none; transition: opacity 0.3s, transform 0.3s;
        }
        .btn:active::after { opacity: 1; transform: scale(1); transition: 0s; }
        .btn:active, .btn.btn-active { box-shadow: var(--btn-shadow-active); transform: translateY(3px); }
        .btn-wide { grid-column: span 2; border-radius: 20px; }
        .btn[data-color="red"] { background: var(--bg-red); color: #fff; }
        .btn[data-color="blue"] { background: var(--bg-blue); color: #fff; }
        .btn[data-color="green"] { background: var(--enter-bg); color: var(--enter-text); }
        
        .token-op { color: var(--neon-blue); margin: 0 2px; }
        .token-selected { background: var(--edit-highlight); border-radius: 4px; }

        /* CRYPTO UI */
        .crypto-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: calc(var(--safe-bottom) + 20px); }
        
        #timestamp { text-align: center; color: var(--secondary-text); font-size: 0.8rem; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--secondary-text); display: inline-block; transition: 0.3s; }
        .status-dot.online { background-color: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        .status-dot.error { background-color: var(--status-offline); }
        
        .card {
            background: var(--card-bg); border-radius: 18px; padding: 16px; margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--border-ui);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative;
        }
        .card:hover { transform: scale(1.02); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .card:active { transform: scale(0.98); }
        
        .coin-details { display: flex; align-items: center; gap: 12px; }
        .coin-logo { width: 42px; height: 42px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); object-fit: cover; background: #fff; }
        .coin-info h2 { font-size: 1.1rem; margin: 0; color: var(--primary-text); text-transform: capitalize; }
        .change-percentage { font-size: 0.9rem; }
        .change-positive { color: var(--crypto-green); font-weight: bold; text-shadow: 0 0 8px rgba(3, 218, 198, 0.3); }
        .change-negative { color: var(--crypto-red); font-weight: bold; }
        
        .price-container { text-align: right; display: flex; flex-direction: column; justify-content: center; }
        .price-eur { font-size: 1.2rem; font-weight: 700; color: var(--primary-text); }
        .price-usd { font-size: 0.85rem; font-weight: 500; color: var(--secondary-text); margin-top: 2px; }

        /* MODALES */
        #chart-modal, #add-coin-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(12px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s; padding: 20px;
        }
        .visible { opacity: 1 !important; pointer-events: auto !important; }
        
        .modal-content {
            width: 100%; max-width: 500px; background: var(--modal-bg);
            border: 1px solid var(--border-ui); border-radius: 24px;
            padding: 20px; transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column;
        }
        .visible .modal-content { transform: scale(1); }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { color: var(--primary-text); font-size: 1.4rem; font-weight: 700; text-transform: capitalize; }
        .close-btn { background: none; border: none; font-size: 1.8rem; color: var(--secondary-text); cursor: pointer; padding: 5px; z-index: 2; }
        
        /* Chart Controls (NUEVO) */
        .timeframe-selector { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.1); padding: 4px; border-radius: 12px; }
        .tf-btn { background: transparent; border: none; color: var(--secondary-text); padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .tf-btn.active { background: var(--card-bg); color: var(--primary-text); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .action-bar { margin-top: 15px; display: flex; gap: 10px; }
        .action-btn {
            flex: 1; padding: 12px; border-radius: 14px; border: none; font-weight: 600; font-size: 1rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-use-price { background: var(--neon-blue); color: white; box-shadow: 0 4px 15px rgba(0,136,255,0.3); }
        .btn-use-price:active { transform: scale(0.96); }
        .btn-delete-coin { background: rgba(255,23,68,0.1); color: var(--neon-red); border: 1px solid rgba(255,23,68,0.3); }

        /* Add Coin Modal (NUEVO) */
        .input-group { display: flex; gap: 10px; margin-top: 15px; }
        #coin-input { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid var(--border-ui); background: var(--keypad-bg); color: var(--primary-text); font-family: 'Poppins', sans-serif; }
        .btn-confirm { background: var(--neon-green); color: #000; border: none; padding: 0 20px; border-radius: 12px; font-weight: 600; cursor: pointer; }

        /* Spinner Original */
        .loading-spinner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--neon-blue); border-radius: 50%;
            animation: spin 1s linear infinite; display: none; z-index: 5;
        }
        .loading-spinner.active { display: block; }
        
        /* Estilo personalizado para Tooltips de ApexCharts */
        .apexcharts-tooltip {
            background: var(--tooltip-bg) !important;
            border: 1px solid var(--border-ui) !important;
            color: var(--tooltip-text) !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3) !important;
            border-radius: 8px !important;
        }
        .apexcharts-tooltip-title {
            background: rgba(0,0,0,0.2) !important;
            border-bottom: 1px solid var(--border-ui) !important;
            font-family: 'Poppins', sans-serif !important;
        }
        .apexcharts-text { fill: var(--secondary-text) !important; }

        .toast {
            position: fixed; bottom: 50%; left: 50%; transform: translate(-50%, 50%) scale(0.9);
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); color: white;
            padding: 12px 24px; border-radius: 30px;
            opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); white-space: nowrap;
        }
        .toast.show { opacity: 1; transform: translate(-50%, 0) scale(1); }

        @media(min-width: 600px) {
            body { display: flex; align-items: center; justify-content: center; background: #222; }
            .view-container { max-width: 400px; height: 90vh; border-radius: 40px; border: 8px solid #333; background: var(--bg-color); overflow: hidden; box-shadow: 0 50px 100px rgba(0,0,0,0.5); }
        }
    </style>
</head>
<body data-theme="dark">

    <div class="view-container">
        <div id="view-calculator" class="view active">
            <header class="app-header">
                <button class="embedded-ui icon-btn btn-theme" title="Cambiar Tema" aria-label="Cambiar modo de color">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                
                <div class="app-title embedded-ui">aiDANaI</div>
                
                <div id="clock" class="embedded-ui">0:00:00</div>
                
                <button id="btn-go-crypto" class="embedded-ui icon-btn" title="Crypto" aria-label="Ver precios de criptomonedas">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                </button>
            </header>
        
            <div class="upper-section">
                <div class="display-lens" id="display-container">
                    <ul id="history-list"></ul>
                    <div class="display-area">
                        <div id="secondary-display">0</div>
                        <div id="main-display">0</div>
                    </div>
                </div>
            </div>

            <div class="calculator-body">
                <div class="keypad">
                    <button class="btn" data-key="AC" data-color="red" aria-label="Borrar todo">AC</button>
                    <button class="btn" data-key="Backspace" data-color="red" aria-label="Borrar">‚å´</button>
                    <button class="btn" data-key="(" data-color="red" aria-label="Par√©ntesis">( )</button>
                    <button class="btn" data-key="/" data-color="blue" aria-label="Dividir">√∑</button>
  
                    <button class="btn" data-key="7">7</button>
                    <button class="btn" data-key="8">8</button>
                    <button class="btn" data-key="9">9</button>
                    <button class="btn" data-key="*" data-color="blue" aria-label="Multiplicar">√ó</button>
             
                    <button class="btn" data-key="4">4</button>
                    <button class="btn" data-key="5">5</button>
                    <button class="btn" data-key="6">6</button>
                    <button class="btn" data-key="-" data-color="blue" aria-label="Restar">‚àí</button>
                    <button class="btn" data-key="1">1</button>
  
                    <button class="btn" data-key="2">2</button>
                    <button class="btn" data-key="3">3</button>
                    <button class="btn" data-key="+" data-color="blue" aria-label="Sumar">+</button>
                    <button class="btn" data-key="0">0</button>
             
                    <button class="btn btn-wide" data-key="Enter" data-color="green" aria-label="Igual">=</button>
                    <button class="btn" data-key="." data-color="blue" aria-label="Decimal">,</button>
                </div>
            </div>
        </div>

        <div id="view-crypto" class="view">
            <header class="app-header">
                <button class="embedded-ui icon-btn btn-theme" aria-label="Cambiar modo de color">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                
                <div class="app-title embedded-ui" style="color: var(--neon-purple);">Crypto</div>
                
                <button id="btn-add-coin" class="embedded-ui icon-btn" style="color: var(--neon-green);" title="A√±adir Moneda">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
                
                <button id="btn-go-calc" class="embedded-ui icon-btn" title="Volver a Calculadora" aria-label="Volver a la calculadora">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="12" y1="10" x2="12" y2="10"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="12" y1="18" x2="12" y2="18"></line></svg>
                </button>
            </header>
            <div class="crypto-content">
                <p id="timestamp"><span class="status-dot"></span> <span id="time-text">Conectando...</span></p>
                <div id="crypto-list-container"></div>
            </div>
        </div>
    </div>

    <div id="chart-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="chart-title">Coin</h2>
                <button class="close-btn" id="close-chart">&times;</button>
            </div>
            
            <div class="timeframe-selector">
                <button class="tf-btn" data-days="1">24H</button>
                <button class="tf-btn active" data-days="7">7D</button>
                <button class="tf-btn" data-days="30">30D</button>
                <button class="tf-btn" data-days="365">1A</button>
            </div>

            <div style="position: relative; min-height: 250px;">
                <div id="loading-chart" class="loading-spinner"></div>
                <div id="chart-container"></div>
            </div>

            <div class="action-bar">
                <button class="action-btn btn-delete-coin" id="btn-delete-current" title="Eliminar de lista">
                   üóëÔ∏è
                </button>
                <button class="action-btn btn-use-price" id="btn-use-price">
                    üßÆ Usar Precio
                </button>
            </div>
        </div>
    </div>

    <div id="add-coin-modal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h2 class="modal-title">A√±adir Moneda</h2>
                <button class="close-btn" id="close-add">&times;</button>
            </div>
            <p style="color:var(--secondary-text); font-size:0.9rem;">Introduce el ID de CoinGecko (ej: 'cardano', 'pepe', 'polkadot')</p>
            <div class="input-group">
                <input type="text" id="coin-input" placeholder="id de moneda..." autocomplete="off">
                <button class="btn-confirm" id="confirm-add">A√±adir</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Notificaci√≥n</div>

    <script>
        const App = {
            expr: '',
            state: { 
                theme: 'dark',
                coins: ['bitcoin', 'ethereum', 'solana', 'ripple'] // Default list
            },
            editIdx: null,
            chart: null,
            wakeLock: null,
            
            // Crypto State
            currentCoin: null,
            currentPrice: 0,
            chartDays: 7,
            prices: {}, 
            
            init() {
                this.loadState();
                this.applyTheme(this.state.theme);
                this.renderCryptoList(); // Renderiza las monedas guardadas
                this.bindEvents();
                this.startClocks();
                this.fetchPrices();
                setInterval(() => this.fetchPrices(), 60000);
                this.requestWakeLock(); // RESTAURADO: WakeLock
                this.fixHeight();
            },

            fixHeight() {
                const doc = document.documentElement;
                const setH = () => doc.style.setProperty('--doc-height', `${window.innerHeight}px`);
                setH(); window.addEventListener('resize', setH);
            },

            async requestWakeLock() { // RESTAURADO: WakeLock
                try {
                    if ('wakeLock' in navigator) {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        document.addEventListener('visibilitychange', async () => {
                            if (this.wakeLock !== null && document.visibilityState === 'visible') {
                                this.wakeLock = await navigator.wakeLock.request('screen');
                            }
                        });
                    }
                } catch (e) {}
            },

            bindEvents() {
                // Navegaci√≥n
                document.getElementById('btn-go-crypto').onclick = () => this.switchView('crypto');
                document.getElementById('btn-go-calc').onclick = () => this.switchView('calc');
                
                // Temas (Con Haptic RESTAURADO)
                document.querySelectorAll('.btn-theme').forEach(b => b.onclick = () => {
                    this.applyTheme(this.state.theme === 'dark' ? 'light' : 'dark');
                    this.haptic(15);
                });

                // L√≥gica de Botones Calculadora (COMPLETA ORIGINAL + TECLADO)
                document.querySelectorAll('.btn[data-key]').forEach(b => {
                    const key = b.dataset.key;
                    
                    if (key === 'AC') {
                        let pressTimer;
                        let longPressTriggered = false;

                        const startPress = (e) => { // RESTAURADO: Long Press logic
                            if(e.cancelable) e.preventDefault();
                            b.classList.add('btn-active');
                            longPressTriggered = false;
                            
                            pressTimer = setTimeout(() => {
                                longPressTriggered = true;
                                document.getElementById('history-list').innerHTML = '';
                                this.showToast('Historial Eliminado üóëÔ∏è');
                                this.haptic([50, 50, 50]); 
                                this.pulseDisplay();
                                this.handleInput('AC'); 
                            }, 800);
                        };

                        const endPress = () => {
                            clearTimeout(pressTimer);
                            b.classList.remove('btn-active');
                            if (!longPressTriggered) {
                                this.haptic(10);
                                this.handleInput('AC');
                                this.pulseDisplay();
                            }
                        };

                        b.addEventListener('pointerdown', startPress);
                        b.addEventListener('pointerup', endPress);
                        b.addEventListener('pointerleave', () => {
                            clearTimeout(pressTimer);
                            b.classList.remove('btn-active');
                        });

                    } else {
                        const press = (e) => {
                            if(e.cancelable) e.preventDefault(); 
                            this.haptic(10);
                            b.classList.add('btn-active');
                            this.pulseDisplay(); 
                            this.handleInput(key);
                        };
                        const release = () => b.classList.remove('btn-active');
                        b.addEventListener('pointerdown', press);
                        b.addEventListener('pointerup', release);
                        b.addEventListener('pointerleave', release);
                    }
                });

                // RESTAURADO: Soporte de teclado f√≠sico completo
                document.addEventListener('keydown', (e) => {
                    const k = e.key === 'Enter' ? 'Enter' : e.key;
                    if(!/^[0-9+\-*/.,=()]$|Enter|Backspace|Escape|Delete/.test(k)) return;
                    let vKey = k;
                    if(k==='Enter'||k==='=') vKey='Enter';
                    if(k==='Escape'||k==='Delete') vKey='AC';
                    const btn = document.querySelector(`.btn[data-key="${vKey}"]`) || document.querySelector(`.btn[data-key="${k}"]`);
                    if(btn) {
                        btn.classList.add('btn-active');
                        this.pulseDisplay();
                        setTimeout(() => btn.classList.remove('btn-active'), 100);
                        this.handleInput(vKey === 'AC' ? 'AC' : (vKey === 'Enter' ? 'Enter' : k));
                    }
                });

                // EVENTOS NUEVOS: Modales y Cripto
                const chartModal = document.getElementById('chart-modal');
                const addModal = document.getElementById('add-coin-modal');

                document.getElementById('btn-add-coin').onclick = () => {
                    addModal.classList.add('visible');
                    document.getElementById('coin-input').focus();
                };
                document.getElementById('close-add').onclick = () => addModal.classList.remove('visible');
                document.getElementById('confirm-add').onclick = () => this.addCoin();
                
                // Add coin con Enter
                document.getElementById('coin-input').addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') this.addCoin();
                });

                document.getElementById('close-chart').onclick = () => chartModal.classList.remove('visible');
                
                // Cerrar clickando fuera
                chartModal.onclick = (e) => { if (e.target === chartModal) chartModal.classList.remove('visible'); };
                addModal.onclick = (e) => { if (e.target === addModal) addModal.classList.remove('visible'); };

                // Chart Timeframes
                document.querySelectorAll('.tf-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.chartDays = btn.dataset.days;
                        this.haptic(10);
                        if(this.currentCoin) this.loadChartData(this.currentCoin);
                    };
                });

                // Feature: Usar Precio en Calculadora
                document.getElementById('btn-use-price').onclick = () => {
                    this.sendToCalc();
                    chartModal.classList.remove('visible');
                    this.haptic(20);
                };

                // Borrar moneda
                document.getElementById('btn-delete-current').onclick = () => {
                    if(confirm(`¬øEliminar ${this.currentCoin}?`)) {
                        this.state.coins = this.state.coins.filter(c => c !== this.currentCoin);
                        this.saveState();
                        this.renderCryptoList();
                        this.fetchPrices();
                        chartModal.classList.remove('visible');
                        this.haptic(20);
                    }
                };
            },

            pulseDisplay() {
                const lens = document.getElementById('display-container');
                lens.classList.remove('pulse-active');
                void lens.offsetWidth; 
                lens.classList.add('pulse-active');
                setTimeout(()=>lens.classList.remove('pulse-active'), 300);
            },

            handleInput(k) {
                if(this.fresh) {
                    if(!"+-*/".includes(k) && k !== 'Enter') { this.expr=''; this.editIdx=null; }
                    this.fresh = false;
                    document.getElementById('secondary-display').classList.remove('visible');
                }
                
                if(k==='AC') { 
                    this.expr = '';
                    this.editIdx = null; 
                }
                else if(k==='Backspace') { this.expr = this.expr.toString().slice(0, -1);
                }
                else if(k==='Enter') { this.calculate();
                }
                else if(k==='(') { this.smartParen(); }
                else {
                    const last = this.expr.slice(-1);
                    if("+-*/".includes(last) && "+-*/".includes(k)) { this.expr = this.expr.slice(0, -1) + k; } 
                    else { this.expr += k; }
                }
                this.renderCalc();
            },

            calculate() {
                if(!this.expr) return;
                try {
                    // RESTAURADO: Mostrar operaci√≥n original en pantalla secundaria
                    const originalExpr = this.expr.replace(/\*/g,'√ó').replace(/\//g,'√∑');
                    
                    let clean = this.expr.replace(/[^0-9+\-*/().]/g, '');
                    clean = clean.replace(/\)\(/g, ')*('); 
                    let res = new Function('return ' + clean)();
                    if(!isFinite(res)) throw new Error("Error");
                    res = parseFloat(res.toPrecision(12)); 
                    
                    this.addToHistory(this.expr, res);
                    this.expr = String(res); this.fresh=true;
                    
                    const secDisp = document.getElementById('secondary-display');
                    secDisp.innerText = originalExpr + ' =';
                    secDisp.classList.add('visible');
                    this.pulseDisplay();
                } catch(e) { this.showToast("C√°lculo inv√°lido"); }
                this.renderCalc();
            },

            smartParen() {
                const o = (this.expr.match(/\(/g)||[]).length;
                const c = (this.expr.match(/\)/g)||[]).length;
                const last = this.expr.slice(-1);
                if(o > c && (/[0-9.]$/.test(last) || last===')')) this.expr += ')';
                else if(/[0-9.]$/.test(last) || last===')') this.expr += '*(';
                else this.expr += '(';
                this.renderCalc();
            },

            renderCalc() {
                const d = document.getElementById('main-display');
                if(!this.expr) { d.innerHTML = '0'; d.style.fontSize = '2.5rem'; return; }
                const len = this.expr.length;
                
                let size = 2.5; 
                if (len > 7) {
                    size = Math.max(1.1, 2.5 - ((len - 7) * 0.08));
                }
                d.style.fontSize = `${size}rem`;

                const parts = this.expr.split(/([\+\-\*\/])/);
                let h = '';
                parts.forEach((p,i) => {
                    if(p==='') return;
                    let cls = 'token';
                    let txt = p;
                    if("+-*/".includes(p)) { cls += ' token-op'; txt = p.replace('*','√ó').replace('/','√∑'); } 
                    else { if(!isNaN(parseFloat(p))) { let [int, dec] = p.split('.'); int = int.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    txt = dec !== undefined ? `${int},${dec}` : int; } }
                    if(i === this.editIdx) cls += ' token-selected';
                    h += `<span class="${cls}">${txt}</span>`;
                });
                d.innerHTML = h;
            },

            addToHistory(ex, r) {
                const li = document.createElement('li');
                const formattedRes = r.toLocaleString('es-ES', { maximumFractionDigits: 10 });
                const prettyExpr = ex.replace(/\*/g,'√ó').replace(/\//g,'√∑').replace(/(\d+)(\.\d+)?/g, (m, i, d) => i.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + (d?d.replace('.',','):''));
                li.innerHTML = `${prettyExpr} = <b>${formattedRes}</b>`;
                li.setAttribute('role', 'button');
                li.setAttribute('tabindex', '0');
                li.onclick = () => { this.expr = String(r); this.fresh = true; this.renderCalc(); this.haptic(10); };
                const list = document.getElementById('history-list');
                list.prepend(li);
                if(list.children.length > 20) list.lastChild.remove(); 
            },

            /* --- LOGICA CRYPTO (MEJORADA + ROBUSTEZ ORIGINAL) --- */

            renderCryptoList() {
                const container = document.getElementById('crypto-list-container');
                container.innerHTML = '';
                
                if(this.state.coins.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--secondary-text)">Sin monedas. Pulsa + para a√±adir.</div>';
                    return;
                }

                this.state.coins.forEach(id => {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.onclick = () => this.openChartModal(id);
                    div.innerHTML = `
                        <div class="coin-details">
                            <img src="" class="coin-logo" id="img-${id}" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg'">
                            <div class="coin-info">
                                <h2>${id}</h2>
                                <p class="change-percentage" id="change-${id}">--</p>
                            </div>
                        </div>
                        <div class="price-container">
                            <p class="price-eur" id="price-eur-${id}">--</p>
                            <p class="price-usd" id="price-usd-${id}">--</p>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },

            async addCoin() {
                const input = document.getElementById('coin-input');
                const id = input.value.toLowerCase().trim();
                if(!id) return;
                
                if(this.state.coins.includes(id)) {
                    this.showToast('La moneda ya est√° en la lista');
                    return;
                }

                document.getElementById('add-coin-modal').classList.remove('visible');
                this.showToast(`Buscando ${id}...`);

                try {
                    const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=eur`);
                    const data = await res.json();
                    if(data[id]) {
                        this.state.coins.push(id);
                        this.saveState();
                        this.renderCryptoList();
                        this.fetchPrices();
                        input.value = '';
                        this.showToast(`${id} a√±adido`);
                        this.haptic(20);
                    } else {
                        this.showToast('Moneda no encontrada');
                        this.haptic(50);
                    }
                } catch(e) {
                    this.showToast('Error de conexi√≥n');
                }
            },

            async fetchPrices() {
                if(this.state.coins.length === 0) return;
                const ids = this.state.coins.join(',');
                const dot = document.querySelector('.status-dot');
                const label = document.getElementById('time-text');
                
                try {
                    const controller = new AbortController(); // RESTAURADO: Robustez Original
                    const idTimeout = setTimeout(() => controller.abort(), 8000);
                    
                    const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=eur,usd&include_24hr_change=true`, { signal: controller.signal });
                    clearTimeout(idTimeout);
                    
                    if(!res.ok) throw new Error("API Limit");
                    const d = await res.json();
                    this.prices = d;

                    const fmtEur = new Intl.NumberFormat('es-ES', {style:'currency', currency:'EUR'});
                    const fmtUsd = new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'});

                    this.state.coins.forEach(id => {
                        if(d[id]) {
                            // Update Images intelligently
                            const img = document.getElementById(`img-${id}`);
                            if(img) {
                                if(id==='bitcoin') img.src="https://assets.coingecko.com/coins/images/1/large/bitcoin.png";
                                else if(id==='ethereum') img.src="https://assets.coingecko.com/coins/images/279/large/ethereum.png";
                                else if(id==='solana') img.src="https://assets.coingecko.com/coins/images/4128/large/solana.png";
                                else if(id==='ripple') img.src="https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png";
                                else if(!img.src || img.src.includes('wikimedia')) img.src = `https://assets.coingecko.com/coins/images/1/large/${id}.png`; // Intento gen√©rico
                            }

                            const elEur = document.getElementById(`price-eur-${id}`);
                            const oldPrice = elEur.innerText;
                            const newPrice = fmtEur.format(d[id].eur);

                            // RESTAURADO: Animaci√≥n de color al cambiar precio
                            if(oldPrice !== '--' && oldPrice !== newPrice) {
                                elEur.style.color = d[id].eur_24h_change > 0 ? 'var(--crypto-green)' : 'var(--crypto-red)';
                                setTimeout(()=>elEur.style.color = 'var(--primary-text)', 1000);
                            }
                            elEur.textContent = newPrice;

                            const elUsd = document.getElementById(`price-usd-${id}`);
                            if(elUsd) elUsd.textContent = fmtUsd.format(d[id].usd);

                            const chg = d[id].eur_24h_change || 0;
                            const elChg = document.getElementById(`change-${id}`);
                            if(elChg) {
                                elChg.innerText = (chg>0?'+':'') + chg.toFixed(2) + '%';
                                elChg.className = `change-percentage ${chg>=0?'change-positive':'change-negative'}`;
                            }
                        }
                    });
                    
                    label.innerText = new Date().toLocaleTimeString().slice(0,5);
                    dot.className = 'status-dot online';
                } catch(e) {
                    dot.className = 'status-dot error';
                    label.innerText = e.name === 'AbortError' ? 'Red lenta' : 'Sin conexi√≥n';
                }
            },

            openChartModal(id) {
                this.currentCoin = id;
                this.currentPrice = this.prices[id] ? this.prices[id].eur : 0;
                document.getElementById('chart-title').innerText = id;
                document.getElementById('chart-modal').classList.add('visible');
                this.loadChartData(id);
            },

            async loadChartData(id) {
                const spinner = document.getElementById('loading-chart');
                spinner.classList.add('active'); // UX: Spinner Original
                
                if(!this.chart) {
                    this.chart = new ApexCharts(document.getElementById('chart-container'), {
                        series:[], chart: {type:'area', height:250, toolbar:{show:false}, background:'transparent'},
                        theme: {mode: this.state.theme}, 
                        stroke:{curve:'smooth',width:2},
                        fill: {type:'gradient', gradient: {shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.3}}, 
                        dataLabels:{enabled:false},
                        xaxis: {type:'datetime', tooltip:{enabled:false}, axisBorder:{show:false}, labels:{show:false}},
                        yaxis: {labels: {style:{colors:'var(--secondary-text)'}, formatter: v=>v.toLocaleString('es-ES') + '‚Ç¨'}},
                        grid: {show:false},
                        tooltip: { theme: this.state.theme, x: {format: 'dd MMM HH:mm'} }
                    });
                    this.chart.render();
                }

                try {
                    const res = await fetch(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=eur&days=${this.chartDays}`);
                    const data = await res.json();
                    
                    const isPositive = (data.prices[data.prices.length-1][1] >= data.prices[0][1]);
                    const color = isPositive ? '#00E676' : '#FF1744';

                    this.chart.updateOptions({
                        theme:{mode:this.state.theme},
                        tooltip: { theme: this.state.theme },
                        colors: [color]
                    });
                    this.chart.updateSeries([{name:'Precio', data: data.prices}]);
                    
                    this.currentPrice = data.prices[data.prices.length-1][1];

                } catch(e) { this.showToast('Error cargando gr√°fico'); }
                finally { spinner.classList.remove('active'); }
            },

            sendToCalc() {
                if(!this.currentPrice) return;
                
                // Nueva l√≥gica inteligente de inserci√≥n
                const p = String(this.currentPrice);
                const lastChar = this.expr.slice(-1);
                
                if("+-*/(".includes(lastChar)) {
                    this.expr += p;
                } else {
                    // Si hay un n√∫mero o est√° vac√≠o, reemplaza para empezar operaci√≥n nueva con el precio
                     this.expr = p;
                }

                this.fresh = false; 
                this.switchView('calc');
                this.renderCalc();
                this.pulseDisplay();
                this.showToast(`Precio copiado`);
            },

            switchView(v) {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                if(v==='crypto') { 
                    document.getElementById('view-crypto').classList.add('active'); 
                    this.fetchPrices(); 
                } else { 
                    document.getElementById('view-calculator').classList.add('active'); 
                }
            },
            
            applyTheme(t) {
                this.state.theme = t;
                document.body.dataset.theme = t;
                if(this.chart) this.chart.updateOptions({ theme: {mode: t}, tooltip: { theme: t } });
                this.saveState();
            },
            
            haptic(p) { if(navigator.vibrate) navigator.vibrate(p); }, // RESTAURADO
            
            showToast(msg) { 
                const t = document.getElementById('toast');
                t.innerText = msg; t.classList.add('show'); 
                setTimeout(()=>t.classList.remove('show'), 2000); 
            },
            
            saveState() { localStorage.setItem('aidanaiAppV2', JSON.stringify(this.state)); },
            loadState() { 
                try {
                    const s = JSON.parse(localStorage.getItem('aidanaiAppV2'));
                    if(s) this.state = {...this.state, ...s};
                } catch(e){} 
            },
            
            startClocks() {
                setInterval(() => {
                    const now = new Date();
                    const t = now.toLocaleTimeString();
                    document.querySelectorAll('#clock, #clock-crypto').forEach(e => e.innerText = t);
                }, 1000);
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>