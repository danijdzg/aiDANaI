<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>aiDANaI Calculadora</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1A1B1E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #E8EBF2; --primary-text: #3e4c6e; --secondary-text: #667085; --keypad-bg: rgba(232, 235, 242, 0.7); --button-bg: #E8EBF2; --button-border: transparent; --keypad-border: transparent; --backdrop-blur: 15px; --toast-bg: rgba(230, 235, 240, 0.9); --border-radius: 24px; --spacing: clamp(12px, 3vw, 18px); --keypad-height: 50%; }
        body[data-theme="light"] { --accent-green: #26A69A; --accent-blue: #3A7DDB; --accent-red: #d15a5a; background: var(--bg-color); }
        body[data-theme="light"] .display-wrapper { background: var(--bg-color); border-radius: 20px; padding: var(--spacing); margin-bottom: var(--spacing); box-shadow: inset 6px 6px 12px #c5c8cf, inset -6px -6px 12px #ffffff; }
        body[data-theme="light"] .main-display { color: var(--primary-text); }
        body[data-theme="light"] .keypad button { border-radius: 18px; color: var(--secondary-text); font-weight: 500; background: linear-gradient(145deg, #fcfdff, #d4d7dc); box-shadow: 6px 6px 12px #c5c8cf, -6px -6px 12px #ffffff; transition: all 150ms ease-in-out; }
        body[data-theme="light"] .keypad button:active, body[data-theme="light"] .keypad button.key-pressed { transform: translateY(0px) scale(0.95); box-shadow: inset 6px 6px 12px #c5c8cf, inset -6px -6px 12px #ffffff; background: #e1e4e9; }
        /* MEJORA: Hover y Focus para Escritorio */
        body[data-theme="light"] .keypad button:hover { filter: brightness(1.05); }
        body[data-theme="light"] .keypad button:focus-visible { box-shadow: 6px 6px 12px #c5c8cf, -6px -6px 12px #ffffff, 0 0 0 3px var(--accent-blue); outline: none; }
        body[data-theme="light"] .keypad .function { color: var(--accent-blue); }
        body[data-theme="light"] .keypad .operator { color: var(--accent-red); }
        body[data-theme="light"] .keypad .equals { background: linear-gradient(145deg, #2abbab, var(--accent-green)); color: #fff; }
        body[data-theme="dark"] { --bg-color: #1A1B1E; --primary-text: #FFFFFF; --secondary-text: #7D7D7D; --keypad-bg: rgba(26, 27, 30, 0.7); --button-bg: #303134; --button-border: #3A3B3D; --keypad-border: #3A3B3D; --backdrop-blur: 20px; --accent-green: #F39C12; --accent-blue: #5DADE2; --accent-red: #F39C12; --toast-bg: rgba(48, 49, 52, 0.9); }
        body[data-theme="dark"] .display-wrapper { background-color: #121212; border-radius: 16px; padding: var(--spacing); margin-bottom: var(--spacing); box-shadow: inset 0px 4px 8px rgba(0, 0, 0, 0.8); }
        body[data-theme="dark"] .main-display { color: var(--primary-text); }
        body[data-theme="dark"] .keypad button { border-radius: 18px; font-weight: 500; background: var(--button-bg); color: var(--primary-text); border: 1px solid var(--button-border); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); transition: all 200ms cubic-bezier(0.4, 0.0, 0.2, 1); }
        body[data-theme="dark"] .keypad button:active, body[data-theme="dark"] .keypad button.key-pressed { transform: scale(0.96) translateY(0); box-shadow: inset 0px 3px 6px rgba(0, 0, 0, 0.6); background-color: #28292c; border-color: #303134; }
        /* MEJORA: Hover y Focus para Escritorio */
        body[data-theme="dark"] .keypad button:hover { border-color: #666; background-color: #3f4044; }
        body[data-theme="dark"] .keypad button:focus-visible { box-shadow: 0 0 0 3px var(--accent-blue); border-color: var(--accent-blue); outline: none;}
        body[data-theme="dark"] .keypad .function { color: var(--accent-red); background-color: #26211c; }
        body[data-theme="dark"] .keypad .operator { color: var(--accent-blue); }
        body[data-theme="dark"] .keypad .equals { background: var(--accent-green); color: #FFFFFF; border-color: #F39C12; }
        body[data-theme="crystal"] { --bg-color: #34495E; --primary-text: #FFFFFF; --secondary-text: #ECF0F1; --keypad-bg: rgba(44, 62, 80, 0.65); --button-bg: #546E7A; --button-border: transparent; --keypad-border: rgba(236, 240, 241, 0.2); --backdrop-blur: 15px; --accent-blue: #4A90E2; --accent-green: #27AE60; --accent-red: #E67E22; --toast-bg: rgba(58, 79, 99, 0.9); }
        body[data-theme="crystal"] { background: linear-gradient(to bottom, #34495E, #2C3E50); }
        body[data-theme="crystal"] .display-wrapper { background: linear-gradient(180deg, #1E272E 0%, #2C3A47 100%); border-radius: 16px; padding: var(--spacing); margin-bottom: var(--spacing); box-shadow: inset 0px 5px 10px rgba(0, 0, 0, 0.5); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        body[data-theme="crystal"] .main-display { text-shadow: 0 0 8px rgba(255, 255, 255, 0.1); }
        body[data-theme="crystal"] .calculator { box-shadow: 0 -10px 30px rgba(0,0,0,0.3); }
        body[data-theme="crystal"] .keypad button { border-radius: 12px; font-weight: 500; font-size: 1.8rem; transition: transform 250ms cubic-bezier(0.4, 0.0, 0.2, 1), box-shadow 250ms cubic-bezier(0.4, 0.0, 0.2, 1); box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.15), inset 0px 1px 1px rgba(255, 255, 255, 0.1); background-color: var(--button-bg); color: var(--primary-text); }
        body[data-theme="crystal"] .keypad button:active, body[data-theme="crystal"] .keypad button.key-pressed { transform: scale(0.95) translateY(0); box-shadow: inset 0px 3px 5px rgba(0, 0, 0, 0.3); filter: brightness(0.95); }
        /* MEJORA: Hover y Focus para Escritorio */
        body[data-theme="crystal"] .keypad button:hover { filter: brightness(1.2); }
        body[data-theme="crystal"] .keypad button:focus-visible { box-shadow: 0 0 0 3px var(--accent-blue), 0 4px 6px rgba(0,0,0,0.2); outline: none; }
        body[data-theme="crystal"] .keypad .function { background: var(--accent-red); color: #FFFFFF; font-size: 1.6rem; }
        body[data-theme="crystal"] .keypad .operator { background: linear-gradient(145deg, #5DADE2, var(--accent-blue)); color: #FFFFFF; font-size: 2.1rem; }
        body[data-theme="crystal"] .keypad .equals { background: linear-gradient(145deg, #2ECC71, var(--accent-green)); color: #FFFFFF; font-weight: 600; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.4); }
        body[data-theme="light"] .keypad .operator-active { color: #fff !important; background: var(--accent-red); box-shadow: inset 3px 3px 6px #b14d4d, inset -3px -3px 6px #f16767; }
        body[data-theme="dark"] .keypad .operator-active { background: var(--accent-blue); color: #fff !important; border-color: var(--accent-blue); transform: scale(1.03); }
        body[data-theme="crystal"] .keypad .operator-active { background: #fff; color: var(--accent-blue) !important; box-shadow: 0 0 10px rgba(255,255,255,0.5), inset 0px 2px 4px rgba(0, 0, 0, 0.2); transform: scale(1.05); }
        @keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }
        .display-error { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes powerOn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes toast-in { from { opacity: 0; transform: translate(-50%, 20px) scale(0.9); } to { opacity: 1; transform: translate(-50%, 0) scale(1); } }
        @keyframes toast-out { to { opacity: 0; transform: translate(-50%, 20px) scale(0.9); } }
        @keyframes panel-in { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes panel-out { to { transform: translateY(100%); } }
        @keyframes newItemAnimation { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes char-pop-in { from { transform: scale(0.8) translateY(5px); opacity: 0.5; } to { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes result-flash { 0% { opacity: 0.6; transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body { height: 100dvh; width: 100vw; font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--primary-text); overflow: hidden; transition: background-color 0.4s ease, color 0.4s ease; }
        .app-container { position: relative; z-index: 1; width: 100%; height: 100%; display: flex; flex-direction: column; animation: powerOn 0.6s ease-out; }
        .app-header { position: absolute; top: 0; left: 0; right: 0; padding: env(safe-area-inset-top) var(--spacing) 10px var(--spacing); z-index: 10; display: grid; grid-template-columns: 44px 1fr 44px; align-items: center; }
        .app-title { grid-column: 2; text-align: center; font-size: 1rem; font-weight: 600; color: var(--accent-green); transition: color 0.4s ease; }
        .control-btn { background: none; border: none; cursor: pointer; color: var(--secondary-text); width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        .paper-roll-container { flex: 1; min-height: 0; display: flex; flex-direction: column; padding: calc(env(safe-area-inset-top) + 70px) var(--spacing) 0 var(--spacing); overflow: hidden; background-color: transparent; position: relative; }
        #history-list { flex: 1 1 auto; list-style: none; overflow-y: auto; display: flex; flex-direction: column-reverse; scrollbar-width: none; -webkit-mask-image: linear-gradient(to top, black 75%, transparent 100%); }
        #history-list::-webkit-scrollbar { display: none; }
        #history-list li { position: relative; overflow: hidden; margin-bottom: 8px; border-radius: 14px; }
        .history-item-wrapper { display: flex; width: 200%; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .history-item-content { width: 50%; text-align: right; padding: 8px 12px; border-radius: 14px; background-color: var(--button-bg); transition: background-color 0.2s; cursor: pointer; }
        body[data-theme="dark"] .history-item-content { background-color: #28292c; }
        body[data-theme="crystal"] .history-item-content { background-color: var(--button-bg); }
        .delete-action { width: 50%; display: flex; align-items: center; justify-content: center; background-color: #e74c3c; color: white; border-radius: 14px; cursor: pointer; font-weight: 500;}
        .history-item-wrapper.swiped { transform: translateX(-50%); }
        #history-list li.history-item-enter { animation: newItemAnimation 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .history-expression, .history-result { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; transition: font-size 0.3s ease; }
        .history-expression { color: var(--secondary-text); font-size: 1rem; }
        .history-result { font-size: 1.8rem; font-weight: 500; font-family: 'Lexend', sans-serif; }
        .history-expression.font-small { font-size: 0.8rem; }
        .history-result.font-medium { font-size: 1.4rem; }
        .history-result.font-small { font-size: 1.1rem; }
        .history-item-fly { position: fixed; z-index: 1001; transition: all 0.4s cubic-bezier(0.5, 0, 0.75, 0) !important; text-align: right; border-radius: 14px; padding: 8px 12px; background-color: var(--button-bg); box-shadow: 0 10px 20px rgba(0,0,0,0.2); pointer-events: none; }
        #empty-history-state { display: none; }
        #empty-history-state.visible { display: flex; }
        .display-wrapper { flex-shrink: 0; margin-top: auto; min-height: 110px; display: flex; flex-direction: column; justify-content: flex-end; transition: all 0.2s ease-out; }
        #secondary-display { height: 25px; font-size: 1.2rem; color: var(--secondary-text); text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; transition: opacity 0.3s ease; flex-shrink: 0; }
        .main-display { font-family: 'Lexend', sans-serif; font-weight: 400; line-height: 1.3; color: var(--primary-text); height: auto; max-height: 9.8rem; text-align: right; word-break: break-all; overflow-y: auto; overflow-x: hidden; scrollbar-width: none; cursor: pointer; transition: all 0.2s ease-out, font-size 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); font-size: 3.2rem; }
        .main-display.font-medium { font-size: 2.6rem; }
        .main-display.font-small { font-size: 2.0rem; }
        .main-display.font-xsmall { font-size: 1.6rem; }
        .main-display::-webkit-scrollbar { display: none; }
        .main-display:empty::before { content: "0"; color: var(--secondary-text); opacity: 0.6; display: block; }
        .main-display .char-animated { display: inline-block; animation: char-pop-in 0.15s ease-out; }
        .main-display.result-calculated { animation: result-flash 0.3s ease-in-out; }
        .main-display .token-selected { background-color: rgba(93, 173, 226, 0.25); border-radius: 8px; padding: 2px 4px; animation: pulse 1.5s ease-in-out infinite; }
        .main-display .is-operator, .main-display .is-parenthesis { opacity: 0.85; }
        .calculator { height: var(--keypad-height); padding: var(--spacing) var(--spacing) calc(var(--spacing) + env(safe-area-inset-bottom)); background: var(--keypad-bg); border-top: 1px solid var(--keypad-border); backdrop-filter: blur(var(--backdrop-blur)); -webkit-backdrop-filter: blur(var(--backdrop-blur)); transition: all 0.4s ease; flex-shrink: 0;}
        .keypad-hidden .calculator { height: 0; padding-top: 0; padding-bottom: 0; border-top-color: transparent; overflow: hidden; }
        .keypad { height: 100%; display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); gap: var(--spacing); }
        .keypad button { font-weight: 400; cursor: pointer; background: var(--button-bg); border: 1px solid var(--button-border); display: flex; align-items: center; justify-content: center; font-size: 1.9rem; }
        .keypad .operator { font-size: 2.3rem; font-weight: 400; }
        .keypad .equals { grid-column: span 2; font-weight: 500; }
        #settings-overlay, #help-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        #settings-overlay.visible, #help-overlay.visible { opacity: 1; pointer-events: all; }
        #settings-panel, #help-panel { position: fixed; bottom: 0; left: 0; right: 0; background: var(--keypad-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--keypad-border); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 21; padding: 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); display: flex; flex-direction: column; gap: 16px; transform: translateY(100%); }
        #settings-panel.visible, #help-panel.visible { animation: panel-in 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        #settings-panel.hidden, #help-panel.hidden { animation: panel-out 0.3s ease-out forwards; }
        #help-panel { max-height: 85vh; overflow-y: auto; }
        .settings-gripper, .help-gripper { width: 40px; height: 5px; background: rgba(128, 128, 128, 0.4); border-radius: 2.5px; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); }
        .settings-header, .help-header { text-align: center; color: var(--secondary-text); font-weight: 500; position: relative; padding-top: 15px; font-size: 1.3rem; }
        .settings-header .close-btn, .help-header .close-btn { position: absolute; right: -10px; top: 50%; transform: translateY(-50%); }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; font-size: 1.1rem; }
        .setting-item.disabled { opacity: 0.5; cursor: not-allowed; }
        .setting-item.disabled .switch { pointer-events: none; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(120, 120, 128, 0.3); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--accent-green); }
        input:checked + .slider:before { transform: translateX(22px); }
        .toast { position: fixed; bottom: calc(env(safe-area-inset-bottom, 0px) + 20px); left: 50%; transform: translateX(-50%); background-color: var(--toast-bg); backdrop-filter: blur(10px); color: var(--primary-text); padding: 12px 24px; border-radius: 30px; z-index: 1000; opacity: 0; pointer-events: none; animation-fill-mode: forwards; animation-duration: 0.3s; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .toast.show { animation-name: toast-in; }
        .toast.hide { animation-name: toast-out; }
        .help-section { margin-bottom: 24px; animation: slideDown 0.5s ease-out; }
        .help-section h3 { color: var(--accent-green); font-size: 1.2rem; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .help-section p { color: var(--secondary-text); line-height: 1.6; margin-bottom: 12px; }
        .help-example { background: var(--button-bg); padding: 12px; border-radius: 12px; margin: 8px 0; border-left: 3px solid var(--accent-green); }
        .help-example strong { color: var(--accent-blue); }
        .help-tip { background: rgba(93, 173, 226, 0.1); padding: 10px; border-radius: 8px; margin: 8px 0; font-size: 0.95rem; border-left: 3px solid var(--accent-blue); }
        .help-emoji { font-size: 1.5rem; }
        .help-btn { background-color: var(--accent-blue); color: white; border: none; border-radius: 12px; padding: 12px; font-size: 1.1rem; font-weight: 500; cursor: pointer; width: 100%; text-align: center; margin-top: 8px; }
        .install-btn { background-color: var(--accent-green); color: white; border: none; border-radius: 12px; padding: 12px; font-size: 1.1rem; font-weight: 500; cursor: pointer; width: 100%; text-align: center; margin-top: 8px; display: none; }
        /* MEJORA: Media query para escritorio robustecida */
        @media (min-width: 450px) {
            body { display: flex; justify-content: center; align-items: center; }
            .app-container { max-width: 400px; max-height: 850px; min-height: 600px; width: 100%; height: 95vh; border-radius: 50px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border: 1px solid rgba(255, 255, 255, 0.3); }
            #settings-panel, #help-panel { max-width: 400px; left: 50%; transform: translate(-50%, 100%); }
            .toast { bottom: 40px; }
        }
    </style>
</head>
<body data-theme="dark">
	<audio id="click-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-zapsplat/zapsplat_multimedia_button_click_fast_short_002_79285.mp3" preload="auto"></audio>
    
    <div class="app-container" id="app-container">
        <header class="app-header">
            <button id="theme-cycle-btn" class="control-btn" aria-label="Cambiar tema">
                <svg class="theme-icon theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg class="theme-icon theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg class="theme-icon theme-icon-crystal" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
            </button>
            <div class="app-title">aiDANaI Calculadora</div>
            <button id="settings-btn" class="control-btn" aria-label="Ajustes">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82-.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </header>
        
        <div class="paper-roll-container">
            <div id="empty-history-state"></div>
            <ul id="history-list"></ul>
            <div class="display-wrapper">
                <div id="secondary-display"></div>
                <div class="main-display" id="main-display"></div>
            </div>
        </div>
        
        <div class="calculator">
            <div class="keypad">
                <button class="function" id="clear-btn" data-key="Escape" aria-label="Borrar todo">AC</button>
                <button class="function" id="backspace-btn" data-key="Backspace" aria-label="Borrar">‚å´</button>
                <button class="function" data-key="(" aria-label="Par√©ntesis">( )</button>
                <button class="operator" data-operator="√∑" data-key="/" aria-label="Dividir">√∑</button>
                <button data-key="7">7</button>
                <button data-key="8">8</button>
                <button data-key="9">9</button>
                <button class="operator" data-operator="√ó" data-key="*" aria-label="Multiplicar">√ó</button>
                <button data-key="4">4</button>
                <button data-key="5">5</button>
                <button data-key="6">6</button>
                <button class="operator" data-operator="-" data-key="-" aria-label="Restar">‚àí</button>
                <button data-key="1">1</button>
                <button data-key="2">2</button>
                <button data-key="3">3</button>
                <button class="operator" data-operator="+" data-key="+" aria-label="Sumar">+</button>
                <button data-key="0">0</button>
                <button data-key="." class="operator" aria-label="Coma">,</button>
                <button class="equals" data-key="Enter" aria-label="Igual">=</button>
            </div>
        </div>
        
        <div id="toast" class="toast"></div>
        
        <div id="settings-overlay"></div>
        <div id="settings-panel">
            <div class="settings-gripper"></div>
            <div class="settings-header">
                Ajustes
                <button class="control-btn close-btn" id="close-settings-btn" aria-label="Cerrar ajustes">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="setting-item" id="keypad-toggle-container">
                <span>Mostrar Teclado</span>
                <label class="switch"><input type="checkbox" id="keypad-toggle"><span class="slider"></span></label>
            </div>
            <div class="setting-item">
                <span>Sonido de Teclas</span>
                <label class="switch"><input type="checkbox" id="sound-toggle"><span class="slider"></span></label>
            </div>
            <div class="setting-item">
                <span>Vibraci√≥n T√°ctil</span>
                <label class="switch"><input type="checkbox" id="haptic-toggle"><span class="slider"></span></label>
            </div>
            <button id="show-help-btn" class="help-btn">üìñ Ver Gu√≠a de Uso</button>
            <button id="install-app-btn" class="install-btn">üì• Instalar Aplicaci√≥n</button>
        </div>
        
        <div id="help-overlay"></div>
        <div id="help-panel">
            <div class="help-gripper"></div>
            <div class="help-header">
                Gu√≠a de Uso
                <button class="control-btn close-btn" id="close-help-btn" aria-label="Cerrar ayuda">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="help-section"> <h3><span class="help-emoji">üéØ</span> Lo B√°sico</h3> <p>Esta no es una calculadora cualquiera. Tiene s√∫per poderes ocultos que har√°n tu vida m√°s f√°cil. ¬°Vamos a descubrirlos!</p> </div> <div class="help-section"> <h3><span class="help-emoji">üî¢</span> C√°lculos Normales</h3> <p>Como toda calculadora decente, puedes sumar, restar, multiplicar y dividir.</p> <div class="help-example"> <strong>Ejemplo:</strong> 250 + 175 = 425</div> <div class="help-tip"> üí° <strong>Truco Pro:</strong> La calculadora formatea autom√°ticamente los n√∫meros grandes para que sean m√°s f√°ciles de leer. ¬°Se ve elegante! </div> </div>
            <div class="help-section"> <h3><span class="help-emoji">üß†</span> C√°lculos Avanzados con Par√©ntesis</h3> <p>¬°Ahora tu calculadora es m√°s potente! Usa el bot√≥n <strong>( )</strong> para agrupar operaciones y controlar el orden del c√°lculo, como en matem√°ticas.</p> <div class="help-example"> <strong>Sin par√©ntesis:</strong> 10 + 5 √ó 2 = 20<br> <strong>Con par√©ntesis:</strong> (10 + 5) √ó 2 = 30</div> <div class="help-tip"> üí° <strong>El bot√≥n ( ) es inteligente:</strong> La app decide si poner ( o ) seg√∫n lo que necesites. Adem√°s, si lo pulsas despu√©s de un n√∫mero, ¬°a√±adir√° '√ó' por ti! Por ejemplo, <strong>5(2+2)</strong> se calcular√° como <strong>5 √ó (2 + 2)</strong>. </div> </div>
            <div class="help-section"> <h3><span class="help-emoji">üìú</span> El Rollo de Papel M√°gico</h3> <p>Cada vez que haces un c√°lculo, se guarda en el historial de arriba. Es como tener un rollo de papel infinito donde puedes ver todo lo que has calculado.</p> <div class="help-example"> <strong>¬øPara qu√© sirve?</strong><br> ‚Ä¢ Reutilizar resultados anteriores<br> ‚Ä¢ Revisar tus c√°lculos</div> </div>
            <div class="help-section"> <h3><span class="help-emoji">‚ú®</span> Magia del Historial</h3> <p>Aqu√≠ viene lo BUENO. Toca cualquier c√°lculo del historial y...</p> <div class="help-example"> <strong>¬°POOF!</strong> üé©‚ú®<br> El resultado vuela hasta la pantalla principal y puedes seguir operando con √©l.</div> <div class="help-tip"> üí° <strong>Caso de uso:</strong> Calculaste 450 + 320 = 770. Ahora quieres multiplicar ese 770 por 3. Solo toca el resultado en el historial, y presiona √ó 3 = </div> </div>
            <div class="help-section"> <h3><span class="help-emoji">üëÜ</span> Trucos con Toques</h3> <p><strong>Doble-Toque para Editar:</strong> ¬øTe equivocaste en un d√≠gito? Haz <strong>doble-toque</strong> r√°pido sobre un n√∫mero en la pantalla para seleccionarlo. Escribe encima para corregirlo sin borrar todo.</p> <div class="help-example"> <strong>Ejemplo:</strong> Escribiste 1234 pero quer√≠as 1235. Doble-toque en el 1234, escribe 5, y listo.</div> <p style="margin-top: 15px;"><strong>Pulsaci√≥n Larga para Copiar:</strong> Mant√©n presionado el resultado en pantalla por un segundo y se copiar√° al portapapeles. ¬°Perfecto para enviarlo por WhatsApp!</p> </div>
            <div class="help-section"> <h3><span class="help-emoji">üëà</span> Gestos R√°pidos</h3> <p>¬øEse c√°lculo del historial ya no te sirve? Desliza el item hacia la izquierda y aparecer√° un bot√≥n "Eliminar". Es como borrar un email. R√°pido y satisfactorio.</p></div>
            <div class="help-section"> <h3><span class="help-emoji">‚ù§Ô∏è</span> Creada para ti</h3> <p>Esta calculadora fue dise√±ada para ser intuitiva, bonita y s√∫per funcional. Si tienes ideas para mejorarla, ¬°comp√°rtelas!</p><p>Puedes enviar tus sugerencias a:<br><strong>1973aidanai1973@gmail.com</strong></p></div>
        </div>
    </div>

    <script>
        const DOMElements = { body: document.body, mainDisplay: document.getElementById('main-display'), secondaryDisplay: document.getElementById('secondary-display'), historyList: document.getElementById('history-list'), emptyHistoryState: document.getElementById('empty-history-state'), keypad: document.querySelector('.keypad'), clearBtn: document.getElementById('clear-btn'), toast: document.getElementById('toast'), settingsPanel: document.getElementById('settings-panel'), settingsOverlay: document.getElementById('settings-overlay'), helpPanel: document.getElementById('help-panel'), helpOverlay: document.getElementById('help-overlay'), themeCycleBtn: document.getElementById('theme-cycle-btn'), keypadToggle: document.getElementById('keypad-toggle'), keypadToggleContainer: document.getElementById('keypad-toggle-container'), soundToggle: document.getElementById('sound-toggle'), hapticToggle: document.getElementById('haptic-toggle'), showHelpBtn: document.getElementById('show-help-btn'), installBtn: document.getElementById('install-app-btn') };
        const app = { expression: '', history: [], justCalculated: false, selectedToken: { index: null, value: '' }, settings: { theme: 'dark', sound: true, haptics: true, keypadVisible: true } };
        const themeOrder = ['dark', 'crystal', 'light'];
        const themeNames = { dark: 'Tema Oscuro', crystal: 'Tema Crystal', light: 'Tema Claro' };
        let toastTimeout, lastTapTime = 0, longPressTimeout, lastClearTapTime = 0;
        let deferredInstallPrompt = null;

        const playClickSound = () => { if (app.settings.sound) document.getElementById('click-sound').play().catch(() => {}); };
        const hapticFeedback = (style = 'light') => { const intensity = { light: 20, medium: 40, heavy: 60 }; if (app.settings.haptics && 'vibrate' in navigator) navigator.vibrate(intensity[style] || 20); };
        const formatNumberWithSeparators = (numStr) => { const [integerPart, decimalPart] = numStr.split(','); const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, "."); return decimalPart !== undefined ? `${formattedInteger},${decimalPart}` : formattedInteger; };
        const showToast = (message) => { clearTimeout(toastTimeout); DOMElements.toast.textContent = message; DOMElements.toast.className = 'toast show'; toastTimeout = setTimeout(() => { DOMElements.toast.className = 'toast hide'; }, 2000); };
        const simulateKeyPress = (key) => { const button = document.querySelector(`button[data-key="${key}"]`); if (button) { button.classList.add('key-pressed'); setTimeout(() => button.classList.remove('key-pressed'), 150); } };
        const updateActiveOperator = (operator = null) => { document.querySelectorAll('.operator-active').forEach(btn => btn.classList.remove('operator-active')); if (operator) { const operatorButton = document.querySelector(`button[data-operator="${operator}"]`); if (operatorButton) operatorButton.classList.add('operator-active'); } };
        const adjustDisplayFontSize = () => { const display = DOMElements.mainDisplay; const textLength = display.innerText.length; display.classList.remove('font-medium', 'font-small', 'font-xsmall'); if (textLength > 20) display.classList.add('font-xsmall'); else if (textLength > 15) display.classList.add('font-small'); else if (textLength > 10) display.classList.add('font-medium'); };
        
        const updateDisplay = () => {
            clearSelection();
            const tokens = app.expression.match(/(\d+\.\d+|\d+|[+\-√ó√∑()])/g) || [];
            let html = tokens.map((token, index) => {
                const isOperator = /[+\-√ó√∑]/.test(token);
                const isParenthesis = /[()]/.test(token);
                let displayToken = token;
                if (!isOperator && !isParenthesis) {
                    displayToken = formatNumberWithSeparators(token.replace(/\./g, ','));
                } else {
                    displayToken = ` ${token} `;
                }
                const tokenClass = isOperator ? 'is-operator' : (isParenthesis ? 'is-parenthesis' : '');
                return `<span class="token ${tokenClass}" data-index="${index}">${displayToken}</span>`;
            }).join('');
            DOMElements.mainDisplay.innerHTML = html;
            DOMElements.mainDisplay.scrollTop = DOMElements.mainDisplay.scrollHeight;
            DOMElements.clearBtn.textContent = app.expression ? 'C' : 'AC';
            if (!app.expression) updateActiveOperator();
            adjustDisplayFontSize();
        };

        const animateLastChar = () => { const lastToken = DOMElements.mainDisplay.querySelector('.token:last-child'); if (lastToken) { const text = lastToken.textContent.trim(); const rest = text.slice(0, -1); const lastChar = text.slice(-1); lastToken.innerHTML = ` ${rest}<span class="char-animated">${lastChar}</span> `; } };
        const clearSelection = () => { app.selectedToken.index = null; app.selectedToken.value = ''; const selected = DOMElements.mainDisplay.querySelector('.token-selected'); if (selected) selected.classList.remove('token-selected'); };
        const handleParenthesis = () => { if (app.justCalculated) { app.expression = ''; app.justCalculated = false; } const openParenCount = (app.expression.match(/\(/g) || []).length; const closeParenCount = (app.expression.match(/\)/g) || []).length; const lastChar = app.expression.slice(-1); if (openParenCount > closeParenCount && (/\d/.test(lastChar) || lastChar === ')')) { app.expression += ')'; } else { if (/\d/.test(lastChar) || lastChar === ')') { app.expression += '√ó('; } else { app.expression += '('; } } updateDisplay(); animateLastChar(); };

        // MEJORA: L√≥gica de entrada centralizada y robustecida
        const appendSymbol = (symbol) => {
            if (app.selectedToken.index !== null) { clearSelection(); }
            if (app.justCalculated) { DOMElements.secondaryDisplay.innerText = ''; if (!/[+\-√ó√∑]/.test(symbol)) { app.expression = ''; } app.justCalculated = false; DOMElements.mainDisplay.classList.remove('result-calculated'); }
            const lastChar = app.expression.slice(-1);

            if (symbol === '.') {
                if (!/\d/.test(lastChar) && lastChar !== ')') { app.expression += '0.'; } 
                else if (!app.expression.split(/[+\-√ó√∑(]/).pop().includes('.')) { app.expression += '.'; }
            } else if (/[0-9]/.test(symbol)) {
                if (lastChar === ')') { app.expression += `√ó${symbol}`; } 
                else { app.expression += symbol; }
            } else if (/[+\-√ó√∑]/.test(symbol)) {
                if (app.expression === '' && symbol !== '-') return;
                if (/[+\-√ó√∑]/.test(lastChar)) { app.expression = app.expression.slice(0, -1) + symbol; } 
                else if (lastChar !== '(') { app.expression += symbol; }
                updateActiveOperator(symbol);
            }
            updateDisplay();
            animateLastChar();
        };

        const backspace = () => { DOMElements.mainDisplay.classList.remove('result-calculated'); updateActiveOperator(); if (app.selectedToken.index !== null) { const tokens = app.expression.match(/(\d+\.\d+|\d+|[+\-√ó√∑()])/g) || []; tokens.splice(app.selectedToken.index, 1); app.expression = tokens.join(''); clearSelection(); } else { if (app.expression) app.expression = app.expression.slice(0, -1); } if (app.justCalculated) DOMElements.secondaryDisplay.innerText = ''; app.justCalculated = false; updateDisplay(); };
        const clear = () => { DOMElements.mainDisplay.classList.remove('result-calculated'); const now = Date.now(); if (app.expression !== '') { app.expression = ''; } else { if (now - lastClearTapTime < 400) { app.history = []; saveSettings(); renderHistory(); showToast('‚ú® Historial borrado'); hapticFeedback('heavy'); } else { showToast('Pulsa de nuevo para borrar historial'); } } lastClearTapTime = now; DOMElements.secondaryDisplay.innerText = ''; app.justCalculated = false; clearSelection(); updateDisplay(); };
        const calculate = () => { if (!app.expression || /[+\-√ó√∑(]$/.test(app.expression.slice(-1))) return; updateActiveOperator(); try { let evalExpr = app.expression.replace(/√ó/g, '*').replace(/√∑/g, '/'); const result = parseFloat(Number(new Function('return ' + evalExpr)()).toPrecision(15)); if (isNaN(result) || !isFinite(result)) { throw new Error('Resultado no v√°lido'); } const displayExpression = app.expression.replace(/\*/g, '√ó').replace(/\//g, '√∑'); const resultString = String(result); addToHistory(app.expression, resultString, displayExpression); DOMElements.secondaryDisplay.innerText = `${formatNumberWithSeparators(displayExpression.replace(/\./g,','))} =`; app.expression = resultString; app.justCalculated = true; updateDisplay(); DOMElements.mainDisplay.classList.add('result-calculated'); } catch (error) { showToast('‚ö†Ô∏è Expresi√≥n no v√°lida'); hapticFeedback('heavy'); DOMElements.mainDisplay.classList.add('display-error'); setTimeout(() => DOMElements.mainDisplay.classList.remove('display-error'), 500); app.expression = ''; app.justCalculated = false; updateDisplay(); } };
        
        // --- Toda la l√≥gica de Renderizado e Historial se mantiene intacta ---
        const renderHistory = () => { DOMElements.historyList.innerHTML = ''; DOMElements.emptyHistoryState.classList.toggle('visible', app.history.length === 0); app.history.forEach((item, index) => createHistoryElement(item, index)); };
        const createHistoryElement = (item, index, prepend = false) => { const li = document.createElement('li'); li.dataset.index = index; li.innerHTML = ` <div class="history-item-wrapper"> <div class="history-item-content"> <div class="history-expression">${formatNumberWithSeparators(item.display.replace(/\./g, ','))} =</div> <div class="history-result">${formatNumberWithSeparators(item.result.replace('.',','))}</div> </div> <div class="delete-action" data-action="delete">Eliminar</div> </div>`; const resultDiv = li.querySelector('.history-result'); const expressionDiv = li.querySelector('.history-expression'); const resultLength = item.result.length; if (resultLength > 14) { resultDiv.classList.add('font-small'); } else if (resultLength > 9) { resultDiv.classList.add('font-medium'); } if (item.display.length > 25) { expressionDiv.classList.add('font-small'); } if (prepend) { li.classList.add('history-item-enter'); DOMElements.historyList.prepend(li); DOMElements.historyList.scrollTop = 0; } else { DOMElements.historyList.appendChild(li); } };
        const addToHistory = (expression, result, display) => { const newItem = { expression, result, display }; app.history.unshift(newItem); if (app.history.length > 50) app.history.pop(); saveSettings(); DOMElements.emptyHistoryState.classList.remove('visible'); renderHistory(); };
        const toggleSettings = (show) => { if (show) { DOMElements.settingsPanel.classList.add('visible'); DOMElements.settingsOverlay.classList.add('visible'); DOMElements.settingsPanel.classList.remove('hidden'); } else { DOMElements.settingsPanel.classList.add('hidden'); DOMElements.settingsOverlay.classList.remove('visible'); } };
        const toggleHelp = (show) => { if (show) { DOMElements.helpPanel.classList.add('visible'); DOMElements.helpOverlay.classList.add('visible'); DOMElements.helpPanel.classList.remove('hidden'); toggleSettings(false); } else { DOMElements.helpPanel.classList.add('hidden'); DOMElements.helpOverlay.classList.remove('visible'); } };
        const applySettings = () => { DOMElements.body.dataset.theme = app.settings.theme; DOMElements.body.classList.toggle('keypad-hidden', !app.settings.keypadVisible); DOMElements.keypadToggle.checked = app.settings.keypadVisible; DOMElements.soundToggle.checked = app.settings.sound; DOMElements.hapticToggle.checked = app.settings.haptics; };
        const saveSettings = () => { try { localStorage.setItem('aiDANaICalcSettingsV5', JSON.stringify({ ...app.settings, history: app.history })); } catch (e) { console.error("Error al guardar ajustes:", e); } };
        const loadSettings = () => { try { const saved = localStorage.getItem('aiDANaICalcSettingsV5'); if (saved) { const parsed = JSON.parse(saved); Object.assign(app.settings, parsed); app.history = parsed.history || []; } } catch (e) { console.error("Error al cargar ajustes:", e); app.history = []; } applySettings(); renderHistory(); updateDisplay(); };
        const cycleTheme = () => { hapticFeedback(); playClickSound(); const currentThemeIndex = themeOrder.indexOf(app.settings.theme); const nextThemeIndex = (currentThemeIndex + 1) % themeOrder.length; app.settings.theme = themeOrder[nextThemeIndex]; applySettings(); saveSettings(); showToast(themeNames[app.settings.theme]); };

        // --- MEJORA ARQUITECT√ìNICA: Funci√≥n √önica de Entrada ---
        const handleInput = (key) => {
            simulateKeyPress(key);
            hapticFeedback();
            playClickSound();

            switch (key) {
                case 'Enter': calculate(); break;
                case 'Backspace': backspace(); break;
                case 'Escape': clear(); break;
                case '(': handleParenthesis(); break;
                default: appendSymbol(key); break;
            }
        };

        const setupEventListeners = () => {
            // MEJORA: El click ahora solo obtiene la tecla y llama al manejador central
            DOMElements.keypad.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (!button || !button.dataset.key) return;
                const key = button.dataset.key;
                
                // Excluimos la vibraci√≥n/sonido del click para que no se duplique
                if (key ==='(') { handleParenthesis(); hapticFeedback(); playClickSound();}
                else if (['Enter', 'Backspace', 'Escape'].includes(key)) { handleInput(key);}
                else { handleInput(button.dataset.operator || key); }
            });
            
            const keyMap = { '0':'0', '1':'1', '2':'2', '3':'3', '4':'4', '5':'5', '6':'6', '7':'7', '8':'8', '9':'9', '+':'+', '-':'-', '*':'*', '/': '/', '.':'.', ',':'.', 'Enter': 'Enter', '=': 'Enter', 'Backspace':'Backspace', 'Escape':'Escape', 'Delete':'Escape', '(': '(', ')': '(' };
            
            // MEJORA: Keydown ahora llama al manejador central, asegurando 100% de consistencia
            document.addEventListener('keydown', e => { 
                if (DOMElements.settingsPanel.classList.contains('visible') || DOMElements.helpPanel.classList.contains('visible')) return; 
                const key = keyMap[e.key];
                if(key) { 
                    e.preventDefault(); 
                    handleInput(key);
                } 
            });

            // --- El resto de listeners no necesitan cambios ---
            DOMElements.mainDisplay.addEventListener('touchstart', e => { e.preventDefault(); longPressTimeout = setTimeout(() => { const textToCopy = DOMElements.mainDisplay.textContent.trim(); if (textToCopy && textToCopy !== '0' && navigator.clipboard) { navigator.clipboard.writeText(textToCopy.replace(/\./g, '').replace(/,/g, '.')).then(() => { showToast('üìã Copiado al portapapeles'); hapticFeedback('medium'); }).catch(err => showToast('‚ùå Error al copiar')); } }, 600); }, { passive: false });
            DOMElements.mainDisplay.addEventListener('touchend', () => clearTimeout(longPressTimeout));
            DOMElements.mainDisplay.addEventListener('touchmove', () => clearTimeout(longPressTimeout));
            DOMElements.mainDisplay.addEventListener('mousedown', e => { if(e.button !== 0) return; longPressTimeout = setTimeout(() => { const textToCopy = DOMElements.mainDisplay.textContent.trim(); if (textToCopy && textToCopy !== '0' && navigator.clipboard) { navigator.clipboard.writeText(textToCopy.replace(/\./g, '').replace(/,/g, '.')).then(() => { showToast('üìã Copiado al portapapeles'); hapticFeedback('medium'); }).catch(err => showToast('‚ùå Error al copiar')); } }, 600); });
            DOMElements.mainDisplay.addEventListener('mouseup', () => clearTimeout(longPressTimeout));
            DOMElements.mainDisplay.addEventListener('mouseleave', () => clearTimeout(longPressTimeout));
            DOMElements.mainDisplay.addEventListener('click', e => { clearTimeout(longPressTimeout); const targetToken = e.target.closest('.token'); const now = Date.now(); if (targetToken && now - lastTapTime < 300) { hapticFeedback(); const index = parseInt(targetToken.dataset.index, 10); const tokens = app.expression.match(/(\d+\.\d+|\d+|[+\-√ó√∑()])/g) || []; const tokenValue = tokens[index]; if (!/[+\-√ó√∑()]/.test(tokenValue)) { document.querySelectorAll('.token-selected').forEach(el => el.classList.remove('token-selected')); targetToken.classList.add('token-selected'); app.selectedToken = { index, value: tokenValue }; showToast('‚úèÔ∏è N√∫mero seleccionado'); } } else { clearSelection(); } lastTapTime = now; });
            let touchStartX = 0, currentSwipedItem = null; DOMElements.historyList.addEventListener('touchstart', e => { const li = e.target.closest('li'); if (!li) return; if (currentSwipedItem && currentSwipedItem !== li) { currentSwipedItem.querySelector('.history-item-wrapper').classList.remove('swiped'); } touchStartX = e.changedTouches[0].clientX; currentSwipedItem = li; li.querySelector('.history-item-wrapper').style.transition = 'transform 0s'; }, { passive: true }); DOMElements.historyList.addEventListener('touchmove', e => { if (!currentSwipedItem) return; const touchCurrentX = e.changedTouches[0].clientX; const diffX = touchCurrentX - touchStartX; if (diffX < 0 && diffX > -150) { currentSwipedItem.querySelector('.history-item-wrapper').style.transform = `translateX(${diffX}px)`; } }, { passive: true }); DOMElements.historyList.addEventListener('touchend', e => { if (!currentSwipedItem) return; const wrapper = currentSwipedItem.querySelector('.history-item-wrapper'); wrapper.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)'; const transformMatrix = new WebKitCSSMatrix(window.getComputedStyle(wrapper).transform); if (transformMatrix.m41 < -50) { wrapper.classList.add('swiped'); hapticFeedback('light'); } else { wrapper.classList.remove('swiped'); currentSwipedItem = null; } }); DOMElements.historyList.addEventListener('click', e => { const target = e.target; const li = target.closest('li'); if (!li) return; if (target.dataset.action === 'delete') { const indexToDelete = Array.from(li.parentNode.children).reverse().indexOf(li); app.history.splice(indexToDelete, 1); saveSettings(); renderHistory(); showToast('üóëÔ∏è C√°lculo eliminado'); hapticFeedback('medium'); return; } const itemContent = target.closest('.history-item-content'); if (itemContent) { const index = Array.from(li.parentNode.children).reverse().indexOf(li); const clickedItem = app.history[index]; animateHistoryToDisplay(itemContent, clickedItem); } });
            const animateHistoryToDisplay = (element, item) => { const rect = element.getBoundingClientRect(); const displayRect = DOMElements.mainDisplay.getBoundingClientRect(); const flyingClone = element.cloneNode(true); flyingClone.classList.add('history-item-fly'); flyingClone.style.top = `${rect.top}px`; flyingClone.style.left = `${rect.left}px`; flyingClone.style.width = `${rect.width}px`; flyingClone.style.height = `${rect.height}px`; document.body.appendChild(flyingClone); hapticFeedback(); requestAnimationFrame(() => { flyingClone.style.top = `${displayRect.top + (displayRect.height / 2)}px`; flyingClone.style.left = `${displayRect.right - 50}px`; flyingClone.style.transform = 'scale(0.3)'; flyingClone.style.opacity = '0'; }); setTimeout(() => { flyingClone.remove(); app.expression = item.result; app.justCalculated = false; DOMElements.secondaryDisplay.innerText = ''; DOMElements.mainDisplay.classList.remove('result-calculated'); updateDisplay(); }, 400); };
            document.getElementById('settings-btn').addEventListener('click', () => toggleSettings(true)); document.getElementById('close-settings-btn').addEventListener('click', () => toggleSettings(false)); DOMElements.settingsOverlay.addEventListener('click', () => { toggleSettings(false); toggleHelp(false); });
            DOMElements.showHelpBtn.addEventListener('click', () => toggleHelp(true)); document.getElementById('close-help-btn').addEventListener('click', () => toggleHelp(false)); DOMElements.helpOverlay.addEventListener('click', () => toggleHelp(false));
            DOMElements.themeCycleBtn.addEventListener('click', cycleTheme);
            DOMElements.keypadToggle.addEventListener('change', e => { app.settings.keypadVisible = e.target.checked; applySettings(); saveSettings(); }); DOMElements.soundToggle.addEventListener('change', e => { app.settings.sound = e.target.checked; saveSettings(); if (e.target.checked) playClickSound(); }); DOMElements.hapticToggle.addEventListener('change', e => { app.settings.haptics = e.target.checked; saveSettings(); if (e.target.checked) hapticFeedback('medium'); });
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredInstallPrompt = e; if (!window.matchMedia('(display-mode: standalone)').matches) { DOMElements.installBtn.style.display = 'block'; } }); DOMElements.installBtn.addEventListener('click', () => { DOMElements.installBtn.style.display = 'none'; if (deferredInstallPrompt) { deferredInstallPrompt.prompt(); deferredInstallPrompt.userChoice.then(() => { deferredInstallPrompt = null; }); } });
        };
        const init = () => { const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0; if (isMobile) { DOMElements.keypadToggleContainer.classList.add('disabled'); DOMElements.keypadToggle.disabled = true; app.settings.keypadVisible = true; } loadSettings(); setupEventListeners(); };
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>