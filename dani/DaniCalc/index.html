<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#eef2f5" media="(prefers-color-scheme: light)">
    
    <meta name="description" content="aiDANaI Financial Suite">
    <title>aiDANaI</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Lexend:wght@300;400;500;700&family=Poppins:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
   <style>
    :root { 
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
        --header-height: 60px; 
        
        --neon-red: #ff0033; 
        --neon-cyan: #00f2ff;
        --neon-lime: #ccff00;
        --neon-yellow: #ffff00;
        
        --crypto-up: #00ff9d;
        --crypto-down: #ff0033;
    }

    body { overscroll-behavior: none; touch-action: none; } 
    #history-list, .crypto-content { overscroll-behavior: contain; touch-action: pan-y; }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
    
    button, .card, li { touch-action: manipulation; }

    .tabular-nums { font-variant-numeric: tabular-nums; letter-spacing: -0.5px; }
    .small-decimal { font-size: 0.75em; vertical-align: baseline; opacity: 0.85; margin-left: 0px; font-weight: 400; }

    /* === ANIMACIONES COMBINADAS (Lo mejor de ambos) === */
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Flash de pantalla (Feedback de tecla) */
    @keyframes screenFlash { 0% { box-shadow: inset 0 0 0 rgba(0,0,0,0); } 50% { box-shadow: inset 0 0 60px var(--flash-color); } 100% { box-shadow: inset 0 0 0 rgba(0,0,0,0); } }
    
    /* Shake (Feedback de Error - Importado de Geminis) */
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    .shake-active { animation: shake 0.3s ease-in-out; }

    /* Pop (Feedback de √âxito - Importado de AIStudio) */
    @keyframes popScale { 0% { transform: scale(1); } 50% { transform: scale(1.08); color: var(--primary-text); } 100% { transform: scale(1); } }
    .pop-active { animation: popScale 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    /* Shimmer (Feedback de Carga Crypto) */
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

    /* ================= TEMA OSCURO ================= */
    body[data-theme="dark"] { 
        --bg-body: #000000;
        --bg-gradient: radial-gradient(circle at 50% 0%, #1a0505 0%, #000000 70%);
        --chassis-bg: #050505;
        --chassis-border: 1px solid #222;
        --screen-bg: #000000;
        --screen-inset: inset 0 0 30px rgba(0,0,0,1);
        --screen-border: 1px solid rgba(255, 0, 51, 0.2);
        --screen-glow: 0 0 20px rgba(255, 0, 51, 0.05);
        --primary-text: #ffffff;
        --secondary-text: #888;
        --clock-text: var(--neon-yellow);
        --clock-glow: 0 0 15px rgba(255, 255, 0, 0.7);
        --history-op-color: #00f2ff;
        --history-res-color: #39ff14;
        --history-opacity: 0.9;
        --history-glow: 0 0 8px rgba(0, 242, 255, 0.3);
        --btn-bg: linear-gradient(160deg, #333333 0%, #000000 100%);
        --btn-border: 1px solid rgba(255,255,255,0.08);
        --btn-shadow: inset 0 1px 0 rgba(255,255,255,0.35), 0 6px 0 #000000, 0 8px 20px rgba(0,0,0,0.8);
        --btn-shadow-active: inset 0 10px 20px rgba(0,0,0,1), 0 0 0 #000000, 0 0 0 rgba(0,0,0,0);
        --btn-text: #dddddd;
        --accent-blue-text: var(--neon-cyan);
        --accent-red-text: var(--neon-red);
        --accent-green-bg: linear-gradient(180deg, #ccff00 0%, #4caf50 100%);
        --text-glow-blue: 0 0 15px rgba(0, 242, 255, 0.7);
        --text-glow-red: 0 0 15px rgba(255, 0, 51, 0.7);
        --card-bg: rgba(20, 20, 20, 0.85);
        --card-border: 1px solid rgba(255,255,255,0.1);
        --edit-highlight: rgba(255, 0, 51, 0.15);
        --flash-color: rgba(255, 0, 51, 0.3);
        --op-active-bg: #ffffff;
        --op-active-color: #000000;
    }

    /* ================= TEMA CLARO ================= */
    body[data-theme="light"] { 
        --bg-body: #eef2f5;
        --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        --chassis-bg: #eef2f5;
        --chassis-border: 1px solid rgba(255,255,255,0.8);
        --screen-bg: #e6e9ef;
        --screen-inset: inset 4px 4px 8px #cbced1, inset -4px -4px 8px #ffffff;
        --screen-border: 1px solid #fff;
        --screen-glow: none;
        --primary-text: #2d3436;
        --secondary-text: #636e72;
        --clock-text: #b7950b; 
        --clock-glow: none;
        --history-op-color: #0044ff;
        --history-res-color: #008f39;
        --history-opacity: 1;
        --history-glow: none;
        --btn-bg: linear-gradient(145deg, #ffffff, #d1d9e6);
        --btn-border: 1px solid #fff;
        --btn-shadow: 0 6px 0 #b1b5be, 0 10px 20px rgba(0,0,0,0.1);
        --btn-shadow-active: inset 0 3px 5px rgba(0,0,0,0.1), 0 0 0 #b1b5be, 0 0 0 rgba(0,0,0,0);
        --btn-text: #4a5568;
        --accent-blue-text: #0984e3;
        --accent-red-text: #ff0033;
        --accent-green-bg: linear-gradient(145deg, #55efc4, #00b894);
        --text-glow-blue: none;
        --text-glow-red: none;
        --card-bg: rgba(255,255,255,0.7);
        --card-border: 1px solid #fff;
        --edit-highlight: rgba(255, 0, 51, 0.1);
        --flash-color: rgba(0,0,0,0.05);
        --op-active-bg: #2d3436;
        --op-active-color: #ffffff;
    }

    html, body { height: 100dvh; width: 100vw; font-family: 'Poppins', sans-serif; overflow: hidden; background-color: var(--bg-body); transition: background 0.4s ease; }
    .view-container { width: 100%; height: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column; background: var(--bg-gradient); }

    .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transform: scale(0.95); transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .view.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 10; }

    /* HEADER */
    .app-header { flex: 0 0 auto; display: flex; align-items: center; justify-content: space-between; padding: max(var(--safe-top), 10px) 15px 5px; z-index: 20; gap: 10px; height: calc(var(--header-height) + var(--safe-top)); width: 100%; }
    
    .embedded-ui { 
        background: var(--card-bg); 
        backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 16px; 
        display: flex; align-items: center; justify-content: center; 
        border: var(--card-border); transition: 0.2s; flex-shrink: 0; 
    }

    .icon-btn { width: 44px; height: 44px; cursor: pointer; color: var(--secondary-text); padding: 10px; position: relative; overflow: hidden; }
    .icon-btn:active { transform: scale(0.95); }
    
    .icon-swap svg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: opacity 0.3s, transform 0.3s; }
    .icon-swap .hidden { opacity: 0; transform: translate(-50%, -40%); pointer-events: none; }
    .icon-swap .shown { opacity: 1; transform: translate(-50%, -50%); }

    /* ESTILO MODIFICADO PARA TITULO ROJO BRILLANTE */
    .app-title { 
        font-family: 'Lexend', sans-serif; font-weight: 800; font-size: 1.2rem; 
        /* Color Rojo Brillante Puro */
        color: #ff0033 !important; 
        background: none !important;
        -webkit-text-fill-color: initial !important;
        
        /* Glow Efecto Ne√≥n */
        text-shadow: 0 0 10px rgba(255, 0, 51, 0.8), 0 0 20px rgba(255, 0, 51, 0.4);
        
        flex-grow: 1; text-align: center; text-decoration: none; 
        display: flex; justify-content: center; align-items: center; height: 44px; letter-spacing: 2px; 
    }
    
    #clock, #clock-crypto { 
        font-family: 'Fira Code', monospace; font-weight: 700; font-size: 0.8rem; 
        color: var(--clock-text); text-shadow: var(--clock-glow);
        padding: 0 12px; min-width: 80px; text-align: center; height: 44px; 
    }

    /* PANTALLA CALCULADORA */
    .upper-section { flex: 1 1 40%; display: flex; flex-direction: column; padding: 15px 20px; min-height: 0; justify-content: flex-end; }
    
    .display-lens { 
        width: 100%; flex: 1; 
        background: var(--screen-bg); 
        box-shadow: var(--screen-inset), var(--screen-glow);
        border: var(--screen-border); border-radius: 24px; 
        display: flex; flex-direction: column; padding: 20px; position: relative; overflow: hidden; 
        transition: all 0.3s ease;
    }
    .display-lens::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: linear-gradient(45deg, rgba(255,255,255,0) 40%, rgba(255,255,255,0.02) 50%, rgba(255,255,255,0) 60%);
        pointer-events: none; transform: rotate(25deg);
    }
    .display-lens.pulse-active { animation: screenFlash 0.15s ease-out; }
    
    #history-list { 
        flex: 1; overflow-y: auto; padding: 5px; 
        display: flex; flex-direction: column-reverse; 
        list-style: none; gap: 8px; mask-image: linear-gradient(to top, black 85%, transparent 100%); scrollbar-width: none; 
    }
    #history-list li { 
        text-align: right; cursor: pointer; opacity: var(--history-opacity); 
        font-family: 'Inter', sans-serif; font-size: 1.1rem; 
        color: var(--history-op-color); text-shadow: var(--history-glow);
        animation: slideIn 0.3s ease; padding: 4px 8px; border-radius: 6px; transition: all 0.2s; font-weight: 500;
    }
    #history-list li:hover { opacity: 1; background: var(--edit-highlight); transform: scale(1.02) translateX(-5px); }
    #history-list b { color: var(--history-res-color); font-weight: 700; margin-left: 8px; }
    
    .display-area { flex-shrink: 0; text-align: right; padding-top: 10px; display: flex; flex-direction: column; justify-content: flex-end; min-height: 90px; z-index: 2; width: 100%; overflow: hidden; }
    
    #secondary-display { font-family: 'Fira Code', monospace; color: var(--accent-blue-text); text-shadow: var(--text-glow-blue); min-height: 1.5rem; font-size: 1.1rem; opacity: 0; transition: opacity 0.2s; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-bottom: 5px; }
    #secondary-display.visible { opacity: 1; }
    
    #main-display { 
        font-family: 'Lexend', sans-serif; 
        color: var(--primary-text); 
        font-size: 3.2rem; font-weight: 500; line-height: 1.1; 
        width: 100%;
        text-align: right;
        white-space: nowrap; 
        overflow-x: auto; 
        overflow-y: hidden;
        scrollbar-width: none; 
        -ms-overflow-style: none; 
        text-shadow: 0 0 25px rgba(255,255,255,0.15); 
        transition: color 0.2s, font-size 0.1s ease-out;
        padding-bottom: 2px;
    }
    #main-display::-webkit-scrollbar { display: none; }

    /* TECLADO */
    .calculator-body { 
        flex: 1 1 60%; width: 100%; 
        background: var(--chassis-bg); border-top: var(--chassis-border);
        border-radius: 35px 35px 0 0; z-index: 10; 
        padding: 25px; padding-bottom: max(25px, var(--safe-bottom)); 
        box-shadow: 0 -20px 60px rgba(0,0,0,0.4);
        display: flex; flex-direction: column; justify-content: center; 
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }
    .keypad { flex: 1; width: 100%; display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); gap: 15px; align-items: center; justify-items: center; }

    .btn { 
        background: var(--btn-bg); color: var(--btn-text); 
        box-shadow: var(--btn-shadow); border: var(--btn-border);
        font-family: 'Lexend', sans-serif; cursor: pointer; 
        display: flex; align-items: center; justify-content: center; 
        border-radius: 20px; width: 100%; height: 100%; 
        font-size: 1.4rem; font-weight: 500; 
        position: relative; transition: transform 0.1s, box-shadow 0.1s, color 0.1s, background 0.1s;
    }
    
    .btn::before { content: ''; position: absolute; top: -8px; bottom: -8px; left: -8px; right: -8px; z-index: 0; }
    
    .btn.btn-large { grid-column: span 2; border-radius: 24px; }
    .btn:active, .btn.btn-active { box-shadow: var(--btn-shadow-active); transform: translateY(6px); color: var(--primary-text); }

    /* Estado activo del operador (Memoria Visual) */
    .btn.op-active {
        background: var(--op-active-bg);
        color: var(--op-active-color);
        box-shadow: inset 0 3px 5px rgba(0,0,0,0.2);
        text-shadow: none;
        transform: translateY(1px);
    }

    .btn[data-key="AC"], .btn[data-key="Backspace"] { color: var(--accent-red-text); text-shadow: var(--text-glow-red); font-weight: 700; }
    .token-op, .btn[data-color="blue"] { color: var(--accent-blue-text); text-shadow: var(--text-glow-blue); font-weight: 600; font-size: 1.6rem; }
    .btn[data-color="green"] { background: var(--accent-green-bg); color: #000; border: none; box-shadow: 0 6px 0 #33691e, 0 10px 20px rgba(100, 255, 0, 0.3); }
    .btn[data-color="green"]::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: linear-gradient(to bottom, rgba(255,255,255,0.5) 0%, transparent 100%); border-radius: 20px 20px 50% 50%; opacity: 0.6; pointer-events: none; }
    .btn[data-color="green"]:active { box-shadow: inset 0 5px 15px rgba(0,0,0,0.5); transform: translateY(6px); }

    /* CRYPTO COMPACTO */
    .crypto-content { flex: 1; padding: 10px 15px; padding-bottom: calc(var(--safe-bottom) + 10px); display: flex; flex-direction: column; overflow-y: auto; }
    #timestamp { flex-shrink: 0; text-align: center; color: var(--secondary-text); font-size: 0.75rem; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 1px; }
    .crypto-list { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; min-height: 0; }

    .card { 
        background: var(--card-bg); border: var(--card-border);
        border-radius: 18px; padding: 12px 16px; margin-bottom: 8px; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        display: flex; justify-content: space-between; align-items: center; 
        cursor: pointer; position: relative; overflow: hidden;
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        transition: transform 0.2s, box-shadow 0.2s; min-height: 65px; 
    }
    .card:last-child { margin-bottom: 0; }
    .card:hover { transform: scale(1.01); box-shadow: 0 5px 20px rgba(0,0,0,0.2), 0 0 10px var(--edit-highlight); border-color: var(--accent-red-text); }
    
    .card.loading { pointer-events: none; }
    .card.loading::after {
        content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(90deg, transparent 0%, var(--edit-highlight) 50%, transparent 100%);
        background-size: 200% 100%; animation: shimmer 1.5s infinite linear; z-index: 5;
    }

    .coin-logo { width: 32px; height: 32px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .coin-info h2 { font-size: 1rem; margin: 0; color: var(--primary-text); font-weight: 700; letter-spacing: 0.5px; }
    
    .change-percentage { font-size: 0.85rem; font-weight: 600; }
    .change-positive { color: var(--crypto-up); text-shadow: 0 0 8px rgba(0,255,157,0.3); }
    .change-negative { color: var(--crypto-down); text-shadow: 0 0 8px rgba(255, 0, 51, 0.4); }
    
    .price-eur { font-size: 1.1rem; font-weight: 700; color: var(--primary-text); text-align: right; letter-spacing: -0.5px; }
    .price-usd { font-size: 0.8rem; color: var(--secondary-text); text-align: right; margin-top: 2px; }

    /* MODALES Y TOAST */
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--secondary-text); box-shadow: 0 0 5px currentColor; transition: 0.3s; }
    .status-dot.online { background-color: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); }
    .status-dot.error { background-color: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); }

    #chart-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; padding: 20px; }
    #chart-modal.visible { opacity: 1; pointer-events: auto; }
    .modal-content { width: 100%; max-width: 500px; background: var(--chassis-bg); border: 1px solid var(--accent-red-text); box-shadow: 0 0 40px rgba(255,0,51,0.15); border-radius: 30px; padding: 25px; transform: scale(0.9); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; flex-direction: column; }
    #chart-modal.visible .modal-content { transform: scale(1); }
    .close-chart { align-self: flex-end; background: none; border: none; font-size: 2rem; color: var(--secondary-text); cursor: pointer; line-height: 1; transition: color 0.2s; }
    .close-chart:hover { color: var(--accent-red-text); text-shadow: 0 0 10px var(--accent-red-text); }
    .chart-controls { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; background: rgba(128,128,128,0.1); padding: 6px; border-radius: 14px; }
    .time-btn { background: transparent; border: none; color: var(--secondary-text); padding: 8px 16px; border-radius: 10px; font-size: 0.9rem; cursor: pointer; font-family: 'Lexend', sans-serif; font-weight: 600; transition: 0.2s; }
    .time-btn.active { background: var(--card-bg); color: var(--accent-red-text); box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-shadow: 0 0 8px rgba(255, 0, 51, 0.4); }
    .loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--neon-red); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; z-index: 10; box-shadow: 0 0 15px var(--neon-red); }
    .loading-spinner.active { display: block; }
    .toast { position: fixed; top: 90px; left: 50%; transform: translate(-50%, -20px) scale(0.9); background: rgba(10, 10, 10, 0.9); border: 1px solid var(--accent-red-text); box-shadow: 0 0 20px rgba(255, 0, 51, 0.3); color: white; padding: 12px 30px; border-radius: 40px; font-size: 1rem; opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; z-index: 200; font-weight: 600; letter-spacing: 0.5px; }
    .toast.show { opacity: 1; transform: translate(-50%, 0) scale(1); }

    @media (max-width: 380px) {
        .app-header { gap: 4px; padding: 5px; }
        .app-header .icon-btn { width: 38px; height: 38px; padding: 8px; }
        .app-title { font-size: 1rem; }
        #clock, #clock-crypto { font-size: 0.7rem; min-width: 65px; }
        .keypad { gap: 10px; }
        .btn { font-size: 1.2rem; border-radius: 16px; }
    }
    
    @media(min-width: 600px) {
        body { display: flex; align-items: center; justify-content: center; background: #050505; }
        .view-container { max-width: 420px; height: 92vh; border-radius: 45px; border: 8px solid #111; box-shadow: 0 0 0 2px #333, 0 20px 50px rgba(0,0,0,0.8), 0 0 100px rgba(255, 0, 51, 0.1); }
        body[data-theme="dark"] .view-container { border-color: #1a1a1a; box-shadow: 0 0 0 2px #333, 0 0 60px rgba(255, 0, 51, 0.15); }
    }
/* --- INICIO: ICONOS DE CABECERA COLORIDOS --- */

    /* 1. Bot√≥n de Tema (Sol/Luna): Naranja √Åmbar */
    .btn-theme {
        color: #ffab00 !important;
        transition: all 0.3s ease;
        /* Resplandor suave */
        filter: drop-shadow(0 0 2px rgba(255, 171, 0, 0.6));
    }
    .btn-theme:hover {
        filter: drop-shadow(0 0 8px rgba(255, 171, 0, 1));
        transform: scale(1.1);
    }

    /* 2. Bot√≥n de Sonido: Cyan El√©ctrico */
    #btn-mute {
        color: var(--neon-cyan) !important;
        transition: all 0.3s ease;
        filter: drop-shadow(0 0 2px rgba(0, 242, 255, 0.6));
    }
    #btn-mute:hover {
        filter: drop-shadow(0 0 8px var(--neon-cyan));
        transform: scale(1.1);
    }

    /* 3. Bot√≥n Ir a Crypto (Gr√°fico): Verde Matrix */
    #btn-go-crypto {
        color: var(--crypto-up) !important;
        transition: all 0.3s ease;
        filter: drop-shadow(0 0 2px rgba(0, 255, 157, 0.6));
    }
    #btn-go-crypto:hover {
        filter: drop-shadow(0 0 8px var(--crypto-up));
        transform: scale(1.1);
    }

    /* 4. Bot√≥n Volver a Calc (Flecha): Rosa Cyberpunk */
    #btn-go-calc {
        color: #ff00ff !important;
        transition: all 0.3s ease;
        filter: drop-shadow(0 0 2px rgba(255, 0, 255, 0.6));
    }
    #btn-go-calc:hover {
        filter: drop-shadow(0 0 8px #ff00ff);
        transform: scale(1.1);
    }
    /* --- FIN: ICONOS DE CABECERA COLORIDOS --- */	
</style>
</head>
<body data-theme="dark">

    <div class="view-container">
        <div id="view-calculator" class="view active">
            <header class="app-header">
				<button class="embedded-ui icon-btn btn-theme" aria-label="Cambiar Tema">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
                
                <button class="embedded-ui icon-btn icon-swap" id="btn-mute" aria-label="Silenciar">
                    <svg class="shown" id="icon-sound-on" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    <svg class="hidden" id="icon-sound-off" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
                </button>
                               
                <a href="https://danijdzg.github.io/dani/" target="_blank" class="app-title embedded-ui">aiDANaI</a>
                
                <div id="clock" class="embedded-ui tabular-nums">0:00:00</div>
                
                <button id="btn-go-crypto" class="embedded-ui icon-btn" aria-label="Crypto">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                </button>
            </header>
        
            <div class="upper-section">
                <div class="display-lens" id="display-container">
                    <ul id="history-list"></ul>
                    <div class="display-area">
                        <div id="secondary-display" class="tabular-nums"></div>
                        <div id="main-display" class="tabular-nums">0</div>
                    </div>
                </div>
            </div>

            <div class="calculator-body">
                <div class="keypad">
                    <button class="btn" data-key="AC">AC</button>
                    <button class="btn" data-key="Backspace">‚å´</button>
                    <button class="btn" data-key="%" data-color="blue">%</button>
                    <button class="btn" data-key="/" data-color="blue">√∑</button>
             
                    <button class="btn" data-key="7">7</button>
                    <button class="btn" data-key="8">8</button>
                    <button class="btn" data-key="9">9</button>
                    <button class="btn" data-key="*" data-color="blue">√ó</button>
             
                    <button class="btn" data-key="4">4</button>
                    <button class="btn" data-key="5">5</button>
                    <button class="btn" data-key="6">6</button>
                    <button class="btn" data-key="-" data-color="blue">‚àí</button>
  
                    <button class="btn" data-key="1">1</button>
                    <button class="btn" data-key="2">2</button>
                    <button class="btn" data-key="3">3</button>
                    <button class="btn" data-key="+" data-color="blue">+</button>

                    <button class="btn" data-key="0">0</button>
                    <button class="btn" data-key=",">,</button>
                    <button class="btn btn-large" data-key="Enter" data-color="green">=</button>
                </div>
            </div>
        </div>

        <div id="view-crypto" class="view">
            <header class="app-header">
                <button class="embedded-ui icon-btn btn-theme" aria-label="Cambiar Tema">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
                
                <a href="https://danijdzg.github.io/dani/" target="_blank" class="app-title embedded-ui">Crypto</a>
                
                <div id="clock-crypto" class="embedded-ui tabular-nums">0:00:00</div>
                
                <button id="btn-go-calc" class="embedded-ui icon-btn" aria-label="Volver">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2" stroke-width="2"></rect><line x1="8" y1="6" x2="16" y2="6" stroke-width="2"></line><line x1="16" y1="14" x2="16" y2="14" stroke-width="3"></line><line x1="12" y1="14" x2="12" y2="14" stroke-width="3"></line><line x1="8" y1="14" x2="8" y2="14" stroke-width="3"></line><line x1="16" y1="18" x2="16" y2="18" stroke-width="3"></line><line x1="12" y1="18" x2="12" y2="18" stroke-width="3"></line><line x1="8" y1="18" x2="8" y2="18" stroke-width="3"></line></svg>
                </button>
            </header>
            
            <div class="crypto-content">
                <p id="timestamp"><span class="status-dot"></span> <span id="time-text">Conectando...</span></p>
                <div class="crypto-list">
                    <div class="card" data-id="bitcoin" data-name="Bitcoin">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/1/large/bitcoin.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>Bitcoin</h2><p class="change-percentage tabular-nums" id="bitcoin-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="bitcoin-price-eur">--</p><p class="price-usd tabular-nums" id="bitcoin-price-usd">--</p></div>
                    </div>
                    <div class="card" data-id="ethereum" data-name="Ethereum">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/279/large/ethereum.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>Ethereum</h2><p class="change-percentage tabular-nums" id="ethereum-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="ethereum-price-eur">--</p><p class="price-usd tabular-nums" id="ethereum-price-usd">--</p></div>
                    </div>
                    <div class="card" data-id="solana" data-name="Solana">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/4128/large/solana.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>Solana</h2><p class="change-percentage tabular-nums" id="solana-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="solana-price-eur">--</p><p class="price-usd tabular-nums" id="solana-price-usd">--</p></div>
                    </div>
                     <div class="card" data-id="ripple" data-name="XRP">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>XRP</h2><p class="change-percentage tabular-nums" id="ripple-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="ripple-price-eur">--</p><p class="price-usd tabular-nums" id="ripple-price-usd">--</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chart-modal">
        <div class="modal-content">
            <button class="close-chart" aria-label="Cerrar">&times;</button>
            <h2 id="chart-title" style="margin-bottom:15px; color: var(--primary-text); text-align: center;">Moneda</h2>
            
            <div class="chart-controls">
                <button class="time-btn" data-days="1">24h</button>
                <button class="time-btn" data-days="7">7D</button>
                <button class="time-btn active" data-days="30">30D</button>
                <button class="time-btn" data-days="365">1A</button>
            </div>

            <div style="position: relative; min-height: 250px;">
                <div id="loading-chart" class="loading-spinner"></div>
                <div id="chart-container"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const App = {
            expr: '',
            fresh: true,
            chart: null,
            currentCoinId: null,
            escCounter: 0,
            escTimer: null,
            audioCtx: null,
            touchStartY: 0,
            pullToRefreshActive: false,
            
            state: { 
                theme: 'dark', 
                muted: false, 
                history: [], 
                cryptoCache: null,
                lastFetchTime: 0,
                chartCache: {} // Feature AIStudio: Cache para gr√°ficos
            },
            
            init() {
                this.loadState();
                this.applyTheme(this.state.theme);
                this.updateMuteIcon();
                
                this.bindEvents();
                this.startClocks();
                this.renderHistoryFromState(); 
                
                if(this.state.cryptoCache) this.renderCryptoData(this.state.cryptoCache, new Date(this.state.lastFetchTime));
                
                setInterval(() => this.fetchPrices(), 60000);
                this.fixHeight();
                this.initAudioContext();
                this.setupPullToRefresh();
                
                document.body.addEventListener('touchstart', () => {
                    if (this.audioCtx && this.audioCtx.state === 'suspended') this.audioCtx.resume();
                }, { once: true });
            },

            fixHeight() {
                const doc = document.documentElement;
                const setH = () => doc.style.setProperty('--doc-height', `${window.innerHeight}px`);
                setH();
                window.addEventListener('resize', setH);
            },

            bindEvents() {
                document.getElementById('btn-go-crypto').onclick = () => this.switchView('crypto');
                document.getElementById('btn-go-calc').onclick = () => this.switchView('calc');
                document.getElementById('btn-mute').onclick = () => this.toggleMute();

                document.querySelectorAll('.btn-theme').forEach(b => b.onclick = () => {
                    this.applyTheme(this.state.theme === 'dark' ? 'light' : 'dark');
                    this.haptic(15);
                });

                document.querySelectorAll('.btn[data-key]').forEach(b => {
                    const key = b.dataset.key;
                    if (key === 'AC') {
                        let pressTimer;
                        let longPressTriggered = false;
                        const startPress = (e) => {
                            if(e.cancelable) e.preventDefault();
                            b.classList.add('btn-active');
                            longPressTriggered = false;
                            pressTimer = setTimeout(() => {
                                longPressTriggered = true;
                                this.clearAllHistory(); 
                            }, 800);
                        };
                        const endPress = () => {
                            clearTimeout(pressTimer);
                            b.classList.remove('btn-active');
                            if (!longPressTriggered) {
                                this.haptic(10);
                                this.handleInput('AC');
                                this.pulseDisplay();
                            }
                        };
                        b.addEventListener('pointerdown', startPress);
                        b.addEventListener('pointerup', endPress);
                        b.addEventListener('pointerleave', () => { clearTimeout(pressTimer); b.classList.remove('btn-active'); });
                    } else {
                        const press = (e) => {
                            if(e.cancelable) e.preventDefault(); 
                            this.haptic(10); b.classList.add('btn-active'); 
                            this.pulseDisplay(); this.handleInput(key);
                        };
                        const release = () => b.classList.remove('btn-active');
                        b.addEventListener('pointerdown', press);
                        b.addEventListener('pointerup', release);
                        b.addEventListener('pointerleave', release);
                    }
                });

                document.addEventListener('keydown', (e) => {
                    const k = e.key === 'Enter' ? 'Enter' : e.key;
                    if (k === 'Escape') {
                        this.escCounter++;
                        clearTimeout(this.escTimer);
                        this.escTimer = setTimeout(() => { this.escCounter = 0; }, 800);
                        const btn = document.querySelector('.btn[data-key="AC"]');
                        if(btn) { btn.classList.add('btn-active'); setTimeout(()=>btn.classList.remove('btn-active'), 100); }
                        if (this.escCounter >= 3) { this.clearAllHistory(); this.escCounter = 0; } 
                        else { this.handleInput('AC'); }
                        return;
                    }
                    if(!/^[0-9+\-*/.,=()%]$|Enter|Backspace|Delete/.test(k)) return;
                    let vKey = k;
                    if(k==='Enter'||k==='=') vKey='Enter';
                    if(k==='Delete') vKey='AC';
                    if(k==='.') vKey=',';
                    const btn = document.querySelector(`.btn[data-key="${vKey}"]`) || document.querySelector(`.btn[data-key="${k}"]`);
                    if(btn) {
                        btn.classList.add('btn-active');
                        this.pulseDisplay();
                        setTimeout(() => btn.classList.remove('btn-active'), 100);
                        this.handleInput(vKey === 'AC' ? 'AC' : (vKey === 'Enter' ? 'Enter' : (vKey === ',' ? ',' : k)));
                    }
                });

                const chartModal = document.getElementById('chart-modal');
                document.querySelectorAll('.card').forEach(c => c.onclick = () => this.openChart(c.dataset.id, c.dataset.name));
                document.querySelector('.close-chart').onclick = () => {
                    chartModal.classList.remove('visible');
                    if(this.chart) { this.chart.destroy(); this.chart = null; }
                };
                chartModal.onclick = (e) => { if (e.target === chartModal) document.querySelector('.close-chart').click(); };

                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.updateChartData(e.target.dataset.days);
                    }
                });
            },

            toggleMute() {
                this.state.muted = !this.state.muted;
                this.updateMuteIcon();
                this.saveState();
                if(!this.state.muted) this.playTone('Enter');
                this.showToast(this.state.muted ? 'Silencio Activado üîá' : 'Sonido Activado üîä');
            },

            updateMuteIcon() {
                const onIcon = document.getElementById('icon-sound-on');
                const offIcon = document.getElementById('icon-sound-off');
                if(this.state.muted) {
                    onIcon.classList.replace('shown', 'hidden');
                    offIcon.classList.replace('hidden', 'shown');
                } else {
                    offIcon.classList.replace('shown', 'hidden');
                    onIcon.classList.replace('hidden', 'shown');
                }
            },

            clearAllHistory() {
                this.state.history = []; 
                this.saveState(); 
                document.getElementById('history-list').innerHTML = '';
                this.showToast('üóëÔ∏è Historial Eliminado');
                this.haptic([50, 50, 50]); 
                this.pulseDisplay();
                this.handleInput('AC'); 
            },

            pulseDisplay() {
                const lens = document.getElementById('display-container');
                lens.classList.remove('pulse-active');
                void lens.offsetWidth; 
                lens.classList.add('pulse-active');
                setTimeout(()=>lens.classList.remove('pulse-active'), 300);
            },

            handleInput(k) {
                if(this.fresh) {
                    if(!"+-*/%".includes(k) && k !== 'Enter') { this.expr=''; }
                    this.fresh = false;
                    document.getElementById('secondary-display').classList.remove('visible');
                }
                
                if(k==='AC') { this.expr = ''; }
                else if(k==='Backspace') { this.expr = this.expr.toString().slice(0, -1); }
                else if(k==='Enter') { this.calculate(); }
                else if(k==='(') { this.smartParen(); }
                else if(k==='%') { this.handlePercent(); } 
                else {
                    const last = this.expr.slice(-1);
                    if (k === ',') k = '.';
                    
                    if (k === '.') {
                        const currentNum = this.expr.split(/[\+\-\*\/]/).pop();
                        if (currentNum.includes('.')) return; 
                        if (this.expr === '' || "+-*/(".includes(last)) {
                            this.expr += '0.';
                            this.render(); this.playTone(k); return;
                        }
                    }

                    if ("+-*/".includes(k) && "+-*/".includes(last)) { 
                        this.expr = this.expr.slice(0, -1) + k;
                    } else { 
                        this.expr += k; 
                    }
                }
                this.render();
                this.playTone(k);
            },

            handlePercent() {
                if (!this.expr) return;
                const operators = ['+', '-', '*', '/'];
                let lastOpIndex = -1;
                let lastOp = '';
                
                for (let i = this.expr.length - 1; i >= 0; i--) {
                    if (operators.includes(this.expr[i])) {
                        lastOpIndex = i;
                        lastOp = this.expr[i];
                        break;
                    }
                }

                const match = this.expr.match(/(\d+(\.\d+)?)$/);
                if (!match) return;

                const currentVal = parseFloat(match[0]);
                let replacement = '';

                if (lastOpIndex !== -1 && (lastOp === '+' || lastOp === '-')) {
                    const baseExpr = this.expr.substring(0, lastOpIndex);
                    try {
                        const cleanBase = baseExpr.replace(/[^0-9+\-*/.]/g, ''); 
                        const baseVal = new Function('return ' + cleanBase)();
                        const percentVal = baseVal * (currentVal / 100);
                        replacement = percentVal.toString();
                    } catch (e) {
                        replacement = (currentVal / 100).toString();
                    }
                } else {
                    replacement = (currentVal / 100).toString();
                }

                this.expr = this.expr.substring(0, this.expr.length - match[0].length) + replacement;
                this.fresh = false;
                this.render();
            },

            calculate() {
                if(!this.expr) return;
                try {
                    let formattedExpr = this.expr.replace(/\*/g, '√ó').replace(/\//g, '√∑');
                    formattedExpr = formattedExpr.replace(/\d+(\.\d+)?/g, (match) => {
                        const [int, dec] = match.split('.');
                        return dec ? `${parseInt(int).toLocaleString('es-ES')},${dec}` : parseInt(int).toLocaleString('es-ES');
                    });

                    let clean = this.expr.replace(/[^0-9+\-*/().]/g, '');
                    clean = clean.replace(/([+\-*/])\1+/g, '$1'); 
                    clean = clean.replace(/\)\(/g, ')*('); 

                    if(clean.includes('/0') && !clean.match(/\/0\./)) throw new Error("DIV_ZERO");
                    const openParen = (clean.match(/\(/g)||[]).length;
                    const closeParen = (clean.match(/\)/g)||[]).length;
                    if(openParen !== closeParen) throw new Error("PAREN");

                    let res = new Function('return ' + clean)();
                    if(!isFinite(res)) throw new Error("INVALID");
                    
                    res = parseFloat(parseFloat(res).toPrecision(12)); 
                    
                    this.addToHistoryState(this.expr, res);
                    this.expr = String(res); 
                    this.fresh = true;
                    
                    const secDisp = document.getElementById('secondary-display');
                    secDisp.innerText = formattedExpr + ' =';
                    secDisp.classList.add('visible');
                    this.pulseDisplay();
                    
                    // FEEDBACK POSITIVO (AIStudio)
                    const d = document.getElementById('main-display');
                    d.classList.remove('pop-active');
                    void d.offsetWidth;
                    d.classList.add('pop-active');

                } catch(e) { 
                    // FEEDBACK ERROR SHAKE (Geminis)
                    const dContainer = document.getElementById('display-container');
                    dContainer.classList.add('shake-active');
                    setTimeout(() => dContainer.classList.remove('shake-active'), 300);
                    
                    let msg = "‚ùå Error";
                    if(e.message === "DIV_ZERO") msg = "‚ö†Ô∏è Divisi√≥n por 0";
                    else if(e.message === "PAREN") msg = "‚ö†Ô∏è Par√©ntesis ()";
                    this.showToast(msg);
                    this.haptic([50, 50, 100]);
                    const d = document.getElementById('main-display');
                    const originalColor = d.style.color;
                    d.style.color = 'var(--neon-red)';
                    setTimeout(() => d.style.color = originalColor, 800);
                }
                this.render();
            },

            smartParen() {
                const o = (this.expr.match(/\(/g)||[]).length;
                const c = (this.expr.match(/\)/g)||[]).length;
                const last = this.expr.slice(-1);
                if(o > c && (/[0-9.]$/.test(last) || last===')')) this.expr += ')';
                else if(/[0-9.]$/.test(last) || last===')') this.expr += '*(';
                else this.expr += '(';
                this.render();
            },

            render() {
                const d = document.getElementById('main-display');
                if(!this.expr) { d.innerHTML = '0'; d.style.fontSize = '3.2rem'; return; }
                
                const parts = this.expr.split(/([\+\-\*\/])/);
                let h = '';
                
                // HIGHLIGHT DE OPERADORES (AIStudio)
                document.querySelectorAll('.btn').forEach(b => b.classList.remove('op-active'));
                const lastChar = this.expr.slice(-1);
                if ("+-*/".includes(lastChar)) {
                    const opMap = {'+':'+', '-':'-', '*':'*', '/':'/'};
                    const btn = document.querySelector(`.btn[data-key="${opMap[lastChar]}"]`);
                    if(btn) btn.classList.add('op-active');
                }

                parts.forEach((p) => {
                    if(p==='') return;
                    if("+-*/".includes(p)) { 
                        const op = p.replace('*','√ó').replace('/','√∑'); 
                        h += `<span class="token token-op" style="margin:0 2px">${op}</span>`;
                    } else {
                        if(!isNaN(parseFloat(p))) { 
                            let [int, dec] = p.split('.'); 
                            const intFormatted = int ? parseInt(int).toLocaleString('es-ES') : '';
                            const finalInt = (int === '0' || int === '') && p.startsWith('0') ? '0' : intFormatted;

                            if(dec !== undefined) {
                                h += `<span>${finalInt}<span class="small-decimal" style="opacity:0.7">,${dec}</span></span>`;
                            } else {
                                h += `<span>${finalInt}</span>`;
                            }
                        } else {
                            h += p;
                        }
                    }
                });
                d.innerHTML = h;

                // ESCALADO DE FUENTE EQUILIBRADO (Mix)
                const plainTextLen = d.innerText.replace(/,/g, '').length; 
                let size = 3.2;
                if (plainTextLen > 7) {
                    // Permitimos hasta 1.25rem para que entren m√°s n√∫meros
                    size = Math.max(1.25, 3.2 - ((plainTextLen - 7) * 0.20)); 
                }
                d.style.fontSize = `${size}rem`;

                requestAnimationFrame(() => d.scrollLeft = d.scrollWidth);
            },

            addToHistoryState(ex, r) {
                const item = { expr: ex, res: r, date: Date.now() };
                this.state.history.unshift(item); 
                if (this.state.history.length > 20) this.state.history.pop(); 
                this.saveState();
                this.renderHistoryItem(item, true); 
            },

            renderHistoryFromState() {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                [...this.state.history].reverse().forEach(item => this.renderHistoryItem(item, false));
            },

            renderHistoryItem(item, isNew) {
                const li = document.createElement('li');
                const formattedRes = item.res.toLocaleString('es-ES', { maximumFractionDigits: 10 });
                let prettyExpr = item.expr.replace(/\*/g, '√ó').replace(/\//g, '√∑');
                
                prettyExpr = prettyExpr.replace(/\d+(\.\d+)?/g, (match) => {
                    const [int, dec] = match.split('.');
                    const intFormatted = parseInt(int).toLocaleString('es-ES');
                    return dec ? `${intFormatted},${dec}` : intFormatted;
                });

                li.innerHTML = `${prettyExpr} = <b>${formattedRes}</b>`;
                li.onclick = () => { 
                    this.expr = String(item.res); 
                    this.fresh = true; 
                    this.render(); 
                    this.haptic(10);
                    this.showToast('‚úì Recuperado');
                };
                const list = document.getElementById('history-list');
                if(isNew) list.prepend(li); else list.prepend(li); 
            },

            async fetchPrices(force = false) {
                const dot = document.querySelector('.status-dot');
                const label = document.getElementById('time-text');
                const now = Date.now();
                const cacheValid = this.state.cryptoCache && (now - this.state.lastFetchTime < 60000);
                
                if (cacheValid && !force) {
                    this.renderCryptoData(this.state.cryptoCache, new Date(this.state.lastFetchTime));
                    return;
                }
                document.querySelectorAll('.card').forEach(c => c.classList.add('loading'));

                try {
                    dot.className = 'status-dot'; 
                    label.innerText = "Actualizando...";

                    const controller = new AbortController();
                    setTimeout(() => controller.abort(), 8000);
                    const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,ripple&vs_currencies=eur,usd&include_24hr_change=true', { signal: controller.signal });
                    
                    if(res.status === 429) throw new Error("L√≠mite API");
                    if(!res.ok) throw new Error("Error API");
                    
                    const d = await res.json();
                    
                    this.state.cryptoCache = d;
                    this.state.lastFetchTime = Date.now();
                    this.saveState();
                    this.renderCryptoData(d, new Date());

                } catch(e) { 
                    if (this.state.cryptoCache) {
                        this.renderCryptoData(this.state.cryptoCache, new Date(this.state.lastFetchTime));
                        dot.className = 'status-dot';
                        dot.style.backgroundColor = 'var(--neon-yellow)'; 
                        dot.style.boxShadow = '0 0 10px var(--neon-yellow)';
                        label.innerText = "Modo Offline";
                    } else {
                        dot.className = 'status-dot error';
                        label.innerText = "Sin conexi√≥n";
                    }
                } finally {
                    document.querySelectorAll('.card').forEach(c => c.classList.remove('loading'));
                }
            },

            renderCryptoData(d, dateObj) {
                const dot = document.querySelector('.status-dot');
                const label = document.getElementById('time-text');
                const fmtEur = new Intl.NumberFormat('es-ES', {style:'currency', currency:'EUR'});
                const fmtUsd = new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'});

                ['bitcoin','ethereum','solana','ripple'].forEach(id => {
                    if(d[id]) {
                        document.getElementById(`${id}-price-eur`).textContent = fmtEur.format(d[id].eur);
                        document.getElementById(`${id}-price-usd`).textContent = fmtUsd.format(d[id].usd);
                        const chg = d[id].eur_24h_change;
                        const cEl = document.getElementById(`${id}-change`);
                        cEl.innerText = (chg>0?'+':'') + chg.toFixed(2)+'%';
                        cEl.className = `change-percentage tabular-nums ${chg>=0?'change-positive':'change-negative'}`;
                    }
                });

                const timeStr = dateObj.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                if(label.innerText !== "Modo Offline") {
                    dot.className = 'status-dot online';
                    dot.style.backgroundColor = ''; 
                    dot.style.boxShadow = '';
                    label.innerText = `Actualizado: ${timeStr}`;
                }
            },

            async openChart(id, name) {
                this.currentCoinId = id;
                document.getElementById('chart-title').innerText = name;
                document.getElementById('chart-modal').classList.add('visible');
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.time-btn[data-days="30"]').classList.add('active');
                if(this.chart) { this.chart.destroy(); this.chart = null; }
                await this.initChart();
                this.updateChartData(30);
            },

            async initChart() {
                const options = {
                    series: [],
                    chart: { type: 'area', height: 250, toolbar:{show:false}, background:'transparent', animations: { enabled: false } },
                    theme: { mode: this.state.theme },
                    stroke: { curve: 'smooth', width: 2 },
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1 } },
                    dataLabels: { enabled: false },
                    xaxis: { type: 'datetime', tooltip:{enabled:false}, axisBorder:{show:false}, labels: { show: false } },
                    yaxis: { show: true, labels: { style:{ colors:'var(--secondary-text)' }, formatter: v=>v.toLocaleString('es-ES',{maximumFractionDigits:0}) + '‚Ç¨' } },
                    grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 5, padding: { left: 10, right: 0 } },
                    tooltip: { theme: this.state.theme, x: { format: 'dd MMM HH:mm' } }
                };
                this.chart = new ApexCharts(document.querySelector("#chart-container"), options);
                await this.chart.render();
            },

            async updateChartData(days) {
                const spinner = document.getElementById('loading-chart');
                spinner.classList.add('active');
                
                // SISTEMA CACH√â GR√ÅFICOS (De AIStudio - Crucial para API Rate Limit)
                const now = Date.now();
                const cacheKey = `${this.currentCoinId}_${days}`;
                const cached = this.state.chartCache?.[cacheKey];
                
                // Cach√© de 10 minutos
                if (cached && (now - cached.time < 600000)) {
                    if(this.chart) {
                        this.chart.updateOptions({ colors: [cached.color], tooltip: { theme: this.state.theme } });
                        this.chart.updateSeries([{ name: 'Precio', data: cached.data }]);
                    }
                    spinner.classList.remove('active');
                    return;
                }

                try {
                    const url = `https://api.coingecko.com/api/v3/coins/${this.currentCoinId}/market_chart?vs_currency=eur&days=${days}`;
                    const res = await fetch(url);
                    if(res.status === 429) throw new Error("‚ö†Ô∏è L√≠mite de API. Espera.");
                    if(!res.ok) throw new Error("Error API");
                    const data = await res.json();
                    if(!data.prices || data.prices.length === 0) throw new Error("Sin datos");

                    const isPositive = data.prices[data.prices.length-1][1] >= data.prices[0][1];
                    const color = isPositive ? '#00E676' : '#FF1744';

                    // Guardar en cach√©
                    if(!this.state.chartCache) this.state.chartCache = {};
                    this.state.chartCache[cacheKey] = { data: data.prices, time: now, color: color };
                    this.saveState();

                    if(this.chart) {
                        this.chart.updateOptions({ colors: [color], tooltip: { theme: this.state.theme } });
                        this.chart.updateSeries([{ name: 'Precio', data: data.prices }]);
                    }
                } catch(e) { this.showToast(e.message); } 
                finally { spinner.classList.remove('active'); }
            },

            switchView(v) {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                if(v==='crypto') { 
                    document.getElementById('view-crypto').classList.add('active'); 
                    this.fetchPrices(); 
                } else { 
                    document.getElementById('view-calculator').classList.add('active'); 
                }
            },
            
            applyTheme(t) {
                this.state.theme = t;
                document.body.dataset.theme = t;
                if(this.chart) this.chart.updateOptions({ theme: {mode: t}, tooltip: {theme: t} });
                this.saveState();
            },
            
            haptic(p) { 
                if(navigator.vibrate) {
                    const d = typeof p === 'number' ? Math.min(p, 10) : p;
                    navigator.vibrate(d);
                } 
            },
            
            showToast(msg) { 
                const t = document.getElementById('toast');
                t.innerText = msg; t.classList.add('show'); 
                setTimeout(()=>t.classList.remove('show'),2000); 
            },
            
            saveState() { localStorage.setItem('aidanaiUltimate', JSON.stringify(this.state)); },
            
            loadState() { 
                try {
                    const s = JSON.parse(localStorage.getItem('aidanaiUltimate')); 
                    if(s) this.state = {...this.state, ...s};
                } catch(e) {} 
            },
            
            startClocks() {
                const update = () => {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('es-ES', {hour:'numeric', minute:'2-digit', second:'2-digit'});
                    document.querySelectorAll('#clock, #clock-crypto').forEach(e => e.innerText = timeStr);
                };
                update(); setInterval(update, 1000);
            },
            
            initAudioContext() {
                try { this.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { this.audioCtx = null; }
            },
            
            // AUDIO MEJORADO: Clicky/Corto (Afinaci√≥n Geminis)
            playTone(key) {
                if(this.state.muted || !this.audioCtx) return;
                try {
                    if(this.audioCtx.state === 'suspended') this.audioCtx.resume();

                    const osc = this.audioCtx.createOscillator();
                    const gain = this.audioCtx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(this.audioCtx.destination);
                    
                    osc.type = 'sine'; // Sonido m√°s puro
                    
                    if(key === 'Enter') osc.frequency.value = 880;      
                    else if(key === 'AC') osc.frequency.value = 440;    
                    else if('+-*/%'.includes(key)) osc.frequency.value = 659.25; 
                    else osc.frequency.value = 1046.50;                    
                    
                    const now = this.audioCtx.currentTime;
                    gain.gain.setValueAtTime(0, now);
                    // Timings r√°pidos para sensaci√≥n mec√°nica
                    gain.gain.linearRampToValueAtTime(0.3, now + 0.002); 
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.06); 
                    
                    osc.start(now);
                    osc.stop(now + 0.07);
                } catch(e) { /* Fallo silencioso */ }
            },
            
            setupPullToRefresh() {
                const cryptoContent = document.querySelector('.crypto-content');
                if(!cryptoContent) return;
                
                cryptoContent.addEventListener('touchstart', (e) => {
                    if(cryptoContent.scrollTop === 0) this.touchStartY = e.touches[0].clientY;
                }, { passive: true });
                
                cryptoContent.addEventListener('touchmove', (e) => {
                    if(this.touchStartY && !this.pullToRefreshActive) {
                        const pullDistance = e.touches[0].clientY - this.touchStartY;
                        if(pullDistance > 100 && cryptoContent.scrollTop === 0) {
                            this.pullToRefreshActive = true;
                            this.showToast('üîÑ Actualizando...');
                            this.fetchPrices(true);
                            this.haptic(20);
                            setTimeout(() => { this.touchStartY = 0; this.pullToRefreshActive = false; }, 1000);
                        }
                    }
                }, { passive: true });
                cryptoContent.addEventListener('touchend', () => { this.touchStartY = 0; }, { passive: true });
            }
        };
        App.init();
    </script>
</body>
</html>
