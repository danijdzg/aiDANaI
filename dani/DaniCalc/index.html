<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <style>html, body { background-color: #000000; }</style>
    <meta name="theme-color" content="#000000">
    
    <meta name="description" content="aiDANaI Ultimate Dark">
    <title>aiDANaI Ultimate</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Lexend:wght@300;400;500;700&family=Poppins:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
   <style>
    :root { 
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
        --header-height: 60px; 
        
        /* === PALETA NEÓN === */
        --neon-red: #ff0033; 
        --neon-cyan: #00f2ff;
        --neon-lime: #ccff00;
        --neon-yellow: #ffff00;
        --matrix-green: #39ff14;
        
        --crypto-up: #00ff9d;
        --crypto-down: #ff0033;

        /* === TEMA OSCURO PERMANENTE === */
        --bg-body: #000000;
        --bg-gradient: radial-gradient(circle at 50% 0%, #1a0505 0%, #000000 70%);
        --chassis-bg: #050505;
        --chassis-border: 1px solid #222;
        --screen-bg: #000000;
        --screen-inset: inset 0 0 30px rgba(0,0,0,1);
        --screen-border: 1px solid rgba(255, 0, 51, 0.2);
        --screen-glow: 0 0 20px rgba(255, 0, 51, 0.05);
        --primary-text: #ffffff;
        --secondary-text: #888;
        --clock-text: var(--neon-yellow);
        --clock-glow: 0 0 15px rgba(255, 255, 0, 0.7);
        --history-op-color: #00f2ff;
        --history-res-color: #39ff14;
        --history-opacity: 0.9;
        --history-glow: 0 0 8px rgba(0, 242, 255, 0.3);
        --btn-bg: linear-gradient(160deg, #333333 0%, #000000 100%);
        --btn-border: 1px solid rgba(255,255,255,0.08);
        --btn-shadow: inset 0 1px 0 rgba(255,255,255,0.35), 0 6px 0 #000000, 0 8px 20px rgba(0,0,0,0.8);
        --btn-shadow-active: inset 0 10px 20px rgba(0,0,0,1), 0 0 0 #000000, 0 0 0 rgba(0,0,0,0);
        --btn-text: #dddddd;
        --accent-blue-text: var(--neon-cyan);
        --accent-red-text: var(--neon-red);
        --accent-green-bg: linear-gradient(180deg, #ccff00 0%, #4caf50 100%);
        --text-glow-blue: 0 0 15px rgba(0, 242, 255, 0.7);
        --text-glow-red: 0 0 15px rgba(255, 0, 51, 0.7);
        --card-bg: rgba(20, 20, 20, 0.85);
        --card-border: 1px solid rgba(255,255,255,0.1);
        --card-hover: rgba(30, 30, 30, 0.95);
        --edit-highlight: rgba(255, 0, 51, 0.15);
        --flash-color: rgba(255, 0, 51, 0.3);
        --op-active-bg: #ffffff;
        --op-active-color: #000000;
        --ripple-color: rgba(255, 255, 255, 0.15);
        --skeleton-bg: rgba(255, 0, 51, 0.1);
        --glow-color: rgba(255, 0, 51, 0.5);
    }

    body { 
        overscroll-behavior: none; touch-action: none; 
        background: var(--bg-body);
        height: 100dvh; width: 100vw; 
        font-family: 'Poppins', sans-serif; overflow: hidden; 
    } 
    
    #history-list, .crypto-content { overscroll-behavior: contain; touch-action: pan-y; }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
    
    button, .card, li { touch-action: manipulation; cursor: pointer; }

    .tabular-nums { font-variant-numeric: tabular-nums; letter-spacing: -0.5px; }
    .small-decimal { font-size: 0.75em; vertical-align: baseline; opacity: 0.85; margin-left: 0px; font-weight: 400; }

    /* === ANIMACIONES === */
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes screenFlash { 0% { box-shadow: inset 0 0 0 rgba(0,0,0,0); } 50% { box-shadow: inset 0 0 60px var(--flash-color); } 100% { box-shadow: inset 0 0 0 rgba(0,0,0,0); } }
    
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    .shake-active { animation: shake 0.3s ease-in-out; }

    @keyframes popScale { 0% { transform: scale(1); } 50% { transform: scale(1.08); color: var(--history-res-color); } 100% { transform: scale(1); } }
    .pop-active { animation: popScale 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    @keyframes ripple { to { transform: scale(4); opacity: 0; } }
    @keyframes glowPulse { 0%, 100% { filter: drop-shadow(0 0 5px currentColor); } 50% { filter: drop-shadow(0 0 15px currentColor); } }
    
    /* === PARTÍCULAS === */
    @keyframes particleFloatUp { 0% { opacity: 0.8; transform: translateY(0) rotate(0deg) scale(0.5); } 100% { opacity: 0; transform: translateY(-150px) rotate(360deg) scale(1); } }
	@keyframes particleFloatDown { 
        0% { opacity: 0.8; transform: translateY(0) rotate(0deg) scale(0.5); } 
        100% { opacity: 0; transform: translateY(150px) rotate(360deg) scale(1); } 
    }
    @keyframes particleExplosion { 0% { opacity: 1; transform: scale(0) rotate(0deg); } 50% { opacity: 0.8; transform: scale(1.2) rotate(180deg); } 100% { opacity: 0; transform: scale(0.8) rotate(360deg); } }
    @keyframes particleFragmentation { 0% { opacity: 1; transform: translate(0, 0) scale(1) rotate(0deg); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0) rotate(var(--rot)); } }
    @keyframes particleStarFall { 0% { opacity: 1; transform: translateY(-100px) rotate(0deg); } 100% { opacity: 0; transform: translateY(100px) rotate(720deg); } }
    @keyframes particleMatrixRain { 0% { opacity: 0; transform: translateY(-50px) translateX(var(--start-x)); } 10% { opacity: 1; } 90% { opacity: 1; } 100% { opacity: 0; transform: translateY(150px) translateX(var(--end-x)); } }
    @keyframes particleConfetti { 0% { opacity: 1; transform: translateY(-20px) rotate(0deg) scale(0.5); } 100% { opacity: 0; transform: translateY(100px) rotate(720deg) scale(1) translateX(var(--tx)); } }
    
    /* Transiciones de Modo */
    @keyframes modeTransitionFlip { 0% { transform: perspective(1000px) rotateY(0deg) scale(1); opacity: 1; } 50% { transform: perspective(1000px) rotateY(90deg) scale(0.8); opacity: 0.5; } 100% { transform: perspective(1000px) rotateY(0deg) scale(1); opacity: 1; } }
    @keyframes modeTransitionFold { 0% { transform: perspective(1200px) rotateX(0deg); opacity: 1; } 50% { transform: perspective(1200px) rotateX(-90deg) scale(0.7); opacity: 0.3; } 100% { transform: perspective(1200px) rotateX(0deg); opacity: 1; } }
    @keyframes modeTransitionVortex { 0% { transform: scale(1) rotate(0deg); opacity: 1; filter: blur(0px); } 30% { transform: scale(0.5) rotate(180deg); opacity: 0.5; filter: blur(5px); } 70% { transform: scale(0.5) rotate(180deg); opacity: 0.5; filter: blur(5px); } 100% { transform: scale(1) rotate(360deg); opacity: 1; filter: blur(0px); } }
    @keyframes modeTransitionGlitch { 0% { transform: translateX(0); opacity: 1; } 10% { transform: translateX(-5px) skewX(5deg); opacity: 0.8; } 50% { transform: translateX(0); opacity: 0.5; filter: blur(8px); } 100% { transform: translateX(0); opacity: 1; filter: blur(0px); } }
    @keyframes modeTransitionMorph { 0% { clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%); transform: scale(1); } 50% { clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); transform: scale(0.7); opacity: 0.7; } 100% { clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%); transform: scale(1); opacity: 1; } }

    .transition-flip { animation: modeTransitionFlip 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
    .transition-fold { animation: modeTransitionFold 0.9s cubic-bezier(0.87, 0, 0.13, 1) forwards; }
    .transition-vortex { animation: modeTransitionVortex 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
    .transition-glitch { animation: modeTransitionGlitch 1.2s steps(5, end) forwards; }
    .transition-morph { animation: modeTransitionMorph 1.1s cubic-bezier(0.77, 0, 0.175, 1) forwards; }

    /* Retroalimentación táctil */
    @keyframes pressureWave { 0% { opacity: 0; transform: scale(0.5); } 50% { opacity: 0.7; transform: scale(1.2); } 100% { opacity: 0; transform: scale(1.5); } }
    @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes elastic { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 85% { transform: scale(1.03); } 100% { transform: scale(1); } }
    
    .pressure-wave { animation: pressureWave 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
    .bounce-active { animation: bounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    .elastic-active { animation: elastic 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }

    .view-container { width: 100%; height: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column; background: var(--bg-gradient); }
    .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transform: scale(0.95); transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .view.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 10; }
    
    /* Fondos dinámicos */
    .dynamic-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; opacity: 0.4; transition: opacity 0.5s ease; }
    .particles-bg { background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), transparent 0%, rgba(255, 0, 51, 0.05) 30%, transparent 70%); filter: blur(20px); }
    .grid-pattern { background-image: linear-gradient(rgba(255, 0, 51, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 0, 51, 0.05) 1px, transparent 1px); background-size: 30px 30px; }
    .circuit-pattern { background-image: radial-gradient(circle at 25% 25%, rgba(0, 242, 255, 0.1) 0%, transparent 50%), radial-gradient(circle at 75% 75%, rgba(255, 0, 51, 0.1) 0%, transparent 50%); }
    .crypto-waves { background: radial-gradient(circle at 20% 80%, rgba(0, 255, 157, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255, 0, 51, 0.1) 0%, transparent 50%); }
    .time-gradient { background: linear-gradient(var(--gradient-angle, 135deg), var(--time-color-1, #1a0505) 0%, var(--time-color-2, #000000) 70%); }

    .particles-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; overflow: hidden; }
    .particle { position: absolute; pointer-events: none; z-index: 1000; }
    .particle-circle { border-radius: 50%; }
    .particle-star { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
    .particle-square { border-radius: 10%; }
    .particle-triangle { clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
    .particle-hexagon { clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); }
    
    .pressure-wave-effect { position: absolute; border-radius: 50%; background: radial-gradient(circle, var(--glow-color) 0%, transparent 70%); pointer-events: none; z-index: 999; }
    .touch-trail { position: absolute; border-radius: 50%; background: var(--glow-color); pointer-events: none; z-index: 999; filter: blur(5px); }

    /* HEADER */
    .app-header { flex: 0 0 auto; display: flex; align-items: center; justify-content: space-between; padding: max(var(--safe-top), 10px) 15px 5px; z-index: 20; gap: 10px; height: calc(var(--header-height) + var(--safe-top)); width: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    
    .embedded-ui { background: var(--card-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 16px; display: flex; align-items: center; justify-content: center; border: var(--card-border); transition: all 0.2s; flex-shrink: 0; position: relative; }

    .icon-btn { width: 44px; height: 44px; cursor: pointer; color: var(--secondary-text); padding: 10px; position: relative; overflow: hidden; transition: all 0.2s; }
    .icon-btn:active { transform: scale(0.85); }
    
    #btn-mute { color: var(--neon-cyan) !important; filter: drop-shadow(0 0 2px rgba(0, 242, 255, 0.6)); transition: all 0.3s; }
    #btn-mute:hover { filter: drop-shadow(0 0 8px var(--neon-cyan)); transform: scale(1.1); }
    
    #btn-go-crypto { color: var(--crypto-up) !important; filter: drop-shadow(0 0 2px rgba(0, 255, 157, 0.6)); transition: all 0.3s; }
    #btn-go-crypto:hover { filter: drop-shadow(0 0 8px var(--crypto-up)); transform: scale(1.1); }
    
    #btn-go-calc { color: #ff00ff !important; filter: drop-shadow(0 0 2px rgba(255, 0, 255, 0.6)); transition: all 0.3s; }
    #btn-go-calc:hover { filter: drop-shadow(0 0 8px #ff00ff); transform: scale(1.1); }

    .ripple { position: absolute; border-radius: 50%; background: var(--ripple-color); transform: scale(0); animation: ripple 0.6s linear; pointer-events: none; }

    .icon-swap svg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: opacity 0.3s, transform 0.3s; }
    .icon-swap .hidden { opacity: 0; transform: translate(-50%, -40%); pointer-events: none; }
    .icon-swap .shown { opacity: 1; transform: translate(-50%, -50%); }

    .app-title { font-family: 'Lexend', sans-serif; font-weight: 800; font-size: 1.2rem; color: #ff0033 !important; text-shadow: 0 0 10px rgba(255, 0, 51, 0.8), 0 0 20px rgba(255, 0, 51, 0.4); flex-grow: 1; text-align: center; text-decoration: none; display: flex; justify-content: center; align-items: center; height: 44px; letter-spacing: 2px; transition: all 0.3s; }
    .app-title.glow-pulse { animation: glowPulse 1.5s ease-in-out infinite; }
    
    #clock, #clock-crypto { font-family: 'Fira Code', monospace; font-weight: 700; font-size: 0.8rem; color: var(--clock-text); text-shadow: var(--clock-glow); padding: 0 12px; min-width: 80px; text-align: center; height: 44px; transition: all 0.3s; }
    #clock.glow-pulse, #clock-crypto.glow-pulse { animation: glowPulse 2s ease-in-out infinite; }

    /* PANTALLA CALCULADORA */
    .upper-section { flex: 1 1 40%; display: flex; flex-direction: column; padding: 15px 20px; min-height: 0; justify-content: flex-end; position: relative; }
    
    .display-lens { width: 100%; flex: 1; background: var(--screen-bg); box-shadow: var(--screen-inset), var(--screen-glow); border: var(--screen-border); border-radius: 24px; display: flex; flex-direction: column; padding: 20px; position: relative; overflow: hidden; transition: all 0.3s ease; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
    .display-lens.pulse-active { animation: screenFlash 0.15s ease-out; }
    
    #history-list { flex: 1; overflow-y: auto; padding: 5px; display: flex; flex-direction: column-reverse; list-style: none; gap: 8px; mask-image: linear-gradient(to top, black 85%, transparent 100%); scrollbar-width: none; }
    #history-list li { text-align: right; cursor: pointer; opacity: var(--history-opacity); font-family: 'Inter', sans-serif; font-size: 1.1rem; color: var(--history-op-color); text-shadow: var(--history-glow); animation: slideIn 0.3s ease; padding: 6px 10px; border-radius: 8px; transition: all 0.2s; font-weight: 500; position: relative; overflow: hidden; }
    #history-list li:hover { opacity: 1; background: var(--edit-highlight); transform: scale(1.02) translateX(-5px); }
    #history-list b { color: var(--history-res-color); font-weight: 700; margin-left: 8px; }
    
    .display-area { flex-shrink: 0; text-align: right; padding-top: 10px; display: flex; flex-direction: column; justify-content: flex-end; min-height: 90px; z-index: 2; width: 100%; overflow: hidden; }
    #secondary-display { font-family: 'Fira Code', monospace; color: var(--accent-blue-text); text-shadow: var(--text-glow-blue); min-height: 1.5rem; font-size: 1.1rem; opacity: 0; transition: opacity 0.2s; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-bottom: 5px; }
    #secondary-display.visible { opacity: 1; }
    #main-display { font-family: 'Lexend', sans-serif; color: var(--primary-text); font-size: 3.2rem; font-weight: 500; line-height: 1.1; width: 100%; text-align: right; white-space: nowrap; overflow-x: auto; overflow-y: hidden; scrollbar-width: none; text-shadow: 0 0 25px rgba(255,255,255,0.15); transition: color 0.2s, font-size 0.1s ease-out; padding-bottom: 2px; position: relative; z-index: 2; }
    #main-display::-webkit-scrollbar { display: none; }

    /* TECLADO */
    .calculator-body { flex: 1 1 60%; width: 100%; background: var(--chassis-bg); border-top: var(--chassis-border); border-radius: 35px 35px 0 0; z-index: 10; padding: 25px; padding-bottom: max(25px, var(--safe-bottom)); box-shadow: 0 -20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; justify-content: center; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); position: relative; }
    .calculator-body::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--neon-red), var(--neon-cyan), transparent); opacity: 0.3; }
    .keypad { flex: 1; width: 100%; display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); gap: 15px; align-items: center; justify-items: center; }

    .btn { background: var(--btn-bg); color: var(--btn-text); box-shadow: var(--btn-shadow); border: var(--btn-border); font-family: 'Lexend', sans-serif; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 20px; width: 100%; height: 100%; font-size: 1.4rem; font-weight: 500; position: relative; overflow: hidden; transition: transform 0.1s, box-shadow 0.1s, color 0.1s, background 0.1s; }
    .btn.btn-large { grid-column: span 2; border-radius: 24px; }
    .btn:active, .btn.btn-active { box-shadow: var(--btn-shadow-active); transform: translateY(6px); color: var(--primary-text); }
    .btn.elastic-active { animation: elastic 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
    .btn.bounce-active { animation: bounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    .btn.op-active { background: var(--op-active-bg); color: var(--op-active-color); box-shadow: inset 0 3px 5px rgba(0,0,0,0.2); text-shadow: none; transform: translateY(1px); }

    .btn[data-key="AC"], .btn[data-key="Backspace"] { color: var(--accent-red-text); text-shadow: var(--text-glow-red); font-weight: 700; }
    .token-op, .btn[data-color="blue"] { color: var(--accent-blue-text); text-shadow: var(--text-glow-blue); font-weight: 600; font-size: 1.6rem; }
    .btn[data-color="green"] { background: var(--accent-green-bg); color: #000; border: none; box-shadow: 0 6px 0 #33691e, 0 10px 20px rgba(100, 255, 0, 0.3); }
    .btn[data-color="green"]::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: linear-gradient(to bottom, rgba(255,255,255,0.5) 0%, transparent 100%); border-radius: 20px 20px 50% 50%; opacity: 0.6; pointer-events: none; }
    .btn[data-color="green"]:active { box-shadow: inset 0 5px 15px rgba(0,0,0,0.5); transform: translateY(6px); }

    /* CRYPTO */
    .crypto-content { flex: 1; padding: 10px 15px; padding-bottom: calc(var(--safe-bottom) + 10px); display: flex; flex-direction: column; overflow-y: auto; }
    #timestamp { flex-shrink: 0; text-align: center; color: var(--secondary-text); font-size: 0.75rem; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 1px; }
    .crypto-list { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; min-height: 0; gap: 10px; }

    .card { background: var(--card-bg); border: var(--card-border); border-radius: 18px; padding: 12px 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; cursor: pointer; position: relative; overflow: hidden; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); transition: transform 0.2s, box-shadow 0.2s, background 0.2s; min-height: 70px; }
    .card:hover { transform: scale(1.02); box-shadow: 0 5px 20px rgba(0,0,0,0.2), 0 0 10px var(--edit-highlight); border-color: var(--accent-red-text); background: var(--card-hover); }
    .card.loading { pointer-events: none; }
    .card.loading::after { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent 0%, var(--skeleton-bg) 50%, transparent 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; z-index: 5; }

    .coin-logo { width: 36px; height: 36px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: transform 0.3s; }
    .card:hover .coin-logo { transform: rotate(10deg) scale(1.1); }
    .coin-info h2 { font-size: 1rem; margin: 0; color: var(--primary-text); font-weight: 700; letter-spacing: 0.5px; }
    
    .change-percentage { font-size: 0.85rem; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
    .change-positive { color: var(--crypto-up); background: rgba(0, 255, 157, 0.1); border: 1px solid rgba(0, 255, 157, 0.2); text-shadow: 0 0 8px rgba(0,255,157,0.3); }
    .change-negative { color: var(--crypto-down); background: rgba(255, 0, 51, 0.1); border: 1px solid rgba(255, 0, 51, 0.2); text-shadow: 0 0 8px rgba(255, 0, 51, 0.4); }
    
    .price-eur { font-size: 1.1rem; font-weight: 700; color: var(--primary-text); text-align: right; letter-spacing: -0.5px; }
    .price-usd { font-size: 0.8rem; color: var(--secondary-text); text-align: right; margin-top: 2px; }

    /* MODALES Y TOAST */
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--secondary-text); box-shadow: 0 0 5px currentColor; transition: 0.3s; }
    .status-dot.online { background-color: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); animation: glowPulse 1.5s ease-in-out infinite; }
    .status-dot.error { background-color: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); animation: glowPulse 1s ease-in-out infinite; }

    #chart-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; padding: 20px; }
    #chart-modal.visible { opacity: 1; pointer-events: auto; }
    .modal-content { width: 100%; max-width: 500px; background: var(--chassis-bg); border: 1px solid var(--accent-red-text); box-shadow: 0 0 40px rgba(255,0,51,0.15); border-radius: 30px; padding: 25px; transform: scale(0.9); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; flex-direction: column; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    #chart-modal.visible .modal-content { transform: scale(1); }
    .close-chart { align-self: flex-end; background: none; border: none; font-size: 2rem; color: var(--secondary-text); cursor: pointer; line-height: 1; transition: 0.2s; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .close-chart:hover { color: var(--accent-red-text); background: rgba(255,0,51,0.1); text-shadow: 0 0 10px var(--accent-red-text); transform: rotate(90deg); }
    .chart-controls { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; background: rgba(128,128,128,0.1); padding: 6px; border-radius: 14px; }
    .time-btn { background: transparent; border: none; color: var(--secondary-text); padding: 8px 16px; border-radius: 10px; font-size: 0.9rem; cursor: pointer; font-family: 'Lexend', sans-serif; font-weight: 600; transition: 0.2s; }
    .time-btn.active { background: var(--card-bg); color: var(--accent-red-text); box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-shadow: 0 0 8px rgba(255, 0, 51, 0.4); }
    .loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--neon-red); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; z-index: 10; box-shadow: 0 0 15px var(--neon-red); }
    .loading-spinner.active { display: block; }
    .toast { position: fixed; top: 90px; left: 50%; transform: translate(-50%, -20px) scale(0.9); background: rgba(10, 10, 10, 0.95); border: 1px solid var(--accent-red-text); box-shadow: 0 0 20px rgba(255, 0, 51, 0.3); color: white; padding: 12px 30px; border-radius: 40px; font-size: 1rem; opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; z-index: 200; font-weight: 600; letter-spacing: 0.5px; backdrop-filter: blur(10px); }
    .toast.show { opacity: 1; transform: translate(-50%, 0) scale(1); }
    
    @media (max-width: 380px) {
        .app-header { gap: 4px; padding: 5px; }
        .app-header .icon-btn { width: 38px; height: 38px; padding: 8px; }
        .app-title { font-size: 1rem; }
        #clock, #clock-crypto { font-size: 0.7rem; min-width: 65px; }
        .keypad { gap: 10px; }
        .btn { font-size: 1.2rem; border-radius: 16px; }
       }
    
    @media(min-width: 600px) {
        body { display: flex; align-items: center; justify-content: center; background: #050505; }
        .view-container { max-width: 420px; height: 92vh; border-radius: 45px; border: 8px solid #111; box-shadow: 0 0 0 2px #333, 0 20px 50px rgba(0,0,0,0.8), 0 0 100px rgba(255, 0, 51, 0.1); }
        .view-container { border-color: #1a1a1a; box-shadow: 0 0 0 2px #333, 0 0 60px rgba(255, 0, 51, 0.15); }
        .dynamic-bg { border-radius: 45px; }
    }
</style>
</head>
<body data-theme="dark">

    <div id="dynamic-bg-layer" class="dynamic-bg particles-bg"></div>
    <div id="grid-pattern-layer" class="dynamic-bg grid-pattern"></div>
    <div id="circuit-pattern-layer" class="dynamic-bg circuit-pattern"></div>
    <div id="crypto-waves-layer" class="dynamic-bg crypto-waves"></div>
    <div id="time-gradient-layer" class="dynamic-bg time-gradient"></div>

    <div id="particles-layer" class="particles-layer"></div>
        
    <div class="view-container">
        <div id="view-calculator" class="view active">
            <header class="app-header">
                <button class="embedded-ui icon-btn icon-swap" id="btn-mute" aria-label="Silenciar">
                    <svg class="shown" id="icon-sound-on" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    <svg class="hidden" id="icon-sound-off" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
                </button>
                               
                <a href="https://danijdzg.github.io/dani/" target="_blank" class="app-title embedded-ui">aiDANaI</a>
                
                <div id="clock" class="embedded-ui tabular-nums">0:00:00</div>
                
                <button id="btn-go-crypto" class="embedded-ui icon-btn" aria-label="Ir a Crypto">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                </button>
            </header>
        
            <div class="upper-section">
                <div class="display-lens" id="display-container">
                    <ul id="history-list"></ul>
                    <div class="display-area">
                        <div id="secondary-display" class="tabular-nums"></div>
                        <div id="main-display" class="tabular-nums">0</div>
                    </div>
                </div>
            </div>

            <div class="calculator-body">
                <div class="keypad">
                    <button class="btn" data-key="AC">AC</button>
                    <button class="btn" data-key="Backspace">⌫</button>
                    <button class="btn" data-key="%" data-color="blue">%</button>
                    <button class="btn" data-key="/" data-color="blue">÷</button>
             
                    <button class="btn" data-key="7">7</button>
                    <button class="btn" data-key="8">8</button>
                    <button class="btn" data-key="9">9</button>
                    <button class="btn" data-key="*" data-color="blue">×</button>
             
                    <button class="btn" data-key="4">4</button>
                    <button class="btn" data-key="5">5</button>
                    <button class="btn" data-key="6">6</button>
                    <button class="btn" data-key="-" data-color="blue">−</button>
  
                    <button class="btn" data-key="1">1</button>
                    <button class="btn" data-key="2">2</button>
                    <button class="btn" data-key="3">3</button>
                    <button class="btn" data-key="+" data-color="blue">+</button>

                    <button class="btn" data-key="0">0</button>
                    <button class="btn" data-key=",">,</button>
                    <button class="btn btn-large" data-key="Enter" data-color="green">=</button>
                </div>
            </div>
        </div>

        <div id="view-crypto" class="view">
            <header class="app-header">
                <div style="width:44px;"></div>
                
                <a href="https://danijdzg.github.io/dani/" target="_blank" class="app-title embedded-ui">Crypto</a>
                
                <div id="clock-crypto" class="embedded-ui tabular-nums">0:00:00</div>
                
                <button id="btn-go-calc" class="embedded-ui icon-btn" aria-label="Volver">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2" stroke-width="2"></rect><line x1="8" y1="6" x2="16" y2="6" stroke-width="2"></line><line x1="16" y1="14" x2="16" y2="14" stroke-width="3"></line><line x1="12" y1="14" x2="12" y2="14" stroke-width="3"></line><line x1="8" y1="14" x2="8" y2="14" stroke-width="3"></line><line x1="16" y1="18" x2="16" y2="18" stroke-width="3"></line><line x1="12" y1="18" x2="12" y2="18" stroke-width="3"></line><line x1="8" y1="18" x2="8" y2="18" stroke-width="3"></line></svg>
                </button>
            </header>
            
            <div class="crypto-content">
                <p id="timestamp"><span class="status-dot"></span> <span id="time-text">Conectando...</span></p>
                <div class="crypto-list">
                    <div class="card glow-border" data-id="bitcoin" data-name="Bitcoin">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/1/large/bitcoin.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>Bitcoin</h2><p class="change-percentage tabular-nums" id="bitcoin-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="bitcoin-price-eur">--</p><p class="price-usd tabular-nums" id="bitcoin-price-usd">--</p></div>
                    </div>
                    <div class="card glow-border" data-id="ethereum" data-name="Ethereum">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/279/large/ethereum.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>Ethereum</h2><p class="change-percentage tabular-nums" id="ethereum-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="ethereum-price-eur">--</p><p class="price-usd tabular-nums" id="ethereum-price-usd">--</p></div>
                    </div>
                    <div class="card glow-border" data-id="solana" data-name="Solana">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/4128/large/solana.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>Solana</h2><p class="change-percentage tabular-nums" id="solana-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="solana-price-eur">--</p><p class="price-usd tabular-nums" id="solana-price-usd">--</p></div>
                    </div>
                     <div class="card glow-border" data-id="ripple" data-name="XRP">
                        <div class="coin-details">
                            <img src="https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png" class="coin-logo" onerror="this.style.display='none'">
                            <div class="coin-info"><h2>XRP</h2><p class="change-percentage tabular-nums" id="ripple-change">--</p></div>
                        </div>
                        <div class="price-container"><p class="price-eur tabular-nums" id="ripple-price-eur">--</p><p class="price-usd tabular-nums" id="ripple-price-usd">--</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chart-modal">
        <div class="modal-content">
            <button class="close-chart" aria-label="Cerrar">&times;</button>
            <h2 id="chart-title" style="margin-bottom:15px; color: var(--primary-text); text-align: center;">Moneda</h2>
            
            <div class="chart-controls">
                <button class="time-btn" data-days="1">24h</button>
                <button class="time-btn" data-days="7">7D</button>
                <button class="time-btn active" data-days="30">30D</button>
                <button class="time-btn" data-days="365">1A</button>
            </div>

            <div style="position: relative; min-height: 250px;">
                <div id="loading-chart" class="loading-spinner"></div>
                <div id="chart-container"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <<script>
    const App = {
        expr: '',
        fresh: true,
        chart: null,
        currentCoinId: null,
        escCounter: 0,
        escTimer: null,
        audioCtx: null,
        touchStartY: 0,
        pullToRefreshActive: false,
        particleCount: 0,
        maxParticles: 60, // Reducido para rendimiento
        transitionStyles: ['flip', 'fold', 'vortex', 'glitch', 'morph'],
        currentTransition: 0,
        animationId: null,
        lastMouseX: 0,
        lastMouseY: 0,
        backgroundMode: 'calc',
        
        state: { 
            theme: 'dark', 
            muted: false, 
            history: [], 
            cryptoCache: null, 
            lastFetchTime: 0,
            chartCache: {},
            backgroundIntensity: 0.4
        },
        
        init() {
            this.loadState();
            this.updateMuteIcon();
            this.initBackgroundLayers();
            this.updateBackgroundMode('calc');
            this.startTimeBasedBackground();
            
            this.bindEvents();
            this.startClocks();
            this.renderHistoryFromState(); 
            
            // Cargar caché inicial si es válido
            if(this.state.cryptoCache) {
                this.renderCryptoData(this.state.cryptoCache, new Date(this.state.lastFetchTime));
            }
            
            setInterval(() => this.fetchPrices(), 60000);
            this.fixHeight();
            this.initAudioContext();
            this.setupPullToRefresh();
            this.setupTouchTrail();
            this.setupMouseTracking();
            
            // Desbloquear AudioContext en interacción
            const unlockAudio = () => {
                if (this.audioCtx && this.audioCtx.state === 'suspended') this.audioCtx.resume();
                document.removeEventListener('touchstart', unlockAudio);
                document.removeEventListener('click', unlockAudio);
            };
            document.addEventListener('touchstart', unlockAudio);
            document.addEventListener('click', unlockAudio);
        },

        fixHeight() {
            const doc = document.documentElement;
            const setH = () => doc.style.setProperty('--doc-height', `${window.innerHeight}px`);
            setH();
            window.addEventListener('resize', setH);
        },

        // --- BACKGROUND & VISUALS ---
        initBackgroundLayers() {
            this.updateBackgroundIntensity(this.state.backgroundIntensity);
            this.animateTimeGradient();
            this.createBackgroundParticles();
        },
        
        updateBackgroundMode(mode) {
            this.backgroundMode = mode;
            const layers = {
                'particles': document.getElementById('dynamic-bg-layer'),
                'grid': document.getElementById('grid-pattern-layer'),
                'circuit': document.getElementById('circuit-pattern-layer'),
                'crypto': document.getElementById('crypto-waves-layer'),
                'time': document.getElementById('time-gradient-layer')
            };
            
            // Transición suave de opacidades según el modo
            if (mode === 'calc') {
                layers.particles.style.opacity = '0.3';
                layers.grid.style.opacity = '0.2';
                layers.circuit.style.opacity = '0.4';
                layers.crypto.style.opacity = '0';
                layers.time.style.opacity = '0.3';
            } else { 
                layers.particles.style.opacity = '0.4';
                layers.grid.style.opacity = '0.1';
                layers.circuit.style.opacity = '0.2';
                layers.crypto.style.opacity = '0.5';
                layers.time.style.opacity = '0.2';
            }
        },
        
        startTimeBasedBackground() {
            const updateTimeBackground = () => {
                const now = new Date();
                const hours = now.getHours();
                let color1, color2, angle;
                
                if (hours >= 6 && hours < 12) {
                    color1 = '#0a1929'; color2 = '#001524'; angle = '135deg';
                } else if (hours >= 12 && hours < 18) {
                    color1 = '#1a0505'; color2 = '#000000'; angle = '45deg';
                } else if (hours >= 18 && hours < 22) {
                    color1 = '#2c0618'; color2 = '#000814'; angle = '225deg';
                } else {
                    color1 = '#000814'; color2 = '#000000'; angle = '315deg';
                }
                
                const timeLayer = document.getElementById('time-gradient-layer');
                timeLayer.style.setProperty('--time-color-1', color1);
                timeLayer.style.setProperty('--time-color-2', color2);
                timeLayer.style.setProperty('--gradient-angle', angle);
            };
            
            updateTimeBackground();
            setInterval(updateTimeBackground, 60000);
        },
        
        animateTimeGradient() {
            let angle = 135;
            const animate = () => {
                angle = (angle + 0.1) % 360;
                const el = document.getElementById('time-gradient-layer');
                if(el) el.style.setProperty('--gradient-angle', `${angle}deg`);
                this.animationId = requestAnimationFrame(animate);
            };
            animate();
        },
        
        createBackgroundParticles() {
            const particlesLayer = document.getElementById('particles-layer');
            // Reducido a 15 para mejorar rendimiento en idle
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                const size = Math.random() * 4 + 1;
                const duration = Math.random() * 20 + 10;
                particle.style.cssText = `position: absolute; width: ${size}px; height: ${size}px; background: ${this.getRandomNeonColor()}; border-radius: 50%; left: ${Math.random() * 100}%; top: ${Math.random() * 100}%; opacity: ${Math.random() * 0.3 + 0.1}; filter: blur(1px); animation: particleFloatUp ${duration}s linear infinite; will-change: transform;`;
                particlesLayer.appendChild(particle);
            }
        },
        
        updateBackgroundIntensity(intensity) {
            this.state.backgroundIntensity = intensity;
            document.querySelectorAll('.dynamic-bg').forEach(layer => layer.style.opacity = intensity);
            this.saveState();
        },
        
        setupMouseTracking() {
            document.addEventListener('mousemove', (e) => {
                this.lastMouseX = e.clientX;
                this.lastMouseY = e.clientY;
                const layer = document.getElementById('dynamic-bg-layer');
                if(layer) {
                    layer.style.setProperty('--mouse-x', `${e.clientX}px`);
                    layer.style.setProperty('--mouse-y', `${e.clientY}px`);
                }
            });
            document.addEventListener('click', (e) => this.createBackgroundRipple(e.clientX, e.clientY));
        },
        
        createBackgroundRipple(x, y) {
            const ripple = document.createElement('div');
            ripple.style.cssText = `position: fixed; left: ${x}px; top: ${y}px; width: 0; height: 0; border-radius: 50%; background: radial-gradient(circle, ${this.getRandomNeonColor()} 0%, transparent 70%); transform: translate(-50%, -50%); pointer-events: none; z-index: 998; animation: pressureWave 1s ease-out forwards;`;
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 1000);
        },
        
        setupTouchTrail() {
            let lastTouchTime = 0;
            const touchCooldown = 40; 
            const handleTrail = (x, y) => {
                const now = Date.now();
                if (now - lastTouchTime < touchCooldown) return;
                lastTouchTime = now;
                this.createTouchTrail(x, y);
            };

            document.addEventListener('touchmove', (e) => handleTrail(e.touches[0].clientX, e.touches[0].clientY), { passive: true });
            document.addEventListener('mousemove', (e) => { if(e.buttons) handleTrail(e.clientX, e.clientY); });
        },
        
        createTouchTrail(x, y) {
            if(this.particleCount > this.maxParticles) return;
            const trail = document.createElement('div');
            trail.classList.add('touch-trail');
            const size = Math.random() * 15 + 5;
            trail.style.cssText = `width: ${size}px; height: ${size}px; background: ${this.getRandomNeonColor()}; left: ${x}px; top: ${y}px; opacity: 0.7;`;
            document.getElementById('particles-layer').appendChild(trail);
            
            trail.animate([
                { transform: 'translate(0, 0) scale(1)', opacity: 0.7 }, 
                { transform: `translate(${(Math.random() - 0.5) * 30}px, ${(Math.random() - 0.5) * 30}px) scale(0.5)`, opacity: 0 }
            ], { duration: 600, easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)' }).onfinish = () => trail.remove();
        },
        
        createPressureWave(x, y, element = null) {
            const wave = document.createElement('div');
            wave.classList.add('pressure-wave-effect');
            const rect = element ? element.getBoundingClientRect() : { left: x, top: y, width: 0, height: 0 };
            const centerX = element ? rect.left + rect.width / 2 : x;
            const centerY = element ? rect.top + rect.height / 2 : y;
            wave.style.cssText = `left: ${centerX}px; top: ${centerY}px; width: 0; height: 0;`;
            document.getElementById('particles-layer').appendChild(wave);
            const finalSize = element ? Math.max(rect.width, rect.height) * 2 : 100;
            wave.animate([
                { width: '0', height: '0', opacity: 0.7, transform: 'translate(-50%, -50%) scale(0.5)' }, 
                { width: `${finalSize}px`, height: `${finalSize}px`, opacity: 0, transform: 'translate(-50%, -50%) scale(1.5)' }
            ], { duration: 600, easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)' }).onfinish = () => wave.remove();
        },
        
        createGlowBorder(element, duration = 1000) {
            element.classList.add('active', 'glow-border');
            setTimeout(() => { element.classList.remove('active'); setTimeout(() => element.classList.remove('glow-border'), 300); }, duration);
        },
        
        applyBounceEffect(element) { element.classList.add('bounce-active'); setTimeout(() => element.classList.remove('bounce-active'), 400); },
        showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = 'toast show';
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        },

        // --- CACHE HELPERS ---
        getChartCacheKey(coinId, days) { return `${coinId}_${days}`; },
        
        getCachedChartData(coinId, days) {
            const cacheKey = this.getChartCacheKey(coinId, days);
            const cached = this.state.chartCache[cacheKey];
            if (!cached) return null;
            if (Date.now() - cached.timestamp > 10 * 60 * 1000) {
                delete this.state.chartCache[cacheKey];
                this.saveState();
                return null;
            }
            return cached.data;
        },
        
        setChartCache(coinId, days, data) {
            const cacheKey = this.getChartCacheKey(coinId, days);
            this.state.chartCache[cacheKey] = { data: data, timestamp: Date.now() };
            // Limitar caché para no llenar localStorage
            const keys = Object.keys(this.state.chartCache);
            if (keys.length > 15) {
                const oldestKey = keys.reduce((a, b) => this.state.chartCache[a].timestamp < this.state.chartCache[b].timestamp ? a : b);
                delete this.state.chartCache[oldestKey];
            }
            this.saveState();
        },
        
        // --- EVENT BINDING ---
        bindEvents() {
            document.getElementById('btn-go-crypto').onclick = () => { this.updateBackgroundMode('crypto'); this.switchViewWithTransition('crypto'); };
            document.getElementById('btn-go-calc').onclick = () => { this.updateBackgroundMode('calc'); this.switchViewWithTransition('calc'); };
            document.getElementById('btn-mute').onclick = () => this.toggleMute();
            
            // Touch/Click Handling for Keypad
            document.querySelectorAll('.btn[data-key]').forEach(b => {
                const key = b.dataset.key;
                if (key === 'AC') {
                    let pressTimer;
                    let longPressTriggered = false;
                    const startPress = (e) => {
                        if(e.cancelable) e.preventDefault();
                        this.createRipple(e, b);
                        this.createPressureWave(e.clientX, e.clientY, b);
                        b.classList.add('btn-active');
                        longPressTriggered = false;
                        pressTimer = setTimeout(() => { longPressTriggered = true; this.clearAllHistory(); }, 800);
                    };
                    const endPress = () => {
                        clearTimeout(pressTimer);
                        b.classList.remove('btn-active');
                        if (!longPressTriggered) { this.haptic(10); this.handleInput('AC'); this.pulseDisplay(); }
                    };
                    b.addEventListener('pointerdown', startPress);
                    b.addEventListener('pointerup', endPress);
                    b.addEventListener('pointerleave', () => { clearTimeout(pressTimer); b.classList.remove('btn-active'); });
                } else {
                    const press = (e) => {
                        if(e.cancelable) e.preventDefault(); 
                        this.createRipple(e, b);
                        this.createPressureWave(e.clientX, e.clientY, b);
                        this.applyBounceEffect(b);
                        this.haptic(10); 
                        b.classList.add('btn-active'); 
                        this.pulseDisplay(); 
                        this.handleInput(key);
                        if (['+', '-', '*', '/', '%', 'Enter'].includes(key)) this.createButtonParticles(e, key);
                    };
                    const release = () => b.classList.remove('btn-active');
                    b.addEventListener('pointerdown', press);
                    b.addEventListener('pointerup', release);
                    b.addEventListener('pointerleave', release);
                }
            });

            // Keyboard support
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.escCounter++;
                    clearTimeout(this.escTimer);
                    this.escTimer = setTimeout(() => { this.escCounter = 0; }, 800);
                    if (this.escCounter >= 2) { this.clearAllHistory(); this.escCounter = 0; } 
                    else { this.handleInput('AC'); }
                    return;
                }
                const k = e.key === 'Enter' ? 'Enter' : (e.key === 'Backspace' ? 'Backspace' : e.key);
                if(!/^[0-9+\-*/.,=()%]$|Enter|Backspace|Delete/.test(k)) return;
                
                let vKey = k === 'Delete' ? 'AC' : (k === '.' ? ',' : k);
                if(vKey === '=') vKey = 'Enter';
                
                const btn = document.querySelector(`.btn[data-key="${vKey}"]`) || document.querySelector(`.btn[data-key="${k}"]`);
                if(btn) {
                    btn.classList.add('btn-active');
                    this.pulseDisplay();
                    setTimeout(() => btn.classList.remove('btn-active'), 100);
                    this.handleInput(vKey);
                }
            });

            // Chart Interactions
            const chartModal = document.getElementById('chart-modal');
            document.querySelectorAll('.card').forEach(c => {
                c.onclick = (e) => {
                    this.createRipple(e, c);
                    this.createPressureWave(e.clientX, e.clientY, c);
                    this.openChart(c.dataset.id, c.dataset.name);
                }
            });
            document.querySelector('.close-chart').onclick = () => {
                chartModal.classList.remove('visible');
                if(this.chart) { this.chart.destroy(); this.chart = null; }
            };
            chartModal.onclick = (e) => { if (e.target === chartModal) document.querySelector('.close-chart').click(); };

            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.onclick = (e) => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.applyBounceEffect(e.target);
                    this.updateChartData(e.target.dataset.days);
                }
            });
        },

        // --- PARTICLE SYSTEM ---
        createParticle(x, y, config = {}) {
            if (this.particleCount >= this.maxParticles) return; // Límite estricto
            
            const particle = document.createElement('div');
            const size = config.size || Math.random() * 8 + 4;
            const color = config.color || this.getRandomNeonColor();
            const shape = config.shape || this.getRandomShape();
            const lifetime = config.lifetime || Math.random() * 1.5 + 0.5;
            
            particle.className = `particle particle-${shape}`;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.background = color;
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            if (config.glow) particle.style.boxShadow = `0 0 ${size * 2}px ${color}`;
            
            // Variables CSS para la animación
            particle.style.setProperty('--tx', `${config.tx || 0}px`);
            particle.style.setProperty('--ty', `${config.ty || 0}px`);
            particle.style.setProperty('--rot', `${config.rotation || 0}deg`);
            particle.style.setProperty('--start-x', `${Math.random() * 100 - 50}px`);
            particle.style.setProperty('--end-x', `${Math.random() * 100 - 50}px`);
            
            const animName = this.getAnimationName(config.animation || 'floatUp');
            particle.style.animation = `${animName} ${lifetime}s ease-out forwards`;
            
            document.getElementById('particles-layer').appendChild(particle);
            this.particleCount++;
            
            particle.addEventListener('animationend', () => { particle.remove(); this.particleCount--; });
        },
        
        getRandomNeonColor() { return ['var(--neon-red)', 'var(--neon-cyan)', 'var(--neon-lime)', 'var(--neon-yellow)', 'var(--matrix-green)', 'var(--crypto-up)', '#ff00ff', '#00ffff'][Math.floor(Math.random() * 8)]; },
        getRandomShape() { return ['circle', 'star', 'square', 'triangle'][Math.floor(Math.random() * 4)]; },
        
        getAnimationName(type) {
            const animations = { 'floatUp': 'particleFloatUp', 'floatDown': 'particleFloatDown', 'explosion': 'particleExplosion', 'fragmentation': 'particleFragmentation', 'starFall': 'particleStarFall', 'matrixRain': 'particleMatrixRain', 'confetti': 'particleConfetti' };
            return animations[type] || 'particleFloatUp';
        },
        
        createOperationParticles(operationType, x, y) {
            // Optimizado: menos partículas
            switch(operationType) {
                case '+': case '-':
                    const direction = operationType === '+' ? 'floatUp' : 'floatDown';
                    for (let i = 0; i < 8; i++) { setTimeout(() => { this.createParticle(x + Math.random()*60-30, y, { animation: direction, color: operationType === '+' ? 'var(--crypto-up)' : 'var(--crypto-down)', size: Math.random()*5+2, glow: true }); }, i * 40); }
                    break;
                case '*':
                    for (let i = 0; i < 12; i++) { setTimeout(() => { const a = Math.random()*6.28; const d = Math.random()*40; this.createParticle(x, y, { animation: 'explosion', color: 'var(--neon-yellow)', size: Math.random()*6+3, glow: true, tx: Math.cos(a)*d, ty: Math.sin(a)*d }); }, i * 30); }
                    break;
                case '/':
                    for (let i = 0; i < 10; i++) { setTimeout(() => { const a = Math.random()*6.28; const d = 40; this.createParticle(x, y, { animation: 'fragmentation', color: 'var(--neon-cyan)', size: 4, tx: Math.cos(a)*d, ty: Math.sin(a)*d, rotation: 360 }); }, i * 30); }
                    break;
                case 'Enter':
                    for (let i = 0; i < 15; i++) { setTimeout(() => { this.createParticle(x + Math.random()*100-50, y-20, { animation: 'confetti', shape: 'star', color: this.getRandomNeonColor(), size: 5, tx: Math.random()*60-30, glow: true }); }, i * 20); }
                    break;
            }
        },
        
        createButtonParticles(event, key) {
            const rect = event.target.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            const color = this.getColorByKey(key);
            for (let i = 0; i < 5; i++) { // Reducido a 5
                setTimeout(() => {
                    const a = Math.random() * 6.28;
                    const d = Math.random() * 30;
                    this.createParticle(x, y, { animation: 'floatUp', color: color, size: Math.random() * 4 + 2, glow: true, tx: Math.cos(a)*d, ty: Math.sin(a)*d });
                }, i * 40);
            }
        },
        
        getColorByKey(key) {
            const colorMap = { '+': 'var(--crypto-up)', '-': 'var(--crypto-down)', '*': 'var(--neon-yellow)', '/': 'var(--neon-cyan)', '%': 'var(--matrix-green)', 'Enter': 'var(--neon-lime)' };
            return colorMap[key] || this.getRandomNeonColor();
        },
        
        createRipple(event, element) {
            const ripple = document.createElement('span');
            const rect = element.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = (event.clientX ? event.clientX : rect.left + rect.width/2) - rect.left - size / 2;
            const y = (event.clientY ? event.clientY : rect.top + rect.height/2) - rect.top - size / 2;
            ripple.style.cssText = `width: ${size}px; height: ${size}px; left: ${x}px; top: ${y}px;`;
            ripple.classList.add('ripple');
            element.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        },
        
        createSuccessEffect() {
            const display = document.getElementById('main-display');
            const rect = display.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            for(let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const a = Math.random() * 6.28;
                    const d = Math.random() * 60;
                    this.createParticle(centerX, centerY, { animation: 'explosion', shape: 'star', color: this.getRandomNeonColor(), size: Math.random() * 8 + 4, glow: true, tx: Math.cos(a)*d, ty: Math.sin(a)*d });
                }, i * 20);
            }
        },

        // --- NAVIGATION ---
        switchViewWithTransition(targetView) {
            const currentView = targetView === 'crypto' ? 'view-calculator' : 'view-crypto';
            const nextView = targetView === 'crypto' ? 'view-crypto' : 'view-calculator';
            const transitionStyle = this.transitionStyles[this.currentTransition];
            this.currentTransition = (this.currentTransition + 1) % this.transitionStyles.length;
            
            if(!this.state.muted) this.playTransitionSound();
            
            const currentElement = document.getElementById(currentView);
            const nextElement = document.getElementById(nextView);
            
            currentElement.classList.add(`transition-${transitionStyle}`);
            nextElement.classList.add(`transition-${transitionStyle}`);
            
            setTimeout(() => {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById(nextView).classList.add('active');
                setTimeout(() => {
                    currentElement.classList.remove(`transition-${transitionStyle}`);
                    nextElement.classList.remove(`transition-${transitionStyle}`);
                }, 100);
                
                if(targetView === 'crypto') { 
                    this.fetchPrices(); 
                    this.showToast('📊 Modo Crypto');
                } else { 
                    this.showToast('🧮 Modo Calculadora');
                }
            }, transitionStyle === 'vortex' ? 500 : 600);
        },
        
        playTransitionSound() {
            if(!this.audioCtx) return;
            try {
                if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
                const now = this.audioCtx.currentTime;
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, now);
                osc.frequency.exponentialRampToValueAtTime(880, now + 0.3);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.05, now + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            } catch(e) {}
        },

        toggleMute() {
            this.state.muted = !this.state.muted;
            this.updateMuteIcon();
            this.saveState();
            if(!this.state.muted) this.playTone('Enter');
            this.showToast(this.state.muted ? 'Silencio 🔇' : 'Sonido 🔊');
        },

        updateMuteIcon() {
            const onIcon = document.getElementById('icon-sound-on');
            const offIcon = document.getElementById('icon-sound-off');
            if(this.state.muted) {
                onIcon.classList.replace('shown', 'hidden');
                offIcon.classList.replace('hidden', 'shown');
            } else {
                offIcon.classList.replace('shown', 'hidden');
                onIcon.classList.replace('hidden', 'shown');
            }
        },

        clearAllHistory() {
            this.state.history = []; 
            this.saveState(); 
            document.getElementById('history-list').innerHTML = '';
            this.showToast('🗑️ Historial Borrado');
            this.haptic([50, 50]); 
            this.handleInput('AC'); 
        },

        pulseDisplay() {
            const lens = document.getElementById('display-container');
            lens.classList.remove('pulse-active');
            void lens.offsetWidth; 
            lens.classList.add('pulse-active');
        },

        // --- CALCULATOR LOGIC ---
        handleInput(k) {
            if(this.fresh) {
                if(!"+-*/%".includes(k) && k !== 'Enter') { this.expr=''; }
                this.fresh = false;
                document.getElementById('secondary-display').classList.remove('visible');
            }
            if (['+', '-', '*', '/', '%', 'Enter'].includes(k)) {
                const rect = document.getElementById('display-container').getBoundingClientRect();
                this.createOperationParticles(k, rect.left + rect.width/2, rect.top + rect.height/2);
            }
            
            if(k==='AC') { this.expr = ''; }
            else if(k==='Backspace') { this.expr = this.expr.toString().slice(0, -1); }
            else if(k==='Enter') { this.calculate(); }
            else if(k==='(') { this.smartParen(); }
            else if(k==='%') { this.handlePercent(); } 
            else {
                const last = this.expr.slice(-1);
                if (k === ',') k = '.';
                // PREVENIR MÚLTIPLES PUNTOS
                if (k === '.') {
                    const parts = this.expr.split(/[\+\-\*\/]/);
                    const current = parts[parts.length-1];
                    if(current.includes('.')) return;
                    if(this.expr === '' || "+-*/(".includes(last)) { this.expr += '0.'; this.render(); this.playTone(k); return; }
                }
                if ("+-*/".includes(k) && "+-*/".includes(last)) { 
                    this.expr = this.expr.slice(0, -1) + k;
                } else { 
                    this.expr += k; 
                }
            }
            this.render();
            this.playTone(k);
        },

        handlePercent() {
            if (!this.expr) return;
            const match = this.expr.match(/(\d+(\.\d+)?)$/);
            if (!match) return;
            const currentVal = parseFloat(match[0]);
            this.expr = this.expr.substring(0, this.expr.length - match[0].length) + (currentVal / 100).toString();
            this.fresh = false;
            this.render();
        },

        calculate() {
            if(!this.expr) return;
            try {
                let formattedExpr = this.expr.replace(/\*/g, '×').replace(/\//g, '÷');
                let clean = this.expr.replace(/[^0-9+\-*/().]/g, '');
                // Sanitización básica
                if(clean.includes('/0') && !clean.match(/\/0\./)) throw new Error("DIV_ZERO");
                
                // Paréntesis balanceados?
                const open = (clean.match(/\(/g)||[]).length;
                const close = (clean.match(/\)/g)||[]).length;
                if(open !== close) throw new Error("PAREN");
                
                let res = new Function('return ' + clean)();
                if(!isFinite(res) || isNaN(res)) throw new Error("INVALID");
                
                // Formateo de precisión
                res = parseFloat(parseFloat(res).toPrecision(12)); 
                
                this.addToHistoryState(this.expr, res);
                this.expr = String(res); 
                this.fresh = true;
                
                const secDisp = document.getElementById('secondary-display');
                secDisp.innerText = formattedExpr + ' =';
                secDisp.classList.add('visible');
                
                const d = document.getElementById('main-display');
                d.classList.remove('pop-active');
                void d.offsetWidth;
                d.classList.add('pop-active');
                this.createSuccessEffect();
            } catch(e) { 
                this.handleError(e);
            }
            this.render();
        },
        
        handleError(e) {
            const dContainer = document.getElementById('display-container');
            dContainer.classList.add('shake-active');
            setTimeout(() => dContainer.classList.remove('shake-active'), 300);
            
            let msg = "❌ Error";
            if(e.message === "DIV_ZERO") msg = "⚠️ División por 0";
            if(e.message === "PAREN") msg = "⚠️ Paréntesis ()";
            
            this.showToast(msg);
            this.haptic([50, 100]);
            const d = document.getElementById('main-display');
            d.style.color = 'var(--neon-red)';
            setTimeout(() => d.style.color = '', 800);
        },

        smartParen() {
            const o = (this.expr.match(/\(/g)||[]).length;
            const c = (this.expr.match(/\)/g)||[]).length;
            const last = this.expr.slice(-1);
            if(o > c && (/[0-9.]$/.test(last) || last===')')) this.expr += ')';
            else if(/[0-9.]$/.test(last) || last===')') this.expr += '*(';
            else this.expr += '(';
            this.render();
        },

        render() {
            const d = document.getElementById('main-display');
            if(!this.expr) { d.innerHTML = '0'; d.style.fontSize = '3.2rem'; return; }
            
            // Highlight de operador activo
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('op-active'));
            const lastChar = this.expr.slice(-1);
            if ("+-*/".includes(lastChar)) {
                const opMap = {'+':'+', '-':'-', '*':'*', '/':'/'};
                const btn = document.querySelector(`.btn[data-key="${opMap[lastChar]}"]`);
                if(btn) btn.classList.add('op-active');
            }
            
            // Renderizado HTML coloreado
            const parts = this.expr.split(/([\+\-\*\/])/);
            let h = '';
            parts.forEach((p) => {
                if(p==='') return;
                if("+-*/".includes(p)) { 
                    const op = p.replace('*','×').replace('/','÷'); 
                    h += `<span class="token token-op" style="margin:0 2px">${op}</span>`;
                } else {
                    if(!isNaN(parseFloat(p))) { 
                        let [int, dec] = p.split('.'); 
                        const intF = int ? parseInt(int).toLocaleString('es-ES') : '';
                        const fInt = (int === '0' || int === '') && p.startsWith('0') ? '0' : intF;
                        h += dec !== undefined ? `<span>${fInt}<span class="small-decimal">,${dec}</span></span>` : `<span>${fInt}</span>`;
                    } else { h += p; }
                }
            });
            d.innerHTML = h;
            
            // Escalado dinámico de fuente
            const len = d.innerText.length;
            const size = len > 7 ? Math.max(1.4, 3.2 - ((len - 7) * 0.22)) : 3.2;
            d.style.fontSize = `${size}rem`;
            d.scrollLeft = d.scrollWidth;
        },

        addToHistoryState(ex, r) {
            const item = { expr: ex, res: r, date: Date.now() };
            this.state.history.unshift(item); 
            if (this.state.history.length > 20) this.state.history.pop(); 
            this.saveState();
            this.renderHistoryItem(item, true); 
        },

        renderHistoryFromState() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            [...this.state.history].reverse().forEach(item => this.renderHistoryItem(item, false));
        },

        renderHistoryItem(item, isNew) {
            const li = document.createElement('li');
            const resF = item.res.toLocaleString('es-ES', { maximumFractionDigits: 10 });
            let pretty = item.expr.replace(/\*/g, '×').replace(/\//g, '÷');
            li.innerHTML = `${pretty} = <b>${resF}</b>`;
            li.onclick = () => { 
                this.expr = String(item.res); 
                this.fresh = true; 
                this.render(); 
                this.haptic(10);
            };
            const list = document.getElementById('history-list');
            list.prepend(li); 
        },

        // --- CRYPTO FETCHING ---
        async fetchPrices(force = false) {
            const dot = document.querySelector('.status-dot');
            const label = document.getElementById('time-text');
            
            // Check cache en memoria
            const now = Date.now();
            if (!force && this.state.cryptoCache && (now - this.state.lastFetchTime < 60000)) {
                this.renderCryptoData(this.state.cryptoCache, new Date(this.state.lastFetchTime));
                return;
            }

            document.querySelectorAll('.card').forEach(c => c.classList.add('loading'));
            dot.className = 'status-dot'; 
            label.innerText = "Actualizando...";

            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 8000);
                const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,ripple&vs_currencies=eur,usd&include_24hr_change=true', { signal: controller.signal });
                
                if(res.status === 429) throw new Error("Límite API");
                if(!res.ok) throw new Error("Error API");
                
                const d = await res.json();
                this.state.cryptoCache = d;
                this.state.lastFetchTime = Date.now();
                this.saveState();
                this.renderCryptoData(d, new Date());
                
            } catch(e) { 
                if (this.state.cryptoCache) {
                    this.renderCryptoData(this.state.cryptoCache, new Date(this.state.lastFetchTime));
                    dot.style.backgroundColor = 'var(--neon-yellow)'; 
                    label.innerText = "Modo Offline";
                } else {
                    dot.className = 'status-dot error';
                    label.innerText = "Sin conexión";
                }
            } finally {
                document.querySelectorAll('.card').forEach(c => c.classList.remove('loading'));
            }
        },

        renderCryptoData(d, dateObj) {
            const fmtEur = new Intl.NumberFormat('es-ES', {style:'currency', currency:'EUR'});
            const fmtUsd = new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'});
            ['bitcoin','ethereum','solana','ripple'].forEach(id => {
                if(d[id]) {
                    document.getElementById(`${id}-price-eur`).textContent = fmtEur.format(d[id].eur);
                    document.getElementById(`${id}-price-usd`).textContent = fmtUsd.format(d[id].usd);
                    const chg = d[id].eur_24h_change;
                    const cEl = document.getElementById(`${id}-change`);
                    cEl.innerText = (chg>0?'+':'') + chg.toFixed(2)+'%';
                    cEl.className = `change-percentage tabular-nums ${chg>=0?'change-positive':'change-negative'}`;
                }
            });
            const dot = document.querySelector('.status-dot');
            const label = document.getElementById('time-text');
            if(label.innerText !== "Modo Offline") {
                dot.className = 'status-dot online';
                dot.style.backgroundColor = '';
                label.innerText = `Actualizado: ${dateObj.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}`;
            }
        },

        async openChart(id, name) {
            this.currentCoinId = id;
            document.getElementById('chart-title').innerText = name;
            document.getElementById('chart-modal').classList.add('visible');
            if(this.chart) { this.chart.destroy(); this.chart = null; }
            await this.initChart();
            this.updateChartData(30);
        },

        async initChart() {
            const options = {
                series: [],
                chart: { type: 'area', height: 250, toolbar:{show:false}, background:'transparent', animations: { enabled: true, speed: 500 } }, // Animación más rápida
                theme: { mode: 'dark' },
                stroke: { curve: 'smooth', width: 2 },
                fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1 } },
                dataLabels: { enabled: false },
                xaxis: { type: 'datetime', tooltip:{enabled:false}, axisBorder:{show:false}, labels: { show: false } },
                yaxis: { show: true, labels: { style:{ colors:'var(--secondary-text)' }, formatter: v=>v.toLocaleString('es-ES',{maximumFractionDigits:0}) + '€' } },
                grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 5, padding: { left: 10, right: 0 } },
                tooltip: { theme: 'dark', x: { format: 'dd MMM HH:mm' } }
            };
            this.chart = new ApexCharts(document.querySelector("#chart-container"), options);
            await this.chart.render();
        },

        async updateChartData(days) {
            const spinner = document.getElementById('loading-chart');
            spinner.classList.add('active');
            
            const cachedData = this.getCachedChartData(this.currentCoinId, days);
            
            if (cachedData) {
                this.renderChartData(cachedData);
                spinner.classList.remove('active');
                return;
            }

            try {
                const url = `https://api.coingecko.com/api/v3/coins/${this.currentCoinId}/market_chart?vs_currency=eur&days=${days}`;
                const res = await fetch(url);
                if(res.status === 429) throw new Error("⏳ Límite API. Espera.");
                if(!res.ok) throw new Error("Error API");
                const data = await res.json();
                if(!data.prices || data.prices.length === 0) throw new Error("Sin datos");

                this.setChartCache(this.currentCoinId, days, data.prices);
                this.renderChartData(data.prices);

            } catch(e) { this.showToast(e.message); } 
            finally { spinner.classList.remove('active'); }
        },
        
        renderChartData(prices) {
            const isPositive = prices[prices.length-1][1] >= prices[0][1];
            const color = isPositive ? '#00ff9d' : '#ff0033';
            if(this.chart) {
                this.chart.updateOptions({ colors: [color] });
                this.chart.updateSeries([{ name: 'Precio', data: prices }]);
            }
        },

        // --- UTILS ---
        setupPullToRefresh() {
            const content = document.querySelector('.crypto-content');
            if(!content) return;
            content.addEventListener('touchstart', (e) => { if(content.scrollTop === 0) this.touchStartY = e.touches[0].clientY; }, { passive: true });
            content.addEventListener('touchmove', (e) => {
                if(this.touchStartY && !this.pullToRefreshActive && content.scrollTop === 0) {
                    if((e.touches[0].clientY - this.touchStartY) > 100) {
                        this.pullToRefreshActive = true;
                        this.showToast('🔄 Recargando...');
                        this.fetchPrices(true);
                        this.haptic(20);
                        setTimeout(() => { this.touchStartY = 0; this.pullToRefreshActive = false; }, 1000);
                    }
                }
            }, { passive: true });
        },
        
        haptic(pattern) { if (navigator.vibrate) try { navigator.vibrate(pattern); } catch(e) {} },
        saveState() { localStorage.setItem('aidanaiUltimate', JSON.stringify(this.state)); },
        loadState() { try { const s = JSON.parse(localStorage.getItem('aidanaiUltimate')); if(s) this.state = {...this.state, ...s}; } catch(e) {} },
        
        startClocks() {
            const update = () => {
                const s = new Date().toLocaleTimeString('es-ES', {hour:'numeric', minute:'2-digit', second:'2-digit'});
                document.querySelectorAll('#clock, #clock-crypto').forEach(e => e.innerText = s);
            };
            update(); setInterval(update, 1000);
        },
        
        initAudioContext() { try { this.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { this.audioCtx = null; } },
        
        playTone(key) {
            if(this.state.muted || !this.audioCtx) return;
            try {
                if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.type = 'sine';
                const freqs = { 'Enter': 880, 'AC': 440, 'Backspace': 392, '%': 523, '+': 659, '-': 587, '*': 698, '/': 784 };
                osc.frequency.value = freqs[key] || 1046;
                const now = this.audioCtx.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.1, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } catch(e) {}
        }
    };
    
    // Limpieza de partículas huérfanas
    setInterval(() => {
        const p = document.querySelectorAll('.particle');
        if(p.length > 50) { for(let i=0; i<p.length-50; i++) p[i].remove(); App.particleCount = 50; }
    }, 5000);
    
    window.addEventListener('load', () => App.init());
</script>
</body>
</html>