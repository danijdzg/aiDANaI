<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>aiDANaI-Calculadora Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#222738">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* === PALETA DE COLORES Y ESTILO: "NEUMORFISMO SUAVE" === */
        :root {
            /* Colores Base */
            --bg-color-dark: #1e2230;
            --bg-color-light: #2c3144;
            --surface-color: #262b3c;
            
            /* Colores de Texto */
            --primary-text: #f0f4f8;
            --secondary-text: #828a9e;
            
            /* Acentos Vibrantes */
            --accent-cyan: #00f5d4;
            --accent-magenta: #ff007f;
            --accent-yellow: #fce205;

            /* Colores para los Botones */
            --btn-shadow-light: rgba(44, 49, 66, 0.9);
            --btn-shadow-dark: rgba(22, 25, 36, 0.7);

            /* Espaciado */
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;

            /* Radios */
            --border-radius: 28px;
        }

        /* --- Reset y Estilos Globales --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; /* Elimina el resaltado azul en los toques */
        }

        html { 
            height: 100%; 
            font-family: 'Poppins', -apple-system, sans-serif; 
        }

        body { 
            height: 100vh; 
            width: 100%; 
            overflow: hidden; 
            color: var(--primary-text); 
            /* Gradiente sutil para darle profundidad al fondo */
            background: radial-gradient(circle, var(--bg-color-light) 0%, var(--bg-color-dark) 100%); 
        }

        .app-container { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- Área del Historial y Display --- */
        .paper-roll-container { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            padding: env(safe-area-inset-top) var(--spacing-lg) 0 var(--spacing-lg); 
            overflow: hidden; 
            min-height: 0;
        }

        #history-list { 
            flex: 1; 
            list-style: none; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column-reverse; 
            scrollbar-width: none; /* Oculta scrollbar en Firefox */
            /* Degradado suave para un efecto "fade out" elegante */
            mask-image: linear-gradient(to top, black 70%, transparent 100%);
            -webkit-mask-image: linear-gradient(to top, black 70%, transparent 100%);
        }

        #history-list::-webkit-scrollbar { display: none; } /* Oculta scrollbar en Chrome/Safari */

        #history-list li { 
            text-align: right; 
            padding: 14px 5px; 
            cursor: pointer; 
            border-bottom: 1px solid rgba(240, 244, 248, 0.05);
            opacity: 0.8;
            transition: opacity 0.2s ease, background-color 0.2s ease;
        }
        #history-list li:hover { 
            opacity: 1; 
            background-color: rgba(255,255,255,0.03);
        }
        
        .history-expression { color: var(--secondary-text); font-size: 1.2rem; font-weight: 300; pointer-events: none; }
        .history-result { font-size: 2.2rem; font-weight: 500; margin-top: 4px; pointer-events: none; }
        
        .display-wrapper { padding: var(--spacing-md) 0; }

        .main-display { 
            font-size: 4rem;
            font-weight: 300; 
            text-align: right; 
            word-wrap: break-word; 
            word-break: break-all;
            outline: none; 
            min-height: 60px;
            /* Efecto de texto brillante */
            background: linear-gradient(120deg, var(--accent-cyan), #fff 80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .main-display:empty::before { 
            content: "0";
            background: var(--primary-text);
            -webkit-background-clip: text;
        }
        
        /* --- Contenedor del Teclado --- */
        .calculator { 
            flex-shrink: 0; 
            height: auto; 
            padding: var(--spacing-lg) var(--spacing-md) calc(var(--spacing-md) + env(safe-area-inset-bottom));
            background-color: rgba(0,0,0,0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* --- Teclado (Keypad) --- */
        .keypad { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(5, 1fr); 
            gap: var(--spacing-md); 
            flex: 1; 
        }
        
        /* Estilo base de los botones con Neumorfismo */
        .keypad button { 
            border: none; 
            border-radius: var(--border-radius);
            font-size: 1.7rem; 
            font-weight: 500; 
            cursor: pointer; 
            color: var(--primary-text);
            background-color: var(--surface-color);
            transition: all 0.15s ease-out;
            box-shadow: 
                5px 5px 10px var(--btn-shadow-dark),
                -5px -5px 10px var(--btn-shadow-light);
        }

        /* Efecto de pulsación */
        .keypad button:active, 
        .keypad button.active { 
            box-shadow: 
                inset 5px 5px 10px var(--btn-shadow-dark),
                inset -5px -5px 10px var(--btn-shadow-light);
            font-size: 1.6rem;
            transition-duration: 0s;
            transform: scale(0.98);
        }
        
        /* Colores específicos de botones */
        .keypad .function { color: var(--accent-yellow); } 
        .keypad .operator { color: var(--accent-magenta); font-weight: 600; font-size: 2rem; }
        .keypad .equals { 
            background: var(--accent-cyan); 
            color: var(--bg-color-dark);
            font-size: 2.2rem;
            font-weight: 600;
        } 
        
        .keypad .zero { 
            grid-column: span 2; 
            text-align: left; 
            padding-left: var(--spacing-lg); 
        }
        
        /* Media Query para pantallas grandes */
        @media (min-width: 600px) and (min-height: 700px) {
            body { 
                padding: 20px; 
                display: flex; 
                justify-content: center; 
                align-items: center; 
            }
            .app-container { 
                max-width: 420px; 
                height: 95vh; 
                max-height: 900px; 
                border-radius: 50px;
                overflow: hidden;
                box-shadow: 0 0 100px rgba(0, 245, 212, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.05);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="paper-roll-container">
            <ul id="history-list"></ul>
            <div class="display-wrapper">
                <div class="main-display" id="main-display"></div>
            </div>
        </div>
        
        <div class="calculator">
             <div class="keypad">
                <button class="function" id="clear-btn" data-key="Escape" onclick="handleClear()">AC</button>
                <button class="function" data-key="(" onclick="appendSymbol('(')">(</button>
                <button class="function" data-key=")" onclick="appendSymbol(')')">)</button>
                <button class="operator" data-key="/" onclick="appendSymbol('÷')">÷</button>
                <button class="number-key" data-key="7" onclick="appendSymbol('7')">7</button>
                <button class="number-key" data-key="8" onclick="appendSymbol('8')">8</button>
                <button class="number-key" data-key="9" onclick="appendSymbol('9')">9</button>
                <button class="operator" data-key="*" onclick="appendSymbol('×')">×</button>
                <button class="number-key" data-key="4" onclick="appendSymbol('4')">4</button>
                <button class="number-key" data-key="5" onclick="appendSymbol('5')">5</button>
                <button class="number-key" data-key="6" onclick="appendSymbol('6')">6</button>
                <button class="operator" data-key="-" onclick="appendSymbol('-')">−</button>
                <button class="number-key" data-key="1" onclick="appendSymbol('1')">1</button>
                <button class="number-key" data-key="2" onclick="appendSymbol('2')">2</button>
                <button class="number-key" data-key="3" onclick="appendSymbol('3')">3</button>
                <button class="operator" data-key="+" onclick="appendSymbol('+')">+</button>
                <button class="number-key zero" data-key="0" onclick="appendSymbol('0')">0</button>
                <button class="number-key" data-key="." onclick="appendSymbol('.')">.</button>
                <button class="equals" data-key="Enter" onclick="calculate()">=</button>
            </div>
        </div>
    </div>

    <script>
        // === CÓDIGO JAVASCRIPT COMPLETO, CORREGIDO Y ROBUSTO ===

        const mainDisplay = document.getElementById('main-display');
        const historyList = document.getElementById('history-list');
        const clearBtn = document.getElementById('clear-btn');
        let expression = ''; // La variable principal, se mantiene como string
        let history = []; 
        
        let lastClearPressTime = 0;
        const doublePressThreshold = 400;

        // === Formateo de Números (con más protecciones) ===
        function formatNumber(numStr) { 
            let safeNumStr = String(numStr);
            if (!safeNumStr || ["Error", "Error de Sintaxis", "Expresión no válida"].includes(safeNumStr)) return safeNumStr;
            let [integerPart, decimalPart] = safeNumStr.split('.');
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); 
            return decimalPart !== undefined ? `${integerPart},${decimalPart}` : integerPart;
        }

        function formatExpressionForDisplay(expr) {
            if (!expr) return '0'; 
            const safeExpr = String(expr); 
            const parts = safeExpr.split(/([+\-×÷()])/);
            return parts.map(part => !isNaN(parseFloat(part)) && isFinite(part) && part !== '' ? formatNumber(part) : part).join('');
        }

        // === Lógica del Teclado ===
        function backspace() { 
            let currentExpr = String(expression);
            expression = (["Error", "Error de Sintaxis", "Expresión no válida"].includes(currentExpr)) 
                ? '' 
                : currentExpr.slice(0, -1);
            updateDisplay(); 
        }
        
        function appendSymbol(symbol) {
            let currentExpr = String(expression);
            if (["Error", "Error de Sintaxis", "Expresión no válida"].includes(currentExpr)) {
                currentExpr = '';
            }
            if (symbol === '.') { 
                const segments = currentExpr.split(/[+\-×÷()]/); 
                if (segments[segments.length - 1].includes('.')) return; 
            } 
            if (currentExpr.length >= 24) return; 
            expression = currentExpr + symbol; 
            updateDisplay(); 
        }

        function updateDisplay() { 
            mainDisplay.innerText = formatExpressionForDisplay(expression); 
            clearBtn.innerText = expression === '' ? 'AC' : 'C'; 
        }

        // === Motor de Cálculo ===
        function evaluateExpression(expr) {
            try {
                const sanitizedExpr = String(expr).replace(/×/g, '*').replace(/÷/g, '/').replace(/--/g, '+');
                if (/[^0-9.\+\-\*\/()\s]/.test(sanitizedExpr) || sanitizedExpr === '') return { error: "Expresión no válida" };
                const result = new Function('return ' + sanitizedExpr)();
                if (isNaN(result) || !isFinite(result)) return { error: "Error" };

                // Controlar precisión decimal para evitar errores de coma flotante
                let maxDecimalPlaces = 0;
                const numbers = sanitizedExpr.match(/\d+(\.\d+)?/g);
                if (numbers) {
                    numbers.forEach(numStr => {
                        if (numStr.includes('.')) {
                            maxDecimalPlaces = Math.max(maxDecimalPlaces, numStr.split('.')[1].length);
                        }
                    });
                }
                const finalResult = parseFloat(result.toFixed(Math.min(maxDecimalPlaces, 10)));
                return { result: finalResult };
            } catch {
                return { error: "Error de Sintaxis" };
            }
        }
        
        // === Lógica de Botones Principales (Clear y Calculate) ===
        function handleClear() {
            const currentTime = Date.now();
            if (currentTime - lastClearPressTime < doublePressThreshold) {
                history = [];
                renderHistory();
                expression = '';
                lastClearPressTime = 0;
            } else {
                expression = '';
                lastClearPressTime = currentTime;
            }
            updateDisplay();
        }

        function calculate() { 
            const currentExpr = String(expression).trim();
            if (currentExpr === '' || /[+\-×÷.]$/.test(currentExpr)) return; 
            
            const { result, error } = evaluateExpression(currentExpr); 
            
            if (error) { 
                expression = error;
            } else { 
                addToHistory(currentExpr, result); 
                // *** LA CORRECCIÓN CRÍTICA: Se convierte el resultado numérico a string ***
                expression = String(result); 
            } 
            updateDisplay();
        }
        
        // === Lógica del Historial ===
        function addToHistory(expr, res) { 
            const newEntry = { id: Date.now(), expression: expr, result: res };
            history.unshift(newEntry); 
            if (history.length > 50) history.pop(); 
            renderHistory(); 
        }

        function renderHistory() { 
            historyList.innerHTML = ''; 
            history.forEach(entry => { 
                const li = document.createElement('li'); 
                li.dataset.id = entry.id; 
                li.innerHTML = `<div class="history-expression">${formatExpressionForDisplay(entry.expression)}</div><div class="history-result">${formatNumber(entry.result)}</div>`; 
                li.addEventListener('click', () => recallFromHistory(entry.id)); 
                historyList.appendChild(li); 
            }); 
        }

        function recallFromHistory(entryId) { 
            const entry = history.find(e => e.id === entryId); 
            if (entry) { 
                expression = String(entry.result); 
                updateDisplay(); 
            } 
        }
        
        // === Manejador del Teclado Físico ===
        document.addEventListener('keydown', (e) => { 
            e.preventDefault(); 
            const key = e.key;
            const button = document.querySelector(`button[data-key="${key === ',' ? '.' : key}"]`);
            if (key === 'Backspace') { backspace(); }
            if (button) { 
                button.classList.add('active'); 
                setTimeout(() => button.classList.remove('active'), 150); 
                button.click(); 
            } 
        });

        // Inicializa la aplicación al cargar
        updateDisplay();
    </script>
</body>
</html>