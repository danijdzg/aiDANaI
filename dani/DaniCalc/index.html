<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>aiDANaI-Calculadora</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* El CSS no necesita cambios y se mantiene intacto */
        :root {
            --bg-color: #000000;
            --surface-color: rgba(14, 21, 58, 0.2);
            --primary-text: #e6f1ff;
            --secondary-text: #7b88a1;
            --accent-purple: #9d00ff;
            --accent-orange: #ff5f00;
            --accent-green: #00ff9d;
            --accent-blue: #00ccff;
            --border-radius: 20px;
            --spacing: 16px;
        }
        @keyframes resultPulse {
            0% { text-shadow: 0 0 8px var(--accent-green), 0 0 16px var(--accent-green); }
            100% { text-shadow: 0 0 0 transparent; }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; font-family: 'Poppins', sans-serif; }
        body {
            height: 100vh; width: 100%;
            background-color: var(--bg-color);
            overflow: hidden;
            color: var(--primary-text);
        }
        .app-container { 
            position: relative; width: 100%; height: 100%; display: flex; 
            flex-direction: column; background: transparent;
        }
        .paper-roll-container { flex: 1; display: flex; flex-direction: column; padding: env(safe-area-inset-top) var(--spacing) 0 var(--spacing); overflow: hidden; min-height: 0; }
        #history-list {
            flex: 1; list-style: none; overflow-y: auto; display: flex; flex-direction: column-reverse; scrollbar-width: none;
            -webkit-mask-image: linear-gradient(to top, black 70%, transparent 100%);
        }
        #history-list::-webkit-scrollbar { display: none; }
        #history-list li {
            text-align: right; padding: 10px; margin-bottom: 6px; cursor: pointer;
            border-radius: 10px; transition: background-color 0.2s ease;
        }
        #history-list li:hover { background: var(--surface-color); }
        .history-expression { color: var(--secondary-text); font-size: 1.1rem; }
        .history-result { font-size: 2rem; font-weight: 500; color: var(--primary-text); }
        .display-wrapper { padding: var(--spacing) 0; }
        .main-display {
            font-size: 4.5rem; font-weight: 300; text-align: right; word-wrap: break-word; word-break: break-all;
            outline: none; min-height: 68px; color: var(--accent-green);
            text-shadow: 0 0 8px var(--accent-green);
        }
        .main-display:empty::before { content: "0"; color: var(--secondary-text); text-shadow: none; }
        .main-display.result-pulse { animation: resultPulse 0.5s ease-out; }
        .calculator { flex-shrink: 0; padding: var(--spacing) var(--spacing) calc(var(--spacing) + env(safe-area-inset-bottom)); }
        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); gap: var(--spacing); }
        .keypad button {
            border-radius: var(--border-radius); font-size: 1.8rem; font-weight: 500; cursor: pointer;
            background: var(--surface-color); border: 1px solid rgba(0, 204, 255, 0.2);
            color: var(--primary-text); transition: all 0.1s ease;
        }
        .keypad button:active, .keypad button.active {
            transform: scale(0.96); background: rgba(0, 204, 255, 0.15);
            box-shadow: 0 0 15px rgba(0, 204, 255, 0.5); border-color: rgba(0, 204, 255, 0.7);
        }
        .keypad .function { color: var(--accent-purple); text-shadow: 0 0 5px var(--accent-purple); border-color: rgba(157, 0, 255, 0.3); }
        .keypad .operator { color: var(--accent-orange); font-size: 2rem; text-shadow: 0 0 5px var(--accent-orange); border-color: rgba(255, 95, 0, 0.3); }
        .keypad .equals {
            background: var(--accent-green); color: #000; font-size: 2rem; font-weight: 600;
            border: none; box-shadow: 0 0 10px var(--accent-green), 0 0 20px var(--accent-green) inset;
        }
        .keypad .equals:active, .keypad .equals.active { background: #fff; box-shadow: 0 0 25px var(--accent-green); }
        .keypad .zero { grid-column: span 2; text-align: left; padding-left: 28px; }
        @media (min-width: 600px) {
            body { display: flex; justify-content: center; align-items: center; }
            .app-container {
                max-width: 400px; max-height: 850px; width: 100%; height: 95vh;
                border-radius: 40px; overflow: hidden;
                border: 1px solid rgba(0, 204, 255, 0.3);
                box-shadow: 0 0 50px rgba(0, 204, 255, 0.2);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="paper-roll-container">
            <ul id="history-list"></ul>
            <div class="display-wrapper">
                <div class="main-display" id="main-display"></div>
            </div>
        </div>
        
        <div class="calculator">
             <div class="keypad">
                <button class="function" id="clear-btn" data-key="Escape" onclick="handleClear()">AC</button>
                <button class="function" data-key="(" onclick="appendSymbol('(')">(</button>
                <button class="function" data-key=")" onclick="appendSymbol(')')">)</button>
                <button class="operator" data-key="/" onclick="appendSymbol('÷')">÷</button>
                <button class="number-key" data-key="7" onclick="appendSymbol('7')">7</button>
                <button class="number-key" data-key="8" onclick="appendSymbol('8')">8</button>
                <button class="number-key" data-key="9" onclick="appendSymbol('9')">9</button>
                <button class="operator" data-key="*" onclick="appendSymbol('×')">×</button>
                <button class="number-key" data-key="4" onclick="appendSymbol('4')">4</button>
                <button class="number-key" data-key="5" onclick="appendSymbol('5')">5</button>
                <button class="number-key" data-key="6" onclick="appendSymbol('6')">6</button>
                <button class="operator" data-key="-" onclick="appendSymbol('-')">−</button>
                <button class="number-key" data-key="1" onclick="appendSymbol('1')">1</button>
                <button class="number-key" data-key="2" onclick="appendSymbol('2')">2</button>
                <button class="number-key" data-key="3" onclick="appendSymbol('3')">3</button>
                <button class="operator" data-key="+" onclick="appendSymbol('+')">+</button>
                <button class="number-key zero" data-key="0" onclick="appendSymbol('0')">0</button>
                <!-- MODIFICACIÓN CLAVE DEL HTML -->
                <button class="number-key" data-key="," onclick="appendSymbol(',')">,</button>
                <button class="equals" data-key="Enter" onclick="calculate()">=</button>
            </div>
        </div>
    </div>

    <script>
        // === JAVASCRIPT CON FORMATO DE NÚMEROS LOCALIZADO ===

        const mainDisplay = document.getElementById('main-display');
        const historyList = document.getElementById('history-list');
        const clearBtn = document.getElementById('clear-btn');
        let expression = ''; let history = []; let lastClearPressTime = 0;
        const doublePressThreshold = 400;

        mainDisplay.addEventListener('animationend', () => mainDisplay.classList.remove('result-pulse'));
        
        function triggerPulseAnimation() { mainDisplay.classList.add('result-pulse'); }
        
        // *** FUNCIÓN DE FORMATEO MODIFICADA ***
        function formatNumber(numStr) { 
            let safeNumStr = String(numStr);
            if (!safeNumStr || ["Error", "Error de Sintaxis", "Expresión no válida"].includes(safeNumStr)) return safeNumStr;
            let [integerPart, decimalPart] = safeNumStr.split('.');
            
            // Separador de miles: punto (.)
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); 
            
            // Separador decimal: coma (,)
            return decimalPart !== undefined ? `${integerPart},${decimalPart}` : integerPart;
        }

        // Esta función no necesita cambios, ya que depende de la lógica de formatNumber()
        function formatExpressionForDisplay(expr) {
            if (!expr) return ''; 
            const safeExpr = String(expr);
            return safeExpr.split(/([+\-×÷()])/).map(part => !isNaN(parseFloat(part.replace(/,/g, '.'))) && isFinite(part.replace(/,/g, '.')) && part !== '' ? formatNumber(part) : part).join('');
        }

        // *** FUNCIÓN DE AÑADIR SÍMBOLOS MODIFICADA ***
        function appendSymbol(symbol) {
            let currentExpr = String(expression);
            if (["Error", "Error de Sintaxis", "Expresión no válida"].includes(currentExpr)) currentExpr = '';
            
            // Lógica para evitar múltiples comas
            if (symbol === ',') {
                const segments = currentExpr.split(/[+\-×÷()]/);
                if (segments[segments.length - 1].includes(',')) return;
            }

            if (currentExpr.length >= 24) return;
            expression = currentExpr + symbol;
            updateDisplay();
        }

        function updateDisplay() { mainDisplay.innerText = formatExpressionForDisplay(expression); clearBtn.innerText = expression === '' ? 'AC' : 'C'; }
        
        function backspace() { expression = String(expression).slice(0, -1); updateDisplay(); }

        // *** MOTOR DE CÁLCULO MODIFICADO ***
        function evaluateExpression(expr) {
            try {
                // Pre-procesamiento para que JavaScript entienda los números:
                // 1. Quitamos los puntos de miles.
                let machinereadableExpr = String(expr).replace(/\./g, '');
                // 2. Reemplazamos la coma decimal por un punto.
                machinereadableExpr = machinereadableExpr.replace(/,/g, '.');

                const sanitizedExpr = machinereadableExpr.replace(/×/g, '*').replace(/÷/g, '/');

                if (/[^0-9.\+\-\*\/()\s]/.test(sanitizedExpr) || sanitizedExpr === '') return { error: "Expresión no válida" };
                const result = new Function('return ' + sanitizedExpr)();

                if (isNaN(result) || !isFinite(result)) return { error: "Error" };
                let maxDecimalPlaces = 0;
                sanitizedExpr.match(/\d+(\.\d+)?/g)?.forEach(numStr => {
                    if (numStr.includes('.')) maxDecimalPlaces = Math.max(maxDecimalPlaces, numStr.split('.')[1].length);
                });
                return { result: parseFloat(result.toFixed(Math.min(maxDecimalPlaces, 10))) };
            } catch { return { error: "Error de Sintaxis" }; }
        }

        function handleClear() {
            const currentTime = Date.now();
            if (currentTime - lastClearPressTime < doublePressThreshold) {
                history = []; renderHistory(); expression = '';
                lastClearPressTime = 0;
            } else { expression = ''; lastClearPressTime = currentTime; }
            updateDisplay();
        }

        function calculate() { 
            const currentExpr = String(expression).trim();
            if (currentExpr === '' || /[+\-×÷,]$/.test(currentExpr)) return;
            const { result, error } = evaluateExpression(currentExpr);
            if (error) { expression = error; }
            else { addToHistory(currentExpr, result); expression = String(result); }
            updateDisplay();
            triggerPulseAnimation();
        }

        function addToHistory(expr, res) { 
            history.unshift({ id: Date.now(), expression: expr, result: res }); 
            if (history.length > 50) history.pop(); 
            renderHistory(); 
        }

        function renderHistory() { 
            historyList.innerHTML = ''; 
            history.forEach(entry => { 
                const li = document.createElement('li'); 
                li.innerHTML = `<div class="history-expression">${formatExpressionForDisplay(entry.expression)}</div><div class="history-result">${formatNumber(entry.result)}</div>`; 
                li.addEventListener('click', () => recallFromHistory(entry.id)); 
                historyList.appendChild(li); 
            }); 
        }

        function recallFromHistory(id) { 
            const entry = history.find(e => e.id === id); 
            if (entry) { expression = String(entry.result); updateDisplay(); }
        }

        // *** MANEJADOR DEL TECLADO FÍSICO MODIFICADO ***
        document.addEventListener('keydown', (e) => { 
            e.preventDefault();
            let key = e.key;

            // Mapea tanto el punto como la coma a nuestro separador decimal
            if (key === '.') key = ',';

            const button = document.querySelector(`button[data-key="${key}"]`);
            if (key === 'Backspace') backspace();
            if (button) { button.classList.add('active'); button.click(); setTimeout(() => button.classList.remove('active'), 150); } 
        });

        updateDisplay();
    </script>
</body>
</html>