<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>DaniCalc Portarrollos</title>
    
    <!-- PWA Manifest y Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --primary-text: #ffffff;
            --secondary-text: #bebebe;
            
            --btn-dark-grey: #333333;
            --btn-dark-grey-active: #737373;
            --btn-light-grey: #a5a5a5;
            --btn-light-grey-active: #d9d9d9;
            --btn-light-grey-text: #000000;
            --btn-orange: #ff9500;
            --btn-orange-active: #fcc280;
            --btn-orange-text-active: #ff9500;

            --spacing: 14px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; font-family: 'Poppins', -apple-system, sans-serif; }
        body { height: 100%; width: 100%; overflow: hidden; color: var(--primary-text); background: var(--bg-color); }

        /* === LA ESTRUCTURA PRINCIPAL: FLEXBOX AL RESCATE === */
        .app-container {
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column; /* Apila el portarrollos encima del teclado */
            background: var(--bg-color);
        }

        /* --- 1. ZONA DEL PORTARROLLOS (Pantalla y Historial) --- */
        .paper-roll-container {
            flex: 1; /* ¡CLAVE! Ocupa todo el espacio sobrante */
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 25px 0 25px;
            overflow: hidden; /* Evita que el contenido se desborde */
        }

        #history-list {
            flex: 1;
            list-style: none;
            overflow-y: auto; /* Permite scroll */
            display: flex;
            flex-direction: column-reverse; /* ¡CLAVE! Muestra el último item abajo */
            scrollbar-width: none; /* Oculta scrollbar */
        }
        #history-list::-webkit-scrollbar { display: none; }
        /* Efecto de difuminado para indicar que hay más historial arriba */
        .paper-roll-container { mask-image: linear-gradient(to top, black 85%, transparent 100%); }
        
        #history-list li {
            text-align: right;
            padding: 10px 0;
            border-bottom: 1px dotted #222;
        }
        #history-list .history-expression { color: var(--secondary-text); font-size: 1.1rem; }
        #history-list .history-result { font-size: 2rem; font-weight: 500; }

        .display-wrapper { padding: 15px 0; flex-shrink: 0; }
        .main-display {
            font-size: 3.5rem; font-weight: 300;
            text-align: right; word-wrap: break-word; outline: none;
            min-height: 50px;
        }
        .main-display:empty::before { content: "0"; }

        /* --- 2. ZONA DE LA CALCULADORA (Teclado) --- */
        .calculator {
            flex-shrink: 0; /* No permite que se encoja */
            height: 50vh; /* ¡CLAVE! Ocupa la mitad de la pantalla en móvil */
            display: flex;
            flex-direction: column;
            padding: 0 var(--spacing) calc(var(--spacing) + env(safe-area-inset-bottom));
            transition: all 0.3s ease-in-out;
        }
        .keypad {
            flex-grow: 1; display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: var(--spacing);
        }
        .keypad button {
            border-radius: 50%; aspect-ratio: 1 / 1; border: none;
            font-size: 1.8rem; font-weight: 500; cursor: pointer;
            color: var(--primary-text);
            transition: background-color 0.15s ease;
        }
        .keypad button:active { transition-duration: 0s; }
        .keypad .number-key { background-color: var(--btn-dark-grey); }
        .keypad .number-key:active, .keypad .number-key.active { background-color: var(--btn-dark-grey-active); }
        .keypad .function { background-color: var(--btn-light-grey); color: var(--btn-light-grey-text); }
        .keypad .function:active, .keypad .function.active { background-color: var(--btn-light-grey-active); }
        .keypad .operator { background-color: var(--btn-orange); }
        .keypad .operator:active, .keypad .operator.active { background-color: var(--btn-orange-active); color: var(--btn-orange); }
        .keypad .zero { grid-column: span 2; border-radius: 50px; aspect-ratio: auto; text-align: left; padding-left: 30px; }

        /* Botón para ocultar teclado, se posiciona en el portarrollos */
        #toggle-keypad-btn { display: none; /* Oculto en móvil */ }

        /* --- MODO DESKTOP Y PANTALLAS ANCHAS --- */
        @media (min-width: 550px) {
            body { padding: 20px; }
            .app-container {
                max-width: 400px; max-height: 850px;
                border-radius: 40px;
                box-shadow: 0 0 50px rgba(255, 255, 255, 0.1);
            }
            .paper-roll-container {
                position: relative; /* Para posicionar el botón */
            }
            #toggle-keypad-btn {
                display: block; position: absolute;
                bottom: 10px; left: 50%;
                transform: translateX(-50%);
                background: #111; border: 1px solid #333;
                color: #888; padding: 5px 15px;
                border-radius: 20px; cursor: pointer;
                font-size: 0.8rem; opacity: 0.7; transition: all 0.2s;
            }
            #toggle-keypad-btn:hover { opacity: 1; color: #fff; border-color: #555; }
            
            /* Lógica de ocultar teclado */
            .app-container.keypad-hidden .calculator {
                height: 0; padding: 0; opacity: 0; visibility: hidden;
            }
            .app-container.keypad-hidden #toggle-keypad-btn {
                background: var(--btn-orange); color: var(--btn-light-grey-text);
                opacity: 1; border-color: transparent;
            }
             .main-display[contenteditable="true"] {
                caret-color: var(--btn-orange);
                background: #111; padding: 10px; border-radius: 10px;
             }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Contenedor Superior: Portarrollos + Pantalla -->
        <div class="paper-roll-container">
            <ul id="history-list">
                <!-- Las operaciones se añaden aquí con JS -->
            </ul>
            <div class="display-wrapper">
                <div class="main-display" id="main-display" contenteditable="false"></div>
            </div>
            <button id="toggle-keypad-btn">Mostrar/Ocultar Teclado</button>
        </div>
        
        <!-- Contenedor Inferior: Teclado -->
        <div class="calculator">
            <div class="keypad">
                <button class="function" id="clear-btn" data-key="Escape" onclick="handleClear()">AC</button><button class="function" data-key="(" onclick="appendSymbol('(')">(</button><button class="function" data-key=")" onclick="appendSymbol(')')">)</button><button class="operator" data-key="/" onclick="appendSymbol('÷')">÷</button><button class="number-key" data-key="7" onclick="appendSymbol('7')">7</button><button class="number-key" data-key="8" onclick="appendSymbol('8')">8</button><button class="number-key" data-key="9" onclick="appendSymbol('9')">9</button><button class="operator" data-key="*" onclick="appendSymbol('×')">×</button><button class="number-key" data-key="4" onclick="appendSymbol('4')">4</button><button class="number-key" data-key="5" onclick="appendSymbol('5')">5</button><button class="number-key" data-key="6" onclick="appendSymbol('6')">6</button><button class="operator" data-key="-" onclick="appendSymbol('-')">−</button><button class="number-key" data-key="1" onclick="appendSymbol('1')">1</button><button class="number-key" data-key="2" onclick="appendSymbol('2')">2</button><button class="number-key" data-key="3" onclick="appendSymbol('3')">3</button><button class="operator" data-key="+" onclick="appendSymbol('+')">+</button><button class="number-key zero" data-key="0" onclick="appendSymbol('0')">0</button><button class="number-key" data-key="." onclick="appendSymbol('.')">.</button><button class="operator" data-key="Enter" onclick="calculate()">=</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const mainDisplay = document.getElementById('main-display');
        const historyList = document.getElementById('history-list');
        const appContainer = document.querySelector('.app-container');
        const toggleKeypadBtn = document.getElementById('toggle-keypad-btn');
        const clearBtn = document.getElementById('clear-btn');
        
        // App State
        let expression = '';
        let calculationDone = false;
        
        // --- LOGIC ---
        function handleClear() {
            expression = '';
            calculationDone = false;
            updateDisplay();
        }

        function appendSymbol(symbol) {
            const isOperator = ['+', '-', '×', '÷'].includes(symbol);
            if (calculationDone && !isOperator && symbol !== '.') expression = '';
            if (calculationDone && isOperator) expression = getResultFromDisplay();
            calculationDone = false;
            
            if (expression.length > 20) return; // Limitar longitud
            if (expression === '0' && symbol === '0') return;
            if (expression === '0' && symbol !== '.') expression = '';

            expression += symbol;
            updateDisplay();
        }

        function getResultFromDisplay() {
             return mainDisplay.innerText.replace(/,/g, '.'); // Convierte comas de vuelta a puntos
        }
        
        function updateDisplay() {
            mainDisplay.innerText = expression === '' ? '' : expression.replace(/\./g, ',');
            clearBtn.innerText = expression === '' ? 'AC' : 'C';
        }
        
        function calculate() {
            let exprToEval = mainDisplay.isContentEditable ? mainDisplay.innerText.replace(/,/g, '.') : expression;
            if (exprToEval.trim() === '') return;
            try {
                const evalExpr = exprToEval.replace(/×/g, '*').replace(/÷/g, '/');
                if (/[^0-9\.\+\-\*\/(\)\s]/.test(evalExpr)) throw new Error("Invalid");
                const result = new Function('return ' + evalExpr)();
                if (isNaN(result) || !isFinite(result)) throw new Error("Error");

                let formattedResult = parseFloat(result.toPrecision(15));
                
                addToHistory(exprToEval.replace(/\*/g, '×').replace(/\//g, '÷'), formattedResult);
                
                expression = formattedResult.toString();
                mainDisplay.innerText = expression.replace(/\./g, ',');
                calculationDone = true;

            } catch (error) {
                mainDisplay.innerText = 'Error';
                expression = '';
            }
        }
        
        function addToHistory(expr, result) {
            const li = document.createElement('li');
            li.innerHTML = `
                <span class="history-expression">${expr}</span>
                <span class="history-result">${result.toString().replace(/\./g, ',')}</span>
            `;
            historyList.prepend(li); // Añade el nuevo item al principio (que es abajo visualmente)
            if (historyList.children.length > 50) historyList.lastChild.remove();
        }
        
        // --- EVENT HANDLERS ---
        toggleKeypadBtn.addEventListener('click', () => {
            const isHidden = appContainer.classList.toggle('keypad-hidden');
            mainDisplay.contentEditable = isHidden;
            if (isHidden) mainDisplay.focus();
        });

        mainDisplay.addEventListener('input', () => { if (mainDisplay.isContentEditable) expression = mainDisplay.innerText.replace(/,/g, '.'); updateDisplay(); });

        document.addEventListener('keydown', (event) => {
            const { key } = event;
            if (mainDisplay.isContentEditable && key !== 'Enter' && key !== 'Escape') return;
            event.preventDefault();
            
            if (key === 'Enter') {
                calculate();
            } else if (key === 'Escape') {
                handleClear();
            } else if (key === 'Backspace') {
                expression = expression.slice(0, -1);
                updateDisplay();
            } else {
                const button = document.querySelector(`button[data-key="${key}"]`);
                if (button) {
                    button.click();
                    button.classList.add('active');
                    setTimeout(() => button.classList.remove('active'), 100);
                }
            }
        });
        
        updateDisplay();
    </script>
</body>
</html>