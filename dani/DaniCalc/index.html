<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>aiDANaI-Calculadora</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#02041b">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #02041b;
            --primary-text: #E6F1FF;
            --secondary-text: #5b6883;
            --neon-green: #00FF9D;
            --neon-purple: #00AFFF;   /* AZUL BRILLANTE */
            --neon-orange: #FF1744;   /* ROJO BRILLANTE */
            --neon-cyan: #00CCFF;
            --border-radius: 24px;
            --spacing: clamp(12px, 3vw, 18px);
        }

        @keyframes resultPulse {
            0% { text-shadow: 0 0 5px var(--bg-color), 0 0 12px var(--neon-green), 0 0 25px var(--neon-green); transform: scale(1.03); }
            100% { text-shadow: 0 0 4px var(--bg-color), 0 0 10px var(--neon-green); transform: scale(1); }
        }
        
        @keyframes cosmicVortex {
            0% { transform: rotate(0deg) scale(1.5); }
            100% { transform: rotate(360deg) scale(1.5); }
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; font-family: 'Poppins', sans-serif; }
        
        body {
            height: 100vh; width: 100vw;
            background-color: var(--bg-color);
            overflow: hidden;
            color: var(--primary-text);
        }

        #background-vortex {
            position: fixed; top: 50%; left: 50%;
            width: 150vmax; height: 150vmax;
            background: radial-gradient(ellipse at center, rgba(13, 33, 86, 0.4) 0%, rgba(2, 4, 27, 0) 60%);
            animation: cosmicVortex 90s linear infinite;
        }
        
        .app-container { 
            position: relative; z-index: 1;
            width: 100%; height: 100%; 
            display: flex; flex-direction: column; 
            backdrop-filter: blur(80px); -webkit-backdrop-filter: blur(80px);
        }
        
        .paper-roll-container {
            height: 50%;
            display: flex; flex-direction: column; 
            padding: env(safe-area-inset-top) var(--spacing) 0 var(--spacing); 
            overflow: hidden;
        }

        #history-list {
            flex: 1; list-style: none; overflow-y: auto;
            display: flex; flex-direction: column-reverse; 
            scrollbar-width: none;
            -webkit-mask-image: linear-gradient(to top, black 75%, transparent 100%);
        }
        #history-list::-webkit-scrollbar { display: none; }
        
        #history-list li {
            text-align: right; padding: 8px 12px; margin-bottom: 8px; cursor: pointer;
            border-radius: 14px; transition: background-color 0.2s, transform 0.2s;
        }
        #history-list li:hover { background: rgba(255, 255, 255, 0.05); transform: translateX(-5px); }

        .history-expression { color: var(--secondary-text); font-size: 1rem; }
        .history-result { font-size: 1.8rem; font-weight: 500; }
        
        .display-wrapper {
            padding-bottom: var(--spacing); display: flex;
            flex-direction: column; justify-content: flex-end;
            min-height: 100px;
        }
        
        /* ============================================================== */
        /* ===          MODIFICACIÓN: AJUSTE DE FUENTE DEL DISPLAY    === */
        /* ============================================================== */
        .main-display {
            /* 
               Valores anteriores: clamp(2.8rem, 13vw, 4.2rem)
               Hemos reducido el mínimo, el escalado y el máximo para que quepan
               más dígitos en la pantalla sin sacrificar la legibilidad.
            */
            font-size: clamp(2.0rem, 11vw, 3.4rem); 
            font-weight: 300; text-align: right; 
            word-wrap: break-word; word-break: break-all;
            color: var(--neon-green);
            text-shadow: 0 0 4px var(--bg-color), 0 0 10px var(--neon-green);
            line-height: 1.1;
            transition: font-size 0.2s ease-out; /* Suaviza el cambio de tamaño si es necesario */
        }
        .main-display:empty::before { content: "0"; color: var(--secondary-text); text-shadow: none; }
        .main-display.result-pulse { animation: resultPulse 0.6s ease-out; }

        .calculator {
            height: 50%;
            padding: var(--spacing) var(--spacing) calc(var(--spacing) + env(safe-area-inset-bottom));
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(0, 204, 255, 0.2);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        
        .keypad { 
            height: 100%; display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(5, 1fr); 
            gap: var(--spacing);
        }

        .keypad button {
            border-radius: var(--border-radius); 
            font-size: 1.9rem; font-weight: 400; 
            cursor: pointer; background: rgba(14, 25, 45, 0.4);
            border: 1px solid rgba(0, 204, 255, 0.25); color: var(--primary-text);
            transition: transform 0.1s ease-out, background-color 0.1s ease-out;
            display: flex; align-items: center; justify-content: center;
        }
        
        .keypad button:active,
        .keypad button.key-press { 
            transform: scale(0.92); 
        }
        .keypad .function { color: var(--neon-purple); border-color: rgba(157, 0, 255, 0.3); }
        .keypad .operator { color: var(--neon-orange); font-size: 2.3rem; border-color: rgba(255, 95, 0, 0.3); }
        
        .keypad .equals {
            grid-column: span 2;
            background: rgba(0, 255, 157, 0.2);
            border: 1px solid var(--neon-green); color: #fff;
            font-size: 2.8rem; font-weight: 600; text-shadow: 0 0 15px #fff;
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.5), 0 0 25px rgba(0, 255, 157, 0.3) inset;
        }
        .keypad .equals:active,
        .keypad .equals.key-press { 
            transform: scale(0.95); background: var(--neon-green) !important;
            color: var(--bg-color) !important; text-shadow: none !important;
            box-shadow: 0 0 30px var(--neon-green), 0 0 50px var(--neon-green) !important; 
        }
        
        @media (min-width: 450px) {
            body { display: flex; justify-content: center; align-items: center; }
            .app-container {
                max-width: 400px; max-height: 850px; 
                width: 100%; height: 95vh;
                border-radius: 50px; overflow: hidden;
                border: 1px solid rgba(0, 204, 255, 0.25);
                box-shadow: 0 0 80px rgba(0, 50, 100, 0.3);
            }
        }
    </style>
</head>
<body>

    <div id="background-vortex"></div>

    <div class="app-container">
        <div class="paper-roll-container">
            <ul id="history-list"></ul>
            <div class="display-wrapper">
                <div class="main-display" id="main-display"></div>
            </div>
        </div>
        
        <div class="calculator">
             <div class="keypad">
                <button class="function" id="clear-btn" data-key="Escape">AC</button>
                <button class="function" data-key="Backspace">⌫</button>
                <button class="function" data-key="%">%</button>
                <button class="operator" data-key="/">÷</button>
                
                <button data-key="7">7</button>
                <button data-key="8">8</button>
                <button data-key="9">9</button>
                <button class="operator" data-key="*">×</button>
                
                <button data-key="4">4</button>
                <button data-key="5">5</button>
                <button data-key="6">6</button>
                <button class="operator" data-key="-">−</button>
                
                <button data-key="1">1</button>
                <button data-key="2">2</button>
                <button data-key="3">3</button>
                <button class="operator" data-key="+">+</button>
                
                <button data-key="0">0</button>
                <button data-key=".">,</button>
                <button class="equals" data-key="Enter">=</button>
            </div>
        </div>
    </div>

    <script>
        const mainDisplay = document.getElementById('main-display');
        const historyList = document.getElementById('history-list');
        const keypad = document.querySelector('.keypad');
        const clearBtn = document.getElementById('clear-btn');
        
        let expression = '';
        let history = [];
        let justCalculated = false;

        function hapticFeedback() {
            if (navigator.vibrate) navigator.vibrate(20);
        }
        
        function formatNumberWithSeparators(value) {
            if (!value) return value;
            if (isNaN(parseFloat(value)) && value.length > 1) {
                 return value.replace(/\./g, ',');
            }
        
            let parts = String(value).split('.');
            let integerPart = parts[0];
            let decimalPart = parts.length > 1 ? parts[1] : '';
        
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
            return decimalPart ? `${integerPart},${decimalPart}` : integerPart;
        }

        function updateDisplay() {
    // 1. Reemplazamos los operadores internos por los visuales para el display.
    let displayValue = formatExpressionForDisplay(expression);

    // 2. Dividimos la expresión por los operadores, pero los conservamos.
    //    Esto crea un array con números y operadores por separado.
    //    Ej: "1234.5*67" -> ["1234.5", "*", "67"]
    const parts = displayValue.split(/([+\-×÷])/);

    // 3. Formateamos cada parte individualmente.
    const formattedParts = parts.map(part => {
        // Si la parte es un número (no un operador), la formateamos.
        if (!isNaN(part) && part.trim() !== '') {
            return formatNumberWithSeparators(part);
        }
        // Si es un operador o está vacío, lo devolvemos tal cual.
        return part;
    });

    // 4. Unimos las partes ya formateadas y las mostramos.
    mainDisplay.innerText = formattedParts.join('');
}
        
        function formatExpressionForDisplay(expr) {
            return String(expr).replace(/\*/g, '×').replace(/\//g, '÷');
        }

        function appendSymbol(symbol) {
            hapticFeedback();
            if (justCalculated && '0123456789'.includes(symbol)) {
                expression = '';
            }
            justCalculated = false;

            if (["Error", "Error de Sintaxis", "Expresión no válida"].includes(expression)) {
                expression = '';
            }

            if (symbol === '.') {
                const segments = expression.split(/[+\-*/]/);
                if (segments.pop().includes('.')) return;
            }
            expression += symbol === ',' ? '.' : symbol;
            updateDisplay();
        }

        function backspace() {
            hapticFeedback();
            if (expression === '' || justCalculated) return;
            expression = String(expression).slice(0, -1);
            justCalculated = false;
            updateDisplay();
        }

        function handleClear() {
            hapticFeedback();
            if (clearBtn.innerText === 'AC') {
                history = [];
                renderHistory();
            }
            expression = '';
            justCalculated = false;
            updateDisplay();
        }

        function calculate() { 
            hapticFeedback();
            const currentExpr = String(expression).trim();
            if (currentExpr === '' || /[+\-×÷.]$/.test(currentExpr)) return;
            const exprForEval = currentExpr.replace(/%/g, '/100');
            const { result, error } = evaluateExpression(exprForEval);

            if (error) {
                expression = error; 
            } else {
                addToHistory(currentExpr, result); 
                expression = String(result);
                justCalculated = true;
            }
            updateDisplay();
            mainDisplay.classList.add('result-pulse');
        }

        function evaluateExpression(expr) {
            try {
                const sanitizedExpr = expr.replace(/×/g, '*').replace(/÷/g, '/');
                if (/[^0-9.\+\-\*\/()\s%]/.test(sanitizedExpr)) return { error: "Expresión no válida" };
                const result = new Function('return ' + sanitizedExpr)();
                if (isNaN(result) || !isFinite(result)) return { error: "Error" };
                return { result: parseFloat(result.toPrecision(12)) };
            } catch { return { error: "Error de Sintaxis" }; }
        }

        function addToHistory(expr, res) { 
            history.unshift({ id: Date.now(), expression: expr, result: res }); 
            if (history.length > 50) history.pop(); 
            renderHistory(); 
        }

        function renderHistory() { 
            historyList.innerHTML = ''; 
            history.forEach(entry => { 
                const li = document.createElement('li');
                const formattedExpr = formatExpressionForDisplay(entry.expression);
                const formattedResult = formatNumberWithSeparators(String(entry.result));
                li.innerHTML = `<div class="history-expression">${formattedExpr}=</div><div class="history-result">${formattedResult}</div>`; 
                li.addEventListener('click', () => recallFromHistory(entry.id)); 
                historyList.appendChild(li); 
            });
            if (history.length > 0) historyList.scrollTop = 0;
        }

        function recallFromHistory(id) { 
            const entry = history.find(e => e.id === id); 
            if (entry) { 
                hapticFeedback();
                expression = String(entry.result); 
                justCalculated = true;
                updateDisplay(); 
            }
        }

        mainDisplay.addEventListener('animationend', () => mainDisplay.classList.remove('result-pulse'));
        
        keypad.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            
            const key = button.dataset.key;
            if (key) {
                switch(key) {
                    case 'Enter': calculate(); break;
                    case 'Escape': handleClear(); break;
                    case 'Backspace': backspace(); break;
                    default: appendSymbol(key); break;
                }
            }
        });

        document.addEventListener('keydown', (e) => {
            e.preventDefault();
            const button = document.querySelector(`button[data-key="${e.key}"]`);
            if (button) {
                button.click();
                button.classList.add('key-press');
                setTimeout(() => button.classList.remove('key-press'), 150);
            } else if (e.key === 'c' || e.key === 'C') {
                const clearButton = document.getElementById('clear-btn');
                clearButton.click();
                clearButton.classList.add('key-press');
                setTimeout(() => clearButton.classList.remove('key-press'), 150);
            }
        });
        
        updateDisplay();
    </script>
</body>
</html>