<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Viewport optimizado: sin zoom, ajuste safe areas -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#050a14">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="aiDANaI Suite Premium">
    <title>aiDANaI Suite</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- Fuentes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Lexend:wght@300;400;500;700&family=Poppins:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Librería Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <style>
        :root { 
            /* Colores Base */
            --neon-red: #FF1744;
            --neon-blue: #0088FF;
            --neon-green: #00E676;
            --neon-purple: #bb86fc;
            --bitcoin-orange: #F7931A;
            --crypto-green: #03dac6;
            --crypto-red: #ff6b6b;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            
            /* Altura del header fija para cálculos */
            --header-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        html, body { 
            height: 100dvh; width: 100vw; 
            font-family: 'Poppins', sans-serif; 
            overflow: hidden; 
            background-color: var(--bg-color);
            transition: background 0.4s ease;
        }

        /* === TEMAS === */
        body[data-theme="dark"] { 
            --bg-color:#050a14; 
            /* CAMBIO: Fondo del teclado más claro y azulado para resaltar */
            --keypad-bg: #151b26; 
            --card-bg: linear-gradient(145deg, #12161f, #0b0e14);
            
            --inset-shadow: inset 3px 3px 6px #06080d, inset -3px -3px 6px #161d2b;
            --border-ui: rgba(255,255,255,0.05);
            --primary-text: #e0e6ed;
            --secondary-text: #8b9bb4;
            --display-lens-bg: #030508;
            --display-lens-border: rgba(255,255,255,0.05);
            
            /* Botones 3D Dark */
            --btn-shadow-idle: 0 8px 15px rgba(0,0,0,0.5), 0 4px 0 #090c12, inset 0 2px 5px rgba(255,255,255,0.08);
            --btn-shadow-active: 0 2px 5px rgba(0,0,0,0.4), 0 0 0 #090c12, inset 0 2px 10px rgba(0,0,0,0.6);
            --btn-face-normal: radial-gradient(120% 120% at 30% 30%, #2b323f 0%, #151921 60%, #080a0f 100%);
            --btn-text: #fff;
            
            /* Colores Botones */
            --bg-red: radial-gradient(120% 120% at 30% 30%, #ff5252 0%, #d50000 60%, #800000 100%);
            --bg-blue: radial-gradient(120% 120% at 30% 30%, #448aff 0%, #2962ff 60%, #002171 100%);
            --enter-bg: radial-gradient(120% 120% at 30% 30%, #69f0ae 0%, #00c853 50%, #003300 100%);
            --enter-text: #000;
            --edit-highlight: rgba(0, 136, 255, 0.2);
        }
        
        body[data-theme="light"] { 
            --bg-color: #dce0e6;
            /* CAMBIO: Fondo del teclado blanco puro para resaltar sobre el gris */
            --keypad-bg: #f8f9fa; 
            --card-bg: linear-gradient(145deg, #ffffff, #e6e6e6);

            --inset-shadow: inset 5px 5px 10px #b8bec9, inset -5px -5px 10px #ffffff;
            --border-ui: rgba(255,255,255,0.6);
            --primary-text: #2d3436; 
            --secondary-text: #636e72;
            --display-lens-bg: #cfd6df;
            --display-lens-border: rgba(255,255,255,0.8);

            /* Botones 3D Light */
            --btn-shadow-idle: 5px 10px 15px rgba(160,170,180, 0.3), 0 4px 0 #b0b6c2, inset 0 2px 4px rgba(255,255,255,0.9);
            --btn-shadow-active: 2px 5px 10px rgba(160,170,180, 0.3), 0 0 0 #b0b6c2, inset 0 2px 8px rgba(160,170,180, 0.5);
            --btn-face-normal: radial-gradient(120% 120% at 30% 30%, #ffffff 0%, #f0f2f5 50%, #cbd2db 100%);
            --btn-text: #333;
            
            --bg-red: radial-gradient(circle at 30% 30%, #ff8a80 0%, #d32f2f 60%, #b71c1c 100%);
            --bg-blue: radial-gradient(circle at 30% 30%, #82b1ff 0%, #1976d2 60%, #0d47a1 100%);
            --enter-bg: radial-gradient(circle at 30% 30%, #b9f6ca 0%, #00e676 50%, #00a000 100%);
            --enter-text: #004d2a;
            --edit-highlight: rgba(25, 118, 210, 0.15);
        }

        /* === LAYOUT SPA === */
        .view-container {
            width: 100%; height: 100%; position: relative; overflow: hidden;
        }

        .view {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            background-color: var(--bg-color);
        }

        .view.active {
            opacity: 1; pointer-events: auto;
            transform: scale(1); z-index: 10;
        }

        /* === HEADER === */
        .app-header {
            flex: 0 0 auto; display: flex; align-items: center;
            padding: max(var(--safe-top), 15px) 20px 10px; 
            z-index: 20; gap: 12px;
            height: calc(var(--header-height) + var(--safe-top));
        }

        .embedded-ui {
            background: var(--bg-color);
            box-shadow: var(--inset-shadow);
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border-ui);
            transition: 0.2s;
        }

        .icon-btn { width: 44px; height: 44px; cursor: pointer; color: var(--secondary-text); padding: 10px; }
        .icon-btn:active { transform: scale(0.95); color: var(--primary-text); }
        
        .app-title { 
            font-family: 'Lexend', sans-serif; font-weight: 700; font-size: 1.1rem; 
            color: var(--neon-red); padding: 8px 15px; 
            flex-grow: 1; text-align: center; white-space: nowrap;
        }

        #clock, #clock-crypto {
            font-family: 'Fira Code', monospace; font-weight: 600; font-size: 0.85rem;
            color: var(--neon-green); padding: 8px 12px; min-width: 95px; text-align: center;
        }

        /* === CALCULADORA: LAYOUT 50/50 === */
        
        /* Parte Superior (Rollo Papel) */
        .upper-section {
            flex: 1 1 50%; 
            height: 50%;
            display: flex; flex-direction: column;
            padding: 5px 20px 15px; 
            min-height: 0; 
        }

        .display-lens {
            width: 100%; height: 100%;
            background: var(--display-lens-bg);
            border: 1px solid var(--display-lens-border);
            border-radius: 20px;
            box-shadow: inset 0 10px 30px rgba(0,0,0,0.3); 
            display: flex; flex-direction: column;
            padding: 15px; position: relative; overflow: hidden;
        }

        #history-list { 
            flex: 1; overflow-y: auto; padding: 5px; 
            display: flex; flex-direction: column-reverse;
            list-style: none; gap: 12px;
            mask-image: linear-gradient(to top, black 85%, transparent 100%);
            scrollbar-width: none;
        }
        #history-list::-webkit-scrollbar { display: none; }

        #history-list li {
            text-align: right; cursor: pointer; opacity: 0.5; 
            font-family: 'Inter', sans-serif; font-size: 1rem;
            color: var(--secondary-text);
        }
        #history-list li:hover { opacity: 1; transform: translateX(-5px); }
        #history-list b { color: var(--primary-text); }

        .display-area {
            flex-shrink: 0; text-align: right; padding-top: 10px;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        #secondary-display { 
            font-family: 'Fira Code', monospace; color: var(--secondary-text); 
            height: 1.2rem; font-size: 0.9rem; opacity: 0;
        }
        #secondary-display.visible { opacity: 1; }
        #main-display { 
            font-family: 'Lexend', sans-serif; color: var(--primary-text); 
            font-size: 2.5rem; font-weight: 500; line-height: 1.1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            word-wrap: break-word; word-break: break-all;
        }
        
        /* Parte Inferior (Teclado) */
        .calculator-body {
            flex: 1 1 50%;
            height: 50%;
            width: 100%; 
            background: var(--keypad-bg); /* Color diferenciado */
            border-radius: 30px 30px 0 0;
            z-index: 10; padding: 15px 20px; 
            padding-bottom: max(15px, var(--safe-bottom));
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2); 
            display: flex; flex-direction: column;
        }
        .keypad {
            flex: 1; width: 100%; display: grid;
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(5, 1fr); 
            gap: 10px;
            align-items: center; justify-items: center;
        }

        .btn {
            background: var(--btn-face-normal); color: var(--btn-text);
            box-shadow: var(--btn-shadow-idle); transition: 0.05s; 
            border: none; font-family: 'Lexend', sans-serif; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            border-radius: 16px; 
            height: 100%; width: 100%; 
            font-size: clamp(1rem, 2vh, 1.3rem); font-weight: 500;
        }
        .btn:active, .btn.btn-active { 
            box-shadow: var(--btn-shadow-active); 
            transform: translateY(3px); 
        }
        .btn-wide { grid-column: span 2; border-radius: 20px; }
        
        .btn[data-color="red"] { background: var(--bg-red); color: #fff; }
        .btn[data-color="blue"] { background: var(--bg-blue); color: #fff; }
        .btn[data-color="green"] { background: var(--enter-bg); color: var(--enter-text); }
        
        .token-op { color: var(--neon-blue); margin: 0 2px; }
        .token-selected { background: var(--edit-highlight); border-radius: 4px; }

        /* === CRYPTO STYLES === */
        .crypto-content {
            flex: 1; overflow-y: auto; padding: 20px;
            padding-bottom: calc(var(--safe-bottom) + 20px);
        }
        #timestamp { text-align: center; color: var(--secondary-text); font-size: 0.8rem; margin-bottom: 20px; }
        
        .card {
            background: var(--card-bg); border-radius: 18px; padding: 16px;
            margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--border-ui);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: 0.2s;
        }
        .card:hover { transform: scale(1.02); }
        
        .coin-details { display: flex; align-items: center; gap: 12px; }
        .coin-logo { width: 42px; height: 42px; border-radius: 50%; }
        .coin-info h2 { font-size: 1.1rem; margin: 0; color: var(--primary-text); }
        .change-positive { color: var(--crypto-green); font-weight: bold; }
        .change-negative { color: var(--crypto-red); font-weight: bold; }
        .price-eur { font-size: 1.2rem; font-weight: 700; color: var(--primary-text); }

        /* Chart Modal */
        #chart-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s; padding: 20px;
        }
        #chart-modal.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            width: 100%; max-width: 500px; background: var(--bg-color);
            border: 1px solid var(--border-ui); border-radius: 24px;
            padding: 20px; transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #chart-modal.visible .modal-content { transform: scale(1); }
        .close-chart { background: none; border: none; font-size: 2rem; color: var(--secondary-text); cursor: pointer; float: right; }

        .toast {
            position: fixed; bottom: 50%; left: 50%; transform: translate(-50%, 50%) scale(0.9);
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 12px 24px; border-radius: 30px;
            opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200;
        }
        .toast.show { opacity: 1; transform: translate(-50%, 0) scale(1); }

        @media(min-width: 600px) {
            body { display: flex; align-items: center; justify-content: center; background: #222; }
            .view-container { 
                max-width: 400px; height: 90vh; 
                border-radius: 40px; border: 8px solid #333; 
                box-shadow: 0 50px 100px rgba(0,0,0,0.5); background: var(--bg-color);
            }
        }
    </style>
</head>
<body data-theme="dark">

    <div class="view-container">
        
        <!-- ==================== VISTA CALCULADORA ==================== -->
        <div id="view-calculator" class="view active">
            <header class="app-header">
                <!-- Theme Button -->
                <button class="embedded-ui icon-btn btn-theme" title="Cambiar Tema">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                
                <div class="app-title embedded-ui">aiDANaI Calc</div>
                
                <!-- Botón a Crypto: Estilo sutil igual al tema -->
                <button id="btn-go-crypto" class="embedded-ui icon-btn" title="Mercado Crypto">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                </button>

                <div id="clock" class="embedded-ui">0:00:00</div>
            </header>
            
            <!-- DISPLAY + HISTORY (50% Altura) -->
            <div class="upper-section">
                <div class="display-lens">
                    <ul id="history-list"></ul>
                    <div class="display-area">
                        <div id="secondary-display">0</div>
                        <div id="main-display">0</div>
                    </div>
                </div>
            </div>

            <!-- KEYPAD (50% Altura) -->
            <div class="calculator-body">
                <div class="keypad">
                    <button class="btn" data-key="AC" data-color="red">AC</button>
                    <button class="btn" data-key="Backspace" data-color="red">⌫</button>
                    <button class="btn" data-key="(" data-color="red">( )</button>
                    <button class="btn" data-key="/" data-color="blue">÷</button>

                    <button class="btn" data-key="7">7</button>
                    <button class="btn" data-key="8">8</button>
                    <button class="btn" data-key="9">9</button>
                    <button class="btn" data-key="*" data-color="blue">×</button>

                    <button class="btn" data-key="4">4</button>
                    <button class="btn" data-key="5">5</button>
                    <button class="btn" data-key="6">6</button>
                    <button class="btn" data-key="-" data-color="blue">−</button>

                    <button class="btn" data-key="1">1</button>
                    <button class="btn" data-key="2">2</button>
                    <button class="btn" data-key="3">3</button>
                    <button class="btn" data-key="+" data-color="blue">+</button>

                    <button class="btn" data-key="0">0</button>
                    <button class="btn btn-wide" data-key="Enter" data-color="green">=</button>
                    <button class="btn" data-key="." data-color="blue">,</button>
                </div>
            </div>
        </div>

        <!-- ==================== VISTA CRYPTO ==================== -->
        <div id="view-crypto" class="view">
            <header class="app-header">
                <button class="embedded-ui icon-btn btn-theme">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                <div class="app-title embedded-ui" style="color: var(--neon-purple);">Crypto Market</div>
                
                <!-- Botón volver a calculadora: Estilo sutil -->
                <button id="btn-go-calc" class="embedded-ui icon-btn" title="Volver a Calculadora">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="12" y1="10" x2="12" y2="10"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="8" y1="10" x2="8" y2="10"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="8" y1="18" x2="8" y2="18"></line><line x1="16" y1="10" x2="16" y2="10"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line></svg>
                </button>

                <div id="clock-crypto" class="embedded-ui">0:00:00</div>
            </header>
            
            <div class="crypto-content">
                <p id="timestamp">Conectando...</p>
                <div class="crypto-list">
                    <!-- Bitcoin -->
                    <div class="card" data-id="bitcoin" data-name="Bitcoin">
                        <div class="coin-details"><img src="https://assets.coingecko.com/coins/images/1/large/bitcoin.png" class="coin-logo"><div class="coin-info"><h2>Bitcoin</h2><p class="change-percentage" id="bitcoin-change">...</p></div></div><div class="price-container"><p class="price-eur" id="bitcoin-price-eur">...</p></div>
                    </div>
                    <!-- Ethereum -->
                    <div class="card" data-id="ethereum" data-name="Ethereum">
                        <div class="coin-details"><img src="https://assets.coingecko.com/coins/images/279/large/ethereum.png" class="coin-logo"><div class="coin-info"><h2>Ethereum</h2><p class="change-percentage" id="ethereum-change">...</p></div></div><div class="price-container"><p class="price-eur" id="ethereum-price-eur">...</p></div>
                    </div>
                    <!-- Solana -->
                    <div class="card" data-id="solana" data-name="Solana">
                        <div class="coin-details"><img src="https://assets.coingecko.com/coins/images/4128/large/solana.png" class="coin-logo"><div class="coin-info"><h2>Solana</h2><p class="change-percentage" id="solana-change">...</p></div></div><div class="price-container"><p class="price-eur" id="solana-price-eur">...</p></div>
                    </div>
                     <!-- Ripple -->
                     <div class="card" data-id="ripple" data-name="XRP">
                        <div class="coin-details"><img src="https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png" class="coin-logo"><div class="coin-info"><h2>XRP</h2><p class="change-percentage" id="ripple-change">...</p></div></div><div class="price-container"><p class="price-eur" id="ripple-price-eur">...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CHART MODAL -->
    <div id="chart-modal">
        <div class="modal-content">
            <button class="close-chart">&times;</button>
            <h2 id="chart-title" style="margin-bottom:15px; color: var(--primary-text)">Historial</h2>
            <div id="chart-container"></div>
        </div>
    </div>

    <div id="toast" class="toast">Notificación</div>

    <script>
        const App = {
            expr: '',
            state: { theme: 'dark' },
            editIdx: null,
            chart: null,

            init() {
                this.loadState();
                this.applyTheme(this.state.theme);
                this.bindEvents();
                this.startClocks();
                this.fetchPrices();
                setInterval(() => this.fetchPrices(), 60000);
            },

            bindEvents() {
                // --- Navigation ---
                document.getElementById('btn-go-crypto').onclick = () => this.switchView('crypto');
                document.getElementById('btn-go-calc').onclick = () => this.switchView('calc');

                // --- Theme ---
                document.querySelectorAll('.btn-theme').forEach(b => b.onclick = () => {
                    this.applyTheme(this.state.theme === 'dark' ? 'light' : 'dark');
                    this.haptic(15);
                });

                // --- CLICK: Botones Calculadora ---
                document.querySelectorAll('.btn[data-key]').forEach(b => {
                    const press = (e) => {
                        if(e.cancelable) e.preventDefault(); 
                        this.haptic(10);
                        b.classList.add('btn-active');
                        this.handleInput(b.dataset.key);
                    };
                    const release = () => b.classList.remove('btn-active');
                    
                    b.addEventListener('pointerdown', press);
                    b.addEventListener('pointerup', release);
                    b.addEventListener('pointerleave', release);
                });

                // --- KEYBOARD: Teclado PC ---
                document.addEventListener('keydown', (e) => {
                    const keyMap = {
                        'Enter': 'Enter', '=': 'Enter',
                        'Escape': 'AC', 'Delete': 'AC',
                        'Backspace': 'Backspace',
                        '*': '*', 'x': '*', 'X': '*',
                        '/': '/', ':': '/',
                        '+': '+', '-': '-',
                        ',': '.', '.': '.'
                    };
                    
                    let k = keyMap[e.key] || e.key;
                    if (!"0123456789".includes(k) && !keyMap[e.key]) return;
                    if(['/', '*'].includes(k)) e.preventDefault();

                    let virtualKey = k;
                    if(virtualKey === 'Enter') virtualKey = 'Enter'; 
                    
                    let selector = `.btn[data-key="${virtualKey}"]`;
                    if (!document.querySelector(selector)) selector = `.btn[data-key="${e.key}"]`; 
                    
                    const btn = document.querySelector(selector);
                    if (btn) {
                        btn.classList.add('btn-active');
                        setTimeout(() => btn.classList.remove('btn-active'), 100);
                        this.handleInput(virtualKey);
                    } else if("0123456789".includes(k)) {
                        const btnNum = document.querySelector(`.btn[data-key="${k}"]`);
                        if(btnNum) {
                             btnNum.classList.add('btn-active');
                             setTimeout(() => btnNum.classList.remove('btn-active'), 100);
                        }
                        this.handleInput(k);
                    }
                });

                document.querySelectorAll('.card').forEach(c => c.onclick = () => this.openChart(c.dataset.id, c.dataset.name));
                document.querySelector('.close-chart').onclick = () => document.getElementById('chart-modal').classList.remove('visible');
                document.getElementById('main-display').onclick = (e) => {
                    const t = e.target.closest('.token');
                    if(t && !t.classList.contains('token-op')) {
                        const nodes = Array.from(document.getElementById('main-display').children);
                        this.editIdx = nodes.indexOf(t);
                    } else { this.editIdx = null; }
                    this.render();
                };
            },

            handleInput(k) {
                if(this.fresh) {
                    if(!"+-*/".includes(k) && k !== 'Enter') { this.expr=''; this.editIdx=null; }
                    this.fresh = false; document.getElementById('secondary-display').classList.remove('visible');
                }

                if(k==='AC') { this.expr = ''; this.editIdx = null; }
                else if(k==='Backspace') { 
                    if(this.editIdx!==null) { /* lógica futura */ } 
                    else this.expr = this.expr.slice(0, -1); 
                }
                else if(k==='Enter') { this.calculate(); }
                else if(k==='(') { this.smartParen(); }
                else {
                    if("+-*/".includes(k)) { this.editIdx=null; this.expr += k; }
                    else { this.expr += k; }
                }
                this.render();
            },

            calculate() {
                if(!this.expr) return;
                try {
                    let clean = this.expr.replace(/[^0-9+\-*/().]/g, '');
                    clean = clean.replace(/\)\(/g, ')*(');
                    
                    let res = new Function('return ' + clean)();
                    if(!isFinite(res)) throw new Error("Infinito");
                    if(!Number.isInteger(res)) res = parseFloat(res.toFixed(8));
                    
                    this.addToHistory(this.expr, res);
                    this.expr = String(res); this.fresh=true;
                    document.getElementById('secondary-display').innerText = 'TOTAL';
                    document.getElementById('secondary-display').classList.add('visible');
                } catch(e) { this.showToast("Error de cálculo"); }
                this.render();
            },

            smartParen() {
                const o = (this.expr.match(/\(/g)||[]).length;
                const c = (this.expr.match(/\)/g)||[]).length;
                if(o > c && /[0-9.)]$/.test(this.expr)) this.expr += ')';
                else if(/[0-9.]$/.test(this.expr)) this.expr += '*(';
                else this.expr += '(';
                this.render();
            },

            render() {
                const d = document.getElementById('main-display');
                if(!this.expr) { d.innerHTML = '0'; return; }
                
                const parts = this.expr.split(/([\+\-\*\/])/);
                let h = '';
                parts.forEach((p,i) => {
                    if(!p) return;
                    let cls = 'token';
                    let txt = p;
                    if("+-*/".includes(p)) {
                        cls += ' token-op';
                        txt = p.replace('*','×').replace('/','÷');
                    } else {
                         // LÓGICA DE FORMATEO DE MILES
                         // Verificamos si es número
                         if(!isNaN(parseFloat(p))) {
                             const splitNum = p.split('.'); // Separar entero de decimal interno
                             // Formatear parte entera con puntos
                             let integerPart = splitNum[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                             // Si hay decimales, unimos con coma
                             txt = splitNum.length > 1 ? `${integerPart},${splitNum[1]}` : integerPart;
                         }
                    }
                    if(i === this.editIdx) cls += ' token-selected';
                    h += `<span class="${cls}">${txt}</span>`;
                });
                d.innerHTML = h;
            },

            addToHistory(ex, r) {
                const li = document.createElement('li');
                // Formateo también el historial para que coincida
                const formattedExpr = ex.replace(/\*/g,'×').replace(/\//g,'÷').replace(/(\d+)(\.\d+)?/g, (match, int, dec) => {
                    return int.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + (dec ? dec.replace('.',',') : '');
                });
                const formattedRes = r.toLocaleString('es-ES'); // Español usa puntos miles y coma decimal por defecto

                li.innerHTML = `${formattedExpr} = <b>${formattedRes}</b>`;
                li.onclick = () => { this.expr=String(r); this.fresh=true; this.render(); };
                document.getElementById('history-list').prepend(li);
            },

            async fetchPrices() {
                try {
                    const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,ripple&vs_currencies=eur&include_24hr_change=true');
                    const d = await res.json();
                    const fmt = new Intl.NumberFormat('es-ES', {style:'currency', currency:'EUR'});
                    
                    ['bitcoin','ethereum','solana','ripple'].forEach(id => {
                        if(d[id]) {
                            document.getElementById(`${id}-price-eur`).textContent = fmt.format(d[id].eur);
                            const chg = d[id].eur_24h_change;
                            const cEl = document.getElementById(`${id}-change`);
                            cEl.innerText = (chg>0?'+':'') + chg.toFixed(2)+'%';
                            cEl.className = `change-percentage ${chg>=0?'change-positive':'change-negative'}`;
                        }
                    });
                    document.getElementById('timestamp').innerText = 'Actualizado: ' + new Date().toLocaleTimeString();
                } catch(e) { }
            },

            async openChart(id, name) {
                const m = document.getElementById('chart-modal');
                document.getElementById('chart-title').innerText = name + " (1 año)";
                m.classList.add('visible');
                
                if(!this.chart) {
                    this.chart = new ApexCharts(document.getElementById('chart-container'), {
                        series:[], chart: {type:'area', height:250, toolbar:{show:false}, background:'transparent'},
                        theme: {mode: this.state.theme}, stroke:{curve:'smooth',width:2},
                        fill: {type:'gradient'}, dataLabels:{enabled:false},
                        xaxis: {type:'datetime', labels:{show:false}, axisBorder:{show:false}},
                        yaxis: {labels: {style:{colors:'#777'}, formatter: v=>v.toFixed(0)+'€'}},
                        grid: {show:false}
                    });
                    this.chart.render();
                }
                
                try {
                    const res = await fetch(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=eur&days=365`);
                    const data = await res.json();
                    this.chart.updateOptions({theme:{mode:this.state.theme}});
                    this.chart.updateSeries([{name:'Precio', data: data.prices}]);
                } catch(e){}
            },

            switchView(v) {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                if(v==='crypto') { document.getElementById('view-crypto').classList.add('active'); this.fetchPrices(); }
                else document.getElementById('view-calculator').classList.add('active');
            },
            applyTheme(t) {
                this.state.theme = t; document.body.dataset.theme = t;
                this.saveState();
            },
            haptic(p) { if(navigator.vibrate) navigator.vibrate(p); },
            showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); },
            saveState() { localStorage.setItem('aidanaiApp', JSON.stringify(this.state)); },
            loadState() { try{const s=JSON.parse(localStorage.getItem('aidanaiApp')); if(s)this.state={...this.state,...s};}catch(e){} },
            
            startClocks() {
                const update = () => {
                    const now = new Date();
                    const h = now.getHours(); 
                    const m = String(now.getMinutes()).padStart(2, '0');
                    const s = String(now.getSeconds()).padStart(2, '0');
                    const timeStr = `${h}:${m}:${s}`;
                    
                    document.querySelectorAll('#clock, #clock-crypto').forEach(e => e.innerText = timeStr);
                };
                update();
                setInterval(update, 1000);
            }
        };
        App.init();
    </script>
</body>
</html>