<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Cuentas Personales</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="manifest" href="data:application/manifest+json,{
        %22name%22:%22Gestor de Cuentas%22,
        %22short_name%22:%22Cuentas%22,
        %22start_url%22:%22.%22,
        %22display%22:%22standalone%22,
        %22background_color%22:%22#000000%22,
        %22theme_color%22:%22#007AFF%22,
        %22description%22:%22Gestor de finanzas personales, elegante y profesional.%22,
        %22icons%22:[
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg%2bxml%2bxml%22},
            {%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='85' font-size='90'%3E%F0%9F%92%B0%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg%2bxml%2bxml%22}
        ]
    }">
    <meta name="theme-color" content="#000000"/>
    <link rel="apple-touch-icon" href="aiDANaI.webp">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
	
    <link rel="stylesheet" href="style.css">
</head>
<body data-ledger-mode="A">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    
    <div id="introScreen" class="intro-screen">
        <div class="starry-background"></div>
        <img id="splashImage" class="intro-screen__logo" src="aiDANaI.webp" alt="Logo App" />
        <div id="quoteContainer" class="intro-screen__quote-container">
            <p id="quoteText" class="intro-screen__quote-text"></p>
            <span id="quoteAuthor" class="intro-screen__quote-author"></span>
        </div>
    </div>

    <div id="login-screen" class="login-view">
        <div class="starry-background"></div>
        <div class="login-view__card">
            <img src="aiDANaI.webp" alt="Logo Cuentas aiDANaI" class="login-view__logo">
            <h2 id="login-title" class="login-view__title" data-i18n="login_welcome">Bienvenido de nuevo</h2>
            <p class="login-view__tagline" data-i18n="login_tagline">Inicia sesión para controlar tus finanzas.</p>
            <form id="login-form" noValidate>
                <div class="form-group form-group--with-icon">
                    <span class="material-icons">alternate_email</span>
                    <input type="email" id="login-email" class="form-input" data-i18n-placeholder="login_email_placeholder" placeholder="Correo electrónico" required autoComplete="email" autoCapitalize="none" />
                    <span class="form-error" id="login-email-error"></span>
                </div>
                <div class="form-group form-group--with-icon">
                    <span class="material-icons">lock</span>
                    <input type="password" id="login-password" class="form-input" data-i18n-placeholder="login_password_placeholder" placeholder="Contraseña" required autoComplete="current-password" />
                    <span class="form-error" id="login-password-error"></span>
                </div>
                <div class="login-view__actions">
                    <a href="#" class="login-view__link" data-action="forgot-password" data-i18n="login_forgot_password">¿Olvidaste tu contraseña?</a>
                </div>
                <p id="login-error" class="form-error" style="min-height: 16px; margin-top: 8px;"></p>
                <div class="login-view__footer">
                    <button type="submit" data-action="login" class="btn btn--primary btn--full" data-i18n="login_button">Iniciar Sesión</button>
                    <p class="login-view__secondary-action">
                        <span data-i18n="login_no_account">¿No tienes una cuenta?</span> <a href="#" class="login-view__link" data-action="show-register" data-i18n="login_register_link">Regístrate aquí</a>
                    </p>
                </div>
            </form>
        </div>
    </div>

    <div id="pin-login-screen" class="login-view">
        <div class="starry-background"></div>
        <div class="login-view__card">
            <img src="aiDANaI.webp" alt="Logo" class="login-view__logo">
            <h2 class="login-view__title">Bienvenido</h2>
            <p id="pin-login-email" class="login-view__tagline" style="margin-bottom: 1rem; font-weight: 600;"></p>
            <p class="login-view__tagline" style="margin-top: 0;">Introduce tu PIN para acceder.</p>
            <form id="pin-login-form" onsubmit="return false;">
                <div id="pin-inputs-container" class="pin-inputs"></div>
                <span class="form-error" id="pin-login-error"></span>
                <div class="login-view__footer" style="margin-top: 1.5rem;">
                    <p class="login-view__secondary-action">
                        <a href="#" class="login-view__link" data-action="show-full-login">Iniciar sesión con contraseña</a>
                    </p>
                </div>
            </form>
        </div>
    </div>
    
    <div id="app-root" class="app-layout">
        <nav class="bottom-nav">
            <button data-action="navigate" data-page="inicio-page" class="bottom-nav__item">
                <span class="material-icons">home</span>
                <span class="bottom-nav__label" data-i18n="nav_home">Inicio</span>
            </button>
            <button data-action="navigate" data-page="patrimonio-page" class="bottom-nav__item">
                <span class="material-icons">account_balance</span>
                <span class="bottom-nav__label" data-i18n="nav_wealth">Patrimonio</span>
            </button>
            <button data-action="navigate" data-page="analisis-page" class="bottom-nav__item">
                <span class="material-icons">analytics</span>
                <span class="bottom-nav__label" data-i18n="nav_analysis">Análisis</span>
            </button>
            <button data-action="navigate" data-page="configuracion-page" class="bottom-nav__item">
                <span class="material-icons">settings</span>
                <span class="bottom-nav__label" data-i18n="nav_settings">Ajustes</span>
            </button>
        </nav>

        <header id="app-top-bar" class="top-bar">
            <div id="top-bar-left-button" class="top-bar__left-button">
				<button id="ledger-toggle-btn" class="btn btn--secondary" data-action="toggle-ledger" data-i18n-title="tooltip_toggle_ledger" title="Cambiar entre contabilidad Personal (A) y Secundaria (B)">A</button>
            </div>
            <h1 id="top-bar-title" class="top-bar__title"></h1>
            <div id="top-bar-actions" class="top-bar__actions"></div>
			<span id="sync-status-icon" class="material-icons"></span>
        </header>

        <main class="app-layout__main">
            <section id="inicio-page" class="view"></section>
            <section id="patrimonio-page" class="view"></section>

            <section id="analisis-page" class="view">
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">request_quote</span>
                                <span>Presupuestos</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--sp-4);">
                                <div class="form-group" style="flex-grow: 1; margin: 0;">
                                    <label for="budget-year-selector" class="form-label" style="margin: 0;">Año del Presupuesto</label>
                                    <select id="budget-year-selector" class="form-select"></select>
                                </div>
                                <button data-action="update-budgets" class="btn btn--secondary" style="margin-left: var(--sp-3);">
                                    <span class="material-icons" style="font-size: 16px;">edit_calendar</span>
                                    <span>Gestionar</span>
                                </button>
                            </div>
                            <div id="annual-budget-dashboard">
                                <div id="budget-kpi-container" class="kpi-grid"></div>
                                <div class="card" style="margin-top: var(--sp-4);">
                                    <h3 class="card__title"><span class="material-icons">trending_up</span>Tendencia Ingresos y Gastos</h3>
                                    <div class="card__content">
                                        <div class="chart-container" style="height: 220px;"><canvas id="budget-trend-chart"></canvas></div>
                                    </div>
                                </div>
                                <div id="budget-details-list" style="margin-top: var(--sp-4);"></div>
                            </div>
                            <div id="budget-init-placeholder" class="empty-state hidden">
                                <span class="material-icons">edit_calendar</span>
                                <h3 id="budget-placeholder-title" data-i18n="budget_empty_title">Define tu Plan Financiero</h3>
                                <p id="budget-placeholder-text" data-i18n="budget_empty_text">Establece límites de gasto y metas de ingreso para tomar el control de tu año. ¡Empieza ahora!</p>
                                <button data-action="update-budgets" class="btn btn--primary" style="margin-top: var(--sp-4);">
                                    <span class="material-icons" style="font-size: 16px;">add_circle_outline</span>
                                    <span data-i18n="budget_empty_cta">Crear Presupuestos</span>
                                </button>
                            </div>
                        </div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">edit_note</span>
                                <span>Portafolio</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" id="analisis-inversiones-container" style="padding: var(--sp-3) var(--sp-4);"></div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">assessment</span>
                                <span>Informes</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label for="informe-fecha-inicio" class="form-label">Desde</label>
                                    <input type="date" id="informe-fecha-inicio" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="informe-fecha-fin" class="form-label">Hasta</label>
                                    <input type="date" id="informe-fecha-fin" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="filter-cuenta-informe" class="form-label">Cuenta</label>
                                    <select id="filter-cuenta-informe" class="form-select"></select>
                                </div>
                                <div class="form-group">
                                    <label for="filter-concepto-informe" class="form-label">Concepto</label>
                                    <select id="filter-concepto-informe" class="form-select"></select>
                                </div>
                            </div>
                            <button data-action="apply-informe-filters" class="btn btn--primary btn--full" style="margin-top: var(--sp-2);">Generar Informe</button>
                            <div id="informe-results-container" class="hidden" style="margin-top: var(--sp-4);">
                                <div id="informe-kpi-container" class="kpi-grid"></div>
                                <div class="chart-container" style="margin-top: var(--sp-4);"><canvas id="informes-chart"></canvas></div>
                            </div>
                            <div id="empty-informes" class="empty-state" style="border: none; background: transparent; padding-top: var(--sp-4);">
                                <span class="material-icons">query_stats</span>
                                <h3>Define tus parámetros</h3>
                                <p>Selecciona un rango de fechas para generar tu informe personalizado.</p>
                            </div>
                        </div>
                    </details>
                </div>
            </section>

            <section id="configuracion-page" class="view">
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">person_outline</span>
                                <span data-i18n="settings_account_and_prefs">Cuenta y Preferencias</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <h3 class="card__title" style="margin-top: 0; font-size: var(--fs-base); padding: 0;">
                                <span class="material-icons">account_circle</span>
                                <span data-i18n="settings_user_account">Cuenta de Usuario</span>
                            </h3>
                            <div class="modal__list-item" style="padding-left: 0; padding-right: 0; margin-top: var(--sp-2);">
                                <span data-i18n="settings_logged_in_as">Sesión iniciada como:</span>
                                <strong id="config-user-email">cargando...</strong>
                            </div>
                            <button data-action="logout" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);">
                                <span class="material-icons" style="font-size: 16px;">logout</span>
                                <span data-i18n="settings_logout">Cerrar Sesión</span>
                            </button>
                            <button data-action="delete-account" class="btn btn--danger btn--full" style="margin-top: var(--sp-2); background-color: var(--c-black); border: 1px solid var(--c-danger);">
                                <span class="material-icons" style="font-size: 16px;">delete_forever</span>
                                <span data-i18n="settings_delete_account">Eliminar Mi Cuenta Permanentemente</span>
                            </button>
                        </div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                       <summary>
                           <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                               <span class="material-icons">security</span>
                               <span>Seguridad y Acceso</span>
                           </h3>
                           <span class="material-icons accordion__icon">expand_more</span>
                       </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                           <button id="setup-pin-btn" data-action="setup-pin" class="btn btn--secondary btn--full">
                               <span class="material-icons" style="font-size: 16px;">pin</span>
                               <span id="setup-pin-btn-text">Configurar PIN de Acceso</span>
                           </button>
                           <p class="form-label" style="margin-top: var(--sp-2); font-size: var(--fs-xs);">
                               Configura un PIN de 4 dígitos para acceder más rápido en este dispositivo.
                           </p>
                       </div>
                   </details>
               </div>
                <div class="card card--no-bg accordion-wrapper">
                     <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">language</span><span data-i18n="settings_language">Idioma</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                         <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <h3 class="card__title" style="margin-top: 0; font-size: var(--fs-base); padding: 0;">
                                <span class="material-icons">translate</span><span data-i18n="settings_language">Idioma</span>
                            </h3>
                            <div id="language-selector" class="form-group" style="margin-top: var(--sp-3);"></div>
                         </div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                     <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">palette</span><span data-i18n="settings_appearance">Apariencia</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                         <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <h3 class="card__title" style="margin-top: 0; font-size: var(--fs-base); padding: 0;">
                                <span class="material-icons">color_lens</span><span data-i18n="settings_theme_selector">Selector de Tema</span>
                            </h3>
                            <div id="theme-selector" class="form-group" style="margin-top: var(--sp-3);"></div>
                        </div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                     <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">badge</span><span data-i18n="settings_general">Configuración General</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                         <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <h3 class="card__title" style="margin-top: var(--sp-5); font-size: var(--fs-base); padding: 0;">
                                <span class="material-icons">rocket_launch</span><span data-i18n="settings_startup_options">Opciones de Arranque</span>
                            </h3>
                             <div class="form-checkbox-group" style="margin-top: var(--sp-2);">
                                <input type="checkbox" id="config-skip-intro" />
                                <label for="config-skip-intro" data-i18n="settings_skip_intro">Omitir intro y cita al iniciar la app</label>
                            </div>
                            <button data-action="save-config" class="btn btn--primary btn--full" style="margin-top: var(--sp-4);" data-i18n="settings_save_config">Guardar Configuración</button>
                        </div>
                    </details>
                </div>
                <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">edit_note</span><span data-i18n="settings_data_management">Gestión de Datos</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                             <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <button data-action="manage-cuentas" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">account_balance</span><span data-i18n="common_accounts">Cuentas</span></button>
                                <button data-action="manage-conceptos" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">category</span><span data-i18n="common_concepts">Conceptos</span></button>
                                <button data-action="manage-recurrentes" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">event_repeat</span><span data-i18n="common_recurrent">Recurrentes</span></button>
                                <button data-action="update-budgets" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">edit_calendar</span><span>Presupuestos</span></button>
                            </div>
                            <button data-action="recalculate-balances" class="btn btn--primary btn--full" style="margin-top: var(--sp-4);">
                                <span class="material-icons" style="font-size: 16px;">calculate</span>
                                <span data-i18n="settings_recalculate_balances">Recalcular Saldos de Cuentas</span>
                            </button>
                        </div>
                    </details>
                </div>
                 <div class="card card--no-bg accordion-wrapper">
                    <details class="accordion">
                        <summary>
                            <h3 class="card__title" style="margin:0; padding: 0; color: var(--c-on-surface);">
                                <span class="material-icons">backup</span><span data-i18n="settings_backup">Copia de Seguridad</span>
                            </h3>
                            <span class="material-icons accordion__icon">expand_more</span>
                        </summary>
                        <div class="accordion__content" style="padding: var(--sp-3) var(--sp-4);">
                            <p style="font-size: var(--fs-sm); color: var(--c-on-surface-secondary); margin-bottom: var(--sp-4);" data-i18n="settings_backup_warning">La importación de JSON o CSV reemplazará todos los datos actuales. Se recomienda exportar primero para tener una copia de seguridad.</p>
                            <div class="form-grid">
                                <button data-action="export-data" class="btn btn--secondary" data-i18n-title="tooltip_export_json" title="Exportar una copia de seguridad completa en formato JSON."><span class="material-icons" style="font-size: 16px;">save</span><span data-i18n="settings_export_json">Exportar JSON</span></button>
                                <button data-action="export-csv" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">grid_on</span>Exportar CSV</button>
                                <button data-action="import-data" class="btn btn--secondary" data-i18n-title="tooltip_import_json" title="Importar desde un archivo de seguridad JSON."><span class="material-icons" style="font-size: 16px;">file_upload</span><span data-i18n="settings_import_json">Importar JSON</span></button>
                                <button data-action="import-csv" class="btn btn--secondary"><span class="material-icons" style="font-size: 16px;">upload_file</span><span data-i18n="settings_import_csv">Importar CSV</span></button>
                            </div>
                            <input type="file" id="import-file-input" class="hidden" accept=".json,application/json" />
                            <button data-action="clear-data" class="btn btn--danger btn--full" style="margin-top: var(--sp-4);" data-i18n="settings_delete_all_data">Borrar Todos los Datos</button>
                        </div>
                    </details>
                </div>
            </section>
            
            <section id="movimientos-page-full" class="view" style="padding: 0; gap: 0;">
                <div id="movimientos-filter-bar" class="filter-bar hidden">
                    <span id="movimientos-filter-text"></span>
                    <button data-action="clear-movements-filter" class="icon-btn" title="Quitar filtro"><span class="material-icons">close</span></button>
                </div>
                <div id="movimientos-list-container">
                    <div id="virtual-list-sizer">
                        <div id="virtual-list-content"></div>
                    </div>
                    <div id="list-loader" class="hidden"><span class="spinner"></span></div>
                </div>
                <div id="empty-movimientos" class="empty-state hidden" style="margin: 0 var(--sp-4);">
                    <span class="material-icons">receipt_long</span>
                    <h3 data-i18n="empty_history_title">Tu historial empieza aquí</h3>
                    <p data-i18n="empty_history_text">Pulsa el botón `+` para añadir tu primer ingreso o gasto.</p>
                </div>
            </section>
        </main>
        
        <button data-action="add-movement" id="fab-add-movimiento" class="fab" data-i18n-title="tooltip_add_movement" title="Añadir Movimiento" aria-label="Añadir Movimiento"><span class="material-icons">add</span></button>

    </div>

    <div id="toast-container" aria-live="assertive"></div>
    
    <div id="movimiento-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="form-movimiento-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="form-movimiento-title" class="modal__title">Añadir Movimiento</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="movimiento-modal" data-i18n-title="tooltip_close" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div class="modal__body">
                <form id="form-movimiento" novalidate>
                    <input type="hidden" id="movimiento-id" />
                    <input type="hidden" id="movimiento-mode" value="new" />
                    <div class="filter-pills" style="justify-content: center; margin-bottom: var(--sp-4);">
                        <button type="button" id="mov-type-btn-movimiento" class="filter-pill filter-pill--active" data-action="set-movimiento-type" data-type="movimiento" data-i18n="form_type_movement">Ingreso/Gasto</button>
                        <button type="button" id="mov-type-btn-traspaso" class="filter-pill" data-action="set-movimiento-type" data-type="traspaso" data-i18n="form_type_transfer">Traspaso</button>
                    </div>
                    <div class="form-group">
                        <label for="movimiento-cantidad" class="form-label" data-i18n="form_amount">Cantidad (gasto en negativo)</label>
                        <input type="text" id="movimiento-cantidad" class="form-input input-amount-calculator" readonly required data-i18n-placeholder="form_amount_placeholder" placeholder="Ej: -2,50" />
                        <span class="form-error" id="movimiento-cantidad-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="movimiento-descripcion" class="form-label" data-i18n="form_description">Descripción</label>
                        <input type="text" id="movimiento-descripcion" class="form-input" required data-i18n-placeholder="form_description_placeholder" placeholder="Ej: Compra semanal" />
                        <span class="form-error"id="movimiento-descripcion-error"></span>
                        <div id="description-suggestions"></div>
                    </div>
                    <div id="movimiento-fields">
                        <div class="form-grid">
                            <div class="form-group-addon">
                                <div class="form-group">
                                    <label for="movimiento-concepto" class="form-label" data-i18n="common_concept">Concepto</label>
                                    <select id="movimiento-concepto" class="form-select" required></select>
                                    <span class="form-error" id="movimiento-concepto-error"></span>
                                </div>
                                <button type="button" data-action="manage-conceptos" class="icon-btn" data-i18n-title="tooltip_manage_concepts" title="Gestionar Conceptos"><span class="material-icons">more_vert</span></button>
                            </div>
                            <div class="form-group-addon">
                                <div class="form-group">
                                    <label for="movimiento-cuenta" class="form-label" data-i18n="common_account">Cuenta</label>
                                    <select id="movimiento-cuenta" class="form-select" required></select>
                                    <span class="form-error" id="movimiento-cuenta-error"></span>
                                </div>
                                <button type="button" data-action="manage-cuentas" class="icon-btn" data-i18n-title="tooltip_manage_accounts" title="Gestionar Cuentas"><span class="material-icons">more_vert</span></button>
                            </div>
                        </div>
                    </div>
                    <div id="traspaso-fields" class="hidden">
                        <div class="form-group">
                            <label class="form-label" for="traspaso-show-all-accounts-toggle" data-i18n="common_accounts">Cuentas</label>
                            <div class="form-checkbox-group" style="margin-bottom: var(--sp-2);">
                                <input type="checkbox" id="traspaso-show-all-accounts-toggle" data-action="toggle-traspaso-accounts-filter" />
                                <label for="traspaso-show-all-accounts-toggle" style="font-size: var(--fs-xs);" data-i18n="form_show_all_accounts">Mostrar cuentas de ambas contabilidades (A y B)</label>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="movimiento-cuenta-origen" class="form-label" data-i18n="form_source_account">Cuenta Origen</label>
                                <select id="movimiento-cuenta-origen" class="form-select"></select>
                                <span class="form-error" id="movimiento-cuenta-origen-error"></span>
                            </div>
                            <div class="form-group">
                                <label for="movimiento-cuenta-destino" class="form-label" data-i18n="form_destination_account">Cuenta Destino</label>
                                <select id="movimiento-cuenta-destino" class="form-select"></select>
                                <span class="form-error" id="movimiento-cuenta-destino-error"></span>
                            </div>
                        </div>
                    </div>
                    <div style="border-top: 1px solid var(--c-outline); margin-top: var(--sp-4); padding-top: var(--sp-2);">
                        <div class="form-switch-group modal__list-item" style="padding: var(--sp-2) 0;">
                            <label for="movimiento-recurrente" style="font-weight: 700;" data-i18n="form_schedule_recurrent">¿Programar como recurrente?</label>
                            <label class="form-switch"><input type="checkbox" id="movimiento-recurrente"><span class="slider"></span></label>
                        </div>
                        <div id="recurrent-options" class="hidden" style="animation: fade-in 0.3s; margin-top: var(--sp-2);">
                            <div class="form-group">
                                <label for="recurrent-frequency" class="form-label" data-i18n="form_frequency">Frecuencia</label>
                                <select id="recurrent-frequency" class="form-select">
                                    <option value="daily" data-i18n="freq_daily">Diaria</option>
                                    <option value="weekly" data-i18n="freq_weekly">Semanal</option>
                                    <option value="monthly" selected data-i18n="freq_monthly">Mensual</option>
                                    <option value="yearly" data-i18n="freq_yearly">Anual</option>
                                </select>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="recurrent-next-date" class="form-label" data-i18n="form_next_execution">Próxima ejecución</label>
                                    <input type="date" id="recurrent-next-date" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="recurrent-end-date" class="form-label" data-i18n="form_ends_on">Finaliza el (opcional)</label>
                                    <input type="date" id="recurrent-end-date" class="form-input">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: var(--sp-3);">
                        <label for="movimiento-fecha" class="form-label" data-i18n="form_date">Fecha</label>
                        <input type="date" id="movimiento-fecha" class="form-input" required />
                        <span class="form-error" id="movimiento-fecha-error"></span>
                    </div>
                    <div class="modal__actions">
                        <div class="left-actions">
                            <button type="button" id="delete-movimiento-btn" data-action="delete-movement-from-modal" class="icon-btn btn--danger hidden" data-i18n-title="tooltip_delete" title="Borrar"><span class="material-icons">delete</span></button>
                            <button type="button" id="duplicate-movimiento-btn" data-action="duplicate-movement" class="icon-btn btn--secondary hidden" data-i18n-title="tooltip_duplicate" title="Duplicar"><span class="material-icons">content_copy</span></button>
                        </div>
                        <div class="right-actions">
                            <button id="save-movimiento-btn" type="submit" class="btn btn--primary" data-i18n-title="tooltip_save_movement" title="Guardar Movimiento" data-i18n="common_save">Guardar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="generic-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="generic-modal-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="generic-modal-title" class="modal__title"></h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="generic-modal" data-i18n-title="tooltip_close" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="generic-modal-body" class="modal__body"></div>
        </div>
    </div>

    <div id="dashboard-config-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="dashboard-config-title">
        <div class="modal">
            <header class="modal__header">
                <h3 id="dashboard-config-title" class="modal__title" data-i18n="customize_panel_title">Personalizar Panel</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="dashboard-config-modal" data-i18n-title="tooltip_close" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div class="modal__body">
                <p class="form-label" style="margin-bottom: var(--sp-3);" data-i18n="customize_panel_desc">Activa, desactiva y reordena los elementos que quieres ver en tu panel de control.</p>
                <div id="dashboard-widget-list"></div>
            </div>
            <div class="modal__actions">
                <button class="btn btn--primary btn--full" data-action="save-dashboard-config" data-i18n="customize_panel_save">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <div id="calculator-modal" class="modal-overlay calculator-overlay">
        <div class="calculator-ui">
            <div id="calculator-display" class="calculator-display">0</div>
            <div id="calculator-grid" class="calculator-grid">
                <button class="calculator-btn btn-operator" data-key="clear">C</button>
                <button class="calculator-btn btn-operator" data-key="sign">+/-</button>
                <button class="calculator-btn btn-operator" data-key="backspace"><span class="material-icons backspace-icon">backspace</span></button>
                <button class="calculator-btn btn-confirm" data-key="done">OK</button>
                <button class="calculator-btn" data-key="7">7</button>
                <button class="calculator-btn" data-key="8">8</button>
                <button class="calculator-btn" data-key="9">9</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-1" style="visibility: hidden;"></button>
                <button class="calculator-btn" data-key="4">4</button>
                <button class="calculator-btn" data-key="5">5</button>
                <button class="calculator-btn" data-key="6">6</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-2" style="visibility: hidden;"></button>
                <button class="calculator-btn" data-key="1">1</button>
                <button class="calculator-btn" data-key="2">2</button>
                <button class="calculator-btn" data-key="3">3</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-3" style="visibility: hidden;"></button>
                <button class="calculator-btn zero" data-key="0">0</button>
                <button class="calculator-btn" data-key="comma">,</button>
                <button class="calculator-btn btn-operator" data-key="custom-action-4" style="visibility: hidden;"></button>
            </div>
        </div>
    </div>

    <div id="global-search-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="global-search-title">
        <div class="modal">
            <header class="modal__header">
                <div id="global-search-input-wrapper">
                    <span class="material-icons" style="color: var(--c-on-surface-secondary);">search</span>
                    <input type="search" id="global-search-input" data-i18n-placeholder="search_placeholder" placeholder="Buscar en toda la app..." autocomplete="off">
                </div>
                <button class="icon-btn" data-action="close-modal" data-modal-id="global-search-modal" data-i18n-title="tooltip_close" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="global-search-results" class="modal__body">
                <div class="empty-state" style="background:transparent; border: none;">
                    <span class="material-icons">manage_search</span>
                    <h3 data-i18n="search_empty_title">Encuéntralo todo</h3>
                    <p data-i18n="search_empty_text">Busca movimientos, cuentas o conceptos. <br>Atajo: <strong>Cmd/Ctrl + K</strong></p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="onboarding-tour" class="onboarding-overlay">
        <div id="onboarding-highlight" class="onboarding-highlight"></div>
        <div id="onboarding-step-box" class="onboarding-step-box">
            <h3 id="onboarding-title" class="onboarding-step-box__title"></h3>
            <p id="onboarding-content" class="onboarding-step-box__content"></p>
            <div class="onboarding-step-box__footer">
                <button id="onboarding-skip-btn" class="btn btn--secondary" data-action="end-tour" data-i18n="tour_skip">Saltar Tour</button>
                <div id="onboarding-dots" class="onboarding-step-box__dots"></div>
                <div>
                    <button id="onboarding-prev-btn" class="btn btn--secondary" data-action="prev-tour-step" data-i18n="tour_previous">Anterior</button>
                    <button id="onboarding-next-btn" class="btn btn--primary" data-action="next-tour-step" data-i18n="tour_next">Siguiente</button>
                </div>
            </div>
        </div>
    </div>

    <div id="json-import-wizard-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="json-wizard-title">
        <div class="modal" style="max-width: 500px; height: auto; max-height: 85vh;">
            <header class="modal__header">
                <h3 id="json-wizard-title" class="modal__title" data-i18n="json_wizard_title">Asistente de Importación JSON</h3>
                <button class="icon-btn" data-action="close-modal" data-modal-id="json-import-wizard-modal" data-i18n-title="tooltip_close" title="Cerrar" aria-label="Cerrar"><span class="material-icons">close</span></button>
            </header>
            <div id="json-wizard-body" class="modal__body" style="display: flex; flex-direction: column;">
                <div id="json-wizard-step-1" class="json-wizard-step">
                    <h4 data-i18n="json_wizard_step1_title">Paso 1: Selecciona tu copia de seguridad</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);" data-i18n="json_wizard_step1_desc">Arrastra y suelta el archivo <code>.json</code> o haz clic para seleccionarlo. La importación reemplazará <strong>todos</strong> tus datos actuales.</p>
                    <div id="json-drop-zone">
                        <span class="material-icons" style="font-size: 48px; color: var(--c-outline);">upload_file</span>
                        <p id="json-drop-zone-text" data-i18n="json_wizard_dropzone">Arrastra tu archivo aquí o haz clic</p>
                    </div>
                    <div id="json-file-error" class="form-error" style="text-align: center; margin-top: var(--sp-3);"></div>
                </div>
                <div id="json-wizard-step-2" class="json-wizard-step" style="display: none;">
                    <h4 data-i18n="json_wizard_step2_title">Paso 2: Revisa y confirma</h4>
                    <p class="form-label" style="margin-bottom: var(--sp-3);" data-i18n="json_wizard_step2_desc">Hemos analizado tu archivo. Si los datos son correctos, pulsa "Importar" para reemplazar tus datos actuales.</p>
                    <div id="json-preview-container">
                        <ul id="json-preview-list"></ul>
                        <div class="form-error" style="margin-top: var(--sp-2); text-align: center;"><strong data-i18n="common_irreversible">Atención:</strong> <span data-i18n="common_irreversible_desc">Esta acción es irreversible.</span></div>
                    </div>
                    <div class="modal__actions" style="justify-content: space-between;">
                        <button class="btn btn--secondary" data-action="json-wizard-back-2" data-i18n="common_back">Atrás</button>
                        <button class="btn btn--danger" data-action="json-wizard-import-final"><span class="material-icons">warning</span><span data-i18n="common_import_replace">Importar y Reemplazar</span></button>
                    </div>
                </div>
                <div id="json-wizard-step-3" class="json-wizard-step" style="display: none; justify-content: center; align-items: center; text-align: center; min-height: 200px;">
                    <div id="json-import-progress">
                        <span class="spinner" style="width: 48px; height: 48px; border-width: 4px;"></span>
                        <h4 style="margin-top: var(--sp-4);" data-i18n="common_importing">Importando...</h4>
                        <p data-i18n="common_importing_desc">Estamos guardando tus datos. Por favor, no cierres esta ventana.</p>
                    </div>
                     <div id="json-import-result" style="display: none;">
                        <span class="material-icons" style="font-size: 60px; color: var(--c-success);">task_alt</span>
                        <h4 id="json-result-title" style="margin-top: var(--sp-2);" data-i18n="import_complete_title">¡Importación Completada!</h4>
                        <p id="json-result-message"></p>
                        <div class="modal__actions" style="justify-content: center;">
                            <button class="btn btn--primary" data-action="close-modal" data-modal-id="json-import-wizard-modal" data-i18n="common_finish">Finalizar</button>
                        </div>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <div id="exit-screen">
        <p>🧮✨ ¡Tus números están en orden, es hora de descansar! ✨🧮<br>💰 Tu asistente de finanzas personales se queda cuidando tus cuentas 💰</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script type="module" src="app.js"></script>
</body>
</html>