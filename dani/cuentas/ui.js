/**
 * ui.js
 * 
 * M√≥dulo para todas las funciones de interfaz de usuario.
 * Controla modales, toasts, animaciones, selectores, internacionalizaci√≥n,
 * la calculadora, la b√∫squeda global y helpers del DOM.
 */

// --- IMPORTACIONES DE M√ìDULOS ---
import { 
    PAGE_IDS, isOffBalanceMode, THEMES, currentLanguage, locales, db, 
    setCurrentLanguage, setLedgerMode, dataLoaded, currentUser
} from './state.js';
import { 
    loadInversiones, loadPresupuestos, loadRecurrentes
} from './firebase.js';
import { 
    renderAnalisisPage, renderPatrimonioPage, renderInicioPage, 
    loadConfig as renderConfigPage, updateDashboardData, _renderRecientesFromCache,
    renderLanguageSelector, renderThemeSelector, vList, renderVisibleItems
} from './render.js';
import { 
    startMovementForm, handlePinLogin, loadInitialMovements, performGlobalSearch 
} from './main.js';

// --- ESTADO INTERNO DEL M√ìDULO UI ---
let lastScrollTop = null;
let calculatorState = {
    displayValue: '0',
    waitingForNewValue: true,
    targetInput: null,
    isVisible: false,
};
let calculatorKeyboardHandler = null;
const originalButtonTexts = new Map();
let globalSearchDebounceTimer = null;
let descriptionSuggestionDebounceTimer = null;
const DESCRIPTION_SUGGESTION_LIMIT = 5;


// --- INTERNACIONALIZACI√ìN (i18n) ---
const translations = {
    en: {
        nav_home: "Home", nav_wealth: "Wealth", nav_analysis: "Analysis", nav_settings: "Settings", title_home: "Home", title_wealth: "Wealth", title_analysis: "Analysis", title_settings: "Settings", title_history: "Transaction History", login_welcome: "Welcome Back", login_tagline: "Log in to take control of your finances.", login_email_placeholder: "Email address", login_password_placeholder: "Password", login_forgot_password: "Forgot your password?", login_button: "Log In", login_no_account: "Don't have an account?", login_register_link: "Sign up here", settings_account_and_prefs: "Account & Preferences", settings_user_account: "User Account", settings_logged_in_as: "Logged in as:", settings_logout: "Log Out", settings_delete_account: "Delete My Account Permanently", settings_appearance: "Appearance", settings_language: "Language", settings_theme_selector: "Theme Selector", settings_general: "General Settings", settings_startup_options: "Startup Options", settings_skip_intro: "Skip intro and quote on app start", settings_save_config: "Save Settings", settings_data_management: "Data Management", settings_recalculate_balances: "Recalculate Account Balances", settings_backup: "Backup & Restore", settings_backup_warning: "Importing a JSON or CSV file will replace all your current data. It is recommended to export first to have a backup.", settings_export_json: "Export JSON", settings_import_json: "Import JSON", settings_import_csv: "Import CSV", settings_delete_all_data: "Delete All Data", tooltip_toggle_ledger: "Switch between Personal (A) and Secondary (B) ledger", tooltip_add_movement: "Add Transaction", tooltip_close: "Close", tooltip_manage_concepts: "Manage Categories", tooltip_manage_accounts: "Manage Accounts", tooltip_save_movement: "Save Transaction", tooltip_delete: "Delete", tooltip_duplicate: "Duplicate", tooltip_export_json: "Export a full backup in JSON format.", tooltip_import_json: "Import from a JSON backup file.", form_type_movement: "Income/Expense", form_type_transfer: "Transfer", form_amount: "Amount (expense as negative)", form_amount_placeholder: "e.g.: -2.50", form_description: "Description", form_description_placeholder: "e.g.: Weekly groceries", form_source_account: "Source Account", form_destination_account: "Destination Account", form_show_all_accounts: "Show accounts from both ledgers (A & B)", form_schedule_recurrent: "Schedule as recurrent?", form_frequency: "Frequency", form_next_execution: "Next execution", form_ends_on: "Ends on (optional)", form_date: "Date", freq_daily: "Daily", freq_weekly: "Weekly", freq_monthly: "Monthly", freq_yearly: "Annual", empty_history_title: "Your history starts here", empty_history_text: "Press the `+` button to add your first income or expense.", budget_empty_title: "Define Your Financial Plan", budget_empty_text: "Set spending limits and income goals to take control of your year. Get started now!", budget_empty_cta: "Create Budgets", search_placeholder: "Search across the app...", search_empty_title: "Find everything", search_empty_text: "Search for transactions, accounts, or categories. <br>Shortcut: <strong>Cmd/Ctrl + K</strong>", tour_skip: "Skip", tour_previous: "Previous", tour_next: "Next", common_accounts: "Accounts", common_concepts: "Categories", common_recurrent: "Recurrent", common_account: "Account", common_concept: "Category", common_save: "Save", common_back: "Back", common_finish: "Finish", common_import_replace: "Import and Replace", common_importing: "Importing...", common_importing_desc: "We are saving your data. Please do not close this window.", common_irreversible: "Warning:", common_irreversible_desc: "This action is irreversible.", json_wizard_title: "JSON Import Wizard", json_wizard_step1_title: "Step 1: Select your backup", json_wizard_step1_desc: "Drag and drop the <code>.json</code> file or click to select it. Importing will replace <strong>all</strong> of your current data.", json_wizard_dropzone: "Drag your file here or click", json_wizard_step2_title: "Step 2: Review and confirm", json_wizard_step2_desc: "We have analyzed your file. If the data is correct, press 'Import' to replace your current data.", import_complete_title: "Import Complete!", customize_panel_title: "Customize Dashboard", customize_panel_desc: "Enable, disable, and reorder the elements you want to see on your dashboard.", customize_panel_save: "Save Changes", help_title: "The Ultimate User Guide", help_content: `<p>Help content in English goes here. Ensure all HTML is properly formatted within this string.</p>`
    },
    fr: {
        nav_home: "Accueil", nav_wealth: "Patrimoine", nav_analysis: "Analyse", nav_settings: "R√©glages", title_home: "Accueil", title_wealth: "Patrimoine", title_analysis: "Analyse", title_settings: "R√©glages", title_history: "Historique des Transactions", login_welcome: "Bon Retour", login_tagline: "Connectez-vous pour prendre le contr√¥le de vos finances.", login_email_placeholder: "Adresse e-mail", login_password_placeholder: "Mot de passe", login_forgot_password: "Mot de passe oubli√© ?", login_button: "Se Connecter", login_no_account: "Pas de compte ?", login_register_link: "Inscrivez-vous ici", settings_account_and_prefs: "Compte et Pr√©f√©rences", settings_user_account: "Compte Utilisateur", settings_logged_in_as: "Connect√© en tant que :", settings_logout: "Se D√©connecter", settings_delete_account: "Supprimer Mon Compte D√©finitivement", settings_appearance: "Apparence", settings_language: "Langue", settings_theme_selector: "S√©lecteur de Th√®me", settings_general: "R√©glages G√©n√©raux", settings_startup_options: "Options de D√©marrage", settings_skip_intro: "Passer l'intro et la citation au d√©marrage", settings_save_config: "Enregistrer les R√©glages", settings_data_management: "Gestion des Donn√©es", settings_recalculate_balances: "Recalculer les Soldes des Comptes", settings_backup: "Sauvegarde", settings_backup_warning: "L'importation d'un fichier JSON ou CSV remplacera toutes vos donn√©es actuelles. Il est recommand√© d'exporter d'abord pour avoir une sauvegarde.", settings_export_json: "Exporter JSON", settings_import_json: "Importer JSON", settings_import_csv: "Importer CSV", settings_delete_all_data: "Supprimer Toutes les Donn√©es", tooltip_toggle_ledger: "Basculer entre la comptabilit√© Personnelle (A) et Secondaire (B)", tooltip_add_movement: "Ajouter une Transaction", tooltip_close: "Fermer", tooltip_manage_concepts: "G√©rer les Cat√©gories", tooltip_manage_accounts: "G√©rer les Comptes", tooltip_save_movement: "Enregistrer la Transaction", tooltip_delete: "Supprimer", tooltip_duplicate: "Dupliquer", tooltip_export_json: "Exporter une sauvegarde compl√®te au format JSON.", tooltip_import_json: "Importer depuis un fichier de sauvegarde JSON.", form_type_movement: "Revenu/D√©pense", form_type_transfer: "Virement", form_amount: "Montant (d√©pense en n√©gatif)", form_amount_placeholder: "ex: -2,50", form_description: "Description", form_description_placeholder: "ex: Courses de la semaine", form_source_account: "Compte Source", form_destination_account: "Compte Destinataire", form_show_all_accounts: "Afficher les comptes des deux comptabilit√©s (A et B)", form_schedule_recurrent: "Planifier comme r√©current ?", form_frequency: "Fr√©quence", form_next_execution: "Prochaine ex√©cution", form_ends_on: "Se termine le (optionnel)", form_date: "Date", freq_daily: "Quotidienne", freq_weekly: "Hebdomadaire", freq_monthly: "Mensuelle", freq_yearly: "Annuelle", empty_history_title: "Votre historique commence ici", empty_history_text: "Appuyez sur le bouton `+` pour ajouter votre premier revenu ou d√©pense.", budget_empty_title: "D√©finissez Votre Plan Financier", budget_empty_text: "Fixez des limites de d√©penses et des objectifs de revenus pour prendre le contr√¥le de votre ann√©e. Commencez maintenant !", budget_empty_cta: "Cr√©er des Budgets", search_placeholder: "Rechercher dans toute l'application...", search_empty_title: "Trouvez tout", search_empty_text: "Recherchez des transactions, comptes ou cat√©gories. <br>Raccourci : <strong>Cmd/Ctrl + K</strong>", tour_skip: "Passer", tour_previous: "Pr√©c√©dent", tour_next: "Suivant", common_accounts: "Comptes", common_concepts: "Cat√©gories", common_recurrent: "R√©currents", common_account: "Compte", common_concept: "Cat√©gorie", common_save: "Enregistrer", common_back: "Retour", common_finish: "Terminer", common_import_replace: "Importer et Remplacer", common_importing: "Importation...", common_importing_desc: "Nous sauvegardons vos donn√©es. Veuillez ne pas fermer cette fen√™tre.", common_irreversible: "Attention :", common_irreversible_desc: "Cette action est irr√©versible.", json_wizard_title: "Assistant d'Importation JSON", json_wizard_step1_title: "√âtape 1 : S√©lectionnez votre sauvegarde", json_wizard_step1_desc: "Glissez-d√©posez le fichier <code>.json</code> ou cliquez pour le s√©lectionner. L'importation remplacera <strong>toutes</strong> vos donn√©es actuelles.", json_wizard_dropzone: "Glissez votre fichier ici ou cliquez", json_wizard_step2_title: "√âtape 2 : V√©rifiez et confirmez", json_wizard_step2_desc: "Nous avons analys√© votre fichier. Si les donn√©es sont correctes, appuyez sur 'Importer' pour remplacer vos donn√©es actuelles.", import_complete_title: "Importation Termin√©e !", customize_panel_title: "Personnaliser le Tableau de Bord", customize_panel_desc: "Activez, d√©sactivez et r√©organisez les √©l√©ments que vous souhaitez voir sur votre tableau de bord.", customize_panel_save: "Enregistrer les Modifications", help_title: "Le Guide Utilisateur Ultime", help_content: `<p>Help content in French goes here. Ensure all HTML is properly formatted within this string.</p>`
    },
    es: {
        nav_home: "Inicio", nav_wealth: "Patrimonio", nav_analysis: "An√°lisis", nav_settings: "Ajustes", title_home: "Inicio", title_wealth: "Patrimonio", title_analysis: "An√°lisis", title_settings: "Ajustes", title_history: "Historial de Movimientos", login_welcome: "Bienvenido de nuevo", login_tagline: "Inicia sesi√≥n para controlar tus finanzas.", login_email_placeholder: "Correo electr√≥nico", login_password_placeholder: "Contrase√±a", login_forgot_password: "¬øOlvidaste tu contrase√±a?", login_button: "Iniciar Sesi√≥n", login_no_account: "¬øNo tienes una cuenta?", login_register_link: "Reg√≠strate aqu√≠", settings_account_and_prefs: "Cuenta y Preferencias", settings_user_account: "Cuenta de Usuario", settings_logged_in_as: "Sesi√≥n iniciada como:", settings_logout: "Cerrar Sesi√≥n", settings_delete_account: "Eliminar Mi Cuenta Permanentemente", settings_appearance: "Apariencia", settings_language: "Idioma", settings_theme_selector: "Selector de Tema", settings_general: "Configuraci√≥n General", settings_startup_options: "Opciones de Arranque", settings_skip_intro: "Omitir intro y cita al iniciar la app", settings_save_config: "Guardar Configuraci√≥n", settings_data_management: "Gesti√≥n de Datos", settings_recalculate_balances: "Recalcular Saldos de Cuentas", settings_backup: "Copia de Seguridad", settings_backup_warning: "La importaci√≥n de JSON o CSV reemplazar√° todos los datos actuales. Se recomienda exportar primero para tener una copia de seguridad.", settings_export_json: "Exportar JSON", settings_import_json: "Importar JSON", settings_import_csv: "Importar CSV", settings_delete_all_data: "Borrar Todos los Datos", tooltip_toggle_ledger: "Cambiar entre contabilidad Personal (A) y Secundaria (B)", tooltip_add_movement: "A√±adir Movimiento", tooltip_close: "Cerrar", tooltip_manage_concepts: "Gestionar Conceptos", tooltip_manage_accounts: "Gestionar Cuentas", tooltip_save_movement: "Guardar Movimiento", tooltip_delete: "Borrar", tooltip_duplicate: "Duplicar", tooltip_export_json: "Exportar una copia de seguridad completa en formato JSON.", tooltip_import_json: "Importar desde un archivo de seguridad JSON.", form_type_movement: "Ingreso/Gasto", form_type_transfer: "Traspaso", form_amount: "Cantidad (gasto en negativo)", form_amount_placeholder: "Ej: -2,50", form_description: "Descripci√≥n", form_description_placeholder: "Ej: Compra semanal", form_source_account: "Cuenta Origen", form_destination_account: "Cuenta Destino", form_show_all_accounts: "Mostrar cuentas de ambas contabilidades (A y B)", form_schedule_recurrent: "¬øProgramar como recurrente?", form_frequency: "Frecuencia", form_next_execution: "Pr√≥xima ejecuci√≥n", form_ends_on: "Finaliza el (opcional)", form_date: "Fecha", freq_daily: "Diaria", freq_weekly: "Semanal", freq_monthly: "Mensual", freq_yearly: "Anual", empty_history_title: "Tu historial empieza aqu√≠", empty_history_text: "Pulsa el bot√≥n `+` para a√±adir tu primer ingreso o gasto.", budget_empty_title: "Define tu Plan Financiero", budget_empty_text: "Establece l√≠mites de gasto y metas de ingreso para tomar el control de tu a√±o. ¬°Empieza ahora!", budget_empty_cta: "Crear Presupuestos", search_placeholder: "Buscar en toda la app...", search_empty_title: "Encu√©ntralo todo", search_empty_text: "Busca movimientos, cuentas o conceptos. <br>Atajo: <strong>Cmd/Ctrl + K</strong>", tour_skip: "Saltar", tour_previous: "Anterior", tour_next: "Siguiente", common_accounts: "Cuentas", common_concepts: "Conceptos", common_recurrent: "Recurrentes", common_account: "Cuenta", common_concept: "Concepto", common_save: "Guardar", common_back: "Atr√°s", common_finish: "Finalizar", common_import_replace: "Importar y Reemplazar", common_importing: "Importando...", common_importing_desc: "Estamos guardando tus datos. Por favor, no cierres esta ventana.", common_irreversible: "Atenci√≥n:", common_irreversible_desc: "Esta acci√≥n es irreversible.", json_wizard_title: "Asistente de Importaci√≥n JSON", json_wizard_step1_title: "Paso 1: Selecciona tu copia de seguridad", json_wizard_step1_desc: "Arrastra y suelta el archivo <code>.json</code> o haz clic para seleccionarlo. La importaci√≥n reemplazar√° <strong>todos</strong> tus datos actuales.", json_wizard_dropzone: "Arrastra tu archivo aqu√≠ o haz clic", json_wizard_step2_title: "Paso 2: Revisa y confirma", json_wizard_step2_desc: "Hemos analizado tu archivo. Si los datos son correctos, pulsa 'Importar' para reemplazar tus datos actuales.", import_complete_title: "¬°Importaci√≥n Completada!", customize_panel_title: "Personalizar Panel", customize_panel_desc: "Activa, desactiva y reordena los elementos que quieres ver en tu panel de control.", customize_panel_save: "Guardar Cambios", help_title: "Gu√≠a de Usuario Definitiva", help_content: `<div style="text-align: center; margin-bottom: var(--sp-4);"><span class="material-icons" style="font-size: 48px; color: var(--c-primary);">school</span><h3>¬°Bienvenido a tu Centro de Mando Financiero!</h3></div><p>¬°Hola! Prep√°rate para tomar el control de tu dinero como nunca antes. Esta gu√≠a est√° dise√±ada para convertirte en un experto de tus propias finanzas, explicando cada rinc√≥n de la aplicaci√≥n de una forma clara y entretenida. ¬°Vamos all√°!</p><div style="text-align: center; margin: var(--sp-4) 0;"><button class="btn btn--secondary" data-action="start-onboarding-tour"><span class="material-icons" style="font-size: 16px;">play_circle_outline</span><span>Iniciar Tour Interactivo</span></button></div><h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">explore</span>Un Paseo por la Nueva Interfaz</h3><p>Hemos organizado la aplicaci√≥n en cuatro pesta√±as principales para que todo sea m√°s intuitivo. Piensa en ellas como los departamentos de tu empresa financiera personal:</p><details class="accordion" style="margin-bottom: var(--sp-2);" open><summary><span class="material-icons" style="margin-right:8px">home</span><strong>1. Inicio: Tu Centro de Operaciones Diario</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Aqu√≠ es donde pasar√°s la mayor parte del tiempo. Es el pulso de tu actividad financiera diaria. Tienes dos vistas geniales:</p><ul><li><strong>Vista "Recientes":</strong> Como el feed de tus redes sociales, pero con tu dinero. Ver√°s al instante tus √∫ltimos gastos, ingresos y traspasos. Es perfecta para saber qu√© ha pasado hoy o ayer.</li><li><strong>Vista "Resumen":</strong> ¬øQuieres saber c√≥mo va el mes? Cambia a esta vista y obtendr√°s un an√°lisis de alto nivel con:<ul><li><strong>KPIs (Indicadores Clave):</strong> Tus ingresos, gastos y, lo m√°s importante, el <strong>saldo neto</strong>. ¬°Incluso te dice si vas mejor o peor que el mes pasado!</li><li><strong>Gr√°ficos por Concepto:</strong> Un desglose visual y s√∫per f√°cil de entender sobre a d√≥nde se va tu dinero (comida, ocio, facturas...) y de d√≥nde viene.</li></ul></li></ul><p><strong>Ejemplo pr√°ctico:</strong> Acabas de empezar el mes. Usas la vista "Recientes" para registrar tu compra del s√∫per. A mitad de mes, cambias a "Resumen" para ver si est√°s gastando m√°s de la cuenta en "Restaurantes" y ajustar tus planes para las pr√≥ximas semanas.</p></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">account_balance</span><strong>2. Patrimonio: Tu Fotograf√≠a Financiera</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Esta secci√≥n es tu "foto de la riqueza". Te muestra todo lo que tienes y d√≥nde lo tienes, d√°ndote una visi√≥n clara de tu salud financiera global.</p><ul><li><strong>Patrimonio Neto:</strong> El n√∫mero m√°s importante, arriba del todo. Te dice el valor total de tus posesiones.</li><li><strong>Listado de Cuentas:</strong> Aqu√≠ ver√°s todas tus cuentas (bancos, efectivo, tarjetas...) agrupadas por tipo. Puedes usar los filtros para, por ejemplo, ver solo el dinero que tienes en bancos.</li><li><strong>Cartera de Inversi√≥n:</strong> Un apartado de lujo para tus activos de inversi√≥n. No solo te dice cu√°nto valen, sino c√≥mo est√°n rindiendo.</li></ul><p><strong>Ejemplo pr√°ctico:</strong> Quieres saber cu√°nto dinero "l√≠quido" tienes disponible. Vas a Patrimonio, filtras para ver solo "Banco" y "Efectivo", y el n√∫mero de "Patrimonio Neto" te dar√° la respuesta al instante.</p></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">analytics</span><strong>3. An√°lisis: El Laboratorio del Estratega</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Aqu√≠ es donde te pones el sombrero de estratega. Miras al pasado para tomar mejores decisiones en el futuro.</p><ul><li><strong>Presupuestos:</strong> ¬°Tu plan de batalla! Define cu√°nto quieres gastar (o ingresar) en cada categor√≠a durante el a√±o. La app te mostrar√° con barras de progreso si te est√°s ci√±endo al plan o si necesitas apretarte el cintur√≥n.</li><li><strong>Informes Personalizados:</strong> Eres el detective de tus finanzas. ¬øQuieres saber cu√°nto gastaste en gasolina el trimestre pasado usando solo una tarjeta de cr√©dito espec√≠fica? Aqu√≠ puedes generar ese informe con gr√°ficos y todo.</li></ul><p><strong>Ejemplo pr√°ctico:</strong> Creas un presupuesto de 200‚Ç¨ al mes para "Ocio". A final de mes, en la secci√≥n de Presupuestos, ves que has gastado 250‚Ç¨. La barra de progreso estar√° en rojo, avis√°ndote de que te has pasado un 25%.</p></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">settings</span><strong>4. Ajustes: La Sala de M√°quinas</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>El centro de control. Aqu√≠ personalizas la app (¬°prueba los temas de colores!), gestionas tus datos base (crear/editar Cuentas y Conceptos) y, muy importante, haces tus copias de seguridad.</p></div></details><h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">stars</span>Funciones Estrella que Debes Conocer</h3><details class="accordion" style="margin-bottom: var(--sp-2);"><summary>üöÄ <strong>Contabilidad Dual (A/B): Tu Superpoder Secreto</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>El bot√≥n <strong>[A]/[B]</strong> de la esquina superior izquierda es m√°gico. Te permite llevar dos contabilidades totalmente separadas. Es como tener dos aplicaciones en una.</p><p><strong>Ejemplo de uso:</strong></p><ul><li><strong>Contabilidad A (Personal):</strong> Gestionas tu n√≥mina, tus gastos diarios, tus ahorros... tu vida.</li><li><strong>Contabilidad B (Proyecto):</strong> Gestionas los ingresos y gastos de un peque√±o negocio, de las cuentas de la comunidad de vecinos, o de la organizaci√≥n de un viaje en grupo. ¬°Todo separado y ordenado!</li></ul></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary>üîç <strong>B√∫squeda Global (Atajo: Ctrl/Cmd + K)</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>¬øNo recuerdas d√≥nde apuntaste la cena del s√°bado? Pulsa el icono de la lupa (o el atajo de teclado) y escribe "cena". La b√∫squeda te mostrar√° al instante ese movimiento, la cuenta relacionada y el concepto. ¬°Es la forma m√°s r√°pida de encontrar cualquier cosa!</p></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary>üìà <strong>Seguimiento PRO de Inversiones</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Esto lleva tus finanzas al siguiente nivel. En <strong>Ajustes > Gesti√≥n de Datos > Cuentas</strong>, puedes marcar una cuenta como "de inversi√≥n". Al hacerlo, la app empezar√° a calcular m√©tricas profesionales para ella en la pesta√±a de Patrimonio:</p><ul><li><strong>P&L (Ganancias y P√©rdidas):</strong> Te dice exactamente cu√°nto dinero has ganado o perdido, tanto en euros como en porcentaje.</li><li><strong>TIR (Tasa Interna de Retorno):</strong> El indicador definitivo. Te dice la rentabilidad <strong>anualizada</strong> real de tu inversi√≥n, teniendo en cuenta no solo el valor final, sino cu√°ndo y cu√°nto dinero has ido metiendo o sacando.</li></ul></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary>üîÑ <strong>Importaci√≥n Inteligente desde CSV</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>¬øVienes de otra app o tienes tus datos en una hoja de c√°lculo? ¬°No hay problema! Ve a <strong>Ajustes > Copia de Seguridad > Importar CSV</strong>. Solo necesitas un archivo con 5 columnas:</p><code>FECHA;CUENTA;CONCEPTO;IMPORTE;DESCRIPCI√ìN</code><p>La app es muy lista y har√° magia por ti:</p><ul><li>Si una cuenta o concepto no existe, ¬°lo crea autom√°ticamente!</li><li><strong>Truco PRO:</strong> Si en la columna CONCEPTO pones <code>TRASPASO</code>, la app buscar√° un movimiento de la misma fecha e importe contrario en otra cuenta y los emparejar√° como una transferencia.</li><li><strong>Truco PRO 2:</strong> Usa el CONCEPTO <code>INICIAL</code> para establecer el saldo de partida de una cuenta. Por ejemplo: "01/01/2025;Mi Banco;INICIAL;1500;Saldo inicial del a√±o".</li></ul></div></details><p style="text-align: center; margin-top: var(--sp-5); font-style: italic; color: var(--c-on-surface-secondary);">¬°Explora, registra y toma el control definitivo de tu futuro financiero!</p>`
    }
};

export const t = (key, replacements = {}) => {
    const lang = translations[currentLanguage] || translations.es;
    let text = lang[key] || translations.es[key] || `[${key}]`;
    for (const placeholder in replacements) {
        text = text.replace(`{${placeholder}}`, replacements[placeholder]);
    }
    return text;
};

export const applyStaticTranslations = () => {
    document.querySelectorAll('[data-i18n]').forEach(el => { el.textContent = t(el.dataset.i18n); });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { el.placeholder = t(el.dataset.i18nPlaceholder); });
    document.querySelectorAll('[data-i18n-title]').forEach(el => { el.title = t(el.dataset.i18nTitle); });
};


// --- SELECTORES DEL DOM ---
export const select = (id) => document.getElementById(id);
export const selectAll = (s) => document.querySelectorAll(s);
export const selectOne = (s) => document.querySelector(s);


// --- NOTIFICACIONES Y FEEDBACK ---
export function showToast(message, type = 'default', duration = 3000) {
    const c = select('toast-container'); 
    if (!c) return;
    const t = document.createElement('div');
    t.className = `toast`;
    c.appendChild(t);
    const fadeIn = t.animate([{ transform: 'translateY(20px) scale(0.95)', opacity: 0 }, { transform: 'translateY(0) scale(1)', opacity: 1 }], { duration: 300, easing: 'ease-out' });
    fadeIn.onfinish = () => {
        t.textContent = message;
        t.classList.add(`toast--${type}`);
        if (type === 'danger' || type === 'error') hapticFeedback('error');
        else if (type === 'warning') hapticFeedback('warning');
        setTimeout(() => {
            t.animate([{ opacity: 1 }, { opacity: 0 }], { duration: 300, easing: 'ease-in' }).onfinish = () => t.remove();
        }, duration);
    };
}

export function hapticFeedback(type = 'light') {
    if ('vibrate' in navigator) {
        try {
            let pattern;
            switch (type)