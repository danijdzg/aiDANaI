/**
 * ui.js
 * 
 * Módulo para todas las funciones de interfaz de usuario.
 * Controla modales, toasts, animaciones, selectores, internacionalización,
 * la calculadora, la búsqueda global y helpers del DOM.
 */

// --- IMPORTACIONES DE MÓDULOS ---
import { 
    PAGE_IDS, isOffBalanceMode, THEMES, currentLanguage, locales, db, 
    setCurrentLanguage, setLedgerMode, dataLoaded, currentUser
} from './state.js';
import { 
    loadInversiones, loadPresupuestos, loadRecurrentes
} from './firebase.js';
import { 
    renderAnalisisPage, renderPatrimonioPage, renderInicioPage, 
    loadConfig as renderConfigPage, updateDashboardData, _renderRecientesFromCache,
    renderLanguageSelector, renderThemeSelector, vList, renderVisibleItems
} from './render.js';
import { 
    startMovementForm, handlePinLogin, loadInitialMovements, performGlobalSearch 
} from './main.js';

// --- ESTADO INTERNO DEL MÓDULO UI ---
let lastScrollTop = null;
let calculatorState = {
    displayValue: '0',
    waitingForNewValue: true,
    targetInput: null,
    isVisible: false,
};
let calculatorKeyboardHandler = null;
const originalButtonTexts = new Map();
let globalSearchDebounceTimer = null;
let descriptionSuggestionDebounceTimer = null;
const DESCRIPTION_SUGGESTION_LIMIT = 5;


// --- INTERNACIONALIZACIÓN (i18n) ---
const translations = {
    en: {
        nav_home: "Home", nav_wealth: "Wealth", nav_analysis: "Analysis", nav_settings: "Settings", title_home: "Home", title_wealth: "Wealth", title_analysis: "Analysis", title_settings: "Settings", title_history: "Transaction History", login_welcome: "Welcome Back", login_tagline: "Log in to take control of your finances.", login_email_placeholder: "Email address", login_password_placeholder: "Password", login_forgot_password: "Forgot your password?", login_button: "Log In", login_no_account: "Don't have an account?", login_register_link: "Sign up here", settings_account_and_prefs: "Account & Preferences", settings_user_account: "User Account", settings_logged_in_as: "Logged in as:", settings_logout: "Log Out", settings_delete_account: "Delete My Account Permanently", settings_appearance: "Appearance", settings_language: "Language", settings_theme_selector: "Theme Selector", settings_general: "General Settings", settings_startup_options: "Startup Options", settings_skip_intro: "Skip intro and quote on app start", settings_save_config: "Save Settings", settings_data_management: "Data Management", settings_recalculate_balances: "Recalculate Account Balances", settings_backup: "Backup & Restore", settings_backup_warning: "Importing a JSON or CSV file will replace all your current data. It is recommended to export first to have a backup.", settings_export_json: "Export JSON", settings_import_json: "Import JSON", settings_import_csv: "Import CSV", settings_delete_all_data: "Delete All Data", tooltip_toggle_ledger: "Switch between Personal (A) and Secondary (B) ledger", tooltip_add_movement: "Add Transaction", tooltip_close: "Close", tooltip_manage_concepts: "Manage Categories", tooltip_manage_accounts: "Manage Accounts", tooltip_save_movement: "Save Transaction", tooltip_delete: "Delete", tooltip_duplicate: "Duplicate", tooltip_export_json: "Export a full backup in JSON format.", tooltip_import_json: "Import from a JSON backup file.", form_type_movement: "Income/Expense", form_type_transfer: "Transfer", form_amount: "Amount (expense as negative)", form_amount_placeholder: "e.g.: -2.50", form_description: "Description", form_description_placeholder: "e.g.: Weekly groceries", form_source_account: "Source Account", form_destination_account: "Destination Account", form_show_all_accounts: "Show accounts from both ledgers (A & B)", form_schedule_recurrent: "Schedule as recurrent?", form_frequency: "Frequency", form_next_execution: "Next execution", form_ends_on: "Ends on (optional)", form_date: "Date", freq_daily: "Daily", freq_weekly: "Weekly", freq_monthly: "Monthly", freq_yearly: "Annual", empty_history_title: "Your history starts here", empty_history_text: "Press the `+` button to add your first income or expense.", budget_empty_title: "Define Your Financial Plan", budget_empty_text: "Set spending limits and income goals to take control of your year. Get started now!", budget_empty_cta: "Create Budgets", search_placeholder: "Search across the app...", search_empty_title: "Find everything", search_empty_text: "Search for transactions, accounts, or categories. <br>Shortcut: <strong>Cmd/Ctrl + K</strong>", tour_skip: "Skip", tour_previous: "Previous", tour_next: "Next", common_accounts: "Accounts", common_concepts: "Categories", common_recurrent: "Recurrent", common_account: "Account", common_concept: "Category", common_save: "Save", common_back: "Back", common_finish: "Finish", common_import_replace: "Import and Replace", common_importing: "Importing...", common_importing_desc: "We are saving your data. Please do not close this window.", common_irreversible: "Warning:", common_irreversible_desc: "This action is irreversible.", json_wizard_title: "JSON Import Wizard", json_wizard_step1_title: "Step 1: Select your backup", json_wizard_step1_desc: "Drag and drop the <code>.json</code> file or click to select it. Importing will replace <strong>all</strong> of your current data.", json_wizard_dropzone: "Drag your file here or click", json_wizard_step2_title: "Step 2: Review and confirm", json_wizard_step2_desc: "We have analyzed your file. If the data is correct, press 'Import' to replace your current data.", import_complete_title: "Import Complete!", customize_panel_title: "Customize Dashboard", customize_panel_desc: "Enable, disable, and reorder the elements you want to see on your dashboard.", customize_panel_save: "Save Changes", help_title: "The Ultimate User Guide", help_content: `<p>Help content in English goes here. Ensure all HTML is properly formatted within this string.</p>`
    },
    fr: {
        nav_home: "Accueil", nav_wealth: "Patrimoine", nav_analysis: "Analyse", nav_settings: "Réglages", title_home: "Accueil", title_wealth: "Patrimoine", title_analysis: "Analyse", title_settings: "Réglages", title_history: "Historique des Transactions", login_welcome: "Bon Retour", login_tagline: "Connectez-vous pour prendre le contrôle de vos finances.", login_email_placeholder: "Adresse e-mail", login_password_placeholder: "Mot de passe", login_forgot_password: "Mot de passe oublié ?", login_button: "Se Connecter", login_no_account: "Pas de compte ?", login_register_link: "Inscrivez-vous ici", settings_account_and_prefs: "Compte et Préférences", settings_user_account: "Compte Utilisateur", settings_logged_in_as: "Connecté en tant que :", settings_logout: "Se Déconnecter", settings_delete_account: "Supprimer Mon Compte Définitivement", settings_appearance: "Apparence", settings_language: "Langue", settings_theme_selector: "Sélecteur de Thème", settings_general: "Réglages Généraux", settings_startup_options: "Options de Démarrage", settings_skip_intro: "Passer l'intro et la citation au démarrage", settings_save_config: "Enregistrer les Réglages", settings_data_management: "Gestion des Données", settings_recalculate_balances: "Recalculer les Soldes des Comptes", settings_backup: "Sauvegarde", settings_backup_warning: "L'importation d'un fichier JSON ou CSV remplacera toutes vos données actuelles. Il est recommandé d'exporter d'abord pour avoir une sauvegarde.", settings_export_json: "Exporter JSON", settings_import_json: "Importer JSON", settings_import_csv: "Importer CSV", settings_delete_all_data: "Supprimer Toutes les Données", tooltip_toggle_ledger: "Basculer entre la comptabilité Personnelle (A) et Secondaire (B)", tooltip_add_movement: "Ajouter une Transaction", tooltip_close: "Fermer", tooltip_manage_concepts: "Gérer les Catégories", tooltip_manage_accounts: "Gérer les Comptes", tooltip_save_movement: "Enregistrer la Transaction", tooltip_delete: "Supprimer", tooltip_duplicate: "Dupliquer", tooltip_export_json: "Exporter une sauvegarde complète au format JSON.", tooltip_import_json: "Importer depuis un fichier de sauvegarde JSON.", form_type_movement: "Revenu/Dépense", form_type_transfer: "Virement", form_amount: "Montant (dépense en négatif)", form_amount_placeholder: "ex: -2,50", form_description: "Description", form_description_placeholder: "ex: Courses de la semaine", form_source_account: "Compte Source", form_destination_account: "Compte Destinataire", form_show_all_accounts: "Afficher les comptes des deux comptabilités (A et B)", form_schedule_recurrent: "Planifier comme récurrent ?", form_frequency: "Fréquence", form_next_execution: "Prochaine exécution", form_ends_on: "Se termine le (optionnel)", form_date: "Date", freq_daily: "Quotidienne", freq_weekly: "Hebdomadaire", freq_monthly: "Mensuelle", freq_yearly: "Annuelle", empty_history_title: "Votre historique commence ici", empty_history_text: "Appuyez sur le bouton `+` pour ajouter votre premier revenu ou dépense.", budget_empty_title: "Définissez Votre Plan Financier", budget_empty_text: "Fixez des limites de dépenses et des objectifs de revenus pour prendre le contrôle de votre année. Commencez maintenant !", budget_empty_cta: "Créer des Budgets", search_placeholder: "Rechercher dans toute l'application...", search_empty_title: "Trouvez tout", search_empty_text: "Recherchez des transactions, comptes ou catégories. <br>Raccourci : <strong>Cmd/Ctrl + K</strong>", tour_skip: "Passer", tour_previous: "Précédent", tour_next: "Suivant", common_accounts: "Comptes", common_concepts: "Catégories", common_recurrent: "Récurrents", common_account: "Compte", common_concept: "Catégorie", common_save: "Enregistrer", common_back: "Retour", common_finish: "Terminer", common_import_replace: "Importer et Remplacer", common_importing: "Importation...", common_importing_desc: "Nous sauvegardons vos données. Veuillez ne pas fermer cette fenêtre.", common_irreversible: "Attention :", common_irreversible_desc: "Cette action est irréversible.", json_wizard_title: "Assistant d'Importation JSON", json_wizard_step1_title: "Étape 1 : Sélectionnez votre sauvegarde", json_wizard_step1_desc: "Glissez-déposez le fichier <code>.json</code> ou cliquez pour le sélectionner. L'importation remplacera <strong>toutes</strong> vos données actuelles.", json_wizard_dropzone: "Glissez votre fichier ici ou cliquez", json_wizard_step2_title: "Étape 2 : Vérifiez et confirmez", json_wizard_step2_desc: "Nous avons analysé votre fichier. Si les données sont correctes, appuyez sur 'Importer' pour remplacer vos données actuelles.", import_complete_title: "Importation Terminée !", customize_panel_title: "Personnaliser le Tableau de Bord", customize_panel_desc: "Activez, désactivez et réorganisez les éléments que vous souhaitez voir sur votre tableau de bord.", customize_panel_save: "Enregistrer les Modifications", help_title: "Le Guide Utilisateur Ultime", help_content: `<p>Help content in French goes here. Ensure all HTML is properly formatted within this string.</p>`
    },
    es: {
        nav_home: "Inicio", nav_wealth: "Patrimonio", nav_analysis: "Análisis", nav_settings: "Ajustes", title_home: "Inicio", title_wealth: "Patrimonio", title_analysis: "Análisis", title_settings: "Ajustes", title_history: "Historial de Movimientos", login_welcome: "Bienvenido de nuevo", login_tagline: "Inicia sesión para controlar tus finanzas.", login_email_placeholder: "Correo electrónico", login_password_placeholder: "Contraseña", login_forgot_password: "¿Olvidaste tu contraseña?", login_button: "Iniciar Sesión", login_no_account: "¿No tienes una cuenta?", login_register_link: "Regístrate aquí", settings_account_and_prefs: "Cuenta y Preferencias", settings_user_account: "Cuenta de Usuario", settings_logged_in_as: "Sesión iniciada como:", settings_logout: "Cerrar Sesión", settings_delete_account: "Eliminar Mi Cuenta Permanentemente", settings_appearance: "Apariencia", settings_language: "Idioma", settings_theme_selector: "Selector de Tema", settings_general: "Configuración General", settings_startup_options: "Opciones de Arranque", settings_skip_intro: "Omitir intro y cita al iniciar la app", settings_save_config: "Guardar Configuración", settings_data_management: "Gestión de Datos", settings_recalculate_balances: "Recalcular Saldos de Cuentas", settings_backup: "Copia de Seguridad", settings_backup_warning: "La importación de JSON o CSV reemplazará todos los datos actuales. Se recomienda exportar primero para tener una copia de seguridad.", settings_export_json: "Exportar JSON", settings_import_json: "Importar JSON", settings_import_csv: "Importar CSV", settings_delete_all_data: "Borrar Todos los Datos", tooltip_toggle_ledger: "Cambiar entre contabilidad Personal (A) y Secundaria (B)", tooltip_add_movement: "Añadir Movimiento", tooltip_close: "Cerrar", tooltip_manage_concepts: "Gestionar Conceptos", tooltip_manage_accounts: "Gestionar Cuentas", tooltip_save_movement: "Guardar Movimiento", tooltip_delete: "Borrar", tooltip_duplicate: "Duplicar", tooltip_export_json: "Exportar una copia de seguridad completa en formato JSON.", tooltip_import_json: "Importar desde un archivo de seguridad JSON.", form_type_movement: "Ingreso/Gasto", form_type_transfer: "Traspaso", form_amount: "Cantidad (gasto en negativo)", form_amount_placeholder: "Ej: -2,50", form_description: "Descripción", form_description_placeholder: "Ej: Compra semanal", form_source_account: "Cuenta Origen", form_destination_account: "Cuenta Destino", form_show_all_accounts: "Mostrar cuentas de ambas contabilidades (A y B)", form_schedule_recurrent: "¿Programar como recurrente?", form_frequency: "Frecuencia", form_next_execution: "Próxima ejecución", form_ends_on: "Finaliza el (opcional)", form_date: "Fecha", freq_daily: "Diaria", freq_weekly: "Semanal", freq_monthly: "Mensual", freq_yearly: "Anual", empty_history_title: "Tu historial empieza aquí", empty_history_text: "Pulsa el botón `+` para añadir tu primer ingreso o gasto.", budget_empty_title: "Define tu Plan Financiero", budget_empty_text: "Establece límites de gasto y metas de ingreso para tomar el control de tu año. ¡Empieza ahora!", budget_empty_cta: "Crear Presupuestos", search_placeholder: "Buscar en toda la app...", search_empty_title: "Encuéntralo todo", search_empty_text: "Busca movimientos, cuentas o conceptos. <br>Atajo: <strong>Cmd/Ctrl + K</strong>", tour_skip: "Saltar", tour_previous: "Anterior", tour_next: "Siguiente", common_accounts: "Cuentas", common_concepts: "Conceptos", common_recurrent: "Recurrentes", common_account: "Cuenta", common_concept: "Concepto", common_save: "Guardar", common_back: "Atrás", common_finish: "Finalizar", common_import_replace: "Importar y Reemplazar", common_importing: "Importando...", common_importing_desc: "Estamos guardando tus datos. Por favor, no cierres esta ventana.", common_irreversible: "Atención:", common_irreversible_desc: "Esta acción es irreversible.", json_wizard_title: "Asistente de Importación JSON", json_wizard_step1_title: "Paso 1: Selecciona tu copia de seguridad", json_wizard_step1_desc: "Arrastra y suelta el archivo <code>.json</code> o haz clic para seleccionarlo. La importación reemplazará <strong>todos</strong> tus datos actuales.", json_wizard_dropzone: "Arrastra tu archivo aquí o haz clic", json_wizard_step2_title: "Paso 2: Revisa y confirma", json_wizard_step2_desc: "Hemos analizado tu archivo. Si los datos son correctos, pulsa 'Importar' para reemplazar tus datos actuales.", import_complete_title: "¡Importación Completada!", customize_panel_title: "Personalizar Panel", customize_panel_desc: "Activa, desactiva y reordena los elementos que quieres ver en tu panel de control.", customize_panel_save: "Guardar Cambios", help_title: "Guía de Usuario Definitiva", help_content: `<div style="text-align: center; margin-bottom: var(--sp-4);"><span class="material-icons" style="font-size: 48px; color: var(--c-primary);">school</span><h3>¡Bienvenido a tu Centro de Mando Financiero!</h3></div><p>¡Hola! Prepárate para tomar el control de tu dinero como nunca antes. Esta guía está diseñada para convertirte en un experto de tus propias finanzas, explicando cada rincón de la aplicación de una forma clara y entretenida. ¡Vamos allá!</p><div style="text-align: center; margin: var(--sp-4) 0;"><button class="btn btn--secondary" data-action="start-onboarding-tour"><span class="material-icons" style="font-size: 16px;">play_circle_outline</span><span>Iniciar Tour Interactivo</span></button></div><h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">explore</span>Un Paseo por la Nueva Interfaz</h3><p>Hemos organizado la aplicación en cuatro pestañas principales para que todo sea más intuitivo. Piensa en ellas como los departamentos de tu empresa financiera personal:</p><details class="accordion" style="margin-bottom: var(--sp-2);" open><summary><span class="material-icons" style="margin-right:8px">home</span><strong>1. Inicio: Tu Centro de Operaciones Diario</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Aquí es donde pasarás la mayor parte del tiempo. Es el pulso de tu actividad financiera diaria. Tienes dos vistas geniales:</p><ul><li><strong>Vista "Recientes":</strong> Como el feed de tus redes sociales, pero con tu dinero. Verás al instante tus últimos gastos, ingresos y traspasos. Es perfecta para saber qué ha pasado hoy o ayer.</li><li><strong>Vista "Resumen":</strong> ¿Quieres saber cómo va el mes? Cambia a esta vista y obtendrás un análisis de alto nivel con:<ul><li><strong>KPIs (Indicadores Clave):</strong> Tus ingresos, gastos y, lo más importante, el <strong>saldo neto</strong>. ¡Incluso te dice si vas mejor o peor que el mes pasado!</li><li><strong>Gráficos por Concepto:</strong> Un desglose visual y súper fácil de entender sobre a dónde se va tu dinero (comida, ocio, facturas...) y de dónde viene.</li></ul></li></ul><p><strong>Ejemplo práctico:</strong> Acabas de empezar el mes. Usas la vista "Recientes" para registrar tu compra del súper. A mitad de mes, cambias a "Resumen" para ver si estás gastando más de la cuenta en "Restaurantes" y ajustar tus planes para las próximas semanas.</p></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">account_balance</span><strong>2. Patrimonio: Tu Fotografía Financiera</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Esta sección es tu "foto de la riqueza". Te muestra todo lo que tienes y dónde lo tienes, dándote una visión clara de tu salud financiera global.</p><ul><li><strong>Patrimonio Neto:</strong> El número más importante, arriba del todo. Te dice el valor total de tus posesiones.</li><li><strong>Listado de Cuentas:</strong> Aquí verás todas tus cuentas (bancos, efectivo, tarjetas...) agrupadas por tipo. Puedes usar los filtros para, por ejemplo, ver solo el dinero que tienes en bancos.</li><li><strong>Cartera de Inversión:</strong> Un apartado de lujo para tus activos de inversión. No solo te dice cuánto valen, sino cómo están rindiendo.</li></ul><p><strong>Ejemplo práctico:</strong> Quieres saber cuánto dinero "líquido" tienes disponible. Vas a Patrimonio, filtras para ver solo "Banco" y "Efectivo", y el número de "Patrimonio Neto" te dará la respuesta al instante.</p></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">analytics</span><strong>3. Análisis: El Laboratorio del Estratega</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Aquí es donde te pones el sombrero de estratega. Miras al pasado para tomar mejores decisiones en el futuro.</p><ul><li><strong>Presupuestos:</strong> ¡Tu plan de batalla! Define cuánto quieres gastar (o ingresar) en cada categoría durante el año. La app te mostrará con barras de progreso si te estás ciñendo al plan o si necesitas apretarte el cinturón.</li><li><strong>Informes Personalizados:</strong> Eres el detective de tus finanzas. ¿Quieres saber cuánto gastaste en gasolina el trimestre pasado usando solo una tarjeta de crédito específica? Aquí puedes generar ese informe con gráficos y todo.</li></ul><p><strong>Ejemplo práctico:</strong> Creas un presupuesto de 200€ al mes para "Ocio". A final de mes, en la sección de Presupuestos, ves que has gastado 250€. La barra de progreso estará en rojo, avisándote de que te has pasado un 25%.</p></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary><span class="material-icons" style="margin-right:8px">settings</span><strong>4. Ajustes: La Sala de Máquinas</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>El centro de control. Aquí personalizas la app (¡prueba los temas de colores!), gestionas tus datos base (crear/editar Cuentas y Conceptos) y, muy importante, haces tus copias de seguridad.</p></div></details><h3 style="border-top: 1px solid var(--c-outline); padding-top: var(--sp-3); margin-top: var(--sp-4);"><span class="material-icons" style="font-size: 1.2em; vertical-align: bottom; margin-right: 8px;">stars</span>Funciones Estrella que Debes Conocer</h3><details class="accordion" style="margin-bottom: var(--sp-2);"><summary>🚀 <strong>Contabilidad Dual (A/B): Tu Superpoder Secreto</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>El botón <strong>[A]/[B]</strong> de la esquina superior izquierda es mágico. Te permite llevar dos contabilidades totalmente separadas. Es como tener dos aplicaciones en una.</p><p><strong>Ejemplo de uso:</strong></p><ul><li><strong>Contabilidad A (Personal):</strong> Gestionas tu nómina, tus gastos diarios, tus ahorros... tu vida.</li><li><strong>Contabilidad B (Proyecto):</strong> Gestionas los ingresos y gastos de un pequeño negocio, de las cuentas de la comunidad de vecinos, o de la organización de un viaje en grupo. ¡Todo separado y ordenado!</li></ul></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary>🔍 <strong>Búsqueda Global (Atajo: Ctrl/Cmd + K)</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>¿No recuerdas dónde apuntaste la cena del sábado? Pulsa el icono de la lupa (o el atajo de teclado) y escribe "cena". La búsqueda te mostrará al instante ese movimiento, la cuenta relacionada y el concepto. ¡Es la forma más rápida de encontrar cualquier cosa!</p></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary>📈 <strong>Seguimiento PRO de Inversiones</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>Esto lleva tus finanzas al siguiente nivel. En <strong>Ajustes > Gestión de Datos > Cuentas</strong>, puedes marcar una cuenta como "de inversión". Al hacerlo, la app empezará a calcular métricas profesionales para ella en la pestaña de Patrimonio:</p><ul><li><strong>P&L (Ganancias y Pérdidas):</strong> Te dice exactamente cuánto dinero has ganado o perdido, tanto en euros como en porcentaje.</li><li><strong>TIR (Tasa Interna de Retorno):</strong> El indicador definitivo. Te dice la rentabilidad <strong>anualizada</strong> real de tu inversión, teniendo en cuenta no solo el valor final, sino cuándo y cuánto dinero has ido metiendo o sacando.</li></ul></div></details><details class="accordion" style="margin-bottom: var(--sp-2);"><summary>🔄 <strong>Importación Inteligente desde CSV</strong></summary><div class="accordion__content" style="padding-top: var(--sp-2);"><p>¿Vienes de otra app o tienes tus datos en una hoja de cálculo? ¡No hay problema! Ve a <strong>Ajustes > Copia de Seguridad > Importar CSV</strong>. Solo necesitas un archivo con 5 columnas:</p><code>FECHA;CUENTA;CONCEPTO;IMPORTE;DESCRIPCIÓN</code><p>La app es muy lista y hará magia por ti:</p><ul><li>Si una cuenta o concepto no existe, ¡lo crea automáticamente!</li><li><strong>Truco PRO:</strong> Si en la columna CONCEPTO pones <code>TRASPASO</code>, la app buscará un movimiento de la misma fecha e importe contrario en otra cuenta y los emparejará como una transferencia.</li><li><strong>Truco PRO 2:</strong> Usa el CONCEPTO <code>INICIAL</code> para establecer el saldo de partida de una cuenta. Por ejemplo: "01/01/2025;Mi Banco;INICIAL;1500;Saldo inicial del año".</li></ul></div></details><p style="text-align: center; margin-top: var(--sp-5); font-style: italic; color: var(--c-on-surface-secondary);">¡Explora, registra y toma el control definitivo de tu futuro financiero!</p>`
    }
};

export const t = (key, replacements = {}) => {
    const lang = translations[currentLanguage] || translations.es;
    let text = lang[key] || translations.es[key] || `[${key}]`;
    for (const placeholder in replacements) {
        text = text.replace(`{${placeholder}}`, replacements[placeholder]);
    }
    return text;
};

export const applyStaticTranslations = () => {
    document.querySelectorAll('[data-i18n]').forEach(el => { el.textContent = t(el.dataset.i18n); });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { el.placeholder = t(el.dataset.i18nPlaceholder); });
    document.querySelectorAll('[data-i18n-title]').forEach(el => { el.title = t(el.dataset.i18nTitle); });
};


// --- SELECTORES DEL DOM ---
export const select = (id) => document.getElementById(id);
export const selectAll = (s) => document.querySelectorAll(s);
export const selectOne = (s) => document.querySelector(s);


// --- NOTIFICACIONES Y FEEDBACK ---
export function showToast(message, type = 'default', duration = 3000) {
    const c = select('toast-container'); 
    if (!c) return;
    const t = document.createElement('div');
    t.className = `toast`;
    c.appendChild(t);
    const fadeIn = t.animate([{ transform: 'translateY(20px) scale(0.95)', opacity: 0 }, { transform: 'translateY(0) scale(1)', opacity: 1 }], { duration: 300, easing: 'ease-out' });
    fadeIn.onfinish = () => {
        t.textContent = message;
        t.classList.add(`toast--${type}`);
        if (type === 'danger' || type === 'error') hapticFeedback('error');
        else if (type === 'warning') hapticFeedback('warning');
        setTimeout(() => {
            t.animate([{ opacity: 1 }, { opacity: 0 }], { duration: 300, easing: 'ease-in' }).onfinish = () => t.remove();
        }, duration);
    };
}

export function hapticFeedback(type = 'light') {
    if ('vibrate' in navigator) {
        try {
            let pattern;
            switch (type)