<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Agenda aiDANaI</title>

    <!-- Dependencias Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <!-- MEJORA: Añadida fuente condensada para mayor densidad de información -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- PWA y Metadatos -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"Agenda aiDANaI","short_name":"aiDANaI","description":"Agenda aiDANaI: When the ideas become real","start_url":".","display":"standalone","background_color":"#000000","theme_color":"#000000","icons":[{"src":"aiDANaI.webp","sizes":"192x192","type":"image/webp"},{"src":"aiDANaI.webp","sizes":"512x512","type":"image/webp"},{"src":"aiDANaI.webp","sizes":"180x180","type":"image/webp","purpose":"apple touch icon"}]}'>
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="aiDANaI.webp">

    <style>
        /* ============================ */
        /* 1. VARIABLES Y ESTILO BASE   */
        /* ============================ */
        :root {
            --primary-color: #7B68EE;
            --primary-variant: #5A4CAD;
            --secondary-color: #9E9EAD;
            --background: #F8F8FA;
            --surface: #FFFFFF;
            --surface-variant: #F0F0F5;
            --on-primary: #FFFFFF;
            --on-background: #1A1C20;
            --on-surface: #1A1C20;
            --outline: #E0E0E6;
            
            --accent-task: #4CAF50; 
            --accent-event-normal: #2196F3;
            --accent-event-important: #F44336;
            
            --saturday-text: #2196F3;
            --sunday-text: #F44336;

            --accent-delete: #E53935;
            --accent-complete: #43A047;
            --accent-edit: #FFC107;

            /* MEJORA: Fuente condensada por defecto */
            --font-roboto: 'Roboto Condensed', 'Roboto', sans-serif;
            --shadow-layered: 0px 4px 8px rgba(26, 28, 32, 0.04), 0px 8px 24px rgba(26, 28, 32, 0.08);
            --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
        }
        
        [data-theme="dark"] {
            --primary-color: #A78BFA;
            --primary-variant: #7B68EE;
            --secondary-color: #9E9EAD;
            --background: #000000;
            --surface: #121212;
            --surface-variant: #1E1E24;
            --on-primary: #000000;
            --on-background: #EAEAEA;
            --on-surface: #F5F5F5;
            --outline: #2A2A32;
            
            --saturday-text: #81D4FA;
            --sunday-text: #F48FB1;
            --shadow-layered: 0px 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; }
        body { font-family: var(--font-roboto); background-color: var(--background); color: var(--on-background); line-height: 1.5; overflow: hidden; min-height: 100vh; min-height: -webkit-fill-available; height: 100vh; transition: background-color 0.3s, color 0.3s; font-size: 14px; }
        *:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; border-radius: 6px; }
        
        /* ============================ */
        /* 2. VISTAS Y NAVEGACIÓN       */
        /* ============================ */
        #app-root { display: none; max-width: 420px; margin: 0 auto; height: 100vh; background: var(--background); position: relative; flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; padding-bottom: calc(60px + env(safe-area-inset-bottom)); }
        #app-root.visible { display: flex; opacity: 1; }
        .main-content { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        .view { display: none; width: 100%; flex-direction: column; animation: slideAndFadeIn 0.4s var(--ease-out-quint); height: 100%; overflow-y: auto; padding: 16px; }
        #calendarView { padding: 0; overflow-y: hidden; }
        .view.active { display: flex; }
        @keyframes slideAndFadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 420px; background: rgba(28, 28, 28, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(56, 56, 66, 0.5); display: flex; padding: 4px 0 calc(8px + env(safe-area-inset-bottom)) 0; z-index: 100; }
        [data-theme="light"] .bottom-nav { background: rgba(255, 255, 255, 0.7); border-top: 1px solid rgba(224, 224, 230, 0.5); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 4px; cursor: pointer; transition: color 0.2s; color: var(--secondary-color); border: none; background: transparent; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item .material-icons { font-size: 24px; margin-bottom: 2px; }
        .nav-label { font-size: 11px; font-weight: 500; }

        /* ============================ */
        /* 3. VISTA DE AGENDA           */
        /* ============================ */
        .calendar-container { flex-shrink: 0; padding: 12px 16px; border-bottom: 1px solid var(--outline); }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        #calendar-title-btn { font-size: 18px; font-weight: 500; background: none; border: none; color: var(--on-background); padding: 6px 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #calendar-title-btn:hover { background-color: var(--surface-variant); }
        .calendar-nav { display: flex; align-items: center; gap: 4px; }
        .icon-button { background: none; border: none; color: var(--secondary-color); cursor: pointer; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .icon-button:hover { background-color: var(--surface-variant); color: var(--on-surface); }
        
        .calendar-grid { background: var(--surface); border-radius: 16px; padding: 8px; box-shadow: var(--shadow-layered); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
        .weekday { text-align: center; font-size: 11px; font-weight: 500; color: var(--secondary-color); padding: 4px; }
        .weekday.saturday { color: var(--saturday-text); }
        .weekday.sunday { color: var(--sunday-text); }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; position: relative; font-size: 13px; transition: all 0.2s; padding: 4px 0; }
        .calendar-day:hover { background: var(--surface-variant); }
        .day-number { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .calendar-day.today .day-number { background: var(--primary-color); color: var(--on-primary); font-weight: 700; }
        .calendar-day.selected .day-number { background: var(--primary-variant); color: var(--on-primary); transform: scale(1.1); }
        .calendar-day.other-month { color: var(--outline); pointer-events: none; }
        .calendar-day.saturday .day-number { color: var(--saturday-text); }
        .calendar-day.saturday.today .day-number { color: var(--on-primary); }
        .calendar-day.sunday .day-number { color: var(--sunday-text); }
        .calendar-day.sunday.today .day-number { color: var(--on-primary); }

        .calendar-day .event-dots-container { position: absolute; bottom: 4px; left: 0; right: 0; display: flex; justify-content: center; gap: 3px; }
        .event-dot { width: 5px; height: 5px; border-radius: 50%; }
        .event-dot.important { background-color: var(--accent-event-important); }
        .event-dot.normal { background-color: var(--accent-event-normal); }

        .agenda-list-container { flex-grow: 1; overflow-y: auto; padding: 8px 16px 80px 16px; }
        #agenda-title { font-size: 16px; font-weight: 500; display: flex; align-items: center; gap: 8px; padding-bottom: 8px; }
        .agenda-date-header { font-weight: 700; letter-spacing: 0.3px; font-size: 12px; color: var(--primary-color); padding: 8px 12px; background-color: var(--surface-variant); position: sticky; top: 0; z-index: 1; border-radius: 8px; margin-top: 8px; margin-bottom: 4px; }

        /* ============================ */
        /* 4. VISTA DE TAREAS           */
        /* ============================ */
        .section-title { font-size: 16px; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; letter-spacing: 0.2px; }

        /* ============================ */
        /* 5. COMPONENTES DE LISTA COMPACTOS */
        /* ============================ */
        .list-item-swipe-container { 
            display: flex; 
            align-items: center; 
            background: var(--surface); 
            border-radius: 8px; /* Más compacto */
            margin-bottom: 6px; /* Más junto */
            box-shadow: var(--shadow-layered); 
            transition: all 0.3s var(--ease-out-quint); 
            user-select: none; 
            position: relative; 
            padding: 8px 12px; /* Más compacto */
            border-left: 4px solid transparent; 
        }
        .list-item-swipe-container .item-content { flex: 1; cursor: pointer; min-width: 0; }
        .item-card-swipe-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; color: white; opacity: 0; transition: opacity 0.2s; z-index: 0; }
        .item-card-swipe-background .material-icons { font-size: 24px; }
        .list-item-swipe-container.swiping-right.type-task .item-card-swipe-background { background-color: var(--accent-complete); justify-content: flex-start; opacity: 1; }
        .list-item-swipe-container.swiping-right.type-agenda .item-card-swipe-background { background-color: var(--accent-edit); justify-content: flex-start; opacity: 1; }
        .list-item-swipe-container.swiping-left .item-card-swipe-background { background-color: var(--accent-delete); justify-content: flex-end; opacity: 1; }

        .list-item-swipe-container.completed { opacity: 0.6; }
        .list-item-swipe-container.completed .item-title { text-decoration: line-through; text-decoration-color: var(--secondary-color); }
        
        .item-title { 
            font-weight: 400; 
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-checkbox { 
            width: 20px; height: 20px; 
            margin-right: 10px; 
        }
        .item-checkbox .material-icons { font-size: 16px; }

        /* --- MEJORA: Estructura compacta para eventos --- */
        .event-item-content {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            min-width: 0;
        }
        .event-time {
            font-size: 13px;
            font-weight: 700;
            color: var(--secondary-color);
        }
        .event-title {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }
        .event-meta-icon {
            font-size: 16px;
            color: var(--secondary-color);
            flex-shrink: 0;
        }

        /* ============================ */
        /* 6. MODALES Y OTROS           */
        /* ============================ */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; align-items: flex-end; justify-content: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.4s var(--ease-out-quint); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal { background: var(--surface); border-radius: 24px 24px 0 0; padding: 16px 24px 24px 24px; width: 100%; max-width: 420px; max-height: 95vh; overflow-y: auto; box-shadow: var(--shadow-layered); transform: translateY(100%); transition: transform 0.4s var(--ease-out-quint); }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-grabber { width: 40px; height: 5px; background-color: var(--outline); border-radius: 2.5px; margin: 0 auto 16px; flex-shrink: 0; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--secondary-color); }
        .form-input, .form-select { width: 100%; padding: 12px; border: 1.5px solid var(--outline); border-radius: 10px; background: var(--surface); color: var(--on-surface); font-size: 14px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(123, 104, 238, 0.2); }
        .btn { padding: 10px 20px; border: none; border-radius: 24px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background: var(--primary-color); color: var(--on-primary); }
        .btn-secondary { background: transparent; color: var(--secondary-color); border: 1.5px solid var(--outline); }
        .btn-danger { background-color: transparent; border: 1px solid var(--accent-delete); color: var(--accent-delete); }
        .form-group-datetime { display: none; }
        .empty-state { text-align: center; padding: 40px 24px; color: var(--secondary-color); }
        .empty-state .material-icons { font-size: 48px; margin-bottom: 8px; }

        .intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; background-color: #000; transition: opacity 0.5s ease-out; }
        .intro-screen.visible { display: flex; }
        #welcomeScreen { background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px), radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px), radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px), radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px); background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px; background-position: 0 0, 40px 60px, 130px 270px, 70px 100px; animation: move-stars 120s linear infinite; }
        #welcomeImage { width: 250px; height: auto; opacity: 0; animation: growAndFade 2.5s ease-in-out forwards; }
        @keyframes growAndFade { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(8); opacity: 0; } }
        @keyframes move-stars { from { background-position: 0 0, 40px 60px, 130px 270px, 70px 100px; } to { background-position: -10000px 5000px, -10000px 5000px, -10000px 5000px, -10000px 5000px; } }

        #quoteScreen { text-align: center; color: #FFF; padding: 20px; opacity: 0; transition: opacity 1.5s; background-color: #000; }
        #quoteText { font-size: 22px; font-style: italic; font-weight: 300; max-width: 600px; }
        #quoteAuthor { display: block; font-size: 16px; margin-top: 12px; font-weight: 500; }

        .login-view { position: fixed; inset: 0; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; opacity: 0; transition: opacity .5s; background-color: var(--background); }
        .login-view--visible { display: flex; opacity: 1; }
        .login-view__card { background-color: var(--surface); padding: 1.25rem; border-radius: 18px; box-shadow: var(--shadow-layered); width: 100%; max-width: 340px; text-align: center; animation: pop-in 0.3s ease-out; }
        @keyframes pop-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #toast-container { position: fixed; bottom: calc(85px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .toast { background-color: rgba(30, 30, 36, 0.8); backdrop-filter: blur(5px); color: white; padding: 10px 18px; border-radius: 12px; box-shadow: var(--shadow-layered); display: flex; align-items: center; animation: toastFadeIn 0.4s var(--ease-out-quint), toastFadeOut 0.4s 2.6s var(--ease-out-quint); font-size: 14px; }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(10px) scale(0.95); } }
    </style>
</head>
<body>
    
    <div id="welcomeScreen" class="intro-screen"><img src="aiDANaI.webp" id="welcomeImage" alt="Logo Agenda aiDANaI"></div>
    <div id="quoteScreen" class="intro-screen"><p id="quoteText"></p><span id="quoteAuthor"></span></div>
    
    <div id="login-screen" class="login-view">
        <div class="login-view__card">
            <h2 class="login-view__title">🗓️ Agenda aiDANaI</h2>
            <form id="login-form" novalidate>
                <div class="form-group"><input type="email" id="login-email" class="form-input" placeholder="Correo electrónico" required></div>
                <div class="form-group"><input type="password" id="login-password" class="form-input" placeholder="Contraseña" required></div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button type="button" data-action="login" class="btn btn-primary" style="flex: 1;">Iniciar Sesión</button>
                    <button type="button" data-action="register" class="btn btn-secondary" style="flex: 1;">Registrarse</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-root">
        <main class="main-content" id="main-content-area">
            
            <div id="calendarView" class="view active">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button id="calendar-title-btn" title="Seleccionar mes y año"></button>
                        <div class="calendar-nav">
                             <button id="add-item-header-btn" class="icon-button" title="Añadir ítem">
                                <span class="material-icons">add</span>
                             </button>
                             <button id="today-btn" class="icon-button" title="Hoy"><span class="material-icons">today</span></button>
                             <button id="prev-nav-btn" class="icon-button" title="Mes anterior"><span class="material-icons">chevron_left</span></button>
                             <button id="next-nav-btn" class="icon-button" title="Mes siguiente"><span class="material-icons">chevron_right</span></button>
                        </div>
                    </div>
                    <div id="calendar-main-area">
                        <div id="calendar-grid" class="calendar-grid">
                            <div class="calendar-weekdays" id="calendarWeekdays"></div>
                            <div class="calendar-days" id="calendarDays"></div>
                        </div>
                    </div>
                </div>
                <div class="agenda-list-container">
                     <h3 id="agenda-title"></h3>
                    <div id="agendaList"></div>
                </div>
            </div>

            <div id="tasksView" class="view">
                <h3 class="section-title" id="pending-items-title">Tareas Pendientes</h3>
                <div id="pendingItemsList"></div>
                <h3 class="section-title" id="completed-items-title" style="margin-top:24px;">Completados</h3>
                <div id="completedItemsList"></div>
                <div id="emptyTasks" class="empty-state" style="display: none;">
                    <span class="material-icons">check_circle_outline</span>
                    <p>No tienes ítems aquí.</p>
                </div>
            </div>
            
            <div id="helpView" class="view">
                 <div class="help-section">
                    <h2 class="section-title" style="font-size: 20px;"><span><span class="material-icons">rocket_launch</span>Guía Maestra de aiDANaI</span></h2>
                    <p style="padding: 0 4px 12px; font-size: 15px; color: var(--secondary-color);">Tu agenda inteligente está lista para ser tu segundo cerebro 🧠. Esta guía explica cada detalle para que domines la aplicación.</p>
                    
                    <details open>
                        <summary>La Filosofía: Eventos vs. Tareas<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Tu vida se organiza en dos categorías clave:</p>
                            <ul>
                                <li><b>Eventos:</b> Todo lo que ocurre en un momento específico (reuniones, citas, cumpleaños). Viven en la <b>pestaña Agenda</b> y se marcan con colores para indicar su importancia: <span style="color:var(--accent-event-important)"><b>Rojo</b></span> para importantes y <span style="color:var(--accent-event-normal)"><b>Azul</b></span> para normales.</li>
                                <li><b>Tareas:</b> Tus listas de "cosas por hacer" que no dependen de una fecha u hora. Viven en la <b>pestaña Tareas</b> y se identifican con el color <span style="color:var(--accent-task)"><b>Verde</b></span>.</li>
                            </ul>
                        </div>
                    </details>
                    
                    <details>
                        <summary>Gestos: La Clave de la Productividad<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Interactúa con tus ítems de la forma más rápida e intuitiva:</p>
                            <ul>
                                <li><span class="material-icons" style="vertical-align: middle;">edit</span> <b>TOQUE / DESLIZAR DERECHA (en Eventos):</b> Un simple toque en cualquier ítem, o deslizar un <b>evento</b> hacia la derecha, abrirá la ventana de edición.</li>
                                <li><span class="material-icons" style="vertical-align: middle;">check_circle</span> <b>DESLIZAR DERECHA (en Tareas):</b> Deslizar una <b>tarea</b> hacia la derecha la marcará como completada o pendiente.</li>
                                <li><span class="material-icons" style="vertical-align: middle;">delete</span> <b>DESLIZAR IZQUIERDA:</b> Para cualquier ítem, deslizar a la izquierda mostrará la opción para eliminarlo permanentemente.</li>
                            </ul>
                        </div>
                    </details>

                    <details>
                        <summary>Navegación y Funciones<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                             <p>Domina todas las herramientas a tu disposición:</p>
                            <ul>
                                <li><b>Navegación Inferior:</b> Cambia entre <b>Agenda</b>, <b>Tareas</b> y esta <b>Ayuda</b>.</li>
                                <li><b>Añadir Ítem:</b> Pulsa el botón <span class="material-icons">add</span> en la cabecera de la Agenda para crear un nuevo evento o tarea.</li>
                                <li><b>Viaje en el Calendario:</b> Usa las flechas <span class="material-icons">chevron_left</span> y <span class="material-icons">chevron_right</span> o toca el nombre del mes para saltar a cualquier fecha.</li>
                                <li><b>Tema e Intro:</b> En la barra inferior, puedes cambiar entre tema claro/oscuro (<span class="material-icons">brightness_6</span>) y volver a ver la animación de bienvenida (<span class="material-icons">movie</span>).</li>
                            </ul>
                        </div>
                    </details>

                    <details>
                        <summary>Notificaciones<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Activa notificaciones para tus eventos importantes. Al crear o editar un evento, marca la casilla <b>"Activar notificación"</b>.</p>
                            <ul>
                                <li>La primera vez, tu navegador te pedirá <b>permiso</b>. ¡Asegúrate de aceptarlo!</li>
                                <li>Recibirás un aviso justo a la hora del evento.</li>
                                <li><b>Importante:</b> Para que las notificaciones funcionen, la aplicación debe estar abierta en una pestaña del navegador.</li>
                            </ul>
                        </div>
                    </details>
                </div>
            </div>
        </main>
        
        <nav class="bottom-nav">
            <button class="nav-item active" data-view="calendar" title="Agenda"><span class="material-icons">calendar_today</span><span class="nav-label">Agenda</span></button>
            <button class="nav-item" data-view="tasks" title="Tareas"><span class="material-icons">task_alt</span><span class="nav-label">Tareas</span></button>
            <button class="nav-item" data-view="help" title="Ayuda"><span class="material-icons">help_outline</span><span class="nav-label">Ayuda</span></button>
            <button class="nav-item" id="nav-intro-btn" title="Ver Intro"><span class="material-icons">movie</span><span class="nav-label">Intro</span></button>
            <button class="nav-item" id="nav-theme-btn" title="Cambiar Tema"><span class="material-icons">brightness_6</span><span class="nav-label">Tema</span></button>
            <button class="nav-item" data-action="logout" title="Salir de la App"><span class="material-icons">logout</span><span class="nav-label">Salir</span></button>
        </nav>
    </div>

    <!-- Modales -->
    <div id="add-item-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-grabber"></div>
            <form id="add-item-form">
                <input type="hidden" id="item-local-id">
                <div class="form-group"><label class="form-label" for="item-description">Descripción</label><textarea class="form-input" id="item-description" placeholder="Describe el ítem..."></textarea></div>
                <div class="form-group"><label class="form-label" for="item-type">Tipo</label><select class="form-select" id="item-type"><option value="agenda">Evento (con fecha)</option><option value="task">Tarea (sin fecha)</option></select></div>
                <div id="datetime-notification-group" class="form-group-datetime">
                    <div class="form-group"><label class="form-label" for="item-datetime">Fecha y Hora</label><input type="text" class="form-input" id="item-datetime" placeholder="Selecciona fecha y hora..."></div>
                    <div id="event-options" style="margin-top: 12px;">
                        <div class="form-group"><input type="checkbox" id="item-important" style="margin-right: 8px;"><label for="item-important">Marcar como importante (Rojo)</label></div>
                        <div class="form-group"><input type="checkbox" id="item-notification-enabled" style="margin-right: 8px;"><label for="item-notification-enabled">Activar notificación</label></div>
                        <div class="form-group" style="margin-top: 12px;"><label class="form-label" for="item-recurrence">Repetir</label><select class="form-select" id="item-recurrence"><option value="none">No repetir</option><option value="daily">Diariamente</option><option value="weekly">Semanalmente</option><option value="monthly">Mensualmente</option><option value="yearly">Anualmente</option></select></div>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="button" class="btn btn-danger" id="delete-item-btn" style="margin-right: auto; display: none;">Eliminar</button>
                    <button type="button" class="btn btn-secondary" id="cancel-item-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="save-item-btn">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="date-picker-modal" class="modal-overlay">
         <div class="modal">
             <div class="modal-grabber"></div>
            <form id="date-picker-form"><div class="form-group"><label class="form-label">Mes</label><select id="month-select" class="form-select"></select></div><div class="form-group"><label class="form-label">Año</label><input type="number" id="year-select" min="2020" max="2030" step="1" class="form-input"></div><div style="display:flex; gap:12px; margin-top:24px;"><button type="button" class="btn btn-secondary" id="cancel-date-picker-btn">Cancelar</button><button type="submit" class="btn btn-primary">Ir</button></div></form>
        </div>
    </div>
    
    <div id="toast-container"></div>


    <script>
    // =================================================================================
    // 1. CONFIGURACIÓN GLOBAL Y CONSTANTES
    // =================================================================================
    const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };
    const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const DIAS_SEMANA = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
    const QUOTES = [ { text: "La única forma de hacer un gran trabajo es amar lo que haces.", author: "Steve Jobs" }, { text: "El futuro pertenece a quienes creen en la belleza de sus sueños.", author: "Eleanor Roosevelt" }, { text: "Cree que puedes y ya estás a medio camino.", author: "Theodore Roosevelt" } ];
    
    let flatpickrInstance = null;
    let currentUser = null, unsubscribeFromDb = null, saveTimeout = null, db = {};
    let activeTimers = {}; // Para gestionar los timeouts de las notificaciones

    const initialState = { currentView: 'calendar', calendar: { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), selectedDate: dateToYYYYMMDD(new Date()) } };
    let appState = {...initialState};

    // Funciones de utilidad
    const gebi = id => document.getElementById(id);
    const qsa = selector => document.querySelectorAll(selector);
    function dateToYYYYMMDD(date) { if (!date || isNaN(date)) return ''; return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; }
    function dateToHHMM(date) { if (!date || isNaN(date)) return "00:00"; return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`; }
    function yyyymmddToDate(dateStr) { if (!dateStr) return new Date(); const parts = dateStr.split('-'); return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10)); }
    function uuid() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
    function showToast(message) { const tc = gebi('toast-container'); if (!tc) return; const t = document.createElement('div'); t.className = `toast`; t.textContent = message; tc.appendChild(t); setTimeout(() => t.remove(), 3000); }
    
    document.addEventListener('DOMContentLoaded', initApp);

    // =================================================================================
    // 2. FIREBASE Y MANEJO DE DATOS
    // =================================================================================
    firebase.initializeApp(firebaseConfig);
    const fbAuth = firebase.auth(), fbDb = firebase.firestore();

    const getInitialDb = () => ({ items: [], config: { theme: 'dark' } });

    const saveData = (successCallback = () => {}) => {
        if (!currentUser) return;
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            fbDb.collection('users').doc(currentUser.uid).set({ db })
                .then(successCallback)
                .catch(error => console.error("Error al guardar:", error));
        }, 500);
    };

    const loadData = uid => {
        const userDocRef = fbDb.collection('users').doc(uid);
        if (unsubscribeFromDb) unsubscribeFromDb();
        unsubscribeFromDb = userDocRef.onSnapshot(doc => {
            let needsSave = false;
            if (doc.exists && doc.data().db) {
                db = doc.data().db;
                if (!db.items) { db.items = []; needsSave = true; }
                if (!db.config) { db.config = { theme: 'dark' }; needsSave = true; }
            } else { db = getInitialDb(); needsSave = true; }
            if (needsSave) saveData();
            startMainApp();
        }, error => console.error("Error con Firestore:", error));
    };

    // =================================================================================
    // 3. INICIALIZACIÓN DE LA APP Y AUTENTICACIÓN
    // =================================================================================
    function initApp() {
        attachGlobalEventListeners();
        initializeDatePicker();
        checkAuthState();
    }

    const checkAuthState = () => fbAuth.onAuthStateChanged(user => { 
        if (user) { 
            currentUser = user; 
            loadData(user.uid); 
        } else { 
            currentUser = null; 
            if (unsubscribeFromDb) unsubscribeFromDb(); 
            db = getInitialDb();
            showLoginScreen(); 
        } 
    });

    const startMainApp = () => {
        applyTheme(db.config.theme || 'dark');
        
        gebi('login-screen').classList.remove('login-view--visible');
        gebi('welcomeScreen').style.display = 'none';
        gebi('quoteScreen').style.display = 'none';
        gebi('app-root').classList.add('visible'); 
        
        switchView('calendar');
        scheduleAllNotifications();
    };
    
    const showLoginScreen = () => {
        applyTheme(localStorage.getItem('theme') || 'dark');
        gebi('app-root').classList.remove('visible');
        gebi('login-screen').classList.add('login-view--visible');
    };
    
    const handleLogin = () => {
        const email = gebi('login-email').value, password = gebi('login-password').value;
        if (!email || !password) return;
        fbAuth.signInWithEmailAndPassword(email, password).catch(() => {});
    };

    const handleRegister = () => {
        const email = gebi('login-email').value, password = gebi('login-password').value;
        if (!email || password.length < 6) return;
        fbAuth.createUserWithEmailAndPassword(email, password).catch(() => {});
    };

    async function playIntroSequence() {
        gebi('app-root').classList.remove('visible');
        await wait(400);

        const welcomeScreen = gebi('welcomeScreen');
        welcomeScreen.style.opacity = '1';
        welcomeScreen.style.display = 'flex';
        welcomeScreen.classList.add('visible');
        
        await wait(2500); 
        welcomeScreen.style.opacity = '0';
        
        const quoteScreen = gebi('quoteScreen');
        const quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
        gebi('quoteText').textContent = `“${quote.text}”`; 
        gebi('quoteAuthor').textContent = `– ${quote.author}`;
        
        quoteScreen.style.display = 'flex';
        quoteScreen.classList.add('visible'); 
        await wait(100); 
        quoteScreen.style.opacity = '1'; 
        await wait(4000);
        quoteScreen.style.opacity = '0'; 
        await wait(500);
        
        welcomeScreen.style.display = 'none';
        quoteScreen.style.display = 'none'; 

        gebi('app-root').classList.add('visible');
        switchView('calendar');
    }
    
    // =================================================================================
    // 4. RENDERIZADO Y LÓGICA DE UI
    // =================================================================================
    function renderApp() { 
        if (!db || !currentUser) return;
        updateNav(appState.currentView); 
        renderCurrentView(appState); 
    }

    function renderCurrentView(state) {
        qsa('.view').forEach(v => v.classList.remove('active'));
        const viewEl = gebi(`${state.currentView}View`);
        if (viewEl) { 
            viewEl.classList.add('active');
            if (state.currentView === 'calendar') renderCalendarView(state);
            if (state.currentView === 'tasks') renderTaskListView();
        }
    }
    
    function updateNav(currentView) { 
        qsa('.nav-item[data-view]').forEach(item => {
            item.classList.toggle('active', item.dataset.view === currentView);
        }); 
    }
    
    function renderCalendarView(state) {
        const { calendar } = state;
        const { items } = db;
        const { currentMonth, currentYear, selectedDate } = calendar;
        gebi('calendar-title-btn').textContent = `${MESES[currentMonth]} ${currentYear}`;
        
        const weekdaysContainer = gebi('calendarWeekdays');
        if (!weekdaysContainer.hasChildNodes()) { 
            weekdaysContainer.innerHTML = DIAS_SEMANA.map((day, index) => 
                `<div class="weekday ${index === 5 ? 'saturday' : ''} ${index === 6 ? 'sunday' : ''}">${day}</div>`
            ).join(''); 
        }
        
        const calendarDays = gebi('calendarDays');
        calendarDays.innerHTML = ''; 
        const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
        const offset = (firstDayOfMonth.getDay() + 6) % 7;
        const startDate = new Date(firstDayOfMonth);
        startDate.setDate(startDate.getDate() - offset);
        const todayStr = dateToYYYYMMDD(new Date());

        const dailyEventMarkers = new Map();
        items.filter(it => it.type === 'agenda' && it.dueDate).forEach(it => {
            const dateStr = dateToYYYYMMDD(new Date(it.dueDate));
            if (!dailyEventMarkers.has(dateStr)) dailyEventMarkers.set(dateStr, { hasImportant: false, hasNormal: false });
            const marker = dailyEventMarkers.get(dateStr);
            if (it.isImportant) marker.hasImportant = true;
            else marker.hasNormal = true;
        });

        for (let i = 0; i < 42; i++) {
            const cellDate = new Date(startDate); cellDate.setDate(startDate.getDate() + i);
            const dateStr = dateToYYYYMMDD(cellDate); 
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day'; 
            dayEl.dataset.date = dateStr;

            const dayOfWeek = cellDate.getDay();
            if (dayOfWeek === 6) dayEl.classList.add('saturday');
            if (dayOfWeek === 0) dayEl.classList.add('sunday');

            if (cellDate.getMonth() !== currentMonth) dayEl.classList.add('other-month');
            if (dateStr === todayStr) dayEl.classList.add('today');
            if (dateStr === selectedDate) dayEl.classList.add('selected');
            
            let dotsHtml = '';
            if (dailyEventMarkers.has(dateStr)) {
                const markers = dailyEventMarkers.get(dateStr);
                dotsHtml = `<div class="event-dots-container">
                    ${markers.hasImportant ? '<span class="event-dot important"></span>' : ''}
                    ${markers.hasNormal ? '<span class="event-dot normal"></span>' : ''}
                </div>`;
            }
            dayEl.innerHTML = `<span class="day-number">${cellDate.getDate()}</span>${dotsHtml}`;
            if (cellDate.getMonth() === currentMonth) dayEl.onclick = () => selectDate(dateStr);
            calendarDays.appendChild(dayEl);
        }
        renderAgendaFromSelectedDay(items, selectedDate);
    }
    
    function renderAgendaFromSelectedDay(items, selectedDateStr) {
        const agendaList = gebi('agendaList');
        const agendaTitle = gebi('agenda-title');
        const selectedDate = yyyymmddToDate(selectedDateStr);
        selectedDate.setHours(0,0,0,0);

        const upcomingItems = items
            .filter(item => item.type === 'agenda' && item.dueDate && new Date(item.dueDate) >= selectedDate)
            .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        
        const todayStr = dateToYYYYMMDD(new Date());
        agendaTitle.innerHTML = `<span class="material-icons">view_agenda</span><span>${selectedDateStr === todayStr ? 'Próximos Eventos' : 'Eventos desde el ' + selectedDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}</span>`;
        
        agendaList.innerHTML = '';
        if (upcomingItems.length === 0) {
            agendaList.innerHTML = `<div class="empty-state"><span class="material-icons">event_available</span><div>No hay eventos programados desde esta fecha.</div></div>`;
            return;
        }
        
        let lastHeaderDate = null;
        upcomingItems.forEach(item => {
            const itemDate = new Date(item.dueDate);
            const itemDateStr = dateToYYYYMMDD(itemDate);
            if (itemDateStr !== lastHeaderDate) {
                const header = document.createElement('div');
                header.className = 'agenda-date-header';
                header.textContent = itemDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                agendaList.appendChild(header);
                lastHeaderDate = itemDateStr;
            }
            agendaList.appendChild(createUniversalListItemNode(item));
        });
    }

    function renderTaskListView() {
        const { items } = db;
        
        const pendingItems = items.filter(i => !i.isComplete);
        const pendingTasks = pendingItems.filter(i => i.type === 'task').sort((a, b) => a.description.localeCompare(b.description));
        const pendingEvents = pendingItems.filter(i => i.type === 'agenda').sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        const combinedPending = [...pendingTasks, ...pendingEvents];

        const completedItems = items.filter(i => i.isComplete).sort((a,b) => (b.completedAt || 0) - (a.completedAt || 0));

        gebi('pending-items-title').style.display = combinedPending.length > 0 ? 'flex' : 'none';
        gebi('completed-items-title').style.display = completedItems.length > 0 ? 'flex' : 'none';
        
        renderItemsList(gebi('pendingItemsList'), combinedPending, createUniversalListItemNode); 
        renderItemsList(gebi('completedItemsList'), completedItems.slice(0, 20), createUniversalListItemNode);
        
        gebi('emptyTasks').style.display = (combinedPending.length === 0 && completedItems.length === 0) ? 'block' : 'none';
    }
    
    function renderItemsList(container, items, nodeCreator) {
        container.innerHTML = '';
        items.forEach(item => container.appendChild(nodeCreator(item)));
    }

    function createUniversalListItemNode(item) {
        if (item.type === 'task') {
            return createTaskItemNode(item);
        } else {
            return createEventItemNode(item);
        }
    }

    function createEventItemNode(item) {
        const itemEl = document.createElement('div');
        itemEl.className = `list-item-swipe-container type-agenda ${item.isComplete ? 'completed' : ''}`;
        itemEl.dataset.id = item.localId;
        const itemColor = item.isImportant ? 'var(--accent-event-important)' : 'var(--accent-event-normal)';
        itemEl.style.borderLeftColor = itemColor;

        const time = dateToHHMM(new Date(item.dueDate));
        itemEl.innerHTML = `
            <div class="item-card-swipe-background">
                <span class="material-icons">edit</span>
                <span class="material-icons">delete</span>
            </div>
            <div class="event-item-content" data-action="edit">
                <span class="event-time">${time}</span>
                <span class="event-title">${item.description}</span>
                ${item.recurrenceRule !== 'none' ? '<span class="material-icons event-meta-icon">repeat</span>' : ''}
            </div>`;
        itemEl.querySelector('[data-action="edit"]').onclick = () => openAddItemModal(item);
        attachSwipeListeners(itemEl);
        return itemEl;
    }

    function createTaskItemNode(item) {
        const itemEl = document.createElement('div');
        itemEl.dataset.id = item.localId;
        itemEl.className = `list-item-swipe-container type-task ${item.isComplete ? 'completed' : ''}`;
        itemEl.style.borderLeftColor = 'var(--accent-task)';

        itemEl.innerHTML = `
            <div class="item-card-swipe-background">
                <span class="material-icons">check_circle</span>
                <span class="material-icons">delete</span>
            </div>
            <div class="item-checkbox ${item.isComplete ? 'checked' : ''}" data-action="complete">${item.isComplete ? '<span class="material-icons">check</span>' : ''}</div>
            <div class="item-content" data-action="edit">
                <div class="item-title">${item.description}</div>
            </div>`;
        itemEl.querySelector('[data-action="edit"]').onclick = () => openAddItemModal(item);
        itemEl.querySelector('[data-action="complete"]').onclick = (e) => { e.stopPropagation(); handleItemComplete(item.localId, !item.isComplete); };
        attachSwipeListeners(itemEl);
        return itemEl;
    }
    
    // =================================================================================
    // 5. MANEJADORES DE EVENTOS
    // =================================================================================
    function attachGlobalEventListeners() {
        const safeAddListener = (id, event, handler) => {
            const element = gebi(id);
            if (element) {
                element.addEventListener(event, handler);
            }
        };

        document.body.addEventListener('click', e => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;
            const action = actionTarget.dataset.action;
            if (action === 'login') handleLogin();
            if (action === 'register') handleRegister();
            if (action === 'logout' && confirm("¿Seguro que quieres cerrar sesión?")) { fbAuth.signOut(); }
        });

        qsa('.nav-item[data-view]').forEach(item => item.addEventListener('click', () => switchView(item.dataset.view)));
        
        safeAddListener('nav-theme-btn', 'click', handleThemeToggle);
        safeAddListener('nav-intro-btn', 'click', playIntroSequence);
        safeAddListener('prev-nav-btn', 'click', () => changeMonth(-1));
        safeAddListener('next-nav-btn', 'click', () => changeMonth(1));
        safeAddListener('today-btn', 'click', goToToday);
        safeAddListener('calendar-title-btn', 'click', openDatePickerModal);
        safeAddListener('add-item-header-btn', 'click', () => openAddItemModal());
        safeAddListener('cleanup-items-btn', 'click', handleCleanupOldItems);
        safeAddListener('add-item-form', 'submit', handleItemFormSubmit);
        safeAddListener('cancel-item-btn', 'click', () => closeModal('add-item-modal'));
        safeAddListener('item-type', 'change', toggleDateTimeNotificationVisibility);
        safeAddListener('delete-item-btn', 'click', handleDeleteFromModal);
        safeAddListener('date-picker-form', 'submit', handleDateSelectionFromPicker);
        safeAddListener('cancel-date-picker-btn', 'click', () => closeModal('date-picker-modal'));
    }

    // =================================================================================
    // 6. LÓGICA PRINCIPAL (CRUD Y ACCIONES)
    // =================================================================================
    function switchView(view) { if (!view) return; appState.currentView = view; renderApp(); }
    function selectDate(dateStr) { appState.calendar.selectedDate = dateStr; renderApp(); }
    function changeMonth(delta) { const d = new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 1); d.setMonth(d.getMonth() + delta); appState.calendar.currentMonth = d.getMonth(); appState.calendar.currentYear = d.getFullYear(); renderApp(); }
    function goToToday() { const today = new Date(); appState.calendar = { ...appState.calendar, currentMonth: today.getMonth(), currentYear: today.getFullYear(), selectedDate: dateToYYYYMMDD(today) }; renderApp(); }
    
    function openModal(modalId) { gebi(modalId)?.classList.add('active'); }
    function closeModal(modalId) { gebi(modalId)?.classList.remove('active'); }

    function openAddItemModal(itemToEdit = null) {
        const f = gebi('add-item-form'); f.reset();
        gebi('delete-item-btn').style.display = itemToEdit ? 'block' : 'none';
        gebi('item-local-id').value = itemToEdit?.localId || uuid();
        gebi('item-type').value = itemToEdit?.type || (appState.currentView === 'calendar' ? 'agenda' : 'task');
        gebi('item-description').value = itemToEdit?.description || '';
        const dateToShow = itemToEdit?.dueDate ? new Date(itemToEdit.dueDate) : yyyymmddToDate(appState.calendar.selectedDate);
        flatpickrInstance.setDate(dateToShow, false);
        gebi('item-important').checked = itemToEdit?.isImportant || false;
        gebi('item-notification-enabled').checked = itemToEdit?.notificationEnabled || false;
        gebi('item-recurrence').value = itemToEdit?.recurrenceRule || 'none';
        toggleDateTimeNotificationVisibility(); 
        openModal('add-item-modal');
        gebi('item-description').focus();
    }

    function toggleDateTimeNotificationVisibility() { gebi('datetime-notification-group').style.display = gebi('item-type').value === 'agenda' ? 'block' : 'none'; }

    function handleItemFormSubmit(e) {
        e.preventDefault();
        const localId = gebi('item-local-id').value;
        const existingItem = db.items.find(i => i.localId === localId);
        const itemData = {
            localId: localId,
            type: gebi('item-type').value,
            description: gebi('item-description').value.trim(),
            isComplete: existingItem?.isComplete || false,
            createdAt: existingItem?.createdAt || Date.now(),
            isImportant: gebi('item-type').value === 'agenda' ? gebi('item-important').checked : false,
            notificationEnabled: gebi('item-type').value === 'agenda' ? gebi('item-notification-enabled').checked : false,
            notificationShown: (existingItem && existingItem.dueDate === flatpickrInstance.selectedDates[0]?.toISOString()) ? existingItem.notificationShown : false,
            recurrenceRule: gebi('item-type').value === 'agenda' ? gebi('item-recurrence').value : 'none',
            dueDate: gebi('item-type').value === 'agenda' ? flatpickrInstance.selectedDates[0]?.toISOString() : null,
        };

        if (itemData.notificationEnabled) {
            requestNotificationPermission();
        }

        handleItemSave(itemData);
        closeModal('add-item-modal');
    }

    function handleItemSave(itemData) {
        const index = db.items.findIndex(i => i.localId === itemData.localId);
        if (index > -1) db.items[index] = { ...db.items[index], ...itemData };
        else db.items.unshift(itemData);
        
        saveData(() => {
            scheduleAllNotifications();
            if (itemData.type === 'task') {
                switchView('tasks');
            } else {
                renderApp();
            }
        });
    }

    function handleItemComplete(localId, isComplete) {
        const item = db.items.find(i => i.localId === localId);
        if (!item) return;

        if (isComplete && item.type === 'agenda' && item.recurrenceRule !== 'none') {
            const nextDueDate = calculateNextDueDate(new Date(item.dueDate), item.recurrenceRule);
            if (nextDueDate) {
                const newItemData = { ...item, localId: uuid(), isComplete: false, createdAt: Date.now(), dueDate: nextDueDate.toISOString() };
                db.items.unshift(newItemData);
                db.items = db.items.filter(i => i.localId !== localId);
            }
        } else {
            const index = db.items.findIndex(i => i.localId === localId);
            if (index > -1) {
                db.items[index] = { ...item, isComplete, completedAt: isComplete ? Date.now() : null };
            }
        }
        saveData(() => {
            scheduleAllNotifications();
            renderApp();
        });
    }
    
    function handleDeleteFromModal() { 
        const localId = gebi('item-local-id').value;
        const item = db.items.find(i => i.localId === localId);
        if (item && confirm("¿Eliminar este ítem permanentemente?")) { 
            db.items = db.items.filter(i => i.localId !== localId);
            saveData(() => {
                scheduleAllNotifications();
                closeModal('add-item-modal');
                if (item.type === 'task') {
                    switchView('tasks');
                } else {
                    renderApp();
                }
            });
        } 
    }
    
    function applyTheme(theme) { 
        document.documentElement.setAttribute('data-theme', theme); 
        localStorage.setItem('theme', theme);
    }

    function handleThemeToggle() { 
        const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; 
        db.config.theme = newTheme;
        applyTheme(newTheme);
        saveData();
    }

    function openDatePickerModal() { 
        openModal('date-picker-modal'); 
        const monthSelect = gebi('month-select'); 
        monthSelect.innerHTML = MESES.map((mes, i) => `<option value="${i}">${mes}</option>`).join(''); 
        monthSelect.value = appState.calendar.currentMonth; 
        gebi('year-select').value = appState.calendar.currentYear; 
    }

    function handleDateSelectionFromPicker(e) { 
        e.preventDefault(); 
        appState.calendar.currentMonth = parseInt(gebi('month-select').value, 10); 
        appState.calendar.currentYear = parseInt(gebi('year-select').value, 10);
        renderApp();
        closeModal('date-picker-modal'); 
    }

    function handleCleanupOldItems() { 
        const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
        const originalCount = db.items.length;
        db.items = db.items.filter(item => !item.isComplete || item.completedAt > thirtyDaysAgo);
        const cleanedCount = originalCount - db.items.length;
        if (cleanedCount > 0) {
            saveData(() => renderApp());
        }
    }
    
    // =================================================================================
    // 7. NOTIFICACIONES
    // =================================================================================
    async function requestNotificationPermission() {
        if (!("Notification" in window)) {
            showToast("Este navegador no soporta notificaciones.");
            return 'denied';
        }
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            showToast("¡Permiso de notificaciones concedido!");
        } else {
            showToast("Permiso de notificaciones denegado.");
        }
        return permission;
    }

    function showNotification(item) {
        if (Notification.permission !== "granted") return;
        
        const notificationBody = `Tu evento "${item.description}" es ahora.`;
        const notificationOptions = {
            body: notificationBody,
            icon: './aiDANaI.webp', // Asegúrate que la ruta sea correcta
            badge: './aiDANaI.webp'
        };
        
        new Notification('Recordatorio de Agenda', notificationOptions);
        
        const index = db.items.findIndex(i => i.localId === item.localId);
        if (index > -1) {
            db.items[index].notificationShown = true;
            saveData();
        }
    }

    function scheduleNotification(item) {
        if (activeTimers[item.localId]) {
            clearTimeout(activeTimers[item.localId]);
        }
        if (!item.notificationEnabled || item.isComplete || !item.dueDate || item.notificationShown) {
            return;
        }
        
        const msUntilDue = new Date(item.dueDate).getTime() - Date.now();
        if (msUntilDue > 0) {
            activeTimers[item.localId] = setTimeout(() => {
                showNotification(item);
            }, msUntilDue);
        }
    }

    function scheduleAllNotifications() {
        if (!db.items) return;
        Object.values(activeTimers).forEach(clearTimeout);
        activeTimers = {};
        db.items.forEach(scheduleNotification);
    }

    // =================================================================================
    // 8. UTILIDADES Y AYUDANTES
    // =================================================================================
    function attachSwipeListeners(cardEl) {
        if (!cardEl || cardEl.dataset.hammer) return;
        cardEl.dataset.hammer = 'true';
        const mc = new Hammer.Manager(cardEl);
        mc.add(new Hammer.Pan({ threshold: 10, pointers: 1 }));

        mc.on('pan', e => {
            const itemTypeClass = cardEl.classList.contains('type-task') ? 'type-task' : 'type-agenda';
            cardEl.style.transform = `translateX(${e.deltaX}px)`;
            if (e.deltaX > 20) {
                cardEl.classList.add('swiping-right', itemTypeClass);
            } else if (e.deltaX < -20) {
                cardEl.classList.add('swiping-left');
            } else {
                cardEl.classList.remove('swiping-right', 'swiping-left', 'type-task', 'type-agenda');
            }
        });

        mc.on('panend', e => {
            cardEl.style.transition = 'transform 0.3s, opacity 0.3s';
            const threshold = cardEl.offsetWidth * 0.35;
            const id = cardEl.dataset.id;
            const item = db.items.find(i => i.localId === id);
            if (!item) return;

            if (e.deltaX > threshold) { // Deslizar a la derecha
                if (item.type === 'task') {
                    handleItemComplete(id, !item.isComplete);
                } else { // Es un evento ('agenda')
                    openAddItemModal(item);
                }
                cardEl.style.transform = 'translateX(0)';
            } else if (e.deltaX < -threshold) { // Deslizar a la izquierda (borrar para ambos)
                if (confirm(`¿Eliminar "${item.description}"?`)) {
                    db.items = db.items.filter(i => i.localId !== id);
                    saveData(() => {
                        scheduleAllNotifications();
                        renderApp();
                    });
                } else {
                    cardEl.style.transform = 'translateX(0)';
                }
            } else {
                cardEl.style.transform = 'translateX(0)';
            }
            
            setTimeout(() => {
                cardEl.classList.remove('swiping-right', 'swiping-left', 'type-task', 'type-agenda');
                cardEl.style.transition = 'all 0.3s var(--ease-out-quint)';
            }, 300);
        });
    }

    function initializeDatePicker() { 
        flatpickr.localize(flatpickr.l10ns.es); 
        flatpickrInstance = flatpickr("#item-datetime", { 
            enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true, minuteIncrement: 15 
        }); 
    }
    
    function calculateNextDueDate(currentDate, rule) {
        let nextDate = new Date(currentDate);
        const rules = {
            'daily': () => nextDate.setDate(nextDate.getDate() + 1),
            'weekly': () => nextDate.setDate(nextDate.getDate() + 7),
            'monthly': () => nextDate.setMonth(nextDate.getMonth() + 1),
            'yearly': () => nextDate.setFullYear(nextDate.getFullYear() + 1),
        };
        if (rules[rule]) rules[rule]();
        else return null;
        return nextDate;
    }
    
    </script>
</body>
</html>