<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Agenda aiDANaI</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:wght@400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <link rel="manifest" href='data:application/manifest+json,{"name":"Agenda aiDANaI","short_name":"aiDANaI","description":"Agenda aiDANaI: When the ideas become real","start_url":".","display":"standalone","background_color":"#000000","theme_color":"#000000","icons":[{"src":"aiDANaI.webp","sizes":"192x192","type":"image/webp"},{"src":"aiDANaI.webp","sizes":"512x512","type":"image/webp"},{"src":"aiDANaI.webp","sizes":"180x180","type":"image/webp","purpose":"apple touch icon"}]}'>
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="aiDANaI.webp">

    <style>
        /* ============================ */
        /* 1. VARIABLES Y ESTILO BASE   */
        /* ============================ */
        :root {
            --primary-color: #7B68EE;
            --primary-variant: #5A4CAD;
            --secondary-color: #9E9EAD;
            --background: #F8F8FA;
            --surface: #FFFFFF;
            --surface-variant: #F0F0F5;
            --on-primary: #FFFFFF;
            --on-background: #1A1C20;
            --on-surface: #1A1C20;
            --outline: #E0E0E6;
            
            --accent-task: #4CAF50; 
            --accent-event-normal: #2196F3;
            --accent-event-important: #F44336;
            --accent-delete: #E53935;
            --accent-complete: #43A047;
            --accent-edit: #1E88E5;

            --font-main: 'Archivo Narrow', 'Roboto', sans-serif;
            --shadow-layered: 0px 4px 8px rgba(26, 28, 32, 0.04), 0px 8px 24px rgba(26, 28, 32, 0.08);
            --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
        }
        
        [data-theme="dark"] {
            --primary-color: #A78BFA;
            --primary-variant: #7B68EE;
            --secondary-color: #9E9EAD;
            --background: #000000;
            --surface: #121212;
            --surface-variant: #1E1E24;
            --on-primary: #000000;
            --on-background: #EAEAEA;
            --on-surface: #F5F5F5;
            --outline: #2A2A32;
            --shadow-layered: 0px 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; }
        body { font-family: var(--font-main); background-color: var(--background); color: var(--on-background); line-height: 1.5; overflow: hidden; min-height: 100vh; min-height: -webkit-fill-available; height: 100vh; transition: background-color 0.3s, color 0.3s; font-size: 15px; }
        *:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; border-radius: 6px; }
        
        /* ============================ */
        /* 2. VISTAS Y NAVEGACIÓN       */
        /* ============================ */
        #app-root { display: none; max-width: 420px; margin: 0 auto; height: 100vh; background: var(--background); position: relative; flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; padding-bottom: calc(52px + env(safe-area-inset-bottom)); }
        #app-root.visible { display: flex; opacity: 1; }
        .main-content { flex: 1; display: flex; position: relative; overflow: hidden; }
        .view { display: none; width: 100%; flex-direction: column; animation: slideAndFadeIn 0.4s var(--ease-out-quint); height: 100%; overflow-y: auto; padding: 16px; }
        #calendarView { padding: 0; overflow-y: hidden; }
        .view.active { display: flex; }
        @keyframes slideAndFadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 420px; background: rgba(28, 28, 28, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(56, 56, 66, 0.5); display: flex; padding: 2px 0 calc(2px + env(safe-area-inset-bottom)) 0; z-index: 100; }
        [data-theme="light"] .bottom-nav { background: rgba(255, 255, 255, 0.7); border-top: 1px solid rgba(224, 224, 230, 0.5); }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px 0; cursor: pointer; transition: color 0.2s, background-color 0.2s; color: var(--secondary-color); border: none; background: transparent; border-radius: 8px; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item .material-icons { font-size: 24px; margin: 0; }
        .nav-label { display: none; }

        /* ============================ */
        /* 3. HEADER Y VISTAS PRINCIPALES */
        /* ============================ */
        .calendar-container { flex-shrink: 0; padding: 8px 16px; border-bottom: 1px solid var(--outline); }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .calendar-title-container { position: relative; display: inline-flex; align-items: center; }
        #calendar-title-btn { font-size: 18px; font-weight: 700; background: none; border: none; color: var(--on-background); padding: 4px 6px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #calendar-title-btn:hover { background-color: var(--surface-variant); }
        .calendar-nav { display: flex; align-items: center; gap: 2px; }
        .icon-button { background: none; border: none; color: var(--secondary-color); cursor: pointer; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .icon-button .material-icons { font-size: 22px; }
        .icon-button:hover { background-color: var(--surface-variant); color: var(--on-surface); }
        #sync-status-indicator { position: absolute; top: 2px; right: -20px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
        #sync-status-indicator .material-icons { font-size: 14px; transition: color 0.3s; }
        #sync-status-indicator.online .material-icons { color: var(--accent-complete); }
        #sync-status-indicator.offline .material-icons { color: var(--secondary-color); }

        .calendar-grid { background: var(--surface); border-radius: 12px; padding: 6px; box-shadow: var(--shadow-layered); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
        .weekday { text-align: center; font-size: 12px; font-weight: 500; color: var(--secondary-color); padding: 4px; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; position: relative; font-size: 14px; transition: all 0.2s; padding: 4px 0; }
        .day-number { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .calendar-day.today .day-number { background: var(--primary-color); color: var(--on-primary); font-weight: 700; }
        .calendar-day.selected .day-number { background: var(--primary-variant); color: var(--on-primary); }
        .calendar-day.other-month { color: var(--outline); pointer-events: none; }
        .calendar-day .event-dots-container { position: absolute; bottom: 4px; left: 0; right: 0; display: flex; justify-content: center; gap: 3px; }
        .event-dot { width: 4px; height: 4px; border-radius: 50%; }
        .event-dot.important { background-color: var(--accent-event-important); }
        .event-dot.normal { background-color: var(--accent-event-normal); }
        .agenda-list-container { flex-grow: 1; overflow-y: auto; padding: 8px 16px 80px 16px; }
        .agenda-date-header { font-weight: 700; letter-spacing: 0.3px; font-size: 12px; color: var(--primary-color); padding: 8px 12px; background-color: var(--surface-variant); position: sticky; top: 0; z-index: 1; border-radius: 8px; margin-top: 8px; margin-bottom: 4px; }
        #today-greeting { font-size: 22px; font-weight: 700; margin-bottom: 24px; }
        .section-title { font-size: 16px; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; letter-spacing: 0.2px; margin-top: 24px; }

        /* ============================ */
        /* 4. BÚSQUEDA Y FAB            */
        /* ============================ */
        #search-container { padding: 4px 16px 8px; transition: max-height 0.4s ease-out, opacity 0.4s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        #search-container.active { max-height: 60px; opacity: 1; }
        #search-form { display: flex; gap: 8px; align-items: center; }
        #search-input { flex-grow: 1; padding: 10px 16px; border: 1.5px solid var(--outline); border-radius: 24px; background: var(--surface-variant); color: var(--on-surface); font-size: 14px; }
        #search-input:focus { outline: none; border-color: var(--primary-color); }
        
        /* --- NUEVO: Estilo para el Botón de Acción Flotante (FAB) --- */
        .fab {
            position: fixed;
            bottom: calc(65px + env(safe-area-inset-bottom)); /* 52px nav + 13px margen */
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--on-primary);
            border: none;
            box-shadow: var(--shadow-layered);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 150;
            transition: background-color 0.2s, transform 0.2s var(--ease-out-quint);
        }
        .fab:hover {
            background-color: var(--primary-variant);
            transform: scale(1.05);
        }
        .fab .material-icons {
            font-size: 28px;
        }

        /* ============================ */
        /* 5. COMPONENTES DE LISTA      */
        /* ============================ */
        .list-item-swipe-container { display: flex; align-items: flex-start; background: var(--surface); border-radius: 8px; margin-bottom: 6px; box-shadow: var(--shadow-layered); transition: all 0.3s var(--ease-out-quint); user-select: none; position: relative; padding: 12px; border-left: 4px solid transparent; }
        .list-item-swipe-container .item-content { flex: 1; cursor: pointer; min-width: 0; }
        .item-card-swipe-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; color: white; opacity: 0; transition: opacity 0.2s; z-index: 0; }
        .list-item-swipe-container.swiping-right.type-task .item-card-swipe-background { background-color: var(--accent-complete); justify-content: flex-start; opacity: 1; }
        .list-item-swipe-container.swiping-right.type-agenda .item-card-swipe-background { background-color: var(--accent-edit); justify-content: flex-start; opacity: 1; }
        .list-item-swipe-container.swiping-left .item-card-swipe-background { background-color: var(--accent-delete); justify-content: flex-end; opacity: 1; }
        .list-item-swipe-container.completed { opacity: 0.6; }
        .list-item-swipe-container.completed .item-title { text-decoration: line-through; text-decoration-color: var(--secondary-color); }
        .item-title, .event-title { font-weight: 400; font-size: 15px; white-space: normal; word-break: break-word; line-height: 1.4; }
        .item-checkbox { width: 20px; height: 20px; margin-right: 12px; padding-top: 2px; }
        .event-item-content { display: flex; align-items: flex-start; gap: 10px; width: 100%; min-width: 0; }
        .event-time { font-size: 14px; font-weight: 700; color: var(--secondary-color); padding-top: 1px; }
        .event-title { flex-grow: 1; }
        .event-meta-icon { font-size: 16px; color: var(--secondary-color); flex-shrink: 0; }
        .subtask-progress { font-size: 12px; color: var(--secondary-color); margin-top: 4px; }

        /* ============================ */
        /* 6. MODALES Y OTROS           */
        /* ============================ */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; align-items: flex-end; justify-content: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.4s var(--ease-out-quint); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal { background: var(--surface); border-radius: 24px 24px 0 0; padding: 16px 24px 24px 24px; width: 100%; max-width: 420px; max-height: 95vh; overflow-y: auto; box-shadow: var(--shadow-layered); transform: translateY(100%); transition: transform 0.4s var(--ease-out-quint); }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-grabber { width: 40px; height: 5px; background-color: var(--outline); border-radius: 2.5px; margin: 0 auto 16px; flex-shrink: 0; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--secondary-color); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1.5px solid var(--outline); border-radius: 10px; background: var(--surface); color: var(--on-surface); font-size: 14px; font-family: var(--font-main); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(123, 104, 238, 0.2); }
        .form-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 24px; }
        .btn-icon { width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-icon .material-icons { font-size: 24px; }
        #delete-item-btn { background-color: transparent; color: var(--accent-delete); }
        #delete-item-btn:hover { background-color: rgba(229, 57, 53, 0.1); }
        #save-item-btn { background-color: var(--primary-color); color: var(--on-primary); box-shadow: 0 4px 12px rgba(123, 104, 238, 0.3); }
        #save-item-btn:hover { background-color: var(--primary-variant); }
        .btn { padding: 10px 20px; border: none; border-radius: 24px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; font-family: var(--font-main); }
        .btn-primary { background: var(--primary-color); color: var(--on-primary); }
        .btn-secondary { background: transparent; color: var(--secondary-color); border: 1.5px solid var(--outline); }
        .btn-link { background: none; border: none; color: var(--primary-color); font-weight: 500; cursor: pointer; }
        .form-group-datetime, #task-options-group { display: none; }
        .subtask-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .subtask-item input[type="checkbox"] { flex-shrink: 0; }
        .subtask-item input[type="text"] { flex-grow: 1; font-size: 14px; border: none; background: transparent; border-bottom: 1px solid var(--outline); border-radius: 0; padding: 4px 0; }
        .subtask-item input[type="text"]:focus { outline: none; border-bottom-color: var(--primary-color); }
        .subtask-item .delete-subtask-btn { color: var(--secondary-color); font-size: 20px; }

        .empty-state { text-align: center; padding: 40px 24px; color: var(--secondary-color); }
        .empty-state .material-icons { font-size: 48px; margin-bottom: 8px; }
        .intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; background-color: #000; transition: opacity 0.5s ease-out; }
        .intro-screen.visible { display: flex; }
        #welcomeImage { width: 250px; height: auto; opacity: 0; animation: growAndFade 2.5s ease-in-out forwards; }
        @keyframes growAndFade { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(8); opacity: 0; } }
        #quoteScreen { text-align: center; color: #FFF; padding: 20px; opacity: 0; transition: opacity 1.5s; background-color: #000; }
        #quoteText { font-size: 22px; font-style: italic; font-weight: 300; max-width: 600px; }
        #quoteAuthor { display: block; font-size: 16px; margin-top: 12px; font-weight: 500; }
        .login-view { position: fixed; inset: 0; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; opacity: 0; transition: opacity .5s; background-color: var(--background); }
        .login-view--visible { display: flex; opacity: 1; }
        .login-view__card { background-color: var(--surface); padding: 1.25rem; border-radius: 18px; box-shadow: var(--shadow-layered); width: 100%; max-width: 340px; text-align: center; animation: pop-in 0.3s ease-out; }
        @keyframes pop-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #toast-container { position: fixed; bottom: calc(60px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .toast { background-color: rgba(30, 30, 36, 0.8); backdrop-filter: blur(5px); color: white; padding: 10px 18px; border-radius: 12px; box-shadow: var(--shadow-layered); display: flex; align-items: center; animation: toastFadeIn 0.4s var(--ease-out-quint), toastFadeOut 0.4s 2.6s var(--ease-out-quint); font-size: 14px; }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(10px) scale(0.95); } }
        .tasks-header { display: flex; align-items: center; justify-content: space-between; padding: 0 0 16px 0; }
        .tasks-header .form-select { flex-grow: 1; }
        .tasks-header .icon-button { flex-shrink: 0; margin-left: 8px; }
        .help-section details { background: var(--surface); padding: 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--outline); }
        .help-section summary { font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .help-section summary .material-icons { transition: transform 0.2s; }
        .help-section details[open] summary .material-icons { transform: rotate(180deg); }
        .help-section .details-content { padding-top: 12px; }
        .help-section ul { padding-left: 20px; } .help-section li { margin-bottom: 8px; }
        
        @media (min-width: 768px) {
            #app-root { max-width: 720px; }
            .bottom-nav { max-width: 720px; }
            body { font-size: 16px; }
            .modal-overlay { align-items: center; }
            .modal { border-radius: 24px; transform: translateY(0); max-height: 80vh; }
        }
        @media (min-width: 1024px) {
            body { overflow: auto; }
            #app-root { flex-direction: row; max-width: 100%; height: 100vh; padding-bottom: 0; }
            .bottom-nav { position: static; transform: none; flex-direction: column; width: auto; max-width: none; height: 100vh; border-top: none; border-right: 1px solid var(--outline); padding: 24px 8px; justify-content: flex-start; gap: 8px; background: var(--surface); backdrop-filter: none; }
            [data-theme="light"] .bottom-nav { background: var(--surface-variant); }
            .nav-item { flex: 0; flex-direction: row; justify-content: center; width: 100%; padding: 12px; }
            .nav-item:hover { background-color: var(--surface-variant); }
            .nav-item.active { background-color: var(--primary-color); color: var(--on-primary); }
            [data-theme="dark"] .nav-item.active { background-color: var(--primary-variant); }
            .nav-item .material-icons { margin: 0; }
            #toast-container { bottom: 24px; left: calc(50% + 70px); }
            .main-content { height: 100vh; overflow-y: auto; }
            #calendarView { flex-direction: row; align-items: flex-start; gap: 24px; padding: 24px; overflow-y: hidden; }
            .calendar-container { flex: 0 0 400px; border-bottom: none; padding: 0; position: sticky; top: 24px; }
            .agenda-list-container { flex-grow: 1; padding: 0; height: calc(100vh - 48px); }
            .view#todayView, .view#tasksView, .view#helpView, .view#searchView { max-width: 800px; margin: 0 auto; padding: 32px; }
            /* --- NUEVO: Ajuste de posición del FAB para escritorio --- */
            .fab {
                bottom: 32px;
                right: 32px;
            }
        }
    </style>
</head>
<body>
    
    <div id="welcomeScreen" class="intro-screen"><img src="aiDANaI.webp" id="welcomeImage" alt="Logo Agenda aiDANaI"></div>
    <div id="quoteScreen" class="intro-screen"><p id="quoteText"></p><span id="quoteAuthor"></span></div>
    
    <div id="login-screen" class="login-view">
        <div class="login-view__card">
            <h2 class="login-view__title">🗓️ Agenda aiDANaI</h2>
            <form id="login-form" novalidate>
                <div class="form-group"><input type="email" id="login-email" class="form-input" placeholder="Correo electrónico" required></div>
                <div class="form-group"><input type="password" id="login-password" class="form-input" placeholder="Contraseña" required></div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button type="button" data-action="login" class="btn btn-primary" style="flex: 1;">Iniciar Sesión</button>
                    <button type="button" data-action="register" class="btn btn-secondary" style="flex: 1;">Registrarse</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-root">
        <nav class="bottom-nav">
            <button class="nav-item active" data-view="today" title="Hoy"><span class="material-icons">home</span></button>
            <button class="nav-item" data-view="calendar" title="Agenda"><span class="material-icons">calendar_today</span></button>
            <button class="nav-item" data-view="tasks" title="Tareas"><span class="material-icons">task_alt</span></button>
            <button class="nav-item" data-view="help" title="Ayuda"><span class="material-icons">help_outline</span></button>
            <button class="nav-item" id="nav-theme-btn" title="Cambiar Tema"><span class="material-icons">brightness_6</span></button>
            <button class="nav-item" data-action="logout" title="Salir de la App"><span class="material-icons">logout</span></button>
        </nav>

        <main class="main-content" id="main-content-area">
            
            <div id="todayView" class="view active">
                <h1 id="today-greeting"></h1>
                <h3 class="section-title" id="today-events-title">Eventos de Hoy</h3>
                <div id="today-events-list"></div>
                <div id="empty-today-events" class="empty-state" style="display: none;"><span class="material-icons">celebration</span><p>No tienes eventos para hoy. ¡Disfruta del día!</p></div>
                <h3 class="section-title" id="today-tasks-title">Tareas Pendientes</h3>
                <div id="today-tasks-list"></div>
                <div id="empty-today-tasks" class="empty-state" style="display: none;"><span class="material-icons">check_circle</span><p>¡Ninguna tarea pendiente! Bien hecho.</p></div>
                <h3 class="section-title" id="tomorrow-events-title">Mañana te espera...</h3>
                <div id="tomorrow-events-list"></div>
                <div id="empty-tomorrow-events" class="empty-state" style="display: none;"><span class="material-icons">event_upcoming</span><p>Nada programado para mañana todavía.</p></div>
            </div>

            <div id="calendarView" class="view">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-title-container">
                            <button id="calendar-title-btn" title="Seleccionar mes y año"></button>
                            <span id="sync-status-indicator"></span>
                        </div>
                        <div class="calendar-nav">
                             <button id="search-toggle-btn" class="icon-button" title="Buscar"><span class="material-icons">search</span></button>
                             <!-- ELIMINADO: El botón de añadir de aquí se ha movido a un FAB global -->
                             <button id="today-btn" class="icon-button" title="Ir a Hoy en el Calendario"><span class="material-icons">today</span></button>
                             <button id="prev-nav-btn" class="icon-button" title="Mes anterior"><span class="material-icons">chevron_left</span></button>
                             <button id="next-nav-btn" class="icon-button" title="Mes siguiente"><span class="material-icons">chevron_right</span></button>
                        </div>
                    </div>
                    <div id="search-container">
                        <form id="search-form"><input type="search" id="search-input" placeholder="Buscar y pulsar Enter..."><button type="submit" class="btn btn-primary" style="padding: 8px 12px; border-radius: 50%; width: 40px; height: 40px;"><span class="material-icons">search</span></button></form>
                    </div>
                    <div id="calendar-main-area">
                        <div id="calendar-grid" class="calendar-grid"><div class="calendar-weekdays" id="calendarWeekdays"></div><div class="calendar-days" id="calendarDays"></div></div>
                    </div>
                </div>
                <div class="agenda-list-container"><div id="agendaList"></div></div>
            </div>

            <div id="tasksView" class="view">
                <div class="tasks-header">
                    <select id="task-list-filter" class="form-select"></select>
                    <button id="manage-lists-btn" class="icon-button" title="Gestionar Listas"><span class="material-icons">playlist_add</span></button>
                </div>
                <div id="tasks-content"></div>
                <div id="emptyTasks" class="empty-state" style="display: none;"><span class="material-icons">check_circle_outline</span><p>No tienes tareas en esta lista.</p></div>
            </div>
            
            <div id="searchView" class="view">
                <h3 class="section-title" id="search-results-title">Resultados de la Búsqueda</h3>
                <div id="searchResultsList"></div>
                <div id="emptySearch" class="empty-state" style="display: none;"><span class="material-icons">search_off</span><p>No se encontraron resultados.</p></div>
            </div>
            
             <div id="helpView" class="view">
                 <div class="help-section">
                    <h2 class="section-title" style="font-size: 20px;"><span><span class="material-icons">rocket_launch</span>Guía Maestra de aiDANaI</span></h2>
                    <p style="padding: 0 4px 12px; font-size: 15px; color: var(--secondary-color);">Tu agenda inteligente es ahora más potente. Domina cada nueva función para convertirla en tu segundo cerebro 🧠.</p>
                    
                    <details open><summary>🚀 Lo Nuevo: ¡Superpoderes para tu Agenda!<span class="material-icons">expand_more</span></summary><div class="details-content">
                        <p>Hemos añadido dos funciones revolucionarias para cambiar tu forma de organizarte:</p>
                        <ul>
                            <li><b>Creación Rápida con Lenguaje Natural:</b> La forma más rápida e intuitiva de añadir ítems.</li>
                            <li><b>Organización Avanzada de Tareas:</b> Usa Listas y Sub-tareas para gestionar proyectos complejos.</li>
                        </ul>
                        <p>¡Sigue leyendo para descubrir cómo funcionan!</p>
                    </div></details>
                     
                    <details><summary>✨ Creación Rápida: Habla con tu Agenda<span class="material-icons">expand_more</span></summary><div class="details-content">
                        <p>Olvídate de los formularios. Pulsa el botón flotante <span class="material-icons" style="vertical-align: middle;">add_circle</span> y escribe lo que quieres hacer. ¡Así de fácil! La IA de aiDANaI lo entenderá.</p>
                        <ul>
                            <li><b>Para crear un evento:</b> Incluye una fecha y/o una hora.
                                <br><i>Ej: "Reunión de equipo mañana a las 10:30"</i>
                                <br><i>Ej: "Cena con Ana el viernes a las 9 de la noche"</i>
                                <br><i>Ej: "Ir al dentista el 25 de agosto"</i>
                            </li>
                            <li><b>Para crear una tarea:</b> Simplemente escribe la acción.
                                <br><i>Ej: "Comprar leche y pan"</i>
                            </li>
                        </ul>
                        <p><b>Consejo Pro:</b> Si la IA no acierta, pulsa en "Editar Detalles" para ajustar manualmente el ítem en el formulario avanzado.</p>
                    </div></details>
                     
                    <details><summary>🗂️ Listas y Proyectos de Tareas<span class="material-icons">expand_more</span></summary><div class="details-content">
                        <p>Organiza tu vida en contextos separados. En la vista de <b>Tareas</b> (<span class="material-icons" style="vertical-align: middle;">task_alt</span>), ahora puedes gestionar diferentes listas.</p>
                        <ul>
                            <li><b>Cambiar de lista:</b> Usa el menú desplegable en la parte superior para ver las tareas de cada lista (ej: "Trabajo", "Personal").</li>
                            <li><b>Gestionar listas:</b> Pulsa el botón <span class="material-icons" style="vertical-align: middle;">playlist_add</span> para:
                                <ul>
                                    <li>Añadir una nueva lista.</li>
                                    <li>Renombrar una lista existente.</li>
                                    <li>Eliminar una lista (¡cuidado, esto borrará sus tareas!).</li>
                                </ul>
                            </li>
                            <li><b>Asignar tareas:</b> Al crear o editar una tarea en el modo avanzado, podrás seleccionar a qué lista pertenece.</li>
                        </ul>
                    </div></details>

                    <details><summary>📋 Sub-tareas: Desglosa tus Metas<span class="material-icons">expand_more</span></summary><div class="details-content">
                        <p>Las grandes tareas son solo un conjunto de pasos pequeños. Ahora puedes desglosarlas.</p>
                        <ul>
                            <li><b>Añadir Sub-tareas:</b> Al editar una tarea en el formulario avanzado, verás una nueva sección para "Sub-tareas". Escribe una y pulsa Enter para añadir más.</li>
                            <li><b>Progreso Visual:</b> En la vista principal, verás un indicador de progreso (ej: "2 de 5 completadas") debajo de las tareas que tienen sub-tareas.</li>
                            <li><b>Gestión:</b> Marca cada sub-tarea como completada con su propio checkbox o elimínala si ya no es necesaria.</li>
                        </ul>
                    </div></details>

                    <details><summary>👋 Gestos: La Clave de la Productividad<span class="material-icons">expand_more</span></summary><div class="details-content"><p>Interactúa con tus ítems de la forma más rápida e intuitiva:</p><ul><li><span class="material-icons" style="vertical-align: middle;">edit</span> <b>TOQUE / DESLIZAR DERECHA (en Eventos):</b> Un simple toque en cualquier ítem, o deslizar un <b>evento</b> hacia la derecha, abrirá la ventana de edición.</li><li><span class="material-icons" style="vertical-align: middle;">check_circle</span> <b>DESLIZAR DERECHA (en Tareas):</b> Deslizar una <b>tarea</b> hacia la derecha la marcará como completada o pendiente.</li><li><span class="material-icons" style="vertical-align: middle;">delete</span> <b>DESLIZAR IZQUIERDA:</b> Para cualquier ítem, deslizar a la izquierda mostrará la opción para eliminarlo permanentemente.</li></ul></div></details>
                 </div>
            </div>
        </main>
        
        <!-- NUEVO: Botón de Acción Flotante (FAB) global -->
        <button id="fab-add-item" class="fab" title="Añadir ítem">
            <span class="material-icons">add</span>
        </button>
    </div>

    <div id="quick-add-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-grabber"></div>
            <form id="quick-add-form">
                <div class="form-group">
                    <label class="form-label" for="quick-add-input">Creación Rápida con IA ✨</label>
                    <textarea class="form-textarea" id="quick-add-input" placeholder="Ej: 'Reunión con el equipo mañana a las 10:30'..." rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-link" id="open-advanced-editor-btn">Editar Detalles</button>
                    <div>
                        <button type="button" class="btn btn-secondary" id="cancel-quick-add-btn">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="save-quick-add-btn">Añadir</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="add-item-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-grabber"></div>
            <form id="add-item-form">
                <input type="hidden" id="item-local-id">
                <div class="form-group"><label class="form-label" for="item-description">Descripción</label><textarea class="form-textarea" id="item-description" placeholder="Describe el ítem..." rows="3"></textarea></div>
                <div class="form-group"><label class="form-label" for="item-type">Tipo</label><select class="form-select" id="item-type"><option value="agenda">Evento (con fecha)</option><option value="task">Tarea (sin fecha)</option></select></div>
                
                <div id="task-options-group">
                    <div class="form-group"><label class="form-label" for="item-task-list">Lista de Tareas</label><select class="form-select" id="item-task-list"></select></div>
                    <div class="form-group">
                        <label class="form-label">Sub-tareas</label>
                        <div id="subtasks-container"></div>
                        <div id="add-subtask-controls" style="display: flex; gap: 8px;">
                            <input type="text" id="new-subtask-input" class="form-input" placeholder="Añadir sub-tarea y pulsar Enter...">
                            <button type="button" id="add-subtask-btn" class="btn-icon" style="background:var(--primary-color); color: var(--on-primary); flex-shrink:0;"><span class="material-icons">add</span></button>
                        </div>
                    </div>
                </div>

                <div id="datetime-notification-group">
                    <div class="form-group"><label class="form-label" for="item-datetime">Fecha y Hora</label><input type="text" class="form-input" id="item-datetime" placeholder="Selecciona fecha y hora..."></div>
                    <div id="event-options" style="margin-top: 12px;">
                        <div class="form-group" style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="item-important"><label for="item-important">Marcar como importante (Rojo)</label></div>
                        <div class="form-group" style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="item-notification-enabled"><label for="item-notification-enabled">Activar notificación</label></div>
                        <div class="form-group" id="reminder-time-group" style="display: none; margin-top: 12px;">
                            <label class="form-label" for="item-reminder">Avisarme...</label>
                            <select class="form-select" id="item-reminder"><option value="0">Justo a la hora</option><option value="5">5 minutos antes</option><option value="15">15 minutos antes</option><option value="30">30 minutos antes</option><option value="60">1 hora antes</option></select>
                        </div>
                        <div class="form-group" style="margin-top: 12px;"><label class="form-label" for="item-recurrence">Repetir</label><select class="form-select" id="item-recurrence"><option value="none">No repetir</option><option value="daily">Diariamente</option><option value="weekly">Semanalmente</option><option value="monthly">Mensualmente</option><option value="yearly">Anualmente</option></select></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-icon" id="delete-item-btn" style="display: none;" title="Eliminar"><span class="material-icons">delete</span></button>
                    <button type="button" class="btn btn-secondary" id="cancel-item-btn">Cancelar</button>
                    <button type="submit" class="btn-icon" id="save-item-btn" title="Guardar"><span class="material-icons">check</span></button>
                </div>
            </form>
        </div>
    </div>
    <div id="manage-lists-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-grabber"></div>
            <h3 class="section-title">Gestionar Listas de Tareas</h3>
            <div id="task-lists-editor"></div>
            <form id="add-list-form" style="display:flex; gap:8px; margin-top:16px;">
                <input type="text" id="new-list-name" class="form-input" placeholder="Nombre de nueva lista..." required>
                <button type="submit" class="btn btn-primary">Añadir</button>
            </form>
            <div class="form-actions" style="justify-content:flex-end;">
                 <button type="button" class="btn btn-secondary" id="close-manage-lists-btn">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="date-picker-modal" class="modal-overlay"><div class="modal"><div class="modal-grabber"></div><form id="date-picker-form"><div class="form-group"><label class="form-label">Mes</label><select id="month-select" class="form-select"></select></div><div class="form-group"><label class="form-label">Año</label><input type="number" id="year-select" min="2020" max="2030" step="1" class="form-input"></div><div style="display:flex; gap:12px; margin-top:24px;"><button type="button" class="btn btn-secondary" id="cancel-date-picker-btn">Cancelar</button><button type="submit" class="btn btn-primary">Ir</button></div></form></div></div>
    <div id="toast-container"></div>

    <script>
    (() => {
        // =================================================================================
        // 1. CONFIGURACIÓN GLOBAL Y CONSTANTES
        // =================================================================================
        const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };
        const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const DIAS_SEMANA_LARGOS = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];
        const DIAS_SEMANA_CORTOS = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
        const QUOTES = [ { text: "La única forma de hacer un gran trabajo es amar lo que haces.", author: "Steve Jobs" }, { text: "El futuro pertenece a quienes creen en la belleza de sus sueños.", author: "Eleanor Roosevelt" }, { text: "Cree que puedes y ya estás a medio camino.", author: "Theodore Roosevelt" } ];
        
        let flatpickrInstance = null;
        let currentUser = null, unsubscribeFromDb = null, saveTimeout = null, db = {};
        let activeTimers = {};

        const initialState = { currentView: 'today', lastView: 'today', calendar: { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), selectedDate: dateToYYYYMMDD(new Date()) }, tasks: { selectedListId: 'default' } };
        let appState = {...initialState};

        const gebi = id => document.getElementById(id);
        const qsa = selector => document.querySelectorAll(selector);
        function dateToYYYYMMDD(date) { if (!date || isNaN(date.getTime())) return ''; return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; }
        function dateToHHMM(date) { if (!date || isNaN(date.getTime())) return "00:00"; return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`; }
        function yyyymmddToDate(dateStr) { if (!dateStr) return new Date(); const parts = dateStr.split('-'); return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10)); }
        function uuid() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
        const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
        function showToast(message) { const tc = gebi('toast-container'); if (!tc) return; const t = document.createElement('div'); t.className = `toast`; t.textContent = message; tc.appendChild(t); setTimeout(() => t.remove(), 3000); }
        
        document.addEventListener('DOMContentLoaded', initApp);

        // =================================================================================
        // 2. FIREBASE Y MANEJO DE DATOS
        // =================================================================================
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth(), fbDb = firebase.firestore();

        fbDb.enablePersistence().catch(err => {
            if (err.code == 'failed-precondition') { console.warn("Persistencia falló: múltiples pestañas abiertas."); } 
            else if (err.code == 'unimplemented') { console.warn("Persistencia no soportada en este navegador."); }
        });

        const getInitialDb = () => ({ 
            items: [], 
            taskLists: [{id: 'default', name: 'General'}],
            config: { theme: 'dark' } 
        });

        const saveData = (successCallback = () => {}) => {
            if (!currentUser) return;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                fbDb.collection('users').doc(currentUser.uid).set({ db })
                    .then(successCallback)
                    .catch(error => console.error("Error al guardar:", error));
            }, 500);
        };

        const loadData = uid => {
            const userDocRef = fbDb.collection('users').doc(uid);
            if (unsubscribeFromDb) unsubscribeFromDb();
            unsubscribeFromDb = userDocRef.onSnapshot(doc => {
                let needsSave = false;
                if (doc.exists && doc.data().db) {
                    db = doc.data().db;
                    if (!db.items) { db.items = []; needsSave = true; }
                    if (!db.config) { db.config = { theme: 'dark' }; needsSave = true; }
                    if (!db.taskLists || db.taskLists.length === 0) { db.taskLists = [{id: 'default', name: 'General'}]; needsSave = true; }
                } else { db = getInitialDb(); needsSave = true; }
                if (needsSave) saveData();
                startMainApp();
            }, error => console.error("Error con Firestore:", error));
        };

        // =================================================================================
        // 3. INICIALIZACIÓN DE LA APP Y AUTENTICACIÓN
        // =================================================================================
        function initApp() {
            attachGlobalEventListeners();
            initializeDatePicker();
            checkAuthState();
            updateSyncStatus();
        }

        const checkAuthState = () => fbAuth.onAuthStateChanged(user => { 
            if (user) { currentUser = user; loadData(user.uid); } 
            else { currentUser = null; if (unsubscribeFromDb) unsubscribeFromDb(); db = getInitialDb(); showLoginScreen(); } 
        });

        const startMainApp = () => {
            applyTheme(db.config.theme || 'dark');
            gebi('login-screen').classList.remove('login-view--visible');
            gebi('welcomeScreen').style.display = 'none';
            gebi('quoteScreen').style.display = 'none';
            gebi('app-root').classList.add('visible'); 
            switchView('today');
            scheduleAllNotifications();
        };
        
        const showLoginScreen = () => {
            applyTheme(localStorage.getItem('theme') || 'dark');
            gebi('app-root').classList.remove('visible');
            gebi('login-screen').classList.add('login-view--visible');
        };
        
        const handleAuthError = (error) => {
            switch (error.code) {
                case 'auth/user-not-found': showToast('Usuario no encontrado.'); break;
                case 'auth/wrong-password': showToast('Contraseña incorrecta.'); break;
                case 'auth/invalid-email': showToast('El formato del correo es inválido.'); break;
                case 'auth/email-already-in-use': showToast('El correo ya está registrado.'); break;
                case 'auth/weak-password': showToast('La contraseña debe tener al menos 6 caracteres.'); break;
                default: showToast('Ocurrió un error. Inténtalo de nuevo.'); console.error(error); break;
            }
        };

        const handleLogin = () => fbAuth.signInWithEmailAndPassword(gebi('login-email').value, gebi('login-password').value).catch(handleAuthError);
        const handleRegister = () => fbAuth.createUserWithEmailAndPassword(gebi('login-email').value, gebi('login-password').value).catch(handleAuthError);
        
        // =================================================================================
        // 4. RENDERIZADO Y LÓGICA DE UI
        // =================================================================================
        function renderApp() { 
            if (!db || !currentUser) return;
            updateNav(appState.currentView); 
            renderCurrentView(appState); 
        }

        function renderCurrentView(state) {
            qsa('.view').forEach(v => v.classList.remove('active'));
            const viewEl = gebi(`${state.currentView}View`);
            if (viewEl) { 
                viewEl.classList.add('active');
                if (state.currentView === 'today') renderTodayView();
                if (state.currentView === 'calendar') renderCalendarView(state);
                if (state.currentView === 'tasks') renderTaskListView();
            }
        }
        
        function updateNav(currentView) { 
            qsa('.nav-item[data-view]').forEach(item => {
                item.classList.toggle('active', item.dataset.view === currentView);
            }); 
        }
        
        function renderTodayView() {
            const hours = new Date().getHours();
            const greeting = hours < 12 ? "Buenos días" : hours < 20 ? "Buenas tardes" : "Buenas noches";
            gebi('today-greeting').textContent = greeting;

            const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
            const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
            const tomorrowStart = new Date(todayStart); tomorrowStart.setDate(tomorrowStart.getDate() + 1);
            const tomorrowEnd = new Date(todayEnd); tomorrowEnd.setDate(tomorrowEnd.getDate() + 1);

            const todayEvents = db.items.filter(i => i.type === 'agenda' && !i.isComplete && new Date(i.dueDate) >= todayStart && new Date(i.dueDate) <= todayEnd).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            const pendingTasks = db.items.filter(i => i.type === 'task' && !i.isComplete).sort((a,b) => a.description.localeCompare(b.description));
            const tomorrowEvents = db.items.filter(i => i.type === 'agenda' && !i.isComplete && new Date(i.dueDate) >= tomorrowStart && new Date(i.dueDate) <= tomorrowEnd).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            const renderListWithEmptyState = (containerId, emptyStateId, titleId, items) => {
                const container = gebi(containerId);
                const emptyState = gebi(emptyStateId);
                const title = gebi(titleId);
                container.innerHTML = '';
                if (items.length > 0) {
                    items.forEach(item => container.appendChild(createUniversalListItemNode(item)));
                    emptyState.style.display = 'none';
                    title.style.display = 'flex';
                } else {
                    emptyState.style.display = 'block';
                    title.style.display = 'none';
                }
            };

            renderListWithEmptyState('today-events-list', 'empty-today-events', 'today-events-title', todayEvents);
            renderListWithEmptyState('today-tasks-list', 'empty-today-tasks', 'today-tasks-title', pendingTasks);
            renderListWithEmptyState('tomorrow-events-list', 'empty-tomorrow-events', 'tomorrow-events-title', tomorrowEvents);
        }

        function renderCalendarView(state) {
            const { calendar } = state;
            const { items } = db;
            const { currentMonth, currentYear, selectedDate } = calendar;
            gebi('calendar-title-btn').textContent = `${MESES[currentMonth]} ${currentYear}`;
            const weekdaysContainer = gebi('calendarWeekdays');
            if (!weekdaysContainer.hasChildNodes()) { 
                weekdaysContainer.innerHTML = DIAS_SEMANA_CORTOS.map((day) => `<div class="weekday">${day}</div>`).join(''); 
            }
            const calendarDays = gebi('calendarDays');
            calendarDays.innerHTML = ''; 
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const offset = (firstDayOfMonth.getDay() + 6) % 7;
            const startDate = new Date(firstDayOfMonth);
            startDate.setDate(startDate.getDate() - offset);
            const todayStr = dateToYYYYMMDD(new Date());

            const dailyEventMarkers = new Map();
            items.filter(it => it.type === 'agenda' && it.dueDate).forEach(it => {
                const dateStr = dateToYYYYMMDD(new Date(it.dueDate));
                if (!dailyEventMarkers.has(dateStr)) dailyEventMarkers.set(dateStr, { hasImportant: false, hasNormal: false });
                const marker = dailyEventMarkers.get(dateStr);
                if (it.isImportant) marker.hasImportant = true;
                else marker.hasNormal = true;
            });

            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate); cellDate.setDate(startDate.getDate() + i);
                const dateStr = dateToYYYYMMDD(cellDate); 
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day'; 
                dayEl.dataset.date = dateStr;
                if (cellDate.getMonth() !== currentMonth) dayEl.classList.add('other-month');
                if (dateStr === todayStr) dayEl.classList.add('today');
                if (dateStr === selectedDate) dayEl.classList.add('selected');
                let dotsHtml = '';
                if (dailyEventMarkers.has(dateStr)) {
                    const markers = dailyEventMarkers.get(dateStr);
                    dotsHtml = `<div class="event-dots-container">${markers.hasImportant ? '<span class="event-dot important"></span>' : ''}${markers.hasNormal ? '<span class="event-dot normal"></span>' : ''}</div>`;
                }
                dayEl.innerHTML = `<span class="day-number">${cellDate.getDate()}</span>${dotsHtml}`;
                if (cellDate.getMonth() === currentMonth) dayEl.onclick = () => selectDate(dateStr);
                calendarDays.appendChild(dayEl);
            }
            renderAgendaFromSelectedDay(items, selectedDate);
        }
        
        function renderAgendaFromSelectedDay(items, selectedDateStr) {
            const agendaList = gebi('agendaList');
            agendaList.innerHTML = '';
            if (!selectedDateStr) return;
            const selectedDate = yyyymmddToDate(selectedDateStr);
            selectedDate.setHours(0, 0, 0, 0);
            const itemsForDayAndBeyond = items.filter(item => item.type === 'agenda' && !item.isComplete && item.dueDate && new Date(item.dueDate) >= selectedDate).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            if (itemsForDayAndBeyond.length === 0) {
                agendaList.innerHTML = `<div class="empty-state" style="padding-top: 24px;"><span class="material-icons">event_available</span><div>Nada programado a partir de este día.</div></div>`;
                return;
            }

            let lastHeaderDate = null;
            itemsForDayAndBeyond.forEach(item => {
                const itemDate = new Date(item.dueDate);
                const itemDateStr = dateToYYYYMMDD(itemDate);
                if (itemDateStr !== lastHeaderDate) {
                    const header = document.createElement('div');
                    header.className = 'agenda-date-header';
                    header.textContent = itemDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                    agendaList.appendChild(header);
                    lastHeaderDate = itemDateStr; 
                }
                agendaList.appendChild(createUniversalListItemNode(item));
            });
        }

        function renderTaskListView() {
            const filter = gebi('task-list-filter');
            filter.innerHTML = db.taskLists.map(list => `<option value="${list.id}">${list.name}</option>`).join('');
            filter.value = appState.tasks.selectedListId;

            const tasksContainer = gebi('tasks-content');
            tasksContainer.innerHTML = '';
            
            const pendingTasks = db.items.filter(i => i.type === 'task' && !i.isComplete && (i.listId || 'default') === appState.tasks.selectedListId).sort((a,b) => a.createdAt - b.createdAt);
            const completedTasks = db.items.filter(i => i.type === 'task' && i.isComplete && (i.listId || 'default') === appState.tasks.selectedListId).sort((a,b) => (b.completedAt || 0) - (a.completedAt || 0));

            if (pendingTasks.length > 0) {
                const title = document.createElement('h3');
                title.className = 'section-title';
                title.textContent = 'Tareas Pendientes';
                tasksContainer.appendChild(title);
                pendingTasks.forEach(item => tasksContainer.appendChild(createTaskItemNode(item)));
            }
            
            if (completedTasks.length > 0) {
                const title = document.createElement('h3');
                title.className = 'section-title';
                title.textContent = 'Tareas Completadas';
                tasksContainer.appendChild(title);
                completedTasks.slice(0, 20).forEach(item => tasksContainer.appendChild(createTaskItemNode(item)));
            }

            const isAllEmpty = pendingTasks.length === 0 && completedTasks.length === 0;
            gebi('emptyTasks').style.display = isAllEmpty ? 'block' : 'none';
        }
        
        function renderSearchView(query) {
            const resultsList = gebi('searchResultsList');
            resultsList.innerHTML = '';
            const emptyState = gebi('emptySearch');
            const lowerCaseQuery = query.toLowerCase();
            const results = db.items.filter(item => item.description.toLowerCase().includes(lowerCaseQuery));
            if (results.length > 0) {
                emptyState.style.display = 'none';
                results.sort((a,b) => (a.createdAt < b.createdAt) ? 1 : -1)
                       .forEach(item => resultsList.appendChild(createUniversalListItemNode(item)));
            } else {
                emptyState.style.display = 'block';
            }
        }

        function createUniversalListItemNode(item) {
            return item.type === 'task' ? createTaskItemNode(item) : createEventItemNode(item);
        }

        function createEventItemNode(item) {
            const itemEl = document.createElement('div');
            itemEl.className = `list-item-swipe-container type-agenda ${item.isComplete ? 'completed' : ''}`;
            itemEl.dataset.id = item.localId;
            const itemColor = item.isImportant ? 'var(--accent-event-important)' : 'var(--accent-event-normal)';
            itemEl.style.borderLeftColor = itemColor;
            const time = dateToHHMM(new Date(item.dueDate));
            itemEl.innerHTML = `<div class="item-card-swipe-background"><span class="material-icons">edit</span><span class="material-icons">delete</span></div><div class="event-item-content" data-action="edit"><span class="event-time">${time}</span><div class="event-title">${item.description}</div>${item.recurrenceRule !== 'none' ? '<span class="material-icons event-meta-icon">repeat</span>' : ''}</div>`;
            itemEl.querySelector('[data-action="edit"]').onclick = () => openAddItemModal(item);
            attachSwipeListeners(itemEl);
            return itemEl;
        }

        function createTaskItemNode(item) {
            const itemEl = document.createElement('div');
            itemEl.dataset.id = item.localId;
            itemEl.className = `list-item-swipe-container type-task ${item.isComplete ? 'completed' : ''}`;
            itemEl.style.borderLeftColor = 'var(--accent-task)';
            let subtaskHtml = '';
            if (item.subtasks && item.subtasks.length > 0) {
                const completedCount = item.subtasks.filter(st => st.isComplete).length;
                subtaskHtml = `<div class="subtask-progress">${completedCount} de ${item.subtasks.length} completadas</div>`;
            }
            itemEl.innerHTML = `<div class="item-card-swipe-background"><span class="material-icons">check_circle</span><span class="material-icons">delete</span></div><div class="item-checkbox ${item.isComplete ? 'checked' : ''}" data-action="complete">${item.isComplete ? '<span class="material-icons">check</span>' : ''}</div><div class="item-content" data-action="edit"><div class="item-title">${item.description}</div>${subtaskHtml}</div>`;
            itemEl.querySelector('[data-action="edit"]').onclick = () => openAddItemModal(item);
            itemEl.querySelector('[data-action="complete"]').onclick = (e) => { e.stopPropagation(); handleItemComplete(item.localId, !item.isComplete); };
            attachSwipeListeners(itemEl);
            return itemEl;
        }
        
        // =================================================================================
        // 5. MANEJADORES DE EVENTOS
        // =================================================================================
        function attachGlobalEventListeners() {
            const safeAddListener = (id, event, handler) => { const el = gebi(id); if (el) el.addEventListener(event, handler); };
            
            document.body.addEventListener('click', e => {
                const actionTarget = e.target.closest('[data-action]');
                if (!actionTarget) return;
                const action = actionTarget.dataset.action;
                if (action === 'login') handleLogin();
                if (action === 'register') handleRegister();
                if (action === 'logout' && confirm("¿Seguro que quieres cerrar sesión?")) { fbAuth.signOut(); }
            });
            qsa('.nav-item[data-view]').forEach(item => item.addEventListener('click', () => switchView(item.dataset.view)));
            safeAddListener('nav-theme-btn', 'click', handleThemeToggle);
            safeAddListener('prev-nav-btn', 'click', () => changeMonth(-1));
            safeAddListener('next-nav-btn', 'click', () => changeMonth(1));
            safeAddListener('today-btn', 'click', goToToday);
            safeAddListener('calendar-title-btn', 'click', openDatePickerModal);
            
            // --- MODIFICADO: El listener apunta al nuevo FAB ---
            safeAddListener('fab-add-item', 'click', () => openModal('quick-add-modal'));
            
            safeAddListener('quick-add-form', 'submit', handleQuickAddSubmit);
            safeAddListener('cancel-quick-add-btn', 'click', () => closeModal('quick-add-modal'));
            safeAddListener('open-advanced-editor-btn', 'click', openAdvancedFromQuickAdd);
            safeAddListener('add-item-form', 'submit', handleItemFormSubmit);
            safeAddListener('cancel-item-btn', 'click', () => closeModal('add-item-modal'));
            safeAddListener('item-type', 'change', toggleModalOptionsVisibility);
            safeAddListener('item-notification-enabled', 'change', toggleModalOptionsVisibility);
            safeAddListener('delete-item-btn', 'click', handleDeleteFromModal);
            safeAddListener('date-picker-form', 'submit', handleDateSelectionFromPicker);
            safeAddListener('cancel-date-picker-btn', 'click', () => closeModal('date-picker-modal'));
            safeAddListener('search-toggle-btn', 'click', toggleSearchBar);
            safeAddListener('search-form', 'submit', handleSearchSubmit);
            safeAddListener('task-list-filter', 'change', handleTaskListFilterChange);
            safeAddListener('manage-lists-btn', 'click', openManageListsModal);
            safeAddListener('close-manage-lists-btn', 'click', () => closeModal('manage-lists-modal'));
            safeAddListener('add-list-form', 'submit', handleAddTaskList);
            safeAddListener('add-subtask-btn', 'click', handleAddSubtask);
            safeAddListener('new-subtask-input', 'keydown', e => { if (e.key === 'Enter') { e.preventDefault(); handleAddSubtask(); } });
            window.addEventListener('online', updateSyncStatus);
            window.addEventListener('offline', updateSyncStatus);
        }

        // =================================================================================
        // 6. LÓGICA PRINCIPAL (CRUD Y ACCIONES)
        // =================================================================================
        function switchView(view) { 
            if (!view) return; 
            if (appState.currentView !== 'search') appState.lastView = appState.currentView;
            appState.currentView = view; 
            renderApp(); 
        }
        function selectDate(dateStr) { appState.calendar.selectedDate = dateStr; renderApp(); }
        function changeMonth(delta) { const d = new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 1); d.setMonth(d.getMonth() + delta); appState.calendar.currentMonth = d.getMonth(); appState.calendar.currentYear = d.getFullYear(); renderApp(); }
        function goToToday() { const today = new Date(); appState.calendar = { ...appState.calendar, currentMonth: today.getMonth(), currentYear: today.getFullYear(), selectedDate: dateToYYYYMMDD(today) }; switchView('calendar'); }
        function openModal(modalId) { 
            gebi(modalId)?.classList.add('active'); 
            if (modalId === 'quick-add-modal') {
                const input = gebi('quick-add-input');
                input.value = '';
                setTimeout(() => input.focus(), 100);
            }
        }
        function closeModal(modalId) { gebi(modalId)?.classList.remove('active'); }

        function openAddItemModal(itemToEdit = null) {
            const form = gebi('add-item-form');
            form.reset();
            closeModal('quick-add-modal');
            gebi('delete-item-btn').style.display = itemToEdit ? 'block' : 'none';
            
            const localId = itemToEdit?.localId || uuid();
            gebi('item-local-id').value = localId;

            const itemData = itemToEdit || parseNaturalLanguage(gebi('quick-add-input').value);

            const defaultType = appState.currentView === 'tasks' ? 'task' : 'agenda';
            gebi('item-type').value = itemData?.type || defaultType;
            gebi('item-description').value = itemData?.description || '';

            const taskListSelect = gebi('item-task-list');
            taskListSelect.innerHTML = db.taskLists.map(list => `<option value="${list.id}">${list.name}</option>`).join('');
            taskListSelect.value = itemData?.listId || appState.tasks.selectedListId;

            renderSubtasks(itemData?.subtasks || [], localId);

            const dateToShow = itemData?.dueDate ? new Date(itemData.dueDate) : yyyymmddToDate(appState.calendar.selectedDate);
            flatpickrInstance.setDate(dateToShow, false);
            
            gebi('item-important').checked = itemData?.isImportant || false;
            gebi('item-notification-enabled').checked = itemData?.notificationEnabled || false;
            gebi('item-recurrence').value = itemData?.recurrenceRule || 'none';
            gebi('item-reminder').value = itemData?.reminderMinutes || '0';
            
            toggleModalOptionsVisibility(); 
            openModal('add-item-modal');
            gebi('item-description').focus();
        }

        function toggleModalOptionsVisibility() { 
            const isAgenda = gebi('item-type').value === 'agenda';
            const isNotificationEnabled = gebi('item-notification-enabled').checked;
            gebi('datetime-notification-group').style.display = isAgenda ? 'block' : 'none';
            gebi('task-options-group').style.display = isAgenda ? 'none' : 'block';
            gebi('reminder-time-group').style.display = (isAgenda && isNotificationEnabled) ? 'block' : 'none';
        }

        function handleItemFormSubmit(e) {
            e.preventDefault();
            const localId = gebi('item-local-id').value;
            const existingItem = db.items.find(i => i.localId === localId);
            
            const subtasks = Array.from(qsa('#subtasks-container .subtask-item')).map(el => ({
                id: el.dataset.id,
                description: el.querySelector('input[type="text"]').value,
                isComplete: el.querySelector('input[type="checkbox"]').checked
            }));

            const itemData = {
                localId,
                type: gebi('item-type').value,
                description: gebi('item-description').value.trim(),
                isComplete: existingItem?.isComplete || false,
                createdAt: existingItem?.createdAt || Date.now(),
                isImportant: gebi('item-type').value === 'agenda' ? gebi('item-important').checked : false,
                notificationEnabled: gebi('item-type').value === 'agenda' ? gebi('item-notification-enabled').checked : false,
                reminderMinutes: gebi('item-type').value === 'agenda' && gebi('item-notification-enabled').checked ? gebi('item-reminder').value : '0',
                notificationShown: (existingItem && existingItem.dueDate === flatpickrInstance.selectedDates[0]?.toISOString()) ? existingItem.notificationShown : false,
                recurrenceRule: gebi('item-type').value === 'agenda' ? gebi('item-recurrence').value : 'none',
                dueDate: gebi('item-type').value === 'agenda' ? flatpickrInstance.selectedDates[0]?.toISOString() : null,
                listId: gebi('item-type').value === 'task' ? gebi('item-task-list').value : null,
                subtasks: gebi('item-type').value === 'task' ? subtasks : []
            };
            if (itemData.notificationEnabled) requestNotificationPermission();
            handleItemSave(itemData);
            closeModal('add-item-modal');
        }

        function handleItemSave(itemData) {
            if (!itemData.description) {
                showToast("La descripción no puede estar vacía.");
                return;
            }
            const index = db.items.findIndex(i => i.localId === itemData.localId);
            if (index > -1) db.items[index] = { ...db.items[index], ...itemData };
            else db.items.unshift(itemData);
            saveData(() => {
                scheduleAllNotifications();
                renderApp();
            });
        }

        function handleItemComplete(localId, isComplete) {
            const item = db.items.find(i => i.localId === localId);
            if (!item) return;
            const index = db.items.findIndex(i => i.localId === localId);
            if (index > -1) {
                db.items[index] = { ...item, isComplete, completedAt: isComplete ? Date.now() : null };
            }
            saveData(() => { scheduleAllNotifications(); renderApp(); });
        }
        
        function handleDeleteFromModal() { 
            const localId = gebi('item-local-id').value;
            const item = db.items.find(i => i.localId === localId);
            if (item && confirm(`¿Eliminar este ítem permanentemente: "${item.description}"?`)) { 
                db.items = db.items.filter(i => i.localId !== localId);
                saveData(() => {
                    scheduleAllNotifications();
                    closeModal('add-item-modal');
                    renderApp();
                });
            } 
        }

        // =================================================================================
        // 7. LÓGICA DE NUEVAS FUNCIONES (NLP, TAREAS)
        // =================================================================================
        function handleQuickAddSubmit(e) {
            e.preventDefault();
            const input = gebi('quick-add-input').value.trim();
            if (!input) return;
            const parsedData = parseNaturalLanguage(input);
            handleItemSave({
                ...parsedData,
                localId: uuid(),
                isComplete: false,
                createdAt: Date.now(),
                listId: parsedData.type === 'task' ? appState.tasks.selectedListId : null,
            });
            closeModal('quick-add-modal');
        }

        function openAdvancedFromQuickAdd() {
            const itemToEdit = parseNaturalLanguage(gebi('quick-add-input').value);
            openAddItemModal(itemToEdit);
        }
        
        function parseNaturalLanguage(text) {
            let cleanText = text.toLowerCase();
            let date = new Date();
            let dateFound = false;

            const timeRegex = /(?:a las|a la|)\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm|de la mañana|de la tarde|de la noche)?/i;
            const timeMatch = cleanText.match(timeRegex);
            if (timeMatch) {
                let hour = parseInt(timeMatch[1], 10);
                const minute = parseInt(timeMatch[2], 10) || 0;
                const period = timeMatch[3] ? timeMatch[3].toLowerCase() : '';
                if ((period.includes('pm') || period.includes('tarde') || period.includes('noche')) && hour < 12) {
                    hour += 12;
                }
                if ((period.includes('am') || period.includes('mañana')) && hour === 12) {
                    hour = 0;
                }
                date.setHours(hour, minute, 0, 0);
                cleanText = cleanText.replace(timeMatch[0], '').trim();
                dateFound = true;
            }

            const dateRegex = /(\d{1,2})(?:\s+de\s+|\s*\/\s*)(\w+)/i;
            const dateMatch = dateRegex.exec(cleanText);
            if (dateMatch) {
                const day = parseInt(dateMatch[1], 10);
                const monthStr = dateMatch[2].toLowerCase();
                const monthIndex = MESES.findIndex(m => m.toLowerCase().startsWith(monthStr));
                if (monthIndex > -1) {
                    date.setMonth(monthIndex, day);
                    dateFound = true;
                    cleanText = cleanText.replace(dateMatch[0], '').trim();
                }
            } else if (/\bhoy\b/i.test(cleanText)) {
                dateFound = true;
                cleanText = cleanText.replace(/\bhoy\b/i, '').trim();
            } else if (/\bmañana\b/i.test(cleanText)) {
                date.setDate(date.getDate() + 1);
                dateFound = true;
                cleanText = cleanText.replace(/\bmañana\b/i, '').trim();
            } else {
                for (let i = 0; i < DIAS_SEMANA_LARGOS.length; i++) {
                    const dayName = DIAS_SEMANA_LARGOS[i];
                    if (cleanText.includes(dayName)) {
                        const currentDay = new Date().getDay();
                        let dayDiff = i - currentDay;
                        if (dayDiff <= 0) dayDiff += 7; // Siempre futuro
                        date.setDate(date.getDate() + dayDiff);
                        dateFound = true;
                        cleanText = cleanText.replace(new RegExp(`\\b(el\\s+)?${dayName}\\b`, 'i'), '').trim();
                        break;
                    }
                }
            }

            const description = cleanText.charAt(0).toUpperCase() + cleanText.slice(1);
            
            return {
                type: dateFound ? 'agenda' : 'task',
                description: description.replace(/,$/, '').trim(),
                dueDate: dateFound ? date.toISOString() : null,
            };
        }

        function handleTaskListFilterChange(e) {
            appState.tasks.selectedListId = e.target.value;
            renderTaskListView();
        }

        function openManageListsModal() {
            const editor = gebi('task-lists-editor');
            editor.innerHTML = '';
            db.taskLists.forEach(list => {
                const el = document.createElement('div');
                el.style.display = 'flex'; el.style.alignItems = 'center'; el.style.gap = '8px'; el.style.marginBottom = '8px';
                const input = document.createElement('input');
                input.type = 'text'; input.value = list.name; input.className = 'form-input';
                input.onchange = () => handleRenameTaskList(list.id, input.value);
                if(list.id === 'default') input.disabled = true;
                el.appendChild(input);

                if (list.id !== 'default') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'icon-button';
                    deleteBtn.innerHTML = '<span class="material-icons">delete</span>';
                    deleteBtn.onclick = () => handleDeleteTaskList(list.id);
                    el.appendChild(deleteBtn);
                }
                editor.appendChild(el);
            });
            openModal('manage-lists-modal');
        }

        function handleAddTaskList(e) {
            e.preventDefault();
            const input = gebi('new-list-name');
            const name = input.value.trim();
            if (name) {
                const newList = { id: uuid(), name };
                db.taskLists.push(newList);
                saveData(() => {
                    input.value = '';
                    openManageListsModal(); 
                    renderTaskListView();
                });
            }
        }

        function handleRenameTaskList(id, newName) {
            const list = db.taskLists.find(l => l.id === id);
            if (list && newName) {
                list.name = newName;
                saveData(() => {
                    openManageListsModal();
                    renderTaskListView();
                });
            }
        }

        function handleDeleteTaskList(id) {
            const listName = db.taskLists.find(l => l.id === id)?.name;
            if (confirm(`¿Seguro que quieres eliminar la lista "${listName}" y TODAS sus tareas? Esta acción es irreversible.`)) {
                db.taskLists = db.taskLists.filter(l => l.id !== id);
                db.items = db.items.filter(i => i.listId !== id);
                saveData(() => {
                    if (appState.tasks.selectedListId === id) {
                        appState.tasks.selectedListId = 'default';
                    }
                    openManageListsModal();
                    renderTaskListView();
                });
            }
        }

        function renderSubtasks(subtasks, parentId) {
            const container = gebi('subtasks-container');
            container.innerHTML = '';
            subtasks.forEach(subtask => {
                const el = document.createElement('div');
                el.className = 'subtask-item';
                el.dataset.id = subtask.id;
                el.innerHTML = `
                    <input type="checkbox" ${subtask.isComplete ? 'checked' : ''}>
                    <input type="text" value="${subtask.description}">
                    <button type="button" class="icon-button delete-subtask-btn"><span class="material-icons">close</span></button>
                `;
                el.querySelector('.delete-subtask-btn').onclick = () => {
                    el.remove();
                };
                container.appendChild(el);
            });
        }

        function handleAddSubtask() {
            const input = gebi('new-subtask-input');
            const description = input.value.trim();
            if (description) {
                const container = gebi('subtasks-container');
                const el = document.createElement('div');
                el.className = 'subtask-item';
                el.dataset.id = uuid();
                el.innerHTML = `
                    <input type="checkbox">
                    <input type="text" value="${description}">
                    <button type="button" class="icon-button delete-subtask-btn"><span class="material-icons">close</span></button>
                `;
                el.querySelector('.delete-subtask-btn').onclick = () => { el.remove(); };
                container.appendChild(el);
                input.value = '';
                input.focus();
            }
        }

        // =================================================================================
        // 8. UTILIDADES Y AYUDANTES
        // =================================================================================
        function initializeDatePicker() { 
            flatpickr.localize(flatpickr.l10ns.es); 
            flatpickrInstance = flatpickr("#item-datetime", { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true, minuteIncrement: 15 }); 
        }
        
        function applyTheme(theme) { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); }
        function handleThemeToggle() { const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; db.config.theme = newTheme; applyTheme(newTheme); saveData(); }

        function openDatePickerModal() { 
            openModal('date-picker-modal'); 
            const monthSelect = gebi('month-select'); 
            monthSelect.innerHTML = MESES.map((mes, i) => `<option value="${i}">${mes}</option>`).join(''); 
            monthSelect.value = appState.calendar.currentMonth; 
            gebi('year-select').value = appState.calendar.currentYear; 
        }

        function handleDateSelectionFromPicker(e) { 
            e.preventDefault(); 
            appState.calendar.currentMonth = parseInt(gebi('month-select').value, 10); 
            appState.calendar.currentYear = parseInt(gebi('year-select').value, 10);
            appState.calendar.selectedDate = dateToYYYYMMDD(new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 1));
            switchView('calendar');
            closeModal('date-picker-modal'); 
        }
        
        function toggleSearchBar() {
            const searchContainer = gebi('search-container');
            const isActive = searchContainer.classList.toggle('active');
            if (isActive) {
                gebi('search-input').focus();
                if (appState.currentView !== 'search') {
                    appState.lastView = appState.currentView;
                }
            } else {
                gebi('search-input').value = '';
                executeSearch('');
            }
        }

        function handleSearchSubmit(event) {
            event.preventDefault();
            const query = gebi('search-input').value;
            executeSearch(query);
        }
        
        function executeSearch(query) {
             if (query.trim() !== '') {
                switchView('search');
                renderSearchView(query);
            } else {
                if (appState.currentView === 'search') {
                    switchView(appState.lastView || 'today');
                }
            }
        }

        function attachSwipeListeners(cardEl) {
            if (!cardEl || cardEl.dataset.hammer) return;
            cardEl.dataset.hammer = 'true';
            const mc = new Hammer.Manager(cardEl);
            mc.add(new Hammer.Pan({ threshold: 10, pointers: 1 }));
            
            mc.on('panstart', () => {
                cardEl.style.transition = 'none';
            });

            mc.on('pan', e => {
                cardEl.style.transform = `translateX(${e.deltaX}px)`;
                if (e.deltaX > 20) cardEl.classList.add('swiping-right'); 
                else if (e.deltaX < -20) cardEl.classList.add('swiping-left'); 
                else cardEl.classList.remove('swiping-right', 'swiping-left');
            });
            
            mc.on('panend', e => {
                cardEl.style.transition = 'transform 0.3s, opacity 0.3s';
                const threshold = cardEl.offsetWidth * 0.35;
                const id = cardEl.dataset.id;
                const item = db.items.find(i => i.localId === id);
                if (!item) return;
                
                if (e.deltaX > threshold) {
                    if (item.type === 'task') handleItemComplete(id, !item.isComplete); 
                    else openAddItemModal(item);
                    cardEl.style.transform = 'translateX(0)';
                } else if (e.deltaX < -threshold) {
                    if (confirm(`¿Eliminar "${item.description}"?`)) {
                        db.items = db.items.filter(i => i.localId !== id);
                        saveData(() => { scheduleAllNotifications(); renderApp(); });
                    } else {
                        cardEl.style.transform = 'translateX(0)';
                    }
                } else {
                    cardEl.style.transform = 'translateX(0)';
                }
                
                setTimeout(() => {
                    cardEl.classList.remove('swiping-right', 'swiping-left');
                    cardEl.style.transition = 'all 0.3s var(--ease-out-quint)';
                }, 300);
            });
        }

        function updateSyncStatus() {
            const indicator = gebi('sync-status-indicator'); if (!indicator) return;
            const icon = indicator.querySelector('.material-icons') || document.createElement('span');
            icon.classList.add('material-icons');
            const isOnline = navigator.onLine;
            if (isOnline) { indicator.className = 'online'; icon.textContent = 'cloud_done'; indicator.title = "Conectado y sincronizado."; } 
            else { indicator.className = 'offline'; icon.textContent = 'cloud_off'; indicator.title = "Sin conexión. Los cambios se guardarán localmente."; }
            if (!indicator.hasChildNodes()) indicator.appendChild(icon);
        }

        // =================================================================================
        // 9. NOTIFICACIONES
        // =================================================================================
        async function requestNotificationPermission() {
            if (!("Notification" in window)) { showToast("Este navegador no soporta notificaciones."); return 'denied'; }
            const permission = await Notification.requestPermission();
            if (permission === 'granted') { showToast("¡Permiso de notificaciones concedido!"); } 
            else { showToast("Permiso de notificaciones denegado."); }
            return permission;
        }

        function showNotification(item) {
            if (Notification.permission !== "granted") return;
            const notificationBody = `Tu evento "${item.description}" es ahora.`;
            const notificationOptions = { body: notificationBody, icon: './aiDANaI.webp', badge: './aiDANaI.webp' };
            new Notification('Recordatorio de Agenda', notificationOptions);
            const index = db.items.findIndex(i => i.localId === item.localId);
            if (index > -1) { db.items[index].notificationShown = true; saveData(); }
        }

        function scheduleNotification(item) {
            if (activeTimers[item.localId]) clearTimeout(activeTimers[item.localId]);
            if (!item.notificationEnabled || item.isComplete || !item.dueDate || item.notificationShown) return;
            const reminderOffsetMs = (parseInt(item.reminderMinutes, 10) || 0) * 60 * 1000;
            const msUntilDue = new Date(item.dueDate).getTime() - reminderOffsetMs - Date.now();
            if (msUntilDue > 0) activeTimers[item.localId] = setTimeout(() => { showNotification(item); }, msUntilDue);
        }

        function scheduleAllNotifications() {
            if (!db.items) return;
            Object.values(activeTimers).forEach(clearTimeout);
            activeTimers = {};
            db.items.forEach(scheduleNotification);
        }
    })();
    </script>
</body>
</html>