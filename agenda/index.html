<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Agenda aiDANaI</title>

    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1C1B1F">
    <link rel="apple-touch-icon" href="aiDANaI-Agenda.jpg">

    <style>
        /* --- ESTILOS DE 'agenda.html' MEJORADOS Y ADAPTADOS --- */
        :root {
            /* --- Paleta de colores refinada y derivada del logo --- */
            --primary-color: #6A5ACD; /* Un morado ligeramente más suave */
            --primary-variant: #483D8B;
            --secondary-color: #8A8A9E; /* Un gris con tono lavanda */
            --background: #FDFBFF; /* Un blanco casi puro, pero no del todo */
            --surface: #FFFFFF;
            --surface-variant: #F4F3F8; /* Un gris muy claro con tono morado */
            --on-primary: #FFFFFF;
            --on-background: #1B1B1F; /* Un negro no tan absoluto */
            --on-surface: #1B1B1F;
            --outline: #DCD9E0; /* Borde más suave */
            --shadow: rgba(27, 27, 31, 0.08); /* Sombra base más sutil */
            
            --accent-dani: #5B92E5; /* Azul extraído del cielo del logo */
            --accent-norma: #E57373; /* Rojo un poco menos saturado */
            --accent-comun: #81C784; /* Verde más suave */
            --accent-delete: #EF5350;
            --accent-complete: #66BB6A;

            --current-user-accent: var(--accent-dani);
            --font-roboto: 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        [data-theme="dark"] {
            /* Paleta oscura armonizada con los nuevos colores */
            --primary-color: #BEAEEF;
            --secondary-color: #B8B8C6;
            --background: #1C1B1F;
            --surface: #2A2931;
            --surface-variant: #47464F;
            --on-primary: #3A2D7B;
            --on-background: #E5E3E9;
            --on-surface: #E5E3E9;
            --outline: #605E67;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; }
        body { font-family: var(--font-roboto); background-color: var(--background); color: var(--on-background); line-height: 1.5; overflow: hidden; min-height: 100vh; min-height: -webkit-fill-available; height: 100vh; transition: background-color 0.3s, color 0.3s; }
        *:focus-visible { outline: 2px solid var(--current-user-accent); outline-offset: 2px; border-radius: 4px; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        /* --- PANTALLAS INICIALES --- */
        .intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background-color: #000;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),
                radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);
            background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;
            background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;
            animation: move-stars 120s linear infinite;
            transition: opacity 0.5s ease-out;
        }

        .intro-screen.visible { display: flex; }

        #welcomeScreen #welcomeImage { 
            width: 250px; 
            height: auto; 
            opacity: 0; 
            animation: growAndFade 2.5s ease-in-out forwards; 
        }

        @keyframes growAndFade { 
            0% { transform: scale(0.5); opacity: 0; } 
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(8); opacity: 0; } 
        }

        @keyframes move-stars {
            from { background-position: 0 0, 40px 60px, 130px 270px, 70px 100px; }
            to { background-position: -10000px 5000px, -10000px 5000px, -10000px 5000px, -10000px 5000px; }
        }

        #quoteScreen { text-align: center; color: #FFF; padding: 20px; opacity: 0; transition: opacity 1.5s; }
        #quoteScreen.visible { opacity: 1; }
        #quoteText { font-size: 22px; font-style: italic; font-weight: 300; max-width: 600px; }
        #quoteAuthor { display: block; font-size: 16px; margin-top: 12px; font-weight: 500; }
        
        /* --- ESTRUCTURA PRINCIPAL --- */
        #app-root { display: none; max-width: 420px; margin: 0 auto; height: 100vh; background: var(--background); position: relative; flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; padding-bottom: calc(65px + env(safe-area-inset-bottom)); }
        #app-root.visible { display: flex; opacity: 1; }
        .main-content { flex: 1; display: flex; position: relative; overflow: hidden; }
        .view { display: none; width: 100%; flex-direction: column; animation: fadeIn 0.3s ease-in-out; height: 100%; overflow: hidden; }
        #tasksView, #helpView, #searchView, #calendarView { overflow-y: auto; padding: 16px; padding-bottom: 80px; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- VISTA CALENDARIO/AGENDA UNIFICADA --- */
        #calendarView { padding: 0; } /* Reset padding for internal scrolling */
        .calendar-container { flex-shrink: 0; padding: 12px; border-bottom: 1px solid var(--outline); }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; position: relative; }
        #calendar-title-btn { font-size: 18px; font-weight: 500; background: none; border: none; color: var(--on-background); padding: 4px 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #calendar-title-btn:hover { background-color: var(--surface-variant); }
        .calendar-nav { display: flex; align-items: center; gap: 0; }
        .icon-button { background: none; border: none; color: var(--secondary-color); cursor: pointer; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s; }
        .icon-button:hover { background-color: var(--surface-variant); color: var(--on-surface); }
        .calendar-grid { background: var(--surface); border-radius: 16px; padding: 8px; box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.05), 0px 2px 8px rgba(0, 0, 0, 0.06); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
        .weekday { text-align: center; font-size: 11px; font-weight: 500; color: var(--secondary-color); padding: 2px; }
        .weekday.saturday { color: var(--accent-dani); } .weekday.sunday { color: var(--accent-norma); }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; position: relative; font-size: 13px; transition: all 0.2s; }
        .calendar-day:hover { background: var(--surface-variant); }
        .calendar-day.today .day-number { background: var(--primary-color); color: var(--on-primary); font-weight: 700; }
        .calendar-day.selected .day-number { background: var(--primary-variant); color: var(--on-primary); }
        .calendar-day.other-month { color: var(--outline); pointer-events: none; }
        .day-number { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .calendar-day .event-dots-container { position: absolute; bottom: 3px; left: 0; right: 0; display: flex; justify-content: center; gap: 2px; }
        .calendar-day .event-dot { width: 4px; height: 4px; border-radius: 50%; }

        .agenda-list-container { flex-grow: 1; overflow-y: auto; padding: 8px 12px 80px 12px; }
        .agenda-date-header { font-weight: 500; color: var(--primary-color); padding: 4px 16px; background-color: var(--surface-variant); position: sticky; top: 0; z-index: 1; }
        .agenda-item-compact { user-select: none; position: relative; }
        .agenda-item-content { display: flex; align-items: center; gap: 8px; padding: 6px 16px; font-size: 14px; cursor: pointer; transition: background-color 0.2s; background-color: var(--surface); border-bottom: 1px solid var(--surface-variant); }
        .agenda-item-content:hover { background-color: var(--surface-variant); }
        .agenda-item-compact.completed .agenda-item-content { opacity: 0.6; }
        .agenda-item-compact.completed .title { text-decoration: line-through; }
        .agenda-item-content .indicator { width: 4px; height: 18px; border-radius: 2px; flex-shrink: 0; }
        .agenda-item-content .time { font-weight: 500; min-width: 50px; }
        .agenda-item-content .title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- VISTA BÚSQUEDA (CSS CORREGIDO) --- */
        #search-container {
            width: 100%;
            margin-bottom: 16px;
        }
        #search-input { 
            width: 100%; 
            border: none; 
            background: var(--surface-variant); 
            color: var(--on-surface); 
            padding: 10px 14px; 
            border-radius: 12px; 
            font-size: 14px; 
        }
        #search-input:focus { outline: none; box-shadow: 0 0 0 2px var(--primary-color); }

        /* --- VISTA TAREAS Y AYUDA --- */
        .task-filters { display: flex; gap: 12px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px; flex-wrap: wrap; justify-content: center; }
        .filter-group { display: flex; align-items: center; gap: 8px; background: var(--surface-variant); padding: 6px 14px; border-radius: 20px; }
        .filter-group label { font-size: 14px; cursor: pointer; font-weight: 500; }
        .filter-group input { accent-color: var(--primary-color); cursor: pointer; }
        
        .list-item-swipe-container { display: flex; align-items: center; background: var(--surface); border-radius: 16px; margin-bottom: 8px; box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.06), 0px 4px 8px rgba(0, 0, 0, 0.08); transition: all 0.2s ease-out; user-select: none; position: relative; }
        .list-item-swipe-container .item-content { flex: 1; cursor: pointer; }
        .item-card-swipe-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 16px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: white; opacity: 0; transition: opacity 0.2s; z-index: -1; }
        .item-card-swipe-background .material-icons { font-size: 28px; }
        .list-item-swipe-container.swiping-right .item-card-swipe-background { background-color: var(--accent-complete); justify-content: flex-start; opacity: 1; }
        .list-item-swipe-container.swiping-left .item-card-swipe-background { background-color: var(--accent-delete); justify-content: flex-end; opacity: 1; }
        .list-item-swipe-container.item-card { padding: 12px 16px; border-left: 5px solid transparent; } /* Renombrado de task-item a item-card */

        .list-item-swipe-container.completed { opacity: 0.6; }
        .item-checkbox { width: 20px; height: 20px; border: 2px solid var(--outline); border-radius: 50%; margin-right: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; } /* Renombrado de task-checkbox a item-checkbox */
        .item-checkbox.checked { background: var(--accent-complete); border-color: var(--accent-complete); color: white; }
        .item-title { font-weight: 500; }
        .item-title.completed { text-decoration: line-through; }
        .item-meta { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--secondary-color); }
        .item-actions button { color: var(--secondary-color); }

        .settings-section { background: var(--surface); border-radius: 20px; padding: 16px; margin-bottom: 16px; box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.06), 0px 4px 8px rgba(0, 0, 0, 0.08); }
        .section-title { font-size: 18px; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; letter-spacing: 0.2px; }
        .help-section details { margin-bottom: 8px; border: 1px solid var(--surface-variant); border-radius: 12px; }
        .help-section summary { font-weight: 500; cursor: pointer; padding: 12px; display: flex; align-items: center; justify-content: space-between; list-style: none; /* Hide default arrow */ }
        .help-section summary::-webkit-details-marker { display: none; } /* Hide default arrow for Chrome/Safari */
        .help-section summary .material-icons { transition: transform 0.2s; }
        .help-section details[open] summary .material-icons { transform: rotate(180deg); }
        .help-section .details-content { padding: 0 16px 16px 16px; font-size: 15px; line-height: 1.6; border-top: 1px solid var(--surface-variant); margin: 8px 0 0 0; }
        .details-content p, .details-content li { margin-bottom: 12px; color: var(--secondary-color); } 
        .details-content ul { padding-left: 20px; list-style-type: none; }
        .details-content li { position: relative; padding-left: 25px; }
        .details-content li::before { content: 'sparkle'; font-family: 'Material Icons'; font-size: 18px; color: var(--primary-color); position: absolute; left: 0; top: 2px; }
        .details-content .material-icons { font-size: 18px; vertical-align: -4px; margin: 0 2px; color: var(--primary-color); }
        .details-content b { color: var(--on-surface); font-weight: 500; }
        .details-content code { background-color: var(--surface-variant); padding: 3px 6px; border-radius: 6px; font-family: monospace; }
        
        /* --- BOTONES Y NAVEGACIÓN --- */
        .fab { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); right: 24px; width: 56px; height: 56px; background: var(--current-user-accent); color: white; border: none; border-radius: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.07), 0px 8px 16px rgba(0, 0, 0, 0.1); transition: all 0.2s ease-out; z-index: 50; }
        .fab:hover { transform: scale(1.1) translateY(-2px); }
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 420px; background: var(--surface); border-top: 1px solid var(--outline); display: flex; padding: 4px 0 calc(8px + env(safe-area-inset-bottom)) 0; z-index: 100; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 4px 8px; cursor: pointer; transition: color 0.2s; color: var(--secondary-color); border: none; background: transparent; }
        .nav-item.active { color: var(--current-user-accent); }
        .nav-item .material-icons { font-size: 24px; margin-bottom: 2px; }
        .nav-label { font-size: 12px; font-weight: 500; }
        
        /* --- MODAL (FORMULARIO COMPACTO) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; padding: 16px; animation: modalFadeIn 0.3s; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--surface); border-radius: 28px; padding: 24px; width: 100%; max-width: 360px; max-height: 95vh; overflow-y: auto; box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1), 0px 16px 32px rgba(0, 0, 0, 0.1); }
        
        .modal-title { display: none; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--secondary-color); }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1.5px solid var(--outline); border-radius: 12px; background: var(--surface); color: var(--on-surface); font-size: 14px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-color); }
        .form-group-datetime { display: none; }
        .form-group-row { display: flex; gap: 8px; align-items: flex-end; }
        .form-group-row .form-group { flex: 1; margin-bottom: 0; }
        .form-group-inline { display: flex; align-items: center; gap: 8px; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 24px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--current-user-accent); color: white; }
        .btn-secondary { background: transparent; color: var(--secondary-color); }
        .btn-danger { background-color: transparent; border: 1px solid var(--accent-delete); color: var(--accent-delete); }
        .btn-danger:hover { background-color: rgba(255, 69, 58, 0.1); }
        .modal-actions .btn { width: 48px; height: 48px; padding: 0; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
        .modal-actions .btn-secondary { border: 1px solid var(--outline); }
        .modal-actions .btn .material-icons { font-size: 24px; }

        /* --- COMPONENTES ADICIONALES --- */
        #sync-indicator { width: 22px; height: 22px; color: var(--primary-color); animation: spin 1s linear infinite; display: none; }
        #sync-indicator.active { display: block; } @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 48px 24px; color: var(--secondary-color); }
        #toast-container { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 2000; width: max-content; max-width: 90%; pointer-events: none; }
        .toast { background-color: rgba(40, 40, 40, 0.95); backdrop-filter: blur(5px); color: white; padding: 10px 16px; border-radius: 12px; margin-bottom: 6px; box-shadow: 0 2px 6px var(--shadow); display: flex; align-items: center; animation: toastFadeIn 0.3s, toastFadeOut 0.3s 2.7s; font-size: 14px; }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; translateY(10px); } }
        #pull-to-refresh-indicator { position: absolute; top: -50px; left: 0; right: 0; height: 50px; display: flex; align-items: center; justify-content: center; color: var(--secondary-color); transition: top 0.2s, transform 0.2s; z-index: 5; }
        #pull-to-refresh-indicator .material-icons { font-size: 28px; transition: transform 0.2s; }
    </style>
</head>
<body>
    
    <div id="welcomeScreen" class="intro-screen visible"><img src="aiDANaI-Agenda.jpg" id="welcomeImage" alt="Logo Agenda aiDANaI"></div>
    <div id="quoteScreen" class="intro-screen"><p id="quoteText"></p><span id="quoteAuthor"></span></div>

    <div id="app-root">
        <main class="main-content" id="main-content-area">
            
            <div id="tasksView" class="view active">
                <div class="task-filters">
                    <div class="filter-group"><input type="radio" id="filterAll" name="task-filter" value="all" checked><label for="filterAll">Todos</label></div>
                    <div class="filter-group"><input type="radio" id="filterDani" name="task-filter" value="Dani"><label for="filterDani" style="color: var(--accent-dani);">Dani</label></div>
                    <div class="filter-group"><input type="radio" id="filterNorma" name="task-filter" value="Norma"><label for="filterNorma" style="color: var(--accent-norma);">Norma</label></div>
                    <div class="filter-group"><input type="radio" id="filterComun" name="task-filter" value="Comun"><label for="filterComun" style="color: var(--accent-comun);">Común</label></div>
                </div>
                <h3 class="section-title" id="pending-items-title">Pendientes</h3>
                <div id="pendingItemsList"></div>
                <h3 class="section-title" id="completed-items-title" style="margin-top:24px;">Completados</h3>
                <div id="completedItemsList"></div>
                <div id="emptyItems" class="empty-state" style="display: none;"></div>
            </div>

            <div id="calendarView" class="view">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button id="calendar-title-btn" title="Seleccionar mes y año"></button>
                        <div class="calendar-nav">
                             <button id="search-btn" class="icon-button" title="Buscar"><span class="material-icons">search</span></button>
                             <button id="today-btn" class="icon-button" title="Hoy"><span class="material-icons">today</span></button>
                             <button id="prev-month-btn" class="icon-button" title="Mes anterior"><span class="material-icons">chevron_left</span></button>
                             <button id="next-month-btn" class="icon-button" title="Mes siguiente"><span class="material-icons">chevron_right</span></button>
                             <div id="sync-indicator" role="status"><span class="material-icons">sync</span></div>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-weekdays" id="calendarWeekdays"></div>
                        <div class="calendar-days" id="calendarDays"></div>
                    </div>
                </div>
                <div class="agenda-list-container" id="agendaListContainer">
                     <h3 class="section-title" style="padding: 0 16px;" id="agenda-title"><span class="material-icons">view_agenda</span>Próximos eventos</h3>
                    <div id="agendaList"></div>
                </div>
            </div>
            
            <div id="searchView" class="view">
                <div id="search-container">
                    <input type="search" id="search-input" placeholder="Buscar eventos o tareas..." aria-label="Buscar ítems">
                </div>
                <h3 class="section-title">Resultados de la Búsqueda</h3>
                <div id="searchResultsList"></div>
            </div>

            <div id="helpView" class="view">
                <div class="settings-section help-section">
                    <h3 class="section-title" style="font-size: 20px; letter-spacing: 0.3px;"><span class="material-icons">rocket_launch</span>Bienvenido/a a aiDANaI</h3>
                    <p style="padding: 0 4px 12px; font-size: 15px; color: var(--secondary-color);">Tu nueva agenda inteligente, diseñada para ser tu segundo cerebro. Descubre todo su potencial.</p>

                    <details open>
                        <summary>Control Total con Gestos Mágicos<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>La velocidad es clave. Olvídate de los menús y gestiona todo con acciones directas e intuitivas:</p>
                            <ul>
                                <li><b>Completar:</b> Simplemente <b>desliza cualquier ítem hacia la derecha</b>. ¡Listo! Verás una confirmación visual y el ítem se marcará como hecho.</li>
                                <li><b>Eliminar:</b> <b>Desliza un ítem hacia la izquierda</b>. Por seguridad, te pediremos una confirmación antes de borrarlo para siempre.</li>
                                <li><b>Editar:</b> Un <b>simple toque</b> en el centro de cualquier tarea o evento abrirá la pantalla de edición para que puedas hacer cambios al instante.</li>
                                <li><b>Añadir:</b> El botón flotante <span class="material-icons" style="background: var(--current-user-accent); color: var(--on-primary); border-radius: 8px; padding: 2px;">add</span> está siempre visible para que puedas añadir un nuevo ítem sin pensarlo.</li>
                                <li><b>Duplicar:</b> ¿Una tarea recurrente? Pulsa el icono <span class="material-icons">content_copy</span> para crear un clon instantáneo y ahórrate el tecleo.</li>
                            </ul>
                        </div>
                    </details>

                    <details>
                        <summary>Tu Centro de Mando Unificado<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Organiza tu vida sin esfuerzo combinando dos tipos de ítems en un solo lugar:</p>
                            <ul>
                                <li><b>Tareas (<span class="material-icons">task_alt</span>):</b> Son tus "pendientes". Cosas por hacer que no necesitan una hora fija. Asígnales una fecha límite opcional para no perder el foco. Son las protagonistas de tu vista principal.</li>
                                <li><b>Eventos (<span class="material-icons">event</span>):</b> Para todo lo que ocurre en un momento concreto. Citas, reuniones, cumpleaños... Tienen fecha y hora, y se integran perfectamente en la vista de <b>Agenda</b>.</li>
                            </ul>
                        </div>
                    </details>
                    
                     <details>
                        <summary>Diseñada para Compartir<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                             <p>La coordinación es perfecta gracias al sistema de propietarios, identificado por colores:</p>
                             <ul>
                                <li><b>Para Dani (<span style="color:var(--accent-dani)">Azul</span>):</b> Ítems asignados a Dani.</li>
                                <li><b>Para Norma (<span style="color:var(--accent-norma)">Rojo</span>):</b> Ítems asignados a Norma.</li>
                                <li><b>Común (<span style="color:var(--accent-comun)">Verde</span>):</b> Ítems visibles y relevantes para ambos.</li>
                             </ul>
                             <p>Este código de color está presente en toda la app: en las listas, en los puntos del calendario... para que de un vistazo sepas quién es el responsable de qué.</p>
                        </div>
                    </details>

                     <details>
                        <summary>El Superpoder: 100% Offline<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                             <p>Esta es la virtud más importante de aiDANaI: <b>la aplicación funciona perfectamente sin conexión a internet.</b></p>
                             <ul>
                                 <li><b>Libertad Total:</b> Crea, edita, completa y elimina ítems en el metro, en un avión o donde sea. Todos tus cambios se guardan de forma segura en la memoria de tu dispositivo.</li>
                                 <li><b>Sincronización Inteligente:</b> En el momento en que recuperes la conexión, la app detectará los cambios y los sincronizará con la nube de forma automática y silenciosa. El icono <span class="material-icons">sync</span> girando te indicará que la magia está ocurriendo.</li>
                                 <li><b>Sincronización Manual:</b> ¿Quieres asegurarte de tener la última versión? En cualquier vista principal, simplemente <b>arrastra la pantalla hacia abajo</b> ("Pull to Refresh") para forzar una sincronización inmediata.</li>
                             </ul>
                        </div>
                    </details>

                     <details>
                        <summary>Navegación y Herramientas<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Muévete por la app con total fluidez usando la barra inferior:</p>
                             <ul>
                                 <li><span class="material-icons">task_alt</span> <b>Tareas:</b> Tu lista principal de acción.</li>
                                 <li><span class="material-icons">calendar_today</span> <b>Agenda:</b> La vista de calendario para planificar a futuro. Toca el nombre del mes para saltar a cualquier fecha.</li>
                                 <li><span class="material-icons">search</span> <b>Búsqueda:</b> Encuentra cualquier cosa al instante con la búsqueda global (icono de lupa en la vista de Agenda).</li>
                                 <li><span class="material-icons">brightness_6</span> <b>Tema:</b> Cambia entre los temas claro y oscuro para tu comodidad visual.</li>
                                 <li><span class="material-icons">logout</span> <b>Salir:</b> Cierra tu sesión de forma segura.</li>
                             </ul>
                             <p>Para mantener todo limpio, en la sección de mantenimiento puedes usar el botón <b>"Limpiar ítems antiguos"</b> para eliminar ítems completados hace más de 30 días.</p>
                        </div>
                    </details>
                    
                    <details>
                        <summary>Mantenimiento<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Para mantener la aplicación ágil y ordenada, puedes realizar una limpieza periódica.</p>
                            <p>El botón <b>"Limpiar ítems antiguos"</b> eliminará todas las tareas y eventos que hayan sido marcados como completados hace más de 30 días.</p>
                             <button class="btn btn-secondary" id="cleanup-items-btn" style="width:100%; margin-top: 1rem;">Limpiar ítems antiguos</button>
                        </div>
                    </details>

                </div>
            </div>
        </main>

        <button id="fab-add-item" class="fab"><span class="material-icons">add</span></button>
        <nav class="bottom-nav">
            <button class="nav-item active" data-view="tasks" title="Tareas"><span class="material-icons">task_alt</span><span class="nav-label">Tareas</span></button>
            <button class="nav-item" data-view="calendar" title="Agenda"><span class="material-icons">calendar_today</span><span class="nav-label">Agenda</span></button>
            <button class="nav-item" data-view="help" title="Ayuda"><span class="material-icons">help_outline</span><span class="nav-label">Ayuda</span></button>
            <button class="nav-item" id="nav-theme-btn" title="Cambiar Tema"><span class="material-icons">brightness_6</span><span class="nav-label">Tema</span></button>
            <button class="nav-item" id="nav-logout-btn" title="Cerrar Sesión"><span class="material-icons">logout</span><span class="nav-label">Salir</span></button>
        </nav>
    </div>

    <div id="add-item-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="modal-title-h3" class="modal-title">Crear Nuevo</h2>
            <form id="add-item-form">
                <input type="hidden" id="item-id"><input type="hidden" id="item-local-id">
                
                <div class="form-group">
                    <label class="form-label" for="item-description">Descripción</label>
                    <textarea class="form-input" id="item-description" rows="2" placeholder="Describe el ítem..."></textarea>
                </div>

                <div class="form-group-row">
                    <div class="form-group">
                        <label class="form-label" for="item-type">Tipo</label>
                        <select class="form-select" id="item-type">
                            <option value="task">Tarea</option>
                            <option value="agenda">Evento</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label class="form-label" for="item-owner">Propietario</label>
                        <select class="form-select" id="item-owner">
                            <option value="Dani">Dani</option>
                            <option value="Norma">Norma</option>
                            <option value="Comun">Común</option>
                        </select>
                    </div>
                </div>
                
                <div id="datetime-notification-group" class="form-group-datetime">
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label" for="item-due-date">Fecha</label>
                            <input type="date" class="form-input" id="item-due-date">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="item-due-time">Hora</label>
                            <input type="time" class="form-input" id="item-due-time">
                        </div>
                    </div>
                    <div class="form-group form-group-inline" style="margin-top: 12px;">
                        <input type="checkbox" id="item-notification-enabled" style="width: auto; height: 20px;">
                        <label for="item-notification-enabled" style="margin-bottom: 0; font-weight: normal; color: var(--on-surface);">Activar notificación</label>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" id="delete-item-btn" style="margin-right: auto; display: none;" title="Eliminar"><span class="material-icons">delete</span></button>
                    <button type="button" class="btn btn-secondary" id="cancel-item-btn" title="Cancelar"><span class="material-icons">close</span></button>
                    <button type="submit" class="btn btn-primary" id="save-item-btn" title="Guardar"><span class="material-icons">check</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="date-picker-modal" class="modal-overlay">
         <div class="modal">
            <h3 class="modal-title">Ir a la fecha</h3>
            <form id="date-picker-form">
                <div class="form-group"><label class="form-label">Mes</label><select id="month-select" class="form-select"></select></div>
                <div class="form-group"><label class="form-label">Año</label><input type="number" id="year-select" min="2020" max="2030" step="1" class="form-input"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-date-picker-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Ir</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container" aria-live="assertive"></div>
    <div id="swipe-tooltip-overlay" style="display:none;"></div>

    <script>
    // --- LÓGICA COMPLETA DE LA APLICACIÓN ---

    // --- CONFIGURACIÓN E INICIALIZACIÓN DE PARSE ---
    const PARSE_APP_ID = "v6TC3TP1vvPfkVXErWsox54UQtj9G6vJr8aTWpLl";
    const PARSE_JS_KEY = "ZomACaFL7RcBKbwfOvonnJ4JLNp1jBTlYaDTIMhy";
    const PARSE_SERVER_URL = "https://parseapi.back4app.com/";
    Parse.initialize(PARSE_APP_ID, PARSE_JS_KEY);
    Parse.serverURL = PARSE_SERVER_URL;

    // --- CONSTANTES Y HELPERS ---
    const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const DIAS_SEMANA = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
    
    const QUOTES = [
        { text: "La única forma de hacer un gran trabajo es amar lo que haces.", author: "Steve Jobs" },
        { text: "El futuro pertenece a quienes creen en la belleza de sus sueños.", author: "Eleanor Roosevelt" },
        { text: "Cree que puedes y ya estás a medio camino.", author: "Theodore Roosevelt" },
        { text: "El éxito es la suma de pequeños esfuerzos repetidos día tras día.", author: "Robert Collier" },
        { text: "La mejor manera de predecir el futuro es crearlo.", author: "Peter Drucker" },
        { text: "No cuentes los días, haz que los días cuenten.", author: "Muhammad Ali" },
        { text: "La disciplina es el puente entre las metas y los logros.", author: "Jim Rohn" },
        { text: "La inspiración existe, pero tiene que encontrarte trabajando.", author: "Pablo Picasso" },
        { text: "Si puedes soñarlo, puedes hacerlo.", author: "Walt Disney" },
        { text: "La vida se encoge o se expande en proporción al coraje de uno.", author: "Anaïs Nin" },
        { text: "La lógica te llevará de A a B. La imaginación te llevará a todas partes.", author: "Albert Einstein" },
        { text: "Un objetivo sin un plan es solo un deseo.", author: "Antoine de Saint-Exupéry" },
        { text: "Siempre parece imposible hasta que se hace.", author: "Nelson Mandela" },
        { text: "No soy producto de mis circunstancias. Soy producto de mis decisiones.", author: "Stephen Covey" },
        { text: "He fallado una y otra y otra vez en mi vida. Y es por eso que tengo éxito.", author: "Michael Jordan" },
        { text: "No importa lo lento que vayas, siempre y cuando no te detengas.", author: "Confucio" },
        { text: "Empieza donde estás. Usa lo que tienes. Haz lo que puedes.", author: "Arthur Ashe" },
        { text: "Un día o día uno. Tú decides.", author: "Anónimo" },
        { text: "El secreto del cambio es enfocar toda tu energía, no en luchar contra lo viejo, sino en construir lo nuevo.", author: "Sócrates" }
    ];
    
    const gebi = id => document.getElementById(id);
    const qs = selector => document.querySelector(selector);
    const qsa = selector => document.querySelectorAll(selector);
    function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
    function dateToYYYYMMDD(date) { if (!date || isNaN(date)) return ''; return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; }
    function dateToHHMM(date) { if (!date || isNaN(date)) return "00:00"; return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`; }
    function yyyymmddToDate(dateStr) { if (!dateStr) return new Date(); const parts = dateStr.split('-'); return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10)); }
    function showToast(message) { const tc = gebi('toast-container'); if (!tc) return; const t = document.createElement('div'); t.className = `toast`; t.textContent = message; tc.appendChild(t); setTimeout(() => t.remove(), 3300); }
    function uuid() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

    // --- GESTIÓN DE ESTADO (STORE) ---
    function createStore(initialState) { let state = initialState; const listeners = new Set(); return { getState() { return state; }, setState(updater) { const oldState = state; state = { ...state, ...(typeof updater === 'function' ? updater(state) : updater) }; listeners.forEach(listener => listener(state, oldState)); }, subscribe(listener) { listeners.add(listener); return () => listeners.delete(listener); } }; }
    const initialState = { currentUser: null, items: [], currentView: 'tasks', calendar: { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), selectedDate: dateToYYYYMMDD(new Date()) }, isLoading: false, fetchedMonths: new Set(), pendingSyncOperations: 0, theme: 'dark', taskFilter: 'all', searchQuery: '' };
    const store = createStore(initialState);

    // --- CICLO DE VIDA DE LA APP ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        runWelcomeSequence();
        attachGlobalEventListeners();
        store.subscribe(handleStateChange);
        store.subscribe(debounce((newState) => localStorage.setItem('items', JSON.stringify(newState.items)), 500));
        loadAndApplyTheme();
    }

    async function runWelcomeSequence() {
        const welcomeScreen = gebi('welcomeScreen');
        const quoteScreen = gebi('quoteScreen');

        await wait(2500); // Duración de la animación de entrada del logo
        welcomeScreen.style.opacity = '0';
        
        const quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
        gebi('quoteText').textContent = `“${quote.text}”`;
        gebi('quoteAuthor').textContent = `– ${quote.author}`;
        
        quoteScreen.classList.add('visible');
        await wait(100);
        quoteScreen.style.opacity = '1';
        
        await wait(3000); // Tiempo que la frase está en pantalla
        quoteScreen.style.opacity = '0';

        await wait(500); // Transición de salida
        welcomeScreen.style.display = 'none';
        quoteScreen.style.display = 'none';

        // Simulación de login para desarrollo.
        const defaultUser = { name: 'Dani' };
        localStorage.setItem('currentUser', JSON.stringify(defaultUser));
        store.setState({ currentUser: defaultUser });
        loadDataAndInitializeApp();
    }
    
    async function loadDataAndInitializeApp() {
        gebi('app-root').classList.add('visible');
        loadDataFromLocalStorage();
        await fetchInitialData();
    }
    
    function handleStateChange(newState, oldState) {
        if (newState.currentView !== oldState.currentView || newState.items !== oldState.items || newState.calendar !== oldState.calendar || newState.taskFilter !== oldState.taskFilter || newState.searchQuery !== oldState.searchQuery) {
            renderApp();
        }
        if (newState.pendingSyncOperations !== oldState.pendingSyncOperations) {
            gebi('sync-indicator')?.classList.toggle('active', newState.pendingSyncOperations > 0);
        }
        if (newState.theme !== oldState.theme) {
            applyTheme(newState.theme);
        }
        if (newState.currentUser !== oldState.currentUser && newState.currentUser) {
            setUserSpecificStyles(newState.currentUser.name);
        }
    }

    // --- RENDERIZADO DE LA UI ---
    function renderApp() {
        const state = store.getState();
        updateNav(state.currentView);
        renderCurrentView(state);
    }

    function renderCurrentView(state) {
        qsa('.view').forEach(v => v.classList.remove('active'));
        const viewId = `${state.currentView}View`;
        const viewEl = gebi(viewId);
        if (viewEl) {
            viewEl.classList.add('active');
            switch (state.currentView) {
                case 'calendar': renderCalendarView(state); break;
                case 'tasks': renderTaskListView(state); break;
                case 'help': /* No necesita re-renderizado constante */ break;
                case 'search': renderSearchView(state); break;
            }
        }
    }
    
    function updateNav(currentView) {
        qsa('.nav-item[data-view]').forEach(item => {
            item.classList.toggle('active', item.dataset.view === currentView);
        });
        const itemTypeSelect = gebi('item-type');
        if(itemTypeSelect) {
            itemTypeSelect.value = currentView === 'tasks' ? 'task' : 'agenda';
        }
    }

    function renderCalendarView(state) {
        const { calendar, items } = state;
        const { currentMonth, currentYear, selectedDate } = calendar;

        gebi('calendar-title-btn').textContent = `${MESES[currentMonth]} ${currentYear}`;
        
        const weekdaysContainer = gebi('calendarWeekdays');
        if (!weekdaysContainer.hasChildNodes()) {
            weekdaysContainer.innerHTML = DIAS_SEMANA.map((day, i) => `<div class="weekday ${i === 5 ? 'saturday' : ''} ${i === 6 ? 'sunday' : ''}">${day}</div>`).join('');
        }

        const calendarDays = gebi('calendarDays');
        calendarDays.innerHTML = '';
        const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
        const offset = (firstDayOfMonth.getDay() + 6) % 7;
        const startDate = new Date(firstDayOfMonth);
        startDate.setDate(startDate.getDate() - offset);
        const todayStr = dateToYYYYMMDD(new Date());

        for (let i = 0; i < 42; i++) {
            const cellDate = new Date(startDate);
            cellDate.setDate(startDate.getDate() + i);
            const dateStr = dateToYYYYMMDD(cellDate);
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.dataset.date = dateStr;

            if (cellDate.getMonth() !== currentMonth) dayElement.classList.add('other-month');
            if (dateStr === todayStr) dayElement.classList.add('today');
            if (dateStr === selectedDate) dayElement.classList.add('selected');

            const ownersOnDay = new Set(items.filter(it => it.dueDate && dateToYYYYMMDD(new Date(it.dueDate)) === dateStr).map(it => it.owner));
            let dotsHtml = '';
            if (ownersOnDay.size > 0) {
                 dotsHtml = `<div class="event-dots-container">${Array.from(ownersOnDay).map(owner => `<span class="event-dot" style="background-color: var(--accent-${owner.toLowerCase()});"></span>`).join('')}</div>`;
            }
            
            dayElement.innerHTML = `<span class="day-number">${cellDate.getDate()}</span>${dotsHtml}`;
            if (cellDate.getMonth() === currentMonth) {
                dayElement.onclick = () => selectDate(dateStr);
            }
            calendarDays.appendChild(dayElement);
        }

        renderUpcomingAgenda(items, selectedDate);
    }
    
    function renderUpcomingAgenda(items, selectedDateStr) {
        const agendaList = gebi('agendaList');
        const agendaTitle = gebi('agenda-title');
        agendaList.innerHTML = '';
        const fragment = document.createDocumentFragment();

        const startDate = yyyymmddToDate(selectedDateStr);
        startDate.setHours(0, 0, 0, 0);

        const upcomingItems = items
            .filter(item => {
                if (!item.dueDate) return false;
                const itemDate = new Date(item.dueDate);
                return itemDate >= startDate;
            })
            .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        
        const todayStr = dateToYYYYMMDD(new Date());
        if (selectedDateStr === todayStr) {
            agendaTitle.innerHTML = `<span class="material-icons">view_agenda</span>Próximos Eventos`;
        } else {
            const friendlyDate = startDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
            agendaTitle.innerHTML = `<span class="material-icons">event</span>Eventos desde el ${friendlyDate}`;
        }

        let lastHeaderDate = null;
        upcomingItems.forEach(item => {
            const itemDate = new Date(item.dueDate);
            const itemDateStr = dateToYYYYMMDD(itemDate);

            if (itemDateStr !== lastHeaderDate) {
                const header = document.createElement('div');
                header.className = 'agenda-date-header';
                header.textContent = itemDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                fragment.appendChild(header);
                lastHeaderDate = itemDateStr;
            }

            const itemEl = document.createElement('div');
            itemEl.className = `list-item-swipe-container agenda-item-compact ${item.isComplete ? 'completed' : ''}`;
            itemEl.dataset.id = item.localId;
            const time = item.type === 'task' ? 'Tarea' : dateToHHMM(itemDate);
            
            itemEl.innerHTML = `
                <div class="item-card-swipe-background">
                    <span class="material-icons">check_circle</span>
                    <span class="material-icons">delete</span>
                </div>
                <div class="item-content agenda-item-content" data-action="edit">
                    <div class="indicator" style="background-color:var(--accent-${item.owner.toLowerCase()});"></div>
                    <span class="time">${time}</span>
                    <div class="item-title title ${item.isComplete ? 'completed' : ''}">${item.description}</div>
                </div>`;
            
            itemEl.querySelector('[data-action="edit"]').addEventListener('click', () => openAddItemModal(item));
            fragment.appendChild(itemEl);
            attachSwipeListeners(itemEl);
        });
        
        if (upcomingItems.length === 0) {
            agendaList.innerHTML = `<div class="empty-state" style="padding-top:2rem;"><span class="material-icons">event_available</span><div>No hay eventos futuros desde esta fecha.</div></div>`;
        } else {
            agendaList.appendChild(fragment);
        }
    }

    function renderTaskListView(state) {
        const { items, taskFilter } = state;
        const filteredItems = taskFilter === 'all' ? items : items.filter(i => i.owner === taskFilter);
        
        // CAMBIO: Lógica de ordenación actualizada
        const sortPendingItems = (a, b) => {
            // Criterio 1: Tipo (task antes que agenda)
            if (a.type !== b.type) {
                return a.type === 'task' ? -1 : 1;
            }
            // Criterio 2: Fecha de vencimiento (de más cercana a más lejana)
            const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
            const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
            return dateA - dateB;
        };

        const sortCompletedItems = (a, b) => {
            // Para completados, tiene más sentido ordenar por fecha de completado
            return (b.completedAt || 0) - (a.completedAt || 0);
        };

        const pendingItems = filteredItems.filter(i => !i.isComplete).sort(sortPendingItems);
        const completedItems = filteredItems.filter(i => i.isComplete).sort(sortCompletedItems);

        gebi('pending-items-title').style.display = pendingItems.length > 0 ? 'flex' : 'none';
        gebi('completed-items-title').style.display = completedItems.length > 0 ? 'flex' : 'none';
        
        renderItemsList(gebi('pendingItemsList'), pendingItems);
        renderItemsList(gebi('completedItemsList'), completedItems.slice(0, 20));
        
        const emptyEl = gebi('emptyItems');
        if (filteredItems.length === 0) {
            emptyEl.style.display = 'block';
            emptyEl.innerHTML = `<span class="material-icons" style="font-size: 48px;">task_alt</span><div style="font-size: 1.2rem; margin-top: 1rem;">No hay ítems que mostrar</div><p>Prueba a cambiar los filtros o a crear un nuevo ítem.</p>`;
        } else {
            emptyEl.style.display = 'none';
        }
    }

    function renderItemsList(container, items) {
        container.innerHTML = '';
        items.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = `list-item-swipe-container item-card ${item.isComplete ? 'completed' : ''}`;
            itemEl.style.borderLeftColor = `var(--accent-${item.owner.toLowerCase()})`;
            itemEl.dataset.id = item.localId;

            const isCompleted = item.isComplete;
            const isTask = item.type === 'task';

            let metaInfo = `<span>${item.owner}</span>`;
            if (item.dueDate) {
                const itemDate = new Date(item.dueDate);
                const dateString = itemDate.toLocaleDateString('es-ES', {day: 'numeric', month: 'short'});
                const timeString = isTask ? '' : ` ${dateToHHMM(itemDate)}`;
                metaInfo += ` • <span class="material-icons" style="font-size: 14px; vertical-align: -2px;">${isTask ? 'flag' : 'event'}</span> <span>${dateString}${timeString}</span>`;
            }

            itemEl.innerHTML = `
                <div class="item-card-swipe-background">
                    <span class="material-icons">check_circle</span>
                    <span class="material-icons">delete</span>
                </div>
                <div class="item-checkbox ${isCompleted ? 'checked' : ''}" data-action="complete">
                    ${isCompleted ? '<span class="material-icons" style="font-size: 16px;">check</span>' : ''}
                </div>
                <div class="item-content" data-action="edit">
                    <div class="item-title ${isCompleted ? 'completed' : ''}">${item.description}</div>
                    <div class="item-meta">${metaInfo}</div>
                </div>
                <div class="item-actions">
                    <button class="icon-button" data-action="duplicate" title="Duplicar"><span class="material-icons">content_copy</span></button>
                </div>`;
            
            container.appendChild(itemEl);
            attachSwipeListeners(itemEl);
            itemEl.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                if (action) {
                    e.stopPropagation();
                    const id = item.localId;
                    if (action === 'complete') handleItemComplete(id, !item.isComplete);
                    if (action === 'edit') openAddItemModal(item);
                    if (action === 'duplicate') handleItemDuplicate(id);
                }
            });
        });
    }
    
    function renderSearchView(state) {
        const { searchQuery, items } = state;
        const resultsList = gebi('searchResultsList');
        const query = searchQuery.trim().toLowerCase();

        if (!query) {
            resultsList.innerHTML = `<div class="empty-state"><span class="material-icons">search</span><div>Escribe para buscar...</div></div>`;
            return;
        }

        const results = items.filter(item => item.description.toLowerCase().includes(query)).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        
        if (results.length > 0) {
            renderItemsList(resultsList, results);
        } else {
            resultsList.innerHTML = `<div class="empty-state"><span class="material-icons">search_off</span><div>No se encontraron resultados para "${searchQuery}"</div></div>`;
        }
    }


    // --- MANEJO DE EVENTOS GLOBALES ---
    function attachGlobalEventListeners() {
        qsa('.nav-item[data-view]').forEach(item => item.addEventListener('click', () => switchView(item.dataset.view)));
        gebi('nav-theme-btn').addEventListener('click', handleThemeToggle);
        gebi('nav-logout-btn').addEventListener('click', handleLogout);
        
        gebi('prev-month-btn').addEventListener('click', () => changeMonth(-1));
        gebi('next-month-btn').addEventListener('click', () => changeMonth(1));
        gebi('today-btn').addEventListener('click', goToToday);
        gebi('calendar-title-btn').addEventListener('click', openDatePickerModal);
        gebi('search-btn').addEventListener('click', () => switchView('search'));
        const debouncedSearch = debounce((e) => store.setState({ searchQuery: e.target.value }), 300);
        gebi('search-input').addEventListener('input', debouncedSearch);
        gebi('fab-add-item').addEventListener('click', () => openAddItemModal());
        gebi('cleanup-items-btn').addEventListener('click', handleCleanupOldItems);
        gebi('add-item-form').addEventListener('submit', handleItemFormSubmit);
        gebi('cancel-item-btn').addEventListener('click', () => closeModal('add-item-modal'));
        gebi('item-type').addEventListener('change', toggleDateTimeNotificationVisibility);
        gebi('delete-item-btn').addEventListener('click', handleDeleteFromModal);
        gebi('date-picker-form').addEventListener('submit', handleDateSelectionFromPicker);
        gebi('cancel-date-picker-btn').addEventListener('click', () => closeModal('date-picker-modal'));
        qsa('input[name="task-filter"]').forEach(radio => radio.addEventListener('change', (e) => store.setState({ taskFilter: e.target.value })));
        attachPullToRefresh(gebi('main-content-area'));
    }

    // --- FUNCIONALIDADES (LÓGICA DE NEGOCIO) ---
    const TODO_ITEM_CLASS_NAME = 'TodoItem';
    
    function parseObjectToAppItem(p) { if (!p) return null; return { id: p.id, type: p.get('type'), description: p.get('description'), owner: p.get('owner'), isComplete: p.get('isComplete') || false, createdAt: p.createdAt?.getTime(), createdBy: p.get('createdBy'), completedAt: p.get('completedAt')?.getTime(), lastModified: p.updatedAt?.getTime(), lastModifiedBy: p.get('lastModifiedBy'), dueDate: p.get('dueDate')?.toISOString(), notificationEnabled: p.get('notificationEnabled') || false, localId: p.get('localId') || p.id, }; }
    function updateSyncIndicator(change) { store.setState(prev => ({ pendingSyncOperations: Math.max(0, prev.pendingSyncOperations + change) })); }
    
    async function fetchInitialData() {
        if (!store.getState().currentUser) return;
        store.setState({ isLoading: true });
        updateSyncIndicator(1);
        try {
            const query = new Parse.Query(TODO_ITEM_CLASS_NAME);
            query.limit(1000);
            query.descending("updatedAt");
            const results = await query.find();
            const backendItems = results.map(parseObjectToAppItem).filter(Boolean);
            store.setState(prev => {
                const itemMap = new Map(prev.items.map(item => [item.localId, item]));
                backendItems.forEach(bItem => {
                    const existing = itemMap.get(bItem.localId);
                    if (!existing || (bItem.lastModified && existing.lastModified && bItem.lastModified > existing.lastModified)) {
                        itemMap.set(bItem.localId, bItem);
                    }
                });
                return { items: Array.from(itemMap.values()) };
            });
            showToast("Datos sincronizados.");
        } catch (e) {
            showToast(`Error de sincronización: ${e.message}.`);
        } finally {
            store.setState({ isLoading: false });
            updateSyncIndicator(-1);
        }
    }

    function switchView(view) {
        if (store.getState().isLoading || !view) return;
        
        store.setState({ currentView: view });

        if (view === 'search') {
            setTimeout(() => {
                const searchInput = gebi('search-input');
                if (searchInput) searchInput.focus();
            }, 50);
        }
    }
    
    function selectDate(dateStr) {
        store.setState(prev => ({ calendar: { ...prev.calendar, selectedDate: dateStr }}));
        switchView('calendar');
    }

    function changeMonth(delta) {
        const { currentMonth, currentYear } = store.getState().calendar;
        let newDate = new Date(currentYear, currentMonth, 1);
        newDate.setMonth(newDate.getMonth() + delta);
        store.setState(prev => ({ calendar: { ...prev.calendar, currentMonth: newDate.getMonth(), currentYear: newDate.getFullYear() }}));
    }
    
    function goToToday() {
        const today = new Date();
        const newCalendarState = { currentMonth: today.getMonth(), currentYear: today.getFullYear(), selectedDate: dateToYYYYMMDD(today) };
        if (store.getState().currentView !== 'calendar') {
             store.setState({ currentView: 'calendar', calendar: newCalendarState });
        } else {
            store.setState({ calendar: newCalendarState });
        }
    }
    
    // --- MANEJO DE MODALES ---
    function openModal(modalId) { const modal = gebi(modalId); if(modal) modal.classList.add('active'); }
    function closeModal(modalId) { const modal = gebi(modalId); if(modal) modal.classList.remove('active'); }

    function openAddItemModal(itemToEdit = null) {
        const state = store.getState();
        const f = gebi('add-item-form');
        f.reset();
        
        const isEditing = itemToEdit !== null;
        gebi('modal-title-h3').textContent = isEditing ? 'Editar Ítem' : 'Añadir Ítem';
        gebi('delete-item-btn').style.display = isEditing ? 'inline-flex' : 'none';

        gebi('item-id').value = itemToEdit?.id || '';
        gebi('item-local-id').value = itemToEdit?.localId || uuid();
        gebi('item-type').value = itemToEdit?.type || (state.currentView === 'tasks' ? 'task' : 'agenda');
        gebi('item-description').value = itemToEdit?.description || '';
        
        const dueDate = itemToEdit?.dueDate ? new Date(itemToEdit.dueDate) : yyyymmddToDate(state.calendar.selectedDate);
        gebi('item-due-date').value = dateToYYYYMMDD(dueDate);
        
        if (itemToEdit && itemToEdit.dueDate) {
            gebi('item-due-time').value = dateToHHMM(new Date(itemToEdit.dueDate));
        } else {
            const now = new Date();
            now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15);
            gebi('item-due-time').value = dateToHHMM(now);
        }
        
        gebi('item-notification-enabled').checked = itemToEdit?.notificationEnabled || false;
        gebi('item-owner').value = itemToEdit?.owner || state.currentUser?.name || 'Comun';

        toggleDateTimeNotificationVisibility();
        openModal('add-item-modal');
    }

    function toggleDateTimeNotificationVisibility() {
        const isAgenda = gebi('item-type').value === 'agenda';
        const dateTimeGroup = gebi('datetime-notification-group');
        dateTimeGroup.style.display = 'block';
        
        const timeInput = gebi('item-due-time');
        const timeLabel = dateTimeGroup.querySelector('label[for="item-due-time"]');

        timeInput.style.display = isAgenda ? 'block' : 'none';
        timeLabel.style.display = isAgenda ? 'block' : 'none';
        
        if (!gebi('item-due-date').value) {
            gebi('item-due-date').value = dateToYYYYMMDD(new Date());
        }
    }
    
    // --- CRUD DE ÍTEMS ---
    function handleItemFormSubmit(e) {
        e.preventDefault();
        const { currentUser } = store.getState();
        if (!currentUser) return;
        
        const localId = gebi('item-local-id').value;
        const existingItem = store.getState().items.find(i => i.localId === localId);

        const itemData = {
            id: gebi('item-id').value,
            localId: localId,
            type: gebi('item-type').value,
            description: gebi('item-description').value.trim(),
            owner: gebi('item-owner').value,
            isComplete: existingItem?.isComplete || false,
            createdAt: existingItem?.createdAt || Date.now(),
            createdBy: existingItem?.createdBy || currentUser.name,
            notificationEnabled: gebi('item-notification-enabled').checked,
            dueDate: null
        };
        
        const datePart = gebi('item-due-date').value;
        const timePart = gebi('item-due-time').value || '00:00';
        
        if (datePart) {
             const [year, month, day] = datePart.split('-');
            if (itemData.type === 'agenda') {
                const [hour, minute] = timePart.split(':');
                itemData.dueDate = new Date(year, month - 1, day, hour, minute).toISOString();
            } else { 
                itemData.dueDate = new Date(year, month - 1, day, 23, 59, 59).toISOString();
            }
        }
        
        handleItemSave(itemData);
        closeModal('add-item-modal');
    }

    async function handleItemSave(itemData) {
        const { currentUser } = store.getState();
        const itemForUI = { ...itemData, lastModified: Date.now(), lastModifiedBy: currentUser.name };
        
        store.setState(prev => {
            const items = [...prev.items];
            const index = items.findIndex(i => i.localId === itemForUI.localId);
            if (index > -1) items[index] = { ...items[index], ...itemForUI };
            else items.unshift(itemForUI);
            return { items };
        });

        updateSyncIndicator(1);
        try {
            const ParseItem = Parse.Object.extend(TODO_ITEM_CLASS_NAME);
            const query = new Parse.Query(ParseItem);
            query.equalTo('localId', itemData.localId);
            let parseItem = await query.first();
            
            if (!parseItem) {
                parseItem = new ParseItem();
                parseItem.set('createdBy', currentUser.name);
                parseItem.set('localId', itemData.localId);
            }
            
            parseItem.set('type', itemData.type);
            parseItem.set('description', itemData.description);
            parseItem.set('owner', itemData.owner);
            parseItem.set('isComplete', itemData.isComplete || false);
            parseItem.set('lastModifiedBy', currentUser.name);
            if (itemData.completedAt) parseItem.set('completedAt', new Date(itemData.completedAt));
            else parseItem.unset('completedAt');
            if (itemData.dueDate) parseItem.set('dueDate', new Date(itemData.dueDate));
            else parseItem.unset('dueDate');
            parseItem.set('notificationEnabled', itemData.notificationEnabled);

            const savedItem = await parseItem.save();
            const finalItem = parseObjectToAppItem(savedItem);
            
            store.setState(prev => ({
                items: prev.items.map(i => i.localId === finalItem.localId ? finalItem : i)
            }));
            showToast(`Ítem ${itemData.id ? 'actualizado' : 'guardado'}.`);
        } catch (e) {
            showToast(`Error al guardar en la nube: ${e.message}`);
        } finally {
            updateSyncIndicator(-1);
        }
    }

    function handleItemComplete(localId, isComplete) {
        const item = store.getState().items.find(i => i.localId === localId);
        if (item) {
            handleItemSave({ ...item, isComplete, completedAt: isComplete ? Date.now() : null });
            showToast(isComplete ? 'Ítem completado.' : 'Ítem marcado como pendiente.');
        }
    }
    
    async function handleItemDelete(localId) {
        const itemToDelete = store.getState().items.find(i => i.localId === localId);
        if (!itemToDelete) return;
        
        store.setState(prev => ({ items: prev.items.filter(i => i.localId !== localId) }));
        
        if (itemToDelete.id) {
             updateSyncIndicator(1);
            try {
                const itemInCloud = Parse.Object.extend(TODO_ITEM_CLASS_NAME).createWithoutData(itemToDelete.id);
                await itemInCloud.destroy();
                showToast('Ítem eliminado.');
            } catch (e) {
                showToast(`Error al eliminar de la nube.`);
                store.setState(prev => ({ items: [...prev.items, itemToDelete] }));
            } finally {
                updateSyncIndicator(-1);
            }
        }
    }
    
    function handleDeleteFromModal() {
        const localId = gebi('item-local-id').value;
        if (localId && confirm("¿Eliminar este ítem permanentemente?")) {
            handleItemDelete(localId);
            closeModal('add-item-modal');
        }
    }

    function handleItemDuplicate(localId) {
        const itemToDup = store.getState().items.find(i => i.localId === localId);
        if (!itemToDup) return;
        const newItemData = { ...itemToDup, id: null, localId: uuid(), isComplete: false, completedAt: null, createdAt: Date.now() };
        handleItemSave(newItemData);
        showToast('Ítem duplicado.');
    }
    
    // --- OTRAS FUNCIONALIDADES ---
    function loadAndApplyTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        store.setState({ theme: savedTheme });
    }
    function applyTheme(theme) {
        document.body.dataset.theme = theme;
        document.querySelector('meta[name="theme-color"]').setAttribute('content', theme === 'dark' ? '#1C1B1F' : '#FDFBFF');
    }
    function handleThemeToggle() {
        const newTheme = store.getState().theme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        store.setState({ theme: newTheme });
    }

    function setUserSpecificStyles(userName) {
        const accentVar = userName === 'Dani' ? 'var(--accent-dani)' : 'var(--accent-norma)';
        document.documentElement.style.setProperty('--current-user-accent', accentVar);
    }
    
    function handleLogout() {
        window.location.href = 'https://danijdzg.github.io/aiDANaI/menu/';
    }
    
    function loadDataFromLocalStorage() { try { const sI = localStorage.getItem('items'); if (sI) store.setState({ items: JSON.parse(sI) }); } catch (e) { console.error("Error loading items from localStorage", e); } }
    
    function openDatePickerModal() {
        openModal('date-picker-modal');
        const monthSelect = gebi('month-select');
        const yearSelect = gebi('year-select');
        monthSelect.innerHTML = MESES.map((mes, index) => `<option value="${index}">${mes}</option>`).join('');
        monthSelect.value = store.getState().calendar.currentMonth;
        yearSelect.value = store.getState().calendar.currentYear;
    }
    function handleDateSelectionFromPicker(e) {
        e.preventDefault();
        const newMonth = parseInt(gebi('month-select').value, 10);
        const newYear = parseInt(gebi('year-select').value, 10);
        store.setState(prev => ({ calendar: { ...prev.calendar, currentMonth: newMonth, currentYear: newYear }}));
        closeModal('date-picker-modal');
    }

    async function handleCleanupOldItems() {
        const THIRTY_DAYS_AGO = Date.now() - (30 * 24 * 60 * 60 * 1000);
        const itemsToClean = store.getState().items.filter(item => item.isComplete && item.completedAt < THIRTY_DAYS_AGO);
        if (itemsToClean.length === 0) { showToast("No hay ítems antiguos que limpiar."); return; }
        if (!confirm(`¿Eliminar ${itemsToClean.length} ítem(s) completado(s) hace más de 30 días?`)) return;
        
        const localIdsToClean = itemsToClean.map(t => t.localId);
        store.setState(prev => ({ items: prev.items.filter(item => !localIdsToClean.includes(item.localId)) }));
        updateSyncIndicator(1);
        try {
            const parseObjectsToDelete = itemsToClean.filter(t => t.id).map(t => Parse.Object.extend(TODO_ITEM_CLASS_NAME).createWithoutData(t.id));
            if (parseObjectsToDelete.length > 0) await Parse.Object.destroyAll(parseObjectsToDelete);
            showToast("Limpieza completada.");
        } catch (error) {
            showToast("Error al limpiar ítems en la nube.");
        } finally {
            updateSyncIndicator(-1);
        }
    }
    
    function attachSwipeListeners(cardElement) {
        if (!cardElement || cardElement.dataset.hammer) return;
        cardElement.dataset.hammer = 'true';
        const mc = new Hammer.Manager(cardElement);
        mc.add(new Hammer.Pan({ threshold: 10, pointers: 1 }));

        mc.on('panstart', () => { cardElement.style.transition = 'none'; });
        mc.on('pan', (ev) => {
            cardElement.style.transform = `translateX(${ev.deltaX}px)`;
            cardElement.classList.toggle('swiping-right', ev.deltaX > 20);
            cardElement.classList.toggle('swiping-left', ev.deltaX < -20);
        });
        mc.on('panend', (ev) => {
            cardElement.style.transition = 'transform 0.2s ease-out, opacity 0.3s';
            cardElement.classList.remove('swiping-right', 'swiping-left');
            const SWIPE_ACTION_THRESHOLD = cardElement.offsetWidth * 0.35;
            const id = cardElement.dataset.id;
            const item = store.getState().items.find(i => i.localId === id);
            if (!item) return;

            if (ev.deltaX > SWIPE_ACTION_THRESHOLD) {
                cardElement.style.transform = `translateX(100%)`;
                cardElement.style.opacity = '0';
                setTimeout(() => handleItemComplete(id, !item.isComplete), 200);
            } else if (ev.deltaX < -SWIPE_ACTION_THRESHOLD) {
                cardElement.style.transform = `translateX(-100%)`;
                cardElement.style.opacity = '0';
                setTimeout(() => {
                     if(confirm(`¿Eliminar este ítem?\n\n"${item.description}"`)) {
                         handleItemDelete(id);
                     } else {
                         cardElement.style.transform = 'translateX(0)';
                         cardElement.style.opacity = '1';
                     }
                }, 200);
            } else {
                cardElement.style.transform = 'translateX(0)';
            }
        });
    }

    function attachPullToRefresh(element) {
        let touchStartY = 0; let isPulling = false;
        const ptrIndicator = document.createElement('div');
        ptrIndicator.id = 'pull-to-refresh-indicator';
        ptrIndicator.innerHTML = `<span id="ptr-arrow" class="material-icons">arrow_downward</span><span id="ptr-spinner" class="material-icons" style="display:none; animation: spin 1s linear infinite;">sync</span>`;
        element.prepend(ptrIndicator);
        const PULL_THRESHOLD = 80;
        
        element.addEventListener('touchstart', (e) => {
            const activeView = element.querySelector('.view.active');
            if (!activeView) return;
            if (activeView.scrollTop === 0) {
                touchStartY = e.touches[0].clientY; isPulling = true;
                ptrIndicator.querySelector('#ptr-spinner').style.display = 'none';
                ptrIndicator.querySelector('#ptr-arrow').style.display = 'block';
            }
        }, { passive: true });
        
        element.addEventListener('touchmove', (e) => {
            if (!isPulling) return;
            const pullDistance = e.touches[0].clientY - touchStartY;
            if (pullDistance > 0) {
                e.preventDefault();
                const rotation = Math.min(pullDistance / PULL_THRESHOLD, 1) * 180;
                ptrIndicator.style.top = `${Math.min(pullDistance, PULL_THRESHOLD) - 50}px`;
                ptrIndicator.querySelector('#ptr-arrow').style.transform = `rotate(${rotation}deg)`;
            }
        }, { passive: false });
        
        element.addEventListener('touchend', async (e) => {
            if (!isPulling) return;
            const pullDistance = e.changedTouches[0].clientY - touchStartY;
            ptrIndicator.querySelector('#ptr-arrow').style.transform = 'rotate(0deg)';
            if (pullDistance > PULL_THRESHOLD) {
                ptrIndicator.style.top = '10px';
                ptrIndicator.querySelector('#ptr-arrow').style.display = 'none';
                ptrIndicator.querySelector('#ptr-spinner').style.display = 'block';
                await fetchInitialData();
            }
            ptrIndicator.style.top = '-50px';
            isPulling = false;
        });
    }

    </script>
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(r => console.log('ServiceWorker OK')).catch(e => console.log('ServiceWorker Fail', e)); }); }
    </script>
</body>
</html>