<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Agenda aiDANaI</title>
    <!-- Librerías de terceros -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:wght@400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://unpkg.com/flatpickr/dist/l10n/es.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <!-- Configuración PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="aiDANaI.webp">
    <style>
        /* ============================ */
        /* 1. VARIABLES Y ESTILO BASE */
        /* ============================ */
        :root { --primary-color: #7B68EE; --primary-variant: #5A4CAD; --secondary-color: #9E9EAD; --background: #F8F8FA; --surface: #FFFFFF; --surface-variant: #F0F0F5; --on-primary: #FFFFFF; --on-background: #1A1C20; --on-surface: #1A1C20; --outline: #E0E0E6; --accent-task: #4CAF50; --accent-event-normal: #2196F3; --accent-event-important: #F44336; --accent-delete: #E53935; --accent-complete: #43A047; --accent-edit: #1E88E5; --accent-google: #4285F4; --font-main: 'Archivo Narrow', 'Roboto', sans-serif; --shadow-layered: 0px 4px 8px rgba(26, 28, 32, 0.04), 0px 8px 24px rgba(26, 28, 32, 0.08); --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1); --ease-in-out-circ: cubic-bezier(0.85, 0, 0.15, 1); }
        [data-theme="dark"] { --primary-color: #A78BFA; --primary-variant: #7B68EE; --secondary-color: #9E9EAD; --background: #121212; --surface: #1E1E1E; --surface-variant: #2A2A32; --on-primary: #000000; --on-background: #EAEAEA; --on-surface: #F5F5F5; --outline: #3A3A42; --shadow-layered: 0px 8px 24px rgba(0, 0, 0, 0.2); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; }
        body { font-family: var(--font-main); background-color: var(--background); color: var(--on-background); line-height: 1.5; overflow: hidden; min-height: 100vh; min-height: -webkit-fill-available; height: 100vh; transition: background-color 0.3s, color 0.3s; font-size: 15px; }
        *:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; border-radius: 6px; }
        #google-sync-btn.loading .material-icons { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fade-in-down { from { opacity: 0; transform: translateY(-20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .item-entering { animation: fade-in-down 0.4s var(--ease-out-quint) forwards; }
        @keyframes fade-out-up { from { opacity: 1; transform: scale(1); max-height: 200px; margin-top: 6px; padding-top: 8px; padding-bottom: 8px; } to { opacity: 0; transform: scale(0.95); max-height: 0; margin-top: 0; padding-top: 0; padding-bottom: 0; border-width: 0; } }
        .item-exiting { overflow: hidden; animation: fade-out-up 0.35s var(--ease-in-out-circ) forwards; }
        #app-root { display: none; max-width: 420px; margin: 0 auto; height: 100vh; background: var(--background); position: relative; flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out, background-color 0.3s; padding-bottom: calc(52px + env(safe-area-inset-bottom)); }
        #app-root.visible { display: flex; opacity: 1; }
        .main-content { flex: 1; display: flex; position: relative; overflow: hidden; }
        .view { display: none; width: 100%; flex-direction: column; height: 100%; overflow-y: auto; padding: 16px; position: absolute; top: 0; left: 0; transition: transform 0.4s var(--ease-in-out-circ), opacity 0.4s var(--ease-in-out-circ); }
        .view.active { display: flex; z-index: 1; }
        .view.is-animating { display: flex; }
        #calendarView { padding: 0; overflow-y: auto; }
        @keyframes slideInFromRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideOutToLeft { from { transform: translateX(0); } to { transform: translateX(-100%); } }
        @keyframes slideInFromLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes slideOutToRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
        .view-enter-from-right { animation: slideInFromRight 0.4s var(--ease-in-out-circ) forwards; opacity: 1; z-index: 2;}
        .view-exit-to-left { animation: slideOutToLeft 0.4s var(--ease-in-out-circ) forwards; opacity: 0.5; z-index: 1;}
        .view-enter-from-left { animation: slideInFromLeft 0.4s var(--ease-in-out-circ) forwards; opacity: 1; z-index: 2;}
        .view-exit-to-right { animation: slideOutToRight 0.4s var(--ease-in-out-circ) forwards; opacity: 0.5; z-index: 1;}
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 420px; background: rgba(28, 28, 28, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(56, 56, 66, 0.5); display: flex; padding: 2px 0 calc(2px + env(safe-area-inset-bottom)) 0; z-index: 100; }
        [data-theme="paperwhite"] .bottom-nav, [data-theme="coral-sunset"] .bottom-nav, [data-theme="ocean-breeze"] .bottom-nav { background: rgba(255, 255, 255, 0.7); border-top: 1px solid rgba(224, 224, 230, 0.5); }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px 0; cursor: pointer; transition: color 0.2s, background-color 0.2s, transform 0.1s ease-out; color: var(--secondary-color); border: none; background: transparent; border-radius: 8px; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item:active { transform: scale(0.92); }
        .nav-item .material-icons { font-size: 24px; margin: 0; }
        #google-sync-btn.connected { color: var(--accent-google); }
        .calendar-container { flex-shrink: 0; padding: 8px 16px; border-bottom: 1px solid var(--outline); }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .calendar-title-container { position: relative; display: inline-flex; align-items: center; }
        #calendar-title-btn { font-size: 16px; font-weight: 700; background: none; border: none; color: var(--on-background); padding: 4px 6px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, transform 0.1s ease-out; }
        #calendar-title-btn:hover { background-color: var(--surface-variant); }
        #calendar-title-btn:active { transform: scale(0.95); }
        .calendar-nav { display: flex; align-items: center; gap: 2px; }
        .icon-button { background: none; border: none; color: var(--secondary-color); cursor: pointer; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .icon-button:active { transform: scale(0.9); background-color: var(--surface-variant); }
        .icon-button .material-icons { font-size: 22px; }
        .icon-button:hover { background-color: var(--surface-variant); color: var(--on-surface); }
        #sync-status-indicator { position: absolute; top: 2px; right: -20px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
        #sync-status-indicator .material-icons { font-size: 14px; transition: color 0.3s; }
        #sync-status-indicator.online .material-icons { color: var(--accent-complete); }
        #sync-status-indicator.offline .material-icons { color: var(--secondary-color); }
        .view-toggle { display: flex; background-color: var(--surface-variant); border-radius: 10px; overflow: hidden; margin: 0 8px; }
        .view-toggle .btn-toggle { background: none; border: none; color: var(--secondary-color); padding: 6px 10px; cursor: pointer; transition: all 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .view-toggle .btn-toggle.active { background-color: var(--primary-color); color: var(--on-primary); box-shadow: 0 2px 6px color-mix(in srgb, var(--primary-color) 20%, transparent); }
        .view-toggle .btn-toggle:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .view-toggle .btn-toggle:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        .view-toggle .btn-toggle .material-icons { font-size: 20px; }
        .view-toggle .btn-toggle:active { transform: scale(0.95); }
        #calendarView[data-display-mode="month"] #weekly-view-container { display: none; }
        #calendarView[data-display-mode="month"] #calendar-grid { display: block; }
        #calendarView[data-display-mode="month"] #agendaListContainer { display: block; }
        #calendarView[data-display-mode="week"] #calendar-grid { display: none; }
        #calendarView[data-display-mode="week"] #agendaListContainer { display: none; }
        #calendarView[data-display-mode="week"] #weekly-view-container { display: flex; flex-direction: column; }
        .calendar-grid { background: var(--surface); border-radius: 12px; padding: 6px; box-shadow: var(--shadow-layered); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
        .weekday { text-align: center; font-size: 12px; font-weight: 500; color: var(--secondary-color); padding: 4px; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; position: relative; font-size: 14px; transition: all 0.2s; padding: 4px 0; }
        .day-number { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .calendar-day.today .day-number { background: var(--primary-color); color: var(--on-primary); font-weight: 700; }
        .calendar-day.selected .day-number { background: var(--primary-variant); color: var(--on-primary); }
        .calendar-day.other-month { color: var(--outline); pointer-events: none; }
        .calendar-day .event-dots-container { position: absolute; bottom: 4px; left: 0; right: 0; display: flex; justify-content: center; gap: 3px; }
        .event-dot { width: 4px; height: 4px; border-radius: 50%; }
        .event-dot.important { background-color: var(--accent-event-important); }
        .event-dot.normal { background-color: var(--accent-event-normal); }
        .agenda-list-container { flex-grow: 1; overflow-y: auto; padding: 8px 16px 80px 16px; }
        .agenda-date-header { font-weight: 700; letter-spacing: 0.3px; font-size: 12px; color: var(--primary-color); padding: 8px 12px; background-color: var(--surface-variant); position: sticky; top: 0; z-index: 1; border-radius: 8px; margin-top: 8px; margin-bottom: 4px; }
        #today-greeting { font-size: 22px; font-weight: 700; margin-bottom: 24px; }
        .section-title { font-size: 16px; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; letter-spacing: 0.2px; margin-top: 24px; }
        .weekly-view-container { flex-grow: 1; padding: 8px 16px 80px 16px; overflow-y: auto; height: 100%; }
        .weekly-day-section { margin-bottom: 16px; background: var(--surface); border-radius: 12px; box-shadow: var(--shadow-layered); padding-bottom: 8px; }
        .weekly-day-header { font-weight: 700; letter-spacing: 0.3px; font-size: 14px; color: var(--primary-color); padding: 12px 16px; background-color: var(--surface-variant); border-top-left-radius: 12px; border-top-right-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .weekly-day-header .material-icons { font-size: 18px; }
        .weekly-day-events { padding: 0 16px; }
        .weekly-day-events .empty-state { padding: 12px; font-size: 13px; }
        #search-container { padding: 4px 16px 8px; transition: max-height 0.4s ease-out, opacity 0.4s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        #search-container.active { max-height: 60px; opacity: 1; }
        #search-form { display: flex; gap: 8px; align-items: center; }
        #search-input { flex-grow: 1; padding: 10px 16px; border: 1.5px solid var(--outline); border-radius: 24px; background: var(--surface-variant); color: var(--on-surface); font-size: 14px; }
        #search-input:focus { outline: none; border-color: var(--primary-color); }
        .fab { position: fixed; bottom: calc(65px + env(safe-area-inset-bottom)); right: 20px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--primary-color); color: var(--on-primary); border: none; box-shadow: var(--shadow-layered); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 150; transition: background-color 0.2s, transform 0.2s var(--ease-out-quint); }
        .fab:hover { background-color: var(--primary-variant); transform: scale(1.05); }
        .fab:active { transform: scale(0.9); }
        .fab .material-icons { font-size: 28px; }
        .list-item-swipe-container { display: flex; align-items: flex-start; background: var(--surface); border-radius: 8px; margin-bottom: 6px; box-shadow: var(--shadow-layered); transition: transform 0.3s var(--ease-out-quint), opacity 0.3s, border-left-color 0.3s, background-color 0.1s; user-select: none; position: relative; padding: 8px 10px; border-left: 4px solid transparent; }
        .list-item-swipe-container:active { background-color: var(--surface-variant); transform: scale(0.98); }
        .list-item-swipe-container .item-icon { color: var(--secondary-color); margin-right: 8px; padding-top: 2px; font-size: 22px; display: flex; align-items: center; justify-content: center; z-index: 2; position: relative; }
        .list-item-swipe-container .item-checkbox .material-icons { font-size: 24px; cursor: pointer; transition: color 0.2s, transform 0.2s var(--ease-out-quint); color: var(--secondary-color); }
        .list-item-swipe-container .item-checkbox:active .material-icons { transform: scale(0.85); }
        .list-item-swipe-container.completed .item-checkbox .material-icons { color: var(--accent-complete); }
        .list-item-swipe-container .item-content { flex: 1; cursor: pointer; min-width: 0; display: flex; flex-direction: column; justify-content: center; z-index: 2; position: relative; }
        .item-card-swipe-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; color: white; opacity: 0; transition: opacity 0.2s; z-index: 1; pointer-events: none; }
        .list-item-swipe-container.swiping-right .item-card-swipe-background { background-color: var(--accent-complete); justify-content: flex-start; opacity: 1; }
        .list-item-swipe-container.swiping-left .item-card-swipe-background { background-color: var(--accent-delete); justify-content: flex-end; opacity: 1; }
        .list-item-swipe-container.swiping-right .item-card-swipe-background .material-icons:first-child, .list-item-swipe-container.swiping-left .item-card-swipe-background .material-icons:last-child { animation: bounceIn 0.3s ease-out; }
        @keyframes bounceIn { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
        .list-item-swipe-container.completed { opacity: 0.6; }
        .list-item-swipe-container.completed .item-title { text-decoration: line-through; text-decoration-color: var(--secondary-color); }
        .item-title { font-weight: 500; font-size: 14px; white-space: normal; word-break: break-word; line-height: 1.3; font-family: var(--font-main); }
        .event-time { font-size: 13px; font-weight: 700; color: var(--secondary-color); padding-top: 1px; }
        .event-meta-icon { font-size: 16px; color: var(--secondary-color); flex-shrink: 0; }
        .item-metadata-container { display: flex; align-items: center; gap: 8px; margin-top: 2px; color: var(--secondary-color); }
        .google-cal-icon { color: var(--accent-google) !important; }
        .aidanai-only-icon { color: var(--secondary-color) !important; }
        .task-progress-container { margin-top: 8px; }
        .progress-bar-wrapper { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--secondary-color); }
        .progress-bar { flex-grow: 1; background: var(--outline); border-radius: 4px; height: 4px; overflow: hidden; }
        .progress-bar-fill { width: 0%; height: 100%; background: var(--primary-color); transition: width 0.3s; }
        .subtasks-list-view { margin-top: 6px; padding-left: 4px; display: flex; flex-direction: column; gap: 4px; }
        .subtask-list-view-item { display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; }
        .subtask-list-view-item:hover { background-color: var(--surface-variant); }
        .subtask-list-view-item .material-icons { font-size: 18px; color: var(--secondary-color); transition: color 0.2s; }
        .subtask-list-view-item.completed { text-decoration: line-through; color: var(--secondary-color); }
        .subtask-list-view-item.completed .material-icons { color: var(--accent-complete); }
        #quick-add-feedback { margin-top: -8px; margin-bottom: 8px; padding: 0 4px; min-height: 28px; transition: all 0.2s; }
        .feedback-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 16px; font-size: 13px; font-weight: 500; background-color: var(--surface-variant); color: var(--on-surface); animation: fade-in-down 0.3s var(--ease-out-quint); }
        .feedback-chip .material-icons { font-size: 18px; }
        .feedback-chip.type-agenda { color: var(--primary-color); }
        .feedback-chip.type-task { color: var(--accent-task); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; align-items: flex-end; justify-content: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.4s var(--ease-out-quint); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal { background: var(--surface); border-radius: 24px 24px 0 0; padding: 16px 24px 24px 24px; width: 100%; max-width: 420px; max-height: 95vh; overflow-y: auto; box-shadow: var(--shadow-layered); transform: translateY(100%); transition: transform 0.4s var(--ease-out-quint); }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-grabber { width: 40px; height: 5px; background-color: var(--outline); border-radius: 2.5px; margin: 0 auto 16px; flex-shrink: 0; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--secondary-color); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1.5px solid var(--outline); border-radius: 10px; background: var(--surface); color: var(--on-surface); font-size: 14px; font-family: var(--font-main); transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent); }
        .form-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 24px; }
        .btn-icon { width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-icon:active { transform: scale(0.9); }
        .btn-icon .material-icons { font-size: 24px; }
        #delete-item-btn { background-color: transparent; color: var(--accent-delete); }
        #delete-item-btn:hover { background-color: color-mix(in srgb, var(--accent-delete) 10%, transparent); }
        #save-item-btn { background-color: var(--primary-color); color: var(--on-primary); box-shadow: 0 4px 12px color-mix(in srgb, var(--primary-color) 30%, transparent); }
        #save-item-btn:hover { background-color: var(--primary-variant); }
        .btn { padding: 10px 20px; border: none; border-radius: 24px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; font-family: var(--font-main); }
        .btn:active { transform: scale(0.95); opacity: 0.9; }
        .btn-primary { background: var(--primary-color); color: var(--on-primary); }
        .btn-secondary { background: transparent; color: var(--secondary-color); border: 1.5px solid var(--outline); }
        .btn-link { background: none; border: none; color: var(--primary-color); font-weight: 500; cursor: pointer; }
        #task-options-group { display: none; }
        .subtask-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .subtask-item input[type="checkbox"] { flex-shrink: 0; width: 20px; height: 20px; accent-color: var(--primary-color); }
        .subtask-item input[type="text"] { flex-grow: 1; font-size: 14px; border: none; background: transparent; border-bottom: 1px solid var(--outline); border-radius: 0; padding: 4px 0; color: var(--on-surface); }
        .subtask-item input[type="text"]:focus { outline: none; border-bottom-color: var(--primary-color); }
        .subtask-item .delete-subtask-btn { color: var(--secondary-color); font-size: 20px; }
        .empty-state { text-align: center; padding: 40px 24px; color: var(--secondary-color); }
        .empty-state .material-icons { font-size: 48px; margin-bottom: 8px; }
        .empty-state .btn { margin-top: 16px; }
        .intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; background-color: #000; transition: opacity 0.5s ease-out; }
        .intro-screen.visible { display: flex; }
        #welcomeImage { width: 250px; height: auto; opacity: 0; animation: growAndFade 2.5s ease-in-out forwards; }
        @keyframes growAndFade { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(8); opacity: 0; } }
        .login-view { position: fixed; inset: 0; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; opacity: 0; transition: opacity .5s, background-color 0.3s; background-color: var(--background); }
        .login-view--visible { display: flex; opacity: 1; }
        .login-view__card { background-color: var(--surface); padding: 2rem 1.5rem; border-radius: 18px; box-shadow: var(--shadow-layered); width: 100%; max-width: 380px; text-align: center; animation: pop-in 0.3s ease-out; border: 1px solid var(--outline); z-index: 10; }
        @keyframes pop-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #toast-container { position: fixed; bottom: calc(60px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none; }
        .toast { background-color: rgba(30, 30, 36, 0.85); backdrop-filter: blur(5px); color: white; padding: 10px 18px; border-radius: 12px; box-shadow: var(--shadow-layered); display: flex; align-items: center; animation: toastFadeIn 0.4s var(--ease-out-quint), toastFadeOut 0.4s 2.6s var(--ease-out-quint); font-size: 14px; }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(10px) scale(0.95); } }
        .tasks-header { display: flex; align-items: center; justify-content: space-between; padding: 0 0 16px 0; }
        .tasks-header .form-select { flex-grow: 1; }
        .tasks-header .icon-button { flex-shrink: 0; margin-left: 8px; }
        .completed-tasks-section { background: var(--surface); padding: 0; border-radius: 10px; margin-top: 24px; border: 1px solid var(--outline); }
        .completed-tasks-section summary { font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center; list-style: none; padding: 12px; }
        .completed-tasks-section summary::-webkit-details-marker { display: none; }
        .completed-tasks-section summary .section-title { margin: 0; font-size: 16px; }
        .completed-tasks-section summary .material-icons { transition: transform 0.2s; }
        .completed-tasks-section[open] > summary .material-icons { transform: rotate(180deg); }
        .completed-tasks-list { padding: 0 12px 12px 12px; }
        .help-section details { background: var(--surface); padding: 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--outline); }
        .help-section summary { font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; list-style: none; }
        .help-section summary::-webkit-details-marker { display: none; }
        .help-section summary .material-icons { transition: transform 0.2s; }
        .help-section details[open] summary .material-icons { transform: rotate(180deg); }
        .help-section .details-content { padding-top: 12px; }
        .help-section ul { padding-left: 20px; list-style-type: none; }
        .help-section li { margin-bottom: 12px; position: relative; padding-left: 28px; }
        .help-section li .material-icons { position: absolute; left: 0; top: 2px; vertical-align: middle; }
        .starry-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(1px 1px at 10% 20%,#fff,transparent),radial-gradient(1px 1px at 80% 30%,#fff,transparent),radial-gradient(2px 2px at 50% 50%,#fff,transparent),radial-gradient(1px 1px at 30% 80%,#fff,transparent),radial-gradient(2px 2px at 90% 90%,#fff,transparent); background-size: 300px 300px; animation: twinkle 15s linear infinite; opacity: 0.7; z-index: 1; }
        @keyframes twinkle { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .login-view__logo { max-width: 90px; height: auto; border-radius: 18px; margin-bottom: 16px; box-shadow: 0 0 25px rgba(255, 255, 255, 0.1); }
        .login-view__title { margin-bottom: 4px; font-size: 20px; font-weight: 800; }
        .login-view__tagline { font-size: 15px; color: var(--secondary-color); margin-bottom: 20px; }
        .form-group--with-icon { position: relative; margin-bottom: 16px; }
        .form-group--with-icon .material-icons { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--secondary-color); pointer-events: none; transition: color 0.2s; }
        .form-group--with-icon .form-input { padding-left: calc(12px * 2 + 24px); }
        .form-group--with-icon .form-input:focus ~ .material-icons { color: var(--primary-color); }
        .login-view__actions { display: flex; justify-content: flex-end; margin-bottom: 16px; }
        .login-view__link { font-size: 14px; color: var(--primary-color); text-decoration: none; font-weight: 600; transition: color 0.2s; }
        .login-view__link:hover { color: var(--primary-variant); text-decoration: underline; }
        .login-view__footer { margin-top: 16px; width: 100%; }
        .btn--full { width: 100%; }
        .spinner { display: inline-block; width: 1em; height: 1em; border: .15em solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin .8s linear infinite; vertical-align: middle; margin-right: 8px; }
        .btn--loading { pointer-events: none; opacity: .8; }
        .form-input--invalid { border-color: var(--accent-delete) !important; box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-delete) 20%, transparent) !important; }
        .form-error { color: var(--accent-delete); font-size: 13px; margin-top: 4px; min-height: 18px; display: block; }
        @media (min-width: 768px) { #app-root, .bottom-nav { max-width: 720px; } body { font-size: 16px; } .modal-overlay { align-items: center; } .modal { border-radius: 24px; transform: translateY(0); max-height: 80vh; } }
        @media (min-width: 1024px) { body { overflow: auto; } #app-root { flex-direction: row; max-width: 100%; height: 100vh; padding-bottom: 0; } .bottom-nav { position: static; transform: none; flex-direction: column; width: auto; max-width: none; height: 100vh; border-top: none; border-right: 1px solid var(--outline); padding: 24px 8px; justify-content: flex-start; gap: 8px; background: var(--surface); backdrop-filter: none; } [data-theme="light"] .bottom-nav { background: var(--surface); } .nav-item { flex: 0; flex-direction: row; justify-content: center; width: 100%; padding: 12px; } .nav-item:hover { background-color: var(--surface-variant); } .nav-item.active { background-color: var(--primary-color); color: var(--on-primary); } [data-theme="dark"] .nav-item.active { background-color: var(--primary-variant); } #toast-container { bottom: 24px; left: calc(50% + 70px); } .main-content { height: 100vh; overflow-y: auto; } #calendarView { flex-direction: row; align-items: flex-start; gap: 24px; padding: 24px; overflow-y: hidden; } .calendar-container { flex: 0 0 400px; border-bottom: none; padding: 0; position: sticky; top: 0; } #agendaListContainer, #weekly-view-container { flex-grow: 1; height: calc(100vh - 48px); overflow-y: auto; } .view#todayView, .view#tasksView, .view#helpView, .view#searchView { max-width: 800px; margin: 0 auto; padding: 32px; } .fab { bottom: 32px; right: 32px; } }
    </style>
    <style id="app-themes">
        /* ======================================= */
        /*      NUEVOS TEMAS PROFESIONALES         */
        /* ======================================= */
        /* --- 1. CYBERPUNK NIGHT (Oscuro Principal) --- */
        [data-theme="cyberpunk-night"] { --primary-color: #00E5FF; --primary-variant: #00B8D4; --secondary-color: #9999A1; --background: #000000; --surface: #0F0F0F; --surface-variant: #1C1C1E; --on-primary: #000000; --on-background: #EAEAEA; --on-surface: #F5F5F5; --outline: #2A2A2D; --accent-event-important: #FF3860; --accent-task: #00FFA3; --accent-event-normal: #5E5CE6; }
        /* --- 2. MIDNIGHT PLUM (Oscuro) --- */
        [data-theme="midnight-plum"] { --primary-color: #C39DFF; --primary-variant: #9A77D9; --background: #191724; --surface: #26233A; --surface-variant: #3E3B5B; --on-background: #E0DEF4; --on-surface: #F7F7F8; --outline: #4A4668; --accent-event-important: #EB6F92; }
        /* --- 3. EVERGREEN (Oscuro) --- */
        [data-theme="evergreen"] { --primary-color: #37EFCB; --primary-variant: #2CA992; --background: #232A2E; --surface: #2E3940; --surface-variant: #435058; --on-background: #E6F1F1; --on-surface: #FFFFFF; --outline: #435058; --accent-event-important: #FFB86C; }
        /* --- 4. PAPERWHITE (Claro) --- */
        [data-theme="paperwhite"] { --primary-color: #005A9C; --primary-variant: #004070; --background: #FBFBFB; --surface: #FFFFFF; --surface-variant: #F0F0F0; --on-background: #212121; --on-surface: #111111; --outline: #DCDCDC; }
        /* --- 5. CORAL SUNSET (Claro) --- */
        [data-theme="coral-sunset"] { --primary-color: #FF6B6B; --primary-variant: #E55050; --background: #FFF6F0; --surface: #FFFFFF; --surface-variant: #FFEAE4; --on-background: #5D4037; --on-surface: #4E342E; --outline: #FFD8C9; }
        /* --- 6. OCEAN BREEZE (Claro) --- */
        [data-theme="ocean-breeze"] { --primary-color: #0096C7; --primary-variant: #0077B6; --background: #EFFBFF; --surface: #FFFFFF; --surface-variant: #E0F7FF; --on-background: #023E7D; --on-surface: #002855; --outline: #ADE8FF; }
    </style>
</head>
<body>
    <div id="welcomeScreen" class="intro-screen"><img src="aiDANaI.webp" id="welcomeImage" alt="Logo Agenda aiDANaI"></div>
    <div id="login-screen" class="login-view">
        <div class="starry-background"></div>
        <div class="login-view__card">
            <img src="aiDANaI.webp" alt="Logo Agenda aiDANaI" class="login-view__logo">
            <h2 id="login-title" class="login-view__title">Bienvenido de nuevo</h2>
            <p class="login-view__tagline">Inicia sesión para organizar tu día.</p>
            <form id="login-form" noValidate>
                <div class="form-group form-group--with-icon">
                    <span class="material-icons">alternate_email</span>
                    <input type="email" id="login-email" class="form-input" placeholder="Correo electrónico" required autoComplete="email" autoCapitalize="none" />
                    <span class="form-error" id="login-email-error"></span>
                </div>
                <div class="form-group form-group--with-icon">
                    <span class="material-icons">lock</span>
                    <input type="password" id="login-password" class="form-input" placeholder="Contraseña" required autoComplete="current-password" />
                    <span class="form-error" id="login-password-error"></span>
                </div>
                <div class="login-view__actions">
                    <a href="#" class="login-view__link" data-action="forgot-password">¿Olvidaste tu contraseña?</a>
                </div>
                <p id="login-error" class="form-error" style="min-height: 18px; margin-bottom: 8px;"></p>
                <div class="login-view__footer">
                    <button type="submit" id="login-submit-btn" class="btn btn-primary btn--full">Iniciar Sesión</button>
                    <button type="button" id="register-btn" class="btn btn-secondary btn--full" style="margin-top: 12px;">Registrarse</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-root">
        <nav class="bottom-nav">
            <button class="nav-item active" data-view="today" title="Hoy"><span class="material-icons">home</span></button>
            <button class="nav-item" data-view="calendar" title="Agenda"><span class="material-icons">calendar_today</span></button>
            <button class="nav-item" data-view="tasks" title="Tareas"><span class="material-icons">task_alt</span></button>
            <button class="nav-item" data-view="help" title="Ayuda"><span class="material-icons">help_outline</span></button>
            <button class="nav-item" id="nav-theme-btn" title="Cambiar Tema"><span class="material-icons">palette</span></button>
            <button class="nav-item" id="google-sync-btn" title="Conectar con Google Calendar" disabled><span class="material-icons">sync</span></button>
            <button class="nav-item" data-action="logout" title="Salir de la App"><span class="material-icons">logout</span></button>
        </nav>

        <main class="main-content" id="main-content-area">
            <div id="todayView" class="view active">
                <h1 id="today-greeting"></h1>
                <h3 class="section-title" id="today-events-title">Eventos de Hoy</h3>
                <div id="today-events-list"></div>
                <div id="empty-today-events" class="empty-state" style="display: none;">
                    <span class="material-icons">celebration</span>
                    <p>No tienes eventos para hoy. ¡Disfruta del día!</p>
                    <button class="btn btn-primary" data-action="quick-add">Añadir Evento o Tarea</button>
                </div>
                <h3 class="section-title" id="today-tasks-title">Tareas Pendientes</h3>
                <div id="today-tasks-list"></div>
                <div id="empty-today-tasks" class="empty-state" style="display: none;">
                    <span class="material-icons">check_circle</span>
                    <p>¡Ninguna tarea pendiente! Bien hecho.</p>
                    <button class="btn btn-primary" data-action="quick-add">Añadir Nueva Tarea</button>
                </div>
                <h3 class="section-title" id="tomorrow-events-title">Mañana te espera...</h3>
                <div id="tomorrow-events-list"></div>
                <div id="empty-tomorrow-events" class="empty-state" style="display: none;"><span class="material-icons">event_upcoming</span><p>Nada programado para mañana todavía.</p></div>
            </div>

            <div id="calendarView" class="view">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-title-container">
                            <button id="calendar-title-btn" title="Seleccionar mes y año"></button>
                            <span id="sync-status-indicator"></span>
                        </div>
                        <div class="calendar-nav">
                            <button id="search-toggle-btn" class="icon-button" title="Buscar"><span class="material-icons">search</span></button>
                            <div class="view-toggle">
                                <button id="month-view-btn" class="btn-toggle active" data-mode="month" title="Vista Mensual"><span class="material-icons">calendar_month</span></button>
                                <button id="week-view-btn" class="btn-toggle" data-mode="week" title="Vista Semanal"><span class="material-icons">view_week</span></button>
                            </div>
                            <button id="today-btn" class="icon-button" title="Ir a Hoy en el Calendario"><span class="material-icons">today</span></button>
                            <button id="prev-nav-btn" class="icon-button" title="Mes anterior"><span class="material-icons">chevron_left</span></button>
                            <button id="next-nav-btn" class="icon-button" title="Mes siguiente"><span class="material-icons">chevron_right</span></button>
                        </div>
                    </div>
                    <div id="search-container">
                        <form id="search-form"><input type="search" id="search-input" placeholder="Buscar y pulsar Enter..."><button type="submit" class="btn btn-primary" style="padding: 8px 12px; border-radius: 50%; width: 40px; height: 40px;"><span class="material-icons">search</span></button></form>
                    </div>
                    <div id="calendar-grid" class="calendar-grid"><div class="calendar-weekdays" id="calendarWeekdays"></div><div class="calendar-days" id="calendarDays"></div></div>
                </div>
                <div class="agenda-list-container" id="agendaListContainer"><div id="agendaList"></div></div>
                <div id="weekly-view-container" class="weekly-view-container"></div>
            </div>

            <div id="tasksView" class="view">
                <div class="tasks-header">
                    <select id="task-list-filter" class="form-select"></select>
                    <button id="manage-lists-btn" class="icon-button" title="Gestionar Listas"><span class="material-icons">playlist_add</span></button>
                </div>
                <div id="tasks-content"></div>
                <div id="emptyTasks" class="empty-state" style="display: none;">
                    <span class="material-icons">check_circle_outline</span>
                    <p>No tienes tareas en esta lista.</p>
                    <button class="btn btn-primary" data-action="quick-add">Añadir tu primera tarea</button>
                </div>
            </div>

            <div id="searchView" class="view">
                <h3 class="section-title" id="search-results-title">Resultados de la Búsqueda</h3>
                <div id="searchResultsList"></div>
                <div id="emptySearch" class="empty-state" style="display: none;"><span class="material-icons">search_off</span><p>No se encontraron resultados.</p></div>
            </div>

            <div id="helpView" class="view">
                <div class="help-section">
                    <h2 class="section-title" style="font-size: 20px; margin-top: 0;"><span><span class="material-icons">rocket_launch</span>Bienvenido a tu Segundo Cerebro</span></h2>
                    <p style="padding: 0 4px 16px; font-size: 15px; color: var(--secondary-color);">aiDANaI es un espacio inteligente diseñado para que tus ideas se conviertan en realidad. Olvida el desorden; aquí, cada plan tiene su lugar y cada meta es alcanzable. ¡Esta guía te convertirá en un maestro de la productividad!</p>

                    <details open>
                        <summary>Conceptos Clave: Eventos vs. Tareas<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Para organizar tu vida, aiDANaI utiliza dos tipos de ítems:</p>
                            <ul>
                                <li>
                                    <span class="material-icons" style="color: var(--accent-event-normal);">event</span>
                                    <b>Eventos:</b> Tienen una fecha y hora específicas. Son bloques fijos en tu calendario. <i>Ej: "Cena con mamá el viernes a las 21:00".</i>
                                </li>
                                <li>
                                    <span class="material-icons" style="color: var(--accent-task);">task_alt</span>
                                    <b>Tareas:</b> Son tus "pendientes" sin una hora fija. Son las acciones que debes realizar. <i>Ej: "Comprar el regalo de cumpleaños de Ana".</i>
                                </li>
                            </ul>
                        </div>
                    </details>
                    <details>
                        <summary>Entendiendo la Sincronización: ¿Dónde están mis datos? ☁️<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Es muy importante que sepas dónde se guarda tu información para tu tranquilidad:</p>
                            <ul>
                                <li>
                                    <span class="material-icons" style="color: var(--accent-task);">task_alt</span>
                                    <b>Las Tareas se guardan ÚNICAMENTE en tu cuenta de aiDANaI (Firebase).</b> Nunca se sincronizan con Google Calendar. Son tu espacio personal de productividad.
                                </li>
                                <li>
                                    <span class="material-icons" style="color: var(--accent-event-normal);">event</span>
                                    <b>Los Eventos tienen un doble sistema de guardado:</b>
                                    <ol style="list-style-type: lower-alpha; padding-left: 20px; margin-top: 8px;">
                                        <li><b>Siempre se guardan en tu cuenta de aiDANaI (Firebase).</b> Esta es la copia de seguridad principal.</li>
                                        <li>Opcionalmente, se pueden sincronizar con <b>Google Calendar</b> si activas la conexión.</li>
                                    </ol>
                                </li>
                            </ul>
                            <p style="margin-top: 12px;">Para que sepas el estado de cada evento en todo momento, verás estos iconos:</p>
                            <ul>
                                <li>
                                    <span class="material-icons aidanai-only-icon">cloud_done</span>
                                    <b>Guardado en aiDANaI:</b> El evento está seguro en tu cuenta, pero no se ha copiado en Google Calendar.
                                </li>
                                <li>
                                    <span class="material-icons google-cal-icon">event_available</span>
                                    <b>Guardado en aiDANaI y Google Calendar:</b> El evento está sincronizado en ambos sitios. Cualquier cambio que hagas en un lugar se reflejará en el otro en la siguiente sincronización.
                                </li>
                            </ul>
                        </div>
                    </details>
                    <details>
                        <summary>Creación Rápida con IA ✨<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Pulsa el botón flotante <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: var(--primary-color); color: var(--on-primary); border-radius: 50%; vertical-align: middle;"><span class="material-icons" style="font-size: 20px;">add</span></span> y habla con tu agenda en lenguaje humano. La IA entiende el contexto:</p>
                            <ul>
                                <li><span class="material-icons">arrow_right</span>"<u>Reunión de marketing mañana a las 10:30</u>" <b>→</b> Crea un <b>Evento</b>.</li>
                                <li><span class="material-icons">arrow_right</span>"<u>Comprar leche, pan y huevos</u>" <b>→</b> Crea una <b>Tarea</b>.</li>
                                <li><span class="material-icons">arrow_right</span>"<u>Llamar al dentista el próximo viernes</u>" <b>→</b> Crea un <b>Evento</b> para ese día, sin hora.</li>
                            </ul>
                            <p><b>Consejo Pro:</b> Si la IA interpreta algo y quieres ajustarlo, pulsa "Editar Detalles" antes de guardar para tener control total.</p>
                        </div>
                    </details>
                    <details>
                        <summary>Gestos que Ahorran Tiempo 🤸<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Interactúa con tus ítems usando gestos rápidos para maximizar tu eficiencia:</p>
                            <ul>
                                <li>
                                    <span class="material-icons" style="color: var(--accent-edit);">touch_app</span>
                                    <b>TOCAR EL TEXTO:</b> Abre la ventana de <b>edición avanzada</b> para modificar todos los detalles.
                                </li>
                                <li>
                                    <span class="material-icons" style="color: var(--accent-delete);">arrow_back</span>
                                    <b>DESLIZAR A LA IZQUIERDA:</b> Muestra la opción de <b>eliminar</b> el ítem. ¡Úsalo con cuidado!
                                </li>
                                <li>
                                    <span class="material-icons" style="color: var(--accent-complete);">arrow_forward</span>
                                    <b>DESLIZAR A LA DERECHA:</b> Marca el ítem (sea Tarea o Evento) como <b>completado</b>.
                                </li>
                            </ul>
                        </div>
                    </details>
                    <details>
                        <summary>Las 4 Vistas Principales<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Navega con la barra inferior para acceder a las secciones clave:</p>
                            <ul>
                                <li>
                                    <span class="material-icons">home</span>
                                    <b>Hoy:</b> Un resumen perfecto de tu presente y futuro inmediato: eventos de hoy, tareas pendientes y un vistazo a mañana.
                                </li>
                                <li>
                                    <span class="material-icons">calendar_today</span>
                                    <b>Agenda:</b> Tu calendario completo, con vista mensual (para planificación a largo plazo) y semanal (para detalles).
                                </li>
                                <li>
                                    <span class="material-icons">task_alt</span>
                                    <b>Tareas:</b> El centro de tus proyectos. Organiza tus tareas en listas personalizadas (trabajo, casa, etc.) y divídelas en subtareas con barras de progreso.
                                </li>
                                <li>
                                    <span class="material-icons">help_outline</span>
                                    <b>Ayuda:</b> ¡La sección donde te encuentras ahora mismo!
                                </li>
                            </ul>
                        </div>
                    </details>
                    <details>
                        <summary>Edición Avanzada y Funciones Pro<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>Al tocar el texto de un ítem, accedes al modo de edición avanzada. Aquí puedes:</p>
                             <ul>
                                <li><span class="material-icons">palette</span>Asignar un evento como <b>Importante</b> para que destaque en rojo.</li>
                                <li><span class="material-icons">notifications_active</span>Configurar <b>notificaciones</b> para que te avisemos con antelación.</li>
                                <li><span class="material-icons">repeat</span>Establecer <b>recurrencia</b> (diaria, semanal, etc.) para eventos repetitivos.</li>
                                <li><span class="material-icons">playlist_add_check</span>Asignar tareas a tus <b>listas</b> y añadir <b>sub-tareas</b>.</li>
                                <li><span class="material-icons">search</span>Usar la <b>búsqueda global</b> en la vista de Agenda para encontrar cualquier ítem.</li>
                            </ul>
                        </div>
                    </details>
                    <p style="text-align: center; color: var(--secondary-color); margin-top: 24px; font-size: 14px;">¡Ya está! Ahora tienes todo el conocimiento para que aiDANaI trabaje para ti. Explora, experimenta y convierte tus planes en logros. 😉</p>
                </div>

                <div class="help-section" style="margin-top: 24px;">
                    <h2 class="section-title" style="font-size: 20px;">
                        <span><span class="material-icons">palette</span> Personaliza tu Interfaz</span>
                    </h2>
                    <p style="padding: 0 4px 16px; font-size: 15px; color: var(--secondary-color);">
                        Elige el tema que mejor se adapte a tu estilo. Tu selección se guardará automáticamente.
                    </p>
                    <div id="theme-selector" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        <!-- Los temas se generan aquí con JS -->
                    </div>
                </div>
            </div>
        </main>
        <button id="fab-add-item" class="fab" title="Añadir ítem">
            <span class="material-icons">add</span>
        </button>
    </div>

    <!-- Modales -->
    <div id="quick-add-modal" class="modal-overlay"> <div class="modal"> <div class="modal-grabber"></div> <form id="quick-add-form"> <div class="form-group"> <label class="form-label" for="quick-add-input">Creación Rápida con IA ✨</label> <textarea class="form-textarea" id="quick-add-input" placeholder="Ej: 'Reunión con el equipo mañana a las 10:30'..." rows="3"></textarea> <div id="quick-add-feedback"></div> </div> <div class="form-actions"> <button type="button" class="btn-link" id="open-advanced-editor-btn">Editar Detalles</button> <div> <button type="button" class="btn btn-secondary" id="cancel-quick-add-btn">Cancelar</button> <button type="submit" class="btn btn-primary" id="save-quick-add-btn">Añadir</button> </div> </div> </form> </div> </div>
    <div id="add-item-modal" class="modal-overlay"> <div class="modal"> <div class="modal-grabber"></div> <form id="add-item-form"> <input type="hidden" id="item-local-id"> <div class="form-group"><label class="form-label" for="item-description">Descripción</label><textarea class="form-textarea" id="item-description" placeholder="Describe el ítem..." rows="3"></textarea></div> <div class="form-group"><label class="form-label" for="item-type">Tipo</label><select class="form-select" id="item-type"><option value="agenda">Evento (con fecha)</option><option value="task">Tarea (sin fecha)</option></select></div> <div id="task-options-group"> <div class="form-group"><label class="form-label" for="item-task-list">Lista de Tareas</label><select class="form-select" id="item-task-list"></select></div> <div class="form-group"> <label class="form-label">Sub-tareas</label> <div id="subtasks-container"></div> <div id="add-subtask-controls" style="display: flex; gap: 8px;"> <input type="text" id="new-subtask-input" class="form-input" placeholder="Añadir sub-tarea y pulsar Enter..."> <button type="button" id="add-subtask-btn" class="btn-icon" style="background:var(--primary-color); color: var(--on-primary); flex-shrink:0;"><span class="material-icons">add</span></button> </div> </div> </div> <div id="datetime-notification-group"> <div class="form-group"><label class="form-label" for="item-datetime">Fecha y Hora</label><input type="text" class="form-input" id="item-datetime" placeholder="Selecciona fecha y hora..."></div> <div id="event-options" style="margin-top: 12px;"> <div class="form-group" style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="item-all-day"><label for="item-all-day">Todo el día</label></div> <div class="form-group" style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="item-important"><label for="item-important">Marcar como importante (Rojo)</label></div> <div class="form-group" style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="item-notification-enabled"><label for="item-notification-enabled">Activar notificación</label></div> <div class="form-group" id="reminder-time-group" style="display: none; margin-top: 12px;"> <label class="form-label" for="item-reminder">Avisarme...</label> <select class="form-select" id="item-reminder"><option value="0">Justo a la hora</option><option value="5">5 minutos antes</option><option value="15">15 minutos antes</option><option value="30">30 minutos antes</option><option value="60">1 hora antes</option></select> </div> <div class="form-group" style="margin-top: 12px;"><label class="form-label" for="item-recurrence">Repetir</label><select class="form-select" id="item-recurrence"><option value="none">No repetir</option><option value="daily">Diariamente</option><option value="weekly">Semanalmente</option><option value="monthly">Mensualmente</option><option value="yearly">Anualmente</option></select></div> </div> </div> <div class="form-actions"> <button type="button" class="btn-icon" id="delete-item-btn" style="display: none;" title="Eliminar"><span class="material-icons">delete</span></button> <button type="button" class="btn btn-secondary" id="cancel-item-btn">Cancelar</button> <button type="submit" class="btn-icon" id="save-item-btn" title="Guardar"><span class="material-icons">check</span></button> </div> </form> </div> </div>
    <div id="manage-lists-modal" class="modal-overlay"> <div class="modal"> <div class="modal-grabber"></div> <h3 class="section-title">Gestionar Listas de Tareas</h3> <div id="task-lists-editor"></div> <form id="add-list-form" style="display:flex; gap:8px; margin-top:16px;"> <input type="text" id="new-list-name" class="form-input" placeholder="Nombre de nueva lista..." required> <button type="submit" class="btn btn-primary">Añadir</button> </form> <div class="form-actions" style="justify-content:flex-end;"> <button type="button" class="btn btn-secondary" id="close-manage-lists-btn">Cerrar</button> </div> </div> </div>
    <div id="date-picker-modal" class="modal-overlay"><div class="modal"><div class="modal-grabber"></div><form id="date-picker-form"><div class="form-group"><label class="form-label">Mes</label><select id="month-select" class="form-select"></select></div><div class="form-group"><label class="form-label">Año</label><input type="number" id="year-select" min="2020" max="2030" step="1" class="form-input"></div><div style="display:flex; gap:12px; margin-top:24px;"><button type="button" class="btn btn-secondary" id="cancel-date-picker-btn">Cancelar</button><button type="submit" class="btn btn-primary">Ir</button></div></form></div></div>
    <div id="toast-container"></div>
    <div id="custom-confirm-modal" class="modal-overlay"> <div class="modal"> <div class="modal-grabber"></div> <p id="confirm-message" style="margin-bottom: 24px; text-align: center; font-size: 16px;"></p> <div class="form-actions" style="justify-content: center; gap: 16px;"> <button type="button" class="btn btn-secondary" id="confirm-cancel-btn">Cancelar</button> <button type="button" class="btn btn-primary" id="confirm-ok-btn">Confirmar</button> </div> </div> </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, enableIndexedDbPersistence, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- CONFIGURACIÓN REQUERIDA ---
        const GOOGLE_CLIENT_ID = '364074046164-bb80vb1bodaaj7rc2i9e7520l9hp8klo.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyD_EI1odi7jWdv7vSGkc58KCoSOJedt8uY';
        const firebaseConfig = { apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", authDomain: "cuentas-aidanai.firebaseapp.com", projectId: "cuentas-aidanai", storageBucket: "cuentas-aidanai.appspot.com", messagingSenderId: "58244686591", appId: "1:58244686591:web:85c87256c2287d350322ca" };

        const CONSTANTS = { VIEWS: { TODAY: 'today', CALENDAR: 'calendar', TASKS: 'tasks', HELP: 'help', SEARCH: 'search' }, ITEM_TYPES: { AGENDA: 'agenda', TASK: 'task' }, ANIMATION_CLASSES: { ITEM_ENTERING: 'item-entering', ITEM_EXITING: 'item-exiting' } };
        const THEMES = { 'cyberpunk-night': { name: 'Cyberpunk Night', bg: '#000000', color: '#00E5FF' }, 'midnight-plum': { name: 'Midnight Plum', bg: '#191724', color: '#C39DFF' }, 'evergreen': { name: 'Evergreen', bg: '#232A2E', color: '#37EFCB' }, 'paperwhite': { name: 'Paperwhite', bg: '#FBFBFB', color: '#005A9C' }, 'coral-sunset': { name: 'Coral Sunset', bg: '#FFF6F0', color: '#FF6B6B' }, 'ocean-breeze': { name: 'Ocean Breeze', bg: '#EFFBFF', color: '#0096C7' } };
        const THEME_CYCLE_ORDER = ['cyberpunk-night', 'midnight-plum', 'evergreen', 'paperwhite', 'coral-sunset', 'ocean-breeze'];
        const GOOGLE_DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const GOOGLE_SCOPES = "https://www.googleapis.com/auth/calendar.events";
        const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const MESES_CORTOS = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        const DIAS_SEMANA_LARGOS = ['lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo'];
        const DIAS_SEMANA_CORTOS = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
        const VIEW_ORDER = ['today', 'calendar', 'tasks', 'help'];

        let appState = { currentView: 'today', lastView: 'today', calendar: { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), selectedDate: dateToYYYYMMDD(new Date()), displayMode: 'month' }, tasks: { selectedListId: 'default' } };
        let googleAuthInstance, flatpickrInstance = null, currentUser = null, unsubscribeFromDb = null, saveTimeout = null;
        let db = {}; let activeTimers = {}; let newlyCreatedItemId = null; let originalButtonTexts = new Map();
        let isGoogleSignedIn = false, isAppInitialized = false, isViewSwitching = false, isSyncingWithGoogle = false;
        
        const gebi = id => document.getElementById(id);
        const qsa = selector => document.querySelectorAll(selector);
        function dateToYYYYMMDD(date) { if (!date || isNaN(date.getTime())) return ''; return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; }
        function dateToHHMM(date) { if (!date || isNaN(date.getTime())) return "00:00"; return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`; }
        function yyyymmddToDate(dateStr) { if (!dateStr) return new Date(); const parts = dateStr.split('-'); return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10)); }
        function uuid() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
        function triggerHapticFeedback(type = 'light') { if ('vibrate' in navigator) { switch (type) { case 'light': navigator.vibrate(10); break; case 'medium': navigator.vibrate(40); break; case 'success': navigator.vibrate([20, 50, 20]); break; default: navigator.vibrate(10); } } }
        function debounce(func, delay = 250) { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => { func.apply(this, args); }, delay); }; }
        function showToast(message, isError = false) { const container = gebi('toast-container'); if (!container) return; const toast = document.createElement('div'); toast.className = 'toast'; if (isError) { toast.style.backgroundColor = 'var(--accent-delete)'; } toast.textContent = message; container.appendChild(toast); setTimeout(() => toast.remove(), 3000); }
        const setButtonLoading = (btn, isLoading, text = 'Cargando...') => { if (!btn) return; if (isLoading) { if (!originalButtonTexts.has(btn)) { originalButtonTexts.set(btn, btn.innerHTML); } btn.disabled = true; btn.classList.add('btn--loading'); btn.innerHTML = `<span class="spinner"></span> <span>${text}</span>`; } else { btn.disabled = false; btn.classList.remove('btn--loading'); if (originalButtonTexts.has(btn)) { btn.innerHTML = originalButtonTexts.get(btn); originalButtonTexts.delete(btn); } } };
        const displayError = (elementId, message) => { const errorElement = gebi(`${elementId}-error`); if (errorElement) { errorElement.textContent = message; } const inputElement = gebi(elementId); if (inputElement) { inputElement.classList.add('form-input--invalid'); } };
        const clearAllErrors = (formId) => { const form = gebi(formId); if (!form) return; form.querySelectorAll('.form-error').forEach(el => el.textContent = ''); form.querySelectorAll('.form-input--invalid').forEach(el => el.classList.remove('form-input--invalid')); const generalErrorEl = gebi('login-error'); if(generalErrorEl) generalErrorEl.textContent = ''; };
        
        const app = initializeApp(firebaseConfig);
        const fbAuth = getAuth(app);
        const fbDb = getFirestore(app);
        setPersistence(fbAuth, browserSessionPersistence);
        enableIndexedDbPersistence(fbDb).catch(err => { if (err.code == 'failed-precondition') { console.warn("Persistencia offline falló: Múltiples pestañas abiertas."); } else if (err.code == 'unimplemented') { console.warn("Persistencia offline no soportada en este navegador."); } });
        // MODIFICADO: Añadido googleSyncToken a la configuración inicial.
        const getInitialDb = () => ({ items: [], taskLists: [{ id: 'default', name: 'General' }], config: { theme: 'cyberpunk-night', tutorialCompleted: false, googleSyncToken: null } });
        const saveData = () => new Promise((resolve, reject) => { if (!currentUser) { return reject(new Error("Usuario no autenticado. No se puede guardar.")); } clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { const userDocRef = doc(fbDb, 'users', currentUser.uid); setDoc(userDocRef, { db }).then(() => { console.log("Sincronización con Firebase exitosa."); resolve(); }).catch(error => { console.error("Error al guardar en Firestore:", error); reject(error); }); }, 500); });
        const loadData = (uid) => { const userDocRef = doc(fbDb, 'users', uid); if (unsubscribeFromDb) { unsubscribeFromDb(); } unsubscribeFromDb = onSnapshot(userDocRef, docSnapshot => { let needsInitialSave = false; if (docSnapshot.exists() && docSnapshot.data().db) { db = docSnapshot.data().db; if (!db.items) { db.items = []; needsInitialSave = true; } if (!db.config || !db.config.theme) { db.config = { theme: 'cyberpunk-night', tutorialCompleted: false, googleSyncToken: null, ...db.config }; needsInitialSave = true; } if (db.config.tutorialCompleted === undefined) { db.config.tutorialCompleted = false; needsInitialSave = true; } if (db.config.googleSyncToken === undefined) { db.config.googleSyncToken = null; needsInitialSave = true;} if (!db.taskLists || db.taskLists.length === 0) { db.taskLists = [{ id: 'default', name: 'General' }]; needsInitialSave = true; } } else { db = getInitialDb(); needsInitialSave = true; } if (needsInitialSave && currentUser) { saveData().catch(err => showToast("No se pudo guardar la configuración inicial.", true)); } if (!isAppInitialized) { startMainApp(); } renderApp(); }, error => { console.error("Error de conexión con Firestore:", error); showToast("Error de conexión con la base de datos.", true); }); };

        function applyTheme(theme) { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); }
        function handleThemeChange(newTheme, toastMessage) { db.config.theme = newTheme; applyTheme(newTheme); saveData().catch(err => showToast("No se pudo guardar el tema.", true)); triggerHapticFeedback('light'); if (toastMessage) showToast(toastMessage); }
        function handleThemeToggle() { const currentTheme = document.documentElement.getAttribute('data-theme') || THEME_CYCLE_ORDER[0]; const currentIndex = THEME_CYCLE_ORDER.indexOf(currentTheme); const nextIndex = (currentIndex + 1) % THEME_CYCLE_ORDER.length; const newTheme = THEME_CYCLE_ORDER[nextIndex]; handleThemeChange(newTheme, `Tema: ${THEMES[newTheme].name}`); }
        function renderThemeSelector() { const container = gebi('theme-selector'); if (!container) return; container.innerHTML = Object.entries(THEMES).map(([id, theme]) => `<button class="theme-option" data-theme="${id}" style="background-color: ${theme.bg}; color: ${theme.color}; border: 2px solid ${theme.color}; padding: 16px 8px; border-radius: 12px; font-weight: 500; cursor: pointer; text-align: center; transition: all 0.2s;">${theme.name}</button>`).join(''); container.querySelectorAll('.theme-option').forEach(btn => { btn.addEventListener('click', () => { handleThemeChange(btn.dataset.theme, `Tema '${THEMES[btn.dataset.theme].name}' aplicado.`); }); }); }

        function initApp() { const welcomeScreen = gebi('welcomeScreen'); const welcomeImage = gebi('welcomeImage'); welcomeScreen.classList.add('visible'); welcomeImage.addEventListener('animationend', () => { welcomeScreen.style.opacity = '0'; welcomeScreen.addEventListener('transitionend', () => { welcomeScreen.style.display = 'none'; checkAuthState(); }, { once: true }); }, { once: true }); attachGlobalEventListeners(); initializeDatePicker(); updateSyncStatus(); if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(reg => console.log('Service Worker registrado con éxito:', reg)).catch(err => console.log('Error en el registro del Service Worker:', err)); }); } }
        const checkAuthState = () => onAuthStateChanged(fbAuth, user => { if (user) { currentUser = user; loadData(user.uid); } else { currentUser = null; isAppInitialized = false; if (unsubscribeFromDb) unsubscribeFromDb(); db = getInitialDb(); showLoginScreen(); } });
        const startMainApp = () => { if (isAppInitialized) return; isAppInitialized = true; applyTheme(db.config.theme || 'cyberpunk-night'); gebi('login-screen').classList.remove('login-view--visible'); const appRoot = gebi('app-root'); appRoot.classList.add('visible'); updateNav(appState.currentView); appRoot.querySelector('.view.active')?.classList.remove('active'); appRoot.querySelector(`#${appState.currentView}View`).classList.add('active'); renderThemeSelector(); scheduleAllNotifications(); if (!db.config.tutorialCompleted) { setTimeout(startOnboardingTutorial, 500); } };
        const showLoginScreen = () => { applyTheme(localStorage.getItem('theme') || 'cyberpunk-night'); gebi('app-root').classList.remove('visible'); gebi('login-screen').classList.add('login-view--visible'); const emailInput = gebi('login-email'); const passwordInput = gebi('login-password'); if (emailInput) emailInput.value = ''; if (passwordInput) passwordInput.value = ''; clearAllErrors('login-form'); };
        const handleAuthError = (error, submitterBtn) => { clearAllErrors('login-form'); setButtonLoading(submitterBtn, false); triggerHapticFeedback('medium'); const loginErrorEl = gebi('login-error'); switch (error.code) { case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': loginErrorEl.textContent = 'Error: Credenciales incorrectas.'; displayError('login-email', ''); displayError('login-password', ''); break; case 'auth/invalid-email': displayError('login-email', 'Formato de correo no válido.'); break; case 'auth/email-already-in-use': displayError('login-email', 'El correo ya está registrado.'); break; case 'auth/weak-password': displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); break; default: loginErrorEl.textContent = 'Ocurrió un error. Inténtalo de nuevo.'; console.error("Error de autenticación no manejado:", error); break; } };
        const handleLogin = async (btn) => { clearAllErrors('login-form'); const email = (gebi('login-email')).value.trim(); const password = (gebi('login-password')).value; let isValid = true; if (!email) { displayError('login-email', 'El correo es obligatorio.'); isValid = false; } if (!password) { displayError('login-password', 'La contraseña es obligatoria.'); isValid = false; } if (!isValid) { triggerHapticFeedback('error'); gebi('login-error').textContent = 'Por favor, revisa los campos marcados.'; return; } setButtonLoading(btn, true, 'Iniciando...'); try { await signInWithEmailAndPassword(fbAuth, email, password); showToast(`¡Bienvenido/a de nuevo!`); } catch (error) { handleAuthError(error, btn); } finally { setButtonLoading(btn, false); } };
        const handleRegister = async (btn) => { clearAllErrors('login-form'); const email = (gebi('login-email')).value.trim(); const password = (gebi('login-password')).value; let isValid = true; if (!email) { displayError('login-email', 'El correo es obligatorio.'); isValid = false; } if (password.length < 6) { displayError('login-password', 'La contraseña debe tener al menos 6 caracteres.'); isValid = false; } if (!isValid) { triggerHapticFeedback('error'); gebi('login-error').textContent = 'Por favor, revisa los campos marcados.'; return; } setButtonLoading(btn, true, 'Registrando...'); try { await createUserWithEmailAndPassword(fbAuth, email, password); showToast(`¡Registro completado!`); } catch (error) { handleAuthError(error, btn); } };

        function renderApp() { if (!db || !currentUser || !isAppInitialized) return; updateNav(appState.currentView); renderCurrentView(); }
        function renderCurrentView() { const { currentView } = appState; if (currentView === 'today') renderTodayView(); if (currentView === 'calendar') renderCalendarView(); if (currentView === 'tasks') renderTaskListView(); if (currentView === 'search') renderSearchView(gebi('search-input').value); }
        function updateNav(currentView) { qsa('.nav-item[data-view]').forEach(item => { item.classList.toggle('active', item.dataset.view === currentView); }); }
        function renderTodayView() { const hours = new Date().getHours(); const greeting = hours < 12 ? "Buenos días" : hours < 20 ? "Buenas tardes" : "Buenas noches"; gebi('today-greeting').textContent = greeting; const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0); const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999); const tomorrowStart = new Date(todayStart); tomorrowStart.setDate(tomorrowStart.getDate() + 1); const tomorrowEnd = new Date(todayEnd); tomorrowEnd.setDate(tomorrowEnd.getDate() + 1); const todayEvents = db.items.filter(i => i.type === 'agenda' && !i.isComplete && i.dueDate && new Date(i.dueDate) >= todayStart && new Date(i.dueDate) <= todayEnd).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)); const pendingTasks = db.items.filter(i => i.type === 'task' && !i.isComplete).sort((a,b) => a.createdAt - b.createdAt); const tomorrowEvents = db.items.filter(i => i.type === 'agenda' && !i.isComplete && i.dueDate && new Date(i.dueDate) >= tomorrowStart && new Date(i.dueDate) <= tomorrowEnd).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)); const renderListWithEmptyState = (containerId, emptyStateId, titleId, items) => { const container = gebi(containerId); const emptyState = gebi(emptyStateId); const title = gebi(titleId); container.innerHTML = ''; if (items.length > 0) { items.forEach(item => container.appendChild(createUniversalListItemNode(item))); emptyState.style.display = 'none'; title.style.display = 'flex'; } else { emptyState.style.display = 'block'; title.style.display = 'none'; } }; renderListWithEmptyState('today-events-list', 'empty-today-events', 'today-events-title', todayEvents); renderListWithEmptyState('today-tasks-list', 'empty-today-tasks', 'today-tasks-title', pendingTasks); renderListWithEmptyState('tomorrow-events-list', 'empty-tomorrow-events', 'tomorrow-events-title', tomorrowEvents); }
        function renderCalendarView() { const { calendar } = appState; const { items } = db; const { currentMonth, currentYear, selectedDate, displayMode } = calendar; gebi('calendar-title-btn').textContent = `${MESES_CORTOS[currentMonth]} ${currentYear}`; gebi('calendarView').dataset.displayMode = displayMode; qsa('.view-toggle .btn-toggle').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === displayMode)); if (displayMode === 'month') { renderMonthGrid(currentMonth, currentYear, selectedDate, items); renderAgendaFromSelectedDay(items, selectedDate); } else { renderWeekGrid(currentMonth, currentYear, selectedDate, items); } }
        function renderMonthGrid(currentMonth, currentYear, selectedDate, items) { const weekdaysContainer = gebi('calendarWeekdays'); if (weekdaysContainer.innerHTML.length < 5) { weekdaysContainer.innerHTML = DIAS_SEMANA_CORTOS.map((day) => `<div class="weekday">${day}</div>`).join(''); } const calendarDays = gebi('calendarDays'); calendarDays.innerHTML = ''; const firstDayOfMonth = new Date(currentYear, currentMonth, 1); const offset = (firstDayOfMonth.getDay() + 6) % 7; const startDate = new Date(firstDayOfMonth); startDate.setDate(startDate.getDate() - offset); const todayStr = dateToYYYYMMDD(new Date()); const dailyEventMarkers = new Map(); items.filter(it => it.type === 'agenda' && it.dueDate && !it.isComplete).forEach(it => { const dateStr = dateToYYYYMMDD(new Date(it.dueDate)); if (!dailyEventMarkers.has(dateStr)) dailyEventMarkers.set(dateStr, { hasImportant: false, hasNormal: false }); const marker = dailyEventMarkers.get(dateStr); if (it.isImportant) marker.hasImportant = true; else marker.hasNormal = true; }); for (let i = 0; i < 42; i++) { const cellDate = new Date(startDate); cellDate.setDate(startDate.getDate() + i); const dateStr = dateToYYYYMMDD(cellDate); const dayEl = document.createElement('div'); dayEl.className = 'calendar-day'; dayEl.dataset.date = dateStr; if (cellDate.getMonth() !== currentMonth) { dayEl.classList.add('other-month'); } if (dateStr === todayStr) { dayEl.classList.add('today'); } if (dateStr === selectedDate) { dayEl.classList.add('selected'); } let dotsHtml = ''; if (dailyEventMarkers.has(dateStr)) { const markers = dailyEventMarkers.get(dateStr); dotsHtml = `<div class="event-dots-container">${markers.hasImportant ? '<span class="event-dot important"></span>' : ''}${markers.hasNormal ? '<span class="event-dot normal"></span>' : ''}</div>`; } dayEl.innerHTML = `<span class="day-number">${cellDate.getDate()}</span>${dotsHtml}`; dayEl.dataset.action = 'selectDate'; calendarDays.appendChild(dayEl); } }
        function renderWeekGrid(currentMonth, currentYear, selectedDateStr, items) { const weeklyViewContainer = gebi('weekly-view-container'); weeklyViewContainer.innerHTML = ''; const selectedDate = yyyymmddToDate(selectedDateStr); const startOfWeek = new Date(selectedDate); startOfWeek.setDate(selectedDate.getDate() - ((selectedDate.getDay() + 6) % 7)); for (let i = 0; i < 7; i++) { const day = new Date(startOfWeek); day.setDate(startOfWeek.getDate() + i); const dayStr = dateToYYYYMMDD(day); const eventsForDay = items.filter(item => item.type === 'agenda' && !item.isComplete && item.dueDate && dateToYYYYMMDD(new Date(item.dueDate)) === dayStr ).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)); const daySection = document.createElement('div'); daySection.className = 'weekly-day-section'; daySection.innerHTML = ` <div class="weekly-day-header"> <span class="material-icons">${dayStr === dateToYYYYMMDD(new Date()) ? 'today' : 'event'}</span> ${DIAS_SEMANA_LARGOS[day.getDay() === 0 ? 6 : day.getDay() - 1]} ${day.getDate()} de ${MESES[day.getMonth()]} </div> <div class="weekly-day-events" id="weekly-events-${dayStr}"></div> `; weeklyViewContainer.appendChild(daySection); const eventsListContainer = gebi(`weekly-events-${dayStr}`); if (eventsForDay.length > 0) { eventsForDay.forEach(item => eventsListContainer.appendChild(createUniversalListItemNode(item))); } else { eventsListContainer.innerHTML = `<div class="empty-state"><p>Nada programado.</p></div>`; } } }
        function renderAgendaFromSelectedDay(items, selectedDateStr) { const agendaList = gebi('agendaList'); agendaList.innerHTML = ''; if (!selectedDateStr) return; const selectedDate = yyyymmddToDate(selectedDateStr); selectedDate.setHours(0, 0, 0, 0); const itemsForDayAndBeyond = items.filter(item => item.type === 'agenda' && !item.isComplete && item.dueDate && new Date(item.dueDate) >= selectedDate ).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)); if (itemsForDayAndBeyond.length === 0) { agendaList.innerHTML = `<div class="empty-state" style="padding-top: 24px;"><span class="material-icons">event_available</span><div>Nada programado a partir de este día.</div></div>`; return; } let lastHeaderDate = null; itemsForDayAndBeyond.forEach(item => { const itemDate = new Date(item.dueDate); const itemDateStr = dateToYYYYMMDD(itemDate); if (itemDateStr !== lastHeaderDate) { const header = document.createElement('div'); header.className = 'agenda-date-header'; header.textContent = itemDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }); agendaList.appendChild(header); lastHeaderDate = itemDateStr; } agendaList.appendChild(createUniversalListItemNode(item)); }); }
        function renderTaskListView() { const filter = gebi('task-list-filter'); filter.innerHTML = db.taskLists.map(list => `<option value="${list.id}">${list.name}</option>`).join(''); filter.value = appState.tasks.selectedListId; const tasksContainer = gebi('tasks-content'); tasksContainer.innerHTML = ''; const listId = appState.tasks.selectedListId; const pendingTasks = db.items.filter(i => i.type === 'task' && !i.isComplete && (i.listId || 'default') === listId).sort((a, b) => a.createdAt - b.createdAt); const completedTasks = db.items.filter(i => i.type === 'task' && i.isComplete && (i.listId || 'default') === listId).sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0)); if (pendingTasks.length > 0) { const title = document.createElement('h3'); title.className = 'section-title'; title.textContent = 'Tareas Pendientes'; tasksContainer.appendChild(title); pendingTasks.forEach(item => tasksContainer.appendChild(createUniversalListItemNode(item))); } if (completedTasks.length > 0) { const details = document.createElement('details'); details.className = 'completed-tasks-section'; const summary = document.createElement('summary'); summary.innerHTML = `<h3 class="section-title">Tareas Completadas (${completedTasks.length})</h3><span class="material-icons">expand_more</span>`; const completedList = document.createElement('div'); completedList.className = 'completed-tasks-list'; completedTasks.slice(0, 20).forEach(item => completedList.appendChild(createUniversalListItemNode(item))); details.appendChild(summary); details.appendChild(completedList); tasksContainer.appendChild(details); } const isAllEmpty = pendingTasks.length === 0 && completedTasks.length === 0; gebi('emptyTasks').style.display = isAllEmpty ? 'block' : 'none'; }
        function renderSearchView(query) { const resultsList = gebi('searchResultsList'); resultsList.innerHTML = ''; const emptyState = gebi('emptySearch'); const lowerCaseQuery = query.toLowerCase(); const results = db.items.filter(item => item.description.toLowerCase().includes(lowerCaseQuery)); if (results.length > 0) { emptyState.style.display = 'none'; results.sort((a,b) => (a.createdAt < b.createdAt) ? 1 : -1).forEach(item => resultsList.appendChild(createUniversalListItemNode(item))); } else { emptyState.style.display = 'block'; } }
        function createUniversalListItemNode(item) { const node = item.type === 'task' ? createTaskItemNode(item) : createEventItemNode(item); if (newlyCreatedItemId && item.localId === newlyCreatedItemId) { node.classList.add(CONSTANTS.ANIMATION_CLASSES.ITEM_ENTERING); node.addEventListener('animationend', () => { node.classList.remove(CONSTANTS.ANIMATION_CLASSES.ITEM_ENTERING); }, { once: true }); newlyCreatedItemId = null; } return node; }
        // MODIFICADO: Muestra "Todo el día" en lugar de la hora para eventos de día completo.
        function createEventItemNode(item) { const itemEl = document.createElement('div'); itemEl.className = `list-item-swipe-container type-agenda ${item.isComplete ? 'completed' : ''}`; itemEl.dataset.id = item.localId; const itemColor = item.isImportant ? 'var(--accent-event-important)' : 'var(--accent-event-normal)'; itemEl.style.borderLeftColor = itemColor; const time = item.isAllDay ? 'Todo el día' : (item.dueDate ? dateToHHMM(new Date(item.dueDate)) : ''); const hasGoogleId = !!item.googleCalendarEventId; const syncStatusIconHtml = hasGoogleId ? `<span class="material-icons event-meta-icon google-cal-icon" title="Sincronizado con Google Calendar">event_available</span>` : `<span class="material-icons event-meta-icon aidanai-only-icon" title="Guardado solo en aiDANaI (no en Google Calendar)">cloud_done</span>`; itemEl.innerHTML = ` <div class="item-card-swipe-background"><span class="material-icons">check_circle</span><span class="material-icons">delete</span></div> <div class="item-icon"><span class="material-icons" style="color: ${itemColor};">event</span></div> <div class="item-content" data-action="edit-item"> <div class="item-title">${item.description}</div> <div class="item-metadata-container"> <span class="event-time">${time}</span> ${syncStatusIconHtml} ${item.recurrenceRule !== 'none' ? '<span class="material-icons event-meta-icon">repeat</span>' : ''} </div> </div> `; attachSwipeListeners(itemEl); return itemEl; }
        function createTaskItemNode(item) { const itemEl = document.createElement('div'); itemEl.dataset.id = item.localId; itemEl.className = `list-item-swipe-container type-task ${item.isComplete ? 'completed' : ''}`; itemEl.style.borderLeftColor = 'var(--accent-task)'; let progressHtml = ''; if (item.subtasks && item.subtasks.length > 0) { const completedCount = item.subtasks.filter(st => st.isComplete).length; const progressPercent = (completedCount / item.subtasks.length) * 100; const subtasksListViewHtml = item.subtasks.map(st => ` <div class="subtask-list-view-item ${st.isComplete ? 'completed' : ''}" data-action="toggle-subtask" data-task-id="${item.localId}" data-subtask-id="${st.id}"> <span class="material-icons">${st.isComplete ? 'check_circle' : 'radio_button_unchecked'}</span> <span>${st.description}</span> </div> `).join(''); progressHtml = ` <div class="task-progress-container"> <div class="progress-bar-wrapper"> <span>${completedCount} de ${item.subtasks.length}</span> <div class="progress-bar"> <div class="progress-bar-fill" style="width: ${progressPercent}%;"></div> </div> </div> <div class="subtasks-list-view">${subtasksListViewHtml}</div> </div>`; } const titleAndMetaHtml = ` <div style="display: flex; flex-direction: column; align-items: flex-start; width: 100%;"> <div class="item-title" data-action="edit-item">${item.description}</div> <div class="item-metadata-container" style="margin-top: 4px;"> <span class="material-icons event-meta-icon aidanai-only-icon" title="Guardado en tu cuenta de aiDANaI">cloud_done</span> </div> </div> `; itemEl.innerHTML = ` <div class="item-card-swipe-background"><span class="material-icons">check_circle</span><span class="material-icons">delete</span></div> <div class="item-icon item-checkbox" data-action="complete-item"> <span class="material-icons">${item.isComplete ? 'check_circle' : 'radio_button_unchecked'}</span> </div> <div class="item-content"> ${titleAndMetaHtml} ${progressHtml} </div>`; attachSwipeListeners(itemEl); return itemEl; }
        function attachGlobalEventListeners() { const safeAddListener = (id, event, handler) => { const el = gebi(id); if (el) el.addEventListener(event, handler); }; document.body.addEventListener('click', e => { const actionTarget = e.target.closest('[data-action]'); if (actionTarget) { const action = actionTarget.dataset.action; triggerHapticFeedback('light'); if (action === 'edit-item') { const itemId = actionTarget.closest('.list-item-swipe-container').dataset.id; const item = db.items.find(i => i.localId === itemId); if (item) openAddItemModal(item); } if (action === 'complete-item') { const itemId = actionTarget.closest('.list-item-swipe-container').dataset.id; const item = db.items.find(i => i.localId === itemId); if (item) { triggerHapticFeedback('success'); handleItemComplete(itemId, !item.isComplete); } } if (action === 'toggle-subtask') { const taskId = actionTarget.dataset.taskId; const subtaskId = actionTarget.dataset.subtaskId; if (taskId && subtaskId) { triggerHapticFeedback('success'); handleSubtaskToggle(taskId, subtaskId); } } if (action === 'forgot-password') { e.preventDefault(); showToast('La función para recuperar contraseña no está implementada.', false); } if (action === 'logout') { showCustomConfirm("¿Seguro que quieres cerrar sesión?", () => signOut(fbAuth)); } if (action === 'quick-add') openModal('quick-add-modal'); if (action === 'selectDate') { const dateStr = actionTarget.dataset.date; selectDate(dateStr); } } }); qsa('.nav-item[data-view]').forEach(item => item.addEventListener('click', () => switchView(item.dataset.view))); safeAddListener('nav-theme-btn', 'click', handleThemeToggle); safeAddListener('google-sync-btn', 'click', handleGoogleAuthClick); safeAddListener('prev-nav-btn', 'click', () => { appState.calendar.displayMode === 'month' ? changeMonth(-1) : changeWeek(-1); }); safeAddListener('next-nav-btn', 'click', () => { appState.calendar.displayMode === 'month' ? changeMonth(1) : changeWeek(1); }); safeAddListener('today-btn', 'click', goToToday); safeAddListener('calendar-title-btn', 'click', openDatePickerModal); safeAddListener('month-view-btn', 'click', () => setCalendarDisplayMode('month')); safeAddListener('week-view-btn', 'click', () => setCalendarDisplayMode('week')); safeAddListener('fab-add-item', 'click', () => { triggerHapticFeedback('medium'); openModal('quick-add-modal'); }); safeAddListener('quick-add-input', 'input', debounce(handleQuickAddInput)); safeAddListener('quick-add-form', 'submit', handleQuickAddSubmit); safeAddListener('cancel-quick-add-btn', 'click', () => closeModal('quick-add-modal')); safeAddListener('open-advanced-editor-btn', 'click', openAdvancedFromQuickAdd); safeAddListener('add-item-form', 'submit', handleItemFormSubmit); safeAddListener('cancel-item-btn', 'click', () => closeModal('add-item-modal')); safeAddListener('item-type', 'change', toggleModalOptionsVisibility); safeAddListener('item-notification-enabled', 'change', toggleModalOptionsVisibility); safeAddListener('delete-item-btn', 'click', handleDeleteFromModal); safeAddListener('date-picker-form', 'submit', handleDateSelectionFromPicker); safeAddListener('cancel-date-picker-btn', 'click', () => closeModal('date-picker-modal')); safeAddListener('search-toggle-btn', 'click', toggleSearchBar); safeAddListener('search-form', 'submit', handleSearchSubmit); safeAddListener('task-list-filter', 'change', handleTaskListFilterChange); safeAddListener('manage-lists-btn', 'click', openManageListsModal); safeAddListener('close-manage-lists-btn', 'click', () => closeModal('manage-lists-modal')); safeAddListener('add-list-form', 'submit', handleAddTaskList); safeAddListener('add-subtask-btn', 'click', handleAddSubtask); safeAddListener('new-subtask-input', 'keydown', e => { if (e.key === 'Enter') { e.preventDefault(); handleAddSubtask(); } }); safeAddListener('login-form', 'submit', (e) => { e.preventDefault(); handleLogin(gebi('login-submit-btn')); }); safeAddListener('register-btn', 'click', (e) => { e.preventDefault(); handleRegister(gebi('register-btn')); }); window.addEventListener('online', updateSyncStatus); window.addEventListener('offline', updateSyncStatus); safeAddListener('item-all-day', 'change', toggleModalOptionsVisibility); }
        function handleQuickAddInput(e) { const text = e.target.value; const feedbackContainer = gebi('quick-add-feedback'); if (!text.trim()) { feedbackContainer.innerHTML = ''; return; } const parsedData = parseNaturalLanguage(text); let feedbackHtml = ''; if (parsedData.type === 'agenda') { const formattedDate = formatDateForFeedback(parsedData.dueDate); feedbackHtml = `<div class="feedback-chip type-agenda"><span class="material-icons">event</span><span>Evento: ${formattedDate}</span></div>`; } else { feedbackHtml = `<div class="feedback-chip type-task"><span class="material-icons">task_alt</span><span>Tarea</span></div>`; } feedbackContainer.innerHTML = feedbackHtml; }
        function formatDateForFeedback(isoDate) { if (!isoDate) return ''; const date = new Date(isoDate); const now = new Date(); const tomorrow = new Date(); tomorrow.setDate(now.getDate() + 1); let datePart; if (date.toDateString() === now.toDateString()) { datePart = 'Hoy'; } else if (date.toDateString() === tomorrow.toDateString()) { datePart = 'Mañana'; } else { datePart = date.toLocaleDateString('es-ES', { weekday: 'short', month: 'short', day: 'numeric' }); } const timePart = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false }); return timePart !== '00:00' ? `${datePart}, ${timePart}` : datePart; }
        function switchView(view, isInitial = false) { if (!view || view === appState.currentView || isViewSwitching) return; if (view === 'help') renderThemeSelector(); if (view === 'search') { appState.lastView = appState.currentView; } isViewSwitching = true; const oldViewName = appState.currentView; const newViewName = view; appState.currentView = newViewName; const oldViewEl = gebi(`${oldViewName}View`); const newViewEl = gebi(`${newViewName}View`); if (!newViewEl) { isViewSwitching = false; return; } renderApp(); if (isInitial || !oldViewEl) { newViewEl.classList.add('active'); isViewSwitching = false; return; } const oldViewIndex = VIEW_ORDER.indexOf(oldViewName); const newViewIndex = VIEW_ORDER.indexOf(newViewName); let enterClass, exitClass; if (newViewIndex > oldViewIndex) { enterClass = 'view-enter-from-right'; exitClass = 'view-exit-to-left'; } else { enterClass = 'view-enter-from-left'; exitClass = 'view-exit-to-right'; } if (newViewIndex === -1 || oldViewIndex === -1) { newViewEl.classList.add('active'); oldViewEl.classList.remove('active'); isViewSwitching = false; return; } newViewEl.classList.add(enterClass, 'active', 'is-animating'); oldViewEl.classList.add(exitClass, 'is-animating'); newViewEl.addEventListener('animationend', () => { oldViewEl.classList.remove('active', 'is-animating', exitClass); newViewEl.classList.remove(enterClass, 'is-animating'); isViewSwitching = false; }, { once: true }); }
        function selectDate(dateStr) { appState.calendar.selectedDate = dateStr; renderApp(); }
        function changeMonth(delta) { const d = new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 1); d.setMonth(d.getMonth() + delta); appState.calendar.currentMonth = d.getMonth(); appState.calendar.currentYear = d.getFullYear(); renderApp(); }
        function changeWeek(delta) { const d = yyyymmddToDate(appState.calendar.selectedDate); d.setDate(d.getDate() + (delta * 7)); appState.calendar.selectedDate = dateToYYYYMMDD(d); appState.calendar.currentMonth = d.getMonth(); appState.calendar.currentYear = d.getFullYear(); renderApp(); }
        function goToToday() { const today = new Date(); appState.calendar = { ...appState.calendar, currentMonth: today.getMonth(), currentYear: today.getFullYear(), selectedDate: dateToYYYYMMDD(today), displayMode: 'month' }; if (appState.currentView === 'calendar') { renderApp(); } else { switchView('calendar'); } }
        function setCalendarDisplayMode(mode) { if (appState.calendar.displayMode === mode) return; appState.calendar.displayMode = mode; renderApp(); }
        function openModal(modalId) { gebi(modalId)?.classList.add('active'); if (modalId === 'quick-add-modal') { const input = gebi('quick-add-input'); input.value = ''; setTimeout(() => input.focus(), 100); } }
        function closeModal(modalId) { gebi(modalId)?.classList.remove('active'); }
        // MODIFICADO: Ahora gestiona el estado "Todo el día"
        function openAddItemModal(itemToEdit = null) { const form = gebi('add-item-form'); form.reset(); closeModal('quick-add-modal'); gebi('delete-item-btn').style.display = itemToEdit ? 'block' : 'none'; const localId = itemToEdit?.localId || uuid(); gebi('item-local-id').value = localId; const itemData = itemToEdit || parseNaturalLanguage(gebi('quick-add-input').value); const defaultType = appState.currentView === 'tasks' ? 'task' : 'agenda'; gebi('item-type').value = itemData?.type || defaultType; gebi('item-description').value = itemData?.description || ''; const taskListSelect = gebi('item-task-list'); taskListSelect.innerHTML = db.taskLists.map(list => `<option value="${list.id}">${list.name}</option>`).join(''); taskListSelect.value = itemData?.listId || appState.tasks.selectedListId; renderSubtasksInModal(itemData?.subtasks || []); const dateToShow = itemData?.dueDate ? new Date(itemData.dueDate) : yyyymmddToDate(appState.calendar.selectedDate); flatpickrInstance.setDate(dateToShow, false); gebi('item-all-day').checked = itemData?.isAllDay || false; gebi('item-important').checked = itemData?.isImportant || false; gebi('item-notification-enabled').checked = itemData?.notificationEnabled || false; gebi('item-recurrence').value = itemData?.recurrenceRule || 'none'; gebi('item-reminder').value = itemData?.reminderMinutes || '0'; toggleModalOptionsVisibility(); openModal('add-item-modal'); gebi('item-description').focus(); }
        // MODIFICADO: Reconfigura flatpickr y oculta opciones según "Todo el día".
        function toggleModalOptionsVisibility() { const isAgenda = gebi('item-type').value === 'agenda'; const isAllDay = gebi('item-all-day').checked; const isNotificationEnabled = gebi('item-notification-enabled').checked && !isAllDay; gebi('datetime-notification-group').style.display = isAgenda ? 'block' : 'none'; gebi('task-options-group').style.display = isAgenda ? 'none' : 'block'; flatpickrInstance.set('enableTime', !isAllDay); gebi('item-notification-enabled').disabled = isAllDay; if (isAllDay) { gebi('item-notification-enabled').checked = false; } gebi('reminder-time-group').style.display = (isAgenda && isNotificationEnabled) ? 'block' : 'none'; }
        // MODIFICADO: Incluye isAllDay en el objeto de datos del item.
        async function handleItemFormSubmit(e) { e.preventDefault(); if (isSyncingWithGoogle) { showToast("Sincronización en curso, por favor espera.", true); return; } const localId = gebi('item-local-id').value; const existingItem = db.items.find(i => i.localId === localId); const subtasks = Array.from(qsa('#subtasks-container .subtask-item')).map(el => ({ id: el.dataset.id, description: el.querySelector('input[type="text"]').value, isComplete: el.querySelector('input[type="checkbox"]').checked })); let itemData = { localId, type: gebi('item-type').value, description: gebi('item-description').value.trim(), isComplete: existingItem?.isComplete || false, createdAt: existingItem?.createdAt || Date.now(), updatedAt: Date.now(), isAllDay: gebi('item-type').value === 'agenda' ? gebi('item-all-day').checked : false, isImportant: gebi('item-type').value === 'agenda' ? gebi('item-important').checked : false, notificationEnabled: gebi('item-type').value === 'agenda' ? gebi('item-notification-enabled').checked : false, reminderMinutes: gebi('item-type').value === 'agenda' && gebi('item-notification-enabled').checked ? parseInt(gebi('item-reminder').value, 10) : 0, notificationShown: (existingItem && existingItem.dueDate === flatpickrInstance.selectedDates[0]?.toISOString()) ? existingItem.notificationShown : false, recurrenceRule: gebi('item-type').value === 'agenda' ? gebi('item-recurrence').value : 'none', dueDate: gebi('item-type').value === 'agenda' ? flatpickrInstance.selectedDates[0]?.toISOString() : null, listId: gebi('item-type').value === 'task' ? gebi('item-task-list').value : null, subtasks: gebi('item-type').value === 'task' ? subtasks : [], googleCalendarEventId: existingItem?.googleCalendarEventId || null, parentId: existingItem?.parentId || null }; if (itemData.description.trim() === "") { showToast("La descripción no puede estar vacía.", true); return; } if (itemData.notificationEnabled) requestNotificationPermission(); const isNewItem = !existingItem; if (isGoogleSignedIn && itemData.type === 'agenda') { showToast("Sincronizando con Google...", false); isSyncingWithGoogle = true; try { if (itemData.googleCalendarEventId) { await actualizarEventoEnGoogle(itemData); } else { const googleId = await crearEventoEnGoogle(itemData); if (googleId) itemData.googleCalendarEventId = googleId; } } catch (err) { console.error("Falló la sincronización con Google, guardando localmente:", err); showToast("Falló la sincronización. El ítem se ha guardado localmente.", true); } finally { isSyncingWithGoogle = false; } } handleItemSave(itemData, isNewItem); closeModal('add-item-modal'); }
        function handleItemSave(itemData, isNewItem = false) { triggerHapticFeedback('medium'); const index = db.items.findIndex(i => i.localId === itemData.localId); if (index > -1) { db.items[index] = { ...db.items[index], ...itemData }; } else { db.items.unshift(itemData); } if (isNewItem) { newlyCreatedItemId = itemData.localId; } handlePostSaveNavigation(itemData); saveDataAndSchedule(); }
        function handlePostSaveNavigation(itemData) { if (!itemData) { renderApp(); return; } if (itemData.type === 'agenda' && itemData.dueDate) { const itemDate = new Date(itemData.dueDate); appState.calendar.selectedDate = dateToYYYYMMDD(itemDate); appState.calendar.currentMonth = itemDate.getMonth(); appState.calendar.currentYear = itemDate.getFullYear(); if (appState.currentView !== 'calendar') { switchView('calendar'); } else { renderApp(); } } else if (itemData.type === 'task') { appState.tasks.selectedListId = itemData.listId || 'default'; if (appState.currentView !== 'tasks') { switchView('tasks'); } else { renderApp(); } } else { renderApp(); } }
        async function handleItemComplete(localId, isComplete) { if (isSyncingWithGoogle) { showToast("Sincronización en curso, por favor espera.", true); return; } const itemIndex = db.items.findIndex(i => i.localId === localId); if (itemIndex === -1) return; const item = { ...db.items[itemIndex] }; try { if (isComplete) { if (isGoogleSignedIn && item.googleCalendarEventId && item.type === 'agenda') { isSyncingWithGoogle = true; await borrarEventoEnGoogle(item); } showToast(`"${item.description}" completado.`); const updatedItem = { ...item, isComplete: true, completedAt: Date.now(), updatedAt: Date.now() }; if (updatedItem.type === 'task' && updatedItem.subtasks) { updatedItem.subtasks.forEach(st => st.isComplete = true); } db.items[itemIndex] = updatedItem; if (item.type === 'agenda' && item.recurrenceRule !== 'none') { const nextDueDate = calculateNextDueDate(new Date(item.dueDate), item.recurrenceRule); if (nextDueDate) { const nextEvent = { ...item, localId: uuid(), dueDate: nextDueDate.toISOString(), isComplete: false, completedAt: null, notificationShown: false, createdAt: Date.now(), updatedAt: Date.now(), googleCalendarEventId: null, parentId: item.localId }; delete nextEvent.googleCalendarEventId; db.items.unshift(nextEvent); showToast(`Evento reprogramado para la próxima ocurrencia.`); } } } else { if (item.recurrenceRule !== 'none') { const childItemIndex = db.items.findIndex(i => i.parentId === localId); if (childItemIndex > -1) { db.items.splice(childItemIndex, 1); } } const updatedItem = { ...item, isComplete: false, completedAt: null, updatedAt: Date.now() }; db.items[itemIndex] = updatedItem; } renderApp(); saveDataAndSchedule(); } catch (error) { showToast("Error al sincronizar con Google. La operación local se ha completado.", true); console.error("Error in handleItemComplete:", error); renderApp(); } finally { if (isSyncingWithGoogle) { isSyncingWithGoogle = false; } } }
        async function handleDeleteItem(localId) { if (isSyncingWithGoogle) { showToast("Sincronización en curso, por favor espera.", true); return; } triggerHapticFeedback('medium'); const itemEl = document.querySelector(`.list-item-swipe-container[data-id="${localId}"]`); const index = db.items.findIndex(i => i.localId === localId); if (index === -1) return; const itemToDelete = { ...db.items[index] }; try { if (isGoogleSignedIn && itemToDelete.googleCalendarEventId) { isSyncingWithGoogle = true; await borrarEventoEnGoogle(itemToDelete); } const performDeleteAndUpdate = () => { const finalChildIndex = db.items.findIndex(i => i.parentId === localId); if (finalChildIndex > -1) db.items.splice(finalChildIndex, 1); const finalParentIndex = db.items.findIndex(i => i.localId === localId); if (finalParentIndex > -1) db.items.splice(finalParentIndex, 1); saveDataAndSchedule(); if (!itemEl) renderApp(); }; if (itemEl) { itemEl.classList.add('item-exiting'); itemEl.addEventListener('animationend', performDeleteAndUpdate, { once: true }); } else { performDeleteAndUpdate(); renderApp(); } } catch (error) { showToast("Error al eliminar evento de Google. Inténtalo de nuevo.", true); if (itemEl) itemEl.style.transform = 'translateX(0)'; } finally { if (isSyncingWithGoogle) isSyncingWithGoogle = false; } }
        function saveDataAndSchedule() { scheduleAllNotifications(); saveData().catch(error => { showToast(`Error al sincronizar con Firebase.`, true); renderApp(); }); }
        function handleDeleteFromModal() { const localId = gebi('item-local-id').value; const item = db.items.find(i => i.localId === localId); if (item) { showCustomConfirm(`¿Eliminar este ítem permanentemente: "${item.description}"?`, () => { closeModal('add-item-modal'); handleDeleteItem(localId); }); } }
        function calculateNextDueDate(currentDueDate, recurrenceRule) { const nextDate = new Date(currentDueDate); switch (recurrenceRule) { case 'daily': nextDate.setDate(nextDate.getDate() + 1); break; case 'weekly': nextDate.setDate(nextDate.getDate() + 7); break; case 'monthly': nextDate.setMonth(nextDate.getMonth() + 1); break; case 'yearly': nextDate.setFullYear(nextDate.getFullYear() + 1); break; default: return null; } return nextDate; }
        async function handleQuickAddSubmit(e) { e.preventDefault(); if (isSyncingWithGoogle) { showToast("Sincronización en curso, por favor espera.", true); return; } const input = gebi('quick-add-input').value.trim(); if (!input) return; let parsedData = parseNaturalLanguage(input); let itemToSave = { ...parsedData, localId: uuid(), isComplete: false, createdAt: Date.now(), updatedAt: Date.now(), listId: parsedData.type === 'task' ? appState.tasks.selectedListId : null, }; if (isGoogleSignedIn && itemToSave.type === 'agenda') { showToast("Sincronizando con Google...", false); isSyncingWithGoogle = true; try { const googleId = await crearEventoEnGoogle(itemToSave); if (googleId) itemToSave.googleCalendarEventId = googleId; } catch (err) { console.error("Falló la creación rápida en Google, guardando localmente:", err); showToast("Falló la sincronización. El ítem se ha guardado localmente.", true); } finally { isSyncingWithGoogle = false; } } handleItemSave(itemToSave, true); closeModal('quick-add-modal'); }
        function openAdvancedFromQuickAdd() { const itemToEdit = parseNaturalLanguage(gebi('quick-add-input').value); openAddItemModal(itemToEdit); }
        // MODIFICADO: Añade isAllDay a la respuesta del parseo.
        function parseNaturalLanguage(text) { let cleanText = text.toLowerCase(); let date = new Date(); let dateFound = false; let isAllDay = true; const timeRegex = /(?:a las|a la|)\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm|de la mañana|de la tarde|de la noche)?/i; const timeMatch = cleanText.match(timeRegex); if (timeMatch) { isAllDay = false; let hour = parseInt(timeMatch[1], 10); const minute = parseInt(timeMatch[2], 10) || 0; const period = timeMatch[3] ? timeMatch[3].toLowerCase() : ''; if ((period.includes('pm') || period.includes('tarde') || period.includes('noche')) && hour < 12) { hour += 12; } if ((period.includes('am') || period.includes('mañana')) && hour === 12) { hour = 0; } date.setHours(hour, minute, 0, 0); cleanText = cleanText.replace(timeMatch[0], '').trim(); dateFound = true; } else { date.setHours(0,0,0,0); } const numericDateRegex = /\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/; const numericDateMatch = cleanText.match(numericDateRegex); if (numericDateMatch) { const day = parseInt(numericDateMatch[1], 10); const month = parseInt(numericDateMatch[2], 10) - 1; let year = numericDateMatch[3] ? parseInt(numericDateMatch[3], 10) : new Date().getFullYear(); if (year < 100) { year += 2000; } date.setFullYear(year, month, day); dateFound = true; cleanText = cleanText.replace(numericDateMatch[0], '').trim(); } else { const dateRegex = /(\d{1,2})(?:\s+de\s+|\s*\/\s*)(\w+)/i; const dateMatch = dateRegex.exec(cleanText); if (dateMatch) { const day = parseInt(dateMatch[1], 10); const monthStr = dateMatch[2].toLowerCase(); const monthIndex = MESES.findIndex(m => m.toLowerCase().startsWith(monthStr)); if (monthIndex > -1) { date.setMonth(monthIndex, day); dateFound = true; cleanText = cleanText.replace(dateMatch[0], '').trim(); } } else if (/\bhoy\b/i.test(cleanText)) { dateFound = true; cleanText = cleanText.replace(/\bhoy\b/i, '').trim(); } else if (/\bmañana\b/i.test(cleanText)) { date.setDate(date.getDate() + 1); dateFound = true; cleanText = cleanText.replace(/\bmañana\b/i, '').trim(); } else { for (let i = 0; i < DIAS_SEMANA_LARGOS.length; i++) { const dayName = DIAS_SEMANA_LARGOS[i]; if (cleanText.includes(dayName)) { const currentDay = (new Date().getDay() + 6) % 7; const targetDay = i; let dayDiff = targetDay - currentDay; if (dayDiff <= 0) dayDiff += 7; date.setDate(date.getDate() + dayDiff); dateFound = true; cleanText = cleanText.replace(new RegExp(`\\b(el\\s+)?${dayName}\\b`, 'i'), '').trim(); break; } } } } const description = cleanText.charAt(0).toUpperCase() + cleanText.slice(1); return { type: dateFound ? 'agenda' : 'task', description: description.replace(/,$/, '').trim(), dueDate: dateFound ? date.toISOString() : null, isAllDay: dateFound ? isAllDay : false }; }
        function handleTaskListFilterChange(e) { appState.tasks.selectedListId = e.target.value; renderTaskListView(); }
        function openManageListsModal() { const editor = gebi('task-lists-editor'); editor.innerHTML = ''; db.taskLists.forEach(list => { const el = document.createElement('div'); el.style.cssText = 'display:flex; align-items:center; gap:8px; margin-bottom:8px;'; const input = document.createElement('input'); input.type = 'text'; input.value = list.name; input.className = 'form-input'; input.onchange = () => handleRenameTaskList(list.id, input.value); if(list.id === 'default') input.disabled = true; el.appendChild(input); if (list.id !== 'default') { const deleteBtn = document.createElement('button'); deleteBtn.className = 'icon-button'; deleteBtn.innerHTML = '<span class="material-icons">delete</span>'; deleteBtn.onclick = () => handleDeleteTaskList(list.id); el.appendChild(deleteBtn); } editor.appendChild(el); }); openModal('manage-lists-modal'); }
        function handleAddTaskList(e) { e.preventDefault(); const input = gebi('new-list-name'); const name = input.value.trim(); if (name) { const newList = { id: uuid(), name }; db.taskLists.push(newList); saveData().then(() => { input.value = ''; openManageListsModal(); renderTaskListView(); }).catch(err => showToast("Error al añadir lista", true)); } }
        function handleRenameTaskList(id, newName) { const list = db.taskLists.find(l => l.id === id); if (list && newName) { list.name = newName; saveData().then(() => { openManageListsModal(); renderTaskListView(); }).catch(err => showToast("Error al renombrar lista", true)); } }
        function handleDeleteTaskList(id) { const listName = db.taskLists.find(l => l.id === id)?.name; showCustomConfirm(`¿Seguro que quieres eliminar la lista "${listName}" y TODAS sus tareas? Esta acción es irreversible.`, () => { db.taskLists = db.taskLists.filter(l => l.id !== id); db.items = db.items.filter(i => i.listId !== id); if (appState.tasks.selectedListId === id) { appState.tasks.selectedListId = 'default'; } saveData().then(() => { openManageListsModal(); renderTaskListView(); }).catch(err => showToast("Error al eliminar la lista.", true)); }); }
        function renderSubtasksInModal(subtasks = []) { const container = gebi('subtasks-container'); container.innerHTML = ''; subtasks.forEach(subtask => { const el = document.createElement('div'); el.className = 'subtask-item'; el.dataset.id = subtask.id; el.innerHTML = ` <input type="checkbox" ${subtask.isComplete ? 'checked' : ''}> <input type="text" value="${subtask.description}"> <button type="button" class="icon-button delete-subtask-btn"><span class="material-icons">close</span></button> `; el.querySelector('.delete-subtask-btn').onclick = () => { el.remove(); }; container.appendChild(el); }); }
        function handleAddSubtask() { const input = gebi('new-subtask-input'); const description = input.value.trim(); if (description) { const container = gebi('subtasks-container'); const el = document.createElement('div'); el.className = 'subtask-item'; el.dataset.id = uuid(); el.innerHTML = ` <input type="checkbox"> <input type="text" value="${description}"> <button type="button" class="icon-button delete-subtask-btn"><span class="material-icons">close</span></button> `; el.querySelector('.delete-subtask-btn').onclick = () => { el.remove(); }; container.appendChild(el); input.value = ''; input.focus(); } }
        function handleSubtaskToggle(taskId, subtaskId) { const taskIndex = db.items.findIndex(i => i.localId === taskId); if (taskIndex === -1) return; const updatedTask = JSON.parse(JSON.stringify(db.items[taskIndex])); const subtaskIndex = updatedTask.subtasks.findIndex(st => st.id === subtaskId); if (subtaskIndex === -1) return; updatedTask.subtasks[subtaskIndex].isComplete = !updatedTask.subtasks[subtaskIndex].isComplete; const allSubtasksComplete = updatedTask.subtasks.every(st => st.isComplete); updatedTask.isComplete = allSubtasksComplete; if (allSubtasksComplete) { if (!updatedTask.completedAt) updatedTask.completedAt = Date.now(); } else { updatedTask.completedAt = null; } updatedTask.updatedAt = Date.now(); db.items[taskIndex] = updatedTask; renderApp(); saveData().catch(error => { showToast('Error al actualizar la subtarea.', true); renderApp(); }); }
        async function startOnboardingTutorial() { if (typeof driver === 'undefined' || typeof driver.driver !== 'function') { console.warn("Driver.js aún no se ha cargado, reintentando..."); setTimeout(startOnboardingTutorial, 200); return; } const driverObj = driver.driver({ showProgress: true, steps: [ { element: '#today-greeting', popover: { title: '¡Bienvenido/a a Agenda aiDANaI!', description: 'Este es tu centro de mando. Permítenos mostrarte rápidamente cómo funciona.' } }, { element: '#fab-add-item', popover: { title: 'Creación Rápida con IA', description: 'Usa este botón para añadir eventos y tareas usando lenguaje natural, como "Cena con amigos mañana a las 9". ¡La IA se encarga del resto!' } }, { element: '#todayView', popover: { title: 'Gestos que Ahorran Tiempo', description: 'En cualquier lista, desliza un ítem a la DERECHA para completarlo, y a la IZQUIERDA para eliminarlo. ¡Así de fácil!' } }, { element: '.bottom-nav', popover: { title: 'Navega por tu Agenda', description: 'Usa estos botones para cambiar entre la vista de Hoy, la Agenda completa, tus listas de Tareas y más.', side: "top", align: 'start' } } ], onDestroyStarted: async () => { if (!driverObj.isActivated()) { db.config.tutorialCompleted = true; try { await saveData(); } catch (err) { showToast("Error al guardar el estado del tutorial.", true); } } } }); driverObj.drive(); }
        function initializeDatePicker() { flatpickr.localize(flatpickr.l10ns.es); flatpickrInstance = flatpickr("#item-datetime", { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true, minuteIncrement: 15 }); }
        function openDatePickerModal() { openModal('date-picker-modal'); const monthSelect = gebi('month-select'); monthSelect.innerHTML = MESES.map((mes, i) => `<option value="${i}">${mes}</option>`).join(''); monthSelect.value = appState.calendar.currentMonth; gebi('year-select').value = appState.calendar.currentYear; }
        function handleDateSelectionFromPicker(e) { e.preventDefault(); appState.calendar.currentMonth = parseInt(gebi('month-select').value, 10); appState.calendar.currentYear = parseInt(gebi('year-select').value, 10); appState.calendar.selectedDate = dateToYYYYMMDD(new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 1)); appState.calendar.displayMode = 'month'; switchView('calendar'); closeModal('date-picker-modal'); }
        function toggleSearchBar() { const searchContainer = gebi('search-container'); const isActive = searchContainer.classList.toggle('active'); if (isActive) { gebi('search-input').focus(); if (appState.currentView !== 'search') appState.lastView = appState.currentView; } else { gebi('search-input').value = ''; executeSearch(''); } }
        function handleSearchSubmit(event) { event.preventDefault(); executeSearch(gebi('search-input').value); }
        function executeSearch(query) { if (query.trim() !== '') { switchView('search'); } else { if (appState.currentView === 'search') { switchView(appState.lastView || 'today'); } } }
        function attachSwipeListeners(cardEl) { if (!cardEl || cardEl.dataset.hammer) return; cardEl.dataset.hammer = 'true'; const mc = new Hammer.Manager(cardEl); mc.add(new Hammer.Pan({ threshold: 10, pointers: 1 })); mc.on('panstart', () => { cardEl.style.transition = 'none'; }); mc.on('pan', e => { if (e.target.closest('.subtasks-list-view')) { cardEl.style.transform = 'translateX(0)'; return; } cardEl.style.transform = `translateX(${e.deltaX}px)`; if (e.deltaX > 20) cardEl.classList.add('swiping-right'); else if (e.deltaX < -20) cardEl.classList.add('swiping-left'); else cardEl.classList.remove('swiping-right', 'swiping-left'); }); mc.on('panend', e => { cardEl.style.transition = 'transform 0.3s var(--ease-out-quint)'; const threshold = cardEl.offsetWidth * 0.35; const id = cardEl.dataset.id; const item = db.items.find(i => i.localId === id); if (!item) { cardEl.style.transform = 'translateX(0)'; return; } if (e.deltaX > threshold) { triggerHapticFeedback('success'); handleItemComplete(id, true); cardEl.style.transform = 'translateX(0)'; } else if (e.deltaX < -threshold) { showCustomConfirm(`¿Eliminar "${item.description}"?`, () => { handleDeleteItem(id); }, () => { cardEl.style.transform = 'translateX(0)'; }); } else { cardEl.style.transform = 'translateX(0)'; } setTimeout(() => { cardEl.classList.remove('swiping-right', 'swiping-left'); }, 300); }); }
        function showCustomConfirm(message, onConfirm, onCancel) { const modalId = 'custom-confirm-modal'; gebi('confirm-message').textContent = message; const confirmOkBtn = gebi('confirm-ok-btn'); const confirmCancelBtn = gebi('confirm-cancel-btn'); confirmOkBtn.onclick = null; confirmCancelBtn.onclick = null; const newConfirmOkHandler = () => { onConfirm(); closeModal(modalId); }; const newConfirmCancelHandler = () => { if (onCancel) onCancel(); closeModal(modalId); }; confirmOkBtn.onclick = newConfirmOkHandler; confirmCancelBtn.onclick = newConfirmCancelHandler; openModal(modalId); }
        function updateSyncStatus() { const indicator = gebi('sync-status-indicator'); if (!indicator) return; const icon = indicator.querySelector('.material-icons') || document.createElement('span'); icon.classList.add('material-icons'); const isOnline = navigator.onLine; if (isOnline) { indicator.className = 'online'; icon.textContent = 'cloud_done'; indicator.title = "Conectado y sincronizado."; } else { indicator.className = 'offline'; icon.textContent = 'cloud_off'; indicator.title = "Sin conexión. Los cambios se guardarán localmente."; } if (!indicator.hasChildNodes()) { indicator.appendChild(icon); } }
        async function requestNotificationPermission() { if (!("Notification" in window)) { showToast("Este navegador no soporta notificaciones.", true); return 'denied'; } const permission = await Notification.requestPermission(); if (permission === 'granted') { showToast("¡Permiso de notificaciones concedido!"); } else { showToast("Permiso de notificaciones denegado.", true); } return permission; }
        function showNotification(item) { if (Notification.permission !== "granted") return; const body = `Tu evento "${item.description}" es ahora.`; new Notification('Recordatorio de Agenda', { body: body, icon: './aiDANaI.webp', badge: './aiDANaI.webp' }); const index = db.items.findIndex(x => x.localId === item.localId); if (index > -1) { db.items[index].notificationShown = true; saveData().catch(err => showToast("Error al guardar estado de notificación", true)); } }
        function scheduleNotification(item) { if (activeTimers[item.localId]) { clearTimeout(activeTimers[item.localId]); } if (!item.notificationEnabled || item.isComplete || !item.dueDate || item.notificationShown) { return; } const reminderOffsetMs = (parseInt(item.reminderMinutes, 10) || 0) * 60 * 1000; const notificationTimeMs = new Date(item.dueDate).getTime() - reminderOffsetMs; const delay = notificationTimeMs - Date.now(); if (delay > 0) { activeTimers[item.localId] = setTimeout(() => { showNotification(item); delete activeTimers[item.localId]; }, delay); } }
        function scheduleAllNotifications() { if (!db.items) return; Object.values(activeTimers).forEach(clearTimeout); activeTimers = {}; db.items.forEach(scheduleNotification); }
        
        // --- SECCIÓN DE GOOGLE CALENDAR (REESTRUCTURADA) ---

        window.handleGoogleClientLoad = function() { gapi.load('client:auth2', initGoogleClient); }
        function initGoogleClient() { const syncButton = gebi('google-sync-btn'); syncButton.classList.add('loading'); gapi.client.init({ apiKey: GOOGLE_API_KEY, clientId: GOOGLE_CLIENT_ID, discoveryDocs: GOOGLE_DISCOVERY_DOCS, scope: GOOGLE_SCOPES }).then(() => { syncButton.classList.remove('loading'); syncButton.disabled = false; googleAuthInstance = gapi.auth2.getAuthInstance(); googleAuthInstance.isSignedIn.listen(updateGoogleSigninStatus); updateGoogleSigninStatus(googleAuthInstance.isSignedIn.get()); }).catch(error => { console.error("Error initializing Google Client:", error); showToast("No se pudo conectar con Google Calendar.", true); syncButton.classList.remove('loading'); syncButton.disabled = true; syncButton.title = 'Error al conectar con Google'; syncButton.querySelector('.material-icons').textContent = 'sync_problem'; }); }
        function updateGoogleSigninStatus(isSignedIn) { const wasSignedIn = isGoogleSignedIn; isGoogleSignedIn = isSignedIn; const syncButton = gebi('google-sync-btn'); if (isSignedIn) { syncButton.classList.add('connected'); syncButton.title = 'Conectado. Haz clic para sincronizar manualmente.'; syncButton.querySelector('.material-icons').textContent = 'cloud_done'; if (!wasSignedIn) { showToast("Conectado a Google Calendar. Sincronizando..."); syncWithGoogleCalendar(); } } else { syncButton.classList.remove('connected'); syncButton.title = 'Sincronizar con Google'; syncButton.querySelector('.material-icons').textContent = 'sync'; } }
        function handleGoogleAuthClick() { if (!googleAuthInstance) { showToast("La API de Google aún no está lista. Inténtalo de nuevo.", true); return; } if (isGoogleSignedIn) { syncWithGoogleCalendar(); } else { googleAuthInstance.signIn(); } }
        
        // NUEVO: Función centralizada para construir el cuerpo del evento para la API de Google.
        function buildGoogleEventResource(item) {
            const resource = {
                'summary': item.description,
                'reminders': { 'useDefault': false, 'overrides': (item.notificationEnabled && !item.isAllDay) ? [{ 'method': 'popup', 'minutes': item.reminderMinutes }] : [] },
                'colorId': item.isImportant ? '11' : null // 11 es Rojo en Google Calendar
            };

            if (item.isAllDay) {
                const startDate = new Date(item.dueDate);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 1);
                resource.start = { 'date': dateToYYYYMMDD(startDate) };
                resource.end = { 'date': dateToYYYYMMDD(endDate) };
            } else {
                const startDate = new Date(item.dueDate);
                const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); // Duración de 1 hora por defecto
                resource.start = { 'dateTime': startDate.toISOString(), 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone };
                resource.end = { 'dateTime': endDate.toISOString(), 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone };
            }

            if (item.recurrenceRule && item.recurrenceRule !== 'none') {
                const recurrenceMap = { 'daily': 'DAILY', 'weekly': 'WEEKLY', 'monthly': 'MONTHLY', 'yearly': 'YEARLY' };
                resource.recurrence = [`RRULE:FREQ=${recurrenceMap[item.recurrenceRule]}`];
            }

            return resource;
        }

        async function crearEventoEnGoogle(item) { if (!isGoogleSignedIn || item.type !== 'agenda') return null; const eventResource = buildGoogleEventResource(item); try { const response = await gapi.client.calendar.events.insert({ 'calendarId': 'primary', 'resource': eventResource }); return response.result.id; } catch (error) { console.error('Error creando evento en Google:', error); throw error; } }
        async function actualizarEventoEnGoogle(item) { if (!isGoogleSignedIn || !item.googleCalendarEventId || item.type !== 'agenda') return; const eventResource = buildGoogleEventResource(item); try { await gapi.client.calendar.events.update({ 'calendarId': 'primary', 'eventId': item.googleCalendarEventId, 'resource': eventResource }); } catch (error) { console.error('Error actualizando evento en Google:', error); throw error; } }
        async function borrarEventoEnGoogle(item) { if (!isGoogleSignedIn || !item.googleCalendarEventId || item.type !== 'agenda') return; try { await gapi.client.calendar.events.delete({ 'calendarId': 'primary', 'eventId': item.googleCalendarEventId }); } catch (error) { console.error('Error eliminando evento en Google:', error); if (error.result && (error.result.error.code === 404 || error.result.error.code === 410)) { console.log("El evento ya no existía en Google Calendar."); } else { throw error; } } }
        
        // MODIFICADO: Convierte un evento de Google a un item de aiDANaI, gestionando eventos de día completo.
        function convertGoogleEventToAidanaiItem(googleEvent) {
            const dueDateISO = googleEvent.start?.dateTime || googleEvent.start?.date;
            if (!dueDateISO) return null;

            const isAllDay = !!googleEvent.start.date;
            const dueDate = new Date(dueDateISO);
            // Para eventos de día completo, la fecha de Google no tiene info de zona horaria, causando posibles desfases.
            // Forzamos la fecha a UTC para evitar que se muestre en el día anterior.
            if (isAllDay) {
                dueDate.setMinutes(dueDate.getMinutes() + dueDate.getTimezoneOffset());
            }

            return { 
                localId: uuid(), 
                googleCalendarEventId: googleEvent.id, 
                type: CONSTANTS.ITEM_TYPES.AGENDA, 
                description: googleEvent.summary || 'Sin Título', 
                dueDate: dueDate.toISOString(), 
                isAllDay: isAllDay,
                isComplete: false, 
                createdAt: new Date(googleEvent.created).getTime(), 
                updatedAt: new Date(googleEvent.updated).getTime(), 
                isImportant: googleEvent.colorId === '11', 
                notificationEnabled: !isAllDay && googleEvent.reminders?.useDefault === false && googleEvent.reminders?.overrides?.length > 0, 
                reminderMinutes: googleEvent.reminders?.overrides?.[0]?.minutes || 0, 
                recurrenceRule: 'none', // La importación de recurrencia es compleja, se omite por ahora para fiabilidad.
                notificationShown: false, 
            }; 
        }

        // MODIFICADO: Lógica de sincronización completamente reescrita para ser incremental y robusta.
        async function syncWithGoogleCalendar(forceFullSync = false) {
            if (isSyncingWithGoogle) { showToast("Sincronización ya en curso."); return; }
            if (!isGoogleSignedIn || !currentUser) return;
            
            const syncButton = gebi('google-sync-btn');
            isSyncingWithGoogle = true;
            syncButton.classList.add('loading');
            showToast("Sincronizando con Google Calendar...");

            try {
                const syncToken = forceFullSync ? null : db.config.googleSyncToken;
                let request;

                if (syncToken) {
                    console.log("Realizando sincronización incremental...");
                    request = gapi.client.calendar.events.list({ calendarId: 'primary', syncToken: syncToken });
                } else {
                    console.log("Realizando sincronización completa...");
                    const timeMin = new Date();
                    timeMin.setMonth(timeMin.getMonth() - 1); // 1 mes atrás
                    request = gapi.client.calendar.events.list({
                        calendarId: 'primary',
                        timeMin: timeMin.toISOString(),
                        showDeleted: true,
                        singleEvents: true,
                        maxResults: 2500
                    });
                }
                
                const response = await request;
                const googleEvents = response.result.items;
                let changesMade = false;

                // Procesar cambios recibidos de Google
                for (const googleEvent of googleEvents) {
                    const existingItemIndex = db.items.findIndex(i => i.googleCalendarEventId === googleEvent.id);

                    if (googleEvent.status === 'cancelled') {
                        // El evento fue eliminado en Google, lo eliminamos aquí.
                        if (existingItemIndex > -1) {
                            db.items.splice(existingItemIndex, 1);
                            changesMade = true;
                            console.log(`Evento eliminado desde Google: ${googleEvent.summary}`);
                        }
                    } else {
                        // El evento fue creado o actualizado en Google.
                        const newItem = convertGoogleEventToAidanaiItem(googleEvent);
                        if (!newItem) continue;

                        if (existingItemIndex > -1) {
                            // Actualizar item existente
                            db.items[existingItemIndex] = { ...db.items[existingItemIndex], ...newItem, localId: db.items[existingItemIndex].localId };
                            console.log(`Evento actualizado desde Google: ${newItem.description}`);
                        } else {
                            // Añadir nuevo item
                            db.items.unshift(newItem);
                            console.log(`Evento añadido desde Google: ${newItem.description}`);
                        }
                        changesMade = true;
                    }
                }

                // Subir a Google eventos que solo existen localmente
                const localOnlyEvents = db.items.filter(item => item.type === 'agenda' && !item.isComplete && !item.googleCalendarEventId);
                if (localOnlyEvents.length > 0) {
                    console.log(`Subiendo ${localOnlyEvents.length} eventos locales a Google...`);
                    for (const localEvent of localOnlyEvents) {
                        const newGoogleId = await crearEventoEnGoogle(localEvent);
                        if (newGoogleId) {
                            const eventIndex = db.items.findIndex(i => i.localId === localEvent.localId);
                            if (eventIndex > -1) {
                                db.items[eventIndex].googleCalendarEventId = newGoogleId;
                                db.items[eventIndex].updatedAt = Date.now();
                                changesMade = true;
                            }
                        }
                    }
                }

                // Guardar el nuevo syncToken para la próxima vez
                const newSyncToken = response.result.nextSyncToken;
                if (newSyncToken) {
                    db.config.googleSyncToken = newSyncToken;
                }

                if (changesMade) {
                    showToast("Sincronización completada. Datos actualizados.", false);
                    await saveData();
                    renderApp();
                } else {
                    showToast("Tus datos ya estaban sincronizados.", false);
                }

            } catch (error) {
                if (error.result && error.result.error.code === 410) {
                    // El syncToken ha expirado. Forzamos una sincronización completa.
                    console.warn("Sync token inválido. Realizando sincronización completa.");
                    showToast("La sesión de Google requiere una resincronización completa.", true);
                    db.config.googleSyncToken = null;
                    await saveData();
                    syncWithGoogleCalendar(true); // Llamada recursiva para reintentar con sync completa
                } else {
                    showToast("Ocurrió un error durante la sincronización.", true);
                    console.error("Error en syncWithGoogleCalendar:", error);
                }
            } finally {
                isSyncingWithGoogle = false;
                syncButton.classList.remove('loading');
            }
        }
        
    document.addEventListener('DOMContentLoaded', initApp);
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="handleGoogleClientLoad()"></script>
</body>
</html>
