<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Agenda aiDANaI</title>

    <!-- DEPENDENCIAS -->
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1C1B1F">
    <link rel="apple-touch-icon" href="aiDANaI-Agenda.jpg">

    <style>
        /* --- ESTILOS DE 'agenda.html' MEJORADOS Y ADAPTADOS --- */
        :root {
            --primary-color: #6750A4;
            --primary-variant: #4F378B;
            --secondary-color: #625B71;
            --background: #FFFBFE;
            --surface: #FFFFFF;
            --surface-variant: #F3F0F4;
            --on-primary: #FFFFFF;
            --on-secondary: #FFFFFF;
            --on-background: #1C1B1F;
            --on-surface: #1C1B1F;
            --outline: #C0BFC4; /* Lighter outline */
            --shadow: rgba(0,0,0,0.1);
            
            --accent-dani: #4A90E2;
            --accent-norma: #D0021B;
            --accent-comun: #50E3C2;
            --accent-delete: #FF453A;
            --accent-complete: #4CAF50;

            --current-user-accent: var(--accent-dani);
            --font-roboto: 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        [data-theme="dark"] {
            --primary-color: #D0BCFF;
            --secondary-color: #CCC2DC;
            --background: #1C1B1F;
            --surface: #2B2930;
            --surface-variant: #49454F;
            --on-primary: #371E73;
            --on-background: #E6E1E5;
            --on-surface: #E6E1E5;
            --outline: #5F5C63; /* Darker outline */
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; }
        body { font-family: var(--font-roboto); background-color: var(--background); color: var(--on-background); line-height: 1.5; overflow: hidden; min-height: 100vh; min-height: -webkit-fill-available; height: 100vh; transition: background-color 0.3s, color 0.3s; }
        *:focus-visible { outline: 2px solid var(--current-user-accent); outline-offset: 2px; border-radius: 4px; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        /* --- PANTALLAS INICIALES --- */
        .intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; background: #000; transition: opacity 0.5s ease-out; }
        .intro-screen.visible { display: flex; }
        #welcomeScreen #welcomeImage { width: 250px; height: auto; opacity: 0; animation: growAndFade 2.5s ease-in-out forwards; }
        @keyframes growAndFade { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }

        #quoteScreen { text-align: center; color: #FFF; padding: 20px; opacity: 0; transition: opacity 1.5s; }
        #quoteScreen.visible { opacity: 1; }
        #quoteText { font-size: 22px; font-style: italic; font-weight: 300; max-width: 600px; }
        #quoteAuthor { display: block; font-size: 16px; margin-top: 12px; font-weight: 500; }
        
        /* --- ESTRUCTURA PRINCIPAL --- */
        #app-root { display: none; max-width: 420px; margin: 0 auto; height: 100vh; background: var(--background); position: relative; flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; padding-bottom: calc(65px + env(safe-area-inset-bottom)); }
        #app-root.visible { display: flex; opacity: 1; }
        .main-content { flex: 1; display: flex; position: relative; overflow: hidden; }
        .view { display: none; width: 100%; flex-direction: column; animation: fadeIn 0.3s ease-in-out; height: 100%; overflow: hidden; }
        #tasksView, #helpView, #searchView { overflow-y: auto; padding: 16px; padding-bottom: 80px; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- VISTA CALENDARIO/AGENDA UNIFICADA --- */
        #calendarView { padding: 0; }
        .calendar-container { flex-shrink: 0; padding: 12px; border-bottom: 1px solid var(--outline); }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; position: relative; }
        #calendar-title-btn { font-size: 18px; font-weight: 500; background: none; border: none; color: var(--on-background); padding: 4px 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #calendar-title-btn:hover { background-color: var(--surface-variant); }
        .calendar-nav { display: flex; align-items: center; gap: 0; }
        .icon-button { background: none; border: none; color: var(--secondary-color); cursor: pointer; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s; }
        .icon-button:hover { background-color: var(--surface-variant); color: var(--on-surface); }
        .calendar-grid { background: var(--surface); border-radius: 12px; padding: 8px; box-shadow: 0 1px 4px var(--shadow); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
        .weekday { text-align: center; font-size: 11px; font-weight: 500; color: var(--secondary-color); padding: 2px; }
        .weekday.saturday { color: var(--accent-dani); } .weekday.sunday { color: var(--accent-norma); }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; position: relative; font-size: 13px; transition: all 0.2s; }
        .calendar-day:hover { background: var(--surface-variant); }
        .calendar-day.today .day-number { background: var(--primary-color); color: var(--on-primary); font-weight: 700; }
        .calendar-day.selected .day-number { background: var(--primary-variant); color: var(--on-primary); }
        .calendar-day.other-month { color: var(--outline); pointer-events: none; }
        .day-number { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .calendar-day .event-dots-container { position: absolute; bottom: 3px; left: 0; right: 0; display: flex; justify-content: center; gap: 2px; }
        .calendar-day .event-dot { width: 4px; height: 4px; border-radius: 50%; }

        #search-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--background); display: none; align-items: center; z-index: 10; padding: 0 4px; }
        #search-input { width: 100%; border: none; background: var(--surface-variant); color: var(--on-surface); padding: 8px 12px; border-radius: 18px; font-size: 14px; }
        #search-input:focus { outline: none; box-shadow: 0 0 0 2px var(--primary-color); }
        
        .agenda-list-container { flex-grow: 1; overflow-y: auto; padding-top: 8px; padding-bottom: 80px; }
        .agenda-date-header { font-weight: 500; color: var(--primary-color); padding: 4px 16px; background-color: var(--surface-variant); position: sticky; top: 0; z-index: 1; }
        .agenda-item-compact { user-select: none; position: relative; }
        .agenda-item-content { display: flex; align-items: center; gap: 8px; padding: 6px 16px; font-size: 14px; cursor: pointer; transition: background-color 0.2s; background-color: var(--surface); border-bottom: 1px solid var(--surface-variant); }
        .agenda-item-content:hover { background-color: var(--surface-variant); }
        .agenda-item-compact.completed .agenda-item-content { opacity: 0.6; }
        .agenda-item-compact.completed .title { text-decoration: line-through; }
        .agenda-item-content .indicator { width: 4px; height: 18px; border-radius: 2px; flex-shrink: 0; }
        .agenda-item-content .time { font-weight: 500; min-width: 50px; }
        .agenda-item-content .title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- VISTA TAREAS Y AYUDA --- */
        .task-filters { display: flex; gap: 12px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px; flex-wrap: wrap; justify-content: center; }
        .filter-group { display: flex; align-items: center; gap: 8px; background: var(--surface-variant); padding: 6px 14px; border-radius: 20px; }
        .filter-group label { font-size: 14px; cursor: pointer; font-weight: 500; }
        .filter-group input { accent-color: var(--primary-color); cursor: pointer; }
        
        .list-item-swipe-container { display: flex; align-items: center; background: var(--surface); border-radius: 12px; margin-bottom: 8px; box-shadow: 0 1px 4px var(--shadow); transition: all 0.2s; user-select: none; position: relative; }
        .list-item-swipe-container .item-content { flex: 1; cursor: pointer; }
        .item-card-swipe-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: white; opacity: 0; transition: opacity 0.2s; z-index: -1; }
        .item-card-swipe-background .material-icons { font-size: 28px; }
        .list-item-swipe-container.swiping-right .item-card-swipe-background { background-color: var(--accent-complete); justify-content: flex-start; opacity: 1; }
        .list-item-swipe-container.swiping-left .item-card-swipe-background { background-color: var(--accent-delete); justify-content: flex-end; opacity: 1; }
        .list-item-swipe-container.task-item { padding: 10px 12px; border-left: 5px solid transparent; }

        .list-item-swipe-container.completed { opacity: 0.6; }
        .task-checkbox { width: 20px; height: 20px; border: 2px solid var(--outline); border-radius: 50%; margin-right: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .task-checkbox.checked { background: var(--accent-complete); border-color: var(--accent-complete); color: white; }
        .item-title { font-weight: 500; }
        .item-title.completed { text-decoration: line-through; }
        .item-meta { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--secondary-color); }
        .item-actions button { color: var(--secondary-color); }

        .settings-section { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 4px var(--shadow); }
        .section-title { font-size: 18px; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .help-section details { margin-bottom: 8px; border: 1px solid var(--surface-variant); border-radius: 8px; }
        .help-section summary { font-weight: 500; cursor: pointer; padding: 12px; display: flex; align-items: center; justify-content: space-between; }
        .help-section summary .material-icons { transition: transform 0.2s; }
        .help-section details[open] summary .material-icons { transform: rotate(180deg); }
        .help-section .details-content { padding: 0 12px 12px 12px; font-size: 14px; line-height: 1.6; }
        .details-content p, .details-content li { margin-bottom: 10px; } .details-content ul { padding-left: 20px; }
        .details-content .material-icons { font-size: 16px; vertical-align: -3px; margin: 0 2px; color: var(--primary-color); }
        .details-content b { color: var(--on-surface); }
        
        .theme-switcher { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; }
        
        /* --- BOTONES Y NAVEGACIÓN --- */
        .fab { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); right: 24px; width: 56px; height: 56px; background: var(--current-user-accent); color: white; border: none; border-radius: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px var(--shadow); transition: all 0.2s; z-index: 50; }
        .fab:hover { transform: scale(1.1); }
        #themeToggleBtn { position: fixed; bottom: calc(84px + env(safe-area-inset-bottom)); left: 24px; width: 48px; height: 48px; background-color: var(--secondary-color); color: var(--on-secondary); border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px var(--shadow); z-index: 50; cursor: pointer; transition: all 0.2s; }
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 420px; background: var(--surface); border-top: 1px solid var(--outline); display: flex; padding: 4px 0 calc(8px + env(safe-area-inset-bottom)) 0; z-index: 100; box-shadow: 0 -2px 8px var(--shadow); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 4px 8px; cursor: pointer; transition: color 0.2s; color: var(--secondary-color); }
        .nav-item.active { color: var(--current-user-accent); }
        .nav-item .material-icons { font-size: 24px; margin-bottom: 2px; }
        .nav-label { font-size: 12px; font-weight: 500; }
        
        /* --- MODAL (FORMULARIO COMPACTO) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; padding: 16px; animation: modalFadeIn 0.3s; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--surface); border-radius: 24px; padding: 20px; width: 100%; max-width: 360px; max-height: 95vh; overflow-y: auto; box-shadow: 0 8px 32px var(--shadow); }
        
        /* CAMBIO: Se oculta el título del modal */
        .modal-title { display: none; }

        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--secondary-color); }
        .form-input, .form-select { width: 100%; padding: 10px; border: 2px solid var(--outline); border-radius: 8px; background: var(--surface); color: var(--on-surface); font-size: 14px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-color); }
        .form-group-datetime { display: none; }
        .form-group-row { display: flex; gap: 8px; align-items: flex-end; }
        .form-group-row .form-group { flex: 1; margin-bottom: 0; }
        .form-group-inline { display: flex; align-items: center; gap: 8px; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--current-user-accent); color: white; }
        .btn-secondary { background: transparent; color: var(--secondary-color); }
        .btn-danger { background-color: transparent; border: 1px solid var(--accent-delete); color: var(--accent-delete); }
        .btn-danger:hover { background-color: rgba(255, 69, 58, 0.1); }

        /* CAMBIO: Estilo para los botones de icono en el modal */
        .modal-actions .btn {
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .modal-actions .btn-secondary {
             border: 1px solid var(--outline);
        }
        .modal-actions .btn .material-icons {
            font-size: 24px;
        }

        /* --- COMPONENTES ADICIONALES --- */
        #sync-indicator { width: 22px; height: 22px; color: var(--primary-color); animation: spin 1s linear infinite; display: none; }
        #sync-indicator.active { display: block; } @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 48px 24px; color: var(--secondary-color); }
        #toast-container { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 2000; width: max-content; max-width: 90%; pointer-events: none; }
        .toast { background-color: rgba(40, 40, 40, 0.95); backdrop-filter: blur(5px); color: white; padding: 10px 16px; border-radius: 8px; margin-bottom: 6px; box-shadow: 0 2px 6px var(--shadow); display: flex; align-items: center; animation: toastFadeIn 0.3s, toastFadeOut 0.3s 2.7s; font-size: 14px; }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; translateY(10px); } }
        #pull-to-refresh-indicator { position: absolute; top: -50px; left: 0; right: 0; height: 50px; display: flex; align-items: center; justify-content: center; color: var(--secondary-color); transition: top 0.2s, transform 0.2s; z-index: 5; }
        #pull-to-refresh-indicator .material-icons { font-size: 28px; transition: transform 0.2s; }
    </style>
</head>
<body>
    
    <!-- PANTALLAS INICIALES -->
    <div id="welcomeScreen" class="intro-screen visible"><img src="aiDANaI-Agenda.jpg" id="welcomeImage" alt="Logo Agenda aiDANaI"></div>
    <div id="quoteScreen" class="intro-screen"><p id="quoteText"></p><span id="quoteAuthor"></span></div>

    <!-- CONTENEDOR PRINCIPAL DE LA APP -->
    <div id="app-root">
        <main class="main-content" id="main-content-area">
            
            <!-- VISTA CALENDARIO -->
            <div id="calendarView" class="view active">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button id="calendar-title-btn" title="Seleccionar mes y año"></button>
                        <div id="search-container"><input type="search" id="search-input" placeholder="Buscar eventos o tareas..." aria-label="Buscar ítems"></div>
                        <div class="calendar-nav">
                             <button id="search-btn" class="icon-button" title="Buscar"><span class="material-icons">search</span></button>
                             <button id="today-btn" class="icon-button" title="Hoy"><span class="material-icons">today</span></button>
                             <button id="prev-month-btn" class="icon-button" title="Mes anterior"><span class="material-icons">chevron_left</span></button>
                             <button id="next-month-btn" class="icon-button" title="Mes siguiente"><span class="material-icons">chevron_right</span></button>
                             <div id="sync-indicator" role="status"><span class="material-icons">sync</span></div>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-weekdays" id="calendarWeekdays"></div>
                        <div class="calendar-days" id="calendarDays"></div>
                    </div>
                </div>
                <div class="agenda-list-container" id="agendaListContainer">
                     <h3 class="section-title" style="padding: 0 16px;"><span class="material-icons">view_agenda</span>Próximos 7 días</h3>
                    <div id="agendaList"></div>
                </div>
            </div>

            <!-- VISTA TAREAS -->
            <div id="tasksView" class="view">
                <div class="task-filters">
                    <div class="filter-group"><input type="radio" id="filterAll" name="task-filter" value="all" checked><label for="filterAll">Todos</label></div>
                    <div class="filter-group"><input type="radio" id="filterDani" name="task-filter" value="Dani"><label for="filterDani" style="color: var(--accent-dani);">Dani</label></div>
                    <div class="filter-group"><input type="radio" id="filterNorma" name="task-filter" value="Norma"><label for="filterNorma" style="color: var(--accent-norma);">Norma</label></div>
                    <div class="filter-group"><input type="radio" id="filterComun" name="task-filter" value="Comun"><label for="filterComun" style="color: var(--accent-comun);">Común</label></div>
                </div>
                <h3 class="section-title" id="pending-tasks-title">Pendientes</h3>
                <div id="pendingTasksList"></div>
                <h3 class="section-title" id="completed-tasks-title" style="margin-top:24px;">Completadas</h3>
                <div id="completedTasksList"></div>
                <div id="emptyTasks" class="empty-state" style="display: none;"></div>
            </div>
            
            <!-- VISTA DE BÚSQUEDA -->
            <div id="searchView" class="view">
                <h3 class="section-title">Resultados de la Búsqueda</h3>
                <div id="searchResultsList"></div>
            </div>

            <!-- VISTA AYUDA (CAMBIO: Contenido completamente reescrito y detallado) -->
            <div id="helpView" class="view">
                <div class="settings-section help-section">
                    <h3 class="section-title" style="font-size: 20px;"><span class="material-icons">rocket_launch</span>¡Bienvenido/a a tu Agenda!</h3>
                    <p style="padding: 0 4px 12px; font-size: 15px; color: var(--secondary-color);">Esta es tu central de organización compartida, diseñada para ser rápida, inteligente y funcionar siempre, incluso sin internet.</p>

                    <details open>
                        <summary>Gestión Rápida de Ítems<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                            <p>La agilidad es clave. Gestiona todo con acciones simples e intuitivas:</p>
                            <ul>
                                <li><b>Añadir:</b> Pulsa el botón flotante <span class="material-icons" style="background: var(--current-user-accent); color: var(--on-primary); border-radius: 8px; padding: 2px;">add</span> para abrir el formulario y crear un nuevo evento o tarea.</li>
                                <li><b>Editar:</b> Un simple <b>toque sobre cualquier tarea o evento</b> en una lista abrirá la pantalla de edición con toda su información. ¡Así de fácil!</li>
                                <li><b>Completar (Gesto Mágico →):</b> En las vistas de Agenda o Tareas, <b>desliza cualquier ítem hacia la derecha</b> para marcarlo como completado. Verás cómo se atenúa al instante.</li>
                                <li><b>Eliminar (Gesto Mágico ←):</b> <b>Desliza un ítem hacia la izquierda</b> para eliminarlo. Por seguridad, te pediremos confirmación antes de borrarlo para siempre.</li>
                                 <li><b>Duplicar:</b> ¿Una tarea repetitiva? En la vista de Tareas, pulsa el icono <span class="material-icons">content_copy</span> en una tarea para crear un clon instantáneo, listo para ser modificado.</li>
                            </ul>
                        </div>
                    </details>
                     <details>
                        <summary>La Vista de Agenda: Tu Calendario<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                             <p>Tu centro de mando para eventos y citas. Aquí puedes:</p>
                             <ul>
                                <li><b>Navegar Meses:</b> Usa las flechas <span class="material-icons">chevron_left</span> y <span class="material-icons">chevron_right</span> para moverte rápidamente entre meses.</li>
                                <li><b>Saltar a una Fecha:</b> Toca el <b>nombre del mes</b> (ej: "Diciembre 2024") para abrir un selector y saltar a cualquier mes y año que desees.</li>
                                <li><b>Volver a Hoy:</b> No importa dónde estés, el icono <span class="material-icons">today</span> te devolverá al día actual con un solo toque.</li>
                                 <li><b>Identificar Días Ocupados:</b> Los pequeños <b>puntos de colores</b> debajo de un número de día son un indicador visual. Cada punto representa un ítem agendado, coloreado según su propietario (<span style="color:var(--accent-dani)">Dani</span>, <span style="color:var(--accent-norma)">Norma</span> o <span style="color:var(--accent-comun)">Común</span>).</li>
                                 <li><b>Ver Próximos Eventos:</b> Debajo del calendario, tienes una lista clara y compacta de todos tus eventos y tareas para los próximos 7 días.</li>
                            </ul>
                        </div>
                    </details>
                     <details>
                        <summary>La Vista de Tareas: Tu Lista de Pendientes<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                             <p>Aquí es donde las cosas se hacen. Organiza tus tareas de forma eficiente:</p>
                             <ul>
                                <li><b>Filtra por Propietario:</b> Usa los filtros en la parte superior para ver <b>todas</b> las tareas, o solo las de <b>Dani</b>, <b>Norma</b> o las <b>Comunes</b>.</li>
                                <li><b>Indicador de Color:</b> Cada tarea tiene una barra de color a la izquierda que te indica rápidamente a quién pertenece.</li>
                                 <li><b>Listas Separadas:</b> Las tareas se dividen automáticamente en "Pendientes" y "Completadas" para mantener todo ordenado y darte la satisfacción de ver tu progreso.</li>
                            </ul>
                        </div>
                    </details>
                     <details>
                        <summary>Funciones Avanzadas y "Virtudes"<span class="material-icons">expand_more</span></summary>
                        <div class="details-content">
                             <p>Esta agenda tiene superpoderes que la hacen única:</p>
                             <ul>
                                 <li><b>Búsqueda Global:</b> En la vista de Agenda, toca la lupa <span class="material-icons">search</span>. Se abrirá una barra para que busques instantáneamente cualquier ítem por su descripción.</li>
                                 <li><b>¡Funciona Offline!:</b> La virtud más importante. Puedes usar la app, crear, editar y completar ítems <b>sin conexión a internet</b>. Todos tus cambios se guardan localmente.</li>
                                 <li><b>Sincronización Inteligente:</b> En cuanto recuperes la conexión, la app sincronizará todos tus cambios con la nube de forma automática. El icono <span class="material-icons">sync</span> girando te indicará que está trabajando.</li>
                                 <li><b>Forzar Sincronización:</b> Si quieres asegurarte de tener los últimos datos, simplemente <b>arrastra la pantalla hacia abajo</b> desde la parte superior ("Pull to Refresh") en cualquier vista para forzar una sincronización manual.</li>
                             </ul>
                        </div>
                    </details>
                </div>
                <div class="settings-section">
                     <h3 class="section-title"><span class="material-icons">settings</span>Configuración y Mantenimiento</h3>
                     <div class="theme-switcher">
                         <span>Alternar Modo Oscuro/Claro</span>
                         <button id="themeToggleBtn" class="icon-button"><span class="material-icons" id="themeIcon">dark_mode</span></button>
                     </div>
                     <button class="btn btn-secondary" id="cleanup-tasks-btn" style="width:100%; margin-top: 1rem;">Limpiar tareas antiguas</button>
                     <p style="font-size: 12px; color: var(--secondary-color); padding: 4px 8px;">Elimina tareas completadas hace más de 30 días para mantener la lista despejada.</p>
                     <button class="btn btn-secondary" id="logout-btn" style="width:100%; margin-top: 1rem; border-color: var(--accent-delete); color: var(--accent-delete);">Cerrar Sesión</button>
                </div>
            </div>
        </main>

        <button id="fab-add-item" class="fab"><span class="material-icons">add</span></button>
        <nav class="bottom-nav">
            <button class="nav-item active" data-view="calendar"><span class="material-icons">calendar_today</span><span class="nav-label">Agenda</span></button>
            <button class="nav-item" data-view="tasks"><span class="material-icons">task_alt</span><span class="nav-label">Tareas</span></button>
            <button class="nav-item" data-view="help"><span class="material-icons">help_outline</span><span class="nav-label">Ayuda</span></button>
        </nav>
    </div>

    <!-- MODAL DE CREACIÓN/EDICIÓN -->
    <div id="add-item-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="modal-title-h3" class="modal-title">Crear Nuevo</h2>
            <form id="add-item-form">
                <input type="hidden" id="item-id"><input type="hidden" id="item-local-id">
                
                <div class="form-group">
                    <label class="form-label" for="item-description">Descripción</label>
                    <textarea class="form-input" id="item-description" rows="2" placeholder="Describe el ítem..."></textarea>
                </div>

                <div class="form-group-row">
                    <div class="form-group">
                        <label class="form-label" for="item-type">Tipo</label>
                        <select class="form-select" id="item-type">
                            <option value="agenda">Evento</option>
                            <option value="task">Tarea</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label class="form-label" for="item-owner">Propietario</label>
                        <select class="form-select" id="item-owner">
                            <option value="Dani">Dani</option>
                            <option value="Norma">Norma</option>
                            <option value="Comun">Común</option>
                        </select>
                    </div>
                </div>
                
                <div id="datetime-notification-group" class="form-group-datetime">
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label" for="item-due-date">Fecha</label>
                            <input type="date" class="form-input" id="item-due-date">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="item-due-time">Hora</label>
                            <input type="time" class="form-input" id="item-due-time">
                        </div>
                    </div>
                    <div class="form-group form-group-inline" style="margin-top: 12px;">
                        <input type="checkbox" id="item-notification-enabled" style="width: auto; height: 20px;">
                        <label for="item-notification-enabled" style="margin-bottom: 0; font-weight: normal; color: var(--on-surface);">Activar notificación</label>
                    </div>
                </div>
                
                <!-- CAMBIO: Botones de texto reemplazados por iconos -->
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" id="delete-item-btn" style="margin-right: auto; display: none;" title="Eliminar"><span class="material-icons">delete</span></button>
                    <button type="button" class="btn btn-secondary" id="cancel-item-btn" title="Cancelar"><span class="material-icons">close</span></button>
                    <button type="submit" class="btn btn-primary" id="save-item-btn" title="Guardar"><span class="material-icons">check</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL DE SELECCIÓN DE FECHA -->
    <div id="date-picker-modal" class="modal-overlay">
         <div class="modal">
            <h3 class="modal-title">Ir a la fecha</h3>
            <form id="date-picker-form">
                <div class="form-group"><label class="form-label">Mes</label><select id="month-select" class="form-select"></select></div>
                <div class="form-group"><label class="form-label">Año</label><input type="number" id="year-select" min="2020" max="2030" step="1" class="form-input"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-date-picker-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Ir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOASTS Y OTROS ELEMENTOS -->
    <div id="toast-container" aria-live="assertive"></div>
    <div id="swipe-tooltip-overlay" style="display:none;"></div> <!-- Lógica JS lo controla -->

    <script>
    // --- LÓGICA COMPLETA DE 'index.html' ---

    // --- CONFIGURACIÓN E INICIALIZACIÓN DE PARSE ---
    const PARSE_APP_ID = "v6TC3TP1vvPfkVXErWsox54UQtj9G6vJr8aTWpLl";
    const PARSE_JS_KEY = "ZomACaFL7RcBKbwfOvonnJ4JLNp1jBTlYaDTIMhy";
    const PARSE_SERVER_URL = "https://parseapi.back4app.com/";
    Parse.initialize(PARSE_APP_ID, PARSE_JS_KEY);
    Parse.serverURL = PARSE_SERVER_URL;

    // --- CONSTANTES Y HELPERS ---
    const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const DIAS_SEMANA = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
    
    // CAMBIO: Lista de 100 citas motivadoras
    const QUOTES = [
        { text: "La única forma de hacer un gran trabajo es amar lo que haces.", author: "Steve Jobs" },
        { text: "El futuro pertenece a quienes creen en la belleza de sus sueños.", author: "Eleanor Roosevelt" },
        { text: "Cree que puedes y ya estás a medio camino.", author: "Theodore Roosevelt" },
        { text: "El éxito es la suma de pequeños esfuerzos repetidos día tras día.", author: "Robert Collier" },
        { text: "No esperes. El tiempo nunca será el adecuado.", author: "Napoleon Hill" },
        { text: "La mejor manera de predecir el futuro es crearlo.", author: "Peter Drucker" },
        { text: "El único lugar donde el éxito viene antes que el trabajo es en el diccionario.", author: "Vidal Sassoon" },
        { text: "No cuentes los días, haz que los días cuenten.", author: "Muhammad Ali" },
        { text: "El optimismo es la fe que conduce al logro. Nada puede hacerse sin esperanza y confianza.", author: "Helen Keller" },
        { text: "El secreto para salir adelante es empezar.", author: "Mark Twain" },
        { text: "Un viaje de mil millas comienza con un solo paso.", author: "Lao Tse" },
        { text: "La vida es un 10% lo que te sucede y un 90% cómo reaccionas a ello.", author: "Charles R. Swindoll" },
        { text: "La disciplina es el puente entre las metas y los logros.", author: "Jim Rohn" },
        { text: "No tengas miedo de renunciar a lo bueno para ir a por lo grandioso.", author: "John D. Rockefeller" },
        { text: "La inspiración existe, pero tiene que encontrarte trabajando.", author: "Pablo Picasso" },
        { text: "El mayor riesgo es no correr ningún riesgo.", author: "Mark Zuckerberg" },
        { text: "Haz de cada día tu obra maestra.", author: "John Wooden" },
        { text: "La clave del éxito es empezar antes de estar listo.", author: "Marie Forleo" },
        { text: "Los obstáculos son esas cosas espantosas que ves cuando apartas los ojos de tu meta.", author: "Henry Ford" },
        { text: "Si puedes soñarlo, puedes hacerlo.", author: "Walt Disney" },
        { text: "La perseverancia no es una carrera larga; son muchas carreras cortas una tras otra.", author: "Walter Elliot" },
        { text: "El genio se compone de un 2% de talento y un 98% de perseverante aplicación.", author: "Ludwig van Beethoven" },
        { text: "La acción es la clave fundamental de todo éxito.", author: "Pablo Picasso" },
        { text: "Lo que la mente del hombre puede concebir y creer, puede lograrlo.", author: "Napoleon Hill" },
        { text: "No juzgues cada día por la cosecha que recoges, sino por las semillas que plantas.", author: "Robert Louis Stevenson" },
        { text: "Nunca eres demasiado viejo para fijarte otra meta o para soñar un nuevo sueño.", author: "C.S. Lewis" },
        { text: "El fracaso es simplemente la oportunidad de empezar de nuevo, esta vez de forma más inteligente.", author: "Henry Ford" },
        { text: "Para tener éxito, tu deseo de éxito debe ser mayor que tu miedo al fracaso.", author: "Bill Cosby" },
        { text: "El carácter no se puede desarrollar en la facilidad y la tranquilidad. Solo a través de la experiencia de la prueba y el sufrimiento se puede fortalecer el alma.", author: "Helen Keller" },
        { text: "La forma más segura de no fracasar es decidirse a triunfar.", author: "Richard B. Sheridan" },
        { text: "El coraje no es la ausencia de miedo, sino el triunfo sobre él.", author: "Nelson Mandela" },
        { text: "La calidad no es un acto, es un hábito.", author: "Aristóteles" },
        { text: "La oportunidad es a menudo desaprovechada porque se viste con un mono de trabajo y parece trabajo.", author: "Thomas A. Edison" },
        { text: "Los campeones siguen jugando hasta que lo hacen bien.", author: "Billie Jean King" },
        { text: "El que no está lo suficientemente ocupado naciendo, está ocupado muriendo.", author: "Bob Dylan" },
        { text: "La vida se encoge o se expande en proporción al coraje de uno.", author: "Anaïs Nin" },
        { text: "Todo lo que siempre has querido está al otro lado del miedo.", author: "George Addair" },
        { text: "El momento en que dudas si puedes volar, cesas para siempre de poder hacerlo.", author: "J.M. Barrie, Peter Pan" },
        { text: "La diferencia entre lo ordinario y lo extraordinario es ese pequeño extra.", author: "Jimmy Johnson" },
        { text: "La lógica te llevará de A a B. La imaginación te llevará a todas partes.", author: "Albert Einstein" },
        { text: "No dejes que el ayer ocupe demasiado del hoy.", author: "Will Rogers" },
        { text: "La excelencia es hacer una cosa común de una manera poco común.", author: "Booker T. Washington" },
        { text: "Si no te gusta algo, cámbialo. Si no puedes cambiarlo, cambia tu actitud.", author: "Maya Angelou" },
        { text: "La felicidad no es algo ya hecho. Viene de tus propias acciones.", author: "Dalai Lama" },
        { text: "Un objetivo sin un plan es solo un deseo.", author: "Antoine de Saint-Exupéry" },
        { text: "Cae siete veces, levántate ocho.", author: "Proverbio japonés" },
        { text: "Tu tiempo es limitado, no lo malgastes viviendo la vida de otra persona.", author: "Steve Jobs" },
        { text: "La mejor venganza es un éxito masivo.", author: "Frank Sinatra" },
        { text: "La gente exitosa y no exitosa no varían mucho en sus habilidades. Varían en sus deseos de alcanzar su potencial.", author: "John Maxwell" },
        { text: "La pregunta no es quién me va a dejar; es quién me va a parar.", author: "Ayn Rand" },
        { text: "No mires el reloj; haz lo que él hace. Sigue moviéndote.", author: "Sam Levenson" },
        { text: "No es la montaña que conquistamos, sino a nosotros mismos.", author: "Sir Edmund Hillary" },
        { text: "La creatividad es la inteligencia divirtiéndose.", author: "Albert Einstein" },
        { text: "Construye tus propios sueños, o alguien más te contratará para construir los suyos.", author: "Farrah Gray" },
        { text: "Un ganador es un soñador que nunca se rinde.", author: "Nelson Mandela" },
        { text: "La única limitación para nuestra realización de mañana serán nuestras dudas de hoy.", author: "Franklin D. Roosevelt" },
        { text: "Siempre parece imposible hasta que se hace.", author: "Nelson Mandela" },
        { text: "La motivación es lo que te pone en marcha. El hábito es lo que hace que sigas.", author: "Jim Ryun" },
        { text: "La vida es como montar en bicicleta. Para mantener el equilibrio, debes seguir moviéndote.", author: "Albert Einstein" },
        { text: "El éxito no es el final, el fracaso no es fatal: es el coraje de continuar lo que cuenta.", author: "Winston Churchill" },
        { text: "El trabajo duro vence al talento cuando el talento no trabaja duro.", author: "Tim Notke" },
        { text: "No soy producto de mis circunstancias. Soy producto de mis decisiones.", author: "Stephen Covey" },
        { text: "El único modo de hacer un gran trabajo es amar lo que haces.", author: "Steve Jobs" },
        { text: "La vida es una aventura atrevida o no es nada.", author: "Helen Keller" },
        { text: "El conocimiento es poder, pero el entusiasmo aprieta el interruptor.", author: "Ivern Ball" },
        { text: "Si la oportunidad no llama, construye una puerta.", author: "Milton Berle" },
        { text: "La mente es todo. En lo que piensas, te conviertes.", author: "Buda" },
        { text: "He fallado una y otra y otra vez en mi vida. Y es por eso que tengo éxito.", author: "Michael Jordan" },
        { text: "La gente que está lo suficientemente loca como para pensar que puede cambiar el mundo, es la que lo hace.", author: "Rob Siltanen" },
        { text: "No importa lo lento que vayas, siempre y cuando no te detengas.", author: "Confucio" },
        { text: "Todo lo que puedes imaginar es real.", author: "Pablo Picasso" },
        { text: "Un hombre creativo está motivado por el deseo de alcanzar, no por el deseo de vencer a otros.", author: "Ayn Rand" },
        { text: "No dejes que lo que no puedes hacer interfiera con lo que puedes hacer.", author: "John Wooden" },
        { text: "La mejor gloria no es nunca caer, sino levantarse cada vez que caemos.", author: "Confucio" },
        { text: "El dolor que sientes hoy será la fuerza que sentirás mañana.", author: "Anónimo" },
        { text: "Empieza donde estás. Usa lo que tienes. Haz lo que puedes.", author: "Arthur Ashe" },
        { text: "La actitud es una pequeña cosa que marca una gran diferencia.", author: "Winston Churchill" },
        { text: "Los soñadores son los salvadores del mundo.", author: "James Allen" },
        { text: "Un día o día uno. Tú decides.", author: "Anónimo" },
        { text: "Lo que obtienes al alcanzar tus metas no es tan importante como en lo que te conviertes al alcanzarlas.", author: "Zig Ziglar" },
        { text: "El futuro recompensa a los que siguen adelante. No tengo tiempo para sentir pena por mí mismo. No tengo tiempo para quejarme. Voy a seguir adelante.", author: "Barack Obama" },
        { text: "La persona que dice que no se puede hacer no debería interrumpir a la persona que lo está haciendo.", author: "Proverbio chino" },
        { text: "No es lo que miras lo que importa, es lo que ves.", author: "Henry David Thoreau" },
        { text: "La vida es un lienzo en blanco, y debes tirar toda la pintura que puedas en él.", author: "Danny Kaye" },
        { text: "La única manera de hacer un trabajo genial es amar lo que haces.", author: "Steve Jobs" },
        { text: "La acción es el antídoto contra la desesperación.", author: "Joan Baez" },
        { text: "El universo no conspira contra ti, pero tampoco se desvía para alinear tus pines.", author: "Tim Ferriss" },
        { text: "La magia es creer en ti mismo. Si puedes hacer eso, puedes hacer que cualquier cosa suceda.", author: "Johann Wolfgang von Goethe" },
        { text: "La pregunta más persistente y urgente de la vida es: '¿Qué estás haciendo por los demás?'", author: "Martin Luther King, Jr." },
        { text: "No te conformes con historias, cómo han ido las cosas para otros. Despliega tu propio mito.", author: "Rumi" },
        { text: "Si quieres levantar a alguien, levanta tu propia alma.", author: "Booker T. Washington" },
        { text: "Las limitaciones viven solo en nuestras mentes. Pero si usamos nuestra imaginación, nuestras posibilidades se vuelven ilimitadas.", author: "Jamie Paolinetti" },
        { text: "El secreto del cambio es enfocar toda tu energía, no en luchar contra lo viejo, sino en construir lo nuevo.", author: "Sócrates" },
        { text: "Si oyes una voz dentro de ti que dice 'no puedes pintar', entonces pinta, y esa voz será silenciada.", author: "Vincent Van Gogh" },
        { text: "Haz una cosa todos los días que te asuste.", author: "Eleanor Roosevelt" },
        { text: "Para ser irremplazable, uno debe ser siempre diferente.", author: "Coco Chanel" },
        { text: "La vida no se trata de encontrarte a ti mismo. La vida se trata de crearte a ti mismo.", author: "George Bernard Shaw" },
        { text: "La normalidad es un camino pavimentado: es cómodo para caminar, pero no crecen flores en él.", author: "Vincent van Gogh" },
        { text: "Todo nuestro conocimiento tiene sus orígenes en nuestras percepciones.", author: "Leonardo da Vinci" },
    ];
    
    const gebi = id => document.getElementById(id);
    const qs = selector => document.querySelector(selector);
    const qsa = selector => document.querySelectorAll(selector);
    function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
    function dateToYYYYMMDD(date) { if (!date || isNaN(date)) return ''; return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; }
    function dateToHHMM(date) { if (!date || isNaN(date)) return "00:00"; return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`; }
    function yyyymmddToDate(dateStr) { if (!dateStr) return new Date(); const parts = dateStr.split('-'); return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10)); }
    function showToast(message) { const tc = gebi('toast-container'); if (!tc) return; const t = document.createElement('div'); t.className = `toast`; t.textContent = message; tc.appendChild(t); setTimeout(() => t.remove(), 3300); }
    function uuid() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

    // --- El resto del script JavaScript permanece sin cambios ---
    // ... (toda la lógica de la aplicación) ...
    // --- GESTIÓN DE ESTADO (STORE) ---
    function createStore(initialState) { let state = initialState; const listeners = new Set(); return { getState() { return state; }, setState(updater) { const oldState = state; state = { ...state, ...(typeof updater === 'function' ? updater(state) : updater) }; listeners.forEach(listener => listener(state, oldState)); }, subscribe(listener) { listeners.add(listener); return () => listeners.delete(listener); } }; }
    const initialState = { currentUser: null, items: [], currentView: 'calendar', calendar: { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), selectedDate: dateToYYYYMMDD(new Date()) }, isLoading: false, fetchedMonths: new Set(), pendingSyncOperations: 0, theme: 'dark', taskFilter: 'all', isSearching: false, searchQuery: '' };
    const store = createStore(initialState);

    // --- CICLO DE VIDA DE LA APP ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        runWelcomeSequence();
        attachGlobalEventListeners();
        store.subscribe(handleStateChange);
        store.subscribe(debounce((newState) => localStorage.setItem('items', JSON.stringify(newState.items)), 500));
        loadAndApplyTheme();
    }

    async function runWelcomeSequence() {
        const welcomeScreen = gebi('welcomeScreen');
        const quoteScreen = gebi('quoteScreen');

        await wait(2500);
        welcomeScreen.style.opacity = '0';
        
        const quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
        gebi('quoteText').textContent = `“${quote.text}”`;
        gebi('quoteAuthor').textContent = `– ${quote.author}`;
        
        quoteScreen.classList.add('visible');
        await wait(100);
        quoteScreen.style.opacity = '1';
        
        await wait(3000);
        quoteScreen.style.opacity = '0';

        await wait(500);
        welcomeScreen.style.display = 'none';
        quoteScreen.style.display = 'none';

        const defaultUser = { name: 'Dani' };
        localStorage.setItem('currentUser', JSON.stringify(defaultUser));
        store.setState({ currentUser: defaultUser });
        loadDataAndInitializeApp();
    }
    
    async function loadDataAndInitializeApp() {
        gebi('app-root').classList.add('visible');
        loadDataFromLocalStorage();
        await fetchInitialData();
        if (!store.getState().isLoading) { goToToday(); }
    }
    
    function handleStateChange(newState, oldState) {
        if (newState.currentView !== oldState.currentView || newState.items !== oldState.items || newState.calendar !== oldState.calendar || newState.taskFilter !== oldState.taskFilter || newState.searchQuery !== oldState.searchQuery || newState.isSearching !== oldState.isSearching) {
            renderApp();
        }
        if (newState.pendingSyncOperations !== oldState.pendingSyncOperations) {
            gebi('sync-indicator')?.classList.toggle('active', newState.pendingSyncOperations > 0);
        }
        if (newState.theme !== oldState.theme) {
            applyTheme(newState.theme);
        }
        if (newState.currentUser !== oldState.currentUser && newState.currentUser) {
            setUserSpecificStyles(newState.currentUser.name);
        }
    }

    // --- RENDERIZADO DE LA UI ---
    function renderApp() {
        const state = store.getState();
        updateNav(state.currentView);
        renderCurrentView(state);
    }

    function renderCurrentView(state) {
        qsa('.view').forEach(v => v.classList.remove('active'));
        const viewId = `${state.currentView}View`;
        const viewEl = gebi(viewId);
        if (viewEl) {
            viewEl.classList.add('active');
            switch (state.currentView) {
                case 'calendar': renderCalendarView(state); break;
                case 'tasks': renderTaskListView(state); break;
                case 'help': /* No necesita re-renderizado constante */ break;
                case 'search': renderSearchView(state); break;
            }
        }
    }
    
    function updateNav(currentView) {
        qsa('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.view === currentView);
        });
    }

    function renderCalendarView(state) {
        const { calendar, items } = state;
        const { currentMonth, currentYear, selectedDate } = calendar;

        gebi('calendar-title-btn').textContent = `${MESES[currentMonth]} ${currentYear}`;
        
        const weekdaysContainer = gebi('calendarWeekdays');
        if (!weekdaysContainer.hasChildNodes()) {
            weekdaysContainer.innerHTML = DIAS_SEMANA.map((day, i) => `<div class="weekday ${i === 5 ? 'saturday' : ''} ${i === 6 ? 'sunday' : ''}">${day}</div>`).join('');
        }

        const calendarDays = gebi('calendarDays');
        calendarDays.innerHTML = '';
        const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
        const offset = (firstDayOfMonth.getDay() + 6) % 7;
        const startDate = new Date(firstDayOfMonth);
        startDate.setDate(startDate.getDate() - offset);
        const todayStr = dateToYYYYMMDD(new Date());

        for (let i = 0; i < 42; i++) {
            const cellDate = new Date(startDate);
            cellDate.setDate(startDate.getDate() + i);
            const dateStr = dateToYYYYMMDD(cellDate);
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.dataset.date = dateStr;

            if (cellDate.getMonth() !== currentMonth) dayElement.classList.add('other-month');
            if (dateStr === todayStr) dayElement.classList.add('today');
            if (dateStr === selectedDate) dayElement.classList.add('selected');

            const ownersOnDay = new Set(items.filter(it => it.dueDate && dateToYYYYMMDD(new Date(it.dueDate)) === dateStr).map(it => it.owner));
            let dotsHtml = '';
            if (ownersOnDay.size > 0) {
                 dotsHtml = `<div class="event-dots-container">${Array.from(ownersOnDay).map(owner => `<span class="event-dot" style="background-color: var(--accent-${owner.toLowerCase()});"></span>`).join('')}</div>`;
            }
            
            dayElement.innerHTML = `<span class="day-number">${cellDate.getDate()}</span>${dotsHtml}`;
            if (cellDate.getMonth() === currentMonth) {
                dayElement.onclick = () => selectDate(dateStr);
            }
            calendarDays.appendChild(dayElement);
        }

        renderUpcomingAgenda(items);
    }
    
    function renderUpcomingAgenda(items) {
        const agendaList = gebi('agendaList');
        agendaList.innerHTML = '';
        const today = new Date();
        let itemsFound = 0;
        const fragment = document.createDocumentFragment();

        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const dateStr = dateToYYYYMMDD(date);
            const dayItems = items
                .filter(item => item.dueDate && dateToYYYYMMDD(new Date(item.dueDate)) === dateStr)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            if (dayItems.length > 0) {
                itemsFound += dayItems.length;
                const header = document.createElement('div');
                header.className = 'agenda-date-header';
                header.textContent = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' });
                fragment.appendChild(header);

                dayItems.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = `list-item-swipe-container agenda-item-compact ${item.isComplete ? 'completed' : ''}`;
                    itemEl.dataset.id = item.localId;

                    const itemDate = new Date(item.dueDate);
                    const time = item.type === 'task' ? 'Tarea' : dateToHHMM(itemDate);
                    
                    itemEl.innerHTML = `
                        <div class="item-card-swipe-background">
                            <span class="material-icons">check_circle</span>
                            <span class="material-icons">delete</span>
                        </div>
                        <div class="item-content agenda-item-content" data-action="edit">
                            <div class="indicator" style="background-color:var(--accent-${item.owner.toLowerCase()});"></div>
                            <span class="time">${time}</span>
                            <div class="item-title title ${item.isComplete ? 'completed' : ''}">${item.description}</div>
                        </div>`;
                    
                    itemEl.querySelector('[data-action="edit"]').addEventListener('click', () => openAddItemModal(item));
                    fragment.appendChild(itemEl);
                    attachSwipeListeners(itemEl);
                });
            }
        }
        
        if (itemsFound === 0) {
            agendaList.innerHTML = `<div class="empty-state" style="padding-top:2rem;"><span class="material-icons">event_available</span><div>Nada en los próximos 7 días</div></div>`;
        } else {
            agendaList.appendChild(fragment);
        }
    }


    function renderTaskListView(state) {
        const { items, taskFilter } = state;
        const allTasks = items.filter(i => i.type === 'task');
        const filteredTasks = taskFilter === 'all' ? allTasks : allTasks.filter(i => i.owner === taskFilter);

        const pendingTasks = filteredTasks.filter(t => !t.isComplete).sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
        const completedTasks = filteredTasks.filter(t => t.isComplete).sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0));

        gebi('pending-tasks-title').style.display = pendingTasks.length > 0 ? 'flex' : 'none';
        gebi('completed-tasks-title').style.display = completedTasks.length > 0 ? 'flex' : 'none';
        
        renderTaskList(gebi('pendingTasksList'), pendingTasks);
        renderTaskList(gebi('completedTasksList'), completedTasks.slice(0, 15));
        
        const emptyEl = gebi('emptyTasks');
        if (filteredTasks.length === 0) {
            emptyEl.style.display = 'block';
            emptyEl.innerHTML = `<span class="material-icons" style="font-size: 48px;">task_alt</span><div style="font-size: 1.2rem; margin-top: 1rem;">No hay tareas que mostrar</div><p>Prueba a cambiar los filtros o a crear una nueva tarea.</p>`;
        } else {
            emptyEl.style.display = 'none';
        }
    }

    function renderTaskList(container, tasks) {
        container.innerHTML = '';
        tasks.forEach(task => {
            const taskEl = document.createElement('div');
            taskEl.className = `list-item-swipe-container task-item ${task.isComplete ? 'completed' : ''}`;
            taskEl.style.borderLeftColor = `var(--accent-${task.owner.toLowerCase()})`;
            taskEl.dataset.id = task.localId;

            const isCompleted = task.isComplete;
            taskEl.innerHTML = `
                <div class="item-card-swipe-background">
                    <span class="material-icons">check_circle</span>
                    <span class="material-icons">delete</span>
                </div>
                <div class="task-checkbox ${isCompleted ? 'checked' : ''}" data-action="complete">
                    ${isCompleted ? '<span class="material-icons" style="font-size: 16px;">check</span>' : ''}
                </div>
                <div class="item-content" data-action="edit">
                    <div class="item-title ${isCompleted ? 'completed' : ''}">${task.description}</div>
                    <div class="item-meta">
                        <span>${task.owner}</span>
                        ${task.dueDate ? `• <span>${new Date(task.dueDate).toLocaleDateString('es-ES')}</span>` : ''}
                    </div>
                </div>
                <div class="item-actions">
                    <button class="icon-button" data-action="duplicate" title="Duplicar"><span class="material-icons">content_copy</span></button>
                </div>`;
            
            container.appendChild(taskEl);
            attachSwipeListeners(taskEl);
            taskEl.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                if (action) {
                    e.stopPropagation();
                    const id = task.localId;
                    if (action === 'complete') handleItemComplete(id, !task.isComplete);
                    if (action === 'edit') openAddItemModal(task);
                    if (action === 'duplicate') handleItemDuplicate(id);
                }
            });
        });
    }
    
    function renderSearchView(state) {
        const { searchQuery, items } = state;
        const resultsList = gebi('searchResultsList');
        const query = searchQuery.trim().toLowerCase();

        if (!query) {
            resultsList.innerHTML = `<div class="empty-state"><span class="material-icons">search</span><div>Escribe para buscar...</div></div>`;
            return;
        }

        const results = items.filter(item => item.description.toLowerCase().includes(query)).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        
        if (results.length > 0) {
            renderTaskList(resultsList, results);
        } else {
            resultsList.innerHTML = `<div class="empty-state"><span class="material-icons">search_off</span><div>No se encontraron resultados para "${searchQuery}"</div></div>`;
        }
    }


    // --- MANEJO DE EVENTOS GLOBALES ---
    function attachGlobalEventListeners() {
        qsa('.nav-item').forEach(item => item.addEventListener('click', () => switchView(item.dataset.view)));
        gebi('prev-month-btn').addEventListener('click', () => changeMonth(-1));
        gebi('next-month-btn').addEventListener('click', () => changeMonth(1));
        gebi('today-btn').addEventListener('click', goToToday);
        gebi('calendar-title-btn').addEventListener('click', openDatePickerModal);
        gebi('search-btn').addEventListener('click', toggleSearch);
        const debouncedSearch = debounce((e) => store.setState({ searchQuery: e.target.value }), 300);
        gebi('search-input').addEventListener('input', debouncedSearch);
        gebi('fab-add-item').addEventListener('click', () => openAddItemModal());
        gebi('themeToggleBtn').addEventListener('click', handleThemeToggle);
        gebi('logout-btn').addEventListener('click', handleLogout);
        gebi('cleanup-tasks-btn').addEventListener('click', handleCleanupOldTasks);
        gebi('add-item-form').addEventListener('submit', handleItemFormSubmit);
        gebi('cancel-item-btn').addEventListener('click', () => closeModal('add-item-modal'));
        gebi('item-type').addEventListener('change', toggleDateTimeNotificationVisibility);
        gebi('delete-item-btn').addEventListener('click', handleDeleteFromModal);
        gebi('date-picker-form').addEventListener('submit', handleDateSelectionFromPicker);
        gebi('cancel-date-picker-btn').addEventListener('click', () => closeModal('date-picker-modal'));
        qsa('input[name="task-filter"]').forEach(radio => radio.addEventListener('change', (e) => store.setState({ taskFilter: e.target.value })));
        attachPullToRefresh(gebi('main-content-area'));
    }

    // --- FUNCIONALIDADES (LÓGICA DE NEGOCIO) ---
    const TODO_ITEM_CLASS_NAME = 'TodoItem';
    
    function parseObjectToAppItem(p) { if (!p) return null; return { id: p.id, type: p.get('type'), description: p.get('description'), owner: p.get('owner'), isComplete: p.get('isComplete') || false, createdAt: p.createdAt?.getTime(), createdBy: p.get('createdBy'), completedAt: p.get('completedAt')?.getTime(), lastModified: p.updatedAt?.getTime(), lastModifiedBy: p.get('lastModifiedBy'), dueDate: p.get('dueDate')?.toISOString(), notificationEnabled: p.get('notificationEnabled') || false, localId: p.get('localId') || p.id, }; }
    function updateSyncIndicator(change) { store.setState(prev => ({ pendingSyncOperations: Math.max(0, prev.pendingSyncOperations + change) })); }
    
    async function fetchInitialData() {
        if (!store.getState().currentUser) return;
        store.setState({ isLoading: true });
        updateSyncIndicator(1);
        try {
            const query = new Parse.Query(TODO_ITEM_CLASS_NAME);
            query.limit(1000);
            const results = await query.find();
            const backendItems = results.map(parseObjectToAppItem).filter(Boolean);
            store.setState(prev => {
                const itemMap = new Map(prev.items.map(item => [item.localId, item]));
                backendItems.forEach(bItem => {
                    const existing = itemMap.get(bItem.localId);
                    if (!existing || bItem.lastModified > existing.lastModified) {
                        itemMap.set(bItem.localId, bItem);
                    }
                });
                return { items: Array.from(itemMap.values()) };
            });
            showToast("Datos sincronizados.");
        } catch (e) {
            showToast(`Error de sincronización: ${e.message}.`);
        } finally {
            store.setState({ isLoading: false });
            updateSyncIndicator(-1);
        }
    }

    function switchView(view) {
        if (store.getState().isLoading) return;
        if (store.getState().isSearching && view !== 'search') {
             toggleSearch(false);
        }
        store.setState({ currentView: view });
    }
    
    function selectDate(dateStr) {
        store.setState(prev => ({ calendar: { ...prev.calendar, selectedDate: dateStr }}));
    }

    function changeMonth(delta) {
        const { currentMonth, currentYear } = store.getState().calendar;
        let newDate = new Date(currentYear, currentMonth, 1);
        newDate.setMonth(newDate.getMonth() + delta);
        store.setState(prev => ({ calendar: { ...prev.calendar, currentMonth: newDate.getMonth(), currentYear: newDate.getFullYear() }}));
    }
    
    function goToToday() {
        const today = new Date();
        const newCalendarState = { currentMonth: today.getMonth(), currentYear: today.getFullYear(), selectedDate: dateToYYYYMMDD(today) };
        if (store.getState().currentView !== 'calendar') {
             store.setState({ currentView: 'calendar', calendar: newCalendarState });
        } else {
            store.setState({ calendar: newCalendarState });
        }
    }
    
    // --- MANEJO DE MODALES ---
    function openModal(modalId) { const modal = gebi(modalId); if(modal) modal.classList.add('active'); }
    function closeModal(modalId) { const modal = gebi(modalId); if(modal) modal.classList.remove('active'); }

    function openAddItemModal(itemToEdit = null) {
        const state = store.getState();
        const f = gebi('add-item-form');
        f.reset();
        
        const isEditing = itemToEdit !== null;
        // El título ya no se muestra, pero la lógica se mantiene por si se revierte el cambio de estilo
        gebi('modal-title-h3').textContent = isEditing ? 'Editar Ítem' : 'Añadir Ítem';
        gebi('delete-item-btn').style.display = isEditing ? 'block' : 'none';

        gebi('item-id').value = itemToEdit?.id || '';
        gebi('item-local-id').value = itemToEdit?.localId || uuid();
        gebi('item-type').value = itemToEdit?.type || (state.currentView === 'tasks' ? 'task' : 'agenda');
        gebi('item-description').value = itemToEdit?.description || '';
        
        const dueDate = itemToEdit?.dueDate ? new Date(itemToEdit.dueDate) : yyyymmddToDate(state.calendar.selectedDate);
        gebi('item-due-date').value = dateToYYYYMMDD(dueDate);
        
        if (itemToEdit && itemToEdit.dueDate) {
            gebi('item-due-time').value = dateToHHMM(new Date(itemToEdit.dueDate));
        } else {
            const now = new Date();
            now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15);
            gebi('item-due-time').value = dateToHHMM(now);
        }
        
        gebi('item-notification-enabled').checked = itemToEdit?.notificationEnabled || false;
        gebi('item-owner').value = itemToEdit?.owner || state.currentUser?.name || 'Comun';

        toggleDateTimeNotificationVisibility();
        openModal('add-item-modal');
    }

    function toggleDateTimeNotificationVisibility() {
        const isAgenda = gebi('item-type').value === 'agenda';
        gebi('datetime-notification-group').style.display = isAgenda ? 'block' : 'none';
        if (isAgenda && !gebi('item-due-date').value) {
            gebi('item-due-date').value = dateToYYYYMMDD(new Date());
        }
    }
    
    // --- CRUD DE ÍTEMS ---
    function handleItemFormSubmit(e) {
        e.preventDefault();
        const { currentUser } = store.getState();
        if (!currentUser) return;
        
        const localId = gebi('item-local-id').value;
        const existingItem = store.getState().items.find(i => i.localId === localId);

        const itemData = {
            id: gebi('item-id').value,
            localId: localId,
            type: gebi('item-type').value,
            description: gebi('item-description').value.trim(),
            owner: gebi('item-owner').value,
            isComplete: existingItem?.isComplete || false,
            createdAt: existingItem?.createdAt || Date.now(),
            createdBy: existingItem?.createdBy || currentUser.name,
            notificationEnabled: gebi('item-notification-enabled').checked,
            dueDate: null
        };
        
        const datePart = gebi('item-due-date').value;
        const timePart = gebi('item-due-time').value || '00:00';
        
        if (datePart) {
            const [year, month, day] = datePart.split('-');
            const [hour, minute] = timePart.split(':');
            const itemDate = new Date(year, month - 1, day, hour, minute);
            if (itemData.type === 'task') { itemDate.setHours(0, 0, 0, 0); }
            itemData.dueDate = itemDate.toISOString();
        }
        
        handleItemSave(itemData);
        closeModal('add-item-modal');
    }

    async function handleItemSave(itemData) {
        const { currentUser } = store.getState();
        const itemForUI = { ...itemData, lastModified: Date.now(), lastModifiedBy: currentUser.name };
        
        store.setState(prev => {
            const items = [...prev.items];
            const index = items.findIndex(i => i.localId === itemForUI.localId);
            if (index > -1) items[index] = { ...items[index], ...itemForUI };
            else items.unshift(itemForUI);
            return { items };
        });

        updateSyncIndicator(1);
        try {
            const ParseItem = Parse.Object.extend(TODO_ITEM_CLASS_NAME);
            const parseItem = itemData.id ? await new Parse.Query(ParseItem).get(itemData.id) : new ParseItem();
            
            if (!itemData.id) {
                parseItem.set('createdBy', currentUser.name);
                parseItem.set('localId', itemData.localId);
            }
            
            parseItem.set('type', itemData.type);
            parseItem.set('description', itemData.description);
            parseItem.set('owner', itemData.owner);
            parseItem.set('isComplete', itemData.isComplete || false);
            parseItem.set('lastModifiedBy', currentUser.name);
            if (itemData.completedAt) parseItem.set('completedAt', new Date(itemData.completedAt));
            if (itemData.dueDate) parseItem.set('dueDate', new Date(itemData.dueDate));
            parseItem.set('notificationEnabled', itemData.notificationEnabled);

            const savedItem = await parseItem.save();
            const finalItem = parseObjectToAppItem(savedItem);
            
            store.setState(prev => ({
                items: prev.items.map(i => i.localId === finalItem.localId ? finalItem : i)
            }));
            showToast(`Ítem ${itemData.id ? 'actualizado' : 'guardado'}.`);
        } catch (e) {
            showToast(`Error al guardar en la nube: ${e.message}`);
        } finally {
            updateSyncIndicator(-1);
        }
    }

    function handleItemComplete(localId, isComplete) {
        const item = store.getState().items.find(i => i.localId === localId);
        if (item) {
            handleItemSave({ ...item, isComplete, completedAt: isComplete ? Date.now() : null });
            showToast(isComplete ? 'Ítem completado.' : 'Ítem marcado como pendiente.');
        }
    }
    
    async function handleItemDelete(localId) {
        const itemToDelete = store.getState().items.find(i => i.localId === localId);
        if (!itemToDelete) return;
        
        store.setState(prev => ({ items: prev.items.filter(i => i.localId !== localId) }));
        
        updateSyncIndicator(1);
        if (itemToDelete.id) {
            try {
                await Parse.Object.extend(TODO_ITEM_CLASS_NAME).createWithoutData(itemToDelete.id).destroy();
            } catch (e) {
                showToast(`Error al eliminar de la nube.`);
                store.setState(prev => ({ items: [...prev.items, itemToDelete] }));
            }
        }
        showToast('Ítem eliminado.');
        updateSyncIndicator(-1);
    }
    
    function handleDeleteFromModal() {
        const localId = gebi('item-local-id').value;
        if (localId && confirm("¿Eliminar este ítem permanentemente?")) {
            handleItemDelete(localId);
            closeModal('add-item-modal');
        }
    }

    function handleItemDuplicate(localId) {
        const itemToDup = store.getState().items.find(i => i.localId === localId);
        if (!itemToDup) return;
        const newItemData = { ...itemToDup, id: null, localId: uuid(), isComplete: false, completedAt: null, createdAt: Date.now() };
        handleItemSave(newItemData);
        showToast('Ítem duplicado.');
    }
    
    // --- OTRAS FUNCIONALIDADES ---
    function loadAndApplyTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        store.setState({ theme: savedTheme });
    }
    function applyTheme(theme) {
        document.body.dataset.theme = theme;
        gebi('themeIcon').textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
        document.querySelector('meta[name="theme-color"]').setAttribute('content', theme === 'dark' ? '#1C1B1F' : '#FFFBFE');
    }
    function handleThemeToggle() {
        const newTheme = store.getState().theme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        store.setState({ theme: newTheme });
    }

    function setUserSpecificStyles(userName) {
        const accentVar = userName === 'Dani' ? 'var(--accent-dani)' : 'var(--accent-norma)';
        document.documentElement.style.setProperty('--current-user-accent', accentVar);
    }
    
    function handleLogout() { localStorage.clear(); location.reload(); }
    function loadDataFromLocalStorage() { try { const sI = localStorage.getItem('items'); if (sI) store.setState({ items: JSON.parse(sI) }); } catch (e) {} }

    function toggleSearch(forceState = null) {
        const searchContainer = gebi('search-container');
        const isSearching = forceState !== null ? forceState : (searchContainer.style.display === 'none');
        
        searchContainer.style.display = isSearching ? 'flex' : 'none';
        store.setState({ isSearching, currentView: isSearching ? 'search' : 'calendar' });
        
        if (isSearching) {
            setTimeout(() => gebi('search-input').focus(), 50);
        } else {
            gebi('search-input').value = '';
            store.setState({ searchQuery: '' });
        }
    }
    
    function openDatePickerModal() {
        openModal('date-picker-modal');
        const monthSelect = gebi('month-select');
        const yearSelect = gebi('year-select');
        monthSelect.innerHTML = MESES.map((mes, index) => `<option value="${index}">${mes}</option>`).join('');
        monthSelect.value = store.getState().calendar.currentMonth;
        yearSelect.value = store.getState().calendar.currentYear;
    }
    function handleDateSelectionFromPicker(e) {
        e.preventDefault();
        const newMonth = parseInt(gebi('month-select').value, 10);
        const newYear = parseInt(gebi('year-select').value, 10);
        store.setState(prev => ({ calendar: { ...prev.calendar, currentMonth: newMonth, currentYear: newYear }}));
        closeModal('date-picker-modal');
    }

    async function handleCleanupOldTasks() {
        const THIRTY_DAYS_AGO = Date.now() - (30 * 24 * 60 * 60 * 1000);
        const tasksToClean = store.getState().items.filter(item => item.type === 'task' && item.isComplete && item.completedAt < THIRTY_DAYS_AGO);
        if (tasksToClean.length === 0) { showToast("No hay tareas antiguas que limpiar."); return; }
        if (!confirm(`¿Eliminar ${tasksToClean.length} tarea(s) completada(s) hace más de 30 días?`)) return;
        
        store.setState(prev => ({ items: prev.items.filter(item => !tasksToClean.find(t => t.localId === item.localId)) }));
        updateSyncIndicator(1);
        try {
            const parseObjectsToDelete = tasksToClean.filter(t => t.id).map(t => Parse.Object.extend(TODO_ITEM_CLASS_NAME).createWithoutData(t.id));
            if (parseObjectsToDelete.length > 0) await Parse.Object.destroyAll(parseObjectsToDelete);
            showToast("Limpieza completada.");
        } catch (error) {
            showToast("Error al limpiar tareas en la nube.");
        } finally {
            updateSyncIndicator(-1);
        }
    }
    
    function attachSwipeListeners(cardElement) {
        if (!cardElement || cardElement.dataset.hammer) return;
        const mc = new Hammer.Manager(cardElement);
        mc.add(new Hammer.Pan({ threshold: 10, pointers: 1 }));

        mc.on('panstart', () => { cardElement.style.transition = 'none'; });
        mc.on('pan', (ev) => {
            cardElement.style.transform = `translateX(${ev.deltaX}px)`;
            cardElement.classList.toggle('swiping-right', ev.deltaX > 20);
            cardElement.classList.toggle('swiping-left', ev.deltaX < -20);
        });
        mc.on('panend', (ev) => {
            cardElement.style.transition = 'transform 0.2s ease-out, opacity 0.3s';
            cardElement.classList.remove('swiping-right', 'swiping-left');
            const SWIPE_ACTION_THRESHOLD = cardElement.offsetWidth * 0.35;
            const id = cardElement.dataset.id;
            const item = store.getState().items.find(i => i.localId === id);
            if (!item) return;

            if (ev.deltaX > SWIPE_ACTION_THRESHOLD) {
                cardElement.style.transform = `translateX(100%)`;
                cardElement.style.opacity = '0';
                setTimeout(() => handleItemComplete(id, !item.isComplete), 200);
            } else if (ev.deltaX < -SWIPE_ACTION_THRESHOLD) {
                cardElement.style.transform = `translateX(-100%)`;
                cardElement.style.opacity = '0';
                setTimeout(() => {
                     if(confirm(`¿Eliminar este ítem?\n\n"${item.description}"`)) {
                         handleItemDelete(id);
                     } else {
                         cardElement.style.transform = 'translateX(0)';
                         cardElement.style.opacity = '1';
                     }
                }, 200);
            } else {
                cardElement.style.transform = 'translateX(0)';
            }
        });
        cardElement.dataset.hammer = 'true';
    }

    function attachPullToRefresh(element) {
        let touchStartY = 0; let isPulling = false;
        const ptrIndicator = document.createElement('div');
        ptrIndicator.id = 'pull-to-refresh-indicator';
        ptrIndicator.innerHTML = `<span id="ptr-arrow" class="material-icons">arrow_downward</span><span id="ptr-spinner" class="material-icons" style="display:none; animation: spin 1s linear infinite;">sync</span>`;
        element.prepend(ptrIndicator);
        const PULL_THRESHOLD = 80;
        
        element.addEventListener('touchstart', (e) => {
            const activeView = element.querySelector('.view.active');
            if (!activeView) return;
            const scrollableContent = activeView.querySelector('.agenda-list-container, #tasksView, #helpView, #searchView');
            if ((scrollableContent || activeView).scrollTop === 0) {
                touchStartY = e.touches[0].clientY; isPulling = true;
                ptrIndicator.querySelector('#ptr-spinner').style.display = 'none';
                ptrIndicator.querySelector('#ptr-arrow').style.display = 'block';
            }
        }, { passive: true });
        
        element.addEventListener('touchmove', (e) => {
            if (!isPulling) return;
            const pullDistance = e.touches[0].clientY - touchStartY;
            if (pullDistance > 0) {
                e.preventDefault();
                const rotation = Math.min(pullDistance / PULL_THRESHOLD, 1) * 180;
                ptrIndicator.style.top = `${Math.min(pullDistance, PULL_THRESHOLD) - 50}px`;
                ptrIndicator.querySelector('#ptr-arrow').style.transform = `rotate(${rotation}deg)`;
            }
        }, { passive: false });
        
        element.addEventListener('touchend', (e) => {
            if (!isPulling) return;
            const pullDistance = e.changedTouches[0].clientY - touchStartY;
            if (pullDistance > PULL_THRESHOLD) {
                ptrIndicator.style.top = '10px';
                ptrIndicator.querySelector('#ptr-arrow').style.display = 'none';
                ptrIndicator.querySelector('#ptr-spinner').style.display = 'block';
                fetchInitialData().finally(() => {
                    ptrIndicator.style.top = '-50px';
                    ptrIndicator.querySelector('#ptr-arrow').style.transform = 'rotate(0deg)';
                });
            } else {
                ptrIndicator.style.top = '-50px';
                ptrIndicator.querySelector('#ptr-arrow').style.transform = 'rotate(0deg)';
            }
            isPulling = false;
        });
    }

    </script>
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(r => console.log('ServiceWorker OK')).catch(e => console.log('ServiceWorker Fail', e)); }); }
    </script>
</body>
</html>