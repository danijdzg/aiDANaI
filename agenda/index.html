<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Agenda aiDANaI</title>
    <!-- Librerías de terceros -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:wght@400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://unpkg.com/flatpickr/dist/l10n/es.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <!-- Configuración PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <!-- NOTA: Asegúrate de que el fichero 'aiDANaI.webp' exista en la misma carpeta que este HTML -->
    <link rel="apple-touch-icon" href="aiDANaI.webp">
    <style>
        /* ============================ */
        /* 1. VARIABLES Y ESTILO BASE */
        /* ============================ */
        :root { --primary-color: #7B68EE; --primary-variant: #5A4CAD; --secondary-color: #9E9EAD; --background: #F8F8FA; --surface: #FFFFFF; --surface-variant: #F0F0F5; --on-primary: #FFFFFF; --on-background: #1A1C20; --on-surface: #1A1C20; --outline: #E0E0E6; --accent-task: #4CAF50; --accent-event-normal: #2196F3; --accent-event-important: #F44336; --accent-delete: #E53935; --accent-complete: #43A047; --accent-edit: #1E88E5; --accent-google: #4285F4; --font-main: 'Archivo Narrow', 'Roboto', sans-serif; --shadow-layered: 0px 4px 8px rgba(26, 28, 32, 0.04), 0px 8px 24px rgba(26, 28, 32, 0.08); --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1); --ease-in-out-circ: cubic-bezier(0.85, 0, 0.15, 1); }
        [data-theme="dark"] { --primary-color: #A78BFA; --primary-variant: #7B68EE; --secondary-color: #9E9EAD; --background: #000000; --surface: #121212; --surface-variant: #1E1E24; --on-primary: #000000; --on-background: #EAEAEA; --on-surface: #F5F5F5; --outline: #2A2A32; --shadow-layered: 0px 8px 24px rgba(0, 0, 0, 0.2); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; }
        body { font-family: var(--font-main); background-color: var(--background); color: var(--on-background); line-height: 1.5; overflow: hidden; min-height: 100vh; min-height: -webkit-fill-available; height: 100vh; transition: background-color 0.3s, color 0.3s; font-size: 15px; }
        *:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; border-radius: 6px; }
        #google-sync-btn.loading .material-icons { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fade-in-down { from { opacity: 0; transform: translateY(-20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .item-entering { animation: fade-in-down 0.4s var(--ease-out-quint) forwards; }
        @keyframes fade-out-up { from { opacity: 1; transform: scale(1); max-height: 200px; margin-top: 6px; padding-top: 8px; padding-bottom: 8px; } to { opacity: 0; transform: scale(0.95); max-height: 0; margin-top: 0; padding-top: 0; padding-bottom: 0; border-width: 0; } }
        .item-exiting { overflow: hidden; animation: fade-out-up 0.35s var(--ease-in-out-circ) forwards; }
        /* ============================ */
        /* 2. VISTAS Y NAVEGACIÓN */
        /* ============================ */
        #app-root { display: none; max-width: 420px; margin: 0 auto; height: 100vh; background: var(--background); position: relative; flex-direction: column; opacity: 0; transition: opacity 0.5s ease-out; padding-bottom: calc(52px + env(safe-area-inset-bottom)); }
        #app-root.visible { display: flex; opacity: 1; }
        .main-content { flex: 1; display: flex; position: relative; overflow: hidden; }
        .view { display: none; width: 100%; flex-direction: column; height: 100%; overflow-y: auto; padding: 16px; position: absolute; top: 0; left: 0; transition: transform 0.4s var(--ease-in-out-circ), opacity 0.4s var(--ease-in-out-circ); }
        .view.active { display: flex; z-index: 1; }
        .view.is-animating { display: flex; }
        #calendarView { padding: 0; overflow-y: auto; }
        @keyframes slideInFromRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideOutToLeft { from { transform: translateX(0); } to { transform: translateX(-100%); } }
        @keyframes slideInFromLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes slideOutToRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
        .view-enter-from-right { animation: slideInFromRight 0.4s var(--ease-in-out-circ) forwards; opacity: 1; z-index: 2;}
        .view-exit-to-left { animation: slideOutToLeft 0.4s var(--ease-in-out-circ) forwards; opacity: 0.5; z-index: 1;}
        .view-enter-from-left { animation: slideInFromLeft 0.4s var(--ease-in-out-circ) forwards; opacity: 1; z-index: 2;}
        .view-exit-to-right { animation: slideOutToRight 0.4s var(--ease-in-out-circ) forwards; opacity: 0.5; z-index: 1;}
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 420px; background: rgba(28, 28, 28, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(56, 56, 66, 0.5); display: flex; padding: 2px 0 calc(2px + env(safe-area-inset-bottom)) 0; z-index: 100; }
        [data-theme="light"] .bottom-nav { background: rgba(255, 255, 255, 0.7); border-top: 1px solid rgba(224, 224, 230, 0.5); }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px 0; cursor: pointer; transition: color 0.2s, background-color 0.2s, transform 0.1s ease-out; color: var(--secondary-color); border: none; background: transparent; border-radius: 8px; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item:active { transform: scale(0.92); }
        .nav-item .material-icons { font-size: 24px; margin: 0; }
        .nav-label { display: none; }
        #google-sync-btn.connected { color: var(--accent-google); }
        /* ============================ */
        /* 3. HEADER Y VISTAS PRINCIPALES */
        /* ============================ */
        .calendar-container { flex-shrink: 0; padding: 8px 16px; border-bottom: 1px solid var(--outline); }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .calendar-title-container { position: relative; display: inline-flex; align-items: center; }
        #calendar-title-btn { font-size: 16px; font-weight: 700; background: none; border: none; color: var(--on-background); padding: 4px 6px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, transform 0.1s ease-out; }
        #calendar-title-btn:hover { background-color: var(--surface-variant); }
        #calendar-title-btn:active { transform: scale(0.95); }
        .calendar-nav { display: flex; align-items: center; gap: 2px; }
        .icon-button { background: none; border: none; color: var(--secondary-color); cursor: pointer; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .icon-button:active { transform: scale(0.9); background-color: var(--surface-variant); }
        .icon-button .material-icons { font-size: 22px; }
        .icon-button:hover { background-color: var(--surface-variant); color: var(--on-surface); }
        #sync-status-indicator { position: absolute; top: 2px; right: -20px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
        #sync-status-indicator .material-icons { font-size: 14px; transition: color 0.3s; }
        #sync-status-indicator.online .material-icons { color: var(--accent-complete); }
        #sync-status-indicator.offline .material-icons { color: var(--secondary-color); }
        .view-toggle { display: flex; background-color: var(--surface-variant); border-radius: 10px; overflow: hidden; margin: 0 8px; }
        .view-toggle .btn-toggle { background: none; border: none; color: var(--secondary-color); padding: 6px 10px; cursor: pointer; transition: all 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .view-toggle .btn-toggle.active { background-color: var(--primary-color); color: var(--on-primary); box-shadow: 0 2px 6px rgba(123, 104, 238, 0.2); }
        .view-toggle .btn-toggle:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .view-toggle .btn-toggle:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        .view-toggle .btn-toggle .material-icons { font-size: 20px; }
        .view-toggle .btn-toggle:active { transform: scale(0.95); }
        #calendarView[data-display-mode="month"] #weekly-view-container { display: none; }
        #calendarView[data-display-mode="month"] #calendar-grid { display: block; }
        #calendarView[data-display-mode="month"] #agendaListContainer { display: block; }
        #calendarView[data-display-mode="week"] #calendar-grid { display: none; }
        #calendarView[data-display-mode="week"] #agendaListContainer { display: none; }
        #calendarView[data-display-mode="week"] #weekly-view-container { display: flex; flex-direction: column; }
        .calendar-grid { background: var(--surface); border-radius: 12px; padding: 6px; box-shadow: var(--shadow-layered); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
        .weekday { text-align: center; font-size: 12px; font-weight: 500; color: var(--secondary-color); padding: 4px; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; position: relative; font-size: 14px; transition: all 0.2s; padding: 4px 0; }
        .day-number { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .calendar-day.today .day-number { background: var(--primary-color); color: var(--on-primary); font-weight: 700; }
        .calendar-day.selected .day-number { background: var(--primary-variant); color: var(--on-primary); }
        .calendar-day.other-month { color: var(--outline); pointer-events: none; }
        .calendar-day .event-dots-container { position: absolute; bottom: 4px; left: 0; right: 0; display: flex; justify-content: center; gap: 3px; }
        .event-dot { width: 4px; height: 4px; border-radius: 50%; }
        .event-dot.important { background-color: var(--accent-event-important); }
        .event-dot.normal { background-color: var(--accent-event-normal); }
        .agenda-list-container { flex-grow: 1; overflow-y: auto; padding: 8px 16px 80px 16px; }
        .agenda-date-header { font-weight: 700; letter-spacing: 0.3px; font-size: 12px; color: var(--primary-color); padding: 8px 12px; background-color: var(--surface-variant); position: sticky; top: 0; z-index: 1; border-radius: 8px; margin-top: 8px; margin-bottom: 4px; }
        #today-greeting { font-size: 22px; font-weight: 700; margin-bottom: 24px; }
        .section-title { font-size: 16px; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; letter-spacing: 0.2px; margin-top: 24px; }
        .weekly-view-container { flex-grow: 1; padding: 8px 16px 80px 16px; overflow-y: auto; height: 100%; }
        .weekly-day-section { margin-bottom: 16px; background: var(--surface); border-radius: 12px; box-shadow: var(--shadow-layered); padding-bottom: 8px; }
        .weekly-day-header { font-weight: 700; letter-spacing: 0.3px; font-size: 14px; color: var(--primary-color); padding: 12px 16px; background-color: var(--surface-variant); border-top-left-radius: 12px; border-top-right-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .weekly-day-header .material-icons { font-size: 18px; }
        .weekly-day-events { padding: 0 16px; }
        .weekly-day-events .empty-state { padding: 12px; font-size: 13px; }
        /* ============================ */
        /* 4. BÚSQUEDA Y FAB */
        /* ============================ */
        #search-container { padding: 4px 16px 8px; transition: max-height 0.4s ease-out, opacity 0.4s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        #search-container.active { max-height: 60px; opacity: 1; }
        #search-form { display: flex; gap: 8px; align-items: center; }
        #search-input { flex-grow: 1; padding: 10px 16px; border: 1.5px solid var(--outline); border-radius: 24px; background: var(--surface-variant); color: var(--on-surface); font-size: 14px; }
        #search-input:focus { outline: none; border-color: var(--primary-color); }
        .fab { position: fixed; bottom: calc(65px + env(safe-area-inset-bottom)); right: 20px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--primary-color); color: var(--on-primary); border: none; box-shadow: var(--shadow-layered); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 150; transition: background-color 0.2s, transform 0.2s var(--ease-out-quint); }
        .fab:hover { background-color: var(--primary-variant); transform: scale(1.05); }
        .fab:active { transform: scale(0.9); }
        .fab .material-icons { font-size: 28px; }
        /* ============================ */
        /* 5. COMPONENTES DE LISTA */
        /* ============================ */
        .list-item-swipe-container { display: flex; align-items: flex-start; background: var(--surface); border-radius: 8px; margin-bottom: 6px; box-shadow: var(--shadow-layered); transition: transform 0.3s var(--ease-out-quint), opacity 0.3s, border-left-color 0.3s, background-color 0.1s; user-select: none; position: relative; padding: 8px 10px; border-left: 4px solid transparent; }
        .list-item-swipe-container:active { background-color: var(--surface-variant); transform: scale(0.98); }
        .list-item-swipe-container .item-icon { color: var(--secondary-color); margin-right: 8px; padding-top: 2px; font-size: 22px; display: flex; align-items: center; justify-content: center; z-index: 2; position: relative; }
        .list-item-swipe-container .item-checkbox .material-icons { font-size: 24px; cursor: pointer; transition: color 0.2s, transform 0.2s var(--ease-out-quint); color: var(--secondary-color); }
        .list-item-swipe-container .item-checkbox:active .material-icons { transform: scale(0.85); }
        .list-item-swipe-container.completed .item-checkbox .material-icons { color: var(--accent-complete); }
        .list-item-swipe-container .item-content { flex: 1; cursor: pointer; min-width: 0; display: flex; flex-direction: column; justify-content: center; z-index: 2; position: relative; }
        .item-card-swipe-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; color: white; opacity: 0; transition: opacity 0.2s; z-index: 1; pointer-events: none; }
        .list-item-swipe-container.swiping-right.type-task .item-card-swipe-background { background-color: var(--accent-complete); justify-content: flex-start; opacity: 1; }
        .list-item-swipe-container.swiping-right.type-agenda .item-card-swipe-background { background-color: var(--accent-complete); justify-content: flex-start; opacity: 1; }
        .list-item-swipe-container.swiping-left .item-card-swipe-background { background-color: var(--accent-delete); justify-content: flex-end; opacity: 1; }
        .list-item-swipe-container.swiping-right .item-card-swipe-background .material-icons:first-child, .list-item-swipe-container.swiping-left .item-card-swipe-background .material-icons:last-child { animation: bounceIn 0.3s ease-out; }
        @keyframes bounceIn { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
        .list-item-swipe-container.completed { opacity: 0.6; }
        .list-item-swipe-container.completed .item-title { text-decoration: line-through; text-decoration-color: var(--secondary-color); }
        .item-title { font-weight: 500; font-size: 14px; white-space: normal; word-break: break-word; line-height: 1.3; font-family: var(--font-main); }
        .event-time { font-size: 13px; font-weight: 700; color: var(--secondary-color); padding-top: 1px; }
        .event-meta-icon { font-size: 16px; color: var(--secondary-color); flex-shrink: 0; }
        .item-metadata-container { display: flex; align-items: center; gap: 8px; margin-top: 2px; color: var(--secondary-color); }
        .google-cal-icon { font-size: 14px !important; color: var(--accent-google) !important; }
        .task-progress-container { margin-top: 8px; }
        .progress-bar-wrapper { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--secondary-color); }
        .progress-bar { flex-grow: 1; background: var(--outline); border-radius: 4px; height: 4px; overflow: hidden; }
        .progress-bar-fill { width: 0%; height: 100%; background: var(--primary-color); transition: width 0.3s; }
        .subtasks-list-view { margin-top: 6px; padding-left: 4px; display: flex; flex-direction: column; gap: 4px; }
        .subtask-list-view-item { display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; }
        .subtask-list-view-item:hover { background-color: var(--surface-variant); }
        .subtask-list-view-item .material-icons { font-size: 18px; color: var(--secondary-color); transition: color 0.2s; }
        .subtask-list-view-item.completed { text-decoration: line-through; color: var(--secondary-color); }
        .subtask-list-view-item.completed .material-icons { color: var(--accent-complete); }
        #quick-add-feedback { margin-top: -8px; margin-bottom: 8px; padding: 0 4px; min-height: 28px; transition: all 0.2s; }
        .feedback-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 16px; font-size: 13px; font-weight: 500; background-color: var(--surface-variant); color: var(--on-surface); animation: fade-in-down 0.3s var(--ease-out-quint); }
        .feedback-chip .material-icons { font-size: 18px; }
        .feedback-chip.type-agenda { color: var(--primary-color); }
        .feedback-chip.type-task { color: var(--accent-task); }
        /* ============================ */
        /* 6. MODALES Y OTROS */
        /* ============================ */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; align-items: flex-end; justify-content: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.4s var(--ease-out-quint); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal { background: var(--surface); border-radius: 24px 24px 0 0; padding: 16px 24px 24px 24px; width: 100%; max-width: 420px; max-height: 95vh; overflow-y: auto; box-shadow: var(--shadow-layered); transform: translateY(100%); transition: transform 0.4s var(--ease-out-quint); }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-grabber { width: 40px; height: 5px; background-color: var(--outline); border-radius: 2.5px; margin: 0 auto 16px; flex-shrink: 0; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--secondary-color); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1.5px solid var(--outline); border-radius: 10px; background: var(--surface); color: var(--on-surface); font-size: 14px; font-family: var(--font-main); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(123, 104, 238, 0.2); }
        .form-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 24px; }
        .btn-icon { width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-icon:active { transform: scale(0.9); }
        .btn-icon .material-icons { font-size: 24px; }
        #delete-item-btn { background-color: transparent; color: var(--accent-delete); }
        #delete-item-btn:hover { background-color: rgba(229, 57, 53, 0.1); }
        #save-item-btn { background-color: var(--primary-color); color: var(--on-primary); box-shadow: 0 4px 12px rgba(123, 104, 238, 0.3); }
        #save-item-btn:hover { background-color: var(--primary-variant); }
        .btn { padding: 10px 20px; border: none; border-radius: 24px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; font-family: var(--font-main); }
        .btn:active { transform: scale(0.95); opacity: 0.9; }
        .btn-primary { background: var(--primary-color); color: var(--on-primary); }
        .btn-secondary { background: transparent; color: var(--secondary-color); border: 1.5px solid var(--outline); }
        .btn-link { background: none; border: none; color: var(--primary-color); font-weight: 500; cursor: pointer; }
        .form-group-datetime, #task-options-group { display: none; }
        .subtask-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .subtask-item input[type="checkbox"] { flex-shrink: 0; width: 20px; height: 20px; accent-color: var(--primary-color); }
        .subtask-item input[type="text"] { flex-grow: 1; font-size: 14px; border: none; background: transparent; border-bottom: 1px solid var(--outline); border-radius: 0; padding: 4px 0; color: var(--on-surface); }
        .subtask-item input[type="text"]:focus { outline: none; border-bottom-color: var(--primary-color); }
        .subtask-item .delete-subtask-btn { color: var(--secondary-color); font-size: 20px; }
        .empty-state { text-align: center; padding: 40px 24px; color: var(--secondary-color); }
        .empty-state .material-icons { font-size: 48px; margin-bottom: 8px; }
        .empty-state .btn { margin-top: 16px; }
        .intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; background-color: #000; transition: opacity 0.5s ease-out; }
        .intro-screen.visible { display: flex; }
        #welcomeImage { width: 250px; height: auto; opacity: 0; animation: growAndFade 2.5s ease-in-out forwards; }
        @keyframes growAndFade { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(8); opacity: 0; } }
        /* NOTE: Quote screen removed from initial load to speed up app start */
        .login-view { position: fixed; inset: 0; z-index: 1040; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; opacity: 0; transition: opacity .5s; background-color: var(--background); }
        .login-view--visible { display: flex; opacity: 1; }
        .login-view__card { background-color: var(--surface); padding: 1.25rem; border-radius: 18px; box-shadow: var(--shadow-layered); width: 100%; max-width: 340px; text-align: center; animation: pop-in 0.3s ease-out; }
        @keyframes pop-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #toast-container { position: fixed; bottom: calc(60px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .toast { background-color: rgba(30, 30, 36, 0.8); backdrop-filter: blur(5px); color: white; padding: 10px 18px; border-radius: 12px; box-shadow: var(--shadow-layered); display: flex; align-items: center; animation: toastFadeIn 0.4s var(--ease-out-quint), toastFadeOut 0.4s 2.6s var(--ease-out-quint); font-size: 14px; }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(10px) scale(0.95); } }
        .tasks-header { display: flex; align-items: center; justify-content: space-between; padding: 0 0 16px 0; }
        .tasks-header .form-select { flex-grow: 1; }
        .tasks-header .icon-button { flex-shrink: 0; margin-left: 8px; }
        .completed-tasks-section { background: var(--surface); padding: 0; border-radius: 10px; margin-top: 24px; border: 1px solid var(--outline); }
        .completed-tasks-section summary { font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center; list-style: none; padding: 12px; }
        .completed-tasks-section summary::-webkit-details-marker { display: none; }
        .completed-tasks-section summary .section-title { margin: 0; font-size: 16px; }
        .completed-tasks-section summary .material-icons { transition: transform 0.2s; }
        .completed-tasks-section[open] > summary .material-icons { transform: rotate(180deg); }
        .completed-tasks-list { padding: 0 12px 12px 12px; }
        .help-section details { background: var(--surface); padding: 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--outline); }
        .help-section summary { font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; list-style: none; }
        .help-section summary::-webkit-details-marker { display: none; }
        .help-section summary .material-icons { transition: transform 0.2s; }
        .help-section details[open] summary .material-icons { transform: rotate(180deg); }
        .help-section .details-content { padding-top: 12px; }
        .help-section ul { padding-left: 20px; }
        .help-section li { margin-bottom: 10px; }
        @media (min-width: 768px) { #app-root { max-width: 720px; } .bottom-nav { max-width: 720px; } body { font-size: 16px; } .modal-overlay { align-items: center; } .modal { border-radius: 24px; transform: translateY(0); max-height: 80vh; } }
        @media (min-width: 1024px) { body { overflow: auto; } #app-root { flex-direction: row; max-width: 100%; height: 100vh; padding-bottom: 0; } .bottom-nav { position: static; transform: none; flex-direction: column; width: auto; max-width: none; height: 100vh; border-top: none; border-right: 1px solid var(--outline); padding: 24px 8px; justify-content: flex-start; gap: 8px; background: var(--surface); backdrop-filter: none; } [data-theme="light"] .bottom-nav { background: var(--surface); } .nav-item { flex: 0; flex-direction: row; justify-content: center; width: 100%; padding: 12px; } .nav-item:hover { background-color: var(--surface-variant); } .nav-item.active { background-color: var(--primary-color); color: var(--on-primary); } [data-theme="dark"] .nav-item.active { background-color: var(--primary-variant); } .nav-item .material-icons { margin: 0; } #toast-container { bottom: 24px; left: calc(50% + 70px); } .main-content { height: 100vh; overflow-y: auto; } #calendarView { flex-direction: row; align-items: flex-start; gap: 24px; padding: 24px; overflow-y: hidden; } .calendar-container { flex: 0 0 400px; border-bottom: none; padding: 0; position: sticky; top: 0; height: auto; } #calendar-grid { flex-shrink: 0; } #agendaListContainer { flex-grow: 1; padding: 0; height: calc(100vh - 48px); overflow-y: auto; } #weekly-view-container { flex-grow: 1; height: calc(100vh - 48px); overflow-y: auto; } .view#todayView, .view#tasksView, .view#helpView, .view#searchView { max-width: 800px; margin: 0 auto; padding: 32px; } .fab { bottom: 32px; right: 32px; } }
    </style>
</head>
<body>
    <!-- NOTA: La imagen 'aiDANaI.webp' debe estar en la misma carpeta que este fichero HTML -->
    <div id="welcomeScreen" class="intro-screen"><img src="aiDANaI.webp" id="welcomeImage" alt="Logo Agenda aiDANaI"></div>
    
    <div id="login-screen" class="login-view">
        <div class="login-view__card">
            <h2 class="login-view__title">🗓️ Agenda aiDANaI</h2>
            <form id="login-form" novalidate>
                <div class="form-group"><input type="email" id="login-email" class="form-input" placeholder="Correo electrónico" required></div>
                <div class="form-group"><input type="password" id="login-password" class="form-input" placeholder="Contraseña" required></div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button type="button" data-action="login" class="btn btn-primary" style="flex: 1;">Iniciar Sesión</button>
                    <button type="button" data-action="register" class="btn btn-secondary" style="flex: 1;">Registrarse</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-root">
        <nav class="bottom-nav">
            <button class="nav-item active" data-view="today" title="Hoy"><span class="material-icons">home</span></button>
            <button class="nav-item" data-view="calendar" title="Agenda"><span class="material-icons">calendar_today</span></button>
            <button class="nav-item" data-view="tasks" title="Tareas"><span class="material-icons">task_alt</span></button>
            <button class="nav-item" data-view="help" title="Ayuda"><span class="material-icons">help_outline</span></button>
            <button class="nav-item" id="nav-theme-btn" title="Cambiar Tema"><span class="material-icons">brightness_6</span></button>
            <button class="nav-item" id="google-sync-btn" title="Conectar con Google Calendar" disabled><span class="material-icons">sync</span></button>
            <button class="nav-item" data-action="logout" title="Salir de la App"><span class="material-icons">logout</span></button>
        </nav>

        <main class="main-content" id="main-content-area">
            <div id="todayView" class="view active">
                <h1 id="today-greeting"></h1>
                <h3 class="section-title" id="today-events-title">Eventos de Hoy</h3>
                <div id="today-events-list"></div>
                <div id="empty-today-events" class="empty-state" style="display: none;">
                    <span class="material-icons">celebration</span>
                    <p>No tienes eventos para hoy. ¡Disfruta del día!</p>
                    <button class="btn btn-primary" data-action="quick-add">Añadir Evento o Tarea</button>
                </div>
                <h3 class="section-title" id="today-tasks-title">Tareas Pendientes</h3>
                <div id="today-tasks-list"></div>
                <div id="empty-today-tasks" class="empty-state" style="display: none;">
                    <span class="material-icons">check_circle</span>
                    <p>¡Ninguna tarea pendiente! Bien hecho.</p>
                    <button class="btn btn-primary" data-action="quick-add">Añadir Nueva Tarea</button>
                </div>
                <h3 class="section-title" id="tomorrow-events-title">Mañana te espera...</h3>
                <div id="tomorrow-events-list"></div>
                <div id="empty-tomorrow-events" class="empty-state" style="display: none;"><span class="material-icons">event_upcoming</span><p>Nada programado para mañana todavía.</p></div>
            </div>

            <div id="calendarView" class="view">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-title-container">
                            <button id="calendar-title-btn" title="Seleccionar mes y año"></button>
                            <span id="sync-status-indicator"></span>
                        </div>
                        <div class="calendar-nav">
                            <button id="search-toggle-btn" class="icon-button" title="Buscar"><span class="material-icons">search</span></button>
                            <div class="view-toggle">
                                <button id="month-view-btn" class="btn-toggle active" data-mode="month" title="Vista Mensual"><span class="material-icons">calendar_month</span></button>
                                <button id="week-view-btn" class="btn-toggle" data-mode="week" title="Vista Semanal"><span class="material-icons">view_week</span></button>
                            </div>
                            <button id="today-btn" class="icon-button" title="Ir a Hoy en el Calendario"><span class="material-icons">today</span></button>
                            <button id="prev-nav-btn" class="icon-button" title="Mes anterior"><span class="material-icons">chevron_left</span></button>
                            <button id="next-nav-btn" class="icon-button" title="Mes siguiente"><span class="material-icons">chevron_right</span></button>
                        </div>
                    </div>
                    <div id="search-container">
                        <form id="search-form"><input type="search" id="search-input" placeholder="Buscar y pulsar Enter..."><button type="submit" class="btn btn-primary" style="padding: 8px 12px; border-radius: 50%; width: 40px; height: 40px;"><span class="material-icons">search</span></button></form>
                    </div>
                    <div id="calendar-grid" class="calendar-grid"><div class="calendar-weekdays" id="calendarWeekdays"></div><div class="calendar-days" id="calendarDays"></div></div>
                </div>
                <div class="agenda-list-container" id="agendaListContainer"><div id="agendaList"></div></div>
                <div id="weekly-view-container" class="weekly-view-container"></div>
            </div>

            <div id="tasksView" class="view">
                <div class="tasks-header">
                    <select id="task-list-filter" class="form-select"></select>
                    <button id="manage-lists-btn" class="icon-button" title="Gestionar Listas"><span class="material-icons">playlist_add</span></button>
                </div>
                <div id="tasks-content"></div>
                <div id="emptyTasks" class="empty-state" style="display: none;">
                    <span class="material-icons">check_circle_outline</span>
                    <p>No tienes tareas en esta lista.</p>
                    <button class="btn btn-primary" data-action="quick-add">Añadir tu primera tarea</button>
                </div>
            </div>

            <div id="searchView" class="view">
                <h3 class="section-title" id="search-results-title">Resultados de la Búsqueda</h3>
                <div id="searchResultsList"></div>
                <div id="emptySearch" class="empty-state" style="display: none;"><span class="material-icons">search_off</span><p>No se encontraron resultados.</p></div>
            </div>

            <div id="helpView" class="view">
                <div class="help-section">
                    <h2 class="section-title" style="font-size: 20px; margin-top: 0;"><span><span class="material-icons">rocket_launch</span>Bienvenido a tu Segundo Cerebro</span></h2>
                    <p style="padding: 0 4px 16px; font-size: 15px; color: var(--secondary-color);">aiDANaI no es solo una agenda. Es un espacio inteligente diseñado para que tus ideas se conviertan en realidad. Olvida el desorden; aquí, cada plan tiene su lugar y cada meta es alcanzable. Esta guía te convertirá en un maestro de la productividad. ¡Empezamos!</p>
                    <details open> <summary>El Dúo Dinámico: Eventos y Tareas<span class="material-icons">expand_more</span></summary> <div class="details-content"> <p>En el corazón de aiDANaI viven dos conceptos clave que organizarán tu vida:</p> <ul> <li><span class="material-icons" style="vertical-align: middle; color: var(--accent-event-normal); margin-right: 8px;">event</span> <b>Eventos:</b> Son momentos con un lugar fijo en tu calendario. Tienen una fecha y, opcionalmente, una hora. <i>"Cena con mamá el viernes a las 9"</i>. Son los pilares inamovibles de tu tiempo.</li> <li><span class="material-icons" style="vertical-align: middle; color: var(--accent-task); margin-right: 8px;">task_alt</span> <b>Tareas:</b> Son tus "pendientes", las acciones que necesitas completar sin una hora específica. <i>"Comprar el regalo de cumpleaños de Ana"</i>. Son los pasos que das para alcanzar tus metas.</li> </ul> <p>La app diferencia visualmente cada ítem con iconos y colores para que de un vistazo sepas qué es qué.</p> </div> </details>
                    <details> <summary>Tu Varita Mágica: Creación Rápida con IA ✨<span class="material-icons">expand_more</span></summary> <div class="details-content"> <p>Esta es la joya de la corona. Olvídate de rellenar formularios. Pulsa el botón flotante <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: var(--primary-color); color: var(--on-primary); border-radius: 50%; vertical-align: middle;"><span class="material-icons" style="font-size: 20px;">add</span></span> y habla con tu agenda en lenguaje humano. La IA entiende el contexto:</p> <ul> <li>"<u>Reunión de marketing mañana a las 10:30</u>" <b>→</b> Crea un <b>Evento</b> para mañana a esa hora.</li> <li>"<u>Llamar al dentista el viernes</u>" <b>→</b> Crea un <b>Evento</b> para el próximo viernes (sin hora).</li> <li>"<u>Revisión del coche el 24/08/2024</u>" <b>→</b> Crea un <b>Evento</b> en esa fecha específica.</li> <li>"<u>Comprar leche, pan y huevos</u>" <b>→</b> Crea una <b>Tarea</b> sin fecha.</li> </ul> <p><b>Consejo Pro:</b> Si la IA interpreta algo y quieres ajustarlo, pulsa "Editar Detalles" antes de guardar para acceder al modo avanzado y tener control total sobre la fecha, hora, notificaciones y más.</p> </div> </details>
                    <details> <summary>El Arte de la Eficiencia: Gestos que Ahorran Tiempo 🤸<span class="material-icons">expand_more</span></summary> <div class="details-content"> <p>Interactúa con tus ítems usando gestos rápidos para maximizar tu eficiencia.</p> <p><b>Para TODOS los ítems (Eventos y Tareas):</b></p> <ul> <li><span style="color: var(--accent-edit);"><b>TOCAR EL TEXTO</b></span> <span class="material-icons" style="vertical-align: middle;">touch_app</span> Abre la ventana de <b>edición avanzada</b> para modificar todos los detalles.</li> <li><span style="color: var(--accent-delete);"><b>DESLIZAR A LA IZQUIERDA</b></span> <span class="material-icons" style="vertical-align: middle;">arrow_back</span> Muestra la opción de <b>eliminar</b>. ¡Úsalo con cuidado!</li> </ul> <p><b>Acciones Específicas al Deslizar a la Derecha <span class="material-icons" style="vertical-align: middle;">arrow_forward</span>:</b></p> <ul> <li><b>Para TAREAS <span class="material-icons" style="vertical-align: middle;">task_alt</span>:</b> La marca como <b>completada</b>. ¡La forma más rápida de tachar de tu lista!</li> <li><b>Para EVENTOS <span class="material-icons" style="vertical-align: middle;">event</span>:</b> Lo marca como <b>completado</b>. Si es un evento recurrente, programará automáticamente la siguiente ocurrencia.</li> </ul> </div> </details>
                    <details> <summary>Tu Centro de Mando: La Vista "Hoy" 🏠<span class="material-icons">expand_more</span></summary> <div class="details-content"> <p>Es lo primero que ves por una razón: te da un resumen perfecto de tu presente y tu futuro inmediato. Aquí encontrarás:</p> <ul> <li><b>Eventos de Hoy:</b> Tu agenda para las próximas horas, ordenada cronológicamente.</li> <li><b>Tareas Pendientes:</b> La lista de todo lo que tienes que hacer, incluidas las subtareas visibles.</li> <li><b>Mañana te espera...:</b> Un vistazo rápido a los eventos del día siguiente para que nada te pille por sorpresa.</li> </ul> </div> </details>
                    <details> <summary>Domina el Tiempo: La Vista "Agenda" 🗓️<span class="material-icons">expand_more</span></summary> <div class="details-content"> <p>Tu calendario completo, con dos modos de visualización para una planificación perfecta. Usa los botones <button class="btn-toggle active" style="cursor: default; padding: 2px 6px; font-size: 12px; height: auto;"><span class="material-icons" style="font-size: 16px;">calendar_month</span></button> y <button class="btn-toggle" style="cursor: default; padding: 2px 6px; font-size: 12px; height: auto;"><span class="material-icons" style="font-size: 16px;">view_week</span></button> para cambiar de vista.</p> <ul> <li><span class="material-icons" style="vertical-align: middle;">calendar_month</span> <b>Vista Mensual:</b> Perfecta para una visión a largo plazo. Verás puntos de colores en los días con actividad. Toca un día para seleccionarlo y ver todos sus eventos en la lista de abajo (o a la derecha en pantallas grandes).</li> <li><span class="material-icons" style="vertical-align: middle;">view_week</span> <b>Vista Semanal:</b> Ideal para la planificación detallada. Te muestra cada día de la semana en una sección, con sus eventos listados claramente.</li> </ul> <p>Usa los botones <span class="material-icons" style="vertical-align: middle;">chevron_left</span> y <span class="material-icons" style="vertical-align: middle;">chevron_right</span> para moverte entre meses o semanas, y pulsa "Hoy" para volver al presente al instante.</p> </div> </details>
                    <details> <summary>Conquista tus Metas: La Vista "Tareas" ✅<span class="material-icons">expand_more</span></summary> <div class="details-content"> <p>Aquí es donde las pequeñas acciones se unen para completar grandes proyectos.</p> <ul> <li><b>🗂️ Listas de Tareas:</b> No mezcles el trabajo con la vida personal. Crea listas para diferentes áreas ("Trabajo", "Casa", "Proyecto X") usando el botón <span class="material-icons" style="vertical-align: middle;">playlist_add</span>.</li> <li><b>📋 Sub-tareas:</b> ¿Una tarea parece demasiado grande? Divídela. Ahora puedes verlas y marcarlas directamente en la lista principal, y verás una <b>barra de progreso</b> que te motivará a medida que avanzas.</li> <li><b>🎉 Completadas:</b> Las tareas finalizadas se mueven a una sección propia al final de la lista, dándote una satisfactoria vista de tus logros.</li> </ul> </div> </details>
                    <details> <summary>El Panel de Control: Edición Avanzada ⚙️<span class="material-icons">expand_more</span></summary> <div class="details-content"> <p>Cuando necesitas precisión, el modo de edición avanzada (al tocar un ítem) es tu mejor aliado. Aquí puedes:</p> <ul> <li>Asignar un evento a una fecha y hora exactas.</li> <li>Marcar un evento como <b><span style="color: var(--accent-event-important);">Importante</span></b> para que destaque en rojo.</li> <li>Configurar <b>notificaciones</b> para que te avisemos con antelación (5, 15, 30 o 60 minutos antes).</li> <li>Establecer <b>recurrencia</b> (diaria, semanal, etc.) para eventos que se repiten.</li> <li>Asignar tareas a tus <b>listas</b> personalizadas.</li> <li>Añadir, editar y marcar <b>sub-tareas</b>.</li> </ul> </div> </details>
                    <details> <summary>Funciones Adicionales y Consejos<span class="material-icons">expand_more</span></summary> <div class="details-content"> <ul> <li><b>Búsqueda Global:</b> En la vista de Agenda, toca el icono <span class="material-icons" style="vertical-align: middle;">search</span> para buscar cualquier ítem por su descripción.</li> <li><b>Modo Oscuro/Claro:</b> Usa el botón <span class="material-icons" style="vertical-align: middle;">brightness_6</span> en la barra de navegación para cambiar el tema visual de la aplicación.</li> <li><b>Sincronización en la Nube:</b> El icono <span class="material-icons" style="vertical-align: middle; color: var(--accent-complete);">cloud_done</span> en la cabecera de la agenda te indica que tus datos están sincronizados. Si estás sin conexión, cambiará a <span class="material-icons" style="vertical-align: middle; color: var(--secondary-color);">cloud_off</span> y guardará tus cambios localmente para sincronizarlos cuando vuelvas a tener internet.</li> </ul> </div> </details>
                    <p style="text-align: center; color: var(--secondary-color); margin-top: 24px; font-size: 14px;">¡Ya está! Ahora tienes todo el conocimiento para que aiDANaI trabaje para ti. Explora, experimenta y convierte tus planes en logros. 😉</p>
                </div>
            </div>
        </main>

        <button id="fab-add-item" class="fab" title="Añadir ítem">
            <span class="material-icons">add</span>
        </button>
    </div>

    <!-- Modales -->
    <div id="quick-add-modal" class="modal-overlay"> <div class="modal"> <div class="modal-grabber"></div> <form id="quick-add-form"> <div class="form-group"> <label class="form-label" for="quick-add-input">Creación Rápida con IA ✨</label> <textarea class="form-textarea" id="quick-add-input" placeholder="Ej: 'Reunión con el equipo mañana a las 10:30'..." rows="3"></textarea> <div id="quick-add-feedback"></div> </div> <div class="form-actions"> <button type="button" class="btn-link" id="open-advanced-editor-btn">Editar Detalles</button> <div> <button type="button" class="btn btn-secondary" id="cancel-quick-add-btn">Cancelar</button> <button type="submit" class="btn btn-primary" id="save-quick-add-btn">Añadir</button> </div> </div> </form> </div> </div>
    <div id="add-item-modal" class="modal-overlay"> <div class="modal"> <div class="modal-grabber"></div> <form id="add-item-form"> <input type="hidden" id="item-local-id"> <div class="form-group"><label class="form-label" for="item-description">Descripción</label><textarea class="form-textarea" id="item-description" placeholder="Describe el ítem..." rows="3"></textarea></div> <div class="form-group"><label class="form-label" for="item-type">Tipo</label><select class="form-select" id="item-type"><option value="agenda">Evento (con fecha)</option><option value="task">Tarea (sin fecha)</option></select></div> <div id="task-options-group"> <div class="form-group"><label class="form-label" for="item-task-list">Lista de Tareas</label><select class="form-select" id="item-task-list"></select></div> <div class="form-group"> <label class="form-label">Sub-tareas</label> <div id="subtasks-container"></div> <div id="add-subtask-controls" style="display: flex; gap: 8px;"> <input type="text" id="new-subtask-input" class="form-input" placeholder="Añadir sub-tarea y pulsar Enter..."> <button type="button" id="add-subtask-btn" class="btn-icon" style="background:var(--primary-color); color: var(--on-primary); flex-shrink:0;"><span class="material-icons">add</span></button> </div> </div> </div> <div id="datetime-notification-group"> <div class="form-group"><label class="form-label" for="item-datetime">Fecha y Hora</label><input type="text" class="form-input" id="item-datetime" placeholder="Selecciona fecha y hora..."></div> <div id="event-options" style="margin-top: 12px;"> <div class="form-group" style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="item-important"><label for="item-important">Marcar como importante (Rojo)</label></div> <div class="form-group" style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="item-notification-enabled"><label for="item-notification-enabled">Activar notificación</label></div> <div class="form-group" id="reminder-time-group" style="display: none; margin-top: 12px;"> <label class="form-label" for="item-reminder">Avisarme...</label> <select class="form-select" id="item-reminder"><option value="0">Justo a la hora</option><option value="5">5 minutos antes</option><option value="15">15 minutos antes</option><option value="30">30 minutos antes</option><option value="60">1 hora antes</option></select> </div> <div class="form-group" style="margin-top: 12px;"><label class="form-label" for="item-recurrence">Repetir</label><select class="form-select" id="item-recurrence"><option value="none">No repetir</option><option value="daily">Diariamente</option><option value="weekly">Semanalmente</option><option value="monthly">Mensualmente</option><option value="yearly">Anualmente</option></select></div> </div> </div> <div class="form-actions"> <button type="button" class="btn-icon" id="delete-item-btn" style="display: none;" title="Eliminar"><span class="material-icons">delete</span></button> <button type="button" class="btn btn-secondary" id="cancel-item-btn">Cancelar</button> <button type="submit" class="btn-icon" id="save-item-btn" title="Guardar"><span class="material-icons">check</span></button> </div> </form> </div> </div>
    <div id="manage-lists-modal" class="modal-overlay"> <div class="modal"> <div class="modal-grabber"></div> <h3 class="section-title">Gestionar Listas de Tareas</h3> <div id="task-lists-editor"></div> <form id="add-list-form" style="display:flex; gap:8px; margin-top:16px;"> <input type="text" id="new-list-name" class="form-input" placeholder="Nombre de nueva lista..." required> <button type="submit" class="btn btn-primary">Añadir</button> </form> <div class="form-actions" style="justify-content:flex-end;"> <button type="button" class="btn btn-secondary" id="close-manage-lists-btn">Cerrar</button> </div> </div> </div>
    <div id="date-picker-modal" class="modal-overlay"><div class="modal"><div class="modal-grabber"></div><form id="date-picker-form"><div class="form-group"><label class="form-label">Mes</label><select id="month-select" class="form-select"></select></div><div class="form-group"><label class="form-label">Año</label><input type="number" id="year-select" min="2020" max="2030" step="1" class="form-input"></div><div style="display:flex; gap:12px; margin-top:24px;"><button type="button" class="btn btn-secondary" id="cancel-date-picker-btn">Cancelar</button><button type="submit" class="btn btn-primary">Ir</button></div></form></div></div>
    <div id="toast-container"></div>
    <div id="custom-confirm-modal" class="modal-overlay"> <div class="modal"> <div class="modal-grabber"></div> <p id="confirm-message" style="margin-bottom: 24px; text-align: center; font-size: 16px;"></p> <div class="form-actions" style="justify-content: center; gap: 16px;"> <button type="button" class="btn btn-secondary" id="confirm-cancel-btn">Cancelar</button> <button type="button" class="btn btn-primary" id="confirm-ok-btn">Confirmar</button> </div> </div> </div>


    <!-- SCRIPT PRINCIPAL DE LA APLICACIÓN -->
    <script type="module">
        // 1. IMPORTACIÓN DE FUNCIONES DE FIREBASE (SDK MODULAR)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, enableIndexedDbPersistence, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // =================================================================================
        // CONFIGURACIÓN Y CONSTANTES GLOBALES
        // =================================================================================

        // =============================================================================== //
        // ¡¡¡IMPORTANTE!!! PASO 1: OBTIENE TUS PROPIAS CREDENCIALES DESDE GOOGLE CLOUD CONSOLE //
        // Habilita la "Google Calendar API". Crea una "API Key" y un "OAuth 2.0 Client ID" //
        // =============================================================================== //
        const GOOGLE_CLIENT_ID = '364074046164-bb80vb1bodaaj7rc2i9e7520l9hp8klo.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyD_EI1odi7jWdv7vSGkc58KCoSOJedt8uY';
		        
        // ========================================================================= //
        // ¡¡¡IMPORTANTE!!! PASO 2: OBTIENE TUS PROPIAS CREDENCIALES DESDE FIREBASE     //
        // Crea un proyecto en Firebase, añade una app web y copia la configuración. //
        // ========================================================================= //
        const firebaseConfig = { 
			apiKey: "AIzaSyAp-t-2qmbvSX-QEBW9B1aAJHBESqnXy9M", 
			authDomain: "cuentas-aidanai.firebaseapp.com",
			projectId: "cuentas-aidanai",
			storageBucket: "cuentas-aidanai.appspot.com",
			messagingSenderId: "58244686591",
			appId: "1:58244686591:web:85c87256c2287d350322ca"
            };
        // <!-- FIN DE LA CONFIGURACIÓN REQUERIDA -->


        const CONSTANTS = { VIEWS: { TODAY: 'today', CALENDAR: 'calendar', TASKS: 'tasks', HELP: 'help', SEARCH: 'search' }, ITEM_TYPES: { AGENDA: 'agenda', TASK: 'task' }, ANIMATION_CLASSES: { ITEM_ENTERING: 'item-entering', ITEM_EXITING: 'item-exiting' } };
        const GOOGLE_DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const GOOGLE_SCOPES = "https://www.googleapis.com/auth/calendar.events";
        const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const MESES_CORTOS = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        const DIAS_SEMANA_LARGOS = ['lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo'];
        const DIAS_SEMANA_CORTOS = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
        const VIEW_ORDER = ['today', 'calendar', 'tasks', 'help'];
        let googleAuthInstance; let isGoogleSignedIn = false; let flatpickrInstance = null; let currentUser = null, unsubscribeFromDb = null, saveTimeout = null; let db = {}; let activeTimers = {}; const initialState = { currentView: 'today', lastView: 'today', calendar: { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), selectedDate: dateToYYYYMMDD(new Date()), displayMode: 'month' }, tasks: { selectedListId: 'default' } }; let appState = { ...initialState }; let isAppInitialized = false; let isViewSwitching = false; let newlyCreatedItemId = null; let isSyncingWithGoogle = false; // ================================================================================= // FUNCIONES DE UTILIDAD // ================================================================================= const gebi = id => document.getElementById(id); const qsa = selector => document.querySelectorAll(selector); function dateToYYYYMMDD(date) { if (!date || isNaN(date.getTime())) return ''; return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; } function dateToHHMM(date) { if (!date || isNaN(date.getTime())) return "00:00"; return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`; } function yyyymmddToDate(dateStr) { if (!dateStr) return new Date(); const parts = dateStr.split('-'); return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10)); } function uuid() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); } const wait = ms => new Promise(resolve => setTimeout(resolve, ms)); function triggerHapticFeedback(type = 'light') { if ('vibrate' in navigator) { switch (type) { case 'light': navigator.vibrate(10); break; case 'medium': navigator.vibrate(40); break; case 'success': navigator.vibrate([20, 50, 20]); break; default: navigator.vibrate(10); } } } function debounce(func, delay = 250) { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => { func.apply(this, args); }, delay); }; } function formatDateForFeedback(isoDate) { if (!isoDate) return ''; const date = new Date(isoDate); const now = new Date(); const tomorrow = new Date(); tomorrow.setDate(now.getDate() + 1); let datePart; if (date.toDateString() === now.toDateString()) { datePart = 'Hoy'; } else if (date.toDateString() === tomorrow.toDateString()) { datePart = 'Mañana'; } else { datePart = date.toLocaleDateString('es-ES', { weekday: 'short', month: 'short', day: 'numeric' }); } const timePart = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false }); return timePart !== '00:00' ? `${datePart}, ${timePart}` : datePart; } function showToast(message, isError = false) { const tc = gebi('toast-container'); if (!tc) return; const t = document.createElement('div'); t.className = `toast`; if (isError) t.style.backgroundColor = 'var(--accent-delete)'; t.textContent = message; tc.appendChild(t); setTimeout(() => t.remove(), 3000); } // ================================================================================= // INTEGRACIÓN CON API DE GOOGLE // =================================================================================
		window.handleGoogleClientLoad = function() { gapi.load('client:auth2', initGoogleClient); }
		function initGoogleClient() { const syncButton = gebi('google-sync-btn'); syncButton.classList.add('loading'); gapi.client.init({ apiKey: GOOGLE_API_KEY, clientId: GOOGLE_CLIENT_ID, discoveryDocs: GOOGLE_DISCOVERY_DOCS, scope: GOOGLE_SCOPES }).then(() => { syncButton.classList.remove('loading'); syncButton.disabled = false; googleAuthInstance = gapi.auth2.getAuthInstance(); googleAuthInstance.isSignedIn.listen(updateGoogleSigninStatus); updateGoogleSigninStatus(googleAuthInstance.isSignedIn.get()); }).catch(error => { console.error("Error initializing Google Client:", error); showToast("No se pudo conectar con Google Calendar.", true); syncButton.classList.remove('loading'); syncButton.disabled = true; syncButton.title = 'Error al conectar con Google'; syncButton.querySelector('.material-icons').textContent = 'sync_problem'; }); } function updateGoogleSigninStatus(isSignedIn) { const wasSignedIn = isGoogleSignedIn; isGoogleSignedIn = isSignedIn; const syncButton = gebi('google-sync-btn'); if (isSignedIn) { syncButton.classList.add('connected'); syncButton.title = 'Conectado. Haz clic para sincronizar manualmente.'; syncButton.querySelector('.material-icons').textContent = 'cloud_done'; showToast("Conectado a Google Calendar."); if (!wasSignedIn) { syncWithGoogleCalendar(); } } else { syncButton.classList.remove('connected'); syncButton.title = 'Sincronizar con Google'; syncButton.querySelector('.material-icons').textContent = 'sync'; } } function handleGoogleAuthClick() { if (!googleAuthInstance) { showToast("La API de Google aún no está lista. Inténtalo de nuevo.", true); console.error("Se intentó usar googleAuthInstance pero no está inicializado."); return; } if (isGoogleSignedIn) { syncWithGoogleCalendar(); } else { googleAuthInstance.signIn(); } } async function crearEventoEnGoogle(item) { if (!isGoogleSignedIn || item.type !== 'agenda') return null; const startDate = new Date(item.dueDate); const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); const event = { 'summary': item.description, 'start': { 'dateTime': startDate.toISOString(), 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone }, 'end': { 'dateTime': endDate.toISOString(), 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone }, 'reminders': { 'useDefault': false, 'overrides': item.notificationEnabled ? [{ 'method': 'popup', 'minutes': item.reminderMinutes }] : [] }, ...(item.isImportant && { 'colorId': '11' }) }; try { const response = await gapi.client.calendar.events.insert({ 'calendarId': 'primary', 'resource': event }); console.log('Evento creado en Google:', response.result); return response.result.id; } catch (error) { console.error('Error creando evento en Google:', error); showToast('Error al crear evento en Google.', true); return null; } } async function actualizarEventoEnGoogle(item) { if (!isGoogleSignedIn || !item.googleCalendarEventId || item.type !== 'agenda') return; const startDate = new Date(item.dueDate); const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); const event = { 'summary': item.description, 'start': { 'dateTime': startDate.toISOString(), 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone }, 'end': { 'dateTime': endDate.toISOString(), 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone }, 'reminders': { 'useDefault': false, 'overrides': item.notificationEnabled ? [{ 'method': 'popup', 'minutes': item.reminderMinutes }] : [] }, 'colorId': item.isImportant ? '11' : null }; try { await gapi.client.calendar.events.update({ 'calendarId': 'primary', 'eventId': item.googleCalendarEventId, 'resource': event }); console.log('Evento actualizado en Google'); } catch (error) { console.error('Error actualizando evento en Google:', error); showToast('Error al actualizar evento en Google.', true); } } async function borrarEventoEnGoogle(item) { if (!isGoogleSignedIn || !item.googleCalendarEventId || item.type !== 'agenda') return; try { await gapi.client.calendar.events.delete({ 'calendarId': 'primary', 'eventId': item.googleCalendarEventId }); console.log('Evento eliminado de Google Calendar'); } catch (error) { console.error('Error eliminando evento en Google:', error); if (error.result && (error.result.error.code === 404 || error.result.error.code === 410)) { console.log("El evento ya no existía en Google Calendar. Sincronización correcta."); } else { showToast('Error al eliminar evento de Google.', true); throw error; } } } async function getGoogleCalendarEvents() { if (!isGoogleSignedIn) return []; try { const timeMin = new Date(); timeMin.setMonth(timeMin.getMonth() - 1); const timeMax = new Date(); timeMax.setFullYear(timeMax.getFullYear() + 1); const response = await gapi.client.calendar.events.list({ 'calendarId': 'primary', 'timeMin': timeMin.toISOString(), 'timeMax': timeMax.toISOString(), 'showDeleted': false, 'singleEvents': true, 'maxResults': 250, 'orderBy': 'startTime' }); return response.result.items; } catch (error) { console.error("Error fetching events from Google Calendar:", error); showToast("Error al obtener eventos de Google.", true); return []; } } function convertGoogleEventToAidanaiItem(googleEvent) { const dueDate = googleEvent.start?.dateTime || googleEvent.start?.date; if (!dueDate) return null; return { localId: uuid(), googleCalendarEventId: googleEvent.id, type: CONSTANTS.ITEM_TYPES.AGENDA, description: googleEvent.summary || 'Sin Título', dueDate: new Date(dueDate).toISOString(), isComplete: false, createdAt: new Date(googleEvent.created).getTime(), updatedAt: new Date(googleEvent.updated).getTime(), isImportant: googleEvent.colorId === '11', notificationEnabled: googleEvent.reminders?.useDefault === false && googleEvent.reminders?.overrides?.length > 0, reminderMinutes: googleEvent.reminders?.overrides?.[0]?.minutes || 0, recurrenceRule: 'none', notificationShown: false, }; } async function syncWithGoogleCalendar() { if (isSyncingWithGoogle) { showToast("Sincronización ya en curso."); return; } if (!isGoogleSignedIn || !currentUser) return; const syncButton = gebi('google-sync-btn'); isSyncingWithGoogle = true; syncButton.classList.add('loading'); showToast("Sincronizando con Google Calendar..."); try { const googleEvents = await getGoogleCalendarEvents(); const aidanaiEvents = db.items.filter(item => item.type === CONSTANTS.ITEM_TYPES.AGENDA); const googleEventsMap = new Map(googleEvents.map(e => [e.id, e])); const aidanaiEventsMap = new Map(aidanaiEvents.filter(i => i.googleCalendarEventId).map(i => [i.googleCalendarEventId, i])); let changesMade = false; for (const [googleId, googleEvent] of googleEventsMap.entries()) { if (!aidanaiEventsMap.has(googleId)) { console.log(`Sync: Evento '${googleEvent.summary}' encontrado en Google, añadiendo a aiDANaI.`); const newItem = convertGoogleEventToAidanaiItem(googleEvent); if (newItem) { db.items.unshift(newItem); changesMade = true; } } } for (const aidanaiEvent of aidanaiEvents) { if (!aidanaiEvent.googleCalendarEventId) continue; const googleEvent = googleEventsMap.get(aidanaiEvent.googleCalendarEventId); if (!googleEvent) { console.log(`Sync: Evento '${aidanaiEvent.description}' no encontrado en Google, eliminando de aiDANaI.`); db.items = db.items.filter(item => item.localId !== aidanaiEvent.localId); changesMade = true; } else { const aidanaiUpdated = new Date(aidanaiEvent.updatedAt || aidanaiEvent.createdAt); const googleUpdated = new Date(googleEvent.updated); if (googleUpdated > aidanaiUpdated) { console.log(`Sync: Evento '${aidanaiEvent.description}' actualizado en Google, actualizando aiDANaI.`); const updatedItem = convertGoogleEventToAidanaiItem(googleEvent); if (updatedItem) { const index = db.items.findIndex(i => i.localId === aidanaiEvent.localId); if (index > -1) { db.items[index] = { ...db.items[index], ...updatedItem, localId: aidanaiEvent.localId }; changesMade = true; } } } else if (aidanaiUpdated > googleUpdated) { console.log(`Sync: Evento '${aidanaiEvent.description}' actualizado en aiDANaI, actualizando Google.`); await actualizarEventoEnGoogle(aidanaiEvent); } } } const localOnlyEvents = db.items.filter(item => item.type === 'agenda' && !item.googleCalendarEventId); if(localOnlyEvents.length > 0) { console.log(`Sync: Se encontraron ${localOnlyEvents.length} eventos locales para subir a Google.`); for (const localEvent of localOnlyEvents) { console.log(`Sync: Subiendo '${localEvent.description}' a Google Calendar.`); const newGoogleId = await crearEventoEnGoogle(localEvent); if (newGoogleId) { const eventIndex = db.items.findIndex(i => i.localId === localEvent.localId); if (eventIndex > -1) { db.items[eventIndex].googleCalendarEventId = newGoogleId; db.items[eventIndex].updatedAt = Date.now(); changesMade = true; } } } } if (changesMade) { showToast("Sincronización completada. Se actualizaron los datos."); await saveData(); renderApp(); } else { showToast("Tus datos ya estaban sincronizados."); } } catch (error) { showToast("Ocurrió un error durante la sincronización.", true); console.error("Error en syncWithGoogleCalendar:", error); } finally { isSyncingWithGoogle = false; syncButton.classList.remove('loading'); } } // ================================================================================= // INICIALIZACIÓN DE FIREBASE Y MANEJO DE DATOS // ================================================================================= const app = initializeApp(firebaseConfig); const fbAuth = getAuth(app); const fbDb = getFirestore(app); enableIndexedDbPersistence(fbDb).catch(err => { if (err.code == 'failed-precondition') console.warn("Persistencia falló: múltiples pestañas abiertas."); else if (err.code == 'unimplemented') console.warn("Persistencia no soportada en este navegador."); }); const getInitialDb = () => ({ items: [], taskLists: [{ id: 'default', name: 'General' }], config: { theme: 'dark', tutorialCompleted: false } }); const saveData = () => new Promise((resolve, reject) => { if (!currentUser) return reject(new Error("Usuario no autenticado.")); clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { const userDocRef = doc(fbDb, 'users', currentUser.uid); setDoc(userDocRef, { db }) .then(() => { console.log("Sincronización con Firebase exitosa."); resolve(); }) .catch(error => { console.error("Error al guardar en Firestore:", error); reject(error); }); }, 500); }); const loadData = uid => { const userDocRef = doc(fbDb, 'users', uid); if (unsubscribeFromDb) unsubscribeFromDb(); unsubscribeFromDb = onSnapshot(userDocRef, docSnapshot => { let needsSave = false; if (docSnapshot.exists() && docSnapshot.data().db) { db = docSnapshot.data().db; if (!db.items) { db.items = []; needsSave = true; } if (!db.config) { db.config = { theme: 'dark', tutorialCompleted: false }; needsSave = true; } if (db.config.tutorialCompleted === undefined) { db.config.tutorialCompleted = false; needsSave = true; } if (!db.taskLists || db.taskLists.length === 0) { db.taskLists = [{ id: 'default', name: 'General' }]; needsSave = true; } } else { db = getInitialDb(); needsSave = true; } if (needsSave && currentUser) saveData().catch(err => showToast("No se pudo guardar la configuración inicial.", true)); if (!isAppInitialized) startMainApp(); else renderApp(); }, error => { console.error("Error con Firestore:", error); showToast("Error de conexión con la base de datos.", true); }); }; // ================================================================================= // FLUJO DE INICIO Y AUTENTICACIÓN // ================================================================================= // REFACTOR: Se ha rediseñado por completo el flujo de inicio para ser más rápido y robusto. function initApp() { const welcomeScreen = gebi('welcomeScreen'); const welcomeImage = gebi('welcomeImage'); // Muestra la pantalla de bienvenida welcomeScreen.classList.add('visible'); // El listener se adjunta a la imagen, que es el elemento que se anima. welcomeImage.addEventListener('animationend', () => { welcomeScreen.style.opacity = '0'; // Una vez que la pantalla de bienvenida se desvanece, se oculta y se comprueba el estado de autenticación. welcomeScreen.addEventListener('transitionend', () => { welcomeScreen.style.display = 'none'; checkAuthState(); }, { once: true }); }, { once: true }); // Adjuntar listeners globales una sola vez. attachGlobalEventListeners(); initializeDatePicker(); updateSyncStatus(); // Registrar el Service Worker si está disponible. if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js') .then(registration => console.log('Service Worker registrado con éxito:', registration)) .catch(error => console.log('Error en el registro del Service Worker:', error)); }); } } const checkAuthState = () => onAuthStateChanged(fbAuth, user => { if (user) { currentUser = user; loadData(user.uid); } else { currentUser = null; isAppInitialized = false; if (unsubscribeFromDb) unsubscribeFromDb(); db = getInitialDb(); showLoginScreen(); } }); const startMainApp = () => { if (isAppInitialized) return; isAppInitialized = true; applyTheme(db.config.theme || 'dark'); gebi('login-screen').classList.remove('login-view--visible'); gebi('app-root').classList.add('visible'); switchView(appState.currentView, true); scheduleAllNotifications(); if (!db.config.tutorialCompleted) { // Se introduce un pequeño retardo para que el tutorial no aparezca bruscamente sobre la app. setTimeout(startOnboardingTutorial, 500); } }; const showLoginScreen = () => { applyTheme(localStorage.getItem('theme') || 'dark'); gebi('app-root').classList.remove('visible'); gebi('login-screen').classList.add('login-view--visible'); }; const handleAuthError = (error) => { switch (error.code) { case 'auth/user-not-found': showToast('Usuario no encontrado.', true); break; case 'auth/wrong-password': showToast('Contraseña incorrecta.', true); break; case 'auth/invalid-email': showToast('El formato del correo es inválido.', true); break; case 'auth/email-already-in-use': showToast('El correo ya está registrado.', true); break; case 'auth/weak-password': showToast('La contraseña debe tener al menos 6 caracteres.', true); break; default: showToast('Ocurrió un error. Inténtalo de nuevo.', true); console.error(error); break; } }; const handleLogin = () => signInWithEmailAndPassword(fbAuth, gebi('login-email').value, gebi('login-password').value).catch(handleAuthError); const handleRegister = () => createUserWithEmailAndPassword(fbAuth, gebi('login-email').value, gebi('login-password').value).catch(handleAuthError); // ================================================================================= // RENDERIZADO Y LÓGICA DE UI // ================================================================================= function renderApp() { if (!db || !currentUser || !isAppInitialized) return; updateNav(appState.currentView); renderCurrentView(appState); } function renderCurrentView(state) { const viewEl = gebi(`${state.currentView}View`); if (viewEl) { if (state.currentView === 'today') renderTodayView(); if (state.currentView === 'calendar') renderCalendarView(state); if (state.currentView === 'tasks') renderTaskListView(); if (state.currentView === 'search') renderSearchView(gebi('search-input').value); } } function updateNav(currentView) { qsa('.nav-item[data-view]').forEach(item => { item.classList.toggle('active', item.dataset.view === currentView); }); } function renderTodayView() { const hours = new Date().getHours(); const greeting = hours < 12 ? "Buenos días" : hours < 20 ? "Buenas tardes" : "Buenas noches"; gebi('today-greeting').textContent = greeting; const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0); const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999); const tomorrowStart = new Date(todayStart); tomorrowStart.setDate(tomorrowStart.getDate() + 1); const tomorrowEnd = new Date(todayEnd); tomorrowEnd.setDate(tomorrowEnd.getDate() + 1); const todayEvents = db.items.filter(i => i.type === 'agenda' && !i.isComplete && i.dueDate && new Date(i.dueDate) >= todayStart && new Date(i.dueDate) <= todayEnd).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)); const pendingTasks = db.items.filter(i => i.type === 'task' && !i.isComplete).sort((a,b) => a.createdAt - b.createdAt); const tomorrowEvents = db.items.filter(i => i.type === 'agenda' && !i.isComplete && i.dueDate && new Date(i.dueDate) >= tomorrowStart && new Date(i.dueDate) <= tomorrowEnd).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)); const renderListWithEmptyState = (containerId, emptyStateId, titleId, items) => { const container = gebi(containerId); const emptyState = gebi(emptyStateId); const title = gebi(titleId); container.innerHTML = ''; if (items.length > 0) { items.forEach(item => container.appendChild(createUniversalListItemNode(item))); emptyState.style.display = 'none'; title.style.display = 'flex'; } else { emptyState.style.display = 'block'; title.style.display = 'none'; } }; renderListWithEmptyState('today-events-list', 'empty-today-events', 'today-events-title', todayEvents); renderListWithEmptyState('today-tasks-list', 'empty-today-tasks', 'today-tasks-title', pendingTasks); renderListWithEmptyState('tomorrow-events-list', 'empty-tomorrow-events', 'tomorrow-events-title', tomorrowEvents); } function renderCalendarView(state) { const { calendar } = state; const { items } = db; const { currentMonth, currentYear, selectedDate, displayMode } = calendar; gebi('calendar-title-btn').textContent = `${MESES_CORTOS[currentMonth]} ${currentYear}`; gebi('calendarView').dataset.displayMode = displayMode; qsa('.view-toggle .btn-toggle').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === displayMode)); if (displayMode === 'month') { renderMonthGrid(currentMonth, currentYear, selectedDate, items); renderAgendaFromSelectedDay(items, selectedDate); } else { renderWeekGrid(currentMonth, currentYear, selectedDate, items); } } function renderMonthGrid(currentMonth, currentYear, selectedDate, items) { const weekdaysContainer = gebi('calendarWeekdays'); if (weekdaysContainer.innerHTML.length < 5) weekdaysContainer.innerHTML = DIAS_SEMANA_CORTOS.map((day) => `<div class="weekday">${day}</div>`).join(''); const calendarDays = gebi('calendarDays'); calendarDays.innerHTML = ''; const firstDayOfMonth = new Date(currentYear, currentMonth, 1); const offset = (firstDayOfMonth.getDay() + 6) % 7; const startDate = new Date(firstDayOfMonth); startDate.setDate(startDate.getDate() - offset); const todayStr = dateToYYYYMMDD(new Date()); const dailyEventMarkers = new Map(); items.filter(it => it.type === 'agenda' && it.dueDate && !it.isComplete).forEach(it => { const dateStr = dateToYYYYMMDD(new Date(it.dueDate)); if (!dailyEventMarkers.has(dateStr)) dailyEventMarkers.set(dateStr, { hasImportant: false, hasNormal: false }); const marker = dailyEventMarkers.get(dateStr); if (it.isImportant) marker.hasImportant = true; else marker.hasNormal = true; }); for (let i = 0; i < 42; i++) { const cellDate = new Date(startDate); cellDate.setDate(startDate.getDate() + i); const dateStr = dateToYYYYMMDD(cellDate); const dayEl = document.createElement('div'); dayEl.className = 'calendar-day'; dayEl.dataset.date = dateStr; if (cellDate.getMonth() !== currentMonth) dayEl.classList.add('other-month'); if (dateStr === todayStr) dayEl.classList.add('today'); if (dateStr === selectedDate) dayEl.classList.add('selected'); let dotsHtml = ''; if (dailyEventMarkers.has(dateStr)) { const markers = dailyEventMarkers.get(dateStr); dotsHtml = `<div class="event-dots-container">${markers.hasImportant ? '<span class="event-dot important"></span>' : ''}${markers.hasNormal ? '<span class="event-dot normal"></span>' : ''}</div>`; } dayEl.innerHTML = `<span class="day-number">${cellDate.getDate()}</span>${dotsHtml}`; dayEl.dataset.action = 'selectDate'; // REFACTOR: Acción para la delegación de eventos calendarDays.appendChild(dayEl); } } function renderWeekGrid(currentMonth, currentYear, selectedDateStr, items) { const weeklyViewContainer = gebi('weekly-view-container'); weeklyViewContainer.innerHTML = ''; const selectedDate = yyyymmddToDate(selectedDateStr); const startOfWeek = new Date(selectedDate); startOfWeek.setDate(selectedDate.getDate() - ((selectedDate.getDay() + 6) % 7)); for (let i = 0; i < 7; i++) { const day = new Date(startOfWeek); day.setDate(startOfWeek.getDate() + i); const dayStr = dateToYYYYMMDD(day); const eventsForDay = items.filter(item => item.type === 'agenda' && !item.isComplete && item.dueDate && dateToYYYYMMDD(new Date(item.dueDate)) === dayStr ).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)); const daySection = document.createElement('div'); daySection.className = 'weekly-day-section'; daySection.innerHTML = ` <div class="weekly-day-header"> <span class="material-icons">${dayStr === dateToYYYYMMDD(new Date()) ? 'today' : 'event'}</span> ${DIAS_SEMANA_LARGOS[day.getDay() === 0 ? 6 : day.getDay() - 1]} ${day.getDate()} de ${MESES[day.getMonth()]} </div> <div class="weekly-day-events" id="weekly-events-${dayStr}"></div> `; weeklyViewContainer.appendChild(daySection); const eventsListContainer = gebi(`weekly-events-${dayStr}`); if (eventsForDay.length > 0) { eventsForDay.forEach(item => eventsListContainer.appendChild(createUniversalListItemNode(item))); } else { eventsListContainer.innerHTML = `<div class="empty-state"><p>Nada programado.</p></div>`; } } } function renderAgendaFromSelectedDay(items, selectedDateStr) { const agendaList = gebi('agendaList'); agendaList.innerHTML = ''; if (!selectedDateStr) return; const selectedDate = yyyymmddToDate(selectedDateStr); selectedDate.setHours(0, 0, 0, 0); const itemsForDayAndBeyond = items.filter(item => item.type === 'agenda' && !item.isComplete && item.dueDate && new Date(item.dueDate) >= selectedDate) .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)); if (itemsForDayAndBeyond.length === 0) { agendaList.innerHTML = `<div class="empty-state" style="padding-top: 24px;"><span class="material-icons">event_available</span><div>Nada programado a partir de este día.</div></div>`; return; } let lastHeaderDate = null; itemsForDayAndBeyond.forEach(item => { const itemDate = new Date(item.dueDate); const itemDateStr = dateToYYYYMMDD(itemDate); if (itemDateStr !== lastHeaderDate) { const header = document.createElement('div'); header.className = 'agenda-date-header'; header.textContent = itemDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }); agendaList.appendChild(header); lastHeaderDate = itemDateStr; } agendaList.appendChild(createUniversalListItemNode(item)); }); } function renderTaskListView() { const filter = gebi('task-list-filter'); filter.innerHTML = db.taskLists.map(list => `<option value="${list.id}">${list.name}</option>`).join(''); filter.value = appState.tasks.selectedListId; const tasksContainer = gebi('tasks-content'); tasksContainer.innerHTML = ''; const pendingTasks = db.items.filter(i => i.type === 'task' && !i.isComplete && (i.listId || 'default') === appState.tasks.selectedListId).sort((a,b) => a.createdAt - b.createdAt); const completedTasks = db.items.filter(i => i.type === 'task' && i.isComplete && (i.listId || 'default') === appState.tasks.selectedListId).sort((a,b) => (b.completedAt || 0) - (a.completedAt || 0)); if (pendingTasks.length > 0) { const title = document.createElement('h3'); title.className = 'section-title'; title.textContent = 'Tareas Pendientes'; tasksContainer.appendChild(title); pendingTasks.forEach(item => tasksContainer.appendChild(createUniversalListItemNode(item))); } if (completedTasks.length > 0) { const details = document.createElement('details'); details.className = 'completed-tasks-section'; const summary = document.createElement('summary'); summary.innerHTML = `<h3 class="section-title">Tareas Completadas (${completedTasks.length})</h3><span class="material-icons">expand_more</span>`; const completedList = document.createElement('div'); completedList.className = 'completed-tasks-list'; completedTasks.slice(0, 20).forEach(item => completedList.appendChild(createUniversalListItemNode(item))); details.appendChild(summary); details.appendChild(completedList); tasksContainer.appendChild(details); } const isAllEmpty = pendingTasks.length === 0 && completedTasks.length === 0; gebi('emptyTasks').style.display = isAllEmpty ? 'block' : 'none'; } function renderSearchView(query) { const resultsList = gebi('searchResultsList'); resultsList.innerHTML = ''; const emptyState = gebi('emptySearch'); const lowerCaseQuery = query.toLowerCase(); const results = db.items.filter(item => item.description.toLowerCase().includes(lowerCaseQuery)); if (results.length > 0) { emptyState.style.display = 'none'; results.sort((a,b) => (a.createdAt < b.createdAt) ? 1 : -1) .forEach(item => resultsList.appendChild(createUniversalListItemNode(item))); } else { emptyState.style.display = 'block'; } } function createUniversalListItemNode(item) { const node = item.type === 'task' ? createTaskItemNode(item) : createEventItemNode(item); if (newlyCreatedItemId && item.localId === newlyCreatedItemId) { node.classList.add(CONSTANTS.ANIMATION_CLASSES.ITEM_ENTERING); node.addEventListener('animationend', () => { node.classList.remove(CONSTANTS.ANIMATION_CLASSES.ITEM_ENTERING); }, { once: true }); newlyCreatedItemId = null; } return node; } function createEventItemNode(item) { const itemEl = document.createElement('div'); itemEl.className = `list-item-swipe-container type-agenda ${item.isComplete ? 'completed' : ''}`; itemEl.dataset.id = item.localId; const itemColor = item.isImportant ? 'var(--accent-event-important)' : 'var(--accent-event-normal)'; itemEl.style.borderLeftColor = itemColor; const time = item.dueDate ? dateToHHMM(new Date(item.dueDate)) : ''; itemEl.innerHTML = ` <div class="item-card-swipe-background"><span class="material-icons">check_circle</span><span class="material-icons">delete</span></div> <div class="item-icon"><span class="material-icons" style="color: ${itemColor};">event</span></div> <div class="item-content" data-action="edit-item"> <div class="item-title">${item.description}</div> <div class="item-metadata-container"> <span class="event-time">${time}</span> ${item.googleCalendarEventId ? '<span class="material-icons event-meta-icon google-cal-icon">event_available</span>' : ''} ${item.recurrenceRule !== 'none' ? '<span class="material-icons event-meta-icon">repeat</span>' : ''} </div> </div>`; // REFACTOR: Se eliminan los .onclick. La lógica se centraliza en attachGlobalEventListeners. attachSwipeListeners(itemEl); return itemEl; } function createTaskItemNode(item) { const itemEl = document.createElement('div'); itemEl.dataset.id = item.localId; itemEl.className = `list-item-swipe-container type-task ${item.isComplete ? 'completed' : ''}`; itemEl.style.borderLeftColor = 'var(--accent-task)'; let contentHtml = ''; if (item.subtasks && item.subtasks.length > 0) { const completedCount = item.subtasks.filter(st => st.isComplete).length; const progressPercent = (completedCount / item.subtasks.length) * 100; const subtasksListViewHtml = item.subtasks.map(st => ` <div class="subtask-list-view-item ${st.isComplete ? 'completed' : ''}" data-action="toggle-subtask" data-task-id="${item.localId}" data-subtask-id="${st.id}"> <span class="material-icons">${st.isComplete ? 'check_circle' : 'radio_button_unchecked'}</span> <span>${st.description}</span> </div> `).join(''); contentHtml = ` <div class="task-progress-container"> <div class="progress-bar-wrapper"> <span>${completedCount} de ${item.subtasks.length}</span> <div class="progress-bar"> <div class="progress-bar-fill" style="width: ${progressPercent}%;"></div> </div> <div class="subtasks-list-view">${subtasksListViewHtml}</div> </div>`; } itemEl.innerHTML = ` <div class="item-card-swipe-background"><span class="material-icons">check_circle</span><span class="material-icons">delete</span></div> <div class="item-icon item-checkbox" data-action="complete-item"> <span class="material-icons">${item.isComplete ? 'check_circle' : 'radio_button_unchecked'}</span> </div> <div class="item-content"> <div class="item-title" data-action="edit-item">${item.description}</div> ${contentHtml} </div>`; // REFACTOR: Se eliminan los .onclick. La lógica se centraliza en attachGlobalEventListeners. attachSwipeListeners(itemEl); return itemEl; } // ================================================================================= // MANEJADORES DE EVENTOS // ================================================================================= function attachGlobalEventListeners() { const safeAddListener = (id, event, handler) => { const el = gebi(id); if (el) el.addEventListener(event, handler); }; // REFACTOR: Se utiliza un único manejador de clics para toda la aplicación (delegación de eventos) document.body.addEventListener('click', e => { const actionTarget = e.target.closest('[data-action]'); if (actionTarget) { const action = actionTarget.dataset.action; triggerHapticFeedback('light'); // Acciones de la lista de ítems if (action === 'edit-item') { const itemId = actionTarget.closest('.list-item-swipe-container').dataset.id; const item = db.items.find(i => i.localId === itemId); if (item) openAddItemModal(item); } if (action === 'complete-item') { const itemId = actionTarget.closest('.list-item-swipe-container').dataset.id; const item = db.items.find(i => i.localId === itemId); if (item) { triggerHapticFeedback('success'); handleItemComplete(itemId, !item.isComplete); } } if (action === 'toggle-subtask') { const taskId = actionTarget.dataset.taskId; const subtaskId = actionTarget.dataset.subtaskId; if (taskId && subtaskId) { triggerHapticFeedback('success'); handleSubtaskToggle(taskId, subtaskId); } } // Acciones de autenticación if (action === 'login') handleLogin(); if (action === 'register') handleRegister(); if (action === 'logout') { showCustomConfirm("¿Seguro que quieres cerrar sesión?", () => signOut(fbAuth)); } // Acciones de UI y modales if (action === 'quick-add') openModal('quick-add-modal'); if (action === 'selectDate') { const dateStr = actionTarget.dataset.date; selectDate(dateStr); } } }); qsa('.nav-item[data-view]').forEach(item => item.addEventListener('click', () => switchView(item.dataset.view))); safeAddListener('nav-theme-btn', 'click', handleThemeToggle); safeAddListener('google-sync-btn', 'click', handleGoogleAuthClick); safeAddListener('prev-nav-btn', 'click', () => { appState.calendar.displayMode === 'month' ? changeMonth(-1) : changeWeek(-1); }); safeAddListener('next-nav-btn', 'click', () => { appState.calendar.displayMode === 'month' ? changeMonth(1) : changeWeek(1); }); safeAddListener('today-btn', 'click', goToToday); safeAddListener('calendar-title-btn', 'click', openDatePickerModal); safeAddListener('month-view-btn', 'click', () => setCalendarDisplayMode('month')); safeAddListener('week-view-btn', 'click', () => setCalendarDisplayMode('week')); safeAddListener('fab-add-item', 'click', () => { triggerHapticFeedback('medium'); openModal('quick-add-modal'); }); safeAddListener('quick-add-input', 'input', debounce(handleQuickAddInput)); safeAddListener('quick-add-form', 'submit', handleQuickAddSubmit); safeAddListener('cancel-quick-add-btn', 'click', () => closeModal('quick-add-modal')); safeAddListener('open-advanced-editor-btn', 'click', openAdvancedFromQuickAdd); safeAddListener('add-item-form', 'submit', handleItemFormSubmit); safeAddListener('cancel-item-btn', 'click', () => closeModal('add-item-modal')); safeAddListener('item-type', 'change', toggleModalOptionsVisibility); safeAddListener('item-notification-enabled', 'change', toggleModalOptionsVisibility); safeAddListener('delete-item-btn', 'click', handleDeleteFromModal); safeAddListener('date-picker-form', 'submit', handleDateSelectionFromPicker); safeAddListener('cancel-date-picker-btn', 'click', () => closeModal('date-picker-modal')); safeAddListener('search-toggle-btn', 'click', toggleSearchBar); safeAddListener('search-form', 'submit', handleSearchSubmit); safeAddListener('task-list-filter', 'change', handleTaskListFilterChange); safeAddListener('manage-lists-btn', 'click', openManageListsModal); safeAddListener('close-manage-lists-btn', 'click', () => closeModal('manage-lists-modal')); safeAddListener('add-list-form', 'submit', handleAddTaskList); safeAddListener('add-subtask-btn', 'click', handleAddSubtask); safeAddListener('new-subtask-input', 'keydown', e => { if (e.key === 'Enter') { e.preventDefault(); handleAddSubtask(); } }); window.addEventListener('online', updateSyncStatus); window.addEventListener('offline', updateSyncStatus); } // ================================================================================= // LÓGICA PRINCIPAL (CRUD, NAVEGACIÓN, ACCIONES) // ================================================================================= function handleQuickAddInput(e) { const text = e.target.value; const feedbackContainer = gebi('quick-add-feedback'); if (!text.trim()) { feedbackContainer.innerHTML = ''; return; } const parsedData = parseNaturalLanguage(text); let feedbackHtml = ''; if (parsedData.type === 'agenda') { const formattedDate = formatDateForFeedback(parsedData.dueDate); feedbackHtml = `<div class="feedback-chip type-agenda"><span class="material-icons">event</span><span>Evento: ${formattedDate}</span></div>`; } else { feedbackHtml = `<div class="feedback-chip type-task"><span class="material-icons">task_alt</span><span>Tarea</span></div>`; } feedbackContainer.innerHTML = feedbackHtml; } function switchView(view, isInitial = false) { if (!view || view === appState.currentView || isViewSwitching) return; if (view === 'search') appState.lastView = appState.currentView; isViewSwitching = true; const oldViewName = appState.currentView; const newViewName = view; appState.currentView = newViewName; const oldViewEl = gebi(`${oldViewName}View`); const newViewEl = gebi(`${newViewName}View`); if (!newViewEl) { isViewSwitching = false; return; } renderApp(); if (isInitial || !oldViewEl) { newViewEl.classList.add('active'); isViewSwitching = false; return; } const oldViewIndex = VIEW_ORDER.indexOf(oldViewName); const newViewIndex = VIEW_ORDER.indexOf(newViewName); let enterClass, exitClass; if (newViewIndex > oldViewIndex) { enterClass = 'view-enter-from-right'; exitClass = 'view-exit-to-left'; } else { enterClass = 'view-enter-from-left'; exitClass = 'view-exit-to-right'; } if (newViewIndex === -1 || oldViewIndex === -1) { newViewEl.classList.add('active'); oldViewEl.classList.remove('active'); isViewSwitching = false; return; } newViewEl.classList.add(enterClass, 'active', 'is-animating'); oldViewEl.classList.add(exitClass, 'is-animating'); newViewEl.addEventListener('animationend', () => { oldViewEl.classList.remove('active', 'is-animating', exitClass); newViewEl.classList.remove(enterClass, 'is-animating'); isViewSwitching = false; }, { once: true }); } function selectDate(dateStr) { appState.calendar.selectedDate = dateStr; renderApp(); } function changeMonth(delta) { const d = new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 1); d.setMonth(d.getMonth() + delta); appState.calendar.currentMonth = d.getMonth(); appState.calendar.currentYear = d.getFullYear(); renderApp(); } function changeWeek(delta) { const d = yyyymmddToDate(appState.calendar.selectedDate); d.setDate(d.getDate() + (delta * 7)); appState.calendar.selectedDate = dateToYYYYMMDD(d); appState.calendar.currentMonth = d.getMonth(); appState.calendar.currentYear = d.getFullYear(); renderApp(); } function goToToday() { const t = new Date(); appState.calendar = { ...appState.calendar, currentMonth: t.getMonth(), currentYear: t.getFullYear(), selectedDate: dateToYYYYMMDD(t), displayMode: 'month' }; if (appState.currentView === 'calendar') { renderApp(); } else { switchView('calendar'); } } function setCalendarDisplayMode(mode) { if (appState.calendar.displayMode === mode) return; appState.calendar.displayMode = mode; renderApp(); } function openModal(modalId) { gebi(modalId)?.classList.add('active'); if (modalId === 'quick-add-modal') { const i = gebi('quick-add-input'); i.value = ''; setTimeout(() => i.focus(), 100); } } function closeModal(modalId) { gebi(modalId)?.classList.remove('active'); } function openAddItemModal(itemToEdit = null) { const form = gebi('add-item-form'); form.reset(); closeModal('quick-add-modal'); gebi('delete-item-btn').style.display = itemToEdit ? 'block' : 'none'; const localId = itemToEdit?.localId || uuid(); gebi('item-local-id').value = localId; const itemData = itemToEdit || parseNaturalLanguage(gebi('quick-add-input').value); const defaultType = appState.currentView === 'tasks' ? 'task' : 'agenda'; gebi('item-type').value = itemData?.type || defaultType; gebi('item-description').value = itemData?.description || ''; const taskListSelect = gebi('item-task-list'); taskListSelect.innerHTML = db.taskLists.map(list => `<option value="${list.id}">${list.name}</option>`).join(''); taskListSelect.value = itemData?.listId || appState.tasks.selectedListId; renderSubtasksInModal(itemData?.subtasks || []); const dateToShow = itemData?.dueDate ? new Date(itemData.dueDate) : yyyymmddToDate(appState.calendar.selectedDate); flatpickrInstance.setDate(dateToShow, false); gebi('item-important').checked = itemData?.isImportant || false; gebi('item-notification-enabled').checked = itemData?.notificationEnabled || false; gebi('item-recurrence').value = itemData?.recurrenceRule || 'none'; gebi('item-reminder').value = itemData?.reminderMinutes || '0'; toggleModalOptionsVisibility(); openModal('add-item-modal'); gebi('item-description').focus(); } function toggleModalOptionsVisibility() { const isAgenda = gebi('item-type').value === 'agenda'; const isNotificationEnabled = gebi('item-notification-enabled').checked; gebi('datetime-notification-group').style.display = isAgenda ? 'block' : 'none'; gebi('task-options-group').style.display = isAgenda ? 'none' : 'block'; gebi('reminder-time-group').style.display = (isAgenda && isNotificationEnabled) ? 'block' : 'none'; } // FIX: Se ha reestructurado por completo para manejar correctamente las operaciones asíncronas. async function handleItemFormSubmit(e) { e.preventDefault(); if (isSyncingWithGoogle) { showToast("Sincronización en curso, por favor espera.", true); return; } const localId = gebi('item-local-id').value; const existingItem = db.items.find(i => i.localId === localId); const subtasks = Array.from(qsa('#subtasks-container .subtask-item')).map(el => ({ id: el.dataset.id, description: el.querySelector('input[type="text"]').value, isComplete: el.querySelector('input[type="checkbox"]').checked })); let itemData = { localId, type: gebi('item-type').value, description: gebi('item-description').value.trim(), isComplete: existingItem?.isComplete || false, createdAt: existingItem?.createdAt || Date.now(), updatedAt: Date.now(), isImportant: gebi('item-type').value === 'agenda' ? gebi('item-important').checked : false, notificationEnabled: gebi('item-type').value === 'agenda' ? gebi('item-notification-enabled').checked : false, reminderMinutes: gebi('item-type').value === 'agenda' && gebi('item-notification-enabled').checked ? parseInt(gebi('item-reminder').value, 10) : 0, notificationShown: (existingItem && existingItem.dueDate === flatpickrInstance.selectedDates[0]?.toISOString()) ? existingItem.notificationShown : false, recurrenceRule: gebi('item-type').value === 'agenda' ? gebi('item-recurrence').value : 'none', dueDate: gebi('item-type').value === 'agenda' ? flatpickrInstance.selectedDates[0]?.toISOString() : null, listId: gebi('item-type').value === 'task' ? gebi('item-task-list').value : null, subtasks: gebi('item-type').value === 'task' ? subtasks : [], googleCalendarEventId: existingItem?.googleCalendarEventId || null, parentId: existingItem?.parentId || null }; if (itemData.notificationEnabled) requestNotificationPermission(); const isNewItem = !existingItem; try { if (isGoogleSignedIn && itemData.type === 'agenda') { isSyncingWithGoogle = true; showToast("Sincronizando con Google...", false); if (itemData.googleCalendarEventId) { await actualizarEventoEnGoogle(itemData); } else { const googleId = await crearEventoEnGoogle(itemData); if (googleId) { itemData.googleCalendarEventId = googleId; } else { // Si la creación en Google falla, no continuamos. throw new Error("No se pudo crear el evento en Google Calendar."); } } } // Solo si la parte asíncrona (Google) tiene éxito, procedemos a guardar localmente. handleItemSave(itemData, isNewItem); closeModal('add-item-modal'); } catch (error) { showToast("Error al guardar. " + error.message, true); console.error("Error en handleItemFormSubmit:", error); } finally { // Aseguramos que el estado de sincronización siempre se restablezca. if (isSyncingWithGoogle) { isSyncingWithGoogle = false; } } } function handleItemSave(itemData, isNewItem = false) { if (!itemData.description) { showToast("La descripción no puede estar vacía.", true); return; } triggerHapticFeedback('medium'); const index = db.items.findIndex(i => i.localId === itemData.localId); if (index > -1) { db.items[index] = { ...db.items[index], ...itemData }; } else { db.items.unshift(itemData); } if (isNewItem) { newlyCreatedItemId = itemData.localId; } handlePostSaveNavigation(itemData); saveDataAndSchedule(); } function handlePostSaveNavigation(itemData) { if (!itemData) { renderApp(); return; } if (itemData.type === 'agenda' && itemData.dueDate) { const itemDate = new Date(itemData.dueDate); appState.calendar.selectedDate = dateToYYYYMMDD(itemDate); appState.calendar.currentMonth = itemDate.getMonth(); appState.calendar.currentYear = itemDate.getFullYear(); if (appState.currentView !== 'calendar') switchView('calendar'); else renderApp(); } else if (itemData.type === 'task') { appState.tasks.selectedListId = itemData.listId || 'default'; if (appState.currentView !== 'tasks') switchView('tasks'); else renderApp(); } else { renderApp(); } } async function handleItemComplete(localId, isComplete) { if (isSyncingWithGoogle) { showToast("Sincronización en curso, por favor espera.", true); return; } const itemIndex = db.items.findIndex(i => i.localId === localId); if (itemIndex === -1) return; const item = { ...db.items[itemIndex] }; try { if (isComplete) { if (isGoogleSignedIn && item.googleCalendarEventId && item.type === 'agenda') { isSyncingWithGoogle = true; await borrarEventoEnGoogle(item); } showToast(`"${item.description}" completado.`); const updatedItem = { ...item, isComplete: true, completedAt: Date.now(), updatedAt: Date.now() }; if (updatedItem.type === 'task' && updatedItem.subtasks) { updatedItem.subtasks.forEach(st => st.isComplete = true); } db.items[itemIndex] = updatedItem; if (item.type === 'agenda' && item.recurrenceRule !== 'none') { const nextDueDate = calculateNextDueDate(new Date(item.dueDate), item.recurrenceRule); if (nextDueDate) { const nextEvent = { ...item, localId: uuid(), dueDate: nextDueDate.toISOString(), isComplete: false, completedAt: null, notificationShown: false, createdAt: Date.now(), updatedAt: Date.now(), parentId: item.localId }; delete nextEvent.googleCalendarEventId; db.items.unshift(nextEvent); showToast(`Evento reprogramado para la próxima ocurrencia.`); } } } else { if (item.recurrenceRule !== 'none') { const childItemIndex = db.items.findIndex(i => i.parentId === localId); if (childItemIndex > -1) { db.items.splice(childItemIndex, 1); } } const updatedItem = { ...item, isComplete: false, completedAt: null, updatedAt: Date.now() }; db.items[itemIndex] = updatedItem; } renderApp(); saveDataAndSchedule(); } catch (error) { showToast("Error al sincronizar con Google.", true); console.error("Error in handleItemComplete:", error); renderApp(); } finally { if (isSyncingWithGoogle) { isSyncingWithGoogle = false; } } } async function handleDeleteItem(localId) { if (isSyncingWithGoogle) { showToast("Sincronización en curso, por favor espera.", true); return; } triggerHapticFeedback('medium'); const itemEl = document.querySelector(`.list-item-swipe-container[data-id="${localId}"]`); const index = db.items.findIndex(i => i.localId === localId); if (index === -1) return; const itemToDelete = { ...db.items[index] }; try { if (isGoogleSignedIn && itemToDelete.googleCalendarEventId) { isSyncingWithGoogle = true; await borrarEventoEnGoogle(itemToDelete); } const performDeleteAndUpdate = () => { const finalChildIndex = db.items.findIndex(i => i.parentId === localId); if (finalChildIndex > -1) db.items.splice(finalChildIndex, 1); const finalParentIndex = db.items.findIndex(i => i.localId === localId); if (finalParentIndex > -1) db.items.splice(finalParentIndex, 1); saveDataAndSchedule(); if (!itemEl) renderApp(); }; if (itemEl) { itemEl.classList.add('item-exiting'); itemEl.addEventListener('animationend', performDeleteAndUpdate, { once: true }); } else { performDeleteAndUpdate(); renderApp(); } } catch (error) { showToast("Error al eliminar evento de Google.", true); if (itemEl) itemEl.style.transform = 'translateX(0)'; } finally { if (isSyncingWithGoogle) isSyncingWithGoogle = false; } } function saveDataAndSchedule() { scheduleAllNotifications(); saveData().catch(error => { showToast(`Error al sincronizar.`, true); renderApp(); }); } function handleDeleteFromModal() { const localId = gebi('item-local-id').value; const item = db.items.find(i => i.localId === localId); if (item) { showCustomConfirm(`¿Eliminar este ítem permanentemente: "${item.description}"?`, () => { closeModal('add-item-modal'); handleDeleteItem(localId); }); } } // ================================================================================= // LÓGICA DE FUNCIONES AVANZADAS (NLP, TAREAS, TUTORIAL, ETC.) // ================================================================================= function calculateNextDueDate(currentDueDate, recurrenceRule) { const nextDate = new Date(currentDueDate); switch (recurrenceRule) { case 'daily': nextDate.setDate(nextDate.getDate() + 1); break; case 'weekly': nextDate.setDate(nextDate.getDate() + 7); break; case 'monthly': nextDate.setMonth(nextDate.getMonth() + 1); break; case 'yearly': nextDate.setFullYear(nextDate.getFullYear() + 1); break; default: return null; } return nextDate; } async function handleQuickAddSubmit(e) { e.preventDefault(); if (isSyncingWithGoogle) { showToast("Sincronización en curso, por favor espera.", true); return; } const input = gebi('quick-add-input').value.trim(); if (!input) return; let parsedData = parseNaturalLanguage(input); let itemToSave = { ...parsedData, localId: uuid(), isComplete: false, createdAt: Date.now(), updatedAt: Date.now(), listId: parsedData.type === 'task' ? appState.tasks.selectedListId : null }; try { if (isGoogleSignedIn && itemToSave.type === 'agenda') { isSyncingWithGoogle = true; showToast("Sincronizando con Google...", false); const googleId = await crearEventoEnGoogle(itemToSave); if (googleId) { itemToSave.googleCalendarEventId = googleId; } else { throw new Error("No se pudo crear evento en Google en modo rápido."); } } handleItemSave(itemToSave, true); closeModal('quick-add-modal'); } catch (error) { showToast("Error al crear evento. " + error.message, true); console.error("Error en handleQuickAddSubmit:", error); } finally { if (isSyncingWithGoogle) { isSyncingWithGoogle = false; } } } function openAdvancedFromQuickAdd() { const itemToEdit = parseNaturalLanguage(gebi('quick-add-input').value); openAddItemModal(itemToEdit); } function parseNaturalLanguage(text) { let cleanText = text.toLowerCase(); let date = new Date(); let dateFound = false; const timeRegex = /(?:a las|a la|)\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm|de la mañana|de la tarde|de la noche)?/i; const timeMatch = cleanText.match(timeRegex); if (timeMatch) { let hour = parseInt(timeMatch[1], 10); const minute = parseInt(timeMatch[2], 10) || 0; const period = timeMatch[3] ? timeMatch[3].toLowerCase() : ''; if ((period.includes('pm') || period.includes('tarde') || period.includes('noche')) && hour < 12) { hour += 12; } if ((period.includes('am') || period.includes('mañana')) && hour === 12) { hour = 0; } date.setHours(hour, minute, 0, 0); cleanText = cleanText.replace(timeMatch[0], '').trim(); dateFound = true; } else { date.setHours(0,0,0,0); } const numericDateRegex = /\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/; const numericDateMatch = cleanText.match(numericDateRegex); if (numericDateMatch) { const day = parseInt(numericDateMatch[1], 10); const month = parseInt(numericDateMatch[2], 10) - 1; let year = numericDateMatch[3] ? parseInt(numericDateMatch[3], 10) : new Date().getFullYear(); if (year < 100) { year += 2000; } date.setFullYear(year, month, day); dateFound = true; cleanText = cleanText.replace(numericDateMatch[0], '').trim(); } else { const dateRegex = /(\d{1,2})(?:\s+de\s+|\s*\/\s*)(\w+)/i; const dateMatch = dateRegex.exec(cleanText); if (dateMatch) { const day = parseInt(dateMatch[1], 10); const monthStr = dateMatch[2].toLowerCase(); const monthIndex = MESES.findIndex(m => m.toLowerCase().startsWith(monthStr)); if (monthIndex > -1) { date.setMonth(monthIndex, day); dateFound = true; cleanText = cleanText.replace(dateMatch[0], '').trim(); } } else if (/\bhoy\b/i.test(cleanText)) { dateFound = true; cleanText = cleanText.replace(/\bhoy\b/i, '').trim(); } else if (/\bmañana\b/i.test(cleanText)) { date.setDate(date.getDate() + 1); dateFound = true; cleanText = cleanText.replace(/\bmañana\b/i, '').trim(); } else { for (let i = 0; i < DIAS_SEMANA_LARGOS.length; i++) { const dayName = DIAS_SEMANA_LARGOS[i]; if (cleanText.includes(dayName)) { const currentDay = (new Date().getDay() + 6) % 7; const targetDay = i; let dayDiff = targetDay - currentDay; if (dayDiff <= 0) dayDiff += 7; date.setDate(date.getDate() + dayDiff); dateFound = true; cleanText = cleanText.replace(new RegExp(`\\b(el\\s+)?${dayName}\\b`, 'i'), '').trim(); break; } } } } const description = cleanText.charAt(0).toUpperCase() + cleanText.slice(1); return { type: dateFound ? 'agenda' : 'task', description: description.replace(/,$/, '').trim(), dueDate: dateFound ? date.toISOString() : null }; } function handleTaskListFilterChange(e) { appState.tasks.selectedListId = e.target.value; renderTaskListView(); } function openManageListsModal() { const editor = gebi('task-lists-editor'); editor.innerHTML = ''; db.taskLists.forEach(list => { const el = document.createElement('div'); el.style.display = 'flex'; el.style.alignItems = 'center'; el.style.gap = '8px'; el.style.marginBottom = '8px'; const input = document.createElement('input'); input.type = 'text'; input.value = list.name; input.className = 'form-input'; input.onchange = () => handleRenameTaskList(list.id, input.value); if(list.id === 'default') input.disabled = true; el.appendChild(input); if (list.id !== 'default') { const deleteBtn = document.createElement('button'); deleteBtn.className = 'icon-button'; deleteBtn.innerHTML = '<span class="material-icons">delete</span>'; deleteBtn.onclick = () => handleDeleteTaskList(list.id); el.appendChild(deleteBtn); } editor.appendChild(el); }); openModal('manage-lists-modal'); } function handleAddTaskList(e) { e.preventDefault(); const input = gebi('new-list-name'); const name = input.value.trim(); if (name) { const newList = { id: uuid(), name }; db.taskLists.push(newList); saveData().then(() => { input.value = ''; openManageListsModal(); renderTaskListView(); }).catch(err => showToast("Error al añadir lista", true)); } } function handleRenameTaskList(id, newName) { const list = db.taskLists.find(l => l.id === id); if (list && newName) { list.name = newName; saveData().then(() => { openManageListsModal(); renderTaskListView(); }).catch(err => showToast("Error al renombrar lista", true)); } } function handleDeleteTaskList(id) { const listName = db.taskLists.find(l => l.id === id)?.name; showCustomConfirm(`¿Seguro que quieres eliminar la lista "${listName}" y TODAS sus tareas? Esta acción es irreversible.`, () => { db.taskLists = db.taskLists.filter(l => l.id !== id); db.items = db.items.filter(i => i.listId !== id); if (appState.tasks.selectedListId === id) { appState.tasks.selectedListId = 'default'; } saveData().then(() => { openManageListsModal(); renderTaskListView(); }).catch(err => showToast("Error al eliminar la lista.", true)); }); } function renderSubtasksInModal(subtasks = []) { const container = gebi('subtasks-container'); container.innerHTML = ''; subtasks.forEach(subtask => { const el = document.createElement('div'); el.className = 'subtask-item'; el.dataset.id = subtask.id; el.innerHTML = `<input type="checkbox" ${subtask.isComplete ? 'checked' : ''}><input type="text" value="${subtask.description}"><button type="button" class="icon-button delete-subtask-btn"><span class="material-icons">close</span></button>`; el.querySelector('.delete-subtask-btn').onclick = () => { el.remove(); }; container.appendChild(el); }); } function handleAddSubtask() { const i = gebi('new-subtask-input'); const d = i.value.trim(); if (d) { const c = gebi('subtasks-container'); const el = document.createElement('div'); el.className = 'subtask-item'; el.dataset.id = uuid(); el.innerHTML = `<input type="checkbox"><input type="text" value="${d}"><button type="button" class="icon-button delete-subtask-btn"><span class="material-icons">close</span></button>`; el.querySelector('.delete-subtask-btn').onclick = () => { el.remove(); }; c.appendChild(el); i.value = ''; i.focus(); } } function handleSubtaskToggle(taskId, subtaskId) { const taskIndex = db.items.findIndex(i => i.localId === taskId); if (taskIndex === -1) return; const updatedTask = JSON.parse(JSON.stringify(db.items[taskIndex])); const subtaskIndex = updatedTask.subtasks.findIndex(st => st.id === subtaskId); if (subtaskIndex === -1) return; updatedTask.subtasks[subtaskIndex].isComplete = !updatedTask.subtasks[subtaskIndex].isComplete; const allSubtasksComplete = updatedTask.subtasks.every(st => st.isComplete); updatedTask.isComplete = allSubtasksComplete; if (allSubtasksComplete) { if (!updatedTask.completedAt) updatedTask.completedAt = Date.now(); } else { updatedTask.completedAt = null; } updatedTask.updatedAt = Date.now(); db.items[taskIndex] = updatedTask; renderApp(); saveData().catch(error => { showToast('Error al actualizar la subtarea.', true); renderApp(); }); } function startOnboardingTutorial() { if (typeof driver === 'undefined' || typeof driver.driver !== 'function') { console.warn("Driver.js aún no se ha cargado, reintentando en 200ms..."); setTimeout(startOnboardingTutorial, 200); return; } const driverObj = driver.driver({ showProgress: true, steps: [ { element: '#today-greeting', popover: { title: '¡Bienvenido/a a Agenda aiDANaI!', description: 'Este es tu centro de mando. Permítenos mostrarte rápidamente cómo funciona.' } }, { element: '#fab-add-item', popover: { title: 'Creación Rápida con IA', description: 'Usa este botón para añadir eventos y tareas usando lenguaje natural, como "Cena con amigos mañana a las 9". ¡La IA se encarga del resto!' } }, { element: '#todayView', popover: { title: 'Gestos que Ahorran Tiempo', description: 'En cualquier lista, desliza un ítem a la DERECHA para completarlo, y a la IZQUIERDA para eliminarlo. ¡Así de fácil!' } }, { element: '.bottom-nav', popover: { title: 'Navega por tu Agenda', description: 'Usa estos botones para cambiar entre la vista de Hoy, la Agenda completa, tus listas de Tareas y más.', side: "top", align: 'start' } } ], onDestroyStarted: () => { if (!driverObj.isActivated()) { db.config.tutorialCompleted = true; saveData().catch(err => showToast("Error al guardar el estado del tutorial.", true)); } } }); driverObj.drive(); } function initializeDatePicker() { flatpickr.localize(flatpickr.l10ns.es); flatpickrInstance = flatpickr("#item-datetime", { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true, minuteIncrement: 15 }); } function applyTheme(theme) { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); } function handleThemeToggle() { const n = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; db.config.theme = n; applyTheme(n); saveData().catch(err => showToast("No se pudo guardar el tema.", true)); } function openDatePickerModal() { openModal('date-picker-modal'); const m = gebi('month-select'); m.innerHTML = MESES.map((mes, i) => `<option value="${i}">${mes}</option>`).join(''); m.value = appState.calendar.currentMonth; gebi('year-select').value = appState.calendar.currentYear; } function handleDateSelectionFromPicker(e) { e.preventDefault(); appState.calendar.currentMonth = parseInt(gebi('month-select').value, 10); appState.calendar.currentYear = parseInt(gebi('year-select').value, 10); appState.calendar.selectedDate = dateToYYYYMMDD(new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 1)); appState.calendar.displayMode = 'month'; switchView('calendar'); closeModal('date-picker-modal'); } function toggleSearchBar() { const s = gebi('search-container'); const a = s.classList.toggle('active'); if (a) { gebi('search-input').focus(); if (appState.currentView !== 'search') appState.lastView = appState.currentView; } else { gebi('search-input').value = ''; executeSearch(''); } } function handleSearchSubmit(event) { event.preventDefault(); executeSearch(gebi('search-input').value); } function executeSearch(query) { if (query.trim() !== '') { switchView('search'); } else { if (appState.currentView === 'search') switchView(appState.lastView || 'today'); } } function attachSwipeListeners(cardEl) { if (!cardEl || cardEl.dataset.hammer) return; cardEl.dataset.hammer = 'true'; const mc = new Hammer.Manager(cardEl); mc.add(new Hammer.Pan({ threshold: 10, pointers: 1 })); mc.on('panstart', () => { cardEl.style.transition = 'none'; }); mc.on('pan', e => { if (e.target.closest('.subtasks-list-view')) return; cardEl.style.transform = `translateX(${e.deltaX}px)`; if (e.deltaX > 20) cardEl.classList.add('swiping-right'); else if (e.deltaX < -20) cardEl.classList.add('swiping-left'); else cardEl.classList.remove('swiping-right', 'swiping-left'); }); mc.on('panend', e => { cardEl.style.transition = 'transform 0.3s var(--ease-out-quint)'; const threshold = cardEl.offsetWidth * 0.35; const id = cardEl.dataset.id; const item = db.items.find(i => i.localId === id); if (!item) { cardEl.style.transform = 'translateX(0)'; return; } if (e.deltaX > threshold) { triggerHapticFeedback('success'); handleItemComplete(id, true); cardEl.style.transform = 'translateX(0)'; } else if (e.deltaX < -threshold) { showCustomConfirm(`¿Eliminar "${item.description}"?`, () => { handleDeleteItem(id); }, () => { cardEl.style.transform = 'translateX(0)'; } ); } else { cardEl.style.transform = 'translateX(0)'; } setTimeout(() => { cardEl.classList.remove('swiping-right', 'swiping-left'); }, 300); }); } function showCustomConfirm(message, onConfirm, onCancel) { const modalId = 'custom-confirm-modal'; let modalOverlay = gebi(modalId); if (!modalOverlay) { modalOverlay = document.createElement('div'); modalOverlay.id = modalId; modalOverlay.className = 'modal-overlay'; modalOverlay.innerHTML = ` <div class="modal"> <div class="modal-grabber"></div> <p id="confirm-message" style="margin-bottom: 24px; text-align: center; font-size: 16px;"></p> <div class="form-actions" style="justify-content: center; gap: 16px;"> <button type="button" class="btn btn-secondary" id="confirm-cancel-btn">Cancelar</button> <button type="button" class="btn btn-primary" id="confirm-ok-btn">Confirmar</button> </div> </div>`; document.body.appendChild(modalOverlay); } gebi('confirm-message').textContent = message; const confirmOkBtn = gebi('confirm-ok-btn'); const confirmCancelBtn = gebi('confirm-cancel-btn'); const newConfirmOkHandler = () => { onConfirm(); closeModal(modalId); }; const newConfirmCancelHandler = () => { if (onCancel) onCancel(); closeModal(modalId); }; confirmOkBtn.onclick = newConfirmOkHandler; confirmCancelBtn.onclick = newConfirmCancelHandler; openModal(modalId); } function updateSyncStatus() { const indicator = gebi('sync-status-indicator'); if (!indicator) return; const icon = indicator.querySelector('.material-icons') || document.createElement('span'); icon.classList.add('material-icons'); const isOnline = navigator.onLine; if (isOnline) { indicator.className = 'online'; icon.textContent = 'cloud_done'; indicator.title = "Conectado y sincronizado."; } else { indicator.className = 'offline'; icon.textContent = 'cloud_off'; indicator.title = "Sin conexión. Los cambios se guardarán localmente."; } if (!indicator.hasChildNodes()) indicator.appendChild(icon); } // ================================================================================= // NOTIFICACIONES // ================================================================================= async function requestNotificationPermission() { if (!("Notification" in window)) { showToast("Este navegador no soporta notificaciones.", true); return 'denied'; } const p = await Notification.requestPermission(); if (p === 'granted') { showToast("¡Permiso de notificaciones concedido!"); } else { showToast("Permiso de notificaciones denegado.", true); } return p; } function showNotification(item) { if (Notification.permission !== "granted") return; const b = `Tu evento "${item.description}" es ahora.`; new Notification('Recordatorio de Agenda', { body: b, icon: './aiDANaI.webp', badge: './aiDANaI.webp' }); const i = db.items.findIndex(x => x.localId === item.localId); if (i > -1) { db.items[i].notificationShown = true; saveData().catch(err => showToast("Error al guardar estado de notificación", true)); } } function scheduleNotification(item) { if (activeTimers[item.localId]) clearTimeout(activeTimers[item.localId]); if (!item.notificationEnabled || item.isComplete || !item.dueDate || item.notificationShown) return; const o = (parseInt(item.reminderMinutes, 10) || 0) * 60 * 1000; const d = new Date(item.dueDate).getTime() - o - Date.now(); if (d > 0) { activeTimers[item.localId] = setTimeout(() => { showNotification(item); }, d); } } function scheduleAllNotifications() { if (!db.items) return; Object.values(activeTimers).forEach(clearTimeout); activeTimers = {}; db.items.forEach(scheduleNotification); } // ================================================================================= // PUNTO DE ENTRADA DE LA APLICACIÓN // ================================================================================= document.addEventListener('DOMContentLoaded', initApp); 
	
    </script>
	<script async defer src="https://apis.google.com/js/api.js" onload="handleGoogleClientLoad()"></script>	
</body>
</html>